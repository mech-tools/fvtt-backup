{"version":3,"file":"bundle.js","mappings":"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","sources":["webpack:///webpack/runtime/create fake namespace object","webpack:///webpack/runtime/load script","webpack:///./multi-token-edit/applications/cssEdit.js","webpack:///./multi-token-edit/applications/dataAdapters.js","webpack:///./multi-token-edit/applications/formUtils.js","webpack:///./multi-token-edit/scripts/fieldInjector.js","webpack:///./multi-token-edit/scripts/macro/action.js","webpack:///./multi-token-edit/scripts/macro/targets.js","webpack:///./multi-token-edit/scripts/macro/generator.js","webpack:///./multi-token-edit/applications/macro.js","webpack:///./multi-token-edit/applications/meApplication.js","webpack:///./multi-token-edit/applications/forms.js","webpack:///./multi-token-edit/data/custom-controls.js","webpack:///./multi-token-edit/applications/generic/navGenerator.js","webpack:///./multi-token-edit/applications/generic/genericForm.js","webpack:///./multi-token-edit/applications/multiConfig.js","webpack:///./multi-token-edit/scripts/brush.js","webpack:///./multi-token-edit/scripts/constants.js","webpack:///./multi-token-edit/scripts/dialogs.js","webpack:///./multi-token-edit/scripts/linker/linker.js","webpack:///./multi-token-edit/scripts/mouse3d.js","webpack:///./multi-token-edit/scripts/picker.js","webpack:///./multi-token-edit/scripts/presets/collection.js","webpack:///./multi-token-edit/scripts/presets/fileIndexer.js","webpack:///./multi-token-edit/applications/progressDialog.js","webpack:///./multi-token-edit/scripts/fixedSort.js","webpack:///./multi-token-edit/scripts/presets/tagSelector.js","webpack:///./multi-token-edit/scripts/presets/forms.js","webpack:///./multi-token-edit/scripts/presets/preset.js","webpack:///./multi-token-edit/scripts/presets/utils.js","webpack:///./multi-token-edit/scripts/randomizer/randomizerUtils.js","webpack:///./multi-token-edit/scripts/shim/shim.js","webpack:///./multi-token-edit/scripts/tmfx.js","webpack:///./multi-token-edit/scripts/utils.js","webpack:///external var \"jQuery\"","webpack:///webpack/bootstrap","webpack:///webpack/runtime/compat get default export","webpack:///webpack/runtime/define property getters","webpack:///webpack/runtime/ensure chunk","webpack:///webpack/runtime/get javascript chunk filename","webpack:///webpack/runtime/hasOwnProperty shorthand","webpack:///webpack/runtime/make namespace object","webpack:///webpack/runtime/publicPath","webpack:///webpack/runtime/jsonp chunk loading","webpack:///./multi-token-edit/scripts/selectTool.js","webpack:///./multi-token-edit/scripts/presets/migration.js","webpack:///./multi-token-edit/multi-token-edit.mjs","webpack:///./multi-token-edit/scripts/settings.js"],"sourcesContent":["var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n\t__webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; typeof current == 'object' && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => (def[key] = () => (value[key])));\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","var inProgress = {};\n// data-webpack is not used as build has no uniqueName\n// loadScript function to load a script via script tag\n__webpack_require__.l = (url, done, key, chunkId) => {\n\tif(inProgress[url]) { inProgress[url].push(done); return; }\n\tvar script, needAttach;\n\tif(key !== undefined) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tfor(var i = 0; i < scripts.length; i++) {\n\t\t\tvar s = scripts[i];\n\t\t\tif(s.getAttribute(\"src\") == url) { script = s; break; }\n\t\t}\n\t}\n\tif(!script) {\n\t\tneedAttach = true;\n\t\tscript = document.createElement('script');\n\n\t\tscript.charset = 'utf-8';\n\t\tscript.timeout = 120;\n\t\tif (__webpack_require__.nc) {\n\t\t\tscript.setAttribute(\"nonce\", __webpack_require__.nc);\n\t\t}\n\n\n\t\tscript.src = url;\n\t}\n\tinProgress[url] = [done];\n\tvar onScriptComplete = (prev, event) => {\n\t\t// avoid mem leaks in IE.\n\t\tscript.onerror = script.onload = null;\n\t\tclearTimeout(timeout);\n\t\tvar doneFns = inProgress[url];\n\t\tdelete inProgress[url];\n\t\tscript.parentNode && script.parentNode.removeChild(script);\n\t\tdoneFns && doneFns.forEach((fn) => (fn(event)));\n\t\tif(prev) return prev(event);\n\t}\n\tvar timeout = setTimeout(onScriptComplete.bind(null, undefined, { type: 'timeout', target: script }), 120000);\n\tscript.onerror = onScriptComplete.bind(null, script.onerror);\n\tscript.onload = onScriptComplete.bind(null, script.onload);\n\tneedAttach && document.head.appendChild(script);\n};","import { MODULE_ID } from '../scripts/constants.js';\r\n\r\nexport function getInUseStyle() {\r\n  const styleInUse = game.settings.get(MODULE_ID, 'cssStyle');\r\n  if (styleInUse in STYLES) {\r\n    return [styleInUse, STYLES[styleInUse]];\r\n  } else {\r\n    return ['CUSTOM', game.settings.get(MODULE_ID, 'cssCustom') || ''];\r\n  }\r\n}\r\n\r\nexport default class CSSEdit extends FormApplication {\r\n  constructor() {\r\n    super({}, {});\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-css',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/cssEdit.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: 'Edit CSS',\r\n      width: 490,\r\n      height: 730,\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    const [styleInUse, css] = getInUseStyle();\r\n    data.styleInUse = styleInUse;\r\n    data.css = css;\r\n\r\n    data.styles = Object.keys(STYLES);\r\n    data.styles.push('CUSTOM');\r\n    data.disableCSS = styleInUse !== 'CUSTOM';\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    $(html).on('change', '.selectStyle', (event) => {\r\n      let css;\r\n      if (event.target.value === 'CUSTOM') {\r\n        css = game.settings.get(MODULE_ID, 'cssCustom');\r\n      } else {\r\n        css = STYLES[event.target.value];\r\n      }\r\n      $(html)\r\n        .find('.cssTextArea')\r\n        .val(css)\r\n        .prop('disabled', event.target.value !== 'CUSTOM');\r\n      $(html).find('.previewStyle').html(css);\r\n    });\r\n    $(html).on('input', '.cssTextArea', (event) => {\r\n      $(html).find('.previewStyle').html(event.target.value);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (formData.selectedStyle === 'CUSTOM') {\r\n      game.settings.set(MODULE_ID, 'cssCustom', formData.css);\r\n    }\r\n    game.settings.set(MODULE_ID, 'cssStyle', formData.selectedStyle);\r\n  }\r\n}\r\n\r\n// Pre-made styles\r\nexport const STYLES = {\r\n  Default: `.form-group.meCommon {\r\n  outline: green dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  outline: rgb(255, 204, 110) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  outline: rgb(246, 175, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  outline: rgb(118, 242, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // No Outline\r\n  // ==================\r\n  'No Outline': `.form-group.meCommon {}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Striped Background\r\n  // ==================\r\n  'Striped Background': `.form-group.meCommon {\r\n  background: repeating-linear-gradient(\r\n  45deg,\r\n  rgba(155, 233, 155, 0.8),\r\n  rgba(155, 233, 155, 0.8) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: repeating-linear-gradient(\r\n  135deg,\r\n  rgba(255, 207, 118, 0.5),\r\n  rgba(255, 207, 118, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(237, 149, 255, 0.3),\r\n  rgba(237, 149, 255, 0.3) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(118, 242, 255, 0.5),\r\n  rgba(118, 242, 255, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Solid Background\r\n  // ==================\r\n  'Solid Background': `.form-group.meCommon {\r\n  background: rgba(155, 233, 155, 0.8)\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\noutline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: rgba(255, 207, 118, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: rgba(237, 149, 255, 0.3)\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: rgba(118, 242, 255, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}`,\r\n};\r\n","class PlaylistSoundDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('lvolume' in formData) {\r\n      formData['volume'] = AudioHelper.inputToVolume(formData['lvolume']);\r\n      delete formData['lvolume'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    data['lvolume'] = (note.document ?? note).volume;\r\n  }\r\n\r\n  static updateToForm(update) {\r\n    if ('volume' in update) {\r\n      update['lvolume'] = AudioHelper.volumeToInput(update['volume']);\r\n      delete update.volume;\r\n    }\r\n  }\r\n}\r\n\r\nclass NoteDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('icon.selected' in formData || 'icon.custom' in formData) {\r\n      formData['texture.src'] = formData['icon.selected'] || formData['icon.custom'];\r\n      delete formData['icon.selected'];\r\n      delete formData['icon.custom'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    const doc = note.document ?? note;\r\n    if (doc.texture?.src != null) {\r\n      data['icon.selected'] = doc.texture.src;\r\n      data['icon.custom'] = doc.texture.src;\r\n    }\r\n  }\r\n}\r\n\r\nexport class TokenDataAdapter {\r\n  static updateToForm(update) {\r\n    if ('texture.scaleX' in update) {\r\n      update.mirrorX = update['texture.scaleX'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleX']);\r\n    }\r\n    if ('texture.scaleY' in update) {\r\n      update.mirrorY = update['texture.scaleY'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleY']);\r\n    }\r\n  }\r\n\r\n  static dataToForm(token, data) {\r\n    const doc = token.document ?? token;\r\n    if (doc.texture?.scaleX != null) data.scale = Math.abs(doc.texture.scaleX);\r\n    if (doc.texture?.scaleX != null) data.mirrorX = doc.texture.scaleX < 0;\r\n    if (doc.texture?.scaleY != null) data.mirrorY = doc.texture.scaleY < 0;\r\n  }\r\n\r\n  static formToData(token, formData) {\r\n    const doc = token.document ?? token;\r\n\r\n    // Scale/mirroring\r\n    if ('scale' in formData || 'mirrorX' in formData || 'mirrorY' in formData) {\r\n      if (!('scale' in formData)) formData.scale = Math.abs(doc.texture.scaleX);\r\n      if (!('mirrorX' in formData)) formData.mirrorX = doc.texture.scaleX < 0;\r\n      if (!('mirrorY' in formData)) formData.mirrorY = doc.texture.scaleY < 0;\r\n      formData['texture.scaleX'] = formData.scale * (formData.mirrorX ? -1 : 1);\r\n      formData['texture.scaleY'] = formData.scale * (formData.mirrorY ? -1 : 1);\r\n      ['scale', 'mirrorX', 'mirrorY'].forEach((k) => delete formData[k]);\r\n    }\r\n\r\n    // Detection modes\r\n    TokenDataAdapter.correctDetectionModes(doc, formData);\r\n  }\r\n\r\n  static correctDetectionModeOrder(data, randomizeFields) {\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          i++;\r\n        }\r\n        const newKey = `detectionModes.${indexMap[comps[1]]}.${comps[2]}`;\r\n        delete data[k];\r\n        data[newKey] = v;\r\n        if (randomizeFields && k in randomizeFields) {\r\n          const rVal = randomizeFields[k];\r\n          delete randomizeFields[k];\r\n          randomizeFields[newKey] = rVal;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static detectionModeMatch(searchModes, tokenModes) {\r\n    for (const m1 of searchModes) {\r\n      if (!('id' in m1)) continue; // Ignore mode search attempts without ids as they can't be matched up\r\n      for (const m2 of tokenModes) {\r\n        if (m1.id === m2.id) {\r\n          if ('enabled' in m1 && m1.enabled !== m2.enabled) return false;\r\n          if ('range' in m1 && m1.range !== m2.range) return false;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  static correctDetectionModes(token, data) {\r\n    const detectionModes = [];\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          detectionModes.push({});\r\n          i++;\r\n        }\r\n        const dm = detectionModes[indexMap[comps[1]]];\r\n        dm[comps[2]] = v;\r\n        // data[`${comps[0]}.${indexMap[comps[1]]}.${comps[2]}`] = v;\r\n        delete data[k];\r\n      }\r\n    }\r\n\r\n    if (!detectionModes.length) return;\r\n\r\n    // Merge current detectionModes assigned to the token and the new ones being added\r\n    const mergedModes = foundry.utils.deepClone(token.detectionModes).filter((d) => d.id);\r\n    for (const dm of detectionModes) {\r\n      if (dm.id == null) continue;\r\n\r\n      let found = false;\r\n      for (const tdm of mergedModes) {\r\n        if (tdm.id === dm.id) {\r\n          foundry.utils.mergeObject(tdm, dm);\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n      if (!found) mergedModes.push(foundry.utils.mergeObject({ id: '', range: 0, enabled: true }, dm));\r\n    }\r\n    data.detectionModes = mergedModes;\r\n  }\r\n\r\n  static modifyPresetData(app, data) {\r\n    const pModes = Object.values(foundry.utils.expandObject(data)?.detectionModes || {});\r\n    if (!pModes.length) return;\r\n\r\n    const modes = Object.values(foundry.utils.expandObject(app._getSubmitData())?.detectionModes || {});\r\n\r\n    const dataClone = foundry.utils.deepClone(data);\r\n    const randomize = data['mass-edit-randomize'] ?? {};\r\n    const addSubtract = data['mass-edit-addSubtract'] ?? {};\r\n\r\n    const modCustomFields = function (fields, key, i, k, data) {\r\n      if (`detectionModes.${i}.${k}` in fields) {\r\n        delete fields[`detectionModes.${i}.${k}`];\r\n        fields[`detectionModes.${j}.${k}`] = data[key][`detectionModes.${i}.${k}`];\r\n      }\r\n    };\r\n\r\n    const startingModeLength = modes.length;\r\n    for (let i = 0; i < pModes.length; i++) {\r\n      if (!('id' in pModes[i])) continue;\r\n      let found = false;\r\n      for (let j = 0; j < startingModeLength; j++) {\r\n        if (pModes[i].id === modes[j].id) {\r\n          found = true;\r\n          Object.keys(pModes[i]).forEach((k) => {\r\n            delete data[`detectionModes.${i}.${k}`];\r\n            data[`detectionModes.${j}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n            modCustomFields(randomize, 'mass-edit-randomize', i, k, dataClone);\r\n            modCustomFields(addSubtract, 'mass-edit-addSubtract', i, k, dataClone);\r\n          });\r\n        }\r\n      }\r\n      if (!found) {\r\n        modes.push({ id: '', range: 0, enabled: true });\r\n        Object.keys(pModes[i]).forEach((k) => {\r\n          delete data[`detectionModes.${i}.${k}`];\r\n          data[`detectionModes.${modes.length - 1}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n\r\n          if (`detectionModes.${i}.${k}` in randomize) {\r\n            delete randomize[`detectionModes.${i}.${k}`];\r\n            randomize[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-randomize'][`detectionModes.${i}.${k}`];\r\n          }\r\n          if (`detectionModes.${i}.${k}` in addSubtract) {\r\n            delete addSubtract[`detectionModes.${i}.${k}`];\r\n            addSubtract[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-addSubtract'][`detectionModes.${i}.${k}`];\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    if (startingModeLength !== modes.length) {\r\n      app._previewChanges({ detectionModes: modes });\r\n      app.render();\r\n      return true;\r\n    }\r\n  }\r\n}\r\n\r\nconst ADAPTERS = {\r\n  Token: TokenDataAdapter,\r\n  PlaylistSound: PlaylistSoundDataAdapter,\r\n  Note: NoteDataAdapter,\r\n};\r\n\r\nexport class GeneralDataAdapter {\r\n  static formToData(documentName, obj, formData) {\r\n    const adapter = ADAPTERS[documentName];\r\n    if (adapter && adapter.formToData) {\r\n      adapter.formToData(obj, formData);\r\n    }\r\n  }\r\n\r\n  static dataToForm(documentName, obj, formData) {\r\n    const adapter = ADAPTERS[documentName];\r\n    if (adapter && adapter.dataToForm) {\r\n      adapter.dataToForm(obj, formData);\r\n    }\r\n  }\r\n\r\n  static updateToForm(documentName, update) {\r\n    const adapter = ADAPTERS[documentName];\r\n    if (adapter && adapter.updateToForm) {\r\n      adapter.updateToForm(update);\r\n    }\r\n  }\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from '../scripts/constants.js';\r\nimport { DataTransform } from '../scripts/picker.js';\r\nimport { applyRandomization } from '../scripts/randomizer/randomizerUtils.js';\r\nimport { applyDDTint, applyTMFXPreset } from '../scripts/tmfx.js';\r\nimport {\r\n  flagCompare,\r\n  getCommonData,\r\n  getData,\r\n  getDocumentName,\r\n  localFormat,\r\n  mergeObjectPreserveDot,\r\n  panToFitPlaceables,\r\n  wildcardStringMatch,\r\n} from '../scripts/utils.js';\r\nimport { GeneralDataAdapter, TokenDataAdapter } from './dataAdapters.js';\r\nimport { SCENE_DOC_MAPPINGS, showMassEdit } from './multiConfig.js';\r\n\r\nexport function performMassSearch(\r\n  command,\r\n  documentName,\r\n  selectedFields,\r\n  { scope = null, selected = null, control = true, pan = true } = {}\r\n) {\r\n  const found = [];\r\n\r\n  if (scope === 'selected') {\r\n    performDocSearch(selected, documentName, selectedFields, found);\r\n  } else if (SUPPORTED_COLLECTIONS.includes(documentName)) {\r\n    performDocSearch(Array.from(game.collections.get(documentName)), documentName, selectedFields, found);\r\n  } else {\r\n    let scenes = [];\r\n    if (scope === 'world') scenes = Array.from(game.scenes);\r\n    else if (canvas.scene) scenes = [canvas.scene];\r\n\r\n    for (const scene of scenes) {\r\n      performMassSearchScene(scene, documentName, selectedFields, found);\r\n    }\r\n  }\r\n\r\n  // Select found placeables/documents\r\n  if (control) {\r\n    // First release/de-select the currently selected placeable on the current scene\r\n    canvas.activeLayer.controlled.map((c) => c).forEach((c) => c.release());\r\n\r\n    setTimeout(() => {\r\n      found.forEach((f) => {\r\n        let obj = f.object ?? f;\r\n        if (obj.control) obj.control({ releaseOthers: false });\r\n      });\r\n\r\n      if (pan && found.length && game.settings.get(MODULE_ID, 'panToSearch')) {\r\n        panToFitPlaceables(found);\r\n      }\r\n    }, 100);\r\n  }\r\n  if (command === 'meSearchAndEdit') {\r\n    setTimeout(() => {\r\n      showMassEdit(found, documentName);\r\n    }, 500);\r\n  }\r\n  return found;\r\n}\r\n\r\nfunction performMassSearchScene(scene, documentName, selectedFields, found) {\r\n  const docs = Array.from(scene[SCENE_DOC_MAPPINGS[documentName]]);\r\n  performDocSearch(docs, documentName, selectedFields, found);\r\n}\r\n\r\nfunction performDocSearch(docs, documentName, selectedFields, found) {\r\n  // Next select objects that match the selected fields\r\n  for (const c of docs) {\r\n    let matches = true;\r\n    const data = foundry.utils.flattenObject(getData(c).toObject());\r\n\r\n    // Special processing for some placeable types\r\n    // Necessary when form data is not directly mappable to placeable\r\n    GeneralDataAdapter.dataToForm(documentName, c, data);\r\n\r\n    for (const [k, v] of Object.entries(selectedFields)) {\r\n      // Special handling for flags\r\n      if (k.startsWith('flags.')) {\r\n        if (!flagCompare(data, k, v)) {\r\n          matches = false;\r\n          break;\r\n        }\r\n        // Special handling for empty strings and undefined\r\n      } else if ((v === '' || v == null) && (data[k] !== '' || data[k] != null)) {\r\n        // matches\r\n      } else if (typeof v === 'string' && v.includes('*') && wildcardStringMatch(v, data[k])) {\r\n        // Wildcard matched\r\n      } else if (data[k] != v) {\r\n        // Detection mode keys cannot be treated in isolation\r\n        // We skip them here and will check them later\r\n        if (documentName === 'Token') {\r\n          if (k.startsWith('detectionModes')) {\r\n            continue;\r\n          }\r\n        }\r\n\r\n        matches = false;\r\n        break;\r\n      }\r\n    }\r\n    if (matches) {\r\n      // We skipped detectionMode matching in the previous step and do it now instead\r\n      if (documentName === 'Token') {\r\n        const modes = Object.values(foundry.utils.expandObject(selectedFields)?.detectionModes || {});\r\n\r\n        if (!TokenDataAdapter.detectionModeMatch(modes, c.detectionModes)) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      found.push(c);\r\n    }\r\n  }\r\n}\r\n\r\nexport function applyAddSubtract(updates, objects, documentName, addSubtractFields) {\r\n  // See if any field need to be added or subtracted\r\n  if (!addSubtractFields || foundry.utils.isEmpty(addSubtractFields)) return;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n\r\n    GeneralDataAdapter.dataToForm(documentName, objects[i], data);\r\n\r\n    for (const field of Object.keys(update)) {\r\n      if (field in addSubtractFields && field in data) {\r\n        const ctrl = addSubtractFields[field];\r\n        let val = data[field];\r\n\r\n        // Special processing for Tagger module fields\r\n        if (field === 'flags.tagger.tags') {\r\n          const currentTags = Array.isArray(val) ? val : (val ?? '').split(',').map((s) => s.trim());\r\n          const modTags = (update[field] ?? '').split(',').map((s) => s.trim());\r\n          for (const tag of modTags) {\r\n            if (ctrl.method === 'add') {\r\n              if (!currentTags.includes(tag)) currentTags.push(tag);\r\n            } else if (ctrl.method === 'subtract') {\r\n              const index = currentTags.indexOf(tag);\r\n              if (index > -1) currentTags.splice(index, 1);\r\n            }\r\n          }\r\n          update[field] = currentTags.filter((t) => t).join(',');\r\n          continue;\r\n        } else if (ctrl.type === 'text') {\r\n          if (ctrl.method === 'add') {\r\n            const toAdd = 'value' in ctrl ? ctrl.value : update[field];\r\n            if (toAdd.startsWith('>>')) {\r\n              val = toAdd.replace('>>', '') + val;\r\n            } else {\r\n              val += toAdd;\r\n            }\r\n          } else {\r\n            val = val.replace('value' in ctrl ? ctrl.value : update[field], '');\r\n          }\r\n          update[field] = val;\r\n          continue;\r\n        }\r\n\r\n        if (ctrl.method === 'add') {\r\n          val += 'value' in ctrl ? ctrl.value : update[field];\r\n        } else {\r\n          val -= 'value' in ctrl ? ctrl.value : update[field];\r\n        }\r\n        if ('min' in ctrl && val < ctrl.min) {\r\n          val = ctrl.min;\r\n        } else if ('max' in ctrl && val > ctrl.max) {\r\n          val = ctrl.max;\r\n        }\r\n        update[field] = val;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport async function performMassUpdate(data, objects, documentName, applyType) {\r\n  // Used by GenericForms, we want just the data, and no updates\r\n  if (this.options?.simplified) {\r\n    if (this.options.callback) this.options.callback(data);\r\n    return;\r\n  }\r\n  if (foundry.utils.isEmpty(data)) {\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Make sure we're working with documents and not placeables\r\n  objects = objects.map((o) => o.document ?? o);\r\n\r\n  // Update docs\r\n  const updates = [];\r\n  const context = {};\r\n\r\n  const total = objects.length;\r\n  for (let i = 0; i < total; i++) {\r\n    const update = foundry.utils.deepClone(data);\r\n    update._id = objects[i].id;\r\n\r\n    // push update\r\n    updates.push(update);\r\n  }\r\n\r\n  // Applies randomization\r\n  if (this) await applyRandomization(updates, objects, this.randomizeFields);\r\n  if (this) applyAddSubtract(updates, objects, documentName, this.addSubtractFields);\r\n\r\n  // Necessary when form data is not directly mappable to placeable\r\n  for (let i = 0; i < total; i++) {\r\n    GeneralDataAdapter.formToData(documentName, objects[i], updates[i]);\r\n  }\r\n\r\n  await checkApplySpecialFields(documentName, updates, objects);\r\n\r\n  if (documentName === 'Actor') {\r\n    // Perform Updates\r\n    // There is a lot of wonkiness related to updating of real/synthetic actors. It's probably best\r\n    // to simply update the Actors directly\r\n\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      if (this.options?.tokens) this.options.tokens[i].actor.update(update);\r\n      else objects[i].update(update);\r\n    }\r\n  } else if (documentName === 'Scene') {\r\n    Scene.updateDocuments(updates, context);\r\n  } else if (documentName === 'PlaylistSound') {\r\n    for (let i = 0; i < objects.length; i++) {\r\n      delete updates[i]._id;\r\n      objects[i].update(updates[i]);\r\n    }\r\n  } else if (documentName === 'Note') {\r\n    // Notes can be updated across different scenes\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].scene ?? objects[i].parent;\r\n      if (applyType === 'meApplyCurrentScene' && scene.id !== canvas.scene.id) continue;\r\n      if (!(scene.id in splitUpdates)) {\r\n        splitUpdates[scene.id] = { scene: scene, updates: [] };\r\n      }\r\n      splitUpdates[scene.id].updates.push(updates[i]);\r\n    }\r\n    for (const sceneUpdate of Object.values(splitUpdates)) {\r\n      sceneUpdate.scene.updateEmbeddedDocuments(documentName, sceneUpdate.updates, context);\r\n    }\r\n  } else if (!this.isPrototype && SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].parent;\r\n      if (!splitUpdates[scene.id]) splitUpdates[scene.id] = [];\r\n      splitUpdates[scene.id].push(updates[i]);\r\n    }\r\n\r\n    for (const sceneId of Object.keys(splitUpdates)) {\r\n      game.scenes.get(sceneId)?.updateEmbeddedDocuments(documentName, splitUpdates[sceneId], context);\r\n    }\r\n  } else if (SUPPORTED_COLLECTIONS.includes(documentName)) {\r\n    objects[0].constructor?.updateDocuments(updates, context);\r\n  } else {\r\n    // Not a placeable or otherwise specially handled doc type\r\n    // Simply merge the fields directly into the object\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      mergeObjectPreserveDot(objects[i], foundry.utils.mergeObject(objects[i], update));\r\n    }\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n  }\r\n\r\n  // May need to also update Token prototypes\r\n  if ((applyType === 'meApplyToPrototype' || this.isPrototype) && documentName === 'Token') {\r\n    const actorUpdates = {};\r\n    for (let i = 0; i < objects.length; i++) {\r\n      const actor = objects[i].actor;\r\n      if (actor) actorUpdates[actor.id] = { _id: actor.id, prototypeToken: updates[i] };\r\n    }\r\n    if (!foundry.utils.isEmpty(actorUpdates)) {\r\n      const updates = [];\r\n      for (const id of Object.keys(actorUpdates)) {\r\n        updates.push(actorUpdates[id]);\r\n      }\r\n      Actor.updateDocuments(updates);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Processes Mass Edit inserted custom fields\r\n * @param {String} documentName\r\n * @param {*} updates\r\n * @param {*} objects\r\n */\r\nexport async function checkApplySpecialFields(documentName, updates, objects) {\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const object = objects[i];\r\n\r\n    // Token Magic FX specific processing\r\n    if (update.hasOwnProperty('tokenmagic.ddTint') && typeof TokenMagic !== 'undefined') {\r\n      await applyDDTint(object, update['tokenmagic.ddTint']);\r\n    }\r\n    if (update.hasOwnProperty('tokenmagic.preset') && typeof TokenMagic !== 'undefined') {\r\n      await applyTMFXPreset(\r\n        object,\r\n        update['tokenmagic.preset'],\r\n        this?.addSubtractFields?.['tokenmagic.preset']?.method === 'subtract'\r\n      );\r\n    }\r\n\r\n    // Mass Edit inserted fields\r\n    if (documentName === 'Tile') {\r\n      if (update.hasOwnProperty('massedit.scale')) {\r\n        const scale = update['massedit.scale'];\r\n        update.width = object.width * scale;\r\n        update.height = object.height * scale;\r\n\r\n        // 3D Support\r\n        if (object.flags?.['levels-3d-preview']?.depth != null) {\r\n          update['flags.levels-3d-preview.depth'] = object.flags['levels-3d-preview'].depth *= scale;\r\n        } else if (object['flags.levels-3d-preview.depth'] != null) {\r\n          update['flags.levels-3d-preview.depth'] = object['flags.levels-3d-preview.depth'] * scale;\r\n        }\r\n      }\r\n\r\n      if (update.hasOwnProperty('massedit.texture.scale')) {\r\n        update['texture.scaleX'] = update['massedit.texture.scale'];\r\n        update['texture.scaleY'] = update['massedit.texture.scale'];\r\n        delete update['massedit.texture.scale'];\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Toggle checkbox if input has been detected inside it's form-group\r\nexport async function onInputChange(event) {\r\n  if (event.target.className === 'mass-edit-control') {\r\n    if (!event.target.checked) {\r\n      // If the checkbox has been unchecked we may need to remove highlighting from tabs\r\n      deselectTabs(event.target);\r\n      return;\r\n    }\r\n  }\r\n\r\n  const meChk = $(event.target).closest('.form-group').find('.mass-edit-checkbox input');\r\n  meChk.prop('checked', true);\r\n\r\n  // Highlight tabs if they exist\r\n  selectTabs(meChk[0]);\r\n\r\n  // Immediately update the placeables\r\n  if (this?.options.massEdit && this._performOnInputChangeUpdate && this.modUpdate) this._performOnInputChangeUpdate();\r\n}\r\n\r\nexport function selectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .addClass('mass-edit-tab-selected');\r\n    selectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nexport function deselectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length && tab.find('.mass-edit-checkbox input:checked').length === 0) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .removeClass('mass-edit-tab-selected');\r\n    deselectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nfunction getObjFormData(obj, documentName) {\r\n  const data = foundry.utils.flattenObject(getData(obj).toObject());\r\n\r\n  // Special processing for some placeable types\r\n  // Necessary when form data is not directly mappable to placeable\r\n  GeneralDataAdapter.dataToForm(documentName, obj, data);\r\n\r\n  return data;\r\n}\r\n\r\n// Merge all data and determine what is common between the docs\r\nexport function getCommonDocData(docs, documentName) {\r\n  if (!documentName) getDocumentName(docs[0]);\r\n  const objects = docs.map((d) => getObjFormData(d, documentName));\r\n  return getCommonData(objects);\r\n}\r\n\r\n/**\r\n *\r\n * @param {Document} docs\r\n * @param {Preset} preset\r\n * @param {boolean} suppressNotif\r\n * @returns\r\n */\r\nexport function pasteDataUpdate(docs, preset, suppressNotif = false, excludePosition = false, transform = null) {\r\n  if (!docs || !docs.length) return false;\r\n\r\n  let documentName = docs[0].document ? docs[0].document.documentName : docs[0].documentName;\r\n\r\n  preset = preset ?? getClipboardData(documentName);\r\n  let applyType;\r\n\r\n  // Special handling for Tokens/Actors\r\n  if (!preset) {\r\n    if (documentName === 'Token') {\r\n      if (!preset) {\r\n        preset = getClipboardData('TokenProto');\r\n        applyType = 'meApplyToPrototype';\r\n      }\r\n\r\n      if (!preset) {\r\n        preset = getClipboardData('Actor');\r\n        documentName = 'Actor';\r\n        docs = docs.filter((d) => d.actor).map((d) => d.actor);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (preset) {\r\n    if (preset.documentName !== documentName) return;\r\n\r\n    const context = { meObjects: docs };\r\n    if (!foundry.utils.isEmpty(preset.randomize)) context.randomizeFields = preset.randomize;\r\n    if (!foundry.utils.isEmpty(preset.addSubtract)) context.addSubtractFields = preset.addSubtract;\r\n\r\n    const ogData = preset.data[Math.floor(Math.random() * preset.data.length)];\r\n    let data = foundry.utils.deepClone(ogData);\r\n    if (transform) {\r\n      DataTransform.apply(documentName, data, { x: 0, y: 0 }, transform);\r\n      data = foundry.utils.mergeObject(ogData, data, { insertKeys: false, inplace: false });\r\n    }\r\n    if (excludePosition) {\r\n      delete data.x;\r\n      delete data.y;\r\n      delete data.c;\r\n      delete data.elevation;\r\n    }\r\n\r\n    performMassUpdate.call(context, foundry.utils.flattenObject(data), docs, preset.documentName, applyType);\r\n    if (!suppressNotif)\r\n      ui.notifications.info(\r\n        localFormat('clipboard.paste', {\r\n          document: preset.documentName,\r\n          count: docs.length,\r\n        })\r\n      );\r\n\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n// ==================================\r\n// ========== CLIPBOARD =============\r\n// ==================================\r\n\r\nconst CLIPBOARD = {};\r\n\r\nexport function copyToClipboard(preset, command, isPrototype) {\r\n  CLIPBOARD[preset.documentName] = preset;\r\n\r\n  // Special handling for Actors/Tokens\r\n  if (preset.documentName === 'Token' && isPrototype) {\r\n    CLIPBOARD['TokenProto'] = preset;\r\n  } else if (preset.documentName === 'Token') {\r\n    if (command === 'copyProto') {\r\n      delete CLIPBOARD['Token'];\r\n      CLIPBOARD['TokenProto'] = preset;\r\n    }\r\n  }\r\n\r\n  // Also copy the fields to the game clipboard as plain text\r\n  game.clipboard.copyPlainText(\r\n    JSON.stringify(foundry.utils.deepClone(preset.data.length === 1 ? preset.data[0] : preset.data), null, 2)\r\n  );\r\n\r\n  ui.notifications.info(\r\n    localFormat('clipboard.copy', {\r\n      document: preset.documentName,\r\n    })\r\n  );\r\n}\r\n\r\nexport function getClipboardData(documentName) {\r\n  return CLIPBOARD[documentName];\r\n}\r\n\r\nexport function deleteFromClipboard(documentName) {\r\n  delete CLIPBOARD[documentName];\r\n  if (documentName === 'Token') delete CLIPBOARD['TokenProto'];\r\n}\r\n","import { getDocumentName, localize } from './utils.js';\r\n\r\nexport function injectVisibility(app) {\r\n  const documentName = getDocumentName(app.meObjects[0]);\r\n\r\n  // Only the following docs necessitate hidden field\r\n  if (!['AmbientLight', 'AmbientSound'].includes(documentName)) return;\r\n\r\n  const form = $(app.form);\r\n\r\n  const isInjected = form.find('input[name=\"hidden\"]');\r\n  if (isInjected.length) return;\r\n\r\n  const hidden = app.meObjects[0].hidden;\r\n  const newHtml = `\r\n  <div class=\"form-group\">\r\n    <label>${localize(`Hidden`, false)}</label>\r\n    <div class=\"form-fields\">\r\n        <input type=\"checkbox\" name=\"hidden\" ${hidden ? 'checked' : ''}>\r\n    </div>\r\n  </div>\r\n`;\r\n\r\n  const tabs = form.find('div.tab');\r\n  if (tabs.length) {\r\n    tabs.first().append(newHtml);\r\n  } else {\r\n    form.find('.form-group').last().after(newHtml);\r\n  }\r\n\r\n  //app.setPosition({ height: 'auto' });\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { hasMassEditUpdateDependency, objToString } from './generator.js';\r\n\r\nexport function genAction(options, documentName) {\r\n  if (options.method === 'update' || options.method === 'toggle') {\r\n    let command = ``;\r\n\r\n    if (options.method === 'toggle') command += genToggleUtil(options);\r\n\r\n    // Insert 'update' objects\r\n\r\n    command += `\\n// Updates to be applied\r\nconst update = ${objToString(options.fields)};\\n`;\r\n    if (options.method === 'toggle') command += `const update2 = ${objToString(options.toggle.fields)};\\n\\n`;\r\n\r\n    // Insert Mass Edit control objects\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      command += `\\n// Mass Edit control objects\\n`;\r\n      if (options.randomize) command += `const randomizeFields = ${objToString(options.randomize)};\\n`;\r\n      if (options.addSubtract) command += `const addSubtractFields = ${objToString(options.addSubtract)};\\n`;\r\n      if (options.toggle) {\r\n        if (options.toggle.randomize)\r\n          command += `const randomizeFieldsToggleOff = ${objToString(options.toggle?.randomize)};\\n`;\r\n        if (options.toggle.addSubtract)\r\n          command += `const addSubtractFieldsToggleOff = ${objToString(options.toggle?.addSubtract)};\\n`;\r\n      }\r\n    }\r\n\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      return command + genUpdateWithMassEditDep(options, documentName);\r\n    } else {\r\n      return command + genUpdate(options, documentName);\r\n    }\r\n  } else if (options.method === 'massEdit') {\r\n    return `\\n// Open Mass Edit Form\r\nawait MassEdit.api.showMassEdit(targets, '${documentName}');`;\r\n  } else if (options.method === 'delete') {\r\n    return genDelete(options, documentName);\r\n  }\r\n}\r\n\r\nfunction genDelete(options, documentName) {\r\n  let command = `\\n// Delete ${documentName}s`;\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    if (options.target.scope === 'selected' || options.target.scope === 'scene') {\r\n      command += `\\ncanvas.scene.deleteEmbeddedDocuments('${documentName}', targets.map(t => t.id));`;\r\n    } else {\r\n      command += `\\nconst toDelete = {};\r\ntargets.forEach( t => {\r\n  const sceneID = t.parent.id;\r\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\r\n  toDelete[sceneID].push(t.id);\r\n});\r\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${documentName}', toDelete[sceneID]));\r\n      `;\r\n    }\r\n  } else {\r\n    command += `\\n${documentName}.deleteDocuments(targets.map( t => t.id ));`;\r\n  }\r\n  return command;\r\n}\r\n\r\nfunction genUpdate(options, documentName) {\r\n  // Update related code\r\n  let command = '';\r\n\r\n  // Macro only execution, ignore update code\r\n  if (foundry.utils.isEmpty(options.fields) && !options.toggle) {\r\n    return '';\r\n  } else if (options.toggle && foundry.utils.isEmpty(options.toggle.fields) && foundry.utils.isEmpty(options.fields)) {\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n\r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n    `;\r\n  }\r\n\r\n  // We start generating update code here\r\n  // Are there macros to execute?\r\n  const macroTracking = (options.macro || options.toggle?.macro) && options.toggle;\r\n\r\n  if (macroTracking) {\r\n    command += `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  `;\r\n  }\r\n\r\n  // Setting up updates\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    command += '\\nconst updates = {};';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n\r\n  updates[sceneId].push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n  \r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n    updates[sceneId].push(u);\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    command += '\\nconst updates = [];';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    }\r\n  }\r\n\r\n  // Executing updates\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    command += `\r\nfor(const sceneId of Object.keys(updates)) {\r\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${documentName}', updates[sceneId]);\r\n}\r\n  `;\r\n  } else if (documentName === 'PlaylistSound') {\r\n    command += `\r\nfor (let i = 0; i < targets.length; i++) {\r\n  delete updates[i]._id;\r\n  targets[i].document.update(updates[i]);\r\n}\r\n  `;\r\n  } else {\r\n    command += `\\n${documentName}.updateDocuments(updates);\\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genUpdateWithMassEditDep(options, documentName) {\r\n  let context = [];\r\n  if (options.randomize) context.push('randomizeFields');\r\n  if (options.addSubtract) context.push('addSubtractFields');\r\n  context = context.join(', ');\r\n\r\n  if (options.method === 'toggle') {\r\n    let context2 = [];\r\n    if (options.toggle?.randomize) context2.push('randomizeFields: randomizeFieldsToggleOff');\r\n    if (options.toggle?.addSubtract) context2.push('addSubtractFields: addSubtractFieldsToggleOff');\r\n    context2 = context2.join(', ');\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  \r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n  \r\nawait MassEdit.api.performMassUpdate.call({${context}}, update, toggleOnTargets, '${documentName}');\r\nawait MassEdit.api.performMassUpdate.call({${context2}}, update2, toggleOffTargets, '${documentName}');\r\n`;\r\n  } else {\r\n    return `await MassEdit.api.performMassUpdate.call({${context}}, update, targets, '${documentName}');\\n`;\r\n  }\r\n}\r\n\r\nfunction genToggleUtil(options) {\r\n  let command = `\\n// Toggle; Helper function`;\r\n  if (options.toggle.method === 'field') {\r\n    command += `\r\nconst toggleOn = function (obj, fields) {\r\n  const data = foundry.utils.flattenObject(obj.toObject());\r\n  fields = foundry.utils.flattenObject(fields);\r\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\r\n};\r\n  `;\r\n  } else {\r\n    command += `\r\nconst macro = this;\r\nconst toggleOn = function (obj) {\r\n  if (obj.getFlag('world', \\`macro-\\${macro.id}-toggleOn\\`)) {\r\n    obj.unsetFlag('world', \\`macro-\\${macro.id}-toggleOn\\`);\r\n    return true;\r\n  } else {\r\n    obj.setFlag('world', \\`macro-\\${macro.id}-toggleOn\\`, true);\r\n    return false;\r\n  }\r\n};\r\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { objToString } from './generator.js';\r\n\r\nexport function genTargets(options, documentName, selected) {\r\n  const target = options.target;\r\n  if (target.method === 'ids') {\r\n    return genIDTargets(target, documentName, selected);\r\n  } else if (target.method === 'search') {\r\n    return genSearch(target, documentName);\r\n  } else if (target.method === 'tagger') {\r\n    return genTaggerTargets(target, documentName);\r\n  } else if (target.method === 'all') {\r\n    return genAllTargets(target, documentName);\r\n  } else {\r\n    throw new Error('Invalid target method: ' + target.method);\r\n  }\r\n}\r\n\r\nfunction genSearch(target, documentName) {\r\n  let fields = objToString(target.fields);\r\n  if (target.scope === 'selected') {\r\n    let command = genSelected(documentName);\r\n    command += `\\ntargets = await MassEdit.api.performMassSearch('meSearch', '${documentName}' , ${fields}, { scope: 'selected', selected: targets, control: false, pan: false });`;\r\n    return command;\r\n  } else if (target.scope === 'scene') {\r\n    return `const targets = await MassEdit.api.performMassSearch('meSearch', '${documentName}' , ${fields}, { scope: 'scene', control: false, pan: false });`;\r\n  } else if (target.scope === 'world') {\r\n    return `const targets = await MassEdit.api.performMassSearch('meSearch', '${documentName}' , ${fields}, { scope: 'world', control: false, pan: false });`;\r\n  }\r\n}\r\n\r\n// Construct all selected document retriever\r\n// const selected = [...];\r\nfunction genSelected(documentName) {\r\n  let command = '';\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    return `let targets = canvas.getLayerByEmbeddedName('${documentName}').controlled.map(o => o.document);\\n\\n`;\r\n  } else if (game.modules.get('multiple-document-selection')?.active) {\r\n    const mdsClasses = {\r\n      Actor: 'actor',\r\n      Scene: 'scene',\r\n      JournalEntry: 'journalentry',\r\n      Playlist: 'sound',\r\n      Item: 'item',\r\n      RollTable: 'RollTable',\r\n      Cards: 'cards',\r\n    };\r\n\r\n    command += 'let targets = [];\\n';\r\n\r\n    if (documentName === 'Playlist') {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[documentName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n  if (d) targets.push(d);\r\n});\r\n`;\r\n    } else {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[documentName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('${documentName}').get(this.dataset.documentId);\r\n  if (d) targets.push(d);\r\n});\r\n  `;\r\n    }\r\n    return command;\r\n  } else {\r\n    throw new Error(`'Selected' is not a supported options for ${documentName}s`);\r\n  }\r\n}\r\n\r\nfunction genAllTargets(target, documentName) {\r\n  if (target.scope === 'selected') {\r\n    return genSelected(documentName);\r\n  } else if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    if (target.scope === 'scene') {\r\n      return `const targets = canvas.getLayerByEmbeddedName('${documentName}').placeables.map(o => o.document);\\n\\n`;\r\n    } else if (target.scope === 'world') {\r\n      return `const targets = [];\r\nArray.from(game.scenes).forEach( scene => {\r\n  Array.from( scene.getEmbeddedCollection('${documentName}') ).forEach(embed => targets.push(embed));\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    return `const targets = Array.from(game.collections.get('${documentName}'));`;\r\n  }\r\n}\r\n\r\nfunction genTaggerTargets(target, documentName) {\r\n  let command = '';\r\n  const opts = {\r\n    matchAny: target.tagger.match === 'any',\r\n    allScenes: target.scope === 'world',\r\n  };\r\n\r\n  if (target.scope === 'selected') {\r\n    command += genSelected(documentName);\r\n    command += `targets = Tagger.getByTag('${target.tagger.tags}', { matchAny: ${\r\n      target.tagger.match === 'any'\r\n    }, objects: targets }).filter(t => t.documentName === '${documentName}');\\n\\n`;\r\n  } else if (target.scope === 'scene') {\r\n    command += `const targets = Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )}).filter(t => t.documentName === '${documentName}');\\n\\n`;\r\n  } else if (target.scope === 'world') {\r\n    command += `const targets = [];`;\r\n    command += `Object.values(Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )})).forEach(item => item.forEach(t => { if(t.documentName === '${documentName}') targets.push(t) }));`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genIDTargets(target, documentName, selected) {\r\n  let command = `const ids = [${selected.map((p) => `\"${p.id}\"`).join(',')}];\\n`;\r\n  command += `const targets = [];`;\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    command += `\r\nids.forEach( id => {\r\n  Array.from(game.scenes).forEach( scene => {\r\n    let embed = scene.getEmbeddedDocument('${documentName}', id);\r\n    if(embed) targets.push(embed)\r\n  });\r\n});\r\n`;\r\n  } else {\r\n    command += `\r\nids.forEach(id => { \r\n  const doc = ${documentName}.get(id);\r\n  if(doc) targets.push(doc);\r\n});`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS } from '../constants.js';\r\nimport { localFormat } from '../utils.js';\r\nimport { genAction } from './action.js';\r\nimport { genTargets } from './targets.js';\r\n\r\n// Util to stringify a json object\r\nexport function objToString(obj) {\r\n  if (!obj) return null;\r\n  return JSON.stringify(obj, null, 2);\r\n}\r\n\r\nexport async function generateMacro(documentName, placeables, options) {\r\n  let command = '';\r\n\r\n  // Dependencies get checked first\r\n  command += genMacroDependencies(options, documentName);\r\n  command += genTargets(options, documentName, placeables);\r\n  command += genAction(options, documentName);\r\n  if (options.macro || options.toggle?.macro) {\r\n    command += genRunMacro(options, documentName);\r\n  }\r\n\r\n  if (command) {\r\n    // Create Macro\r\n    const macro = await Macro.create({\r\n      name: options.name,\r\n      type: 'script',\r\n      scope: 'global',\r\n      command: command,\r\n    });\r\n    macro.sheet.render(true);\r\n  }\r\n}\r\n\r\nfunction genRunMacro(options, documentName) {\r\n  let command = `\\n\r\n// ===================\r\n// = Macro Execution =\r\n// ===================\r\n\r\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\r\nconst layer = canvas.getLayerByEmbeddedName('${documentName}');\r\n`;\r\n  // Run macros if applicable\r\n  if (options.macro) {\r\n    command += `\r\n// Apply macro\r\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${options.macro.name}')\r\nif (applyMacro && ${options.toggle ? 'toggleOnTargets' : 'targets'}.length) {\r\n  ${\r\n    options.macro.select\r\n      ? `layer.activate();\\n  layer.releaseAll();\\n  ${\r\n          options.toggle ? 'toggleOnTargets' : 'targets'\r\n        }.forEach(t => t.object?.control({ releaseOthers: false }));\\n`\r\n      : ''\r\n  }\r\n  if (advancedMacro) applyMacro.execute(${options.toggle ? 'toggleOnTargets' : 'targets'});\r\n  else applyMacro.execute({token, actor});\r\n  ${options.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  if (options.toggle?.macro) {\r\n    command += `\r\n// Apply macro on toggle off\r\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${options.toggle.macro.name}')\r\nif (offMacro && toggleOffTargets.length) {\r\n  ${\r\n    options.toggle.macro.select\r\n      ? 'layer.activate();\\n  layer.releaseAll();\\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\\n'\r\n      : ''\r\n  }\r\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\r\n  else offMacro.execute({token, actor});\r\n  ${options.toggle.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  return command;\r\n}\r\n\r\nexport function hasMassEditDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    options.target.method === 'search' ||\r\n    options.method === 'massEdit' ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nexport function hasMassEditUpdateDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nfunction genMacroDependencies(options, documentName) {\r\n  let dep = '';\r\n\r\n  const depWarning = (module) => {\r\n    return `ui.notifications.warn('${localFormat('macro.dependency-warning', {\r\n      module,\r\n    })}');`;\r\n  };\r\n\r\n  if (options.target.method === 'tagger')\r\n    dep += `\r\nif (!game.modules.get('tagger')?.active) {\r\n  ${depWarning('Tagger')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (hasMassEditDependency(options))\r\n    dep += `\r\nconst MassEdit = game.modules.get('${MODULE_ID}');\r\nif(!MassEdit?.active){\r\n  ${depWarning('Mass Edit')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (SUPPORTED_COLLECTIONS.includes(documentName) && options.target.scope === 'select')\r\n    dep += `\r\nif (!game.modules.get('multiple-document-selection')?.active) {\r\n  ${depWarning('Multiple Document Selection')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  return dep;\r\n}\r\n\r\nexport function hasSpecialField(fields) {\r\n  const specialFields = ['tokenmagic.ddTint', 'tokenmagic.preset', 'massedit.scale', 'massedit.texture.scale'];\r\n  for (const sf of specialFields) {\r\n    if (sf in fields) return true;\r\n  }\r\n  return false;\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from '../scripts/constants.js';\r\nimport { generateMacro, hasSpecialField } from '../scripts/macro/generator.js';\r\nimport { localFormat, localize } from '../scripts/utils.js';\r\nimport { GeneralDataAdapter } from './dataAdapters.js';\r\n\r\nexport default class MacroForm extends FormApplication {\r\n  constructor(object, placeables, documentName, fields, randomizeFields, addSubtractFields) {\r\n    super({}, {});\r\n    this.mainObject = object;\r\n    this.placeables = placeables;\r\n    this.documentName = documentName;\r\n    this.fields = fields;\r\n    this.randomizeFields = randomizeFields;\r\n    this.addSubtractFields = addSubtractFields;\r\n\r\n    if (\r\n      (randomizeFields && !foundry.utils.isEmpty(randomizeFields)) ||\r\n      (addSubtractFields && !foundry.utils.isEmpty(addSubtractFields))\r\n    ) {\r\n      // keep selected fields in form format\r\n    } else {\r\n      GeneralDataAdapter.formToData(this.documentName, this.mainObject, this.fields);\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-macro',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/macro.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generate Macro`,\r\n      width: 400,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    data.documentName = this.documentName;\r\n    data.fields = JSON.stringify(this.fields, null, 2);\r\n    data.selectable = SUPPORTED_PLACEABLES.includes(this.documentName);\r\n    data.selectScopeEnabled =\r\n      data.selectable ||\r\n      (SUPPORTED_COLLECTIONS.includes(this.documentName) && game.modules.get('multiple-document-selection')?.active);\r\n\r\n    // Define targeting options based on the document being updated\r\n    const targetingOptions = [\r\n      {\r\n        value: 'all',\r\n        title: localFormat('macro.target-all-title', { document: this.documentName }),\r\n        label: localize('common.all'),\r\n      },\r\n      {\r\n        value: 'ids',\r\n        title: localize('macro.target-ids-title'),\r\n        label: localize('macro.target-ids'),\r\n      },\r\n      {\r\n        value: 'search',\r\n        title: localFormat('macro.target-search-title', { document: this.documentName }),\r\n        label: localize('FILES.Search', false),\r\n      },\r\n    ];\r\n    if (SUPPORTED_PLACEABLES.includes(this.documentName) && game.modules.get('tagger')?.active) {\r\n      targetingOptions.push({\r\n        value: 'tagger',\r\n        title: localize('macro.target-tagger-title'),\r\n        label: 'Tagger',\r\n      });\r\n    }\r\n    data.targetingOptions = targetingOptions;\r\n\r\n    if (this.addSubtractFields && !foundry.utils.isEmpty(this.addSubtractFields)) {\r\n      data.hasAddSubtract = true;\r\n      data.addSubtract = JSON.stringify(this.addSubtractFields);\r\n    }\r\n\r\n    if (this.randomizeFields && !foundry.utils.isEmpty(this.randomizeFields)) {\r\n      data.hasRandom = true;\r\n      data.randomize = JSON.stringify(this.randomizeFields);\r\n    }\r\n\r\n    data.hasMEControls = data.hasAddSubtract || data.hasRandom || hasSpecialField(this.fields);\r\n\r\n    // Visibility Toggle\r\n    data.hiddenControl = ['Token', 'Tile', 'Drawing', 'AmbientLight', 'AmbientSound', 'MeasuredTemplate'].includes(\r\n      this.documentName\r\n    );\r\n\r\n    // Macros\r\n    data.macros = game.collections.get('Macro').map((m) => m.name);\r\n\r\n    return data;\r\n  }\r\n\r\n  _onShowReturnJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    const data = JSON.parse(store.val());\r\n\r\n    let content = `<textarea name=\"json\" style=\"width:100%; height: 300px;\">${JSON.stringify(\r\n      data,\r\n      null,\r\n      2\r\n    )}</textarea>`;\r\n    new Dialog({\r\n      title: `JSON`,\r\n      content: content,\r\n      buttons: {\r\n        Ok: {\r\n          label: localize('Save', false),\r\n          callback: (html) => {\r\n            try {\r\n              const val = JSON.parse(html.find('[name=\"json\"]').val() || '{}');\r\n              if (foundry.utils.isEmpty(val)) {\r\n                control.hide();\r\n                store.prop('disabled', true);\r\n                this.setPosition({ height: 'auto' });\r\n              } else {\r\n                store.val(JSON.stringify(val));\r\n              }\r\n            } catch (e) {\r\n              ui.notifications.warn('Invalid data. Failed to save.');\r\n            }\r\n          },\r\n        },\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  _onRemoveJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    control.hide();\r\n    store.prop('disabled', true);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    ['randomize', 'addSubtract', 'toggle.randomize', 'toggle.addSubtract'].forEach((name) => {\r\n      const className = name.replace('.', '');\r\n      html.find(`.${className}`).click((event) => {\r\n        this._onShowReturnJson($(event.target).parent(), name);\r\n      });\r\n      html.find(`.${className}`).contextmenu((event) => {\r\n        this._onRemoveJson($(event.target).parent(), name);\r\n      });\r\n    });\r\n\r\n    html.find('.toggleVisibility').click((event) => {\r\n      const fields = html.find('[name=\"fields\"]');\r\n      const toggleFields = html.find('[name=\"toggle.fields\"]');\r\n\r\n      let update,\r\n        update2 = {};\r\n\r\n      try {\r\n        update = JSON.parse(fields.val());\r\n        update.hidden = !update.hidden;\r\n        fields.val(JSON.stringify(update, null, 2));\r\n\r\n        update2 = JSON.parse(toggleFields.val());\r\n        update2.hidden = !update.hidden;\r\n        toggleFields.val(JSON.stringify(update2, null, 2));\r\n      } catch (e) {}\r\n    });\r\n\r\n    html.find('[name=\"target.method\"]').change((event) => {\r\n      // Hide/show tagger controls\r\n      if (event.target.value === 'tagger') {\r\n        html.find('.taggerControl').show();\r\n        html.find('[name=\"tags\"').attr('required', true);\r\n      } else {\r\n        html.find('.taggerControl').hide();\r\n        html.find('[name=\"tags\"').attr('required', false);\r\n      }\r\n\r\n      // Hide/show scope\r\n      if (event.target.value === 'ids') html.find('[name=\"target.scope\"]').closest('.form-group').hide();\r\n      else html.find('[name=\"target.scope\"]').closest('.form-group').show();\r\n\r\n      if (event.target.value === 'search') html.find('[name=\"target.fields\"]').closest('div').show();\r\n      else html.find('[name=\"target.fields\"]').closest('div').hide();\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.find('[name=\"method\"]').on('change', (event) => {\r\n      if (event.target.value === 'toggle') {\r\n        let data = foundry.utils.flattenObject(getData(this.mainObject).toObject());\r\n\r\n        const toggleFields = {};\r\n        Object.keys(this.fields).forEach((k) => (toggleFields[k] = data[k]));\r\n        html.find('[name=\"toggle.fields\"]').val(JSON.stringify(toggleFields, null, 2));\r\n        html.find('.toggleControl').show();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.toggleControl').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n\r\n      if (event.target.value === 'massEdit' || event.target.value === 'delete') {\r\n        html.find('.fields').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.fields').show();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    formData = expandObject(formData);\r\n\r\n    // Cleanup form data so that the macro generator only receives necessary information\r\n    formData.fields = JSON.parse(formData.fields);\r\n    if (formData.method !== 'toggle') delete formData.toggle;\r\n    else formData.toggle.fields = JSON.parse(formData.toggle.fields);\r\n\r\n    if (!formData.macro.name) delete formData.macro;\r\n    if (formData.toggle?.macro && !formData.toggle.macro.name) delete formData.toggle.macro;\r\n\r\n    if (formData.target.method !== 'tagger') delete formData.target.tagger;\r\n    if (formData.target.method !== 'search') delete formData.target.fields;\r\n    else formData.target.fields = JSON.parse(formData.target.fields);\r\n\r\n    if (formData.randomize) formData.randomize = JSON.parse(formData.randomize);\r\n    if (formData.toggle?.randomize) formData.toggle.randomize = JSON.parse(formData.toggle.randomize);\r\n    if (formData.addSubtract) formData.addSubtract = JSON.parse(formData.addSubtract);\r\n    if (formData.toggle?.addSubtract) formData.toggle.addSubtract = JSON.parse(formData.toggle.addSubtract);\r\n\r\n    generateMacro(this.documentName, this.placeables, formData);\r\n  }\r\n}\r\n\r\nfunction getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n","import { Brush } from '../scripts/brush.js';\r\nimport { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from '../scripts/constants.js';\r\nimport { injectVisibility } from '../scripts/fieldInjector.js';\r\nimport { MassEditPresets } from '../scripts/presets/forms.js';\r\nimport { Preset } from '../scripts/presets/preset.js';\r\nimport { selectRandomizerFields } from '../scripts/randomizer/randomizerUtils.js';\r\nimport { getDDTint } from '../scripts/tmfx.js';\r\nimport { getDocumentName, hasFlagRemove, localFormat, localize, selectAddSubtractFields } from '../scripts/utils.js';\r\nimport { getInUseStyle } from './cssEdit.js';\r\nimport { GeneralDataAdapter, TokenDataAdapter } from './dataAdapters.js';\r\nimport { copyToClipboard, getCommonDocData, onInputChange, performMassSearch, performMassUpdate } from './formUtils.js';\r\nimport { WithMassPermissions } from './forms.js';\r\nimport MacroForm from './macro.js';\r\nimport { showMassActorForm } from './multiConfig.js';\r\n\r\nexport const WithBaseMassEditForm = (cls) => {\r\n  class BaseMassEditForm extends cls {\r\n    constructor(doc, docs, options) {\r\n      if (options.massSelect) options.randomizerEnabled = false;\r\n      const documentName = options.documentName ?? getDocumentName(doc);\r\n      if (!options.commonData) options.commonData = getCommonDocData(docs, documentName);\r\n\r\n      BaseMassEditForm._setMEActions(options);\r\n\r\n      if (\r\n        foundry.utils.isNewerVersion(game.version, 12) &&\r\n        (documentName === 'AmbientSound' || documentName === 'AmbientLight' || documentName === 'Region')\r\n      ) {\r\n        options.document = doc;\r\n        super(options);\r\n      } else {\r\n        super(doc, options);\r\n      }\r\n\r\n      this.meObjects = docs;\r\n      this.documentName = documentName;\r\n      this.commonData = foundry.utils.flattenObject(options.commonData || {});\r\n      this.randomizerEnabled = options.massEdit;\r\n      this.randomizeFields = {};\r\n      this.addSubtractFields = {};\r\n      this.meForm = true;\r\n      this.rangeSpanToTextbox = game.settings.get(MODULE_ID, 'rangeToTextbox');\r\n    }\r\n\r\n    get baseDocument() {\r\n      throw Error('The getBaseDocument() method must be defined by a subclass.');\r\n    }\r\n\r\n    get title() {\r\n      if (this.options.massSelect) return localFormat('form.mass-search-title', { document: this.documentName });\r\n      return localFormat('form.mass-edit-title', { document: this.documentName, count: this.meObjects.length });\r\n    }\r\n\r\n    /**\r\n     * Form Submit\r\n     * @param {*} event\r\n     * @param {*} formData\r\n     * @returns\r\n     */\r\n    static async massUpdateObject(event, control) {\r\n      control = $(control);\r\n      if (!control.data('action')) return;\r\n\r\n      // Gather up all named fields that have mass-edit-checkbox checked\r\n      const selectedFields = this.getSelectedFields();\r\n\r\n      // Detection modes may have been selected out of order\r\n      // Fix that here\r\n      if (this.documentName === 'Token') {\r\n        TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n      }\r\n\r\n      // Preset editing\r\n      if (this.options.presetEdit) {\r\n        this.options.callback?.({\r\n          data: selectedFields,\r\n          addSubtract: this.addSubtractFields,\r\n          randomize: this.randomizeFields,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Search and Select mode\r\n      if (this.options.massSelect) {\r\n        return performMassSearch(control.data('action'), this.documentName, selectedFields, {\r\n          scope: this.modUpdate ? this.modUpdateType : null,\r\n        });\r\n      } else {\r\n        // Edit mode\r\n        return performMassUpdate.call(this, selectedFields, this.meObjects, this.documentName, control.data('action'));\r\n      }\r\n    }\r\n\r\n    getSelectedFields(formData) {\r\n      if (!formData) formData = this._getSubmitData();\r\n\r\n      // Some module flags get un-flattened\r\n      // Flatten them again before attempting to find selected\r\n      formData = foundry.utils.flattenObject(formData);\r\n\r\n      // Modules Specific Logic\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in formData) {\r\n        formData['flags.levels-3d-preview.shaders'] = this.baseDocument.getFlag('levels-3d-preview', 'shaders');\r\n      }\r\n      // == End of Module specific logic\r\n\r\n      // Token _getSubmitData() performs conversions related to scale, we need to undo them here\r\n      // so that named fields on the form match up and can be selected\r\n      if (this.documentName === 'Token') {\r\n        if (formData['texture.scaleX']) {\r\n          formData.scale = Math.abs(formData['texture.scaleX']);\r\n          formData.mirrorX = formData['texture.scaleX'] < 0;\r\n          formData.mirrorY = formData['texture.scaleY'] < 0;\r\n        }\r\n      } else if (this.documentName === 'Note') {\r\n        if (formData['texture.src']) {\r\n          formData['icon.selected'] = formData['texture.src'];\r\n          formData['icon.custom'] = formData['texture.src'];\r\n        }\r\n      }\r\n\r\n      const selectedFields = {};\r\n      const html = $(this.element);\r\n      const addSubtractFields = this.addSubtractFields;\r\n      const app = this;\r\n\r\n      html.find('.form-group').each(function (_) {\r\n        const me_checkbox = $(this).find('.mass-edit-checkbox > input');\r\n        if (me_checkbox.length && me_checkbox.is(':checked')) {\r\n          $(this)\r\n            .find('[name]')\r\n            .each(function (_) {\r\n              const name = $(this).attr('name');\r\n\r\n              // Module specific logic\r\n              if (name === 'flags.limits') {\r\n                const limits = foundry.utils.flattenObject(app.meObjects[0].toObject().flags['limits'] ?? {});\r\n                for (const [k, v] of Object.entries(limits)) {\r\n                  selectedFields['flags.limits.' + k] = v;\r\n                }\r\n              }\r\n              // == End of Module specific logic\r\n\r\n              // Some modules will process their flags to remove them using -= notation\r\n              // Need to account for this when selecting fields\r\n              if (formData[name] === undefined && name.startsWith('flags.')) {\r\n                const removeFlag = hasFlagRemove(name, formData);\r\n                if (removeFlag) {\r\n                  selectedFields[removeFlag] = null;\r\n                }\r\n              } else {\r\n                selectedFields[name] = formData[name];\r\n                if (name in addSubtractFields) {\r\n                  addSubtractFields[name].value = formData[name];\r\n                }\r\n              }\r\n\r\n              if (foundry.utils.getType(selectedFields[name]) === 'string') {\r\n                const input = $(this);\r\n                if (input.hasClass('tva-array')) {\r\n                  if (v.trim()) {\r\n                    selectedFields[name] = selectedFields[name]\r\n                      .trim()\r\n                      .split(',')\r\n                      .map((s) => s.trim());\r\n                  } else {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                } else if (input.hasClass('tva-jsonArray')) {\r\n                  try {\r\n                    selectedFields[name] = JSON.parse(selectedFields[name]);\r\n                  } catch (e) {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                }\r\n              }\r\n            });\r\n        }\r\n      });\r\n\r\n      return selectedFields;\r\n    }\r\n\r\n    /**\r\n     * Copy currently selected field to the clipboard\r\n     */\r\n    performMassCopy({ command = '', selectedFields = null } = {}) {\r\n      if (!selectedFields) {\r\n        selectedFields = this.getSelectedFields();\r\n        if (this.documentName === 'Token') {\r\n          TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n        }\r\n      }\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return false;\r\n\r\n      const preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: selectedFields,\r\n        randomize: this.randomizeFields,\r\n        addSubtract: this.addSubtractFields,\r\n      });\r\n      copyToClipboard(preset, command, this.isPrototype);\r\n      return true;\r\n    }\r\n\r\n    /**\r\n     * Control button style\r\n     * @param {*} html\r\n     */\r\n    _setStyle(html) {\r\n      const [styleName, css] = getInUseStyle();\r\n      html.prepend(`<style>${css}</style>`);\r\n    }\r\n\r\n    _injectGlobalDeleteButton(html) {\r\n      if (!(SUPPORTED_PLACEABLES.includes(this.documentName) || SUPPORTED_COLLECTIONS.includes(this.documentName)))\r\n        return;\r\n\r\n      const control = $(\r\n        `<div class=\"me-global-delete\"><a title=\"${localize(\r\n          'form.global-delete-title'\r\n        )}\"><i class=\"far fa-times-octagon fa-2x\"></i></a></div>`\r\n      );\r\n      control.click((event) => {\r\n        new Dialog({\r\n          title: 'Confirm',\r\n          content: `\r\n                <h2 style=\"color: red; text-align: center;\">${localFormat('form.delete-warning', {\r\n                  count: this.meObjects.length,\r\n                  document: this.documentName,\r\n                })}</h2>\r\n                <p>${localize('form.proceed')}</p>`,\r\n          buttons: {\r\n            buttonA: {\r\n              label: localize('Yes', false),\r\n              callback: () => {\r\n                this.meObjects.forEach((obj) => {\r\n                  let doc = obj.document ?? obj;\r\n                  if (doc.delete) doc.delete();\r\n                });\r\n                this.close();\r\n              },\r\n            },\r\n            no: {\r\n              label: localize('No', false),\r\n            },\r\n          },\r\n          default: 'buttonA',\r\n        }).render(true);\r\n      });\r\n      html.closest('form').append(control);\r\n    }\r\n\r\n    _activateAutoSelectListeners(html) {\r\n      // On any field being changed we want to automatically select the form-group to be included in the update\r\n      html.on(\r\n        'input',\r\n        'textarea, input[type=\"text\"], input[type=\"number\"], range-picker, color-picker',\r\n        onInputChange.bind(this)\r\n      );\r\n      html.on('change', 'textarea, input, select', onInputChange.bind(this));\r\n      html.on('paste', 'input', onInputChange.bind(this));\r\n      html.on('click', 'button', onInputChange.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Add Mass Edit controls to a .form-group\r\n     * @param {*} formGroup\r\n     * @param {*} typeOverride\r\n     * @returns\r\n     */\r\n    _processFormGroup(formGroup, typeOverride = null) {\r\n      // We only want to attach extra controls if the form-group contains named fields\r\n      if (!$(formGroup).find('[name]').length) return;\r\n      // Return if a checkbox is already inserted\r\n      if ($(formGroup).find('.mass-edit-checkbox').length) return;\r\n      // if ($(formGroup).find('[name]:disabled').length) return;\r\n\r\n      const commonData = this.commonData;\r\n      const rangeSpanToTextbox = this.rangeSpanToTextbox;\r\n      const insertRNGControl = this.randomizerEnabled;\r\n\r\n      // Check if fields within this form-group are part of common data or control a flag\r\n      let fieldType = 'meCommon';\r\n      if (commonData) {\r\n        $(formGroup)\r\n          .find('[name]')\r\n          .each(function () {\r\n            const name = $(this).attr('name');\r\n\r\n            if (rangeSpanToTextbox && $(this).attr('type') === 'range') {\r\n              const span = $(formGroup).find('span.range-value');\r\n              if (span.length) {\r\n                span.replaceWith(\r\n                  $(\r\n                    `<input name=\"${name}\" class=\"range-value\" type=\"number\" step=\"any\" value=\"${this.defaultValue}\" min=\"${this.min}\" max=\"${this.max}\"></input>`\r\n                  )\r\n                );\r\n                $(this).removeAttr('name');\r\n              }\r\n            }\r\n\r\n            if (name.startsWith('flags.')) {\r\n              fieldType = 'meFlag';\r\n            } else if (!(name in commonData)) {\r\n              // We want to ignore certain fields from commonData checks e.g. light invert-radius\r\n\r\n              if (name === 'invert-radius') {\r\n              } else {\r\n                fieldType = 'meDiff';\r\n              }\r\n            }\r\n          });\r\n      }\r\n\r\n      // Add randomizer controls\r\n      let randomControl = '';\r\n      if (insertRNGControl) {\r\n        randomControl = '<div class=\"mass-edit-randomize\"></div>';\r\n      }\r\n\r\n      fieldType = typeOverride ?? fieldType;\r\n\r\n      // Insert the checkbox\r\n      const checkbox = $(\r\n        `<div class=\"mass-edit-checkbox ${fieldType}\">${randomControl}<input class=\"mass-edit-control\" type=\"checkbox\" data-dtype=\"Boolean\"}></div>`\r\n      );\r\n      if ($(formGroup).find('p.hint, p.notes').length) {\r\n        $(formGroup).find('p.hint, p.notes').first().before(checkbox);\r\n      } else {\r\n        $(formGroup).append(checkbox);\r\n      }\r\n\r\n      // Assign field type to the form group. Will be used to set appropriate visual look\r\n      $(formGroup).addClass(fieldType);\r\n    }\r\n\r\n    /**\r\n     * Add Mass Edit control for all .form-group's within the html\r\n     * @param {*} html\r\n     */\r\n    _processAllFormGroups(html) {\r\n      const processFormGroup = this._processFormGroup.bind(this);\r\n      // Add checkboxes to each form-group to control highlighting and which fields are to be saved\r\n      html.find('.form-group').each(function (_) {\r\n        processFormGroup(this);\r\n      });\r\n    }\r\n\r\n    async _processPreset(preset) {\r\n      // This will be called when a preset item is selected or JSON data is being directly applied\r\n      // The code bellow handles it being applied to the current form\r\n\r\n      // =====================\r\n      // Module specific logic\r\n      // =====================\r\n      let timeoutRequired = false;\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n      // Monk's Active Tiles\r\n      if ('flags.monks-active-tiles.actions' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.setFlag('monks-active-tiles', 'actions', data['flags.monks-active-tiles.actions']);\r\n      }\r\n\r\n      if ('flags.monks-active-tiles.files' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.setFlag('monks-active-tiles', 'files', data['flags.monks-active-tiles.files']);\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.setFlag('levels-3d-preview', 'shaders', data['flags.levels-3d-preview.shaders']);\r\n      }\r\n\r\n      // Limits\r\n      if ('flags.limits.light.enabled' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.update({ flags: { limits: foundry.utils.expandObject(data).flags.limits } });\r\n      }\r\n\r\n      if (this.documentName === 'Token') {\r\n        timeoutRequired = TokenDataAdapter.modifyPresetData(this, data);\r\n      }\r\n\r\n      if (timeoutRequired) {\r\n        setTimeout(() => {\r\n          this._applyPreset(preset);\r\n        }, 250);\r\n        return;\r\n      }\r\n\r\n      this._applyPreset(preset);\r\n    }\r\n\r\n    /**\r\n     * Apply preset to the form\r\n     * @param {Preset} preset\r\n     */\r\n    _applyPreset(preset) {\r\n      const form = $(this.form);\r\n\r\n      const customMerge = (obj1, obj2) => {\r\n        if (!obj2) return obj1;\r\n        for (const [k, v] of Object.entries(obj2)) {\r\n          obj1[k] = v;\r\n        }\r\n        return obj1;\r\n      };\r\n\r\n      this.randomizeFields = customMerge(this.randomizeFields, preset.randomize);\r\n      this.addSubtractFields = customMerge(this.addSubtractFields, preset.addSubtract);\r\n      selectRandomizerFields(form, this.randomizeFields);\r\n      selectAddSubtractFields(form, this.addSubtractFields);\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n      GeneralDataAdapter.dataToForm(this.documentName, preset.data[0], data);\r\n      for (const key of Object.keys(data)) {\r\n        const el = form.find(`[name=\"${key}\"]`);\r\n        if (el.is(':checkbox')) {\r\n          el.prop('checked', data[key]);\r\n        } else {\r\n          el.val(data[key]);\r\n        }\r\n        el.trigger('change');\r\n      }\r\n\r\n      // Make brush aware of randomized field changes\r\n      Brush.refreshPreset();\r\n    }\r\n\r\n    _registerRandomizerListeners(html) {\r\n      const context = this;\r\n      if (this.randomizerEnabled) {\r\n        html.on('contextmenu', '.mass-edit-checkbox', (event) => {\r\n          import('../scripts/randomizer/randomizerForm.js').then((module) => {\r\n            module.showRandomizeDialog($(event.target).closest('.form-group'), context);\r\n          });\r\n        });\r\n      }\r\n    }\r\n\r\n    // We want to update fields used by brush control every time a field changes on the form\r\n    _registerBrushRefreshListeners(html) {\r\n      html.on('input', 'textarea, input[type=\"text\"], input[type=\"number\"]', () => Brush.refreshPreset());\r\n      html.on('change', 'textarea, input, select', () => Brush.refreshPreset());\r\n      html.on('paste', 'input', () => Brush.refreshPreset());\r\n      html.on('click', 'button', () => Brush.refreshPreset());\r\n    }\r\n\r\n    _registerNumericalInputListeners(html) {\r\n      html.on(\r\n        'contextmenu',\r\n        'input[type=range], input[type=number], input[name=\"flags.tagger.tags\"], input[type=\"text\"], input[name=\"tokenmagic.preset\"]',\r\n        (event) => {\r\n          const name = event.target.name;\r\n          if (!name) return;\r\n\r\n          const input = $(event.target);\r\n          if (name in this.addSubtractFields) {\r\n            if (this.addSubtractFields[name].method === 'add') {\r\n              this.addSubtractFields[name].method = 'subtract';\r\n              input.removeClass('me-add').addClass('me-subtract');\r\n              input.attr('title', '- Subtracting');\r\n              const ctrl = { method: 'subtract' };\r\n              if (event.target.min) {\r\n                ctrl.min = parseFloat(event.target.min);\r\n              }\r\n              ctrl.type = input.attr('type');\r\n              this.addSubtractFields[name] = ctrl;\r\n            } else {\r\n              delete this.addSubtractFields[name];\r\n              input.removeClass('me-subtract');\r\n              input.attr('title', '');\r\n            }\r\n          } else {\r\n            input.addClass('me-add');\r\n            input.attr('title', '+ Adding');\r\n            const ctrl = { method: 'add' };\r\n            if (event.target.max) {\r\n              ctrl.max = parseFloat(event.target.max);\r\n            }\r\n            ctrl.type = input.attr('type');\r\n            this.addSubtractFields[name] = ctrl;\r\n          }\r\n\r\n          // Select nearest mass edit checkbox\r\n          onInputChange(event);\r\n\r\n          // Make brush aware of add/subtract changes\r\n          Brush.refreshPreset();\r\n        }\r\n      );\r\n    }\r\n\r\n    _registerInputChangeCallback(html) {\r\n      if (this.options.inputChangeCallback) {\r\n        html.on('change', 'input, select', async (event) => {\r\n          setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n        });\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Toggle all ME checkboxes on/off when right-clicking tabs\r\n     * @param {*} html\r\n     */\r\n    _registerNavigationTabMassSelect(html) {\r\n      // Select/Deselect all Mass Edit checkboxes when right-clicking the navigation tabs\r\n      html.on('contextmenu', 'nav > .item', (event) => {\r\n        const tab = event.target.dataset?.tab;\r\n        if (tab) {\r\n          const group = $(event.target).closest('nav').attr('data-group');\r\n          let meCheckboxes;\r\n          if (group) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(\r\n                `.tab[data-tab=\"${tab}\"][data-group=\"${group}\"], .matt-tab[data-tab=\"${tab}\"][data-group=\"${group}\"]`\r\n              )\r\n              .find('.mass-edit-control');\r\n          }\r\n          if (!meCheckboxes || meCheckboxes.length === 0) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(`.tab[data-tab=\"${tab}\"], .matt-tab[data-tab=\"${tab}\"]`)\r\n              .find('.mass-edit-control');\r\n          }\r\n\r\n          let selecting = true;\r\n\r\n          if (meCheckboxes.not(':checked').length === 0) {\r\n            selecting = false;\r\n          }\r\n          meCheckboxes.prop('checked', selecting);\r\n\r\n          // Select/Deselect tabs\r\n          meCheckboxes.each(function () {\r\n            if (selecting) selectTabs(this);\r\n            else deselectTabs(this);\r\n          });\r\n\r\n          // Trigger change on one of the checkboxes to initiate processes that respond to them\r\n          // being toggled\r\n          meCheckboxes.first().trigger('change');\r\n        }\r\n      });\r\n    }\r\n\r\n    _insertModuleSpecificFields(html) {\r\n      // Monk's Active Tiles\r\n      if (this.documentName === 'Tile' && this._createAction) {\r\n        let chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>Mass Edit: ${localize(`form.actions`)}</label>\r\n                <div class=\"form-fields\">\r\n                    <input type=\"hidden\" name=\"flags.monks-active-tiles.actions\">\r\n                </div>\r\n              `);\r\n        $(html).find('.matt-tab[data-tab=\"trigger-actions\"]').prepend(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n\r\n        chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>Mass Edit: ${localize(`form.images`)}</label>\r\n                <div class=\"form-fields\">\r\n                    <input type=\"hidden\" name=\"flags.monks-active-tiles.files\">\r\n                </div>\r\n              `);\r\n        chk.insertBefore('.matt-tab[data-tab=\"trigger-images\"] .files-list');\r\n        this._processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ((this.documentName === 'Tile' || this.documentName === 'Token') && game.Levels3DPreview) {\r\n        let chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>Mass Edit: ${localize(`form.shaders`)}</label>\r\n                <div class=\"form-fields\">\r\n                    <input type=\"hidden\" name=\"flags.levels-3d-preview.shaders\">\r\n                </div>\r\n              `);\r\n        $(html).find('#shader-config').after(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n      }\r\n    }\r\n\r\n    _insertSpecialFields(html) {\r\n      // // Token Magic FX\r\n      if (\r\n        (this.documentName === 'Tile' || this.documentName === 'Token') &&\r\n        !this.options?.simplified &&\r\n        game.modules.get('tokenmagic')?.active &&\r\n        game.settings.get(MODULE_ID, 'tmfxFieldsEnable')\r\n      ) {\r\n        let content = '<datalist id=\"tmfxPresets\"><option value=\"DELETE ALL\">';\r\n        TokenMagic.getPresets().forEach((p) => (content += `<option value=\"${p.name}\">`));\r\n        content += `</datalist><input list=\"tmfxPresets\" name=\"tokenmagic.preset\">`;\r\n\r\n        let chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>${localize('common.preset')} <span class=\"units\">(TMFX)</span></label>\r\n                <div class=\"form-fields\">\r\n                  ${content}\r\n                </div>\r\n              `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n\r\n        const currentDDTint = getDDTint(this.baseDocument.object ?? this.baseDocument);\r\n        chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>DungeonDraft <span class=\"units\">(TMFX)</span></label>\r\n                <div class=\"form-fields\">\r\n                  <input class=\"color\" type=\"text\" name=\"tokenmagic.ddTint\" value=\"${currentDDTint}\">\r\n                  <input type=\"color\" value=\"${currentDDTint}\" data-edit=\"tokenmagic.ddTint\">\r\n                </div>\r\n              `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      // Tile scale\r\n      if (this.documentName === 'Tile') {\r\n        let scaleInput = $(`\r\n            <div class=\"form-group slim\">\r\n              <label>${localize('Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n              <div class=\"form-fields\">\r\n                <label>${localize('Width', false)} | ${localize('Height', false)} ${\r\n          game.Levels3DPreview?._active ? '| Depth' : ''\r\n        }</label>\r\n                <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.scale\" min=\"0\">\r\n              </div>\r\n            </div>`);\r\n        $(html).find('[name=\"width\"]').closest('.form-group').before(scaleInput);\r\n        this._processFormGroup(scaleInput, 'meInsert');\r\n\r\n        scaleInput = $(`\r\n              <div class=\"form-group slim\">\r\n                <label>${localize('TILE.Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n                <div class=\"form-fields\">\r\n                  <label>${localize('TILE.ScaleX', false)} | ${localize('TILE.ScaleY', false)}</label>\r\n                  <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.texture.scale\" min=\"0\">\r\n                </div>\r\n              </div>`);\r\n        $(html).find('[name=\"texture.scaleX\"]').closest('.form-group').before(scaleInput);\r\n        this._processFormGroup(scaleInput, 'meInsert');\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Insert button to toggle auto-update on form changes\r\n     * @param {*} html\r\n     */\r\n    _insertModUpdateCheckboxes(html) {\r\n      if (this.options.massEdit && !this.options.simplified && !this.options.presetEdit) {\r\n        const app = this;\r\n        const preSelectAutoApply = game.settings.get(MODULE_ID, 'preSelectAutoApply');\r\n        html.find('button[type=\"submit\"]').each(function (index) {\r\n          const button = $(this);\r\n          const modButton = $(\r\n            `<div class=\"me-mod-update\" title=\"${localize(\r\n              `form.immediate-update-title`\r\n            )}\"><input type=\"checkbox\" data-submit=\"${button.data('action')}\"><i class=\"fas fa-cogs\"></i></div>`\r\n          );\r\n          modButton.on('change', (event) => {\r\n            event.stopPropagation();\r\n            const isChecked = event.target.checked;\r\n            html.find('.me-mod-update > input').not(this).prop('checked', false);\r\n            $(event.target).prop('checked', isChecked);\r\n            app.modUpdate = isChecked;\r\n            app.modUpdateType = $(event.target).data('submit');\r\n          });\r\n\r\n          if (index === 0 && preSelectAutoApply) {\r\n            modButton.find('input[type=\"checkbox\"]').prop('checked', true).trigger('change');\r\n          }\r\n\r\n          modButton.insertAfter(button);\r\n        });\r\n      }\r\n    }\r\n\r\n    _performOnInputChangeUpdate() {\r\n      const selectedFields = this.getSelectedFields();\r\n      performMassUpdate.call(this, selectedFields, this.meObjects, this.documentName, this.modUpdateType);\r\n    }\r\n\r\n    _registerMutateObserver(html) {\r\n      // TokenConfig might be changed by some modules after activateListeners is processed\r\n      // Look out for these updates and add checkboxes for any newly added form-groups\r\n      const processFormGroup = this._processFormGroup.bind(this);\r\n      const mutate = (mutations) => {\r\n        mutations.forEach((mutation) => {\r\n          mutation.addedNodes.forEach((node) => {\r\n            if ($(node).hasClass('form-group')) {\r\n              processFormGroup(node);\r\n            } else {\r\n              $(node)\r\n                .find('.form-group')\r\n                .each(function () {\r\n                  if (!$(this).find('.mass-edit-checkbox').length) {\r\n                    processFormGroup(this);\r\n                  }\r\n                });\r\n            }\r\n          });\r\n        });\r\n      };\r\n\r\n      const observer = new MutationObserver(mutate);\r\n      observer.observe(html[0], {\r\n        characterData: false,\r\n        attributes: false,\r\n        childList: true,\r\n        subtree: true,\r\n      });\r\n    }\r\n\r\n    _onClose(options = {}) {\r\n      options.force = true;\r\n      Brush.deactivate();\r\n      if (this.linkedPresetForm) this.linkedPresetForm.close();\r\n      return super._onClose?.(options);\r\n    }\r\n\r\n    /**\r\n     * ===== ACTIONS ======\r\n     */\r\n\r\n    /**\r\n     * Macro Generator\r\n     */\r\n    static _openMacroForm() {\r\n      const selectedFields = this.getSelectedFields();\r\n      new MacroForm(\r\n        this.baseDocument,\r\n        this.meObjects,\r\n        this.documentName,\r\n        selectedFields,\r\n        this.randomizeFields,\r\n        this.addSubtractFields\r\n      ).render(true);\r\n    }\r\n\r\n    /**\r\n     * Brush Tool\r\n     */\r\n    static _activateBrushTool() {\r\n      Brush.activate({ app: this });\r\n    }\r\n\r\n    /**\r\n     * Token, Note, and Actor permission editing\r\n     */\r\n    static _openEditPermissions() {\r\n      let docs = [];\r\n      const ids = new Set();\r\n      for (const p of this.meObjects) {\r\n        let d;\r\n        if (this.documentName === 'Actor' || this.documentName === 'JournalEntry') d = p;\r\n        else if (this.documentName === 'Token' && p.actor) d = p.actor;\r\n        else if (this.documentName === 'Note' && p.entry) d = p.entry;\r\n\r\n        // Only retain unique docs\r\n        if (d && !ids.has(d.id)) {\r\n          docs.push(d);\r\n          ids.add(d.id);\r\n        }\r\n      }\r\n\r\n      let MP = WithMassPermissions();\r\n      new MP(docs[0], docs).render(true);\r\n    }\r\n\r\n    /**\r\n     * Open Preset browser with a relationship to this app\r\n     */\r\n    static _openPresetBrowser() {\r\n      this.linkedPresetForm = new MassEditPresets(this, null, this.documentName, {\r\n        left: this.position.left - 370,\r\n        top: this.position.top,\r\n        preventPositionOverride: true,\r\n      });\r\n      this.linkedPresetForm.render(true);\r\n    }\r\n\r\n    /**\r\n     * View currently selected fields as JSON and/or apply JSON to the current form\r\n     */\r\n    static _openViewApplyJSON() {\r\n      let selFields = foundry.utils.expandObject(this.getSelectedFields());\r\n      if (foundry.utils.isEmpty(selFields)) selFields = '';\r\n      else selFields = JSON.stringify(selFields, null, 2);\r\n      let content = `<textarea class=\"json\" style=\"width:100%; height: 300px;\">${selFields}</textarea>`;\r\n      new Dialog({\r\n        title: localize('form.apply-json'),\r\n        content: content,\r\n        buttons: {\r\n          apply: {\r\n            label: localize('common.apply'),\r\n            callback: (html) => {\r\n              let json = {};\r\n              try {\r\n                json = JSON.parse(html.find('.json').val());\r\n              } catch (e) {}\r\n\r\n              if (!foundry.utils.isEmpty(json)) {\r\n                const preset = new Preset({\r\n                  documentName: this.documentName,\r\n                  data: foundry.utils.flattenObject(json),\r\n                });\r\n                this._processPreset(preset);\r\n              }\r\n            },\r\n          },\r\n        },\r\n      }).render(true);\r\n    }\r\n\r\n    static _showMassActorForm() {\r\n      if (\r\n        showMassActorForm(this.meObjects, {\r\n          massEdit: this.options.massEdit,\r\n        })\r\n      ) {\r\n        this.close();\r\n      }\r\n    }\r\n\r\n    static _setMEActions(options) {\r\n      const actions = options.action ?? {};\r\n      actions.meMacroGen = this._openMacroForm;\r\n      actions.meBrush = this._activateBrushTool;\r\n      actions.meEditPermissions = this._openEditPermissions;\r\n      actions.mePresetBrowser = this._openPresetBrowser;\r\n      actions.meJSON = this._openViewApplyJSON;\r\n      actions.meTokenActor = this._showMassActorForm;\r\n      [\r\n        'meSearch',\r\n        'meSearchAndEdit',\r\n        'meApplyCurrentScene',\r\n        'meApplyAllScenes',\r\n        'meApply',\r\n        'meApplyToPrototype',\r\n      ].forEach((action) => {\r\n        actions[action] = this.massUpdateObject;\r\n      });\r\n      options.actions = actions;\r\n      foundry.utils.setProperty(options, 'form.handler', () => {});\r\n    }\r\n\r\n    _meGetSubmitButtons() {\r\n      // Add submit buttons\r\n      const buttons = [];\r\n\r\n      if (this.options.massSelect) {\r\n        buttons.push({\r\n          type: 'submit',\r\n          icon: 'fas fa-search',\r\n          label: localize('FILES.Search', false),\r\n          action: 'meSearch',\r\n        });\r\n        buttons.push({\r\n          type: 'submit',\r\n          icon: 'fas fa-search',\r\n          label: localize('form.search-and-edit'),\r\n          action: 'meSearchAndEdit',\r\n        });\r\n      } else if (this.documentName === 'Note' && !this.options.presetEdit) {\r\n        // If we're editing notes and there are some on a different scene\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id === canvas.scene.id).length) {\r\n          buttons.push({\r\n            type: 'submit',\r\n            icon: 'far fa-save',\r\n            label: localize('form.apply-on-current-scene'),\r\n            action: 'meApplyCurrentScene',\r\n          });\r\n        }\r\n\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id !== canvas.scene.id).length) {\r\n          buttons.push({\r\n            type: 'submit',\r\n            label: localize('form.apply-on-all-scenes'),\r\n            icon: 'fas fa-globe',\r\n            action: 'meApplyAllScenes',\r\n          });\r\n        }\r\n      } else {\r\n        buttons.push({\r\n          type: 'submit',\r\n          label: localize('common.apply'),\r\n          icon: 'far fa-save',\r\n          action: 'meApply',\r\n        });\r\n\r\n        // Extra control for Tokens to update their Actors Token prototype\r\n        if (\r\n          this.documentName === 'Token' &&\r\n          !this.options.simplified &&\r\n          !this.meObjects[0].constructor?.name?.startsWith('PrototypeToken') &&\r\n          !this.options.presetEdit\r\n        ) {\r\n          buttons.push({\r\n            type: 'submit',\r\n            label: localize('form.apply-update-proto'),\r\n            icon: 'far fa-save',\r\n            action: 'meApplyToPrototype',\r\n          });\r\n        }\r\n      }\r\n\r\n      return buttons;\r\n    }\r\n\r\n    _getMeControls() {\r\n      const controls = [\r\n        {\r\n          label: 'Generate Macro',\r\n          class: 'mass-edit-macro',\r\n          icon: 'fas fa-terminal',\r\n          action: 'meMacroGen',\r\n          visible:\r\n            SUPPORTED_PLACEABLES.includes(this.documentName) || SUPPORTED_COLLECTIONS.includes(this.documentName),\r\n        },\r\n        {\r\n          label: 'Brush',\r\n          class: 'mass-edit-brush',\r\n          icon: 'fas fa-paint-brush',\r\n          action: 'meBrush',\r\n          visible: SUPPORTED_PLACEABLES.includes(this.documentName),\r\n        },\r\n        {\r\n          label: 'Permissions',\r\n          class: 'mass-edit-permissions',\r\n          icon: 'fas fa-lock fa-fw',\r\n          action: 'meEditPermissions',\r\n          visible: ['Token', 'Note', 'Actor'].includes(this.documentName),\r\n        },\r\n        {\r\n          label: 'Presets',\r\n          class: 'mass-edit-presets',\r\n          icon: 'fas fa-box',\r\n          action: 'mePresetBrowser',\r\n          visible: !this.options.simplified,\r\n        },\r\n        {\r\n          label: 'JSON',\r\n          class: 'mass-edit-apply',\r\n          icon: 'far fa-money-check-edit',\r\n          action: 'meJSON',\r\n          visible: true,\r\n        },\r\n        {\r\n          label: 'Switch',\r\n          class: 'mass-edit-actors',\r\n          icon: 'fas fa-user',\r\n          action: 'meTokenActor',\r\n          visible: this.documentName === 'Token' && this.meObjects.filter((t) => t.actor).length,\r\n        },\r\n      ];\r\n      return controls;\r\n    }\r\n  }\r\n  return BaseMassEditForm;\r\n};\r\n\r\nexport const WithMassEditFormApplicationV2 = (cls) => {\r\n  class MassEditForm extends cls {\r\n    _attachFrameListeners() {\r\n      super._attachFrameListeners();\r\n    }\r\n\r\n    _onRender() {\r\n      super._onRender();\r\n      injectVisibility(this);\r\n\r\n      const html = $(this.element);\r\n      this._injectGlobalDeleteButton(html);\r\n      this._setStyle(html);\r\n      this._activateAutoSelectListeners(html);\r\n      this._processAllFormGroups(html);\r\n      this._registerRandomizerListeners(html);\r\n      this._registerBrushRefreshListeners(html);\r\n      this._registerNumericalInputListeners(html);\r\n      this._registerInputChangeCallback(html);\r\n      this._registerNavigationTabMassSelect(html);\r\n      this._insertModUpdateCheckboxes(html);\r\n      this._insertModuleSpecificFields(html);\r\n      this._insertSpecialFields(html);\r\n      this._registerMutateObserver(html);\r\n    }\r\n\r\n    get baseDocument() {\r\n      return this.document;\r\n    }\r\n\r\n    _getSubmitData() {\r\n      const form = this.element;\r\n      const formData = new FormDataExtended(form);\r\n      const submitData = this._prepareSubmitData(null, form, formData);\r\n      return submitData;\r\n    }\r\n\r\n    _getHeaderControls() {\r\n      return [].concat(super._getHeaderControls()).concat(this._getMeControls());\r\n    }\r\n\r\n    // Special handling for Regions to prevent insertion of submit buttons\r\n    async _preparePartContext(partId, context) {\r\n      if (partId !== 'footer') return super._preparePartContext(partId, context);\r\n      return context;\r\n    }\r\n\r\n    async _prepareContext(options) {\r\n      const context = await super._prepareContext(options);\r\n      context.buttons = (context.buttons ?? []).filter((b) => b.type !== 'submit');\r\n      context.buttons = context.buttons.concat(this._meGetSubmitButtons());\r\n      return context;\r\n    }\r\n\r\n    async render(options = {}, _options = {}) {\r\n      // Do not re-render the form if this is due to the document being updated\r\n      // This is to prevent ME checkboxes from being reset.\r\n      if (_options.renderContext?.startsWith('update')) return;\r\n      return super.render(options, _options);\r\n    }\r\n  }\r\n  return MassEditForm;\r\n};\r\n\r\nexport const WithMassEditFormApplication = (cls) => {\r\n  class MassEditForm extends cls {\r\n    async getData(options) {\r\n      // During Preset editing we will be editing AmbientLight document directly, which causes the preview to be set to null\r\n      // and Foundry complaining about being unable to read data from it. So we set the preview manually here\r\n      if (this.documentName === 'AmbientLight' && !this.preview) {\r\n        this.preview = this.baseDocument.clone();\r\n      }\r\n      const data = super.getData(options);\r\n      return data;\r\n    }\r\n\r\n    get baseDocument() {\r\n      return this.object;\r\n    }\r\n\r\n    // Add styles and controls to the sheet\r\n    async activateListeners(html) {\r\n      await super.activateListeners(html);\r\n      injectVisibility(this);\r\n      this._injectGlobalDeleteButton(html);\r\n      this._setStyle(html);\r\n      this._activateAutoSelectListeners(html);\r\n      this._processAllFormGroups(html);\r\n      this._registerRandomizerListeners(html);\r\n      this._registerBrushRefreshListeners(html);\r\n      this._registerNumericalInputListeners(html);\r\n      this._registerInputChangeCallback(html);\r\n      this._registerNavigationTabMassSelect(html);\r\n      this._removeFooterButtons(html);\r\n      this._insertSubmitButtons(html);\r\n      this._insertModUpdateCheckboxes(html);\r\n      this._insertModuleSpecificFields(html);\r\n      this._insertSpecialFields(html);\r\n      this._registerMutateObserver(html);\r\n\r\n      // Resizes the window\r\n      this.setPosition();\r\n      this.element[0].style.height = ''; // don't want a statically set height\r\n\r\n      if (this.documentName === 'Token') {\r\n        $(html)\r\n          .find('fieldset.detection-mode')\r\n          .each(function (_) {\r\n            $(this).wrap('<div class=\"form-group\"></div>');\r\n          });\r\n      }\r\n    }\r\n\r\n    _insertSubmitButtons(html) {\r\n      const buttons = this._meGetSubmitButtons();\r\n\r\n      // Add submit buttons\r\n      let htmlButtons = '';\r\n      if (!this._meSubmitInserted) {\r\n        this._meSubmitInserted = true;\r\n        for (const button of buttons) {\r\n          htmlButtons += `<button class=\"me-submit\" type=\"submit\" data-action=\"${button.action}\"><i class=\"${button.icon}\"></i> ${button.label}</button>`;\r\n        }\r\n        if (this.options.massSelect && SUPPORTED_PLACEABLES.includes(this.documentName)) {\r\n          htmlButtons += `<div class=\"me-mod-update\" title=\"${localize(\r\n            `form.global-search-title`\r\n          )}\"><input type=\"checkbox\" data-submit=\"world\"><i class=\"far fa-globe\"></i></div>`;\r\n        }\r\n\r\n        let footer = $(html).find('.sheet-footer').last();\r\n        if (footer.length) {\r\n          footer.append(htmlButtons);\r\n        } else {\r\n          footer = $(`<footer class=\"sheet-footer flexrow\">${htmlButtons}</footer>`);\r\n          $(html).closest('form').append(footer);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Overriding here to prevent the underlying object from being updated as inputs change on the form\r\n    // Relevant for AmbientLight, Tile, and Token sheets\r\n    async _onChangeInput(event) {\r\n      if (!['AmbientLight', 'Tile', 'Token'].includes(this.documentName)) {\r\n        super._onChangeInput(event);\r\n        return;\r\n      }\r\n\r\n      // // Handle form element updates\r\n      const el = event.target;\r\n      if (el.type === 'color' && el.dataset.edit) this._onChangeColorPicker(event);\r\n      else if (el.type === 'range') this._onChangeRange(event);\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      await this.options.actions.meApply.call(this, event, event.submitter);\r\n\r\n      // On v11 certain placeable will freeze the canvas layer if parent _updateObject is not called\r\n      if (['Token', 'AmbientLight'].includes(this.documentName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n    }\r\n\r\n    _getHeaderButtons() {\r\n      let buttons = super._getHeaderButtons().filter((b) => b.class !== 'configure-sheet');\r\n\r\n      const controls = foundry.utils.deepClone(this._getMeControls());\r\n      controls.forEach((ctrl) => {\r\n        ctrl.onclick = this.options.actions[ctrl.action].bind(this);\r\n        ctrl.label = '';\r\n      });\r\n\r\n      return controls.concat(buttons);\r\n    }\r\n\r\n    _removeFooterButtons(html) {\r\n      // Remove all buttons in the footer\r\n      html.find('.sheet-footer > button').remove();\r\n\r\n      // Special handling for Walls sheet\r\n      html.find('button[type=\"submit\"]').remove();\r\n    }\r\n\r\n    // Some forms will manipulate themselves via modifying internal objects and re-rendering\r\n    // In such cases we want to preserve the selected fields\r\n    render(force, options = {}) {\r\n      // If it's being re-rendered with an action \"update\" in means it's ClientDocumentMixin response to _onUpdate\r\n      // We can ignore these\r\n      if (options.action === 'update' || options.renderContext?.startsWith('update')) return;\r\n      // Form hasn't been rendered yet, aka first render pass, ignore it\r\n      if (!this.form) return super.render(force, options);\r\n\r\n      // Fetch the currently selected fields before re-rendering\r\n      const selectedFields = this.getSelectedFields();\r\n      const randomize = this.randomizeFields;\r\n      const addSubtract = this.addSubtractFields;\r\n\r\n      // Render, the selections will be wiped\r\n      super.render(force, options);\r\n\r\n      // Re-select fields, we're reusing preset functions here.\r\n      // Timeout require for this module including others to apply their\r\n      // modifications to the configuration window\r\n      setTimeout(() => {\r\n        if (this.form) {\r\n          this._applyPreset(\r\n            new Preset({\r\n              data: selectedFields,\r\n              randomize,\r\n              addSubtract,\r\n            })\r\n          );\r\n        }\r\n      }, 1000);\r\n    }\r\n\r\n    async close(options = {}) {\r\n      super._onClose(options);\r\n      if (['Token', 'AmbientLight'].includes(this.documentName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n      return super.close(options);\r\n    }\r\n  }\r\n\r\n  return MassEditForm;\r\n};\r\n","import { getData } from '../scripts/utils.js';\r\nimport { WithBaseMassEditForm, WithMassEditFormApplication, WithMassEditFormApplicationV2 } from './meApplication.js';\r\n\r\n// ==================================\r\n// ========= Applications ===========\r\n// ==================================\r\n\r\nexport const WithMassEditForm = (cls) => {\r\n  const base = WithBaseMassEditForm(cls);\r\n  if (foundry.applications?.api?.ApplicationV2 && cls.BASE_APPLICATION === foundry.applications.api.ApplicationV2) {\r\n    return WithMassEditFormApplicationV2(base);\r\n  } else {\r\n    return WithMassEditFormApplication(base);\r\n  }\r\n};\r\n\r\nexport const WithMassConfig = (documentName = 'NONE') => {\r\n  let cls;\r\n  const sheets = CONFIG[documentName]?.sheetClasses;\r\n  if (!sheets || documentName === 'Actor') {\r\n    cls = FormApplication;\r\n  } else {\r\n    cls = Object.values(Object.values(sheets).pop() ?? {}).pop()?.cls;\r\n  }\r\n\r\n  const MEF = WithMassEditForm(cls);\r\n\r\n  class MassConfig extends MEF {\r\n    constructor(target, docs, options) {\r\n      super(target.document ? target.document : target, docs, options);\r\n    }\r\n  }\r\n\r\n  const constructorName = `Mass${documentName}Config`;\r\n  Object.defineProperty(MassConfig.prototype.constructor, 'name', { value: constructorName });\r\n  return MassConfig;\r\n};\r\n\r\nexport const WithMassPermissions = () => {\r\n  let MEF = WithMassEditForm(DocumentOwnershipConfig);\r\n\r\n  class MassPermissions extends MEF {\r\n    constructor(target, docs, options = {}) {\r\n      // Generate common permissions\r\n      const data = getData(docs[0]);\r\n      const commonData = foundry.utils.flattenObject(data.ownership);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      // Permissions are only present if they differ from default, for simplicity simple add them before comparing\r\n      const addMissingPerms = function (perms) {\r\n        game.users.forEach((u) => {\r\n          if (!(u.id in perms)) perms[u.id] = metaLevels.DEFAULT;\r\n        });\r\n\r\n        if (!('default' in perms)) perms.default = metaLevels.DEFAULT;\r\n      };\r\n      addMissingPerms(commonData);\r\n\r\n      for (let i = 1; i < docs.length; i++) {\r\n        const data = getData(docs[i]);\r\n        const flatData = foundry.utils.flattenObject(data.ownership);\r\n        addMissingPerms(flatData);\r\n        const diff = foundry.utils.flattenObject(foundry.utils.diffObject(commonData, flatData));\r\n        for (const k of Object.keys(diff)) {\r\n          delete commonData[k];\r\n        }\r\n      }\r\n\r\n      options.commonData = commonData;\r\n      options.massPermissions = true;\r\n\r\n      super(target, docs, options);\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      const selectedFields = this.getSelectedFields(formData);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return;\r\n\r\n      const ids = new Set();\r\n      const updates = [];\r\n      for (const d of this.meObjects) {\r\n        if (!ids.has(d.id)) {\r\n          const data = getData(d);\r\n          const ownership = foundry.utils.deepClone(data.ownership);\r\n\r\n          for (let [user, level] of Object.entries(selectedFields)) {\r\n            if (level === metaLevels.DEFAULT) delete ownership[user];\r\n            else ownership[user] = level;\r\n          }\r\n\r\n          ids.add(d.id);\r\n          updates.push({ _id: d.id, ownership: ownership });\r\n        }\r\n      }\r\n\r\n      this.meObjects[0].constructor.updateDocuments(updates, {\r\n        diff: false,\r\n        recursive: false,\r\n        noHook: true,\r\n      });\r\n    }\r\n\r\n    get title() {\r\n      return `Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`;\r\n    }\r\n  }\r\n\r\n  return MassPermissions;\r\n};\r\n","export const CUSTOM_CONTROLS = {\r\n  field: {\r\n    shieldType: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '16',\r\n      step: '1',\r\n    },\r\n    scale: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    radius: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    intensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    lightAlpha: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    gridPadding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    lightSize: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    animated: {\r\n      time: {\r\n        speed: {\r\n          range: true,\r\n          min: '0',\r\n          max: '0.05',\r\n          step: '0.0001',\r\n        },\r\n      },\r\n    },\r\n  },\r\n  fire: {\r\n    fireBlend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n    animated: {\r\n      intensity: {\r\n        animType: {\r\n          select: true,\r\n          options: [\r\n            'syncChaoticOscillation',\r\n            'syncSinOscillation',\r\n            'syncCosOscillation',\r\n            'chaoticOscillation',\r\n            'halfSinOscillation',\r\n            'sinOscillation',\r\n            'halfCosOscillation',\r\n            'cosOscillation',\r\n            'syncColorOscillation',\r\n            'halfColorOscillation',\r\n            'colorOscillation',\r\n          ],\r\n        },\r\n        val2: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n        val1: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n        loopDuration: {\r\n          range: true,\r\n          min: '0',\r\n          max: '50000',\r\n          step: '100',\r\n        },\r\n      },\r\n      amplitude: {\r\n        animType: {\r\n          select: true,\r\n          options: [\r\n            'syncChaoticOscillation',\r\n            'syncSinOscillation',\r\n            'syncCosOscillation',\r\n            'chaoticOscillation',\r\n            'halfSinOscillation',\r\n            'sinOscillation',\r\n            'halfCosOscillation',\r\n            'cosOscillation',\r\n            'syncColorOscillation',\r\n            'halfColorOscillation',\r\n            'colorOscillation',\r\n          ],\r\n        },\r\n        loopDuration: {\r\n          range: true,\r\n          min: '0',\r\n          max: '50000',\r\n          step: '100',\r\n        },\r\n        val1: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n        val2: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n      },\r\n    },\r\n    intensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '100',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  electric: {\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n  },\r\n  xglow: {\r\n    auraType: {\r\n      range: true,\r\n      min: '0',\r\n      max: '2',\r\n      step: '1',\r\n    },\r\n    scale: {\r\n      range: true,\r\n      min: '0',\r\n      max: '30',\r\n      step: '0.1',\r\n    },\r\n    auraIntensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    subAuraIntensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    threshold: {\r\n      range: true,\r\n      min: '0',\r\n      max: '2',\r\n      step: '0.01',\r\n    },\r\n    thickness: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  glow: {\r\n    outerStrength: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    innerStrength: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    padding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '100',\r\n      step: '1',\r\n    },\r\n    alpha: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n  },\r\n  zapshadow: {\r\n    alphaTolerance: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n  },\r\n  sprite: {\r\n    blendMode: {\r\n      range: true,\r\n      min: '0',\r\n      max: '16',\r\n      step: '1',\r\n    },\r\n    gridPadding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.1',\r\n    },\r\n    scaleX: {\r\n      range: true,\r\n      min: '0',\r\n      max: '3',\r\n      step: '0.01',\r\n    },\r\n    scaleY: {\r\n      range: true,\r\n      min: '0',\r\n      max: '3',\r\n      step: '0.01',\r\n    },\r\n    translationX: {\r\n      range: true,\r\n      min: '-1',\r\n      max: '1',\r\n      step: '0.001',\r\n    },\r\n    translationY: {\r\n      range: true,\r\n      min: '-1',\r\n      max: '1',\r\n      step: '0.001',\r\n    },\r\n    rotation: {\r\n      range: true,\r\n      min: '0',\r\n      max: '360',\r\n      step: '1',\r\n    },\r\n    alpha: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n  },\r\n  xfire: {\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '16',\r\n      step: '1',\r\n    },\r\n    amplitude: {\r\n      range: true,\r\n      min: '0',\r\n      max: '10',\r\n      step: '0.01',\r\n    },\r\n    dispersion: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    scaleX: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    scaleY: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    animated: {\r\n      time: {\r\n        speed: {\r\n          range: true,\r\n          min: '-0.0050',\r\n          max: '0.0050',\r\n          step: '0.0001',\r\n        },\r\n      },\r\n    },\r\n  },\r\n  transform: {\r\n    gridPadding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    scaleX: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.1',\r\n    },\r\n    scaleY: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  ascii: {\r\n    animated: {\r\n      size: {\r\n        val1: {\r\n          range: true,\r\n          min: '-5',\r\n          max: '5',\r\n          step: '0.01',\r\n        },\r\n        val2: {\r\n          range: true,\r\n          min: '-5',\r\n          max: '5',\r\n          step: '0.01',\r\n        },\r\n      },\r\n    },\r\n    size: {\r\n      range: true,\r\n      min: '1',\r\n      max: '64',\r\n      step: '1',\r\n    },\r\n  },\r\n  dot: {\r\n    scale: {\r\n      range: true,\r\n      min: '0',\r\n      max: '10',\r\n      step: '0.1',\r\n    },\r\n    angle: {\r\n      range: true,\r\n      min: '0',\r\n      max: '360',\r\n      step: '1',\r\n    },\r\n  },\r\n  godray: {\r\n    blendMode: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '1',\r\n    },\r\n    padding: {\r\n      range: true,\r\n      min: '-5',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  rgbSplit: {\r\n    redX: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    redY: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    greenX: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    greenY: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    blueX: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    blueY: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n  },\r\n  polymorph: {\r\n    type: {\r\n      range: true,\r\n      min: '0',\r\n      max: '9',\r\n      step: '1',\r\n    },\r\n  },\r\n  shadow: {\r\n    blur: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '1',\r\n    },\r\n  },\r\n  flood: {\r\n    billowy: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    tintIntensity: {\r\n      range: true,\r\n      min: '0.0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n    glint: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n    scale: {\r\n      range: true,\r\n      min: '5',\r\n      max: '500',\r\n      step: '1',\r\n    },\r\n    animated: {\r\n      time: {\r\n        speed: {\r\n          range: true,\r\n          min: '0.00001',\r\n          max: '0.001',\r\n          step: '0.00001',\r\n        },\r\n      },\r\n    },\r\n  },\r\n};\r\n","import { MODULE_ID } from '../../scripts/constants.js';\r\nimport { localize } from '../../scripts/utils.js';\r\n\r\nexport function constructNav(allData, documentName, customControls, pins = true) {\r\n  const nav = {\r\n    dataGroup: 'main',\r\n    items: [],\r\n    tabs: [],\r\n  };\r\n  const tabSelectors = [{ navSelector: '.tabs[data-group=\"main\"]', contentSelector: 'form', initial: 'me-pinned' }];\r\n\r\n  // Limit the form to just the keys marked as editable\r\n  let editableKeys;\r\n  // if (documentName === 'Actor') {\r\n  //   editableKeys = ['name', 'img', 'system', 'data', 'folder', 'flags'];\r\n  // }\r\n\r\n  let object = {};\r\n  if (!editableKeys) object = allData;\r\n  else {\r\n    for (const k of editableKeys) {\r\n      if (k in allData) {\r\n        object[k] = allData[k];\r\n      }\r\n    }\r\n  }\r\n\r\n  const pinned = documentName ? game.settings.get(MODULE_ID, 'pinnedFields')[documentName] || {} : {};\r\n\r\n  _constructControls(nav, object, tabSelectors, '', pinned, customControls, pins);\r\n\r\n  const pinned_groups = [];\r\n  const flatObject = foundry.utils.flattenObject(object);\r\n  for (const [k, v] of Object.entries(pinned)) {\r\n    const value = k in flatObject ? flatObject[k] : v.value;\r\n\r\n    let control = genControl(foundry.utils.getType(value), v.label, value, k, {}, true, customControls, pins);\r\n    control.pinned = true;\r\n    pinned_groups.push(control);\r\n  }\r\n  if (pinned_groups.length) {\r\n    // No tabs constructed means this is not a nested object, however since we have pinned fields\r\n    // we need to separate main object fields from the pinned ones\r\n    if (!nav.items.length) {\r\n      nav.items.push({ dataTab: 'main-me-main', label: 'Main' });\r\n      nav.tabs.push({ dataTab: 'main-me-main', groups: nav.groups });\r\n      delete nav.groups;\r\n    }\r\n\r\n    nav.items.unshift({\r\n      dataTab: 'me-pinned',\r\n      dataTab: 'me-pinned',\r\n      label: localize('generic-form.pinned'),\r\n    });\r\n    nav.tabs.unshift({ dataTab: 'me-pinned', groups: pinned_groups });\r\n  }\r\n\r\n  return [nav, tabSelectors];\r\n}\r\n\r\nfunction _constructControls(nav, data, tabSelectors, name, pinned, customControls, pins) {\r\n  const groups = [];\r\n  let containsNav = false;\r\n  for (const [k, v] of Object.entries(data)) {\r\n    const name2 = name ? name + '.' + k : k;\r\n    if (v !== null) {\r\n      let t = foundry.utils.getType(v);\r\n      let control;\r\n      if (t === 'Object') {\r\n        if (_hasNonNullKeys(v)) {\r\n          nav.items.push({ dataTab: name2, label: _genLabel(k) });\r\n          const newNav = { dataGroup: name2, items: [], tabs: [] };\r\n          nav.tabs.push({ dataTab: name2, nav: newNav });\r\n          tabSelectors.push({\r\n            navSelector: `.tabs[data-group=\"${name2}\"]`,\r\n            contentSelector: `.tab[data-tab=\"${name2}\"]`,\r\n            initial: k + '-me-main',\r\n          });\r\n          _constructControls(newNav, v, tabSelectors, name2, pinned, customControls, pins);\r\n          containsNav = true;\r\n        }\r\n      } else {\r\n        control = genControl(t, _genLabel(k), v, name2, pinned, false, customControls, pins);\r\n      }\r\n      if (control) {\r\n        groups.push(control);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (groups.length) {\r\n    if (containsNav) {\r\n      nav.items.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        label: 'Main',\r\n      });\r\n      nav.tabs.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        groups,\r\n      });\r\n    } else {\r\n      nav.groups = groups;\r\n    }\r\n  }\r\n}\r\n\r\nfunction _hasNonNullKeys(obj) {\r\n  if (foundry.utils.isEmpty(obj)) return false;\r\n  for (const [k, v] of Object.entries(obj)) {\r\n    if (foundry.utils.getType(v) === 'Object') {\r\n      if (_hasNonNullKeys(v)) return true;\r\n    } else if (v != null) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction _genLabel(key) {\r\n  if (key.length <= 3) return key.toUpperCase();\r\n  return key.charAt(0).toUpperCase() + key.slice(1);\r\n}\r\n\r\nconst IMAGE_FIELDS = ['img', 'image', 'src', 'texture'];\r\nconst COLOR_FIELDS = ['tint'];\r\n\r\nexport function isColorField(name) {\r\n  name = name.split('.').pop();\r\n  return COLOR_FIELDS.includes(name) || name.toLowerCase().includes('color');\r\n}\r\n\r\nfunction genControl(type, label, value, name, pinned, editableLabel = false, customControls = {}, pins) {\r\n  const allowedArrayElTypes = ['number', 'string'];\r\n\r\n  let control = { label: label, value, name, editableLabel, pins };\r\n  if (foundry.utils.getProperty(customControls, name)) {\r\n    control = foundry.utils.mergeObject(control, foundry.utils.getProperty(customControls, name));\r\n  } else if (type === 'number') {\r\n    control.number = true;\r\n    const varName = name.split('.').pop();\r\n    if (isColorField(varName)) {\r\n      control.colorPickerNumber = true;\r\n      try {\r\n        control.colorValue = new Color(value).toString();\r\n      } catch (e) {}\r\n    }\r\n  } else if (type === 'string') {\r\n    control.text = true;\r\n    const varName = name.split('.').pop();\r\n    if (\r\n      IMAGE_FIELDS.includes(varName) ||\r\n      varName.toLowerCase().includes('image') ||\r\n      varName.toLowerCase().includes('path')\r\n    )\r\n      control.filePicker = true;\r\n    else if (isColorField(varName)) control.colorPicker = true;\r\n  } else if (type === 'boolean') {\r\n    control.boolean = true;\r\n  } else if (type === 'Array' && value.every((el) => allowedArrayElTypes.includes(foundry.utils.getType(el)))) {\r\n    control.value = value.join(', ');\r\n    control.array = true;\r\n  } else if (type === 'Array') {\r\n    control.jsonArray = true;\r\n    control.value = JSON.stringify(value, null, 2);\r\n  } else {\r\n    control.disabled = true;\r\n    control.text = true;\r\n    control.editableLabel = false;\r\n  }\r\n  if (control && name in pinned) {\r\n    control.pinned = true;\r\n    control.disabled = true;\r\n    control.name = null;\r\n  }\r\n  return control;\r\n}\r\n","import { CUSTOM_CONTROLS } from '../../data/custom-controls.js';\r\nimport { MODULE_ID } from '../../scripts/constants.js';\r\nimport { getCommonData, localize } from '../../scripts/utils.js';\r\nimport { WithMassConfig } from '../forms.js';\r\nimport { showMassEdit } from '../multiConfig.js';\r\nimport { constructNav, isColorField } from './navGenerator.js';\r\n\r\nconst WMC = WithMassConfig();\r\nexport class MassEditGenericForm extends WMC {\r\n  constructor(docs, options = {}) {\r\n    const objects = docs.map((a) => (a.toObject ? a.toObject() : a));\r\n    let allData = {};\r\n    for (let i = objects.length; i >= 0; i--) {\r\n      foundry.utils.mergeObject(allData, objects[i]);\r\n    }\r\n\r\n    if (options.noTabs) {\r\n      allData = foundry.utils.flattenObject(allData);\r\n    }\r\n\r\n    let documentName = options.documentName ?? 'NONE';\r\n\r\n    let customControls = foundry.utils.mergeObject(\r\n      CUSTOM_CONTROLS[documentName] ?? {},\r\n      game.settings.get(MODULE_ID, 'customControls')[documentName] ?? {}\r\n    );\r\n    customControls = foundry.utils.mergeObject(customControls, options.customControls?.[documentName] ?? {});\r\n\r\n    const [nav, tabSelectors] = constructNav(allData, documentName, customControls, !options.noTabs);\r\n    const commonData = getCommonData(objects);\r\n\r\n    super(docs[0], docs, {\r\n      tabs: tabSelectors,\r\n      commonData: commonData,\r\n      ...options,\r\n    });\r\n\r\n    this.allData = allData;\r\n    this.nav = nav;\r\n    this.editableLabels = {};\r\n\r\n    this.pinnedFields = game.settings.get(MODULE_ID, 'pinnedFields')[this.documentName] ?? {};\r\n    this.customControls = customControls;\r\n\r\n    if (options.callback) {\r\n      this.callbackOnUpdate = options.callback;\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-generic-form',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/generic/genericForm.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generic`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n    if (this.options.tokens) {\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-tokens',\r\n        icon: 'fas fa-user-circle',\r\n        onclick: () => {\r\n          showMassEdit(this.options.tokens, 'Token');\r\n          this.close();\r\n        },\r\n      });\r\n    }\r\n    return buttons;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = await super.getData(options);\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`, 'me-navHeaderPartial');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/form-group.html`, 'me-form-group');\r\n\r\n    data.nav = this.nav;\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.me-pinned').click((event) => {\r\n      const star = $(event.target).parent();\r\n      const control = star.closest('.form-group').find('[name]');\r\n      const name = control.attr('name');\r\n      if (star.hasClass('active')) {\r\n        star.removeClass('active');\r\n        delete this.pinnedFields[name];\r\n      } else {\r\n        star.addClass('active');\r\n        this.pinnedFields[name] = { label: name };\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label').on('input', (event) => {\r\n      const name = $(event.target).closest('.form-group').find('[name]').attr('name');\r\n      this.editableLabels[name] = event.target.value;\r\n    });\r\n\r\n    html.find('.color-number').on('change', (event) => {\r\n      if (event.target.dataset?.editNumber) {\r\n        let col = 0;\r\n        try {\r\n          col = Number(Color.fromString(event.target.value));\r\n        } catch (e) {}\r\n\r\n        $(event.target).siblings(`[name=\"${event.target.dataset.editNumber}\"]`).val(col).trigger('input');\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label, label').on('contextmenu', (event) => {\r\n      const formGroup = $(event.target).closest('.form-group');\r\n      if (!formGroup.length) return;\r\n      const input = formGroup.find('[name]');\r\n      const name = input.attr('name');\r\n      if (name) {\r\n        if (isColorField(name)) return;\r\n\r\n        const type = input.attr('type');\r\n        if (type === 'range') {\r\n          unsetCustomControl(name, this.documentName);\r\n          return;\r\n        } else if (type === 'number') {\r\n          defineRangeControl(name, input.val(), this.customControls, this.documentName);\r\n        } else if (type === 'text') {\r\n          defineSelectControl(name, input.val(), this.customControls, this.documentName);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (this.options.inputChangeCallback) {\r\n      html.on('change', 'input, select', async (event) => {\r\n        setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    super._updateObject(event, formData);\r\n\r\n    // Save pinned field values and labels\r\n    const pinned = game.settings.get(MODULE_ID, 'pinnedFields');\r\n    pinned[this.documentName] = this.pinnedFields;\r\n\r\n    for (const name of Object.keys(this.pinnedFields)) {\r\n      this.pinnedFields[name].value = formData[name];\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(this.editableLabels)) {\r\n      for (const [name, label] of Object.entries(this.editableLabels)) {\r\n        if (name in this.pinnedFields) {\r\n          this.pinnedFields[name].label = label;\r\n          this.pinnedFields[name].value = formData[name];\r\n        }\r\n      }\r\n      this.editableLabels = {};\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'pinnedFields', pinned);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    if (this.callbackOnUpdate) this.callbackOnUpdate(null);\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\nfunction defineRangeControl(name, val, customControls, documentName, { min = null, max = null, step = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>Range</label>\r\n  <div class=\"form-fields\">\r\n    <label>${localize('Minimum', false)}</label>\r\n    <input type=\"number\" value=\"${min ?? val}\" name=\"min\" step=\"any\">\r\n    <label>${localize('Maximum', false)}</label>\r\n    <input type=\"number\" value=\"${max ?? val}\" name=\"max\" step=\"any\">\r\n    <label>${localize('generic-form.step-size')}</label>\r\n    <input type=\"number\" value=\"${step ?? 1}\" name=\"step\" step=\"any\">\r\n  </div>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-range'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const min = html.find('[name=\"min\"]').val() || val;\r\n          const max = html.find('[name=\"max\"]').val() || val;\r\n          const step = html.find('[name=\"step\"]').val() || 1;\r\n\r\n          setProperty(customControls, name, { range: true, min, max, step });\r\n          const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n          allControls[documentName] = customControls;\r\n          game.settings.set(MODULE_ID, 'customControls', allControls);\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction defineSelectControl(name, val, customControls, documentName, { options = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>${localize('common.options')}</label>\r\n  <textarea name=\"options\">${options ? options.join('\\n') : val}</textarea>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-dropdown'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const options = html.find('[name=\"options\"]').val().trim();\r\n          if (options) {\r\n            setProperty(customControls, name, {\r\n              select: true,\r\n              options: options.split('\\n').filter((o) => o),\r\n            });\r\n            const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n            allControls[documentName] = customControls;\r\n            game.settings.set(MODULE_ID, 'customControls', allControls);\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction unsetCustomControl(name, documentName) {\r\n  const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n  let docControls = allControls[documentName] || {};\r\n  setProperty(docControls, name, null);\r\n  game.settings.set(MODULE_ID, 'customControls', allControls);\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_SHEET_CONFIGS } from '../scripts/constants.js';\r\nimport { showPlaceableTypeSelectDialog } from '../scripts/dialogs.js';\r\nimport { PresetAPI } from '../scripts/presets/collection.js';\r\nimport { getData, getDocumentName } from '../scripts/utils.js';\r\nimport { getClipboardData, pasteDataUpdate } from './formUtils.js';\r\nimport { WithMassConfig } from './forms.js';\r\nimport { MassEditGenericForm } from './generic/genericForm.js';\r\n\r\nexport const LAYER_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lighting',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\nexport const SCENE_DOC_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lights',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\n// Retrieve currently controlled placeables\r\nexport function getControlled() {\r\n  if (canvas.activeLayer.controlled.length) {\r\n    return canvas.activeLayer.controlled;\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve hovered over placeable\r\nfunction getHover() {\r\n  let documentName = canvas.activeLayer.constructor.documentName;\r\n  // Walls do not properly cleanup hover state\r\n  if (!['Wall'].includes(documentName)) {\r\n    if (canvas.activeLayer.hover) {\r\n      return [canvas.activeLayer.hover];\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve documents selected using Multiple Document Selection module (https://github.com/ironmonk88/multiple-document-selection)\r\nfunction getSelectedDocuments(placeableSelect) {\r\n  const supportedDocs = [\r\n    { name: 'Actor', class: 'actor' },\r\n    { name: 'Scene', class: 'scene' },\r\n    { name: 'JournalEntry', class: 'journalentry' },\r\n    { name: 'Playlist', class: 'sound' },\r\n    { name: 'Item', class: 'item' },\r\n    { name: 'RollTable', class: 'rolltable' },\r\n    { name: 'Cards', class: 'cards' },\r\n  ];\r\n  for (const doc of supportedDocs) {\r\n    const selected = [];\r\n    $(`.directory-list .${doc.class}.selected`).each(function (_) {\r\n      let d;\r\n      if (doc.name === 'Playlist') {\r\n        d = game.collections.get(doc.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n      } else {\r\n        d = game.collections.get(doc.name).get(this.dataset.documentId);\r\n      }\r\n\r\n      if (d) {\r\n        // JournalEntries themselves do not have configs, but notes that they correspond to on the scene do\r\n        if (placeableSelect && doc.name === 'JournalEntry') {\r\n          game.collections.get('Scene').forEach((s) =>\r\n            s.notes.forEach((n) => {\r\n              const eid = n.entryId ?? n.data.entryId;\r\n              if (d.id === eid) {\r\n                selected.push(n);\r\n              }\r\n            })\r\n          );\r\n          // canvas.notes.placeables\r\n          //   .filter((n) => d.id === (n.entryId ?? n.data.entryId))\r\n          //   .forEach((n) => selected.push(n));\r\n        } else {\r\n          if (d) selected.push(d);\r\n        }\r\n      }\r\n    });\r\n    if (selected.length) {\r\n      return selected;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function getSelected(base, placeable = true) {\r\n  let selected;\r\n  if (base) {\r\n    if (Array.isArray(base)) selected = base;\r\n    else selected = [base];\r\n  }\r\n  if (!selected) selected = getSelectedDocuments(placeable);\r\n  if (!selected) selected = getControlled();\r\n\r\n  // Sort placeable on the scene using their (x, y) coordinates\r\n  if (selected && selected.length > 1 && selected[0].x != null && selected[0].y != null) {\r\n    selected.sort((p1, p2) => {\r\n      const c = p1.y - p2.y;\r\n      if (c === 0) {\r\n        return p1.x - p2.x;\r\n      }\r\n      return c;\r\n    });\r\n  }\r\n\r\n  // We want one object to be treated as the target for the form\r\n  // Will prioritize hovered placeable for this purpose\r\n  let hover = getHover();\r\n  hover = hover ? hover[0] : hover;\r\n\r\n  if (!selected && hover) selected = [hover];\r\n  if (!hover && selected) hover = selected[0];\r\n\r\n  if (!hover && !selected) return [null, null];\r\n\r\n  if (hover && getDocumentName(hover) !== getDocumentName(selected[0])) {\r\n    hover = selected[0];\r\n  }\r\n\r\n  return [hover, selected];\r\n}\r\n\r\n// Show placeable search\r\nexport function showMassSelect(basePlaceable) {\r\n  let [target, selected] = getSelected(basePlaceable);\r\n\r\n  if (!target) {\r\n    showPlaceableTypeSelectDialog();\r\n    return;\r\n  }\r\n\r\n  const documentName = getDocumentName(target);\r\n\r\n  const options = {\r\n    commonData: foundry.utils.flattenObject(getData(target).toObject()),\r\n    massSelect: true,\r\n    documentName: documentName,\r\n  };\r\n\r\n  if (SUPPORTED_SHEET_CONFIGS.includes(documentName) && documentName !== 'Actor') {\r\n    const MassConfig = WithMassConfig(documentName);\r\n    new MassConfig(target, selected, options).render(true, {});\r\n  } else if (SUPPORTED_COLLECTIONS.includes(documentName)) {\r\n    new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\n// show placeable edit\r\nexport async function showMassEdit(found = null, documentName, options = {}) {\r\n  let [target, selected] = getSelected(found);\r\n\r\n  // If there are no placeable in control or just one, then either exit or display the default config window\r\n  if (!selected || !selected.length) return;\r\n\r\n  if (!options.forceForm && game.settings.get(MODULE_ID, 'singleDocDefaultConfig')) {\r\n    if (selected.length === 1) {\r\n      if (selected[0].sheet) selected[0].sheet.render(true, {});\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Display modified config window\r\n  if (!documentName) documentName = getDocumentName(target);\r\n  options = { ...options, massEdit: true, documentName };\r\n  if (SUPPORTED_SHEET_CONFIGS.includes(documentName)) {\r\n    if (documentName === 'Actor') {\r\n      target = target.prototypeToken;\r\n      selected = selected.map((s) => s.prototypeToken);\r\n      options.documentName = 'Token';\r\n    }\r\n    const MassConfig = WithMassConfig(options.documentName);\r\n    return new MassConfig(target, selected, options).render(true, {});\r\n  } else {\r\n    return new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\nexport function showMassActorForm(selectedTokens, options) {\r\n  const tokens = [];\r\n  const actors = [];\r\n  selectedTokens.forEach((s) => {\r\n    if (s.actor) {\r\n      tokens.push(s);\r\n      actors.push(s.actor);\r\n    }\r\n  });\r\n\r\n  if (actors.length) {\r\n    new MassEditGenericForm(actors, {\r\n      tokens,\r\n      documentName: 'Actor',\r\n      ...options,\r\n    }).render(true);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function pasteData() {\r\n  let selected;\r\n  if (!selected) selected = getSelectedDocuments();\r\n  if (!selected) selected = getControlled();\r\n  if (!selected) selected = getHover();\r\n\r\n  if (selected) return pasteDataUpdate(selected, null, false, true);\r\n  else {\r\n    let documentName = canvas.activeLayer.constructor.documentName;\r\n    const preset = getClipboardData(documentName);\r\n    if (preset) {\r\n      PresetAPI.spawnPreset({ preset });\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Displays a Generic Mass Edit form for the passed in data object/s\r\n * @param {Array|Object} data Object/s to be edited using the form\r\n * @param {String} name the name to be assigned internally to this data which will be used to manage presets and pins\r\n * @returns Promised resolved once the opened form is submitted\r\n */\r\nexport function showGenericForm(data, name = 'GenericData', options) {\r\n  return new Promise((resolve) => {\r\n    new MassEditGenericForm(Array.isArray(data) ? data : [data], {\r\n      documentName: name,\r\n      callback: () => resolve(),\r\n      ...options,\r\n    }).render(true);\r\n  });\r\n}\r\n\r\n/**\r\n * Get the instance of an open Mass Edit form\r\n * @returns\r\n */\r\nexport function getMassEditForm() {\r\n  return (\r\n    Object.values(ui.windows).find((app) => app.meObjects != null) ??\r\n    Array.from(foundry.applications.instances.values()).find((app) => app.meObjects != null)\r\n  );\r\n}\r\n","import { pasteDataUpdate } from '../applications/formUtils.js';\r\nimport { MODULE_ID } from './constants.js';\r\nimport { Mouse3D } from './mouse3d.js';\r\nimport { Picker } from './picker.js';\r\nimport { PresetAPI } from './presets/collection.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\nimport { TagInput } from './utils.js';\r\n\r\nexport class Brush {\r\n  static app;\r\n  static deactivateCallback;\r\n  static spawner;\r\n  static eraser;\r\n  static lastSpawnTime;\r\n  // @type {Preset}\r\n  static preset;\r\n  static brushOverlay;\r\n  static updatedPlaceables = new Map();\r\n  static hoveredPlaceables = new Set();\r\n  static spawnPoints = [];\r\n  static hoveredPlaceable;\r\n  static documentName;\r\n  static active = false;\r\n  static hitTest;\r\n\r\n  static _checkDensity(pos) {\r\n    const d = canvas.grid.size * this.spawnDensity;\r\n    return this.spawnPoints.every((p) => Math.sqrt((p.x - pos.x) ** 2 + (p.y - pos.y) ** 2) >= d);\r\n  }\r\n\r\n  static _performBrushDocumentUpdate(placeable) {\r\n    this.preset.callPostSpawnHooks({ objects: [placeable], documents: [placeable.document] });\r\n    if (!this.preset.isEmpty) pasteDataUpdate([placeable], this.preset, true, true, this.transform);\r\n    this.updatedPlaceables.set(placeable.id, placeable);\r\n    BrushMenu.iterate();\r\n  }\r\n\r\n  static _performBrushDocumentCreate(pos) {\r\n    const now = new Date().getTime();\r\n    if (!this.lastSpawnTime || now - this.lastSpawnTime > 100) {\r\n      this.lastSpawnTime = now;\r\n\r\n      if (!this._checkDensity(pos)) return;\r\n      Picker.resolve(pos);\r\n      this.spawnPoints.push(pos);\r\n\r\n      BrushMenu.iterate();\r\n    }\r\n  }\r\n\r\n  static _performBrushDocumentDelete(placeable) {\r\n    this.hoveredPlaceable = null;\r\n    if (!placeable._brushDelete) placeable.document?.delete();\r\n    placeable._brushDelete = true;\r\n  }\r\n\r\n  static _hitTestWall(point, wall) {\r\n    return wall.line.hitArea.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hitTestRegion(point, region) {\r\n    return region.bounds.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hitTestControlIcon(point, placeable) {\r\n    return (\r\n      Number.between(\r\n        point.x,\r\n        placeable.x - placeable.controlIcon.width / 2,\r\n        placeable.x + placeable.controlIcon.width / 2\r\n      ) &&\r\n      Number.between(\r\n        point.y,\r\n        placeable.y - placeable.controlIcon.height / 2,\r\n        placeable.y + placeable.controlIcon.height / 2\r\n      )\r\n    );\r\n  }\r\n\r\n  static _hitTestTile(point, placeable) {\r\n    const foreground = ui.controls.control.foreground ?? false;\r\n    // V12, to be removed\r\n    if (placeable.document.hasOwnProperty('elevation')) {\r\n      if (placeable.document.elevation && !foreground) return false;\r\n    } else {\r\n      if (placeable.document.overhead !== foreground) return false;\r\n    }\r\n    return placeable.bounds.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hoverTestArea(placeable) {\r\n    if (!this.hoveredPlaceable) return false;\r\n\r\n    const hBounds = this.hoveredPlaceable.bounds;\r\n    const pBounds = placeable.bounds;\r\n    return hBounds.width * hBounds.height > pBounds.width * pBounds.height;\r\n  }\r\n\r\n  static _hitTestArea(point, placeable) {\r\n    return (\r\n      Number.between(point.x, placeable.x, placeable.x + placeable.hitArea.width) &&\r\n      Number.between(point.y, placeable.y, placeable.y + placeable.hitArea.height)\r\n    );\r\n  }\r\n\r\n  static _onBrushMove(event) {\r\n    const pos = event.data.getLocalPosition(this.brushOverlay);\r\n    const layer = canvas.getLayerByEmbeddedName(this.documentName);\r\n    this._clearHover(event, pos);\r\n\r\n    for (const p of layer.placeables) {\r\n      if (p.visible && this.hitTest(pos, p) && !this.updatedPlaceables.has(p.id) && this.hoveredPlaceable !== p) {\r\n        if (this.hoverTest?.(p)) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoverTest && this.hoveredPlaceable && this.hoveredPlaceable !== p) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoveredPlaceable) {\r\n          this.hoveredPlaceable = p;\r\n        }\r\n\r\n        this.hoveredPlaceable._onHoverIn(event);\r\n      }\r\n    }\r\n  }\r\n\r\n  static _clearHover(event, pos, force = false) {\r\n    if (this.hoveredPlaceable) {\r\n      if (force || !this.hoveredPlaceable.visible || !this.hitTest(pos, this.hoveredPlaceable)) {\r\n        this.hoveredPlaceable._onHoverOut(event);\r\n        this.hoveredPlaceable = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  static _onBrushClickMove(event) {\r\n    if (this.spawner) {\r\n      this._performBrushDocumentCreate(event.data.getLocalPosition(this.brushOverlay));\r\n    } else if (\r\n      this.hoveredPlaceable &&\r\n      this.hoveredPlaceable.visible &&\r\n      !this.updatedPlaceables.has(this.hoveredPlaceable.id)\r\n    ) {\r\n      if (this.eraser) this._performBrushDocumentDelete(this.hoveredPlaceable);\r\n      else this._performBrushDocumentUpdate(this.hoveredPlaceable);\r\n    }\r\n  }\r\n\r\n  static _on3DBrushClick({ x, y, z, placeable } = {}) {\r\n    if (this.spawner) {\r\n      this._performBrushDocumentCreate({ x, y, z });\r\n    } else {\r\n      if (placeable && placeable.document.documentName === this.documentName) {\r\n        if (this.eraser) this._performBrushDocumentDelete(placeable);\r\n        else this._performBrushDocumentUpdate(placeable);\r\n      }\r\n      this.updatedPlaceables.clear();\r\n    }\r\n  }\r\n\r\n  static refreshPreset() {\r\n    if (this.active && this.app) {\r\n      this.preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: this.app.getSelectedFields(),\r\n        randomize: this.app.randomizeFields,\r\n        addSubtract: this.app.addSubtractFields,\r\n      });\r\n    }\r\n  }\r\n\r\n  static async genPreview() {\r\n    PresetAPI.spawnPreset({\r\n      preset: this.preset,\r\n      coordPicker: true,\r\n      previewOnly: true,\r\n      center: true,\r\n      taPreview: 'ALL',\r\n      transform: this.transform,\r\n      snapToGrid: this.snap,\r\n      scaleToGrid: this.scaleToGrid,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Object} options\r\n   * @param {MassEditForm} options.app\r\n   * @param {Preset} options.preset\r\n   * @returns\r\n   */\r\n  static activate({\r\n    app = null,\r\n    preset = null,\r\n    deactivateCallback = null,\r\n    spawner = false,\r\n    spawnDensity = 0.01,\r\n    eraser = false,\r\n    refresh = false,\r\n    transform = {},\r\n    snap = true,\r\n    scaleToGrid = true,\r\n  } = {}) {\r\n    this.deactivate(refresh);\r\n    if (!canvas.ready) return false;\r\n    if (!app && !preset) return false;\r\n\r\n    if (this.brushOverlay) {\r\n      this.brushOverlay.destroy(true);\r\n    }\r\n\r\n    // Setup fields to be used for updates\r\n    this.app = app;\r\n    this.preset = preset;\r\n    this.transform = transform;\r\n    this.deactivateCallback = deactivateCallback;\r\n    this.spawner = spawner;\r\n    this.eraser = eraser;\r\n    this.snap = snap;\r\n    this.spawnDensity = spawnDensity;\r\n    this.scaleToGrid = scaleToGrid;\r\n    if (this.app) {\r\n      this.documentName = this.app.documentName;\r\n    } else {\r\n      this.documentName = this.preset.documentName;\r\n    }\r\n    if (!refresh) {\r\n      this.updatedPlaceables.clear();\r\n      this.spawnPoints = [];\r\n    }\r\n\r\n    const interaction = canvas.app.renderer.events;\r\n    if (!interaction.cursorStyles['brush']) {\r\n      interaction.cursorStyles['brush'] = `url('modules/${MODULE_ID}/images/brush_icon.png'), auto`;\r\n      interaction.cursorStyles['brush_spawn'] = `url('modules/${MODULE_ID}/images/brush_icon_spawn.png'), auto`;\r\n      interaction.cursorStyles['eraser'] = `url('modules/${MODULE_ID}/images/brush_icon_eraser.png'), auto`;\r\n    }\r\n\r\n    this.active = true;\r\n    this.refreshPreset();\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      if (this.spawner) this.genPreview();\r\n      return this._activate3d();\r\n    }\r\n\r\n    // Determine hit test test function to be used for pointer hover detection\r\n    if (this.spawner) {\r\n      this.hitTest = () => false;\r\n      this.genPreview();\r\n    } else {\r\n      switch (this.documentName) {\r\n        case 'Wall':\r\n          this.hitTest = this._hitTestWall;\r\n          break;\r\n        case 'Region':\r\n          this.hitTest = this._hitTestRegion;\r\n          break;\r\n        case 'AmbientLight':\r\n        case 'MeasuredTemplate':\r\n        case 'AmbientSound':\r\n        case 'Note':\r\n          this.hitTest = this._hitTestControlIcon;\r\n          break;\r\n        case 'Tile':\r\n          this.hitTest = this._hitTestTile;\r\n          this.hoverTest = this._hoverTestArea;\r\n          break;\r\n        default:\r\n          this.hitTest = this._hitTestArea;\r\n          this.hoverTest = this._hoverTestArea;\r\n      }\r\n    }\r\n\r\n    // Create the brush overlay\r\n    this.brushOverlay = new PIXI.Container();\r\n    this.brushOverlay.hitArea = canvas.dimensions.rect;\r\n\r\n    let cursor = 'brush';\r\n    if (spawner) cursor = 'brush_spawn';\r\n    else if (eraser) cursor = 'eraser';\r\n    this.brushOverlay.cursor = cursor;\r\n\r\n    this.brushOverlay.interactive = true;\r\n    this.brushOverlay.zIndex = Infinity;\r\n\r\n    this.brushOverlay.on('mousemove', (event) => {\r\n      Picker.feedPos(event.data.getLocalPosition(this.brushOverlay));\r\n      this._onBrushMove(event);\r\n      if (!this.mDownWithinCanvas) return; // Fix to prevent mouse interaction within apps\r\n      if (event.buttons === 1) this._onBrushClickMove(event);\r\n    });\r\n    this.brushOverlay.on('mouseup', (event) => {\r\n      this.mDownWithinCanvas = false; // Fix to prevent mouse interaction within apps\r\n      if (event.nativeEvent.which !== 2) {\r\n        this._onBrushClickMove(event);\r\n      }\r\n      this.updatedPlaceables.clear();\r\n      this.spawnPoints = [];\r\n    });\r\n\r\n    this.brushOverlay.on('mousedown', (event) => {\r\n      this.mDownWithinCanvas = true; // Fix to prevent mouse interaction within apps\r\n    });\r\n\r\n    this.brushOverlay.on('click', (event) => {\r\n      if (event.nativeEvent.which == 2) {\r\n        this.deactivate();\r\n      }\r\n    });\r\n\r\n    canvas.stage.addChild(this.brushOverlay);\r\n\r\n    // Disable canvas events to prevent selects and object placements on click\r\n    canvas.mouseInteractionManager.permissions.clickLeft = false;\r\n    // canvas.mouseInteractionManager.permissions.longPress = false;\r\n\r\n    return true;\r\n  }\r\n\r\n  static _activate3d() {\r\n    Mouse3D.activate({\r\n      mouseMoveCallback: Picker.feedPos.bind(Picker),\r\n      mouseClickCallback: this._on3DBrushClick.bind(this),\r\n      mouseWheelClickCallback: this.deactivate.bind(this),\r\n    });\r\n    return true;\r\n  }\r\n\r\n  static deactivate(refresh = false) {\r\n    if (this.active) {\r\n      canvas.mouseInteractionManager.permissions.clickLeft = true;\r\n      //canvas.mouseInteractionManager.permissions.longPress = true;\r\n      if (this.brushOverlay) this.brushOverlay.parent?.removeChild(this.brushOverlay);\r\n      this.active = false;\r\n\r\n      if (!refresh) {\r\n        this.updatedPlaceables.clear();\r\n        this.spawnPoints = [];\r\n        this._clearHover(null, null, true);\r\n      }\r\n      this.hoverTest = null;\r\n      if (!refresh) this.deactivateCallback?.();\r\n      if (this.spawner) Picker.destroy();\r\n      this.spawner = false;\r\n      this.eraser = false;\r\n      this.deactivateCallback = null;\r\n      this.app = null;\r\n      this.preset = null;\r\n      this.transform = null;\r\n      return true;\r\n    }\r\n    Mouse3D.deactivate();\r\n  }\r\n}\r\n\r\n// =================================================\r\n\r\nexport class BrushMenu extends FormApplication {\r\n  static addPresets(presets = []) {\r\n    if (!this._instance) return this.render(presets);\r\n    else this._instance.addPresets(presets);\r\n  }\r\n\r\n  static isActive() {\r\n    return Boolean(this._instance);\r\n  }\r\n\r\n  static removePreset(id) {\r\n    if (!this._instance) return;\r\n    this._instance.removePreset(id);\r\n  }\r\n\r\n  static iterate(forward = true, force = false) {\r\n    if (!this._instance) return;\r\n    this._instance.iterate(forward, force);\r\n  }\r\n\r\n  static render(presets, settings = {}) {\r\n    if (this._instance) this.addPresets(presets);\r\n    else {\r\n      this._instance = new BrushMenu(presets, settings);\r\n      this._instance.render(true);\r\n    }\r\n  }\r\n\r\n  static async close() {\r\n    return this._instance?.close(true);\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-brush-menu',\r\n      template: `modules/${MODULE_ID}/templates/preset/brush/menu.html`,\r\n      classes: ['mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      resizable: false,\r\n      minimizable: false,\r\n      width: 200,\r\n      height: 'auto',\r\n      scrollY: ['.presets'],\r\n    });\r\n  }\r\n\r\n  constructor(presets, settings = {}) {\r\n    super({}, { left: 10, top: window.innerHeight / 2 });\r\n    this.presets = presets ?? [];\r\n    this.preset = this.presets[0].clone();\r\n    this.preset.data = this.preset.data[0];\r\n    this._settings = foundry.utils.mergeObject(game.settings.get(MODULE_ID, 'brush'), settings);\r\n    this._it = -1;\r\n    this._createIndex();\r\n    this.iterate();\r\n  }\r\n\r\n  _createIndex() {\r\n    const index = [];\r\n\r\n    if (this._settings.group) {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        index.push({ pI });\r\n      }\r\n    } else {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        const preset = this.presets[pI];\r\n        for (let dI = 0; dI < preset.data.length; dI++) {\r\n          index.push({ pI, dI });\r\n        }\r\n      }\r\n    }\r\n    this._index = index;\r\n    if (this._it >= this._index.length) this._it = this._index.length - 1;\r\n  }\r\n\r\n  async _activateBrush(refresh = true) {\r\n    const index = this._index[this._it];\r\n    const p = this.presets[index.pI];\r\n    this.preset = p.clone();\r\n    if (index.hasOwnProperty('dI')) this.preset.data = [this.preset.data[index.dI]];\r\n\r\n    // Apply Color\r\n    await this._applyColor();\r\n\r\n    // Apply TMFX Filters\r\n    this._applyTmfxPresets(this.preset, this._settings.tmfxPreset);\r\n\r\n    // Apply Tagger tags\r\n    this._applyTaggerTags(this.preset, this._settings.tagger);\r\n\r\n    Brush.activate({\r\n      preset: this.preset,\r\n      deactivateCallback: this._deactivateCallback.bind(this),\r\n      spawner: this._settings.spawner,\r\n      eraser: this._settings.eraser,\r\n      transform: this._getTransform(),\r\n      refresh,\r\n      snap: this._settings.snap,\r\n      scaleToGrid: this._settings.scaleToGrid,\r\n      spawnDensity: this._settings.density,\r\n    });\r\n  }\r\n\r\n  async _applyColor() {\r\n    if (this._settings.randomColor || this._settings.color) {\r\n      let pPath;\r\n      const documentName = this.preset.documentName;\r\n      if (documentName === 'Token' || documentName === 'Tile') pPath = 'texture.tint';\r\n      else if (documentName === 'AmbientLight') pPath = 'config.color';\r\n\r\n      if (game.Levels3DPreview?._active) {\r\n        if (documentName === 'Token' || documentName === 'Tile') pPath = 'flags.levels-3d-preview.color';\r\n      }\r\n\r\n      if (pPath) {\r\n        if (this._settings.randomColor) {\r\n          const updates = this.preset.data.map(() => {\r\n            return { color: '' };\r\n          });\r\n          await applyRandomization(updates, null, { color: { type: 'color', ...this._settings.randomColor } });\r\n\r\n          this.preset.data.forEach((d, i) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, updates[i].color);\r\n            else foundry.utils.setProperty(d, pPath, updates[i].color);\r\n          });\r\n        } else {\r\n          this.preset.data.forEach((d) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, this._settings.color);\r\n            else foundry.utils.setProperty(d, pPath, this._settings.color);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  _applyDDTint(data, color) {\r\n    let filters = foundry.utils.getProperty(data, 'flags.tokenmagic.filters');\r\n\r\n    if (!color) {\r\n      if (filters) {\r\n        foundry.utils.setProperty(\r\n          data,\r\n          'flags.tokenmagic.filters',\r\n          filters.filter((f) => f.tmFilters.filterId !== 'DDTint')\r\n        );\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      foundry.utils.setProperty(data, 'flags.tokenmagic.filters', filters);\r\n    }\r\n  }\r\n\r\n  _applyTaggerTags(preset, tags) {\r\n    if (!tags || !tags.length) return;\r\n    if (!game.modules.get('tagger')?.active) return;\r\n\r\n    preset.addPostSpawnHook(({ objects } = {}) => {\r\n      Tagger.addTags(objects, tags);\r\n    });\r\n  }\r\n\r\n  _applyTmfxPresets(preset, tmfxPreset) {\r\n    if (!tmfxPreset) return;\r\n    if (!game.modules.get('tokenmagic')?.active) return;\r\n    if (!['Token', 'Tile', 'Drawing', 'MeasuredTemplate'].includes(preset.documentName)) return;\r\n\r\n    if (!Array.isArray(tmfxPreset)) tmfxPreset = [tmfxPreset];\r\n\r\n    if (tmfxPreset.includes('DELETE ALL')) {\r\n      this.preset.addPostSpawnHook(({ objects } = {}) => objects.forEach((o) => TokenMagic.deleteFilters(o)));\r\n      return;\r\n    } else if (tmfxPreset.includes('DELETE')) {\r\n      this.preset.addPostSpawnHook(({ objects } = {}) =>\r\n        objects.forEach(async (o) => {\r\n          for (const p of tmfxPreset) await TokenMagic.deleteFilters(o, p);\r\n        })\r\n      );\r\n      return;\r\n    }\r\n\r\n    const filters = [];\r\n    tmfxPreset.forEach((presetName) => TokenMagic.getPreset(presetName)?.forEach((filter) => filters.push(filter)));\r\n\r\n    if (filters.length)\r\n      this.preset.addPostSpawnHook(({ objects } = {}) =>\r\n        objects.forEach((o) => TokenMagic.addUpdateFilters(o, filters))\r\n      );\r\n  }\r\n\r\n  get title() {\r\n    return 'Brush';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    return {\r\n      presets: this.presets,\r\n      activePreset: this.preset,\r\n      ...this._settings,\r\n      tmfxActive: game.modules.get('tokenmagic')?.active,\r\n      taggerActive: game.modules.get('tagger')?.active,\r\n    };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const settings = this._settings;\r\n    const app = this;\r\n\r\n    import('./jquery-ui/jquery-ui.js').then((module) => {\r\n      const rotationRangeLabel = html.find('.rotation-range-label');\r\n      html.find('.rotation-slider').slider({\r\n        range: true,\r\n        min: -180,\r\n        max: 180,\r\n        values: settings.rotation,\r\n        slide: function (event, ui) {\r\n          rotationRangeLabel.text(`${ui.values[0]} - ${ui.values[1]}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ rotation: ui.values });\r\n        },\r\n      });\r\n\r\n      const scaleRangeLabel = html.find('.scale-range-label');\r\n      html.find('.scale-slider').slider({\r\n        range: true,\r\n        min: 0.1,\r\n        max: 4,\r\n        step: 0.01,\r\n        values: settings.scale,\r\n        slide: function (event, ui) {\r\n          scaleRangeLabel.text(`${ui.values[0]} - ${ui.values[1]}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ scale: ui.values });\r\n        },\r\n      });\r\n\r\n      const densityRangeLabel = html.find('.density-range-label');\r\n      html.find('.density-slider').slider({\r\n        range: false,\r\n        min: 0.01,\r\n        max: 4,\r\n        step: 0.01,\r\n        value: settings.density ?? 0.01,\r\n        slide: function (event, ui) {\r\n          densityRangeLabel.text(`${ui.value}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ density: ui.value });\r\n        },\r\n      });\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.on('click', '.toggle-button', this._toggleSetting.bind(this));\r\n    html.find('.reset').on('click', this._resetToDefaults.bind(this));\r\n    html.on('click', '.preset', this._onClickPreset.bind(this));\r\n    html.on('contextmenu', '.preset', this._onRightClickPreset.bind(this));\r\n\r\n    // Colorize\r\n    html.on('click', '.randomize-color', this._onRandomizeColor.bind(this));\r\n    html.on('change', 'color-picker', this._onColorChange.bind(this));\r\n    html.on('input paste', 'color-picker input[type=\"text\"]', this._onColorChange.bind(this));\r\n    html.find('.colorizeControl').on('click', this._onColorMenu.bind(this));\r\n\r\n    html.find('.tmfxPresetControl').on('click', () => {\r\n      this._onEditTaglikeField({\r\n        label: 'TMFX',\r\n        name: 'tmfxPreset',\r\n        tags: this._settings.tmfxPreset,\r\n        simplifyTags: false,\r\n        listId: 'tmfxPresets',\r\n        listEntries: TokenMagic.getPresets().map((p) => p.name),\r\n      });\r\n    });\r\n    html.find('.taggerControl').on('click', () => {\r\n      this._onEditTaglikeField({\r\n        label: 'Tagger',\r\n        name: 'tagger',\r\n        tags: this._settings.tagger,\r\n        simplifyTags: false,\r\n      });\r\n    });\r\n  }\r\n\r\n  async _onEditTaglikeField({ label, name, tags, simplifyTags = true, listId, listEntries } = {}) {\r\n    const subMenu = this._toggleSubMenu(name);\r\n    if (!subMenu) return;\r\n\r\n    if (tags && !Array.isArray(tags)) tags = [tags];\r\n    const template = Handlebars.compile(\r\n      `{{tagInput name=name label=label tags=tags listId=listId listEntries=listEntries}}`\r\n    );\r\n    let content = template(\r\n      { name, label, tags, listId, listEntries },\r\n      {\r\n        allowProtoMethodsByDefault: true,\r\n        allowProtoPropertiesByDefault: true,\r\n      }\r\n    );\r\n\r\n    subMenu.html(content);\r\n    this.setPosition({ height: 'auto' });\r\n\r\n    TagInput.activateListeners(subMenu, {\r\n      change: (tags) => {\r\n        this.setPosition({ height: 'auto' });\r\n        this._updateBrushSettings({ [name]: tags.length ? tags : null });\r\n      },\r\n      simplifyTags,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Controls toggling of the sub-menu div container. The div is shared between many different controls, and behaviour\r\n   * depends on whether the same or different controls are being toggled\r\n   * @param {String} name a name of the control issuing a toggle\r\n   * @returns {Boolean} sub-menu element if sub-menu is to be rendered, null if sub-menu was emptied\r\n   */\r\n  _toggleSubMenu(name) {\r\n    const subMenu = this.element.find('.sub-menu');\r\n    if (subMenu.attr('data-control') === name) {\r\n      subMenu.html('').attr('data-control', null);\r\n      this.setPosition({ height: 'auto' });\r\n      return null;\r\n    } else subMenu.attr('data-control', name);\r\n    return subMenu;\r\n  }\r\n\r\n  async _onColorMenu(event) {\r\n    const subMenu = this._toggleSubMenu('colorize');\r\n    if (!subMenu) return;\r\n\r\n    const template = await getTemplate(`modules/${MODULE_ID}/templates/preset/brush/colorize.html`);\r\n    let content = template(await this.getData({}), {\r\n      allowProtoMethodsByDefault: true,\r\n      allowProtoPropertiesByDefault: true,\r\n    });\r\n\r\n    subMenu.html(content);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  async _onColorChange(event) {\r\n    let cString = $(event.currentTarget).val();\r\n    if (!cString) this._updateBrushSettings({ color: '' });\r\n    else {\r\n      let color = Color.fromString(cString);\r\n      if (!Number.isNaN(color.valueOf())) this._updateBrushSettings({ color: cString });\r\n    }\r\n  }\r\n\r\n  async _onClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    if (presetIndex != null) {\r\n      this._it = this._index.findIndex((i) => i.pI === presetIndex);\r\n      await this._activateBrush();\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRandomizeColor() {\r\n    const randomColor = this._settings.randomColor ?? {};\r\n    const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n      method: 'random',\r\n      lockMethod: true,\r\n      space: randomColor.space,\r\n      hue: randomColor.hue,\r\n    });\r\n\r\n    let colorSlider;\r\n    let dialog = new Dialog({\r\n      title: `Pick Range`,\r\n      content: `<form>${colorTemp}</form>`,\r\n      buttons: {\r\n        save: {\r\n          label: 'Apply',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: {\r\n                method: 'random',\r\n                space: html.find('[name=\"space\"]').val(),\r\n                hue: html.find('[name=\"hue\"]').val(),\r\n                colors: colorSlider.getColors(),\r\n              },\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n        remove: {\r\n          label: 'Remove',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: null,\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n      },\r\n      render: (html) => {\r\n        import('./randomizer/slider.js').then((module) => {\r\n          colorSlider = new module.ColorSlider(\r\n            html,\r\n            randomColor.colors ?? [\r\n              { hex: '#ff0000', offset: 0 },\r\n              { hex: '#ff0000', offset: 100 },\r\n            ]\r\n          );\r\n          setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n        });\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async _onRightClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    const preset = this.presets[presetIndex];\r\n    if (preset) this.removePreset(preset.id);\r\n  }\r\n\r\n  async _resetToDefaults() {\r\n    await this._updateBrushSettings({\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      density: 1,\r\n      color: null,\r\n      randomColor: null,\r\n      tmfxPreset: null,\r\n      tagger: null,\r\n    });\r\n    this.render(true);\r\n  }\r\n\r\n  async _toggleSetting(event) {\r\n    const control = $(event.target).closest('.toggle-button');\r\n    const update = { [control.data('name')]: !control.hasClass('active') };\r\n\r\n    if (update.spawner) update.eraser = false;\r\n    if (update.eraser) update.spawner = false;\r\n\r\n    await this._updateBrushSettings(update);\r\n\r\n    if (update.random) await this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async _updateBrushSettings(update) {\r\n    foundry.utils.mergeObject(this._settings, update);\r\n    await game.settings.set(MODULE_ID, 'brush', this._settings);\r\n\r\n    if (update.hasOwnProperty('group')) this._createIndex();\r\n    await this._activateBrush();\r\n  }\r\n\r\n  addPresets(presets = []) {\r\n    for (const preset of presets) {\r\n      if (!this.presets.find((p) => p.uuid === preset.uuid)) this.presets.push(preset);\r\n    }\r\n    this._createIndex();\r\n    this.render(true);\r\n  }\r\n\r\n  removePreset(id) {\r\n    const presetIndex = this.presets.findIndex((p) => p.id === id);\r\n    if (presetIndex === -1) return;\r\n\r\n    const wasActivePreset = this._index[this._it]?.pI === presetIndex;\r\n\r\n    this.presets = this.presets.filter((p) => p.id !== id);\r\n    if (this.presets.length === 0) return this.close(true);\r\n\r\n    this._createIndex();\r\n\r\n    if (wasActivePreset) this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async iterate(forward = true, force = false) {\r\n    if (force || !this._settings.lock) {\r\n      if (this._settings.random) this._it = Math.floor(Math.random() * this._index.length);\r\n      else {\r\n        this._it += forward ? 1 : -1;\r\n        if (this._it < 0) this._it = this._index.length - 1;\r\n        else this._it %= this._index.length;\r\n      }\r\n    } else {\r\n      if (this._it === -1) this._it = 0;\r\n    }\r\n\r\n    await this._activateBrush();\r\n    this.render(true);\r\n  }\r\n\r\n  /**\r\n   * Get transform to be immediately applied to the preset preview\r\n   * @returns {Object} e.g. { rotation: 45, scale: 0.8 }\r\n   */\r\n  _getTransform() {\r\n    const settings = this._settings;\r\n    const transform = {};\r\n\r\n    // Scale and Rotation transformation are accumulated on the picker\r\n    // We want to preserve these when rendering a new preview\r\n    const accumulatedTransform = Picker.getTransformAccumulator();\r\n\r\n    if (settings.scale[0] === settings.scale[1]) {\r\n      transform.scale = settings.scale[0];\r\n      transform.scale *= accumulatedTransform.scale;\r\n    } else {\r\n      const stepsInRange = (settings.scale[1] - settings.scale[0]) / 0.01;\r\n      transform.scale = Math.floor(Math.random() * stepsInRange) * 0.01 + settings.scale[0];\r\n      transform.scale *= accumulatedTransform.scale;\r\n    }\r\n\r\n    if (settings.rotation[0] === settings.rotation[1]) {\r\n      transform.rotation = settings.rotation[0];\r\n      transform.rotation += accumulatedTransform.rotation;\r\n    } else {\r\n      const stepsInRange = (settings.rotation[1] - settings.rotation[0] + 1) / 1;\r\n      transform.rotation = Math.floor(Math.random() * stepsInRange) * 1 + settings.rotation[0];\r\n    }\r\n\r\n    return transform;\r\n  }\r\n\r\n  _deactivateCallback() {\r\n    this.close(true);\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-brush-macro',\r\n      icon: 'fa-solid fa-code',\r\n      onclick: this._generateBrushMacro.bind(this),\r\n    });\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _generateBrushMacro() {\r\n    const genMacro = async function (command) {\r\n      const macro = await Macro.create({\r\n        name: 'Brush Macro',\r\n        type: 'script',\r\n        scope: 'global',\r\n        command,\r\n        img: `modules/${MODULE_ID}/images/brush_icon.png`,\r\n      });\r\n      macro.sheet.render(true);\r\n    };\r\n\r\n    const genUUIDS = function () {\r\n      const uuids = this.presets.map((p) => p.uuid).filter(Boolean);\r\n      if (!uuids.length) return;\r\n\r\n      const command = `MassEdit.openBrushMenu({ \r\n    uuid: ${JSON.stringify(uuids, null, 4)}\r\n  },\r\n  ${JSON.stringify(this._settings, null, 2)}\r\n  );`;\r\n      genMacro(command);\r\n    };\r\n\r\n    const genNames = function () {\r\n      const opts = this.presets.map((p) => {\r\n        return { name: p.name, type: p.documentName };\r\n      });\r\n\r\n      const command = `MassEdit.openBrushMenu(\r\n    ${JSON.stringify(opts, null, 4)}\r\n  ,\r\n  ${JSON.stringify(this._settings, null, 2)}\r\n  );`;\r\n      genMacro(command);\r\n    };\r\n\r\n    let dialog = new Dialog({\r\n      title: `Generate Macro`,\r\n      content: ``,\r\n      buttons: {\r\n        uuids: {\r\n          label: 'UUIDs',\r\n          callback: genUUIDS.bind(this),\r\n        },\r\n        name: {\r\n          label: 'Names',\r\n          callback: genNames.bind(this),\r\n        },\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    Brush.deactivate();\r\n    BrushMenu._instance = null;\r\n    Picker.destroy();\r\n    Picker.resetTransformAccumulator();\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\n/**\r\n * API method to activate the brush.\r\n * @param {Object} options See MassEdit.getPreset(...)\r\n * @param {String} mode update|spawn\r\n */\r\nexport async function activateBrush(options, mode = 'spawner') {\r\n  const preset = await PresetAPI.getPreset(options);\r\n  if (preset) {\r\n    Brush.activate({ preset, spawner: mode === 'spawner' });\r\n  }\r\n}\r\n\r\n/**\r\n * API method to de-activate the brush.\r\n */\r\nexport function deactivateBush() {\r\n  Brush.deactivate();\r\n}\r\n\r\n/**\r\n * Open Brush Menu using the provided presets\r\n * @param {Object} options See MassEdit.getPresets(...)\r\n * @param {Object} settings Brush Menu control settings\r\n */\r\nexport async function openBrushMenu(options, settings = {}) {\r\n  if (BrushMenu.isActive()) return BrushMenu.close();\r\n\r\n  let presets = [];\r\n\r\n  if (Array.isArray(options)) {\r\n    for (const opts of options) {\r\n      let preset = await PresetAPI.getPreset(opts);\r\n      if (preset) presets.push(preset);\r\n    }\r\n  } else {\r\n    presets = await PresetAPI.getPresets(options);\r\n  }\r\n\r\n  if (!presets?.length) return;\r\n  for (const preset of presets) await preset.load();\r\n  BrushMenu.render(presets, settings);\r\n}\r\n","export const MODULE_ID = 'multi-token-edit';\r\nexport const SUPPORTED_PLACEABLES = [\r\n  'Token',\r\n  'MeasuredTemplate',\r\n  'Tile',\r\n  'Drawing',\r\n  'Wall',\r\n  'AmbientLight',\r\n  'AmbientSound',\r\n  'Note',\r\n];\r\nexport const UI_DOCS = ['FAVORITES', 'ALL', ...SUPPORTED_PLACEABLES];\r\nexport const SUPPORTED_SHEET_CONFIGS = [...SUPPORTED_PLACEABLES, 'Actor', 'PlaylistSound', 'Scene'];\r\nexport const SUPPORTED_COLLECTIONS = ['Item', 'Cards', 'RollTable', 'Actor', 'JournalEntry', 'Scene'];\r\n\r\nexport const IMAGE_EXTENSIONS = ['webp', 'jpg', 'jpeg', 'png', 'svg', 'apng', 'avif', 'bmp', 'gif', 'tif'];\r\nexport const VIDEO_EXTENSIONS = ['mp4', 'ogv', 'webm', 'm4v'];\r\nexport const AUDIO_EXTENSIONS = ['aac', 'flac', 'm4a', 'mid', 'mp3', 'ogg', 'opus', 'wav'];\r\nexport const FILE_EXTENSIONS = [...IMAGE_EXTENSIONS, ...VIDEO_EXTENSIONS, ...AUDIO_EXTENSIONS];\r\n\r\nexport const LINKER_DOC_ICONS = {\r\n  Token: 'modules/multi-token-edit/images/linker/person-fill.svg',\r\n  MeasuredTemplate: 'modules/multi-token-edit/images/linker/rulers.svg',\r\n  Tile: 'modules/multi-token-edit/images/linker/boxes.svg',\r\n  Drawing: 'modules/multi-token-edit/images/linker/pencil-fill.svg',\r\n  Wall: 'modules/multi-token-edit/images/linker/bricks.svg',\r\n  AmbientLight: 'modules/multi-token-edit/images/linker/lightbulb-fill.svg',\r\n  AmbientSound: 'modules/multi-token-edit/images/linker/music-note-beamed.svg',\r\n  Note: 'modules/multi-token-edit/images/linker/bookmark-fill.svg',\r\n  Region: 'modules/multi-token-edit/images/linker/border-outer.svg',\r\n};\r\n","import { LAYER_MAPPINGS, showMassSelect } from '../applications/multiConfig.js';\r\nimport { SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from './constants.js';\r\nimport { localFormat, localize } from './utils.js';\r\n\r\nexport function showPlaceableTypeSelectDialog() {\r\n  let content = '';\r\n  for (const config of SUPPORTED_PLACEABLES.concat(SUPPORTED_COLLECTIONS)) {\r\n    content += `<option value=\"${config}\">${config}</option>`;\r\n  }\r\n  content = `<label>${localize('dialog.search-document')}</label>\r\n    <select style=\"width: 100%;\" name=\"documentName\">${content}</select>`;\r\n\r\n  new Dialog({\r\n    title: 'Document SEARCH',\r\n    content: content,\r\n    buttons: {\r\n      select: {\r\n        icon: '<i class=\"fas fa-check\"></i>',\r\n        label: 'Select',\r\n        callback: (html) => {\r\n          const documentName = html.find(\"select[name='documentName']\").val();\r\n\r\n          let docs = [];\r\n          if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n            const layer = LAYER_MAPPINGS[documentName];\r\n            if (layer && canvas[layer].placeables.length) {\r\n              docs = canvas[layer].placeables;\r\n            }\r\n          } else {\r\n            docs = Array.from(game.collections.get(documentName));\r\n          }\r\n\r\n          if (docs.length) {\r\n            showMassSelect(docs[0]);\r\n          } else {\r\n            ui.notifications.warn(localFormat('dialog.document-not-found', { document: documentName }));\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport async function importPresetFromJSONDialog() {\r\n  const content = `\r\n  <div class=\"form-group\">\r\n      <label for=\"data\">${localize('FILES.SelectFile', false)} </label>\r\n      <input type=\"file\" name=\"data\">\r\n  </div>\r\n  `;\r\n\r\n  let dialog = new Promise((resolve, reject) => {\r\n    new Dialog(\r\n      {\r\n        title: localize('presets.import'),\r\n        content: content,\r\n        buttons: {\r\n          import: {\r\n            icon: '<i class=\"fas fa-file-import\"></i>',\r\n            label: localize('common.import'),\r\n            callback: async (html) => {\r\n              let presets;\r\n              readTextFromFile(html.find('[name=\"data\"]')[0].files[0]).then((json) => {\r\n                try {\r\n                  presets = JSON.parse(json);\r\n                } catch (e) {}\r\n                resolve(presets);\r\n              });\r\n            },\r\n          },\r\n          no: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: localize('Cancel', false),\r\n            callback: () => resolve(false),\r\n          },\r\n        },\r\n        default: 'no',\r\n      },\r\n      {\r\n        width: 400,\r\n      }\r\n    ).render(true);\r\n  });\r\n  return await dialog;\r\n}\r\n","/**\r\n * Manage placeable linking to one another using `links` flag.\r\n */\r\n\r\nimport { DataTransform } from '../picker.js';\r\nimport { libWrapper } from '../shim/shim.js';\r\nimport { pickerSelectMultiLayerDocuments, updateEmbeddedDocumentsViaGM } from '../utils.js';\r\nimport { getDataBounds } from '../presets/utils.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES } from '../constants.js';\r\n\r\nconst PROCESSED_UPDATES = new Map();\r\nexport const LINK_TYPES = {\r\n  TWO_WAY: 0,\r\n  RECEIVE: 1,\r\n  SEND: 2,\r\n};\r\n\r\nexport function registerLinkerHooks() {\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    Hooks.on(`preUpdate${name}`, preUpdate);\r\n    Hooks.on(`update${name}`, update);\r\n  });\r\n\r\n  // UNDO linked document delete operation\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'PlaceablesLayer.prototype.undoHistory',\r\n    async function (wrapped, ...args) {\r\n      const type = this.history[this.history.length - 1]?.type;\r\n      const undone = await wrapped(...args);\r\n      if (type === 'delete' && undone?.length) {\r\n        const event = LinkerAPI.history.find((h) => undone.find((d) => d.id === h.id));\r\n\r\n        if (event) {\r\n          event.data.forEach((data, documentName) => {\r\n            canvas.scene.createEmbeddedDocuments(documentName, data, { isUndo: true, keepId: true });\r\n          });\r\n          LinkerAPI.history = LinkerAPI.history.filter((h) => !undone.find((d) => d.id === h.id));\r\n        }\r\n      }\r\n      return undone;\r\n    },\r\n    'WRAPPER'\r\n  );\r\n}\r\n\r\nfunction processLinks(transform, origin, links, scene, docUpdates, processedLinks, sourceId) {\r\n  SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n    const linked = scene\r\n      .getEmbeddedCollection(documentName)\r\n      .filter(\r\n        (t) =>\r\n          t.flags[MODULE_ID]?.links?.some((l1) => l1.type < 2 && links.find((l2) => l2.id === l1.id)) &&\r\n          t.id !== sourceId\r\n      );\r\n\r\n    if (linked.length) {\r\n      const updates = [];\r\n      for (const d of linked) {\r\n        const data = d._source;\r\n        let update = foundry.utils.deepClone(data);\r\n\r\n        DataTransform.apply(documentName, update, origin, transform);\r\n        update = foundry.utils.diffObject(data, update);\r\n\r\n        update._id = d.id;\r\n        updates.push(update);\r\n\r\n        // Check if the document has unprocessed links and if so chain the update\r\n        const dLinks = d.flags[MODULE_ID].links.filter(\r\n          (l) => !(l.type === LINK_TYPES.RECEIVE || processedLinks.has(l.id))\r\n        );\r\n        if (dLinks.length) {\r\n          dLinks.forEach((l) => processedLinks.add(l.id));\r\n          processLinks(transform, origin, dLinks, scene, docUpdates, processedLinks, d.id);\r\n        }\r\n      }\r\n\r\n      docUpdates.set(documentName, (docUpdates.get(documentName) ?? []).concat(updates));\r\n    }\r\n  });\r\n}\r\n\r\nclass PromiseQueue {\r\n  queue = Promise.resolve();\r\n\r\n  add(operation) {\r\n    this.queue = this.queue.then(operation).catch(() => {});\r\n  }\r\n}\r\n\r\nconst updateQueue = new PromiseQueue();\r\n\r\nfunction preUpdate(document, change, options, userId) {\r\n  if (game.user.id !== userId || options.ignoreLinks) return true;\r\n\r\n  // If the document does not contain links do nothing\r\n  let links = document.flags[MODULE_ID]?.links?.filter((l) => l.type !== LINK_TYPES.RECEIVE);\r\n  if (!links?.length) return true;\r\n\r\n  const positionUpdate =\r\n    change.hasOwnProperty('x') ||\r\n    change.hasOwnProperty('y') ||\r\n    change.hasOwnProperty('shapes') ||\r\n    change.hasOwnProperty('c') ||\r\n    change.hasOwnProperty('elevation');\r\n  const rotationUpdate = change.hasOwnProperty('rotation') || options.hasOwnProperty('meRotation');\r\n  if (!(positionUpdate || rotationUpdate)) return true;\r\n\r\n  // Special handling for walls.\r\n  // We do not want to perform linked placeable translation if only a single wall segment is moved.\r\n  if (change.c) {\r\n    if (\r\n      (change.c[0] === document.c[0] && change.c[1] === document.c[1]) ||\r\n      (change.c[2] === document.c[2] && change.c[3] === document.c[3])\r\n    ) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  // If control is held during a non-rotation update, we want to ignore links\r\n  if (game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)) {\r\n    return true;\r\n  }\r\n\r\n  // If an update occurred at the same time (likely same drag, or mass update) we need to check whether\r\n  // this update has unique links which need to be processed\r\n  const puLinks = PROCESSED_UPDATES.get(options.modifiedTime);\r\n  if (puLinks) {\r\n    links = links.filter((l) => !puLinks.some((l2) => l2.id === l.id));\r\n    if (!links.length) return false;\r\n    links.forEach((l) => puLinks.push(l));\r\n  } else {\r\n    PROCESSED_UPDATES.set(options.modifiedTime, links);\r\n    setTimeout(() => PROCESSED_UPDATES.delete(options.modifiedTime), 2000);\r\n    foundry.utils.setProperty(options, `links.${document.id}`, links);\r\n    foundry.utils.setProperty(options, `linkSources.${document.id}`, document.toObject());\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nasync function update(document, change, options, userId) {\r\n  if (!options.links?.[document.id] || options.ignoreLinks || game.user.id !== userId) return true;\r\n\r\n  const positionUpdate =\r\n    change.hasOwnProperty('x') ||\r\n    change.hasOwnProperty('y') ||\r\n    change.hasOwnProperty('shapes') ||\r\n    change.hasOwnProperty('c') ||\r\n    change.hasOwnProperty('elevation');\r\n  const rotationUpdate = change.hasOwnProperty('rotation') || options.hasOwnProperty('meRotation');\r\n  if (!(positionUpdate || rotationUpdate)) return true;\r\n\r\n  const previousSource = foundry.utils.deepClone(options.linkSources[document.id]);\r\n  foundry.utils.mergeObject(options.linkSources[document.id], change);\r\n\r\n  const scene = document.parent;\r\n  const { transform, origin } = calculateTransform(\r\n    document.documentName,\r\n    document.toObject(),\r\n    previousSource,\r\n    change,\r\n    options\r\n  );\r\n  const links = options.links[document.id];\r\n\r\n  updateQueue.add(async () => {\r\n    const docUpdates = new Map();\r\n    processLinks(transform, origin, links, scene, docUpdates, new Set(links.map((l) => l.id)), document.id);\r\n\r\n    for (const [documentName, updates] of docUpdates.entries()) {\r\n      const options = { ignoreLinks: true, animate: false };\r\n      if (documentName === 'Token') {\r\n        options.RidingMovement = true; // 'Auto-Rotate' module compatibility\r\n        options.forced = true; // Regions\r\n      }\r\n      //await scene.updateEmbeddedDocuments(documentName, updates, options);\r\n      await updateEmbeddedDocumentsViaGM(documentName, updates, options, scene);\r\n    }\r\n  });\r\n}\r\n\r\nfunction calculateTransform(documentName, currentSource, previousSource, change, options) {\r\n  let transform;\r\n\r\n  if (change.hasOwnProperty('shapes') || change.hasOwnProperty('c')) {\r\n    if (options.hasOwnProperty('meRotation')) {\r\n      transform = { x: 0, y: 0 };\r\n    } else {\r\n      const previousBounds = getDataBounds(documentName, previousSource);\r\n      const currentBounds = getDataBounds(documentName, currentSource);\r\n\r\n      transform = {\r\n        x: currentBounds.x1 - previousBounds.x1,\r\n        y: currentBounds.y1 - previousBounds.y1,\r\n      };\r\n    }\r\n  } else {\r\n    transform = {\r\n      x: currentSource.x - previousSource.x,\r\n      y: currentSource.y - previousSource.y,\r\n    };\r\n  }\r\n\r\n  const origin = { x: 0, y: 0 };\r\n\r\n  // Calculate rotation delta\r\n  let dRotation;\r\n  if (options.hasOwnProperty('meRotation')) dRotation = options.meRotation;\r\n  else if (currentSource.hasOwnProperty('rotation'))\r\n    dRotation = (currentSource.rotation - previousSource.rotation) % 360;\r\n\r\n  if (dRotation != null) {\r\n    transform.rotation = dRotation;\r\n\r\n    const { x1, y1, x2, y2 } = getDataBounds(documentName, previousSource);\r\n\r\n    origin.x = x1 + (x2 - x1) / 2;\r\n    origin.y = y1 + (y2 - y1) / 2;\r\n  }\r\n\r\n  if (currentSource.hasOwnProperty('elevation')) {\r\n    let dElevation;\r\n    if (Number.isNumeric(currentSource.elevation)) {\r\n      dElevation = currentSource.elevation - previousSource.elevation;\r\n    } else {\r\n      dElevation = (currentSource.elevation.bottom ?? 0) - (previousSource.elevation.bottom ?? 0);\r\n    }\r\n    if (dElevation != 0) transform.z = dElevation;\r\n  }\r\n\r\n  return { transform, origin };\r\n}\r\n\r\nexport class LinkerAPI {\r\n  /**\r\n   * Open Linker Menu window\r\n   * @returns\r\n   */\r\n  static async openMenu() {\r\n    const module = await import('./menu.js');\r\n    return module.openLinkerMenu();\r\n  }\r\n\r\n  static async smartLink({ multiLayer = false } = {}) {\r\n    let selected;\r\n    if (multiLayer) selected = await pickerSelectMultiLayerDocuments();\r\n    else selected = this._getSelected().map((p) => p.document);\r\n\r\n    if (!selected.length) return;\r\n\r\n    if (!this._smartLink) {\r\n      let link;\r\n      for (const d of selected) {\r\n        link = (this.getLinks(d) ?? []).find((l) => l.type === LINK_TYPES.TWO_WAY);\r\n        if (link) break;\r\n      }\r\n      if (!link) link = { id: foundry.utils.randomID(), type: LINK_TYPES.TWO_WAY, label: 'S_LINK' };\r\n      this._smartLink = link;\r\n\r\n      // Open menu window\r\n      const module = await import('./smartMenu.js');\r\n      module.openSmartLinkMenu(selected[0]);\r\n    }\r\n\r\n    const { id, type, label } = this._smartLink;\r\n    let numUpdates = 0;\r\n    for (const d of selected) {\r\n      if (await this.addLink(d, id, type, label)) numUpdates++;\r\n    }\r\n    if (numUpdates) {\r\n      ui.notifications.info(`Mass Edit: ${numUpdates} documents have been linked.`);\r\n    }\r\n  }\r\n\r\n  static getLinks(document) {\r\n    document = document.document ?? document;\r\n    return document.flags[MODULE_ID]?.links;\r\n  }\r\n\r\n  /**\r\n   * Retrieve all linked embedded documents\r\n   * @param {CanvasDocumentMixin|Array<CanvasDocumentMixin>} documents embedded document/s\r\n   * @returns {Set<CanvasDocumentMixin>}\r\n   */\r\n  static getLinkedDocuments(documents) {\r\n    if (!Array.isArray(documents)) documents = [documents];\r\n\r\n    const allLinked = new Set();\r\n    documents.forEach((document) => this._findLinked(document, allLinked));\r\n    documents.forEach((document) => allLinked.delete(document));\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Retrieve TWO_WAY and SEND linked embedded documents\r\n   * @param {Array<CanvasDocumentMixin>} documents\r\n   * @returns\r\n   */\r\n  static getHardLinkedDocuments(documents) {\r\n    if (!Array.isArray(documents)) documents = [documents];\r\n\r\n    const allLinked = new Set();\r\n    documents.forEach((document) => this._findHardLinked(document, allLinked));\r\n    documents.forEach((document) => allLinked.delete(document));\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the placeable has the provided linkId\r\n   * @param {Placeable} placeable\r\n   * @param {String} linkId\r\n   * @returns\r\n   */\r\n  static hasLink(placeable, linkId) {\r\n    const document = placeable.document ?? placeable;\r\n    return Boolean(document.flags[MODULE_ID]?.links?.find((l) => l.id === linkId));\r\n  }\r\n\r\n  /**\r\n   * Add a link to the provided placeable\r\n   * @param {Placeable} placeable\r\n   * @param {String} linkId\r\n   * @param {String} type LINK_TYPES\r\n   * @param {String} label hover text displayed within the Linker Menu\r\n   * @returns\r\n   */\r\n  static async addLink(placeable, linkId, type = LINK_TYPES.TWO_WAY, label = null) {\r\n    if (!Object.values(LINK_TYPES).includes(type)) throw Error(`Invalid link type: ${type}`);\r\n\r\n    const document = placeable.document ?? placeable;\r\n    const links = document.flags[MODULE_ID]?.links ?? [];\r\n\r\n    let link = links.find((l) => l.id === linkId);\r\n    if (!link) {\r\n      link = { id: linkId, type };\r\n      if (label) link.label = label;\r\n      links.push(link);\r\n    } else if (link.type !== type || (label && link.label !== label)) {\r\n      link.type = type;\r\n      if (label) link.label = label;\r\n    } else {\r\n      return false;\r\n    }\r\n\r\n    document.setFlag(MODULE_ID, 'links', links);\r\n    Hooks.call(`${MODULE_ID}.addLink`, document.documentName, document.id, linkId, type, label);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Remove link from the provided placeable\r\n   * @param {Placeable} placeable\r\n   * @param {String} linkId\r\n   */\r\n  static removeLink(placeable, linkId) {\r\n    const document = placeable.document ?? placeable;\r\n    let links = document.flags[MODULE_ID]?.links;\r\n    if (links) {\r\n      links = links.filter((l) => l.id !== linkId);\r\n      if (links.length) document.setFlag(MODULE_ID, 'links', links);\r\n      else document.unsetFlag(MODULE_ID, 'links');\r\n      Hooks.call(`${MODULE_ID}.removeLink`, document.id, linkId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all links from the given placeable/document\r\n   * @param {*} placeable\r\n   */\r\n  static removeLinks(placeable) {\r\n    const document = placeable.document ?? placeable;\r\n    if (document.flags[MODULE_ID]?.links) {\r\n      document.unsetFlag(MODULE_ID, 'links');\r\n      Hooks.call(`${MODULE_ID}.removeNode`, document.id);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Remove all links from selected placeables\r\n   */\r\n  static async removeLinksFromSelected({ multiLayer = false, notification = false } = {}) {\r\n    let selected;\r\n    if (multiLayer) selected = await pickerSelectMultiLayerDocuments();\r\n    else selected = LinkerAPI._getSelected();\r\n\r\n    let numRemoved = 0;\r\n    for (const s of selected) {\r\n      if (LinkerAPI.removeLinks(s)) numRemoved++;\r\n    }\r\n    if (notification && numRemoved) ui.notifications.info(`Mass Edit: Links removed from ${numRemoved} documents.`);\r\n\r\n    // Inform Smart Link menu of removed links\r\n    Object.values(ui.windows)\r\n      .find((w) => w.unlink)\r\n      ?.unlink(selected);\r\n  }\r\n\r\n  static history = [];\r\n\r\n  /**\r\n   * Delete selected placeable and all other placeables they are linked to\r\n   */\r\n  static deleteSelectedLinkedPlaceables() {\r\n    const selected = LinkerAPI._getSelected().map((s) => s.document);\r\n    if (!selected.length) return;\r\n    const linked = LinkerAPI.getHardLinkedDocuments(selected).filter((l) => !selected.find((s) => s.id === l.id));\r\n\r\n    // Delete linked\r\n    const toDelete = new Map();\r\n    linked.forEach((d) => {\r\n      if (!toDelete.get(d.documentName)) toDelete.set(d.documentName, [d.toObject()]);\r\n      else toDelete.get(d.documentName).push(d.toObject());\r\n    });\r\n\r\n    const scene = canvas.scene;\r\n    toDelete.forEach((data, documentName) => {\r\n      scene.deleteEmbeddedDocuments(\r\n        documentName,\r\n        data.map((d) => d._id),\r\n        { isUndo: true } // Hack to prevent history tracking\r\n      );\r\n    });\r\n\r\n    // Track history\r\n    LinkerAPI.history.push({ id: selected[0].id, data: toDelete });\r\n    if (LinkerAPI.history.length > 10) LinkerAPI.history.shift();\r\n\r\n    // Delete selected\r\n    scene.deleteEmbeddedDocuments(\r\n      selected[0].documentName,\r\n      selected.map((s) => s.id)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove all links on the current scene.\r\n   * @returns\r\n   */\r\n  static removeAllLinksOnCurrentScene() {\r\n    const scene = canvas.scene;\r\n    if (!scene) return;\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const updates = [];\r\n      scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        if (d.flags[MODULE_ID]?.links) {\r\n          updates.push({ _id: d.id, [`flags.${MODULE_ID}.-=links`]: null });\r\n        }\r\n      });\r\n      if (updates.length) scene.updateEmbeddedDocuments(documentName, updates);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update linkId on the current scene with the provided label\r\n   * @param {String} linkId\r\n   * @param {String} label\r\n   * @returns\r\n   */\r\n  static updateLinkLabelOnCurrentScene(linkId, label) {\r\n    if (!linkId) return;\r\n\r\n    const scene = canvas.scene;\r\n    if (!scene) return;\r\n\r\n    let updated = false;\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const updates = [];\r\n      scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        const link = d.flags[MODULE_ID]?.links?.find((l) => l.id === linkId);\r\n        if (link && link.label != label) {\r\n          if (!label) delete link.label;\r\n          else link.label = label;\r\n\r\n          updates.push({ _id: d.id, [`flags.${MODULE_ID}.links`]: d.flags[MODULE_ID]?.links });\r\n        }\r\n      });\r\n      if (updates.length) {\r\n        scene.updateEmbeddedDocuments(documentName, updates);\r\n        updated = true;\r\n      }\r\n    });\r\n\r\n    if (updated) {\r\n      Hooks.call(`${MODULE_ID}.linkLabelChange`, linkId, label);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a link from all placeables on the current scene\r\n   * @param {String} linkId\r\n   * @returns\r\n   */\r\n  static removeLinkFromScene(linkId) {\r\n    const scene = canvas.scene;\r\n    if (!scene || !linkId) return;\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const updates = [];\r\n      scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        let links = d.flags[MODULE_ID]?.links;\r\n        if (links) {\r\n          let fLinks = links.filter((l) => l.id !== linkId);\r\n          if (fLinks.length !== links.length) {\r\n            updates.push({ _id: d.id, [`flags.${MODULE_ID}.links`]: fLinks });\r\n          }\r\n        }\r\n      });\r\n      if (updates.length) scene.updateEmbeddedDocuments(documentName, updates);\r\n    });\r\n\r\n    Hooks.call(`${MODULE_ID}.removeNode`, linkId);\r\n  }\r\n\r\n  /**\r\n   * Private Utils\r\n   */\r\n\r\n  /**\r\n   * Returns all selected placeables\r\n   * @returns\r\n   */\r\n  static _getSelected() {\r\n    const activeLayer = canvas.activeLayer;\r\n    if (!SUPPORTED_PLACEABLES.includes(activeLayer.options.objectClass.embeddedName)) return [];\r\n    return [...canvas.activeLayer.controlled];\r\n  }\r\n\r\n  /**\r\n   * Returns all documents on the current scene matching the provided linkId and type\r\n   * @param {String} linkId\r\n   * @param {LINK_TYPES|null} type\r\n   * @returns\r\n   */\r\n  static _getLinkedDocumentsUsingLink(linkId, type = null) {\r\n    if (type != null && !Object.values(LINK_TYPES).includes(type)) throw Error(`Invalid link type: ${type}`);\r\n    const allLinked = new Set();\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      canvas.scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        if (d.flags[MODULE_ID]?.links?.some((l) => l.id === linkId && (type == null || l.type === type))) {\r\n          allLinked.add(d);\r\n        }\r\n      });\r\n    });\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Utility for LinkerAPI.getLinkedDocuments\r\n   * @param {*} document\r\n   * @param {*} allLinked\r\n   * @param {*} processedLinks\r\n   * @returns\r\n   */\r\n  static _findLinked(document, allLinked, processedLinks = new Set()) {\r\n    allLinked.add(document);\r\n\r\n    const links = document.flags[MODULE_ID]?.links?.filter((l) => !processedLinks.has(l.id)).map((l) => l.id);\r\n    if (!links?.length) return allLinked;\r\n\r\n    links.forEach((l) => processedLinks.add(l));\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const linked = canvas.scene\r\n        .getEmbeddedCollection(documentName)\r\n        .filter((t) => t.flags[MODULE_ID]?.links?.some((l1) => links.find((l2) => l2 === l1.id)));\r\n\r\n      for (const d of linked) {\r\n        this._findLinked(d, allLinked, processedLinks);\r\n      }\r\n    });\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Utility for LinkerAPI.getHardLinkedDocuments\r\n   * @param {*} document\r\n   * @param {*} allLinked\r\n   * @param {*} processedLinks\r\n   * @returns\r\n   */\r\n  static _findHardLinked(document, allLinked, processedLinks = new Set()) {\r\n    allLinked.add(document);\r\n\r\n    const links = document.flags[MODULE_ID]?.links\r\n      ?.filter((l) => l.type !== LINK_TYPES.RECEIVE && !processedLinks.has(l.id))\r\n      .map((l) => l.id);\r\n    if (!links?.length) return allLinked;\r\n\r\n    links.forEach((l) => processedLinks.add(l));\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const linked = canvas.scene\r\n        .getEmbeddedCollection(documentName)\r\n        .filter((t) =>\r\n          t.flags[MODULE_ID]?.links?.some((l1) => links.find((l2) => l2 === l1.id && l1.type !== LINK_TYPES.SEND))\r\n        );\r\n\r\n      for (const d of linked) {\r\n        this._findHardLinked(d, allLinked, processedLinks);\r\n      }\r\n    });\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  static _highlightDocuments(docs) {\r\n    const dg = canvas.controls.debug;\r\n    dg.clear();\r\n\r\n    const width = 8;\r\n    const alpha = 1;\r\n    docs.forEach((d) => {\r\n      let bounds = d.object.bounds;\r\n\r\n      dg.lineStyle(width + 2, 0, alpha, 0.5);\r\n      dg.drawRect(bounds.x, bounds.y, bounds.width, bounds.height);\r\n\r\n      dg.lineStyle(width, 0x00ff00, alpha, 0.5);\r\n      dg.drawRect(bounds.x, bounds.y, bounds.width, bounds.height);\r\n    });\r\n  }\r\n\r\n  static _clearHighlight() {\r\n    canvas.controls.debug.clear();\r\n  }\r\n}\r\n","/**\r\n * Mouse controls for Levels 3D\r\n */\r\n\r\nimport { BrushMenu } from './brush';\r\nimport { Picker } from './picker';\r\n\r\nexport class Mouse3D {\r\n  // Trick to keep consistent signatures for bound 3d listeners\r\n  // Required to be able to remove these function once picker is de-activated\r\n  static {\r\n    this._boundOn3DMouseDown = this._on3DMouseDown.bind(this);\r\n    this._boundOn3dMouseMove = this._on3dMouseMove.bind(this);\r\n    this._boundOn3dMouseWheel = this._on3dMouseWheel.bind(this);\r\n  }\r\n\r\n  static activate({ mouseMoveCallback = null, mouseClickCallback = null, mouseWheelClickCallback = null } = {}) {\r\n    this.mouseMoveCallback = mouseMoveCallback;\r\n    this.mouseClickCallback = mouseClickCallback;\r\n    this.mouseWheelClickCallback = mouseWheelClickCallback;\r\n\r\n    this._createTracker();\r\n    this._activate3DListeners();\r\n  }\r\n\r\n  static deactivate() {\r\n    if (this.tracker && game.Levels3DPreview?._active) {\r\n      game.Levels3DPreview.scene.remove(this.tracker);\r\n      this.tracker = null;\r\n      this.deactivate3DListeners();\r\n    }\r\n  }\r\n\r\n  static _createTracker() {\r\n    if (!this.tracker) {\r\n      const THREE = game.Levels3DPreview.THREE;\r\n\r\n      this.tracker = new THREE.Mesh(\r\n        new THREE.SphereGeometry(0.01, 8, 8),\r\n        new THREE.MeshBasicMaterial({\r\n          opacity: 0.5,\r\n          transparent: true,\r\n          color: 0x00ff00,\r\n          wireframe: true,\r\n        })\r\n      );\r\n\r\n      this.tracker.userData.interactive = false;\r\n      this.tracker.userData.ignoreHover = true;\r\n\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      this.tracker.position.set(mPos.x, mPos.y, mPos.z);\r\n\r\n      game.Levels3DPreview.scene.add(this.tracker);\r\n    }\r\n  }\r\n\r\n  static _activate3DListeners() {\r\n    // Remove listeners if they are already set\r\n    this.deactivate3DListeners();\r\n\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('mousedown', this._boundOn3DMouseDown, false);\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('wheel', this._boundOn3dMouseWheel, true);\r\n  }\r\n\r\n  static deactivate3DListeners() {\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('mousedown', this._boundOn3DMouseDown, false);\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('wheel', this._boundOn3dMouseWheel, true);\r\n  }\r\n\r\n  static _on3DMouseDown(event) {\r\n    if (event.which === 1) {\r\n      const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.tracker.position);\r\n      const p = game.Levels3DPreview.interactionManager.currentHover?.placeable;\r\n      this.mouseClickCallback?.({ x: posVec.x, y: posVec.y, z: posVec.z, placeable: p });\r\n      //game.Levels3DPreview.interactionManager._downCameraPosition.set(0, 0, 0);\r\n    } else if (event.which === 2) {\r\n      this.mouseWheelClickCallback?.();\r\n    }\r\n  }\r\n\r\n  static _on3dMouseMove() {\r\n    if (this.delayMoveTimer) return;\r\n\r\n    this.delayMoveTimer = setTimeout(function () {\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      const cPos = game.Levels3DPreview.interactionManager.camera.position;\r\n\r\n      const intersects = game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(\r\n        cPos,\r\n        mPos,\r\n        'collision',\r\n        false,\r\n        false,\r\n        false,\r\n        true\r\n      );\r\n\r\n      if (intersects[0]) {\r\n        const intersect = intersects[0];\r\n        Mouse3D.tracker?.position.set(intersect.point.x, intersect.point.y, intersect.point.z);\r\n        const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(intersect.point);\r\n\r\n        Mouse3D.mouseMoveCallback?.({ x: posVec.x, y: posVec.y, z: posVec.z });\r\n      }\r\n      Mouse3D.delayMoveTimer = null;\r\n    }, 100);\r\n  }\r\n\r\n  static _on3dMouseWheel(event) {\r\n    //console.log(event);\r\n\r\n    if (\r\n      (Picker.isActive() || BrushMenu.isActive()) &&\r\n      (event.ctrlKey || event.shiftKey || event.metaKey || event.altKey)\r\n    ) {\r\n      event.stopPropagation();\r\n      event.preventDefault();\r\n\r\n      let dy = (event.delta = event.deltaY);\r\n      if (event.shiftKey && dy === 0) {\r\n        dy = event.delta = event.deltaX;\r\n      }\r\n      if (dy === 0) return;\r\n\r\n      // console.log(event.altKey, event.ctrlKey, event.shiftKey, event.delta);\r\n\r\n      if (event.altKey) Picker.addScaling(event.delta < 0 ? 0.05 : -0.05);\r\n      else if ((event.ctrlKey || event.metaKey) && event.shiftKey) BrushMenu.iterate(event.delta >= 0, true);\r\n      else if (event.ctrlKey || event.metaKey) Picker.addRotation(event.delta < 0 ? 2.5 : -2.5);\r\n      else if (event.shiftKey) Picker.addRotation(event.delta < 0 ? 15 : -15);\r\n      return;\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { SUPPORTED_PLACEABLES } from './constants.js';\r\nimport { LinkerAPI } from './linker/linker.js';\r\nimport { Mouse3D } from './mouse3d.js';\r\nimport { getDataBounds, getPresetDataCenterOffset } from './presets/utils.js';\r\nimport { pickerSelectMultiLayerDocuments } from './utils.js';\r\n\r\n/**\r\n * Cross-hair and optional preview image/label that can be activated to allow the user to select\r\n * an area on the screen.\r\n */\r\nexport class Picker {\r\n  static pickerOverlay;\r\n  static boundStart;\r\n  static boundEnd;\r\n  static callback;\r\n  static _transformAccumulator = { rotation: 0, scale: 1 };\r\n\r\n  static isActive() {\r\n    return Boolean(this.pickerOverlay);\r\n  }\r\n\r\n  static addRotation(rotation) {\r\n    this._rotation += rotation;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n    this._transformAccumulator.rotation += rotation;\r\n  }\r\n\r\n  static addScaling(scale) {\r\n    this._scale += scale;\r\n    this._transformAccumulator.scale *= this._scale;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static resetTransformAccumulator() {\r\n    this._transformAccumulator.rotation = 0;\r\n    this._transformAccumulator.scale = 1;\r\n  }\r\n\r\n  static getTransformAccumulator() {\r\n    return foundry.utils.deepClone(this._transformAccumulator);\r\n  }\r\n\r\n  static mirrorX() {\r\n    this._mirrorX = true;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static mirrorY() {\r\n    this._mirrorY = true;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  /**\r\n   * Activates the picker overlay.\r\n   * @param {Function} callback callback function with coordinates returned as starting and ending bounds of a rectangles\r\n   *                            { start: {x1, y1}, end: {x2, y2} }\r\n   * @param {Object}  preview\r\n   * @param {String}  preview.documentName (optional) preview placeables document name\r\n   * @param {Map[String,Array]}  preview.previewData    (req) preview placeables data\r\n   * @param {String}  preview.taPreview            (optional) Designates the preview placeable when spawning a `Token Attacher` prefab.\r\n   *                                                e.g. \"Tile\", \"Tile.1\", \"MeasuredTemplate.3\"\r\n   * @param {Boolean} preview.snap                  (optional) if true returned coordinates will be snapped to grid\r\n   * @param {String}  preview.label                  (optional) preview placeables document name\r\n   */\r\n  static async activate(callback, preview) {\r\n    this.destroy();\r\n\r\n    const pickerOverlay = new PIXI.Container();\r\n    this.callback = callback;\r\n\r\n    if (preview) {\r\n      let label;\r\n      if (preview.label) {\r\n        label = new PreciseText(preview.label, { ...CONFIG.canvasTextStyle, _fontSize: 24 });\r\n        label.anchor.set(0.5, 1);\r\n        pickerOverlay.addChild(label);\r\n      }\r\n\r\n      let { previews, layer, previewDocuments } = await this._genPreviews(preview);\r\n      this._rotation = preview.rotation ?? 0;\r\n      this._scale = preview.scale ?? 1;\r\n      this._mirrorX = false;\r\n      this._mirrorY = false;\r\n\r\n      const centerOnCursor = () => {\r\n        return preview.center && !(layer.name === 'TokenLayer' && preview.previewData.size === 1);\r\n      };\r\n\r\n      // Position offset to center preview over the mouse\r\n      let offset;\r\n      if (centerOnCursor()) offset = getPresetDataCenterOffset(preview.previewData);\r\n      else offset = { x: 0, y: 0, z: 0 };\r\n\r\n      if (!game.Levels3DPreview?._active) delete offset.z; // We don't want to perform z axis transform if not on 3D canvas\r\n\r\n      const setPositions = function (pos) {\r\n        if (!pos) return;\r\n        if (centerOnCursor()) offset = getPresetDataCenterOffset(preview.previewData);\r\n        if (preview.snap && layer && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)) {\r\n          const snapped = layer.getSnappedPoint(pos);\r\n          snapped.z = pos.z;\r\n          pos = snapped;\r\n        }\r\n\r\n        // calculate transform\r\n        const pd = previews[0].document;\r\n        const b = getDataBounds(pd.documentName, pd);\r\n        let transform = { x: pos.x - b.x1 - offset.x, y: pos.y - b.y1 - offset.y };\r\n        if (pos.z != null) transform.z = pos.z - b.z1 - offset.z;\r\n\r\n        // Instant transforms\r\n        if (Picker._rotation != 0) {\r\n          transform.rotation = Picker._rotation;\r\n          Picker._rotation = 0;\r\n        }\r\n        if (Picker._scale != 1) {\r\n          transform.scale = Picker._scale;\r\n          Picker._scale = 1;\r\n        }\r\n\r\n        transform.mirrorX = Picker._mirrorX;\r\n        Picker._mirrorX = false;\r\n\r\n        transform.mirrorY = Picker._mirrorY;\r\n        Picker._mirrorY = false;\r\n\r\n        for (const preview of previews) {\r\n          const doc = preview.document;\r\n          const documentName = doc.documentName;\r\n          DataTransform.apply(documentName, preview._pData ?? doc, pos, transform, preview);\r\n\r\n          // =====\r\n          // Hacks\r\n          // =====\r\n          preview.renderFlags.set({ refresh: true });\r\n\r\n          // TODO: improve _meSort, _meElevation\r\n          // Elevation, sort, and z order hacks to make sure previews are always rendered on-top\r\n          if (doc.sort != null) {\r\n            if (!preview._meSort) preview._meSort = doc.sort;\r\n            doc.sort = preview._meSort + 10000;\r\n          }\r\n\r\n          if (!game.Levels3DPreview?._active && doc.elevation != null) {\r\n            if (!preview._meElevation) preview._meElevation = doc.elevation;\r\n            doc.elevation = preview._meElevation + 10000;\r\n          }\r\n\r\n          // For some reason collision bool is refreshed after creation of the preview\r\n          if (preview._l3dPreview) preview._l3dPreview.collision = false;\r\n\r\n          // Special position update conditions\r\n          // - Region: We need to simulate doc update via `_onUpdate` call\r\n          // - AmbientLight and AmbientSound sources need to be re-initialized to have their fields properly rendered\r\n          if (documentName === 'Region') {\r\n            preview._onUpdate({ shapes: null });\r\n          } else if (documentName === 'AmbientLight') {\r\n            preview.initializeLightSource();\r\n          } else if (documentName === 'AmbientSound') {\r\n            preview.initializeSoundSource();\r\n          }\r\n\r\n          // End of Hacks\r\n        }\r\n\r\n        if (label) {\r\n          label.x = pos.x;\r\n          label.y = pos.y - 38;\r\n        }\r\n\r\n        pickerOverlay.previewDocuments = previewDocuments;\r\n\r\n        // Changing scaling offsets the center position\r\n        // Let's immediately reposition back to it\r\n        if (preview.center && transform.scale != null) {\r\n          setPositions(pos);\r\n        }\r\n      };\r\n\r\n      let lastX = Infinity;\r\n      let lastY = Infinity;\r\n      pickerOverlay.on('pointermove', (event) => {\r\n        const client = event.data.client;\r\n        if (client.x !== lastX || client.y !== lastY) {\r\n          lastX = client.x;\r\n          lastY = client.y;\r\n          setPositions(event.data.getLocalPosition(pickerOverlay));\r\n        }\r\n      });\r\n\r\n      //setTimeout(() => setPositions(canvas.mousePosition), 50);\r\n      pickerOverlay.setPositions = setPositions;\r\n    }\r\n\r\n    if (!preview?.previewOnly) {\r\n      if (game.Levels3DPreview?._active) {\r\n        Mouse3D.activate({\r\n          mouseMoveCallback: Picker.feedPos.bind(Picker),\r\n          mouseClickCallback: Picker.resolve.bind(Picker),\r\n          mouseWheelClickCallback: Picker.destroy.bind(Picker),\r\n        });\r\n      } else {\r\n        pickerOverlay.hitArea = canvas.dimensions.rect;\r\n        pickerOverlay.cursor = 'crosshair';\r\n        pickerOverlay.interactive = true;\r\n        pickerOverlay.zIndex = 5;\r\n        pickerOverlay.on('remove', () => pickerOverlay.off('pick'));\r\n        pickerOverlay.on('mousedown', (event) => {\r\n          Picker.boundStart = event.data.getLocalPosition(pickerOverlay);\r\n        });\r\n        pickerOverlay.on('mouseup', (event) => {\r\n          Picker.boundEnd = event.data.getLocalPosition(pickerOverlay);\r\n        });\r\n        pickerOverlay.on('click', (event) => {\r\n          if (event.nativeEvent.which == 2) {\r\n            this.callback?.(null);\r\n          } else {\r\n            const minX = Math.min(this.boundStart.x, this.boundEnd.x);\r\n            const maxX = Math.max(this.boundStart.x, this.boundEnd.x);\r\n            const minY = Math.min(this.boundStart.y, this.boundEnd.y);\r\n            const maxY = Math.max(this.boundStart.y, this.boundEnd.y);\r\n            this.callback?.({ start: { x: minX, y: minY }, end: { x: maxX, y: maxY } });\r\n          }\r\n          this.destroy();\r\n        });\r\n\r\n        canvas.stage.addChild(pickerOverlay);\r\n      }\r\n    }\r\n    this.pickerOverlay = pickerOverlay;\r\n    setTimeout(() => this.feedPos(canvas.mousePosition), 100);\r\n  }\r\n\r\n  static feedPos(pos) {\r\n    this.pickerOverlay?.setPositions?.(pos);\r\n  }\r\n\r\n  static resolve(pos) {\r\n    if (this.callback) {\r\n      if (pos == null) this.callback(null);\r\n      else this.callback?.({ start: { x: pos.x, y: pos.y, z: pos.z }, end: { x: pos.x, y: pos.y, z: pos.z } });\r\n    }\r\n    this.destroy();\r\n  }\r\n\r\n  static destroy() {\r\n    if (this.pickerOverlay) {\r\n      this.pickerOverlay.parent?.removeChild(this.pickerOverlay);\r\n      if (this.pickerOverlay.previewDocuments) {\r\n        this.pickerOverlay.previewDocuments.forEach((name) => {\r\n          const layer = canvas.getLayerByEmbeddedName(name);\r\n          if (layer) {\r\n            if (game.Levels3DPreview?._active) {\r\n              layer.preview.children.forEach((c) => {\r\n                c._l3dPreview?.destroy();\r\n              });\r\n            }\r\n            layer.clearPreviewContainer();\r\n          }\r\n        });\r\n      }\r\n\r\n      this.pickerOverlay.destroy(true);\r\n      this.pickerOverlay.children?.forEach((c) => c.destroy(true));\r\n      this.callback?.(null);\r\n      this.pickerOverlay = null;\r\n      Mouse3D.deactivate();\r\n    }\r\n    this.callback = null;\r\n  }\r\n\r\n  // Modified Foundry _createPreview\r\n  // Does not throw warning if user lacks document create permissions\r\n  static async _createPreview(createData) {\r\n    const documentName = this.constructor.documentName;\r\n    const cls = getDocumentClass(documentName);\r\n    createData._id = foundry.utils.randomID(); // Needed to allow rendering of multiple previews at the same time\r\n    const document = new cls(createData, { parent: canvas.scene });\r\n\r\n    const object = new CONFIG[documentName].objectClass(document);\r\n    document._object = object;\r\n    object.eventMode = 'none';\r\n    object.document.alpha = 0.4;\r\n    if (object.document.occlusion) object.document.occlusion.alpha = 0.4;\r\n    this.preview.addChild(object);\r\n    await object.draw();\r\n\r\n    // Since we do elevation manipulation to force previews to be rendered on top\r\n    // we don't want the user to see these temporary values\r\n    if (object.tooltip) object.tooltip.renderable = false;\r\n    if (object.controlIcon?.tooltip) object.controlIcon.tooltip.renderable = false;\r\n\r\n    // Foundry as well as various modules might have complex `isVisible` and 'visible' conditions\r\n    // lets simplify by overriding this function to make sure the preview is always visible\r\n    Picker._overridePlaceableVisibility(object);\r\n\r\n    // 3D Canvas\r\n    if (game.Levels3DPreview?._active) {\r\n      if (documentName === 'Tile') {\r\n        game.Levels3DPreview.createTile(object);\r\n        const l3dPreview = game.Levels3DPreview.tiles[object.id];\r\n\r\n        l3dPreview.castShadow = false;\r\n        l3dPreview.collision = false;\r\n\r\n        object._l3dPreview = l3dPreview;\r\n      } else if (documentName === 'Token') {\r\n        // Tokens get async loaded without a way to await them\r\n        // We'll need to retrieve the 3D token when the transforms are actually getting applied\r\n        game.Levels3DPreview.addToken(object);\r\n        object._l3dPreview = null;\r\n      } else if (documentName === 'AmbientLight') {\r\n        game.Levels3DPreview.addLight(object);\r\n        const l3dPreview = game.Levels3DPreview.lights[object.id];\r\n        object._l3dPreview = l3dPreview;\r\n      }\r\n    }\r\n\r\n    return object;\r\n  }\r\n\r\n  static _overridePlaceableVisibility(placeable) {\r\n    Object.defineProperty(placeable, 'isVisible', {\r\n      get: function () {\r\n        return true;\r\n      },\r\n      set: function () {},\r\n    });\r\n    Object.defineProperty(placeable, 'visible', {\r\n      get: function () {\r\n        return true;\r\n      },\r\n      set: function () {},\r\n    });\r\n    if (placeable.controlIcon) {\r\n      placeable.controlIcon.alpha = 0.4;\r\n      Object.defineProperty(placeable.controlIcon, 'visible', {\r\n        get: function () {\r\n          return true;\r\n        },\r\n        set: function () {},\r\n      });\r\n    }\r\n  }\r\n\r\n  static async _genPreviews(preview) {\r\n    if (!preview.previewData) return { previews: [] };\r\n\r\n    const transform = {};\r\n    const toCreate = [];\r\n    for (const [documentName, dataArr] of preview.previewData.entries()) {\r\n      for (const data of dataArr) {\r\n        // Set initial transform which will set first preview to (0, 0) and all others relative to it\r\n        if (transform.x == null) {\r\n          if (documentName === 'Wall') {\r\n            transform.x = -data.c?.[0] ?? 0;\r\n            transform.y = -data.c?.[1] ?? 0;\r\n          } else if (documentName === 'Region') {\r\n            const shape = data.shapes[0];\r\n            transform.x = -(shape?.x ?? shape.points?.[0] ?? 0);\r\n            transform.y = -(shape?.y ?? shape.points?.[1] ?? 0);\r\n          } else {\r\n            transform.x = -data.x ?? 0;\r\n            transform.y = -data.y ?? 0;\r\n          }\r\n        }\r\n\r\n        toCreate.push({ documentName, data });\r\n\r\n        if (preview.taPreview && documentName === 'Token') {\r\n          this._genTAPreviews(data, preview.taPreview, data, toCreate);\r\n        }\r\n      }\r\n    }\r\n\r\n    const previewDocuments = new Set();\r\n    const previews = [];\r\n    for (const { documentName, data } of toCreate) {\r\n      DataTransform.apply(documentName, data, { x: 0, y: 0 }, transform);\r\n      const p = await this._createPreview.call(\r\n        canvas.getLayerByEmbeddedName(documentName),\r\n        foundry.utils.deepClone(data)\r\n      );\r\n      p._pData = data;\r\n      previews.push(p);\r\n      previewDocuments.add(documentName);\r\n    }\r\n    return { previews, layer: canvas.getLayerByEmbeddedName(preview.documentName), previewDocuments };\r\n  }\r\n\r\n  static _genTAPreviews(data, taPreview, parent, toCreate) {\r\n    if (!game.modules.get('token-attacher')?.active) return;\r\n\r\n    const attached = foundry.utils.getProperty(data, 'flags.token-attacher.prototypeAttached');\r\n    const pos = foundry.utils.getProperty(data, 'flags.token-attacher.pos');\r\n    const grid = foundry.utils.getProperty(data, 'flags.token-attacher.grid');\r\n\r\n    if (!(attached && pos && grid)) return;\r\n\r\n    const ratio = canvas.grid.size / grid.size;\r\n    const attachedData = this._parseTAPreview(taPreview, attached);\r\n\r\n    for (const [name, dataList] of Object.entries(attachedData)) {\r\n      for (let data of dataList) {\r\n        if (['Token', 'Tile', 'Drawing'].includes(name)) {\r\n          data.width *= ratio;\r\n          data.height *= ratio;\r\n        }\r\n\r\n        if (name === 'Wall') {\r\n          data.c[0] = parent.x + (data.c[0] - pos.xy.x) * ratio;\r\n          data.c[1] = parent.y + (data.c[1] - pos.xy.y) * ratio;\r\n          data.c[2] = parent.x + (data.c[2] - pos.xy.x) * ratio;\r\n          data.c[3] = parent.y + (data.c[3] - pos.xy.y) * ratio;\r\n        } else if (name === 'Region') {\r\n          data.shapes?.forEach((shape) => {\r\n            if (shape.type === 'polygon') {\r\n              for (let i = 0; i < shape.points.length; i += 2) {\r\n                shape.points[i] = parent.x + (shape.points[i] - pos.xy.x) * ratio;\r\n                shape.points[i + 1] = parent.y + (shape.points[i + 1] - pos.xy.y) * ratio;\r\n              }\r\n            } else {\r\n              shape.x = parent.x + (shape.x - pos.xy.x) * ratio;\r\n              shape.y = parent.y + (shape.y - pos.xy.y) * ratio;\r\n              if (shape.type === 'ellipse') {\r\n                shape.radiusX *= ratio;\r\n                shape.radiusY *= ratio;\r\n              } else if (shape.type === 'rectangle') {\r\n                shape.width *= ratio;\r\n                shape.height *= ratio;\r\n              }\r\n            }\r\n          });\r\n        } else {\r\n          data.x = parent.x + (data.x - pos.xy.x) * ratio;\r\n          data.y = parent.y + (data.y - pos.xy.y) * ratio;\r\n        }\r\n\r\n        toCreate.push({ documentName: name, data });\r\n      }\r\n    }\r\n  }\r\n\r\n  static _parseTAPreview(taPreview, attached) {\r\n    if (taPreview === 'ALL') return attached;\r\n\r\n    const attachedData = {};\r\n    taPreview = taPreview.split(',');\r\n\r\n    for (const taIndex of taPreview) {\r\n      let [name, index] = taIndex.trim().split('.');\r\n      if (!attached[name]) continue;\r\n\r\n      if (index == null) {\r\n        attachedData[name] = attached[name];\r\n      } else {\r\n        if (attached[name][index]) {\r\n          if (!attachedData[name]) attachedData[name] = [];\r\n          attachedData[name].push(attached[name][index]);\r\n        }\r\n      }\r\n    }\r\n\r\n    return attachedData;\r\n  }\r\n}\r\n\r\nexport class DataTransform {\r\n  /**\r\n   * Transform placeable data and optionally an accompanying preview with the provided delta transform\r\n   * @param {String} documentName\r\n   * @param {Object} data\r\n   * @param {Object} origin\r\n   * @param {Object} transform\r\n   * @param {PlaceableObject} preview\r\n   */\r\n  static apply(documentName, data, origin, transform, preview) {\r\n    if (transform.x == null) transform.x = 0;\r\n    if (transform.y == null) transform.y = 0;\r\n\r\n    if (documentName === 'Wall') {\r\n      this.transformWall(data, origin, transform, preview);\r\n    } else if (documentName === 'Tile') {\r\n      this.transformTile(data, origin, transform, preview);\r\n    } else if (documentName == 'Note') {\r\n      this.transformNote(data, origin, transform, preview);\r\n    } else if (documentName === 'Token') {\r\n      this.transformToken(data, origin, transform, preview);\r\n    } else if (documentName === 'MeasuredTemplate') {\r\n      this.transformMeasuredTemplate(data, origin, transform, preview);\r\n    } else if (documentName === 'AmbientLight') {\r\n      this.transformAmbientLight(data, origin, transform, preview);\r\n    } else if (documentName === 'AmbientSound') {\r\n      this.transformAmbientSound(data, origin, transform, preview);\r\n    } else if (documentName === 'Drawing') {\r\n      this.transformDrawing(data, origin, transform, preview);\r\n    } else if (documentName === 'Region') {\r\n      this.transformRegion(data, origin, transform, preview);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  static transformRegion(data, origin, transform, preview) {\r\n    if (transform.scale != null && data.shapes) {\r\n      const scale = transform.scale;\r\n\r\n      for (const shape of data.shapes) {\r\n        if (shape.type === 'polygon') {\r\n          for (let i = 0; i < shape.points.length; i++) {\r\n            shape.points[i] *= scale;\r\n          }\r\n        } else {\r\n          shape.x *= scale;\r\n          shape.y *= scale;\r\n          if (shape.type === 'ellipse') {\r\n            shape.radiusX *= scale;\r\n            shape.radiusY *= scale;\r\n          } else if (shape.type === 'rectangle') {\r\n            shape.height *= scale;\r\n            shape.width *= scale;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (data.shapes) {\r\n      data.shapes.forEach((shape) => {\r\n        if (shape.type === 'polygon') {\r\n          for (let i = 0; i < shape.points.length; i += 2) {\r\n            try {\r\n              shape.points[i] += transform.x;\r\n              shape.points[i + 1] += transform.y;\r\n            } catch (e) {\r\n              console.log(shape, transform);\r\n            }\r\n          }\r\n        } else {\r\n          shape.x += transform.x;\r\n          shape.y += transform.y;\r\n        }\r\n      });\r\n    }\r\n    if (transform.z) {\r\n      if (Number.isNumeric(data.elevation?.bottom)) data.elevation.bottom += transform.z;\r\n      if (Number.isNumeric(data.elevation?.top)) data.elevation.top += transform.z;\r\n    }\r\n\r\n    if (transform.rotation != null && data.shapes) {\r\n      for (const shape of data.shapes) {\r\n        if (shape.type === 'rectangle') {\r\n          // Foundry does not support rotation for rectangles\r\n          // Convert it to a polygon instead\r\n          shape.type = 'polygon';\r\n          shape.points = [\r\n            shape.x,\r\n            shape.y,\r\n            shape.x + shape.width,\r\n            shape.y,\r\n            shape.x + shape.width,\r\n            shape.y + shape.height,\r\n            shape.x,\r\n            shape.y + shape.height,\r\n          ];\r\n          delete shape.width;\r\n          delete shape.height;\r\n          delete shape.x;\r\n          delete shape.y;\r\n          delete shape.rotation;\r\n        }\r\n        if (shape.type === 'polygon') {\r\n          const dr = Math.toRadians(transform.rotation % 360);\r\n          for (let i = 0; i < shape.points.length; i += 2) {\r\n            [shape.points[i], shape.points[i + 1]] = this.rotatePoint(\r\n              origin.x,\r\n              origin.y,\r\n              shape.points[i],\r\n              shape.points[i + 1],\r\n              dr\r\n            );\r\n          }\r\n        } else {\r\n          const dr = Math.toRadians(transform.rotation % 360);\r\n          let rectCenter = {\r\n            x: shape.x + (shape.radiusX ?? shape.width) / 2,\r\n            y: shape.y + (shape.radiusY ?? shape.height) / 2,\r\n          };\r\n          [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n          shape.x = rectCenter.x - (shape.radiusX ?? shape.width) / 2;\r\n          shape.y = rectCenter.y - (shape.radiusY ?? shape.height) / 2;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      for (const shape of data.shapes) {\r\n        if (shape.type === 'rectangle' || shape.type === 'ellipse') {\r\n          const rectCenter = {\r\n            x: shape.x + (shape.width ?? shape.radiusX) / 2,\r\n            y: shape.y + (shape.height ?? shape.radiusY) / 2,\r\n          };\r\n          if (transform.mirrorX) {\r\n            rectCenter.x = origin.x - (rectCenter.x - origin.x);\r\n            shape.x = rectCenter.x - (shape.width ?? shape.radiusX) / 2;\r\n          }\r\n          if (transform.mirrorY) {\r\n            rectCenter.y = origin.y - (rectCenter.y - origin.y);\r\n            shape.y = rectCenter.y - (shape.height ?? shape.radiusY) / 2;\r\n          }\r\n        } else if (shape.type === 'polygon') {\r\n          if (transform.mirrorX) {\r\n            for (let i = 0; i < shape.points.length; i += 2) {\r\n              shape.points[i] = origin.x - (shape.points[i] - origin.x);\r\n            }\r\n          }\r\n          if (transform.mirrorY) {\r\n            for (let i = 1; i < shape.points.length; i += 2) {\r\n              shape.points[i] = origin.y - (shape.points[i] - origin.y);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n      if (data.shapes) {\r\n        for (let i = 0; i < data.shapes.length; i++) {\r\n          const docShape = doc.shapes[i];\r\n          const dataShape = data.shapes[i];\r\n\r\n          if (docShape.type !== dataShape.type) {\r\n            // We've performed a type change (rectangle -> polygon)\r\n            doc.shapes[i] = new foundry.data.PolygonShapeData(dataShape);\r\n          } else if (docShape.type === 'polygon') {\r\n            docShape.points = dataShape.points;\r\n          } else {\r\n            docShape.x = dataShape.x;\r\n            docShape.y = dataShape.y;\r\n\r\n            if (docShape.type === 'rectangle') {\r\n              docShape.width = dataShape.width;\r\n              docShape.height = dataShape.height;\r\n            } else if (docShape.type === 'ellipse') {\r\n              docShape.radiusX = dataShape.radiusX;\r\n              docShape.radiusY = dataShape.radiusY;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformNote(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (transform.mirrorX) {\r\n      data.x = origin.x - (data.x - origin.x);\r\n    }\r\n    if (transform.mirrorY) {\r\n      data.y = origin.y - (data.y - origin.y);\r\n    }\r\n\r\n    if (preview) {\r\n      preview.document.x = data.x;\r\n      preview.document.y = data.y;\r\n      if (data.elevation) preview.document.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformAmbientSound(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.radius *= scale;\r\n      }\r\n\r\n      if (data.elevation != null) {\r\n        data.elevation *= scale;\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      data.elevation = (data.elevation ?? 0) + transform.z;\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (transform.mirrorX) {\r\n      data.x = origin.x - (data.x - origin.x);\r\n    }\r\n    if (transform.mirrorY) {\r\n      data.y = origin.y - (data.y - origin.y);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.radius = data.radius;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformWall(data, origin, transform, preview) {\r\n    const c = foundry.utils.deepClone(data.c);\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      c[0] *= scale;\r\n      c[1] *= scale;\r\n      c[2] *= scale;\r\n      c[3] *= scale;\r\n    }\r\n\r\n    c[0] += transform.x;\r\n    c[1] += transform.y;\r\n    c[2] += transform.x;\r\n    c[3] += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [c[0], c[1]] = this.rotatePoint(origin.x, origin.y, c[0], c[1], dr);\r\n      [c[2], c[3]] = this.rotatePoint(origin.x, origin.y, c[2], c[3], dr);\r\n    }\r\n\r\n    if (transform.mirrorX) {\r\n      c[0] = origin.x - (c[0] - origin.x);\r\n      c[2] = origin.x - (c[2] - origin.x);\r\n    }\r\n    if (transform.mirrorY) {\r\n      c[1] = origin.y - (c[1] - origin.y);\r\n      c[3] = origin.y - (c[3] - origin.y);\r\n    }\r\n\r\n    data.c = c;\r\n    if (preview) preview.document.c = c;\r\n  }\r\n\r\n  static transformMeasuredTemplate(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.distance *= scale;\r\n        if (data.width) data.width *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.direction += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      if (transform.mirrorX) {\r\n        data.x = origin.x - (data.x - origin.x);\r\n        if (data.direction > 180) data.direction = 360 - (data.direction - 180);\r\n        else data.direction = 180 - data.direction;\r\n      }\r\n      if (transform.mirrorY) {\r\n        data.y = origin.y - (data.y - origin.y);\r\n        data.direction = 180 - (data.direction - 180);\r\n      }\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.direction = data.direction;\r\n      doc.distance = data.distance;\r\n      doc.width = data.width;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformAmbientLight(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.config.dim *= scale;\r\n        data.config.bright *= scale;\r\n      }\r\n\r\n      if (data.elevation != null) {\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      data.elevation = (data.elevation ?? 0) + transform.z;\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      if (transform.mirrorX) {\r\n        data.x = origin.x - (data.x - origin.x);\r\n        data.rotation = 180 - (data.rotation - 180);\r\n      }\r\n      if (transform.mirrorY) {\r\n        data.y = origin.y - (data.y - origin.y);\r\n        if (data.rotation > 180) data.rotation = 360 - (data.rotation - 180);\r\n        else data.rotation = 180 - data.rotation;\r\n      }\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.rotation = data.rotation;\r\n      doc.config.dim = data.config.dim;\r\n      doc.config.bright = data.config.bright;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n\r\n      if (preview._l3dPreview) {\r\n        const pos = game.Levels3DPreview.ruler.constructor.posCanvasTo3d({\r\n          x: doc.x,\r\n          y: doc.y,\r\n          z: doc.elevation,\r\n        });\r\n        const mesh = preview._l3dPreview.mesh;\r\n        mesh.position.x = pos.x;\r\n        mesh.position.y = pos.y;\r\n        mesh.position.z = pos.z;\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformTile(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.width *= scale;\r\n      data.height *= scale;\r\n\r\n      // 3D Support\r\n      const depth = data.flags?.['levels-3d-preview']?.depth;\r\n      if (depth != null && depth != '') data.flags['levels-3d-preview'].depth = depth * scale;\r\n      if (data.elevation != null) {\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.width / 2, y: data.y + data.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.width / 2;\r\n      data.y = rectCenter.y - data.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      let rectCenter = { x: data.x + data.width / 2, y: data.y + data.height / 2 };\r\n      if (transform.mirrorX) {\r\n        rectCenter.x = origin.x - (rectCenter.x - origin.x);\r\n        data.texture.scaleX *= -1;\r\n        data.x = rectCenter.x - data.width / 2;\r\n      }\r\n      if (transform.mirrorY) {\r\n        rectCenter.y = origin.y - (rectCenter.y - origin.y);\r\n        data.texture.scaleY *= -1;\r\n        data.y = rectCenter.y - data.height / 2;\r\n      }\r\n      data.rotation = 180 - (data.rotation - 180);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n      doc.rotation = data.rotation;\r\n      doc.texture.scaleX = data.texture.scaleX;\r\n      doc.texture.scaleY = data.texture.scaleY;\r\n      if (data.elevation != null) doc.elevation = data.elevation;\r\n\r\n      if (preview._l3dPreview && preview._l3dPreview.mesh) {\r\n        const pos = game.Levels3DPreview.ruler.constructor.posCanvasTo3d({\r\n          x: doc.x + doc.width / 2,\r\n          y: doc.y + doc.height / 2,\r\n          z: doc.elevation,\r\n        });\r\n        const mesh = preview._l3dPreview.mesh;\r\n        mesh.position.x = pos.x;\r\n        mesh.position.y = pos.y;\r\n        mesh.position.z = pos.z;\r\n\r\n        if (transform.scale != null) {\r\n          mesh.scale.multiplyScalar(transform.scale);\r\n        }\r\n        if (transform.rotation != null) {\r\n          mesh.rotation.y += game.Levels3DPreview.THREE.MathUtils.degToRad(-transform.rotation);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformDrawing(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.shape.width *= scale;\r\n      data.shape.height *= scale;\r\n      if (data.shape.points) {\r\n        const points = data.shape.points;\r\n        for (let i = 0; i < points.length; i++) {\r\n          points[i] *= scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.shape.width / 2, y: data.y + data.shape.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.shape.width / 2;\r\n      data.y = rectCenter.y - data.shape.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      const rectCenter = { x: data.x + data.shape.width / 2, y: data.y + data.shape.height / 2 };\r\n\r\n      if (transform.mirrorX) {\r\n        data.x = origin.x - (rectCenter.x - origin.x);\r\n        if (data.shape.points) {\r\n          const points = data.shape.points;\r\n          for (let i = 0; i < points.length; i += 2) {\r\n            points[i] = data.shape.width / 2 - (points[i] - data.shape.width / 2);\r\n          }\r\n        }\r\n        data.x = rectCenter.x - data.shape.width / 2;\r\n      }\r\n\r\n      if (transform.mirrorY) {\r\n        data.y = origin.y - (rectCenter.y - origin.y);\r\n        if (data.shape.points) {\r\n          const points = data.shape.points;\r\n          for (let i = 1; i < points.length; i += 2) {\r\n            points[i] = data.shape.height / 2 - (points[i] - data.shape.height / 2);\r\n          }\r\n        }\r\n        data.y = rectCenter.y - data.shape.height / 2;\r\n      }\r\n\r\n      data.rotation = 180 - (data.rotation - 180);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.shape.width = data.shape.width;\r\n      doc.shape.height = data.shape.height;\r\n      doc.shape.points = data.shape.points;\r\n      doc.rotation = data.rotation;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformToken(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.width *= scale;\r\n        data.height *= scale;\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    const grid = canvas.grid;\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = {\r\n        x: data.x + (data.width * grid.sizeX) / 2,\r\n        y: data.y + (data.height * grid.sizeY) / 2,\r\n      };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - (data.width * grid.sizeX) / 2;\r\n      data.y = rectCenter.y - (data.height * grid.sizeY) / 2;\r\n      data.rotation = (data.rotation + Math.toDegrees(dr)) % 360;\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      let rectCenter = {\r\n        x: data.x + (data.width * grid.sizeX) / 2,\r\n        y: data.y + (data.height * grid.sizeY) / 2,\r\n      };\r\n      if (transform.mirrorX) {\r\n        rectCenter.x = origin.x - (rectCenter.x - origin.x);\r\n        data.texture.scaleX *= -1;\r\n        data.x = rectCenter.x - (data.width * grid.sizeX) / 2;\r\n      }\r\n      if (transform.mirrorY) {\r\n        rectCenter.y = origin.y - (rectCenter.y - origin.y);\r\n        data.texture.scaleY *= -1;\r\n        data.y = rectCenter.y - (data.height * grid.sizeY) / 2;\r\n      }\r\n      data.rotation = 180 - (data.rotation - 180);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.elevation = data.elevation;\r\n      doc.rotation = data.rotation;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n      doc.texture.scaleX = data.texture.scaleX;\r\n      doc.texture.scaleY = data.texture.scaleY;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n      if (preview.hasOwnProperty('_l3dPreview')) {\r\n        preview._l3dPreview = game.Levels3DPreview.tokens[preview.id];\r\n        if (!preview._l3dPreview) return;\r\n\r\n        const pos = game.Levels3DPreview.ruler.constructor.posCanvasTo3d({\r\n          x: doc.x + (doc.width * canvas.grid.sizeX) / 2,\r\n          y: doc.y + (doc.height * canvas.grid.sizeY) / 2,\r\n          z: doc.elevation,\r\n        });\r\n        const mesh = preview._l3dPreview.mesh;\r\n        mesh.position.x = pos.x;\r\n        mesh.position.y = pos.y;\r\n        mesh.position.z = pos.z;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rotates one point around the other\r\n   * @param {Number} x pivot point\r\n   * @param {Number} y pivot point\r\n   * @param {Number} x2 point to be rotated\r\n   * @param {Number} y2 point to be rotated\r\n   * @param {Number} rot rotation in radians\r\n   * @returns\r\n   */\r\n  static rotatePoint(x, y, x2, y2, rot) {\r\n    const dx = x2 - x,\r\n      dy = y2 - y;\r\n    return [x + Math.cos(rot) * dx - Math.sin(rot) * dy, y + Math.sin(rot) * dx + Math.cos(rot) * dy];\r\n  }\r\n}\r\n\r\nexport async function editPreviewPlaceables() {\r\n  const controlled = new Set();\r\n\r\n  SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n    canvas.getLayerByEmbeddedName(documentName).controlled.forEach((p) => {\r\n      controlled.add(p.document);\r\n      LinkerAPI.getLinkedDocuments(p.document).forEach((d) => controlled.add(d));\r\n    });\r\n  });\r\n\r\n  if (!controlled.size) {\r\n    const pickerSelected = await pickerSelectMultiLayerDocuments();\r\n    pickerSelected.forEach((d) => controlled.add(d));\r\n  }\r\n\r\n  if (!controlled.size) return;\r\n\r\n  // Generate data from the selected placeables and pass them to Picker to create previews\r\n  const docToData = new Map();\r\n\r\n  let mainDocumentName;\r\n\r\n  controlled.forEach((document) => {\r\n    const documentName = document.documentName;\r\n    if (!SUPPORTED_PLACEABLES.includes(documentName)) return;\r\n\r\n    let data = document.toObject();\r\n\r\n    if (\r\n      documentName === 'Token' &&\r\n      game.modules.get('token-attacher')?.active &&\r\n      tokenAttacher?.generatePrototypeAttached\r\n    ) {\r\n      const attached = data.flags?.['token-attacher']?.attached || {};\r\n      if (!foundry.utils.isEmpty(attached)) {\r\n        const prototypeAttached = tokenAttacher.generatePrototypeAttached(data, attached);\r\n        foundry.utils.setProperty(data, 'flags.token-attacher.attached', null);\r\n        foundry.utils.setProperty(data, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n        foundry.utils.setProperty(data, 'flags.token-attacher.grid', {\r\n          size: canvas.grid.size,\r\n          w: canvas.grid.sizeX,\r\n          h: canvas.grid.sizeY,\r\n        });\r\n      }\r\n    }\r\n\r\n    if (docToData.get(documentName)) docToData.get(documentName).push(data);\r\n    else docToData.set(documentName, [data]);\r\n\r\n    if (!mainDocumentName) mainDocumentName = documentName;\r\n  });\r\n\r\n  // Lets create copies of original data so that we can perform a diff after transforms have been\r\n  // applied by the Picker\r\n  const originalDocToData = new Map();\r\n  docToData.forEach((dataArr, documentName) => {\r\n    originalDocToData.set(documentName, foundry.utils.deepClone(dataArr));\r\n  });\r\n\r\n  Picker.activate(\r\n    async (coords) => {\r\n      if (coords == null) return;\r\n\r\n      docToData.forEach((data, documentName) => {\r\n        let updates = [];\r\n\r\n        const originalData = originalDocToData.get(documentName);\r\n        for (let i = 0; i < originalData.length; i++) {\r\n          const diff = foundry.utils.diffObject(originalData[i], data[i]);\r\n          if (!foundry.utils.isEmpty(diff)) {\r\n            diff._id = originalData[i]._id;\r\n            updates.push(diff);\r\n          }\r\n        }\r\n        if (updates.length)\r\n          canvas.scene.updateEmbeddedDocuments(documentName, updates, { ignoreLinks: true, animate: false });\r\n      });\r\n    },\r\n    {\r\n      documentName: mainDocumentName,\r\n      previewData: docToData,\r\n      snap: true,\r\n      taPreview: 'ALL',\r\n      center: true,\r\n    }\r\n  );\r\n}\r\n","import { checkApplySpecialFields } from '../../applications/formUtils.js';\r\nimport { showGenericForm } from '../../applications/multiConfig.js';\r\nimport { Brush } from '../brush.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES, UI_DOCS } from '../constants.js';\r\nimport { DataTransform, Picker } from '../picker.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport { SeededRandom, applyPresetToScene, createDocuments, executeScript, localize } from '../utils.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\nimport { Preset, VirtualFilePreset } from './preset.js';\r\nimport {\r\n  FolderState,\r\n  applyTaggerTagRules,\r\n  decodeURIComponentSafely,\r\n  getPresetDataCenterOffset,\r\n  getTransformToOrigin,\r\n  mergePresetDataToDefaultDoc,\r\n  placeableToData,\r\n} from './utils.js';\r\n\r\nconst DEFAULT_PACK = 'world.mass-edit-presets-main';\r\nexport const META_INDEX_ID = 'MassEditMetaData';\r\nexport const META_INDEX_FIELDS = ['id', 'img', 'documentName', 'tags'];\r\n\r\nexport class PresetCollection {\r\n  static presets;\r\n\r\n  static workingPack;\r\n\r\n  static async getTree(type, { externalCompendiums = true, virtualDirectory = true, setFormVisibility = false } = {}) {\r\n    if (CONFIG.debug.MassEdit) console.time('getTree');\r\n\r\n    let pack;\r\n    let mainTree;\r\n    try {\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await PresetTree.init(pack, type, { forceLoad: true, setFormVisibility });\r\n    } catch (e) {\r\n      // Fail-safe. Return back to DEFAULT_PACK\r\n      console.log(e);\r\n      console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`);\r\n      console.log('RETURNING TO DEFAULT');\r\n      await game.settings.set(MODULE_ID, 'workingPack', DEFAULT_PACK);\r\n      this.workingPack = DEFAULT_PACK;\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await PresetTree.init(pack, type, { forceLoad: true, setFormVisibility });\r\n    }\r\n\r\n    const extFolders = [];\r\n\r\n    if (externalCompendiums) {\r\n      for (const p of game.packs) {\r\n        if (p.collection !== this.workingPack && p.index.get(META_INDEX_ID)) {\r\n          const tree = await PresetTree.init(p, type, { setFormVisibility });\r\n          if (!tree.hasVisible) continue;\r\n\r\n          const topFolder = new PresetPackFolder({ pack: p, tree });\r\n          extFolders.push(topFolder);\r\n\r\n          // Collate all folders with the main tree\r\n          mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n          for (const [uuid, folder] of tree.allFolders) {\r\n            mainTree.allFolders.set(uuid, folder);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Read File Index\r\n    if (virtualDirectory) {\r\n      const vTree = await FileIndexer.getVirtualDirectoryTree(type, { setFormVisibility });\r\n      if (vTree?.hasVisible) {\r\n        const topFolder = new VirtualFileFolder({\r\n          name: 'VIRTUAL DIRECTORY',\r\n          children: vTree.folders,\r\n          uuid: 'virtual_directory',\r\n          color: '#1c5fa385',\r\n        });\r\n        extFolders.push(topFolder);\r\n\r\n        // Collate all folders with the main tree\r\n        mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n        for (const [uuid, folder] of vTree.allFolders) {\r\n          mainTree.allFolders.set(uuid, folder);\r\n        }\r\n      }\r\n    }\r\n\r\n    mainTree.extFolders = this._groupExtFolders(extFolders, mainTree.allFolders);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd('getTree');\r\n    return mainTree;\r\n  }\r\n\r\n  static _groupExtFolders(folders, allFolders) {\r\n    folders = folders.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n\r\n    const groups = {};\r\n    const groupless = [];\r\n    folders.forEach((f) => {\r\n      if (f.group) {\r\n        if (!(f.group in groups)) groups[f.group] = [];\r\n        groups[f.group].push(f);\r\n      } else {\r\n        groupless.push(f);\r\n      }\r\n    });\r\n\r\n    const newExtFolders = [];\r\n    for (const [group, folders] of Object.entries(groups)) {\r\n      const id = SeededRandom.randomID(group); // For export operation a real ID is needed. Lets keep it consistent by seeding\r\n      const uuid = 'virtual@' + group; // faux uuid\r\n\r\n      const groupFolder = new PresetVirtualFolder({\r\n        id,\r\n        uuid,\r\n        name: group,\r\n        children: folders,\r\n        draggable: false,\r\n      });\r\n\r\n      allFolders.set(uuid, groupFolder);\r\n      newExtFolders.push(groupFolder);\r\n    }\r\n\r\n    return newExtFolders.concat(groupless).sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n  }\r\n\r\n  // Fixing meta index by removing loose indexes\r\n  // 06/03/2024\r\n  static async _cleanIndex(pack, metaDoc, metaIndex) {\r\n    if (pack.locked || !metaDoc || foundry.utils.isEmpty(metaIndex)) return;\r\n    const index = pack.index;\r\n\r\n    const update = {};\r\n    for (const idx of Object.keys(metaIndex)) {\r\n      if (!index.has(idx)) update['-=' + idx] = null;\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      if (CONFIG.debug.MassEdit) console.log('Mass Edit - Index Cleanup', update);\r\n      metaDoc.setFlag(MODULE_ID, 'index', update);\r\n      delete PresetTree._packTrees[pack.metadata.name];\r\n    }\r\n  }\r\n\r\n  static _sortFolders(folders, sorting = 'a') {\r\n    for (const folder of folders) {\r\n      folder.children = this._sortFolders(folder.children, folder.sorting);\r\n      folder.presets = this._sortPresets(folder.presets, folder.sorting);\r\n    }\r\n\r\n    if (sorting === 'a') return folders.sort((f1, f2) => f1.name.localeCompare(f2.name, 'en', { numeric: true }));\r\n    else return folders.sort((f1, f2) => f1.sort - f2.sort);\r\n  }\r\n\r\n  static _sortPresets(presets, sorting = 'a') {\r\n    if (sorting === 'a') return presets.sort((p1, p2) => p1.name.localeCompare(p2.name, 'en', { numeric: true }));\r\n    else return presets.sort((p1, p2) => p1.sort - p2.sort);\r\n  }\r\n\r\n  static async packToPresets(pack) {\r\n    if (!pack) return [];\r\n\r\n    const presets = [];\r\n\r\n    let metaIndex = (await pack.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  static async update(preset) {\r\n    const compendium = await this._initCompendium(this.workingPack);\r\n    const doc = await compendium.getDocument(preset.id);\r\n    const updateDoc = {\r\n      name: preset.name,\r\n      flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n    };\r\n    const pages = preset.pages;\r\n    if (pages) updateDoc.pages = pages;\r\n    await doc.update(updateDoc);\r\n\r\n    const metaDoc = await this._initMetaDocument(this.workingPack);\r\n    const update = {};\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n    delete PresetTree._packTrees[compendium.metadata.name];\r\n  }\r\n\r\n  /**\r\n   * Update multiple presets at the same time\r\n   * @param {*} updates\r\n   */\r\n  static async updatePresets(updates) {\r\n    // TODO update meta and preset itself\r\n    await JournalEntry.updateDocuments(updates, { pack: this.workingPack });\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async set(preset, pack) {\r\n    if (!pack) pack = this.workingPack;\r\n\r\n    if (preset instanceof Array) {\r\n      for (const p of preset) {\r\n        await PresetCollection.set(p, pack);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const compendium = await this._initCompendium(pack);\r\n    if (compendium.index.get(preset.id)) {\r\n      await this.update(preset);\r\n      return;\r\n    }\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: preset.id,\r\n          name: preset.name,\r\n          pages: preset.pages ?? [],\r\n          folder: preset.folder,\r\n          flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n\r\n    preset.uuid = documents[0].uuid;\r\n    preset.document = documents[0];\r\n\r\n    const metaDoc = await this._initMetaDocument(pack);\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n    delete PresetTree._packTrees[pack];\r\n  }\r\n\r\n  static async get(uuid, { full = true } = {}) {\r\n    if (uuid.startsWith('virtual@')) return this._constructVirtualFilePreset(uuid, { full });\r\n\r\n    let { collection, documentId, documentType, embedded, doc } = foundry.utils.parseUuid(uuid);\r\n    const index = collection.index.get(documentId);\r\n\r\n    if (index) {\r\n      const metaIndex = (await collection.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n      const mIndex = metaIndex[index._id];\r\n\r\n      const preset = new Preset({ ...index, ...mIndex, pack: collection.collection });\r\n      if (full) await preset.load();\r\n      return preset;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  static async _constructVirtualFilePreset(uuid, { full = true } = {}) {\r\n    const src = uuid.substring(8);\r\n    const preset = new VirtualFilePreset({ src });\r\n    if (full) await preset.load();\r\n    return preset;\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async delete(presets) {\r\n    if (!presets) return;\r\n    if (!(presets instanceof Array)) presets = [presets];\r\n\r\n    // Sort by compendium\r\n    const sorted = {};\r\n    for (const preset of presets) {\r\n      let { collection } = foundry.utils.parseUuid(preset.uuid);\r\n      if (!collection) continue;\r\n      collection = collection.collection;\r\n      if (!sorted[collection]) sorted[collection] = [preset];\r\n      else sorted[collection].push(preset);\r\n    }\r\n\r\n    for (const pack of Object.keys(sorted)) {\r\n      const compendium = await game.packs.get(pack);\r\n      if (!compendium) continue;\r\n\r\n      const metaDoc = await this._initMetaDocument(pack);\r\n      const metaUpdate = {};\r\n\r\n      const deleteIds = [];\r\n      for (const preset of sorted[pack]) {\r\n        deleteIds.push(preset.id);\r\n        metaUpdate['-=' + preset.id] = null;\r\n      }\r\n\r\n      const opts = { pack };\r\n      opts.ids = deleteIds; // v12 fix\r\n      await JournalEntry.deleteDocuments(deleteIds, opts);\r\n      await metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n      delete PresetTree._packTrees[compendium.metadata.name];\r\n    }\r\n  }\r\n\r\n  static async _initCompendium(pack) {\r\n    let compendium = game.packs.get(pack);\r\n    if (!compendium && pack === DEFAULT_PACK) {\r\n      compendium = await CompendiumCollection.createCompendium({\r\n        label: 'Mass Edit: Presets (MAIN)',\r\n        type: 'JournalEntry',\r\n        ownership: {\r\n          GAMEMASTER: 'NONE',\r\n          PLAYER: 'NONE',\r\n          ASSISTANT: 'NONE',\r\n        },\r\n        packageType: 'world',\r\n      });\r\n\r\n      await this._initMetaDocument(pack);\r\n    }\r\n\r\n    return compendium;\r\n  }\r\n\r\n  static async _initMetaDocument(pack) {\r\n    const compendium = game.packs.get(pack);\r\n    const metaDoc = await compendium.getDocument(META_INDEX_ID);\r\n    if (metaDoc) return metaDoc;\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: META_INDEX_ID,\r\n          name: '!!! METADATA: DO NOT DELETE !!!',\r\n          flags: { [MODULE_ID]: { index: {} } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n    return documents[0];\r\n  }\r\n\r\n  static async deleteFolder(uuid, deleteAll = false) {\r\n    const folderDoc = await fromUuid(uuid);\r\n    if (folderDoc.compendium.locked) return;\r\n\r\n    if (deleteAll) {\r\n      const metaDoc = folderDoc.compendium.get(META_INDEX_ID);\r\n      if (!metaDoc) return;\r\n\r\n      const metaUpdate = {};\r\n      const traverseFolder = function (folder) {\r\n        folder.contents.forEach((j) => (metaUpdate['-=' + j._id] = null));\r\n        folder.children.forEach((c) => traverseFolder(c.folder));\r\n      };\r\n      traverseFolder(folderDoc);\r\n\r\n      metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n    }\r\n\r\n    delete PresetTree._packTrees[folderDoc.compendium.metadata.name];\r\n    return await folderDoc.delete({ deleteSubfolders: deleteAll, deleteContents: deleteAll });\r\n  }\r\n\r\n  static _searchPresetTree(tree, options) {\r\n    const presets = [];\r\n\r\n    if (!options.folder) this._searchPresetList(tree.allPresets, presets, options);\r\n    tree.allFolders.forEach((folder) => this._searchPresetFolder(folder, presets, options));\r\n\r\n    return presets;\r\n  }\r\n\r\n  static _searchPresetFolder(folder, presets, options) {\r\n    if (options.folder && folder.name !== options.folder) return;\r\n    this._searchPresetList(folder.presets, presets, options, folder.name);\r\n  }\r\n\r\n  static _searchPresetList(toSearch, presets, { name, type, tags } = {}, folderName) {\r\n    for (const preset of toSearch) {\r\n      let match = true;\r\n      if (name && name !== preset.name) match = false;\r\n      if (type && type !== preset.documentName) match = false;\r\n      if (match && tags) {\r\n        if (tags.matchAny) match = tags.tags.some((t) => preset.tags.includes(t));\r\n        else match = tags.tags.every((t) => preset.tags.includes(t));\r\n      }\r\n\r\n      if (match) presets.push(preset);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build preset index for 'Spotlight Omnisearch' module\r\n   * @param {Array[CONFIG.SpotlightOmnisearch.SearchTerm]} soIndex\r\n   */\r\n  static async buildSpotlightOmnisearchIndex(soIndex) {\r\n    const tree = await PresetCollection.getTree(null, { externalCompendiums: true });\r\n\r\n    const SearchTerm = CONFIG.SpotlightOmnisearch.SearchTerm;\r\n\r\n    const onClick = async function () {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        ui.spotlightOmnisearch?.setDraggingState(true);\r\n        await PresetAPI.spawnPreset({\r\n          preset: this.data,\r\n          coordPicker: true,\r\n          taPreview: 'ALL',\r\n          scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n        });\r\n        ui.spotlightOmnisearch?.setDraggingState(false);\r\n      }\r\n    };\r\n\r\n    const onDragEnd = function (event) {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        const { x, y } = canvas.canvasCoordinatesFromClient({ x: event.clientX, y: event.clientY });\r\n        PresetAPI.spawnPreset({\r\n          preset: this.data,\r\n          x,\r\n          y,\r\n          scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n        });\r\n      } else if (this.data.documentName === 'Scene') {\r\n        applyPresetToScene(this.data);\r\n      }\r\n    };\r\n\r\n    const deactivateCallback = function () {\r\n      ui.spotlightOmnisearch?.setDraggingState(false);\r\n    };\r\n\r\n    const getActions = function () {\r\n      const actions = [\r\n        {\r\n          name: 'MassEdit.presets.open-journal',\r\n          icon: '<i class=\"fas fa-book-open fa-fw\"></i>',\r\n          callback: () => {\r\n            this.data.openJournal();\r\n          },\r\n        },\r\n      ];\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        actions.push({\r\n          name: `MassEdit.presets.controls.activate-brush`,\r\n          icon: '<i class=\"fas fa-paint-brush\"></i>',\r\n          callback: async () => {\r\n            canvas.getLayerByEmbeddedName(this.data.documentName)?.activate();\r\n            if (Brush.activate({ preset: await this.data.load(), deactivateCallback })) {\r\n              ui.spotlightOmnisearch.setDraggingState(true);\r\n            }\r\n          },\r\n        });\r\n      }\r\n      return actions;\r\n    };\r\n\r\n    const buildTerm = function (preset) {\r\n      soIndex.push(\r\n        new SearchTerm({\r\n          name: preset.name,\r\n          description: 'Mass Edit: Preset',\r\n          type: preset.documentName + ' preset',\r\n          img: preset.img,\r\n          icon: ['fa-solid fa-books', preset.icon],\r\n          keywords: preset.tags,\r\n          onClick,\r\n          onDragEnd,\r\n          data: preset,\r\n          actions: getActions,\r\n        })\r\n      );\r\n    };\r\n\r\n    tree.presets.forEach(buildTerm);\r\n    tree.allFolders.forEach((f) => f.presets.forEach(buildTerm));\r\n  }\r\n}\r\n\r\nexport class PresetAPI {\r\n  static name = 'PresetAPI';\r\n\r\n  /**\r\n   * Retrieve preset\r\n   * @param {object} [options={}]\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Tags to match a preset against. Can be provided as an object containing 'tags' array and 'match' any flag.\r\n   *                                                     Comma separated string, or a list of strings. In the latter 2 case 'matchAny' is assumed true\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {Boolean} [options.random]                   If multiple presets are found a random one will be chosen\r\n   * @returns {Preset}\r\n   */\r\n  static async getPreset({ uuid, name, type, folder, tags, random = false, full = true } = {}) {\r\n    if (uuid) return await PresetCollection.get(uuid, { full });\r\n    else if (!name && !type && !folder && !tags)\r\n      throw Error('UUID, Name, Type, and/or Folder required to retrieve a Preset.');\r\n\r\n    if (tags) {\r\n      if (Array.isArray(tags)) tags = { tags, matchAny: true };\r\n      else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny: true };\r\n    }\r\n\r\n    const presets = PresetCollection._searchPresetTree(\r\n      await PresetCollection.getTree(type, { externalCompendiums: true, virtualDirectory: true }),\r\n      {\r\n        name,\r\n        type,\r\n        folder,\r\n        tags,\r\n      }\r\n    );\r\n\r\n    let preset = random ? presets[Math.floor(Math.random() * presets.length)] : presets[0];\r\n    if (preset) {\r\n      preset = preset.clone();\r\n      if (full) await preset.load();\r\n    }\r\n    return preset;\r\n  }\r\n\r\n  /**\r\n   * Retrieve presets\r\n   * @param {object} [options={}]\r\n   * @param {String|Array[String]} [options.uuid]        Preset UUID/s\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {String|Array[String]|Object} [options.tags] See PresetAPI.getPreset\r\n   * @param {String} [options.format]                    The form to return placeables in ('preset', 'name', 'nameAndFolder')\r\n   * @returns {Array[Preset]|Array[String]|Array[Object]}\r\n   */\r\n  static async getPresets({ uuid, name, type, folder, format = 'preset', tags, full = true } = {}) {\r\n    let presets;\r\n    if (uuid) {\r\n      presets = [];\r\n      const uuids = Array.isArray(uuid) ? uuid : [uuid];\r\n      for (const uuid of uuids) {\r\n        const preset = await PresetCollection.get(uuid, { full });\r\n        if (preset) presets.push(preset);\r\n      }\r\n    } else if (!name && !type && !folder && !tags) {\r\n      throw Error('UUID, Name, Type, Folder and/or Tags required to retrieve a Preset.');\r\n    } else {\r\n      if (tags) {\r\n        if (Array.isArray(tags)) tags = { tags, matchAny: true };\r\n        else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny: true };\r\n      }\r\n\r\n      presets = PresetCollection._searchPresetTree(\r\n        await PresetCollection.getTree(type, { externalCompendiums: true, virtualDirectory: true }),\r\n        {\r\n          name,\r\n          type,\r\n          folder,\r\n          tags,\r\n        }\r\n      );\r\n    }\r\n\r\n    if (format === 'name') return presets.map((p) => p.name);\r\n    else if (format === 'nameAndFolder')\r\n      return presets.map((p) => {\r\n        return { name: p.name, folder: p._folderName };\r\n      });\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Create a Token preset from the provided Actor\r\n   */\r\n  static async createPresetFromActor(actor, { keepId = false, folder } = {}) {\r\n    if (!actor || actor.documentName !== 'Actor') return;\r\n\r\n    const presetData = {\r\n      id: keepId ? actor.id : null,\r\n      name: actor.name,\r\n      documentName: 'Token',\r\n      img: actor.img,\r\n      data: [actor.prototypeToken.toJSON()],\r\n      folder: folder,\r\n    };\r\n\r\n    presetData.gridSize = canvas.scene.grid.size;\r\n\r\n    const preset = new Preset(presetData);\r\n    await PresetCollection.set(preset);\r\n    return preset;\r\n  }\r\n\r\n  static async createPresetFromActorUuid(uuid, options = {}) {\r\n    const actor = await fromUuid(uuid);\r\n    if (!actor.documentName === 'Actor') return;\r\n\r\n    return await this.createPresetFromActor(actor, options);\r\n  }\r\n\r\n  /**\r\n   * Create Presets from passed in placeables\r\n   * @param {PlaceableObject|Array[PlaceableObject]} placeables Placeable/s to create the presets from.\r\n   * @param {object} [options={}]                               Optional Preset information\r\n   * @param {String} [options.name]                             Preset name\r\n   * @param {String} [options.img]                              Preset thumbnail image\r\n   * @returns {Preset|Array[Preset]}\r\n   */\r\n  static async createPreset(placeables, options = {}) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    // Alike placeables will be made into single presets. Lets batch them up together.\r\n\r\n    const groups = {};\r\n    for (const placeable of placeables) {\r\n      const documentName = placeable.document.documentName;\r\n      if (!groups.hasOwnProperty(documentName)) groups[documentName] = [];\r\n      groups[documentName].push(placeable);\r\n    }\r\n\r\n    const presets = [];\r\n    for (const [documentName, placeables] of Object.entries(groups)) {\r\n      const data = [];\r\n      for (const placeable of placeables) {\r\n        data.push(placeableToData(placeable));\r\n      }\r\n\r\n      // Preset data before merging with user provided\r\n      const defPreset = {\r\n        name: localize('presets.default-name'),\r\n        documentName,\r\n        data: data,\r\n      };\r\n\r\n      // Assign preset image\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n        case 'Tile':\r\n        case 'Note':\r\n          defPreset.img = data[0].texture.src;\r\n          break;\r\n        case 'AmbientSound':\r\n          defPreset.img = 'icons/svg/sound.svg';\r\n          break;\r\n        case 'AmbientLight':\r\n          defPreset.img = 'icons/svg/light.svg';\r\n          break;\r\n        case 'Drawing':\r\n          defPreset.img = 'icons/svg/acid.svg';\r\n          break;\r\n        case 'MeasuredTemplate':\r\n          defPreset.img = 'icons/svg/circle.svg';\r\n          break;\r\n      }\r\n\r\n      //  Assign preset name\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n          defPreset.name = data[0].name;\r\n          break;\r\n        default:\r\n          const taggerTag = data[0].flags?.tagger?.tags?.[0];\r\n          if (taggerTag) defPreset.name = taggerTag;\r\n          break;\r\n      }\r\n\r\n      defPreset.gridSize = placeables[0].document.parent.grid.size;\r\n\r\n      foundry.utils.mergeObject(defPreset, options, { inplace: true });\r\n\r\n      const preset = new Preset(defPreset);\r\n      await PresetCollection.set(preset);\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Spawn a preset on the scene (uuid, name or preset itself are required).\r\n   * By default the current mouse position is used.\r\n   * @param {object} [options={}]\r\n   * @param {Preset} [options.preset]                    Preset\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Preset tags, See PresetAPI.getPreset\r\n   * @param {Boolean} [options.random]                   If a unique preset could not be found, a random one will be chosen from the matched list\r\n   * @param {Number} [options.x]                         Spawn canvas x coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.y]                         Spawn canvas y coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.z]                         Spawn canvas z coordinate (3D Canvas)\r\n   * @param {Boolean} [options.snapToGrid]               If 'true' snaps spawn position to the grid.\r\n   * @param {Boolean} [options.hidden]                   If 'true' preset will be spawned hidden.\r\n   * @param {Boolean} [options.layerSwitch]              If 'true' the layer of the spawned preset will be activated.\r\n   * @param {Boolean} [options.scaleToGrid]              If 'true' Tiles, Drawings, and Walls will be scaled relative to grid size.\r\n   * @param {Boolean} [options.modifyPrompt]             If 'true' a field modification prompt will be shown if configured via `Preset Edit > Modify` form\r\n   * @param {Boolean} [options.coordPicker]              If 'true' a crosshair and preview will be enabled allowing spawn position to be picked\r\n   * @param {String} [options.pickerLabel]               Label displayed above crosshair when `coordPicker` is enabled\r\n   * @param {String} [options.taPreview]                 Designates the preview placeable when spawning a `Token Attacher` prefab.\r\n   *                                                      Accepted values are \"ALL\" (for all elements) and document name optionally followed by an index number\r\n   *                                                      e.g. \"ALL\", \"Tile\", \"AmbientLight.1\"\r\n   * @returns {Array[Document]}\r\n   */\r\n  static async spawnPreset({\r\n    uuid,\r\n    preset,\r\n    name,\r\n    type,\r\n    folder,\r\n    tags,\r\n    random = false,\r\n    x,\r\n    y,\r\n    z,\r\n    coordPicker = false,\r\n    pickerLabel,\r\n    taPreview,\r\n    sceneId = canvas.scene.id,\r\n    snapToGrid = true,\r\n    hidden = false,\r\n    layerSwitch = false,\r\n    scaleToGrid = false,\r\n    modifyPrompt = true,\r\n    center = false,\r\n    transform = {},\r\n    previewOnly = false,\r\n    flags,\r\n  } = {}) {\r\n    if (!canvas.ready) throw Error(\"Canvas need to be 'ready' for a preset to be spawned.\");\r\n    if (!(uuid || preset || name || type || folder || tags))\r\n      throw Error('ID, Name, Folder, Tags, or Preset is needed to spawn it.');\r\n    if (!coordPicker && ((x == null && y != null) || (x != null && y == null)))\r\n      throw Error('Need both X and Y coordinates to spawn a preset.');\r\n\r\n    if (preset) await preset.load();\r\n    preset = preset ?? (await PresetAPI.getPreset({ uuid, name, type, folder, tags, random }));\r\n    if (!preset) throw Error(`No preset could be found matching: { uuid: \"${uuid}\", name: \"${name}\", type: \"${type}\"}`);\r\n\r\n    let presetData = foundry.utils.deepClone(preset.data);\r\n\r\n    // Instead of using the entire data group use only one random one\r\n    if (preset.spawnRandom && presetData.length)\r\n      presetData = [presetData[Math.floor(Math.random() * presetData.length)]];\r\n\r\n    // Display prompt to modify data if needed\r\n    if (modifyPrompt && preset.modifyOnSpawn?.length) {\r\n      presetData = await modifySpawnData(presetData, preset.modifyOnSpawn);\r\n      // presetData being returned as null means that the modify field form has been canceled\r\n      // in which case we should cancel spawning as well\r\n      if (presetData == null) return;\r\n    }\r\n\r\n    // Populate preset data with default placeable data\r\n    presetData = presetData.map((data) => {\r\n      return mergePresetDataToDefaultDoc(preset, data);\r\n    });\r\n    presetData = presetData.map((d) => foundry.utils.flattenObject(d));\r\n    if (!foundry.utils.isEmpty(preset.randomize)) await applyRandomization(presetData, null, preset.randomize); // Randomize data if needed\r\n    await checkApplySpecialFields(preset.documentName, presetData, presetData); // Apply Special fields (TMFX)\r\n    presetData = presetData.map((d) => foundry.utils.expandObject(d));\r\n\r\n    let presetAttached = foundry.utils.deepClone(preset.attached);\r\n\r\n    if (preset.preSpawnScript) {\r\n      await executeScript(preset.preSpawnScript, { data: presetData, attached: presetAttached });\r\n    }\r\n\r\n    // Lets sort the preset data as well as any attached placeable data into document groups\r\n    // documentName -> data array\r\n    const docToData = new Map();\r\n    docToData.set(preset.documentName, presetData);\r\n    if (presetAttached) {\r\n      for (const attached of presetAttached) {\r\n        if (!docToData.get(attached.documentName)) docToData.set(attached.documentName, []);\r\n        docToData.get(attached.documentName).push(attached.data);\r\n      }\r\n    }\r\n\r\n    // Regenerate links present within preset data. This will ensure uniqueness on the links\r\n    // when placed on a scene\r\n    if (!preset.preserveLinks) {\r\n      const links = new Map();\r\n\r\n      const newLinkId = function (oldId) {\r\n        let id = links.get(oldId);\r\n        if (!id) {\r\n          if (oldId.startsWith('LinkTokenBehavior - ')) {\r\n            id = 'LinkTokenBehavior - ' + foundry.utils.randomID(8);\r\n          } else {\r\n            id = foundry.utils.randomID();\r\n          }\r\n          links.set(oldId, id);\r\n        }\r\n        return id;\r\n      };\r\n\r\n      docToData.forEach((data) => {\r\n        data.forEach((d) => {\r\n          d.flags?.[MODULE_ID]?.links?.forEach((l) => {\r\n            l.id = newLinkId(l.id);\r\n          });\r\n          d.behaviors?.forEach((b) => {\r\n            if (b.system?.linkId) b.system.linkId = newLinkId(b.system.linkId);\r\n          });\r\n        });\r\n      });\r\n    }\r\n\r\n    // Scale data relative to grid size\r\n    if (scaleToGrid) {\r\n      const scale = canvas.grid.size / (preset.gridSize || 100);\r\n      docToData.forEach((dataArr, documentName) => {\r\n        dataArr.forEach((data) => DataTransform.apply(documentName, data, { x: 0, y: 0 }, { scale, gridScale: true }));\r\n      });\r\n    }\r\n\r\n    // ==================\r\n    // Determine spawn position\r\n    if (coordPicker) {\r\n      const coords = await new Promise(async (resolve) => {\r\n        Picker.activate(resolve, {\r\n          documentName: preset.documentName,\r\n          previewData: docToData,\r\n          snap: snapToGrid,\r\n          label: pickerLabel,\r\n          taPreview: taPreview,\r\n          center,\r\n          previewOnly,\r\n          ...transform,\r\n        });\r\n      });\r\n      if (coords == null) return [];\r\n      x = coords.end.x;\r\n      y = coords.end.y;\r\n      if (coords.end.z != null) z = coords.end.z;\r\n    } else if (x == null || y == null) {\r\n      if (game.Levels3DPreview?._active) {\r\n        const pos3d = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n        x = pos3d.x;\r\n        y = pos3d.y;\r\n        z = pos3d.z;\r\n      } else {\r\n        x = canvas.mousePosition.x;\r\n        y = canvas.mousePosition.y;\r\n\r\n        if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n          x -= canvas.dimensions.size / 2;\r\n          y -= canvas.dimensions.size / 2;\r\n        }\r\n      }\r\n    }\r\n\r\n    // If not using coorPicker (Picker) we need to handle position snapping here\r\n    if (!coordPicker) {\r\n      if (center) {\r\n        const offset = getPresetDataCenterOffset(docToData);\r\n        x -= offset.x;\r\n        y -= offset.y;\r\n      }\r\n\r\n      let pos = { x, y };\r\n\r\n      if (snapToGrid && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)) {\r\n        pos = canvas.getLayerByEmbeddedName(preset.documentName).getSnappedPoint(pos);\r\n      }\r\n      pos.z = z;\r\n\r\n      const posTransform = getTransformToOrigin(docToData);\r\n      posTransform.x += pos.x;\r\n      posTransform.y += pos.y;\r\n\r\n      // 3D Support\r\n      if (game.Levels3DPreview?._active) {\r\n        if (pos.z == null) posTransform.z = 0;\r\n        else posTransform.z += pos.z;\r\n      }\r\n\r\n      docToData.forEach((dataArr, documentName) => {\r\n        dataArr.forEach((data) => {\r\n          DataTransform.apply(documentName, data, { x: 0, y: 0 }, posTransform);\r\n        });\r\n      });\r\n    }\r\n\r\n    // Assign ownership to the user who triggered the spawn, hide and apply flags if if necessary\r\n    docToData.forEach((dataArr, documentName) => {\r\n      dataArr.forEach((data) => {\r\n        // Assign ownership for Drawings and MeasuredTemplates\r\n        if (['Drawing', 'MeasuredTemplate'].includes(documentName)) {\r\n          if (documentName === 'Drawing') data.author = game.user.id;\r\n          else if (documentName === 'MeasuredTemplate') data.user = game.user.id;\r\n        }\r\n\r\n        // Hide\r\n        if (hidden || game.keyboard.downKeys.has('AltLeft')) data.hidden = true;\r\n        if (flags) data.flags = foundry.utils.mergeObject(data.flags ?? {}, flags);\r\n\r\n        // Apply Tagger rules for Spawn Preset behaviors\r\n        if (documentName === 'Region' && data.behaviors) {\r\n          data.behaviors.forEach((b) => {\r\n            if (b.system?.destinationTags?.length)\r\n              b.system.destinationTags = applyTaggerTagRules(b.system.destinationTags);\r\n          });\r\n        }\r\n\r\n        // TODO: REMOVE once Foundry implements bug fix for null flag override\r\n        if (documentName === 'Token' && data.flags?.['token-attacher']?.attached === null) {\r\n          delete data.flags['token-attacher'].attached;\r\n        }\r\n      });\r\n    });\r\n\r\n    // We need to make sure that newly spawned tiles are displayed above currently places ones\r\n    if (docToData.get('Tile')) {\r\n      const maxSort = Math.max(0, ...game.scenes.get(sceneId).tiles.map((d) => d.sort)) + 1;\r\n      docToData\r\n        .get('Tile')\r\n        .sort((t1, t2) => (t1.sort ?? 0) - (t2.sort ?? 0))\r\n        .forEach((d, i) => (d.sort = maxSort + i));\r\n    }\r\n\r\n    // Switch active layer to the preset's base placeable type\r\n    if (layerSwitch) {\r\n      if (game.user.isGM || ['Token', 'MeasuredTemplate', 'Note'].includes(preset.documentName))\r\n        canvas.getLayerByEmbeddedName(preset.documentName)?.activate();\r\n    }\r\n\r\n    // Create Documents\r\n    const allDocuments = [];\r\n\r\n    for (const [documentName, dataArr] of docToData.entries()) {\r\n      const documents = await createDocuments(documentName, dataArr, sceneId);\r\n      documents.forEach((d) => allDocuments.push(d));\r\n    }\r\n\r\n    // Execute post spawn script/function\r\n    if (preset.postSpawnScript) {\r\n      await executeScript(preset.postSpawnScript, {\r\n        documents: allDocuments,\r\n        objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n      });\r\n    }\r\n    await preset.callPostSpawnHooks({\r\n      documents: allDocuments,\r\n      objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n    });\r\n\r\n    return allDocuments;\r\n  }\r\n}\r\n\r\nexport class PresetFolder {\r\n  static isEditable(uuid) {\r\n    const { collection } = foundry.utils.parseUuid(uuid);\r\n    return collection && !collection.locked;\r\n  }\r\n\r\n  constructor({\r\n    id,\r\n    uuid,\r\n    name,\r\n    sorting = 'm',\r\n    color = '#000000',\r\n    sort = 0,\r\n    children = [],\r\n    presets = [],\r\n    draggable = true,\r\n    folder = null,\r\n    visible = true,\r\n    render = true,\r\n    types = [],\r\n  } = {}) {\r\n    this.id = id;\r\n    this.uuid = uuid;\r\n    this.name = name;\r\n    this.sorting = sorting;\r\n    this.color = color;\r\n    this.sort = sort;\r\n    this.children = children;\r\n    this.children.forEach((c) => {\r\n      c.folder = this.id;\r\n    });\r\n    this.presets = presets;\r\n    this.draggable = draggable;\r\n    this.folder = folder;\r\n    this.visible = visible;\r\n    this.render = render;\r\n    this.expanded = FolderState.expanded(this.uuid);\r\n    this.types = types;\r\n  }\r\n\r\n  async update(data) {\r\n    const doc = await fromUuid(this.uuid);\r\n    if (doc) {\r\n      foundry.utils.mergeObject(this, data);\r\n      await doc.update(data);\r\n    }\r\n  }\r\n}\r\n\r\nexport class PresetVirtualFolder extends PresetFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.virtual = true;\r\n    this.draggable = false;\r\n  }\r\n\r\n  async update(data) {}\r\n}\r\n\r\nexport class VirtualFileFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.id = foundry.utils.randomID();\r\n    if (!options.types) this.types = ['ALL'];\r\n    this.bucket = options.bucket;\r\n    this.source = options.source;\r\n    this.name = decodeURIComponentSafely(this.name);\r\n    this.icon = options.icon;\r\n    this.subtext = options.subtext;\r\n    if (options.source && ['data', 'forgevtt'].includes(options.source)) this.indexable = true;\r\n  }\r\n}\r\n\r\nexport class PresetPackFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    const tree = options.tree;\r\n    const pack = options.pack;\r\n    const packFolderData = tree.metaDoc.getFlag(MODULE_ID, 'folder') ?? {};\r\n    const uuid = pack.collection;\r\n    super({\r\n      uuid,\r\n      id: SeededRandom.randomID(uuid),\r\n      name: packFolderData.name ?? pack.title,\r\n      children: tree.folders,\r\n      presets: tree.presets,\r\n      draggable: false,\r\n      color: packFolderData.color ?? '#000000',\r\n    });\r\n    this.group = packFolderData.group;\r\n  }\r\n\r\n  get pack() {\r\n    return this.uuid;\r\n  }\r\n\r\n  async update(data = {}) {\r\n    const pack = game.packs.get(this.pack);\r\n    if (pack.locked) return;\r\n    if (data.hasOwnProperty('name') && data.name === pack.title) delete data.name;\r\n    if (foundry.utils.isEmpty(data)) return;\r\n\r\n    const metaDoc = await PresetCollection._initMetaDocument(this.pack);\r\n    await metaDoc.setFlag(MODULE_ID, 'folder', data);\r\n\r\n    foundry.utils.mergeObject(this, data);\r\n  }\r\n}\r\n\r\nexport class PresetTree {\r\n  static _packTrees = {};\r\n\r\n  static async init(pack, type, { forceLoad = false, setFormVisibility = false } = {}) {\r\n    if (!pack) return null;\r\n\r\n    if (CONFIG.debug.MassEdit) console.time(pack.title);\r\n\r\n    // Re-use tree if already parsed\r\n    if (!forceLoad && PresetTree._packTrees[pack.metadata.name]) {\r\n      const tree = PresetTree._packTrees[pack.metadata.name];\r\n      if (setFormVisibility) tree.setVisibility(type);\r\n      if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n      return tree;\r\n    }\r\n\r\n    // Setup folders ready for parent/children processing\r\n    const folders = new Map();\r\n    const topLevelFolders = new Map();\r\n    const folderContents = pack.folders.contents;\r\n    for (const f of folderContents) {\r\n      const folder = new PresetFolder({\r\n        id: f._id,\r\n        uuid: f.uuid,\r\n        name: f.name,\r\n        sorting: f.sorting,\r\n        color: f.color,\r\n        sort: f.sort,\r\n        draggable: f.pack === PresetCollection.workingPack,\r\n        folder: f.folder?.uuid,\r\n        types: f.flags[MODULE_ID]?.types || ['ALL'],\r\n      });\r\n\r\n      folders.set(folder.uuid, folder);\r\n      topLevelFolders.set(f.uuid, folder);\r\n    }\r\n\r\n    // If folders have parent folders add them as children and remove them as a top level folder\r\n    for (const f of folderContents) {\r\n      if (f.folder) {\r\n        const parent = folders.get(f.folder.uuid);\r\n        parent.children.push(folders.get(f.uuid));\r\n        topLevelFolders.delete(f.uuid);\r\n      }\r\n    }\r\n\r\n    // Process presets\r\n    const allPresets = [];\r\n    const topLevelPresets = [];\r\n    let hasVisible = false; // tracks whether there exists at least one visible preset within this tree\r\n    const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n    let metaIndex = metaDoc?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n\r\n    // TEMP - 06/03/2024\r\n    // Due to poor implementation of Folder+Folder Content delete, there are likely to be some indexes which were not removed\r\n    // Lets clean them up here for now\r\n    PresetCollection._cleanIndex(pack, metaDoc, metaIndex);\r\n    // Remove after sufficient enough time has passed to have reasonable confidence that All/Most users have executed this ^\r\n\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n\r\n      // If no document name is available (missing metadata) attempt to load the preset to retrieve it\r\n      // If still no name is found, skip it\r\n      if (!preset.documentName) {\r\n        console.log(`Missing MetaData. Attempting document load: ${preset.id} | ${preset.name}`);\r\n        await preset.load(true);\r\n        if (!preset.documentName) continue;\r\n        console.log(`MetaData. Found for: ${preset.id} | ${preset.name}`);\r\n        if (!pack.locked) await preset._updateIndex(preset); // Insert missing preset into metadata index\r\n      }\r\n\r\n      if (preset.folder) {\r\n        let matched = false;\r\n        for (const [uuid, folder] of folders) {\r\n          if (folder.id === preset.folder) {\r\n            folder.presets.push(preset);\r\n            matched = true;\r\n            break;\r\n          }\r\n        }\r\n        if (!matched) topLevelPresets.push(preset);\r\n      } else topLevelPresets.push(preset);\r\n\r\n      allPresets.push(preset);\r\n      hasVisible |= preset._visible;\r\n    }\r\n\r\n    // Sort folders\r\n    const sorting = game.settings.get(MODULE_ID, 'presetSortMode') === 'manual' ? 'm' : 'a';\r\n    const sortedFolders = PresetCollection._sortFolders(Array.from(topLevelFolders.values()), sorting);\r\n    const sortedPresets = PresetCollection._sortPresets(topLevelPresets, sorting);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n\r\n    const tree = new PresetTree({\r\n      folders: sortedFolders,\r\n      presets: sortedPresets,\r\n      allPresets,\r\n      allFolders: folders,\r\n      hasVisible,\r\n      metaDoc,\r\n      pack,\r\n    });\r\n\r\n    if (setFormVisibility) tree.setVisibility(type);\r\n    PresetTree._packTrees[pack.metadata.name] = tree;\r\n\r\n    return tree;\r\n  }\r\n\r\n  constructor({ folders, presets, allPresets, allFolders, hasVisible, metaDoc, pack } = {}) {\r\n    this.folders = folders;\r\n    this.presets = presets;\r\n    this.allPresets = allPresets;\r\n    this.allFolders = allFolders;\r\n    this.hasVisible = hasVisible;\r\n    this.metaDoc = metaDoc;\r\n    this.pack = pack;\r\n  }\r\n\r\n  setVisibility(type) {\r\n    this.allFolders.forEach((f) => {\r\n      f.render = true;\r\n      f.visible = type ? f.types.includes(type) : true;\r\n    });\r\n\r\n    this.hasVisible = false;\r\n\r\n    for (const preset of this.allPresets) {\r\n      preset._visible = true;\r\n      preset._render = true;\r\n      if (type) {\r\n        if (type === 'ALL') {\r\n          if (!UI_DOCS.includes(preset.documentName)) preset._visible = false;\r\n        } else if (type === 'FAVORITES') {\r\n          if (!preset.isFavorite) preset._visible = false;\r\n        } else if (preset.documentName !== type) preset._visible = false;\r\n      }\r\n\r\n      if (type === 'FAVORITES' && preset.folder && preset.isFavorite) {\r\n        for (const [uuid, folder] of this.allFolders) {\r\n          if (folder.id === preset.folder) {\r\n            this._setChildAndParentFoldersVisible(folder);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      this.hasVisible = this.hasVisible || preset._visible;\r\n    }\r\n  }\r\n\r\n  _setChildAndParentFoldersVisible(folder) {\r\n    folder.visible = true;\r\n    if (folder.folder) {\r\n      for (const [uuid, f] of this.allFolders.entries()) {\r\n        if (f.id === folder.folder) return this._setChildAndParentFoldersVisible(f);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Opens a GenericMassEdit form to modify specific fields within the provided data\r\n * @param {Object} data            data to be modified\r\n * @param {Array[String]} toModify fields within data to be modified\r\n * @returns modified data or null if form was canceled\r\n */\r\nasync function modifySpawnData(data, toModify) {\r\n  const fields = {};\r\n  const flatData = foundry.utils.flattenObject(data);\r\n  for (const field of toModify) {\r\n    if (field in flatData) {\r\n      if (flatData[field] == null) fields[field] = '';\r\n      else fields[field] = flatData[field];\r\n    }\r\n  }\r\n\r\n  if (!foundry.utils.isEmpty(fields)) {\r\n    await new Promise((resolve) => {\r\n      showGenericForm(fields, 'PresetFieldModify', {\r\n        callback: (modified) => {\r\n          if (foundry.utils.isEmpty(modified)) {\r\n            if (modified == null) data = null;\r\n            resolve();\r\n            return;\r\n          }\r\n\r\n          for (const [k, v] of Object.entries(modified)) {\r\n            flatData[k] = v;\r\n          }\r\n\r\n          const tmpData = foundry.utils.expandObject(flatData);\r\n\r\n          const reorganizedData = [];\r\n          for (let i = 0; i < data.length; i++) {\r\n            reorganizedData.push(tmpData[i]);\r\n          }\r\n          data = reorganizedData;\r\n          resolve();\r\n        },\r\n        simplified: true,\r\n        noTabs: true,\r\n      });\r\n    });\r\n  }\r\n\r\n  return data;\r\n}\r\n","import { FILE_EXTENSIONS, MODULE_ID } from '../constants.js';\r\nimport { TagInput } from '../utils.js';\r\nimport { PresetTree, VirtualFileFolder } from './collection.js';\r\nimport { VirtualFilePreset } from './preset.js';\r\nimport { encodeURIComponentSafely, readJSONFile } from './utils.js';\r\n\r\nconst CACHE_PATH = '';\r\nconst CACHE_NAME = 'mass_edit_cache.json';\r\n\r\nexport class FileIndexer {\r\n  static _loadedTree;\r\n  static _buildingIndex = false;\r\n\r\n  static async getVirtualDirectoryTree(type, { setFormVisibility = false } = {}) {\r\n    if (CONFIG.debug.MassEdit) console.time('Virtual File Directory');\r\n\r\n    // If we already have a loaded index, re-use it\r\n    if (this._loadedTree) {\r\n      if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n      if (setFormVisibility) this._loadedTree.setVisibility(type);\r\n      return this._loadedTree;\r\n    }\r\n\r\n    // Load and convert an index cache to a virtual folder\r\n    const allFolders = new Map();\r\n    const allPresets = [];\r\n    const topLevelFolders = [];\r\n\r\n    const cache = await this.loadMainIndexCache();\r\n    if (!cache) {\r\n      if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n      return null;\r\n    }\r\n\r\n    for (const source of cache) {\r\n      let prePend = '';\r\n      if (source.source === 'forge-bazaar') {\r\n        prePend = `https://assets.forge-vtt.com/bazaar/`;\r\n      } else if (source.source === 'forgevtt') {\r\n        if (typeof ForgeVTT === 'undefined' || !ForgeVTT.usingTheForge) continue;\r\n        const userId = await ForgeAPI.getUserId();\r\n        if (!userId) continue;\r\n        prePend = `https://assets.forge-vtt.com/${userId}/`;\r\n      } else if (source.source === 's3') {\r\n        const s3 = game.data.files.s3;\r\n        if (!s3 || !s3.buckets.includes(source.bucket)) continue;\r\n        prePend = `https://${source.bucket}.${s3.endpoint.host}`;\r\n      }\r\n      const folders = source.index.map((f) =>\r\n        this._indexToVirtualFolder(f, '', allFolders, allPresets, {\r\n          prePend,\r\n          source: source.source,\r\n          bucket: source.bucket,\r\n        })\r\n      );\r\n\r\n      if (folders?.length) {\r\n        const sFolder = new VirtualFileFolder({\r\n          uuid: 'virtual@source@' + source.source,\r\n          name: source.source,\r\n          children: folders,\r\n          types: ['ALL'],\r\n          bucket: source.bucket,\r\n        });\r\n        if (folders.some((f) => f.types.includes('Tile'))) sFolder.types.push('Tile');\r\n        if (folders.some((f) => f.types.includes('AmbientSound'))) sFolder.types.push('AmbientSound');\r\n        folders.forEach((f) => {\r\n          f.folder = sFolder.id;\r\n        });\r\n        allFolders.set(sFolder.uuid, sFolder);\r\n        topLevelFolders.push(sFolder);\r\n      }\r\n    }\r\n\r\n    let tree;\r\n    if (topLevelFolders.length) {\r\n      tree = new PresetTree({\r\n        folders: topLevelFolders,\r\n        presets: [],\r\n        allPresets,\r\n        allFolders,\r\n        hasVisible: allPresets.some((p) => p._visible),\r\n        metaDoc: null,\r\n        pack: null,\r\n      });\r\n\r\n      if (setFormVisibility) tree.setVisibility(type);\r\n    }\r\n\r\n    this._loadedTree = tree;\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n    return tree;\r\n  }\r\n\r\n  /**\r\n   * Build the directory index using the user defined paths to be scanned.\r\n   * Index structure: [{ dir: 'modules', files: [{ name: 'box.webp', tags: [] }], dirs: [] }];\r\n   */\r\n  static async buildIndex() {\r\n    if (this._buildingIndex) {\r\n      ui.notifications.warn('Index Build In-Progress. Wait for it to finish before attempting it again.');\r\n      return;\r\n    }\r\n\r\n    this._buildingIndex = true;\r\n\r\n    ui.notifications.info('Building Mass Edit directory index.');\r\n\r\n    const settings = game.settings.get(MODULE_ID, 'indexer');\r\n\r\n    try {\r\n      const scannedSources = [];\r\n      const foundCaches = [];\r\n\r\n      // Traverse directories specified in settings.indexDirs\r\n      for (const dir of settings.indexDirs) {\r\n        if (dir.source === 'forge-bazaar' || dir.source === 'forgevtt') {\r\n          await this._buildFauxForgeBrowser(dir.source, dir.target);\r\n        }\r\n        let iDir = await this.generateIndex(dir.target, foundCaches, dir.source, dir.bucket, settings);\r\n\r\n        if (iDir) {\r\n          const sPath = dir.target.split('/').filter(Boolean);\r\n          for (let i = sPath.length - 2; i >= 0; i--) {\r\n            iDir = { dir: sPath[i], dirs: [iDir] };\r\n          }\r\n\r\n          let index = scannedSources.find((i) => i.source === dir.source && i.bucket == dir.bucket);\r\n          if (index) this.mergeIndex(index.index, [iDir]);\r\n          else {\r\n            index = { source: dir.source, index: [iDir] };\r\n            if (dir.bucket) index.bucket = dir.bucket;\r\n            scannedSources.push(index);\r\n          }\r\n        }\r\n      }\r\n\r\n      // If pre-generated caches have been found we want to load and merge them here\r\n      for (const cacheFile of foundCaches) {\r\n        const cache = await this.loadIndexCache(cacheFile);\r\n        if (cache) this.mergeCaches(scannedSources, cache);\r\n      }\r\n\r\n      // User can specify if he wants the tags associated with images/video to be retained or not.\r\n      // overrideNullTagsOnly - true - will essentially override user changes to pre-cached directories\r\n      // overrideNullTagsOnly - false - pre-cached directory tags will be ignored, favoring user tags\r\n      const currentCache = await this.loadIndexCache(CACHE_PATH + '/' + CACHE_NAME);\r\n      if (currentCache) {\r\n        this.mergeCaches(scannedSources, currentCache, {\r\n          tagsOnly: true,\r\n          overrideNullTagsOnly: settings.overrideTags,\r\n        });\r\n      }\r\n\r\n      if (scannedSources.length) await this._writeIndexToCache(scannedSources);\r\n      this._loadedTree = null;\r\n\r\n      ui.notifications.info(`MassEdit Index build finished.`);\r\n    } catch (e) {\r\n      console.log(e);\r\n    }\r\n\r\n    this._buildingIndex = false;\r\n  }\r\n\r\n  static mergeCaches(cacheTo, cacheFrom, { tagsOnly = false, overrideNullTagsOnly = false } = {}) {\r\n    for (const indexSourceFrom of cacheFrom) {\r\n      const indexSourceTo = cacheTo.find(\r\n        (i) => i.source === indexSourceFrom.source && i.bucket == indexSourceFrom.bucket\r\n      );\r\n      if (indexSourceTo) {\r\n        this.mergeIndex(indexSourceTo.index, indexSourceFrom.index, {\r\n          tagsOnly,\r\n          overrideNullTagsOnly,\r\n        });\r\n      } else if (!tagsOnly) cacheTo.push(indexSourceFrom);\r\n    }\r\n  }\r\n\r\n  // options to only merge tags if they didn't have any\r\n  static mergeIndex(indexTo, indexFrom, { tagsOnly = false, overrideNullTagsOnly = false } = {}) {\r\n    for (const dirFrom of indexFrom) {\r\n      const dirTo = indexTo.find((dir) => dir.dir === dirFrom.dir);\r\n      if (dirTo) {\r\n        // TODO: We may want to merge customizable fields here\r\n        if (!tagsOnly) {\r\n          dirTo.icon = dirFrom.icon;\r\n          dirTo.subtext = dirFrom.subtext;\r\n        }\r\n\r\n        // Merge directories\r\n        if (dirFrom.dirs) {\r\n          if (dirTo.dirs) {\r\n            this.mergeIndex(dirTo.dirs, dirFrom.dirs, { tagsOnly, overrideNullTagsOnly });\r\n          } else if (!tagsOnly) {\r\n            dirTo.dirs = dirFrom.dirs;\r\n          }\r\n        }\r\n\r\n        // Merge files\r\n        if (dirFrom.files) {\r\n          if (dirTo.files) {\r\n            for (const fileFrom of dirFrom.files) {\r\n              const fileTo = dirTo.files?.find((f) => f.name === fileFrom.name);\r\n\r\n              if (fileTo) {\r\n                // TODO: We may want to merge customizable fields here\r\n                if (!overrideNullTagsOnly || fileTo.tags == null) fileTo.tags = fileFrom.tags;\r\n              } else if (!tagsOnly) {\r\n                if (!dirTo.files) dirTo.files = [];\r\n                dirTo.files.push(fileFrom);\r\n              }\r\n            }\r\n          } else if (!tagsOnly) dirTo.files = dirFrom.files;\r\n        }\r\n      } else if (!tagsOnly) indexTo.push(dirFrom);\r\n    }\r\n  }\r\n\r\n  static async getPreset(uuid) {\r\n    if (!this._loadedTree) await FileIndexer.getVirtualDirectoryTree();\r\n    if (!this._loadedTree) return null;\r\n    return this._loadedTree.allPresets.find((p) => p.uuid === uuid);\r\n  }\r\n\r\n  static async saveIndexToCache(\r\n    folders = this._loadedTree?.folders,\r\n    { path = CACHE_PATH, notify = true, source = 'data' } = {}\r\n  ) {\r\n    if (folders) {\r\n      const cache = [];\r\n      for (const sourceFolder of folders) {\r\n        const sourceCache = {\r\n          source: sourceFolder.name,\r\n          index: sourceFolder.children.map((f) => this._cacheFolder(f)),\r\n        };\r\n        if (sourceFolder.bucket) sourceCache.bucket = sourceFolder.bucket;\r\n        cache.push(sourceCache);\r\n      }\r\n\r\n      this._writeIndexToCache(cache, { path, notify, source });\r\n    }\r\n  }\r\n\r\n  static async _writeIndexToCache(index, { path = CACHE_PATH, notify = true, source = 'data' } = {}) {\r\n    const str = JSON.stringify(index);\r\n\r\n    const tFile = await StringCompress.compress(str);\r\n    await FilePicker.upload(source, path, tFile, {}, { notify });\r\n  }\r\n\r\n  static async saveFolderToCache(folder) {\r\n    if (!(this._loadedTree || folder.indexable || folder.source)) return;\r\n    const allFolders = this._loadedTree.allFolders;\r\n\r\n    let wFolder = folder;\r\n    while (wFolder.folder) {\r\n      let pFolder;\r\n      for (const [uuid, folder] of allFolders) {\r\n        if (folder.id === wFolder.folder) {\r\n          pFolder = folder;\r\n          break;\r\n        }\r\n      }\r\n      if (!pFolder) return;\r\n\r\n      pFolder = new VirtualFileFolder({\r\n        name: pFolder.name,\r\n        folder: pFolder.folder,\r\n      });\r\n      if (wFolder) pFolder.children = [wFolder];\r\n      wFolder = pFolder;\r\n    }\r\n\r\n    this.saveIndexToCache([wFolder], { path: folder.uuid.replace('virtual@', ''), source: folder.source });\r\n  }\r\n\r\n  static _cacheFolder(folder) {\r\n    const fDic = { dir: encodeURIComponentSafely(folder.name) };\r\n    if (folder.presets.length) fDic.files = folder.presets.map((p) => this._cachePreset(p));\r\n    if (folder.children.length) fDic.dirs = folder.children.map((c) => this._cacheFolder(c));\r\n    return fDic;\r\n  }\r\n\r\n  static _cachePreset(preset) {\r\n    const pDic = { name: encodeURIComponentSafely(preset.name) };\r\n    if (preset.tags?.length) pDic.tags = preset.tags;\r\n    return pDic;\r\n  }\r\n\r\n  static async loadIndexCache(cacheFile) {\r\n    let cache;\r\n    try {\r\n      cache = await StringCompress.decompressCache(cacheFile);\r\n    } catch (error) {\r\n      ui.notifications.warn(`Failed to load cache: ` + cacheFile);\r\n    }\r\n    return cache;\r\n  }\r\n\r\n  static async loadMainIndexCache() {\r\n    let path;\r\n    if (typeof ForgeVTT !== 'undefined' && ForgeVTT.usingTheForge) {\r\n      const userId = await ForgeAPI.getUserId();\r\n      path = `https://assets.forge-vtt.com/${userId}/${CACHE_NAME}`;\r\n    } else {\r\n      path = CACHE_PATH + '/' + CACHE_NAME;\r\n    }\r\n    return await this.loadIndexCache(path);\r\n  }\r\n\r\n  static _indexToVirtualFolder(cache, parentDirPath, allFolders, allPresets, options) {\r\n    const fullPath = parentDirPath + '/' + cache.dir;\r\n    const uuid = 'virtual@' + options.prePend + fullPath;\r\n    const fileFolder = new VirtualFileFolder({\r\n      uuid,\r\n      name: cache.dir,\r\n      subtext: cache.subtext,\r\n      icon: cache.icon,\r\n      color: cache.color,\r\n      source: options.source,\r\n      bucket: options.bucket,\r\n    });\r\n\r\n    if (cache.dirs) {\r\n      for (const dir of cache.dirs) {\r\n        const childFolder = this._indexToVirtualFolder(dir, fullPath, allFolders, allPresets, options);\r\n        if (childFolder) {\r\n          childFolder.folder = fileFolder.id;\r\n          fileFolder.children.push(childFolder);\r\n        }\r\n      }\r\n      fileFolder.children.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n    }\r\n\r\n    if (cache.files) {\r\n      for (const file of cache.files) {\r\n        const preset = new VirtualFilePreset({\r\n          name: file.name,\r\n          src: options.prePend + fullPath + '/' + file.name,\r\n          tags: file.tags,\r\n          folder: fileFolder.id,\r\n        });\r\n        allPresets.push(preset);\r\n        fileFolder.presets.push(preset);\r\n      }\r\n    }\r\n\r\n    // Assign folder to categories based on whether the folder itself or\r\n    // it's child folders contain presets of those types\r\n    ['Tile', 'AmbientSound'].forEach((type) => {\r\n      if (\r\n        fileFolder.presets.some((p) => p.documentName === type) ||\r\n        fileFolder.children.some((c) => c.types.includes(type))\r\n      ) {\r\n        fileFolder.types.push(type);\r\n      }\r\n    });\r\n\r\n    allFolders.set(uuid, fileFolder);\r\n    return fileFolder;\r\n  }\r\n\r\n  static async generateIndex(dir, foundCaches = [], source = 'data', bucket = null, settings, options = {}, tags = []) {\r\n    // Get options associated to this specific directory\r\n    let opts = options[dir] ?? {};\r\n    if (opts.noscan) return null;\r\n\r\n    // Get directory contents\r\n    // contents.dirs -> array of children directories\r\n    // contents.files -> array of contained files\r\n    let content;\r\n    try {\r\n      content = await this._browse(source, dir, { bucket });\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n\r\n    const indexerFile = content.files.find((f) => f.endsWith('indexer.json'));\r\n    if (indexerFile) {\r\n      options = (await readJSONFile(indexerFile)) ?? {};\r\n      opts = options[dir] ?? {};\r\n      if (opts.noscan) return null;\r\n    }\r\n\r\n    if (opts.tags) {\r\n      tags = opts.tags\r\n        .map((t) => TagInput.simplifyString(t))\r\n        .filter(Boolean)\r\n        .concat(tags);\r\n    }\r\n\r\n    const folder = {\r\n      dir: dir.split('/').filter(Boolean).pop(),\r\n      dirs: [],\r\n      files: [],\r\n    };\r\n    if (settings.folderFilters.some((k) => folder.dir.includes(k))) return null;\r\n    if (!foundry.utils.isEmpty(opts)) {\r\n      ['color', 'icon', 'subtext'].forEach((k) => {\r\n        if (opts[k]) folder[k] = opts[k];\r\n      });\r\n    }\r\n\r\n    for (let path of content.files) {\r\n      const fileName = path.split('\\\\').pop().split('/').pop();\r\n      if (settings.fileFilters.some((k) => fileName.includes(k))) continue;\r\n\r\n      // Special file processing\r\n\r\n      // Cancel indexing if noscan.txt or cache file is present within the directory\r\n      if (fileName === 'noscan.txt') return null;\r\n      else if (fileName === CACHE_NAME && !settings.ignoreExternal) {\r\n        const cacheDir = settings.cacheDir;\r\n        if (!(cacheDir.target === dir.target && cacheDir.source === source && cacheDir.bucket === bucket)) {\r\n          foundCaches.push(path);\r\n          return null;\r\n        }\r\n      } else if (fileName === 'module.json') {\r\n        // Read metadata from module's json file applying subtext to current folder\r\n        // and tags to all files\r\n        const author = await this._getAuthorFromModule(path);\r\n        if (author) {\r\n          folder.subtext = opts.subtext ?? author;\r\n          const tag = TagInput.simplifyString(author.split(/[ ,\\-_@]+/)[0] ?? '');\r\n          if (tag && tag.length >= 3) {\r\n            tags = [...tags, tag];\r\n            folder.files.forEach((f) => {\r\n              f.tags = tags;\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      // Otherwise process the file\r\n      let ext = fileName.split('.');\r\n      ext = ext[ext.length - 1].toLowerCase();\r\n\r\n      if (FILE_EXTENSIONS.includes(ext)) {\r\n        const f = { name: fileName };\r\n        if (tags.length) f.tags = tags;\r\n        folder.files.push(f);\r\n      }\r\n    }\r\n\r\n    for (let dir of content.dirs) {\r\n      dir = await this.generateIndex(dir, foundCaches, source, bucket, settings, options, tags);\r\n      if (dir) folder.dirs.push(dir);\r\n    }\r\n\r\n    if (!folder.dirs.length) delete folder.dirs;\r\n    if (!folder.files.length) delete folder.files;\r\n\r\n    if (!(folder.dirs || folder.files)) return null;\r\n    return folder;\r\n  }\r\n\r\n  static async _browse(source, dir, options) {\r\n    if (source === 'forge-bazaar' || source === 'forgevtt') {\r\n      return this._fauxForgeBrowser?.get(dir) ?? { dirs: [], files: [] };\r\n    } else {\r\n      return await FilePicker.browse(source, dir, options);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ForgeVTT forge-bazaar can be browsed recursively returning all the found dirs and files at a given path.\r\n   * To keep the processing consistent between different sources however we will simulate FilePicker.browse results\r\n   * by rebuilding the directory structure using the recursively retrieved results.\r\n   * This faux structure will be used by FileIndexer._browse(...)\r\n   * @param {String} source forge-bazaar or forgevtt\r\n   * @param {String} dir\r\n   */\r\n  static async _buildFauxForgeBrowser(source, dir) {\r\n    this._fauxForgeBrowser = new Map();\r\n\r\n    if (typeof ForgeVTT === 'undefined' || !ForgeVTT.usingTheForge) {\r\n      return;\r\n    }\r\n\r\n    // Recursion doesn't work for forge-bazaar paths at one level above root. Perform non-recursive browse\r\n    // and then recursive one on all of the retrieved dirs\r\n    let paths;\r\n    if (source === 'forgevtt' || !['modules', 'systems', 'worlds', 'assets'].includes(dir.replaceAll(/[\\/\\\\]/g, ''))) {\r\n      paths = [dir];\r\n    } else {\r\n      const contents = await FilePicker.browse(source, dir, { recursive: false });\r\n      paths = contents.dirs;\r\n    }\r\n\r\n    const insertFile = (dirs, file) => {\r\n      for (let i = 1; i < dirs.length + 1; i++) {\r\n        const pDirPath = dirs.slice(0, i).join('/');\r\n        const chDirPath = dirs.slice(0, i + 1).join('/');\r\n\r\n        let pDir = this._fauxForgeBrowser.get(pDirPath);\r\n        if (!pDir) {\r\n          pDir = { dirs: [], files: [] };\r\n          this._fauxForgeBrowser.set(pDirPath, pDir);\r\n        }\r\n        if (pDirPath === chDirPath) pDir.files.push(file);\r\n        else if (!pDir.dirs.includes(chDirPath)) pDir.dirs.push(chDirPath);\r\n      }\r\n    };\r\n\r\n    for (const path of paths) {\r\n      const contents = await FilePicker.browse(source, path, { recursive: true });\r\n      for (const file of contents.files) {\r\n        const pathname = new URL(file).pathname;\r\n        const components = pathname.split('/');\r\n        insertFile(components.slice(2, components.length - 1), components.slice(2).join('/'));\r\n      }\r\n    }\r\n  }\r\n\r\n  static async _getAuthorFromModule(moduleFile) {\r\n    const module = await readJSONFile(moduleFile);\r\n    if (module) {\r\n      const author = module.author ?? module.authors?.[0]?.name;\r\n      if (typeof author === 'string') return author;\r\n    }\r\n    return null;\r\n  }\r\n}\r\n\r\nclass StringCompress {\r\n  /**\r\n   * Compresses the provided string using native gzip implementation and return it as a File ready to be uploaded.\r\n   * @param {String} str string to be compressed\r\n   * @returns {File} compressed string file\r\n   */\r\n  static async compress(str) {\r\n    const stream = new Blob([str]).stream();\r\n    const compressedStream = stream.pipeThrough(new CompressionStream('gzip'));\r\n    const chunks = [];\r\n    for await (const chunk of this.streamAsyncIterator(compressedStream)) {\r\n      chunks.push(chunk);\r\n    }\r\n    const blob = new Blob(chunks);\r\n    const file = new File([blob], CACHE_NAME);\r\n    return file;\r\n  }\r\n\r\n  /**\r\n   * Decompressed provided compressed json file\r\n   * @param {String} filePath path to the compressed json file\r\n   * @returns {Object} decompressed and parsed json object\r\n   */\r\n  static async decompressCache(filePath) {\r\n    let cache;\r\n    try {\r\n      const response = await fetch(filePath);\r\n      if (response.ok) {\r\n        const str = await this.decompress(response.body);\r\n        cache = JSON.parse(str);\r\n      }\r\n    } catch (e) {}\r\n    return cache;\r\n  }\r\n\r\n  static async decompress(stream) {\r\n    const decompressedStream = stream.pipeThrough(new DecompressionStream('gzip'));\r\n    const chunks = [];\r\n    for await (const chunk of this.streamAsyncIterator(decompressedStream)) {\r\n      chunks.push(chunk);\r\n    }\r\n    const stringBytes = await this.concatUint8Arrays(chunks);\r\n    return new TextDecoder().decode(stringBytes);\r\n  }\r\n\r\n  static async concatUint8Arrays(uint8arrays) {\r\n    const blob = new Blob(uint8arrays);\r\n    const buffer = await blob.arrayBuffer();\r\n    return new Uint8Array(buffer);\r\n  }\r\n\r\n  static async *streamAsyncIterator(stream) {\r\n    const reader = stream.getReader();\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) return;\r\n        yield value;\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Form to help configure and execute index build.\r\n */\r\nexport class IndexerForm extends FormApplication {\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/indexer.html`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return 'Directory Indexer';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    const data = foundry.utils.deepClone(game.settings.get(MODULE_ID, 'indexer'));\r\n    data.fileFilters = data.fileFilters.join(', ');\r\n    data.folderFilters = data.folderFilters.join(', ');\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.on('click', '.addDirectory', this._onAddDirectory.bind(this));\r\n    html.on('click', '.deleteDirectory', this._onDeleteDirectory.bind(this));\r\n    html.on('input', '[name=\"fileFilters\"]', this._onFileFiltersChange.bind(this));\r\n    html.on('input', '[name=\"folderFilters\"]', this._onFolderFiltersChange.bind(this));\r\n    html.find('input[type=\"checkbox\"]').on('change', this._onToggleCheckbox.bind(this));\r\n  }\r\n\r\n  _onToggleCheckbox(event) {\r\n    const chkBox = $(event.currentTarget);\r\n    const name = chkBox.attr('name');\r\n    this._updateIndexerSettings({ [name]: chkBox.is(':checked') }, false);\r\n  }\r\n\r\n  _onFileFiltersChange(event) {\r\n    clearTimeout(this._onInputTimeOut);\r\n    this._onInputTimeOut = setTimeout(() => {\r\n      const fileFilters = $(event.currentTarget)\r\n        .val()\r\n        .split(',')\r\n        .map((f) => f.trim())\r\n        .filter(Boolean);\r\n      this._updateIndexerSettings({ fileFilters }, false);\r\n    }, 500);\r\n  }\r\n\r\n  _onFolderFiltersChange(event) {\r\n    clearTimeout(this._onInputTimeOut);\r\n    this._onInputTimeOut = setTimeout(() => {\r\n      const folderFilters = $(event.currentTarget)\r\n        .val()\r\n        .split(',')\r\n        .map((f) => f.trim())\r\n        .filter(Boolean);\r\n      this._updateIndexerSettings({ folderFilters }, false);\r\n    }, 500);\r\n  }\r\n\r\n  async _onAddDirectory() {\r\n    this.selectFolder(async (selection) => {\r\n      if (!selection) return;\r\n      if (!selection.bucket) delete selection.bucket;\r\n\r\n      if (!['data', 'public', 'forge-bazaar', 'forgevtt', 's3'].includes(selection.source)) {\r\n        ui.notifications.warn(`${selection.source} is not a supported source.`);\r\n        return;\r\n      }\r\n\r\n      const indexDirs = game.settings.get(MODULE_ID, 'indexer').indexDirs;\r\n      // Make sure the selection is unique\r\n      if (\r\n        indexDirs.find(\r\n          (id) => id.source === selection.source && id.target === selection.target && id.bucket == selection.bucket\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      indexDirs.push(selection);\r\n      this._updateIndexerSettings({ indexDirs });\r\n    });\r\n  }\r\n\r\n  async _onDeleteDirectory(event) {\r\n    const directory = $(event.target).closest('.directory');\r\n    const source = directory.find('.source').val();\r\n    const target = directory.find('.target').val();\r\n    const bucket = directory.find('.bucket').val() || null;\r\n\r\n    const indexDirs = game.settings\r\n      .get(MODULE_ID, 'indexer')\r\n      .indexDirs.filter((id) => !(id.source === source && id.target === target && id.bucket == bucket));\r\n\r\n    this._updateIndexerSettings({ indexDirs });\r\n  }\r\n\r\n  async _updateIndexerSettings(update = {}, render = true) {\r\n    const settings = game.settings.get(MODULE_ID, 'indexer');\r\n    foundry.utils.mergeObject(settings, update);\r\n    await game.settings.set(MODULE_ID, 'indexer', settings);\r\n    if (render) await this.render();\r\n  }\r\n\r\n  async selectFolder(callback) {\r\n    new FilePicker({\r\n      type: 'folder',\r\n      activeSource: 'data',\r\n      current: '',\r\n      callback: (path, fp) => {\r\n        const selection = { target: fp.result.target, source: fp.activeSource, bucket: fp.result.bucket };\r\n        if (!selection.bucket) delete selection.bucket;\r\n        callback(selection);\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    FileIndexer.buildIndex();\r\n  }\r\n}\r\n\r\nexport class FileIndexerAPI {\r\n  static async readCacheFile(cacheFile) {\r\n    return FileIndexer.loadIndexCache(cacheFile);\r\n  }\r\n}\r\n","class TrackerDialog extends Dialog {\r\n  constructor(options, { total, cancelCallback, left, top }) {\r\n    super(options, { left, top });\r\n    this.count = 0;\r\n    this.total = total;\r\n    this.cancelCallback = cancelCallback;\r\n  }\r\n\r\n  incrementCount() {\r\n    this.count++;\r\n    this.element?.find('.count').html(this.count);\r\n  }\r\n\r\n  stop() {\r\n    this.close(true);\r\n  }\r\n\r\n  get active() {\r\n    return this._state === Application.RENDER_STATES.RENDERED || this._state === Application.RENDER_STATES.RENDERING;\r\n  }\r\n}\r\n\r\nexport async function trackProgress({ title = 'Progress', cancelCallback, total } = {}) {\r\n  if (!total) return;\r\n\r\n  let content = `\r\n<div>\r\n<div  style=\"display: block; text-align: center; padding: 5px;\"><i class=\"fas fa-circle-notch fa-spin fa-3x\"></i></div>\r\n    <p style=\"text-align: center;\"><span class=\"count\">count</span>/${total}</p>\r\n</div>`;\r\n\r\n  const dialog = new TrackerDialog(\r\n    {\r\n      title,\r\n      content,\r\n      buttons: {\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-stop\"></i>',\r\n          label: 'Stop/Cancel',\r\n          callback: () => {\r\n            cancelCallback?.();\r\n          },\r\n        },\r\n      },\r\n      default: 'cancel',\r\n    },\r\n    { total, cancelCallback, left: 50, top: 50 }\r\n  );\r\n\r\n  await dialog._render(true);\r\n\r\n  return dialog;\r\n}\r\n\r\nexport function countFolderItems(folder) {\r\n  if (folder.presets) {\r\n    return (\r\n      folder.presets.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c);\r\n      }, 0)\r\n    );\r\n  } else {\r\n    return (\r\n      folder.contents.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c.folder);\r\n      }, 0)\r\n    );\r\n  }\r\n}\r\n","/**\r\n * A collection of functions related to sorting objects within a parent container.\r\n */\r\nexport class SortingHelpersFixed {\r\n  /**\r\n   * Given a source object to sort, a target to sort relative to, and an Array of siblings in the container:\r\n   * Determine the updated sort keys for the source object, or all siblings if a reindex is required.\r\n   * Return an Array of updates to perform, it is up to the caller to dispatch these updates.\r\n   * Each update is structured as:\r\n   * {\r\n   *   target: object,\r\n   *   update: {sortKey: sortValue}\r\n   * }\r\n   *\r\n   * @param {object} source       The source object being sorted\r\n   * @param {object} [options]    Options which modify the sort behavior\r\n   * @param {object|null} [options.target]  The target object relative which to sort\r\n   * @param {object[]} [options.siblings]   The Array of siblings which the source should be sorted within\r\n   * @param {string} [options.sortKey=sort] The property name within the source object which defines the sort key\r\n   * @param {boolean} [options.sortBefore]  Explicitly sort before (true) or sort after( false).\r\n   *                                        If undefined the sort order will be automatically determined.\r\n   * @returns {object[]}          An Array of updates for the caller of the helper function to perform\r\n   */\r\n  static performIntegerSort(\r\n    source,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > 1) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: Math.round(0.5 * (min + max)) },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Reindex all siblings\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, source);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  static performIntegerSortMulti(\r\n    sources,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    let source = sources[0];\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY * (sources.length - i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > sources.length) {\r\n      let increment = Math.floor((1 / (sources.length + 1)) * Math.abs(max - min));\r\n      if (increment === 0) increment = 1;\r\n      min = Math.min(max, min);\r\n\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + increment * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Reindex all\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, ...sources);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort before the target\r\n   * @private\r\n   */\r\n  static _sortBefore(siblings, idx, sortKey) {\r\n    let max = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let min = siblings[idx - 1] ? siblings[idx - 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort after the target\r\n   * @private\r\n   */\r\n  static _sortAfter(siblings, idx, sortKey) {\r\n    let min = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let max = siblings[idx + 1] ? siblings[idx + 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { MassEditPresets } from './forms.js';\r\n\r\nexport class TagSelector extends FormApplication {\r\n  constructor(presetsApp) {\r\n    const defaultOptions = TagSelector.defaultOptions;\r\n    super({}, { left: presetsApp.position.left - defaultOptions.width - 5, top: presetsApp.position.top });\r\n    this.presetsApp = presetsApp;\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'tag-selector',\r\n      classes: ['mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/tagSelector.html`,\r\n      resizable: true,\r\n      minimizable: true,\r\n      width: 200,\r\n      height: 500,\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return 'Tag Selector';\r\n  }\r\n\r\n  async close(options = {}) {\r\n    this.presetsApp._tagSelector = null;\r\n    return super.close(options);\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    const tagMap = this.getTagsOfRendered();\r\n    const searchedTagsArr = this.getSearchedTags();\r\n\r\n    let tags = [];\r\n    let activeTags = [];\r\n    tagMap.forEach((count, tag) => {\r\n      const t = { name: tag, count };\r\n      if (searchedTagsArr.includes(tag)) activeTags.push(t);\r\n      else tags.push(t);\r\n    });\r\n\r\n    tags = tags.sort((t1, t2) => t2.count - t1.count);\r\n    activeTags = activeTags.sort((t1, t2) => t2.count - t1.count);\r\n\r\n    return { tags, activeTags };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.on('click', '.tag', this._onClickTag.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Collate all tags of render-able presets\r\n   */\r\n  getTagsOfRendered() {\r\n    const tags = new Map();\r\n\r\n    this.presetsApp.tree.folders.forEach((f) => this._getFolderTags(f, tags));\r\n    this.presetsApp.tree.extFolders.forEach((f) => this._getFolderTags(f, tags));\r\n    this.presetsApp.tree.presets.forEach((p) => this._getPresetTags(p, tags));\r\n\r\n    return tags;\r\n  }\r\n\r\n  getSearchedTags() {\r\n    const search = MassEditPresets.lastSearch ?? '';\r\n    const tags = search\r\n      .split(' ')\r\n      .filter((k) => k.startsWith('#'))\r\n      .map((k) => k.substring(1));\r\n    return tags;\r\n  }\r\n\r\n  _getFolderTags(folder, tags) {\r\n    if (!folder.render) return;\r\n\r\n    for (const f of folder.children) {\r\n      this._getFolderTags(f, tags);\r\n    }\r\n\r\n    for (const p of folder.presets) {\r\n      this._getPresetTags(p, tags);\r\n    }\r\n  }\r\n\r\n  _getPresetTags(preset, tags) {\r\n    if (preset.visible) {\r\n      for (const tag of preset.tags) {\r\n        tags.set(tag, (tags.get(tag) ?? 0) + 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  _onClickTag(event) {\r\n    const tag = '#' + $(event.currentTarget).find('span').first().text();\r\n\r\n    const searchInput = this.presetsApp.element.find('.header-search input');\r\n    let search = searchInput.val();\r\n\r\n    if ($(event.currentTarget).hasClass('active')) {\r\n      search = search\r\n        .split(' ')\r\n        .filter((k) => k !== tag)\r\n        .filter(Boolean)\r\n        .join(' ');\r\n    } else {\r\n      if (!search.endsWith(' ') && search.length) search += ' ';\r\n      search += tag;\r\n    }\r\n\r\n    searchInput.val(search).trigger('input');\r\n  }\r\n}\r\n","import { TokenDataAdapter } from '../../applications/dataAdapters.js';\r\nimport { copyToClipboard, pasteDataUpdate } from '../../applications/formUtils.js';\r\nimport { getMassEditForm, showMassEdit } from '../../applications/multiConfig.js';\r\nimport { countFolderItems, trackProgress } from '../../applications/progressDialog.js';\r\nimport { BrushMenu } from '../brush.js';\r\nimport { importPresetFromJSONDialog } from '../dialogs.js';\r\nimport { SortingHelpersFixed } from '../fixedSort.js';\r\nimport { TagInput, applyPresetToScene, isAudio, localFormat, localize } from '../utils.js';\r\nimport {\r\n  VirtualFileFolder,\r\n  META_INDEX_ID,\r\n  PresetAPI,\r\n  PresetCollection,\r\n  PresetPackFolder,\r\n  PresetFolder,\r\n} from './collection.js';\r\nimport { FileIndexer, IndexerForm } from './fileIndexer.js';\r\nimport { LinkerAPI } from '../linker/linker.js';\r\nimport { DOC_ICONS, Preset, VirtualFilePreset } from './preset.js';\r\nimport { TagSelector } from './tagSelector.js';\r\nimport {\r\n  FolderState,\r\n  isVideo,\r\n  mergePresetDataToDefaultDoc,\r\n  placeableToData,\r\n  randomizeChildrenFolderColors,\r\n} from './utils.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES, UI_DOCS } from '../constants.js';\r\n\r\nconst SEARCH_MIN_CHAR = 2;\r\nconst SEARCH_FOUND_MAX_COUNT = 1001;\r\n\r\n// const FLAG_DATA = {\r\n//   documentName: null,\r\n//   data: null,\r\n//   addSubtract: null,\r\n//   randomize: null,\r\n// };\r\n\r\nconst SORT_MODES = {\r\n  manual: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeManual', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-short-wide\"></i>',\r\n  },\r\n  alphabetical: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeAlpha', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-a-z\"></i>',\r\n  },\r\n};\r\n\r\nconst SEARCH_MODES = {\r\n  p: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets');\r\n    },\r\n    icon: '<i class=\"fas fa-search\"></i>',\r\n  },\r\n  pf: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets-folders');\r\n    },\r\n    icon: '<i class=\"fa-solid fa-folder-magnifying-glass\"></i>',\r\n  },\r\n};\r\n\r\nexport class MassEditPresets extends FormApplication {\r\n  static objectHover = false;\r\n  static lastSearch;\r\n\r\n  constructor(configApp, callback, documentName, options = {}) {\r\n    // Restore position and dimensions the previously closed window\r\n    if (!options.preventPositionOverride && MassEditPresets.previousPosition) {\r\n      options = { ...options, ...MassEditPresets.previousPosition };\r\n    }\r\n\r\n    super({}, options);\r\n    this.callback = callback;\r\n\r\n    // Drag/Drop tracking\r\n    this.dragType = null;\r\n    this.dragData = null;\r\n    this.draggedElements = null;\r\n\r\n    if (!configApp && UI_DOCS.includes(documentName)) {\r\n      const docLock = game.settings.get(MODULE_ID, 'presetDocLock');\r\n      this.documentName = docLock || documentName;\r\n    } else {\r\n      this.configApp = configApp;\r\n      this.documentName = documentName || this.configApp.documentName;\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-presets',\r\n      classes: ['sheet', 'mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presets.html`,\r\n      resizable: true,\r\n      minimizable: true,\r\n      width: 377,\r\n      height: 900,\r\n      scrollY: ['.item-list'],\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    let title = localize('common.presets');\r\n    if (!UI_DOCS.includes(this.documentName)) title += ` [${this.documentName}]`;\r\n    else title += ` [${localize('common.placeable')}]`;\r\n    return title;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/preset.html`, 'me-preset');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/presetFolder.html`, 'me-preset-folder');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/presetsContent.html`, 'me-presets-content');\r\n\r\n    const displayExtCompendiums = game.settings.get(MODULE_ID, 'presetExtComp');\r\n    const displayVirtualDirectory = game.settings.get(MODULE_ID, 'presetVirtualDir');\r\n\r\n    this.tree = await PresetCollection.getTree(this.documentName, {\r\n      externalCompendiums: displayExtCompendiums,\r\n      virtualDirectory: displayVirtualDirectory,\r\n      setFormVisibility: true,\r\n    });\r\n    this._tagSelector?.render(true);\r\n\r\n    data.presets = this.tree.presets;\r\n    data.folders = this.tree.folders;\r\n    data.extFolders = this.tree.extFolders.length ? this.tree.extFolders : null;\r\n\r\n    data.createEnabled = Boolean(this.configApp);\r\n    data.isPlaceable =\r\n      SUPPORTED_PLACEABLES.includes(this.documentName) ||\r\n      this.documentName === 'ALL' ||\r\n      this.documentName === 'FAVORITES';\r\n    data.allowDocumentSwap = UI_DOCS.includes(this.documentName) && !this.configApp;\r\n    data.docLockActive = game.settings.get(MODULE_ID, 'presetDocLock') === this.documentName;\r\n    data.layerSwitchActive = game.settings.get(MODULE_ID, 'presetLayerSwitch');\r\n    data.scaling = game.settings.get(MODULE_ID, 'presetScaling');\r\n    data.extCompActive = displayExtCompendiums;\r\n    data.virtDirActive = displayVirtualDirectory;\r\n    data.sortMode = SORT_MODES[game.settings.get(MODULE_ID, 'presetSortMode')];\r\n    data.searchMode = SEARCH_MODES[game.settings.get(MODULE_ID, 'presetSearchMode')];\r\n    data.displayDragDropMessage =\r\n      data.allowDocumentSwap && !(this.tree.presets.length || this.tree.folders.length || data.extFolders);\r\n\r\n    data.lastSearch = MassEditPresets.lastSearch;\r\n\r\n    data.docs = UI_DOCS.reduce((obj, key) => {\r\n      return {\r\n        ...obj,\r\n        [key]: DOC_ICONS[key],\r\n      };\r\n    }, {});\r\n\r\n    data.documents = UI_DOCS;\r\n    data.currentDocument = this.documentName;\r\n\r\n    data.callback = Boolean(this.callback);\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          MassEditPresets.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          MassEditPresets.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        hoverOverlay.hide();\r\n        MassEditPresets.objectHover = false;\r\n      });\r\n\r\n    // Create Preset from Selected\r\n    html.find('.create-preset').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // =====================\r\n    // Preset multi-select & drag Listeners\r\n    const itemList = html.find('.item-list');\r\n\r\n    // Multi-select\r\n    html.on('click', '.item', (event) => {\r\n      itemSelect(event, itemList);\r\n      if (this._activeBrush) this._toggleBrush(event);\r\n    });\r\n\r\n    // Hide/Show preset tags and favorite control\r\n    html.on('mouseenter', '.item', (event) => {\r\n      $(event.currentTarget).find('.tags, .display-hover').addClass('show');\r\n      this._playPreview(event);\r\n    });\r\n\r\n    html.on('mouseleave', '.item', (event) => {\r\n      $(event.currentTarget).find('.tags, .display-hover').removeClass('show');\r\n      this._endPreview(event);\r\n    });\r\n\r\n    html.on('dragstart', '.item', (event) => {\r\n      this.dragType = 'item';\r\n\r\n      const item = $(event.target).closest('.item');\r\n\r\n      // Drag has been started on an item that hasn't been selected\r\n      // Assume that this is the only item to be dragged and select it\r\n      if (!item.hasClass('selected')) {\r\n        itemList.find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n        item.addClass('selected').addClass('last-selected');\r\n      }\r\n\r\n      const uuids = [];\r\n      itemList.find('.item.selected').each(function () {\r\n        uuids.push($(this).data('uuid'));\r\n      });\r\n      this.dragData = uuids;\r\n      this.draggedElements = itemList.find('.item.selected');\r\n\r\n      if (event.originalEvent.dataTransfer) {\r\n        event.originalEvent.dataTransfer.clearData();\r\n        event.originalEvent.dataTransfer.setData('text/plain', JSON.stringify({ uuids }));\r\n      }\r\n    });\r\n    html.on('dragleave', '.item.sortable', (event) => {\r\n      $(event.target).closest('.item').removeClass('drag-bot').removeClass('drag-top');\r\n    });\r\n\r\n    html.on('dragover', '.item.sortable', (event) => {\r\n      if (this.dragType !== 'item') return;\r\n      if (!this.draggedElements.hasClass('sortable')) return;\r\n\r\n      const targetItem = $(event.target).closest('.item');\r\n\r\n      // Check that we're not above a selected item  (i.e. item being dragged)\r\n      if (targetItem.hasClass('selected')) return;\r\n\r\n      // Determine if mouse is hovered over top, middle, or bottom\r\n      var domRect = event.currentTarget.getBoundingClientRect();\r\n      let prc = event.offsetY / domRect.height;\r\n\r\n      if (prc < 0.2) {\r\n        targetItem.removeClass('drag-bot').addClass('drag-top');\r\n      } else if (prc > 0.8) {\r\n        targetItem.removeClass('drag-top').addClass('drag-bot');\r\n      }\r\n    });\r\n\r\n    html.on('drop', '.item.sortable', (event) => {\r\n      if (MassEditPresets.lastSearch?.length) return; // Prevent drops while searching\r\n      if (this.dragType !== 'item') return;\r\n      if (!this.draggedElements.hasClass('sortable')) return;\r\n\r\n      const targetItem = $(event.target).closest('.item');\r\n\r\n      const top = targetItem.hasClass('drag-top');\r\n      targetItem.removeClass('drag-bot').removeClass('drag-top');\r\n\r\n      const uuids = this.dragData;\r\n      if (uuids) {\r\n        if (!targetItem.hasClass('selected')) {\r\n          // Move HTML Elements\r\n          (top ? uuids : uuids.reverse()).forEach((uuid) => {\r\n            const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n            if (item) {\r\n              if (top) item.insertBefore(targetItem);\r\n              else item.insertAfter(targetItem);\r\n            }\r\n          });\r\n\r\n          this._onItemSort(uuids, targetItem.data('uuid'), {\r\n            before: top,\r\n            folderUuid: targetItem.closest('.folder').data('uuid'),\r\n          });\r\n        }\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n\r\n    html.on('dragend', '.item', (event) => {\r\n      if (!checkMouseInWindow(event)) {\r\n        this._onPresetDragOut(event);\r\n      }\r\n    });\r\n\r\n    // ================\r\n    // Folder Listeners\r\n    html.on('click', '.folder > header', (event) => this._folderToggle($(event.target).closest('.folder')));\r\n\r\n    html.on('dragstart', '.folder.sortable', (event) => {\r\n      if (this.dragType == 'item') return;\r\n      this.dragType = 'folder';\r\n\r\n      const folder = $(event.target).closest('.folder');\r\n      const uuids = [folder.data('uuid')];\r\n\r\n      $(event.target)\r\n        .find('.folder')\r\n        .each(function () {\r\n          uuids.push($(this).data('uuid'));\r\n        });\r\n\r\n      this.dragData = uuids;\r\n    });\r\n\r\n    html.on('dragleave', '.folder.sortable header', (event) => {\r\n      $(event.target).closest('.folder').removeClass('drag-mid').removeClass('drag-top');\r\n    });\r\n\r\n    html.on('dragover', '.folder.sortable header', (event) => {\r\n      const targetFolder = $(event.target).closest('.folder');\r\n\r\n      if (this.dragType === 'folder') {\r\n        // Check that we're not above folders being dragged\r\n        if (this.dragData.includes(targetFolder.data('uuid'))) return;\r\n\r\n        // Determine if mouse is hovered over top, middle, or bottom\r\n        var domRect = event.currentTarget.getBoundingClientRect();\r\n        let prc = event.offsetY / domRect.height;\r\n\r\n        if (prc < 0.2) {\r\n          targetFolder.removeClass('drag-mid').addClass('drag-top');\r\n        } else {\r\n          targetFolder.removeClass('drag-top').addClass('drag-mid');\r\n        }\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n        targetFolder.addClass('drag-mid');\r\n      }\r\n    });\r\n\r\n    html.on('drop', '.folder.sortable header', (event) => {\r\n      if (this._foundryDrop(event)) return;\r\n      if (MassEditPresets.lastSearch?.length) return; // Prevent drops while searching\r\n\r\n      const targetFolder = $(event.target).closest('.folder');\r\n\r\n      if (this.dragType === 'folder') {\r\n        const top = targetFolder.hasClass('drag-top');\r\n        targetFolder.removeClass('drag-mid').removeClass('drag-top');\r\n\r\n        const uuids = this.dragData;\r\n        if (uuids) {\r\n          if (uuids.includes(targetFolder.data('uuid'))) return;\r\n\r\n          const uuid = uuids[0];\r\n          const folder = html.find(`.folder[data-uuid=\"${uuid}\"]`);\r\n          if (folder) {\r\n            // Move HTML Elements\r\n            if (top) folder.insertBefore(targetFolder);\r\n            else targetFolder.find('.folder-items').first().append(folder);\r\n\r\n            if (top) {\r\n              this._onFolderSort(uuid, targetFolder.data('uuid'), {\r\n                inside: false,\r\n                folderUuid: targetFolder.parent().closest('.folder').data('uuid') ?? null,\r\n              });\r\n            } else {\r\n              this._onFolderSort(uuid, null, {\r\n                inside: true,\r\n                folderUuid: targetFolder.data('uuid'),\r\n              });\r\n            }\r\n          }\r\n        }\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n        targetFolder.removeClass('drag-mid');\r\n        const uuids = this.dragData;\r\n\r\n        // Move HTML Elements\r\n        const presetItems = targetFolder.children('.preset-items');\r\n        uuids?.forEach((uuid) => {\r\n          const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n          if (item.length) presetItems.append(item);\r\n        });\r\n\r\n        this._onItemSort(uuids, null, {\r\n          folderUuid: targetFolder.data('uuid'),\r\n        });\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n\r\n    html.on('drop', '.top-level-preset-items', (event) => {\r\n      if (this._foundryDrop(event)) return;\r\n      if (MassEditPresets.lastSearch?.length) return; // Prevent drops while searching\r\n      if (this.dragType === 'folder') {\r\n        // Move HTML Elements\r\n        const target = html.find('.top-level-folder-items');\r\n        const folder = html.find(`.folder[data-uuid=\"${this.dragData[0]}\"]`);\r\n        target.append(folder);\r\n\r\n        this._onFolderSort(this.dragData[0], null);\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n        const uuids = this.dragData;\r\n\r\n        // Move HTML Elements\r\n        const target = html.find('.top-level-preset-items');\r\n        uuids?.forEach((uuid) => {\r\n          const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n          if (item.length) target.append(item);\r\n        });\r\n\r\n        this._onItemSort(uuids, null);\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n    // End of Folder Listeners\r\n    // ================\r\n\r\n    html.on('click', '.toggle-sort', this._onToggleSort.bind(this));\r\n    html.on('click', '.toggle-doc-lock', this._onToggleLock.bind(this));\r\n    html.on('click', '.toggle-ext-comp', this._onToggleExtComp.bind(this));\r\n    html.on('click', '.toggle-virtual-dir', this._onToggleVirtDir.bind(this));\r\n    html.on('click', '.toggle-scaling', this._onToggleScaling.bind(this));\r\n    html.on('click', '.toggle-layer-switch', this._onToggleLayerSwitch.bind(this));\r\n    html.on('click', '.document-select', this._onDocumentChange.bind(this));\r\n    html.on('dblclick', '.item', this._onDoubleClickPreset.bind(this));\r\n    html.on('click', '.create-folder', this._onCreateFolder.bind(this));\r\n    html.on('click', '.preset-create', this._onPresetCreate.bind(this));\r\n    html.on('click', '.preset-update a', this._onPresetUpdate.bind(this));\r\n    html.on('click', '.preset-favorite', this._onToggleFavorite.bind(this));\r\n    html.on('click', '.preset-callback', this._onApplyPreset.bind(this));\r\n    html.on('click', '.tagSelector', this._onToggleTagSelector.bind(this));\r\n\r\n    const headerSearch = html.find('.header-search input');\r\n    headerSearch.on('input', (event) => this._onSearchInput(event));\r\n    if ((MassEditPresets.lastSearch?.length ?? 0) >= SEARCH_MIN_CHAR) headerSearch.trigger('input');\r\n\r\n    html.on('click', '.toggle-search-mode', (event) => {\r\n      this._onToggleSearch(event, headerSearch);\r\n    });\r\n\r\n    // Activate context menu\r\n    this._contextMenu(html.find('.item-list'));\r\n  }\r\n\r\n  async _playPreview(event) {\r\n    clearTimeout(this._previewTimeout);\r\n    this._previewTimeout = setTimeout(() => this._renderPlayPreview(event), 200);\r\n  }\r\n\r\n  async _renderPlayPreview(event) {\r\n    await this._endPreview();\r\n    const uuid = $(event.currentTarget).data('uuid');\r\n    if (!uuid) return;\r\n\r\n    const preset = await PresetCollection.get(uuid, { full: false });\r\n    if (preset.documentName === 'AmbientSound') {\r\n      const src = isAudio(preset.img) ? preset.img : (await preset.load()).data[0]?.path;\r\n      if (!src) return;\r\n      const sound = await game.audio.play(src);\r\n      sound._mePreview = true;\r\n    } else if (preset.documentName === 'Tile' && preset.thumbnail === 'icons/svg/video.svg') {\r\n      await preset.load();\r\n      const src = preset.data[0].texture?.src;\r\n      if (src && isVideo(src)) {\r\n        if (!this._videoPreviewElement) {\r\n          this._videoPreviewElement = $('<div class=\"meVideoPreview\"></div>');\r\n          $(document.body).append(this._videoPreviewElement);\r\n        } else {\r\n          this._videoPreviewElement.empty();\r\n        }\r\n\r\n        const ratio = visualViewport.width / 1024;\r\n        this._videoPreviewElement.append(\r\n          `<video width=\"${320 * ratio}\" height=\"${240 * ratio}\" autoplay loop><source src=\"${src}\" type=\"video/${src\r\n            .split('.')\r\n            .pop()\r\n            .toLowerCase()}\"></video>`\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  async _endPreview() {\r\n    clearTimeout(this._previewTimeout);\r\n    game.audio.playing.forEach((s) => {\r\n      if (s._mePreview) s.stop();\r\n    });\r\n    if (this._videoPreviewElement) {\r\n      this._videoPreviewElement.remove();\r\n      this._videoPreviewElement = null;\r\n    }\r\n  }\r\n\r\n  _folderToggle(folderElement) {\r\n    const uuid = folderElement.data('uuid');\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder.expanded) this._folderCollapse(folderElement, folder);\r\n    else this._folderExpand(folderElement, folder);\r\n  }\r\n\r\n  async _folderExpand(folderElement, folder) {\r\n    FolderState.setExpanded(folder.uuid, true);\r\n    folder.expanded = true;\r\n\r\n    if (folderElement.find('.folder-items').length) {\r\n      folderElement.removeClass('collapsed');\r\n      folderElement.find('header .folder-icon').first().removeClass('fa-folder-closed').addClass('fa-folder-open');\r\n    } else {\r\n      let content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/presetFolder.html`, {\r\n        folder,\r\n        createEnabled: Boolean(this.configApp),\r\n        callback: Boolean(this.callback),\r\n        sortable: fromUuidSync(folder.uuid)?.pack === PresetCollection.workingPack,\r\n      });\r\n      folderElement.replaceWith(content);\r\n    }\r\n  }\r\n\r\n  _folderCollapse(folderElement, folder) {\r\n    folderElement.addClass('collapsed');\r\n    folderElement.find('header .folder-icon').first().removeClass('fa-folder-open').addClass('fa-folder-closed');\r\n\r\n    FolderState.setExpanded(folder.uuid, false);\r\n    folder.expanded = false;\r\n  }\r\n\r\n  /**\r\n   * Process drag and drop of an Actor or Folder of actors\r\n   * @param {*} event\r\n   * @returns\r\n   */\r\n  _foundryDrop(event) {\r\n    const data = TextEditor.getDragEventData(event.originalEvent);\r\n    if (!isEmpty(data)) {\r\n      if (data.type === 'Folder') {\r\n        const folder = fromUuidSync(data.uuid);\r\n        if (folder.type !== 'Actor') return false;\r\n        if (this._importTracker?.active) return false;\r\n\r\n        trackProgress({\r\n          title: 'Converting Actors',\r\n          total: countFolderItems(folder),\r\n        }).then(async (tracker) => {\r\n          this._importTracker = tracker;\r\n          await this._importActorFolder(folder, null, { keepId: true });\r\n          this._importTracker?.stop();\r\n        });\r\n        return true;\r\n      } else if (data.type === 'Actor') {\r\n        PresetAPI.createPresetFromActorUuid(data.uuid, { keepId: true }).then((preset) => {\r\n          if (preset) this.render(true);\r\n        });\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  async _importActorFolder(folder, parentFolder = null, options = {}) {\r\n    let nFolder = new Folder.implementation(\r\n      {\r\n        _id: options.keepId ? folder.id : null,\r\n        name: folder.name,\r\n        type: 'JournalEntry',\r\n        sorting: folder.sorting,\r\n        folder: parentFolder,\r\n        color: folder.color ?? '#000000',\r\n        flags: { [MODULE_ID]: { types: ['ALL', 'Token'] } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    nFolder = await Folder.create(nFolder, {\r\n      pack: nFolder.pack,\r\n      keepId: options.keepId,\r\n    });\r\n\r\n    for (const child of folder.children) {\r\n      if (!this._importTracker?.active) break;\r\n      await this._importActorFolder(child.folder, nFolder.id, options);\r\n    }\r\n\r\n    for (const actor of folder.contents) {\r\n      if (!this._importTracker?.active) break;\r\n      await PresetAPI.createPresetFromActorUuid(actor.uuid, {\r\n        folder: nFolder.id,\r\n        keepId: options.keepId,\r\n      });\r\n      this._importTracker.incrementCount();\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onDoubleClickPreset(event) {\r\n    BrushMenu.close();\r\n\r\n    const item = $(event.target).closest('.item');\r\n    const uuid = item.data('uuid');\r\n    if (!uuid) return;\r\n\r\n    let preset = await PresetAPI.getPreset({ uuid });\r\n\r\n    if (!preset) return;\r\n\r\n    if (preset.documentName === 'Scene') {\r\n      ui.notifications.info(`Mass Edit: ${localize('common.apply')} [${preset.name}]`);\r\n      applyPresetToScene(preset);\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    ui.notifications.info(`Mass Edit: ${localize('presets.spawning')} [${preset.name}]`);\r\n\r\n    this._setInteractivityState(false);\r\n    await PresetAPI.spawnPreset({\r\n      preset,\r\n      coordPicker: true,\r\n      taPreview: 'ALL',\r\n      layerSwitch: game.settings.get(MODULE_ID, 'presetLayerSwitch'),\r\n      scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n      center: true,\r\n    });\r\n    this._setInteractivityState(true);\r\n  }\r\n\r\n  /**\r\n   * Sets the window app as translucent and inactive to mouse pointer events\r\n   * @param {Boolean} state true = active, false = inactive\r\n   */\r\n  _setInteractivityState(state) {\r\n    if (state) this.element.removeClass('inactive');\r\n    else this.element.addClass('inactive');\r\n  }\r\n\r\n  _contextMenu(html) {\r\n    ContextMenu.create(this, html, '.item', this._getItemContextOptions(), {\r\n      hookName: 'MassEditPresetContext',\r\n      onOpen: this._onRightClickPreset.bind(this),\r\n    });\r\n    ContextMenu.create(this, html, '.folder header', this._getFolderContextOptions(), {\r\n      hookName: 'MassEditFolderContext',\r\n    });\r\n  }\r\n\r\n  _getItemContextOptions() {\r\n    return [\r\n      {\r\n        name: localize('CONTROLS.CommonEdit', false),\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (item) => Preset.isEditable(item.data('uuid')),\r\n        callback: (item) => this._onEditSelectedPresets(item),\r\n      },\r\n      {\r\n        name: 'Brush',\r\n        icon: '<i class=\"fa-solid fa-paintbrush\"></i>',\r\n        condition: (item) => SUPPORTED_PLACEABLES.includes(item.data('doc-name')),\r\n        callback: (item) => this._onActivateBrush(item),\r\n      },\r\n      {\r\n        name: localize('presets.open-journal'),\r\n        icon: '<i class=\"fas fa-book-open\"></i>',\r\n        condition: (item) => !item.hasClass('virtual'),\r\n        callback: (item) => this._onOpenJournal(item),\r\n      },\r\n      {\r\n        name: localize('presets.apply-to-selected'),\r\n        icon: '<i class=\"fas fa-arrow-circle-right\"></i>',\r\n        condition: (item) =>\r\n          SUPPORTED_PLACEABLES.includes(item.data('doc-name')) &&\r\n          canvas.getLayerByEmbeddedName(item.data('doc-name')).controlled.length,\r\n        callback: (item) => this._onApplyToSelected(item),\r\n      },\r\n      {\r\n        name: localize('Duplicate', false),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => Preset.isEditable(item.data('uuid')) && !item.hasClass('virtual'),\r\n        callback: (item) =>\r\n          this._onCopySelectedPresets(null, {\r\n            keepFolder: true,\r\n            keepId: false,\r\n          }),\r\n      },\r\n      {\r\n        name: localize('presets.copy-source-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => item.data('uuid').startsWith('virtual@'),\r\n        callback: (item) => game.clipboard.copyPlainText(item.data('uuid').substring(8)),\r\n      },\r\n      {\r\n        name: localize('presets.copy-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => $(this.form).find('.item-list').find('.item.selected').length === 1,\r\n        callback: (item) => this._onCopyPresetToClipboard(),\r\n      },\r\n      {\r\n        name: 'Copy UUID',\r\n        icon: '<i class=\"fa-solid fa-passport\"></i>',\r\n        callback: (item) => this._onCopyUUID(item),\r\n      },\r\n      {\r\n        name: localize('presets.export-as-json'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (item) => this._onExportSelectedPresets(),\r\n      },\r\n      {\r\n        name: localize('presets.export-to-compendium'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (item) => this._onExportSelectedPresetsToComp(),\r\n      },\r\n      {\r\n        name: localize('CONTROLS.CommonDelete', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (item) => Preset.isEditable(item.data('uuid')) && !item.hasClass('virtual'),\r\n        callback: (item) => this._onDeleteSelectedPresets(item),\r\n      },\r\n    ];\r\n  }\r\n\r\n  _getFolderContextOptions() {\r\n    return [\r\n      {\r\n        name: 'Edit',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !folder.virtual || folder instanceof PresetPackFolder;\r\n        },\r\n        callback: (header) => this._onFolderEdit(header),\r\n      },\r\n      {\r\n        name: 'Save Index',\r\n        icon: '<i class=\"fas fa-file-search\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return folder.indexable;\r\n        },\r\n        callback: (header) => {\r\n          FileIndexer.saveFolderToCache(this.tree.allFolders.get(header.closest('.folder').data('uuid')));\r\n        },\r\n      },\r\n      {\r\n        name: 'Export to Compendium',\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !(folder instanceof VirtualFileFolder);\r\n        },\r\n        callback: (header) => {\r\n          this._onExportFolder(header.closest('.folder').data('uuid'));\r\n        },\r\n      },\r\n      {\r\n        name: localize('FOLDER.Remove', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (header) => PresetFolder.isEditable(header.closest('.folder').data('uuid')),\r\n        callback: (header) => this._onFolderDelete(header.closest('.folder').data('uuid')),\r\n      },\r\n      {\r\n        name: localize('FOLDER.Delete', false),\r\n        icon: '<i class=\"fas fa-dumpster\"></i>',\r\n        condition: (header) => PresetFolder.isEditable(header.closest('.folder').data('uuid')),\r\n        callback: (header) =>\r\n          this._onFolderDelete(header.closest('.folder').data('uuid'), {\r\n            deleteAll: true,\r\n          }),\r\n      },\r\n      {\r\n        name: 'Randomize Child Folder Colors',\r\n        icon: '<i class=\"fas fa-dice\"></i>',\r\n        condition: () => CONFIG.debug.MassEdit,\r\n        callback: (header) =>\r\n          randomizeChildrenFolderColors(header.closest('.folder').data('uuid'), this.tree, () => this.render(true)),\r\n      },\r\n    ];\r\n  }\r\n\r\n  async _onExportFolder(uuid) {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack && !this._importTracker?.active) {\r\n      const folder = this.tree.allFolders.get(uuid);\r\n      if (folder) {\r\n        this._importTracker = await trackProgress({\r\n          title: 'Exporting Folder',\r\n          total: countFolderItems(this.tree.allFolders.get(uuid)),\r\n        });\r\n        await this._onCopyFolder(uuid, null, pack, true, keepId);\r\n        this._importTracker?.stop();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onCopyFolder(uuid, parentId = null, pack, render = true, keepId = true) {\r\n    if (!pack) pack = PresetCollection.workingPack;\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    const folderDoc = await fromUuid(uuid);\r\n\r\n    if (folder) {\r\n      let types;\r\n      if (folderDoc) types = folderDoc.flags[MODULE_ID]?.types ?? ['ALL'];\r\n      else types = ['ALL'];\r\n\r\n      const data = {\r\n        _id: keepId ? folder.id : null,\r\n        name: folder.name,\r\n        color: folder.color,\r\n        sorting: folder.sorting,\r\n        folder: parentId,\r\n        flags: { [MODULE_ID]: { types } },\r\n        type: 'JournalEntry',\r\n      };\r\n      const nFolder = await Folder.create(data, { pack, keepId });\r\n\r\n      for (const preset of folder.presets) {\r\n        if (!this._importTracker?.active) break;\r\n        const p = (await preset.load()).clone();\r\n        p.folder = nFolder.id;\r\n        if (!keepId) p.id = foundry.utils.randomID();\r\n        await PresetCollection.set(p, pack);\r\n        this._importTracker?.incrementCount();\r\n      }\r\n\r\n      for (const child of folder.children) {\r\n        if (!this._importTracker?.active) break;\r\n        await this._onCopyFolder(child.uuid, nFolder.id, pack, false, keepId);\r\n      }\r\n\r\n      if (render) this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onExportSelectedPresetsToComp() {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack) this._onCopySelectedPresets(pack, { keepId });\r\n  }\r\n\r\n  async _onCopySelectedPresets(pack, { keepFolder = false, keepId = true } = {}) {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    for (const preset of selected) {\r\n      const p = preset.clone();\r\n      if (!keepFolder) p.folder = null;\r\n      if (!keepId) p.id = foundry.utils.randomID();\r\n      await PresetCollection.set(p, pack);\r\n    }\r\n    if (selected.length) this.render(true);\r\n  }\r\n\r\n  async _onCopyPresetToClipboard() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    if (selected.length) copyToClipboard(selected[0]);\r\n  }\r\n\r\n  async _getSelectedPresets({ editableOnly = false, virtualOnly = false, full = true } = {}) {\r\n    const uuids = [];\r\n    let selector = '.item.selected';\r\n    if (virtualOnly) selector += '.virtual';\r\n\r\n    let items = this.element.find('.item-list').find(selector);\r\n    if (editableOnly)\r\n      items = items.filter(function () {\r\n        return Preset.isEditable($(this).data('uuid'));\r\n      });\r\n\r\n    items.each(function () {\r\n      const uuid = $(this).data('uuid');\r\n      uuids.push(uuid);\r\n    });\r\n\r\n    const selected = [];\r\n    for (const uuid of uuids) {\r\n      const preset = await PresetCollection.get(uuid, { full });\r\n      if (preset) selected.push(preset);\r\n    }\r\n    return [selected, items];\r\n  }\r\n\r\n  async _onExportSelectedPresets() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    exportPresets(selected);\r\n  }\r\n\r\n  async _onEditSelectedPresets(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      virtualOnly: item.hasClass('virtual'),\r\n      editableOnly: true,\r\n    });\r\n    if (selected.length) {\r\n      // Position edit window just bellow the item\r\n      const options = item.offset();\r\n      options.top += item.height();\r\n\r\n      this._editPresets(selected, options);\r\n    }\r\n  }\r\n\r\n  async _onDeleteSelectedPresets(item) {\r\n    const [selected, items] = await this._getSelectedPresets({\r\n      editableOnly: true,\r\n      full: false,\r\n    });\r\n    if (selected.length) {\r\n      const confirm =\r\n        selected.length === 0\r\n          ? true\r\n          : await Dialog.confirm({\r\n              title: `${localize('common.delete')} [ ${selected.length} ]`,\r\n              content: `<p>${localize('AreYouSure', false)}</p><p>${localFormat('presets.delete-presets-warn', {\r\n                count: selected.length,\r\n              })}</p>`,\r\n            });\r\n\r\n      if (confirm) {\r\n        await PresetCollection.delete(selected);\r\n        items.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onOpenJournal(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n    });\r\n    selected.forEach((p) => p.openJournal());\r\n  }\r\n\r\n  _onCopyUUID(item) {\r\n    item.data('uuid');\r\n\r\n    game.clipboard.copyPlainText(item.data('uuid'));\r\n    ui.notifications.info(\r\n      game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n        label: item.attr('name'),\r\n        type: 'uuid',\r\n        id: item.data('uuid'),\r\n      })\r\n    );\r\n  }\r\n\r\n  async _onApplyToSelected(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n    });\r\n    if (!selected.length) return;\r\n\r\n    // Confirm that all presets are of the same document type\r\n    const types = new Set();\r\n    for (const s of selected) {\r\n      types.add(s.documentName);\r\n      if (types.size > 1) {\r\n        ui.notifications.warn(localize('presets.apply-to-selected-warn'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    const controlled = canvas.getLayerByEmbeddedName(selected[0].documentName).controlled;\r\n    if (!controlled.length) return;\r\n\r\n    for (const s of selected) {\r\n      pasteDataUpdate(controlled, s, false, true);\r\n    }\r\n  }\r\n\r\n  async _onCreateFolder(event) {\r\n    const types = [];\r\n    if (this.documentName === 'ALL') {\r\n      types.push('ALL');\r\n    } else if (UI_DOCS.includes(this.documentName)) {\r\n      types.push('ALL', this.documentName);\r\n    } else {\r\n      types.push(this.documentName);\r\n    }\r\n\r\n    const folder = new Folder.implementation(\r\n      {\r\n        name: Folder.defaultName(),\r\n        type: 'JournalEntry',\r\n        sorting: 'm',\r\n        flags: { [MODULE_ID]: { types } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    await new Promise((resolve) => {\r\n      new PresetFolderConfig(folder, { resolve }).render(true);\r\n    });\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onFolderEdit(header) {\r\n    const uuid = $(header).closest('.folder').data('uuid');\r\n    const pFolder = this.tree.allFolders.get(uuid);\r\n\r\n    let folder;\r\n    if (pFolder instanceof PresetPackFolder) {\r\n      // This is a virtual pack folder\r\n      folder = new Folder.implementation(\r\n        {\r\n          _id: pFolder.id,\r\n          name: pFolder.name,\r\n          type: 'JournalEntry',\r\n          color: pFolder.color,\r\n          sorting: pFolder.sorting,\r\n        },\r\n        { pack: pFolder.uuid }\r\n      );\r\n    } else {\r\n      folder = await fromUuid($(header).closest('.folder').data('uuid'));\r\n    }\r\n\r\n    new Promise((resolve) => {\r\n      const options = { resolve, ...header.offset(), folder: pFolder };\r\n      options.top += header.height();\r\n\r\n      new PresetFolderConfig(folder, options).render(true);\r\n    }).then(() => this.render(true));\r\n  }\r\n\r\n  async _onFolderDelete(uuid, { render = true, deleteAll = false } = {}) {\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder) {\r\n      let confirm;\r\n\r\n      if (deleteAll) {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Delete', false)}: ${folder.name}`,\r\n          content: `<div style=\"color:red;\"><h4>${localize('AreYouSure', false)}</h4><p>${localize(\r\n            'FOLDER.DeleteWarning',\r\n            false\r\n          )}</p></div>`,\r\n        });\r\n      } else {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Remove', false)}: ${folder.name}`,\r\n          content: `<h4>${localize('AreYouSure', false)}</h4><p>${localize('FOLDER.RemoveWarning', false)}</p>`,\r\n        });\r\n      }\r\n\r\n      if (confirm) {\r\n        await PresetCollection.deleteFolder(uuid, deleteAll);\r\n        if (render) this.render(true);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Throttle input and perform preset search\r\n  _onSearchInput(event) {\r\n    clearTimeout(this._searchTimer);\r\n    this._searchTimer = setTimeout(() => this._onSearch(event), 250);\r\n  }\r\n\r\n  async _onSearch(event) {\r\n    let newSearch = event.target.value;\r\n    let previousSearch = MassEditPresets.lastSearch || '';\r\n    MassEditPresets.lastSearch = newSearch;\r\n\r\n    if (previousSearch.length >= SEARCH_MIN_CHAR && newSearch.length < SEARCH_MIN_CHAR) {\r\n      $(event.target).removeClass('active');\r\n      this._resetSearchState();\r\n      this._renderContent();\r\n      return;\r\n    }\r\n\r\n    if (newSearch.length < SEARCH_MIN_CHAR) return;\r\n\r\n    let filter = event.target.value\r\n      .trim()\r\n      .toLowerCase()\r\n      .split(' ')\r\n      .filter((w) => w.length >= SEARCH_MIN_CHAR);\r\n    if (!filter.length) return;\r\n    $(event.target).addClass('active');\r\n\r\n    const tags = filter.filter((f) => f.startsWith('#')).map((f) => f.substring(1));\r\n    filter = filter.filter((f) => !f.startsWith('#'));\r\n\r\n    this._searchFoundPresets = [];\r\n    this.tree.folders.forEach((f) => this._searchFolder(filter, tags, f));\r\n    this.tree.extFolders.forEach((f) => this._searchFolder(filter, tags, f));\r\n    this.tree.presets.forEach((p) => this._searchPreset(filter, tags, p));\r\n\r\n    this._renderContent();\r\n  }\r\n\r\n  _searchFolder(filter, tags, folder, forceRender = false) {\r\n    const folderName = folder.name.toLowerCase();\r\n    let match = !tags.length && filter.every((k) => folderName.includes(k));\r\n\r\n    let childFolderMatch = false;\r\n    for (const f of folder.children) {\r\n      if (this._searchFolder(filter, tags, f, match || forceRender)) childFolderMatch = true;\r\n    }\r\n\r\n    let presetMatch = false;\r\n    for (const p of folder.presets) {\r\n      if (this._searchPreset(filter, tags, p, match || forceRender)) presetMatch = true;\r\n    }\r\n\r\n    const containsMatch = match || childFolderMatch || presetMatch;\r\n    folder.expanded = childFolderMatch || presetMatch;\r\n    folder.render = containsMatch || forceRender;\r\n\r\n    return containsMatch;\r\n  }\r\n\r\n  _searchPreset(filter, tags, preset, forceRender = false) {\r\n    if (!preset._visible) return false;\r\n\r\n    const presetName = preset.name.toLowerCase();\r\n    if (\r\n      this._searchFoundPresets.length < SEARCH_FOUND_MAX_COUNT &&\r\n      filter.every((k) => presetName.includes(k) || preset.tags.includes(k)) &&\r\n      tags.every((k) => preset.tags.includes(k))\r\n    ) {\r\n      preset._render = true;\r\n      this._searchFoundPresets.push(preset);\r\n      return preset._render;\r\n    } else {\r\n      preset._render = false || forceRender;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _resetSearchState() {\r\n    this._searchFoundPresets = [];\r\n    this.tree.folders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.extFolders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStateFolder(folder) {\r\n    folder.expanded = FolderState.expanded(folder.uuid);\r\n    folder.render = true;\r\n    folder.children.forEach((f) => this._resetSearchStateFolder(f));\r\n    folder.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStatePreset(preset) {\r\n    preset._render = true;\r\n  }\r\n\r\n  async _renderContent() {\r\n    let data;\r\n    if (game.settings.get(MODULE_ID, 'presetSearchMode') === 'p') {\r\n      data = {\r\n        callback: Boolean(this.callback),\r\n        presets: this._searchFoundPresets,\r\n        folders: [],\r\n        createEnabled: Boolean(this.configApp),\r\n        extFolders: null,\r\n      };\r\n    } else {\r\n      data = {\r\n        callback: Boolean(this.callback),\r\n        presets: this.tree.presets,\r\n        folders: this.tree.folders,\r\n        createEnabled: Boolean(this.configApp),\r\n        extFolders: this.tree.extFolders.length ? this.tree.extFolders : null,\r\n      };\r\n    }\r\n\r\n    const content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/presetsContent.html`, data);\r\n    this.element.find('.item-list').html(content);\r\n\r\n    this._tagSelector?.render(true);\r\n  }\r\n\r\n  async _onFolderSort(sourceUuid, targetUuid, { inside = true, folderUuid = null } = {}) {\r\n    let source = this.tree.allFolders.get(sourceUuid);\r\n    let target = this.tree.allFolders.get(targetUuid);\r\n\r\n    let folders;\r\n    if (folderUuid) folders = this.tree.allFolders.get(folderUuid).children;\r\n    else folders = this.tree.folders;\r\n\r\n    const siblings = [];\r\n    for (const folder of folders) {\r\n      if (folder.uuid !== sourceUuid) siblings.push(folder);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSort(source, {\r\n      target,\r\n      siblings,\r\n      sortBefore: true,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await Folder.updateDocuments(updates, {\r\n        pack: PresetCollection.workingPack,\r\n      });\r\n    }\r\n    this.render(true);\r\n  }\r\n\r\n  async _onItemSort(sourceUuids, targetUuid, { before = true, folderUuid = null } = {}) {\r\n    const sourceUuidsSet = new Set(sourceUuids);\r\n    const sources = this.tree.allPresets.filter((p) => sourceUuidsSet.has(p.uuid));\r\n\r\n    let target = this.tree.allPresets.find((p) => p.uuid === targetUuid);\r\n\r\n    // Determine siblings based on folder\r\n    let presets;\r\n    if (folderUuid) presets = this.tree.allFolders.get(folderUuid).presets;\r\n    else presets = this.tree.presets;\r\n\r\n    const siblings = [];\r\n    for (const preset of presets) {\r\n      if (!sourceUuidsSet.has(preset.uuid)) siblings.push(preset);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSortMulti(sources, {\r\n      target,\r\n      siblings,\r\n      sortBefore: before,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        // update preset object itself\r\n        // TODO: improve, this is done so that preset/pack does not need to get reloaded\r\n        const p = presets.find((p) => p.id === update._id);\r\n        if (p) {\r\n          p.folder = update.folder;\r\n          p.sort = update.sort;\r\n        }\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await PresetCollection.updatePresets(updates);\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSort(event) {\r\n    const currentSort = game.settings.get(MODULE_ID, 'presetSortMode');\r\n    const newSort = currentSort === 'manual' ? 'alphabetical' : 'manual';\r\n    await game.settings.set(MODULE_ID, 'presetSortMode', newSort);\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSearch(event, headerSearch) {\r\n    const searchControl = $(event.target).closest('.toggle-search-mode');\r\n\r\n    const currentMode = game.settings.get(MODULE_ID, 'presetSearchMode');\r\n    const newMode = currentMode === 'p' ? 'pf' : 'p';\r\n    await game.settings.set(MODULE_ID, 'presetSearchMode', newMode);\r\n\r\n    const mode = SEARCH_MODES[newMode];\r\n    searchControl.attr('data-tooltip', mode.tooltip).html(mode.icon);\r\n\r\n    if (MassEditPresets.lastSearch) headerSearch.trigger('input');\r\n  }\r\n\r\n  _onToggleLock(event) {\r\n    const lockControl = $(event.target).closest('.toggle-doc-lock');\r\n\r\n    let currentLock = game.settings.get(MODULE_ID, 'presetDocLock');\r\n    let newLock = this.documentName;\r\n\r\n    if (newLock !== currentLock) lockControl.addClass('active');\r\n    else {\r\n      lockControl.removeClass('active');\r\n      newLock = '';\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'presetDocLock', newLock);\r\n  }\r\n\r\n  _onToggleLayerSwitch(event) {\r\n    const switchControl = $(event.currentTarget);\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetLayerSwitch');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    game.settings.set(MODULE_ID, 'presetLayerSwitch', value);\r\n  }\r\n\r\n  async _onToggleVirtDir(event) {\r\n    const switchControl = $(event.currentTarget);\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetVirtualDir');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    await game.settings.set(MODULE_ID, 'presetVirtualDir', value);\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleExtComp(event) {\r\n    const switchControl = $(event.currentTarget);\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetExtComp');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    await game.settings.set(MODULE_ID, 'presetExtComp', value);\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleScaling(event) {\r\n    const switchControl = $(event.target).closest('.toggle-scaling');\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetScaling');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    game.settings.set(MODULE_ID, 'presetScaling', value);\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    const newDocumentName = $(event.target).closest('.document-select').data('name');\r\n    if (newDocumentName != this.documentName) {\r\n      this.documentName = newDocumentName;\r\n\r\n      if (game.settings.get(MODULE_ID, 'presetLayerSwitch'))\r\n        canvas.getLayerByEmbeddedName(this.documentName === 'Actor' ? 'Token' : this.documentName)?.activate();\r\n\r\n      if (MassEditPresets.lastSearch) {\r\n        MassEditPresets.lastSearch = '';\r\n        this._resetSearchState();\r\n      }\r\n\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRightClickPreset(eventTarget) {\r\n    const item = $(eventTarget).closest('.item');\r\n\r\n    // If right-clicked item is not selected, de-select the others and select it\r\n    if (!item.hasClass('selected')) {\r\n      item.closest('.item-list').find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n      item.addClass('selected').addClass('last-selected');\r\n    }\r\n  }\r\n\r\n  _editPresets(presets, options = {}, event) {\r\n    options.callback = () => this.render(true);\r\n    if (!('left' in options) && event) {\r\n      options.left = event.originalEvent.x - PresetConfig.defaultOptions.width / 2;\r\n      options.top = event.originalEvent.y;\r\n    }\r\n    new PresetConfig(presets, options).render(true);\r\n  }\r\n\r\n  async _onApplyPreset(event) {\r\n    if (this.callback) {\r\n      const uuid = $(event.target).closest('.item').data('uuid');\r\n      this.callback(await PresetCollection.get(uuid));\r\n    }\r\n  }\r\n\r\n  async _onToggleTagSelector(event) {\r\n    if (this._tagSelector) {\r\n      this._tagSelector.close(true);\r\n      this._tagSelector = null;\r\n    } else {\r\n      this._tagSelector = new TagSelector(this);\r\n      this._tagSelector.render(true);\r\n    }\r\n  }\r\n\r\n  async _onPresetDragOut(event) {\r\n    const uuid = $(event.originalEvent.target).closest('.item').data('uuid');\r\n    const preset = await PresetCollection.get(uuid);\r\n    if (!preset) return;\r\n\r\n    // If released on top of a Mass Edit form, apply the preset to it instead of spawning it\r\n    const form = hoverMassEditForm(event.pageX, event.pageY, preset.documentName);\r\n    if (form) {\r\n      form._applyPreset(preset);\r\n      return;\r\n    }\r\n\r\n    // If it's a scene preset apply it to the currently active scene\r\n    if (preset.documentName === 'Scene') {\r\n      applyPresetToScene(preset);\r\n      return;\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    // For some reason canvas.mousePosition does not get updated during drag and drop\r\n    // Acquire the cursor position transformed to Canvas coordinates\r\n    let mouseX;\r\n    let mouseY;\r\n    let mouseZ;\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      game.Levels3DPreview.interactionManager._onMouseMove(event, true);\r\n      const { x, y, z } = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n      mouseX = x;\r\n      mouseY = y;\r\n      mouseZ = z;\r\n    } else {\r\n      const [x, y] = [event.clientX, event.clientY];\r\n      const t = canvas.stage.worldTransform;\r\n\r\n      mouseX = (x - t.tx) / canvas.stage.scale.x;\r\n      mouseY = (y - t.ty) / canvas.stage.scale.y;\r\n\r\n      if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n        mouseX -= canvas.dimensions.size / 2;\r\n        mouseY -= canvas.dimensions.size / 2;\r\n      }\r\n    }\r\n\r\n    PresetAPI.spawnPreset({\r\n      preset,\r\n      x: mouseX,\r\n      y: mouseY,\r\n      z: mouseZ,\r\n      mousePosition: false,\r\n      layerSwitch: game.settings.get(MODULE_ID, 'presetLayerSwitch'),\r\n      scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n    });\r\n  }\r\n\r\n  async _onToggleFavorite(event) {\r\n    const item = $(event.target).closest('.item');\r\n    const uuid = item.data('uuid');\r\n    const starControl = item.find('.preset-favorite i');\r\n\r\n    if (uuid) {\r\n      const favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n      if (starControl.hasClass('fa-regular')) {\r\n        starControl.removeClass('fa-regular').addClass('fa-solid');\r\n        favorites[uuid] = true;\r\n      } else {\r\n        starControl.removeClass('fa-solid').addClass('fa-regular');\r\n        delete favorites[uuid];\r\n      }\r\n      game.settings.set(MODULE_ID, 'presetFavorites', favorites);\r\n      Preset.favorites = favorites;\r\n    }\r\n  }\r\n\r\n  async _onActivateBrush(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n    });\r\n    BrushMenu.addPresets(selected);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * Application.setPosition(...) has been modified to use css transform for window translation across the screen\r\n   * instead of top/left css properties which force full-window style recomputation\r\n   */\r\n  setPosition({ left, top, width, height, scale } = {}) {\r\n    if (!this.popOut && !this.options.resizable) return; // Only configure position for popout or resizable apps.\r\n    const el = this.element[0];\r\n    const currentPosition = this.position;\r\n    const pop = this.popOut;\r\n    const styles = window.getComputedStyle(el);\r\n    if (scale === null) scale = 1;\r\n    scale = scale ?? currentPosition.scale ?? 1;\r\n\r\n    // If Height is \"auto\" unset current preference\r\n    if (height === 'auto' || this.options.height === 'auto') {\r\n      el.style.height = '';\r\n      height = null;\r\n    }\r\n\r\n    // Update width if an explicit value is passed, or if no width value is set on the element\r\n    if (!el.style.width || width) {\r\n      const tarW = width || el.offsetWidth;\r\n      const minW = parseInt(styles.minWidth) || (pop ? MIN_WINDOW_WIDTH : 0);\r\n      const maxW = el.style.maxWidth || window.innerWidth / scale;\r\n      currentPosition.width = width = Math.clamp\r\n        ? Math.clamp(tarW, minW, maxW) // v12\r\n        : Math.clamped(tarW, minW, maxW);\r\n      el.style.width = `${width}px`;\r\n      if (width * scale + currentPosition.left > window.innerWidth) left = currentPosition.left;\r\n    }\r\n    width = el.offsetWidth;\r\n\r\n    // Update height if an explicit value is passed, or if no height value is set on the element\r\n    if (!el.style.height || height) {\r\n      const tarH = height || el.offsetHeight + 1;\r\n      const minH = parseInt(styles.minHeight) || (pop ? MIN_WINDOW_HEIGHT : 0);\r\n      const maxH = el.style.maxHeight || window.innerHeight / scale;\r\n      currentPosition.height = height = Math.clamp\r\n        ? Math.clamp(tarH, minH, maxH) // v12\r\n        : Math.clamped(tarH, minH, maxH);\r\n      el.style.height = `${height}px`;\r\n      if (height * scale + currentPosition.top > window.innerHeight + 1) top = currentPosition.top - 1;\r\n    }\r\n    height = el.offsetHeight;\r\n\r\n    let leftT, topT;\r\n    // Update Left\r\n    if ((pop && !this.posSet) || Number.isFinite(left)) {\r\n      const scaledWidth = width * scale;\r\n      const tarL = Number.isFinite(left) ? left : (window.innerWidth - scaledWidth) / 2;\r\n      const maxL = Math.max(window.innerWidth - scaledWidth, 0);\r\n      currentPosition.left = left = Math.clamp\r\n        ? Math.clamp(tarL, 0, maxL) // v12\r\n        : Math.clamped(tarL, 0, maxL);\r\n      leftT = left;\r\n    }\r\n\r\n    // Update Top\r\n    if ((pop && !this.posSet) || Number.isFinite(top)) {\r\n      const scaledHeight = height * scale;\r\n      const tarT = Number.isFinite(top) ? top : (window.innerHeight - scaledHeight) / 2;\r\n      const maxT = Math.max(window.innerHeight - scaledHeight, 0);\r\n      currentPosition.top = Math.clamp\r\n        ? Math.clamp(tarT, 0, maxT) // v12\r\n        : Math.clamped(tarT, 0, maxT);\r\n\r\n      topT = currentPosition.top;\r\n    }\r\n\r\n    let transform = '';\r\n\r\n    // Update Scale\r\n    if (scale) {\r\n      currentPosition.scale = Math.max(scale, 0);\r\n\r\n      if (scale === 1) transform += ``;\r\n      else transform += `scale(${scale})`;\r\n    }\r\n\r\n    if (leftT || topT) {\r\n      this.posSet = true;\r\n      transform += 'translate(' + leftT + 'px,' + topT + 'px)';\r\n    }\r\n\r\n    if (transform) {\r\n      el.style.transform = transform;\r\n    }\r\n\r\n    // Track position post window close\r\n    if (!this.options.preventPositionOverride) {\r\n      const { left, top, width, height } = this.position;\r\n      MassEditPresets.previousPosition = { left, top, width, height };\r\n    }\r\n\r\n    // Return the updated position object\r\n    return currentPosition;\r\n  }\r\n\r\n  async close(options = {}) {\r\n    MassEditPresets.objectHover = false;\r\n    this._tagSelector?.close();\r\n    this._endPreview();\r\n    return super.close(options);\r\n  }\r\n\r\n  async _onPresetUpdate(event) {\r\n    const preset = await PresetCollection.get($(event.target).closest('.item').data('uuid'));\r\n    if (!preset) return;\r\n\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const randomize = foundry.utils.deepClone(this.configApp.randomizeFields || {});\r\n    const addSubtract = foundry.utils.deepClone(this.configApp.addSubtractFields || {});\r\n\r\n    // Detection modes may have been selected out of order\r\n    // Fix that here\r\n    if (this.documentName === 'Token') {\r\n      TokenDataAdapter.correctDetectionModeOrder(selectedFields, randomize);\r\n    }\r\n\r\n    preset.update({ data: selectedFields, randomize, addSubtract });\r\n\r\n    ui.notifications.info(`Preset \"${preset.name}\" updated`);\r\n  }\r\n\r\n  async _onPresetCreate(event) {\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const preset = new Preset({\r\n      name: localize('presets.default-name'),\r\n      documentName: this.documentName,\r\n      data: selectedFields,\r\n      addSubtract: this.configApp.addSubtractFields,\r\n      randomize: this.configApp.randomizeFields,\r\n    });\r\n\r\n    await PresetCollection.set(preset);\r\n    this.render(true);\r\n\r\n    this._editPresets([preset], { isCreate: true }, event);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped on the form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n\r\n    // Switch to just created preset's category before rendering if not set to 'ALL'\r\n    const documentName = placeables[0].document.documentName;\r\n    if (this.documentName !== 'ALL' && this.documentName !== documentName) this.documentName = documentName;\r\n\r\n    const options = { isCreate: true };\r\n    options.left = this.position.left + this.position.width + 20;\r\n    options.top = this.position.top;\r\n\r\n    const linked = LinkerAPI.getLinkedDocuments(placeables.map((p) => p.document));\r\n    if (linked.size) {\r\n      const response = await new Promise((resolve) => {\r\n        Dialog.confirm({\r\n          title: 'Attach Linked',\r\n          content: `<p>Linked placeables have been detected [<b>${linked.size}</b>].</p><p>Should they be included as <b>Attached</b>?</p>`,\r\n          yes: () => resolve(true),\r\n          no: () => resolve(false),\r\n          defaultYes: false,\r\n        });\r\n      });\r\n      if (response) {\r\n        options.attached = Array.from(linked).map((l) => {\r\n          return { documentName: l.documentName, data: placeableToData(l) };\r\n        });\r\n      }\r\n    }\r\n\r\n    this._editPresets(presets, options, event);\r\n    this.render(true);\r\n  }\r\n\r\n  async actorToPreset(actor) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n  }\r\n\r\n  _getActiveEffectFields() {\r\n    return {\r\n      changes: foundry.utils.deepClone(this.configApp.object.changes ?? []),\r\n    };\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-change-compendium',\r\n      icon: 'fa-solid fa-gear',\r\n      onclick: (ev) => this._onWorkingPackChange(),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-indexer',\r\n      icon: 'fas fa-archive',\r\n      onclick: (ev) => this._onOpenIndexer(),\r\n    });\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-import',\r\n      icon: 'fas fa-file-import',\r\n      onclick: (ev) => this._onImport(ev),\r\n    });\r\n\r\n    if (CONFIG.debug.MassEdit) {\r\n      buttons.unshift({\r\n        label: 'Debug',\r\n        class: 'mass-edit-debug',\r\n        icon: 'fas fa-bug',\r\n        onclick: (ev) => {\r\n          console.log({\r\n            index: game.packs.get(PresetCollection.workingPack).get(META_INDEX_ID)?.flags[MODULE_ID]?.index,\r\n            tree: this.tree,\r\n          });\r\n        },\r\n      });\r\n    }\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _onWorkingPackChange() {\r\n    let pack = await new Promise((resolve) => getCompendiumDialog(resolve, {}));\r\n    if (pack && pack !== PresetCollection.workingPack) {\r\n      await game.settings.set(MODULE_ID, 'workingPack', pack);\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onOpenIndexer() {\r\n    if (FileIndexer._buildingIndex) {\r\n      ui.notifications.warn('Index Build In-Progress. Wait for it to finish before attempting it again.');\r\n      return;\r\n    }\r\n    new IndexerForm().render(true);\r\n  }\r\n\r\n  /**\r\n   * Export all working pack presets as as JSON file\r\n   */\r\n  async _onExport() {\r\n    const pack = game.packs.get(PresetCollection.workingPack);\r\n    await pack.getDocuments();\r\n    const tree = await PresetCollection.getTree(null, { externalCompendiums: false, virtualDirectory: false });\r\n    exportPresets(tree.allPresets);\r\n  }\r\n\r\n  async _onImport() {\r\n    const json = await importPresetFromJSONDialog();\r\n    if (!json) return;\r\n\r\n    let importCount = 0;\r\n\r\n    if (foundry.utils.getType(json) === 'Array') {\r\n      for (const p of json) {\r\n        if (!('documentName' in p)) continue;\r\n        if (!('data' in p) || foundry.utils.isEmpty(p.data)) continue;\r\n\r\n        const preset = new Preset(p);\r\n        preset._pages = p.pages;\r\n\r\n        await PresetCollection.set(preset);\r\n        importCount++;\r\n      }\r\n    }\r\n\r\n    ui.notifications.info(`Mass Edit: ${localFormat('presets.imported', { count: importCount })}`);\r\n\r\n    if (importCount) this.render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (this.callback) {\r\n      this.callback(await PresetCollection.get(event.submitter.data.id));\r\n    }\r\n  }\r\n}\r\n\r\nasync function exportPresets(presets, fileName) {\r\n  if (!presets.length) return;\r\n\r\n  for (const preset of presets) {\r\n    await preset.load();\r\n  }\r\n\r\n  presets = presets.map((p) => {\r\n    const preset = p.clone();\r\n    preset.folder = null;\r\n    preset.uuid = null;\r\n    return preset;\r\n  });\r\n\r\n  saveDataToFile(JSON.stringify(presets, null, 2), 'text/json', (fileName ?? 'mass-edit-presets') + '.json');\r\n}\r\n\r\nexport class PresetConfig extends FormApplication {\r\n  static name = 'PresetConfig';\r\n\r\n  /**\r\n   * @param {Array[Preset]} presets\r\n   */\r\n  constructor(presets, options = {}) {\r\n    super({}, options);\r\n    this.presets = presets;\r\n    this.callback = options.callback;\r\n    this.isCreate = options.isCreate;\r\n    this.attached = options.attached;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetEdit.html`,\r\n      width: 360,\r\n      height: 'auto',\r\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.content', initial: 'main' }],\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return 'mass-edit-preset-edit';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    const prefix = this.presets[0] instanceof VirtualFilePreset ? 'File' : 'Preset';\r\n    if (this.presets.length > 1) return `${prefix}s [${this.presets.length}]`;\r\n    else return `${prefix}: ${this.presets[0].name.substring(0, 20)}${this.presets[0].name.length > 20 ? '...' : ''}`;\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    return buttons;\r\n  }\r\n\r\n  _onExport() {\r\n    let fileName;\r\n    if (this.presets.length === 1) {\r\n      fileName = 'mass-edit-preset-' + this.presets[0].name.replace(' ', '_').replace(/\\W/g, '');\r\n    }\r\n    exportPresets(this.presets, fileName);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = {};\r\n\r\n    data.virtual = this.presets[0] instanceof VirtualFilePreset;\r\n\r\n    data.preset = {};\r\n    if (this.presets.length === 1) {\r\n      data.preset = foundry.utils.deepClone(this.presets[0].toJSON());\r\n      data.displayFieldDelete = true;\r\n      data.displayFieldModify = true;\r\n\r\n      data.attached = this.attached || data.preset.attached;\r\n      if (data.attached) {\r\n        data.attached = data.attached.map((at) => {\r\n          let tooltip = at.documentName;\r\n          if (at.documentName === 'Token' && at.data.name) tooltip += ': ' + at.data.name;\r\n          return {\r\n            icon: DOC_ICONS[at.documentName] ?? DOC_ICONS.DEFAULT,\r\n            tooltip,\r\n          };\r\n        });\r\n      }\r\n    } else {\r\n      data.multiEdit = true;\r\n      data.preset = {};\r\n    }\r\n\r\n    // Form data stored if re-render was required\r\n    if (this._submitData) {\r\n      foundry.utils.mergeObject(data.preset, this._submitData);\r\n    }\r\n\r\n    data.minlength = this.presets.length > 1 ? 0 : 1;\r\n    data.tva = game.modules.get('token-variants')?.active;\r\n\r\n    if ((this.data && !(this.data instanceof Array)) || (!this.data && this.presets[0].isEmpty)) {\r\n      data.modifyDisabled = true;\r\n      data.deleteDisabled = true;\r\n    }\r\n\r\n    // Check if all presets are for the same document type and thus can be edited using a Mass Edit form\r\n    const documentName = this.presets[0].documentName;\r\n    if (documentName !== 'Actor' && this.presets.every((p) => p.documentName === documentName)) {\r\n      data.documentEdit = documentName;\r\n      data.isPlaceable = SUPPORTED_PLACEABLES.includes(documentName);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    // Auto-select so that the pre-defined names can be conveniently erased\r\n    html.find('[name=\"name\"]').select();\r\n\r\n    html.find('.edit-document').on('click', this._onEditDocument.bind(this));\r\n    html.find('.assign-document').on('click', this._onAssignDocument.bind(this));\r\n    html.find('.delete-fields').on('click', this._onDeleteFields.bind(this));\r\n    html.find('.spawn-fields').on('click', this._onSpawnFields.bind(this));\r\n    html.find('summary').on('click', () => setTimeout(() => this.setPosition({ height: 'auto' }), 30));\r\n    html.find('.attached').on('click', this.onAttachedRemove.bind(this));\r\n    html.find('.attach-selected').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // TVA Support\r\n    const tvaButton = html.find('.token-variants-image-select-button');\r\n    tvaButton.on('click', (event) => {\r\n      game.modules.get('token-variants').api.showArtSelect('Preset', {\r\n        callback: (imgSrc, name) => {\r\n          tvaButton.siblings(`[name=\"${tvaButton.data('target')}\"]`).val(imgSrc);\r\n        },\r\n        searchType: 'Item',\r\n      });\r\n    });\r\n\r\n    //Hover\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (this.presets.length !== 1) return;\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          PresetConfig.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          PresetConfig.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        if (this.presets.length !== 1) return;\r\n        hoverOverlay.hide();\r\n        PresetConfig.objectHover = false;\r\n      });\r\n\r\n    //Tags\r\n    TagInput.activateListeners(html, {\r\n      change: () => this.setPosition({ height: 'auto' }),\r\n    });\r\n  }\r\n\r\n  _getSubmitData(updateData = {}) {\r\n    const data = super._getSubmitData(updateData);\r\n\r\n    data.name = data.name?.trim();\r\n    data.img = data.img?.trim() || null;\r\n    data.preSpawnScript = data.preSpawnScript?.trim();\r\n    data.postSpawnScript = data.postSpawnScript?.trim();\r\n    data.tags = data.tags ? data.tags.split(',') : [];\r\n    data.addTags = data.addTags ? data.addTags.split(',') : [];\r\n    data.removeTags = data.removeTags ? data.removeTags.split(',') : [];\r\n\r\n    return data;\r\n  }\r\n\r\n  async render(force = false) {\r\n    if (this.form) this._submitData = this._getSubmitData();\r\n    return await super.render(force);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped ont he form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    if (!this.attached) this.attached = foundry.utils.deepClone(this.presets[0].attached ?? []);\r\n    placeables.forEach((p) =>\r\n      this.attached.push({\r\n        documentName: p.document.documentName,\r\n        data: placeableToData(p),\r\n      })\r\n    );\r\n\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async onAttachedRemove(event) {\r\n    const index = $(event.target).closest('.attached').data('index');\r\n    this.attached = this.attached || foundry.utils.deepClone(this.presets[0].attached);\r\n    this.attached.splice(index, 1);\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async _onSpawnFields() {\r\n    new PresetFieldModify(\r\n      this.data ?? this.presets[0].data,\r\n      (modifyOnSpawn) => {\r\n        this.modifyOnSpawn = modifyOnSpawn;\r\n      },\r\n      this.modifyOnSpawn ?? this.presets[0].modifyOnSpawn\r\n    ).render(true);\r\n  }\r\n\r\n  async _onDeleteFields() {\r\n    new PresetFieldDelete(this.data ?? this.presets[0].data, (data) => {\r\n      this.data = data;\r\n    }).render(true);\r\n  }\r\n\r\n  async _onAssignDocument() {\r\n    const controlled = canvas.getLayerByEmbeddedName(this.presets[0].documentName)?.controlled.map((p) => p.document);\r\n    if (!controlled?.length) return;\r\n\r\n    const linked = LinkerAPI.getLinkedDocuments(controlled);\r\n    if (linked.size) {\r\n      const response = await new Promise((resolve) => {\r\n        Dialog.confirm({\r\n          title: 'Override Attached',\r\n          content: `<p>Linked placeables have been detected [<b>${linked.size}</b>].</p><p>Should they be included and override <b>Attached</b>?</p>`,\r\n          yes: () => resolve(true),\r\n          no: () => resolve(false),\r\n          defaultYes: false,\r\n        });\r\n      });\r\n      if (response) {\r\n        this.attached = Array.from(linked).map((l) => {\r\n          return { documentName: l.documentName, data: placeableToData(l) };\r\n        });\r\n      }\r\n    }\r\n\r\n    const data = controlled.map((p) => placeableToData(p));\r\n    this.data = data;\r\n    ui.notifications.info(\r\n      localFormat('presets.assign', {\r\n        count: data.length,\r\n        document: this.presets[0].documentName,\r\n      })\r\n    );\r\n    this.gridSize = canvas.grid.size;\r\n    this.modifyOnSpawn = [];\r\n    this.render(true);\r\n  }\r\n\r\n  async _onEditDocument() {\r\n    const documents = [];\r\n    const cls = CONFIG[this.presets[0].documentName].documentClass;\r\n\r\n    for (const p of this.presets) {\r\n      p.data.forEach((d) => {\r\n        const tempDoc = new cls(mergePresetDataToDefaultDoc(p, d), { parent: canvas.scene });\r\n        documents.push(tempDoc);\r\n      });\r\n    }\r\n\r\n    const app = await showMassEdit(documents, null, {\r\n      presetEdit: true,\r\n      callback: (obj) => {\r\n        this.addSubtract = {};\r\n        this.randomize = {};\r\n        for (const k of Object.keys(obj.data)) {\r\n          if (k in obj.randomize) this.randomize[k] = obj.randomize[k];\r\n          if (k in obj.addSubtract) this.addSubtract[k] = obj.addSubtract[k];\r\n        }\r\n        this.data = obj.data;\r\n        this.render(true);\r\n      },\r\n      forceForm: true,\r\n    });\r\n\r\n    // For randomize and addSubtract only take into account the first preset\r\n    // and apply them to the form\r\n    const preset = new Preset({\r\n      data: {},\r\n      randomize: this.presets[0].randomize,\r\n      addSubtract: this.presets[0].addSubtract,\r\n    });\r\n    setTimeout(() => {\r\n      app._applyPreset(preset);\r\n    }, 400);\r\n  }\r\n\r\n  async _updatePresets(formData) {\r\n    for (const preset of this.presets) {\r\n      let update;\r\n      if (this.isCreate) {\r\n        update = {\r\n          name: formData.name || preset.name || localize('presets.default-name'),\r\n          img: formData.img ?? preset.img,\r\n        };\r\n      } else {\r\n        update = {\r\n          name: formData.name || preset.name,\r\n          img: formData.img || preset.img,\r\n        };\r\n      }\r\n\r\n      if (this.data) update.data = this.data;\r\n      if (this.addSubtract) update.addSubtract = this.addSubtract;\r\n      if (this.randomize) update.randomize = this.randomize;\r\n      if (this.modifyOnSpawn) update.modifyOnSpawn = this.modifyOnSpawn;\r\n      if (this.gridSize) update.gridSize = this.gridSize;\r\n      if (this.attached) update.attached = this.attached;\r\n      if (formData.preSpawnScript != null) update.preSpawnScript = formData.preSpawnScript;\r\n      if (formData.postSpawnScript != null) update.postSpawnScript = formData.postSpawnScript;\r\n      if (formData.spawnRandom != null) update.spawnRandom = formData.spawnRandom;\r\n      if (formData.preserveLinks != null) update.preserveLinks = formData.preserveLinks;\r\n\r\n      // If this is a single preset config, we override all tags\r\n      // If not we merge\r\n      if (this.presets.length === 1) {\r\n        update.tags = formData.tags;\r\n      } else if (formData.addTags.length || formData.removeTags.length) {\r\n        let tags = preset.tags ?? [];\r\n        if (formData.addTags.length) tags = Array.from(new Set(tags.concat(formData.addTags)));\r\n        if (formData.removeTags.length) tags = tags.filter((t) => !formData.removeTags.includes(t));\r\n        update.tags = tags;\r\n      }\r\n\r\n      await preset.update(update);\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    await this._updatePresets(formData);\r\n\r\n    if (this.callback) this.callback(this.presets);\r\n    return this.presets;\r\n  }\r\n\r\n  /** @inheritDoc */\r\n  async _renderOuter() {\r\n    const html = await super._renderOuter();\r\n    this._createDocumentIdLink(html);\r\n    return html;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Create an ID link button in the header which displays the JournalEntry ID and copies it to clipboard\r\n   * @param {jQuery} html\r\n   * @protected\r\n   */\r\n  _createDocumentIdLink(html) {\r\n    const title = html.find('.window-title');\r\n    const label = localize('DOCUMENT.JournalEntry', false);\r\n    const idLink = document.createElement('a');\r\n    idLink.classList.add('document-id-link');\r\n    idLink.setAttribute('alt', 'Copy document id');\r\n    idLink.dataset.tooltip = `${label}: ${this.presets.map((p) => p.id).join(', ')}`;\r\n    idLink.dataset.tooltipDirection = 'UP';\r\n    idLink.innerHTML = '<i class=\"fa-solid fa-passport\"></i>';\r\n    idLink.addEventListener('click', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.id).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'id',\r\n          id: this.presets.map((p) => p.id).join(', '),\r\n        })\r\n      );\r\n    });\r\n    idLink.addEventListener('contextmenu', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.uuid).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'uuid',\r\n          id: this.presets.map((p) => p.uuid).join(', '),\r\n        })\r\n      );\r\n    });\r\n    title.append(idLink);\r\n  }\r\n}\r\n\r\nclass PresetFieldSelect extends FormApplication {\r\n  static name = 'PresetFieldSelect';\r\n\r\n  constructor(data, callback) {\r\n    super();\r\n    this.presetData = data;\r\n    this.isObject = !(data instanceof Array);\r\n    this.callback = callback;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'preset-field-select', 'mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFieldSelect.html`,\r\n      width: 600,\r\n      resizable: false,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.item').on('click', this._onFieldClick);\r\n  }\r\n\r\n  _onFieldClick(e) {\r\n    itemSelect(e, $(e.target).closest('.preset-field-list'));\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const singleData = !this.isObject && this.presetData.length === 1;\r\n\r\n    let index;\r\n    let fields = [];\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (!singleData) {\r\n        const i = k.split('.')[0];\r\n        if (!index) {\r\n          fields.push({ header: true, index: 0 });\r\n        } else if (i !== index) {\r\n          fields.push({ header: true, index: i });\r\n        }\r\n        index = i;\r\n      }\r\n\r\n      let label = k;\r\n      if (singleData) label = label.substring(label.indexOf('.') + 1);\r\n\r\n      let value;\r\n      const t = foundry.utils.getType(v);\r\n      if (t === 'Object' || t === 'Array' || t === 'null') value = JSON.stringify(v);\r\n      else value = v;\r\n\r\n      fields.push({ name: k, label, value, selected: false });\r\n    }\r\n\r\n    return { fields };\r\n  }\r\n}\r\n\r\nclass PresetFieldDelete extends PresetFieldSelect {\r\n  static name = 'PresetFieldDelete';\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-delete');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = {\r\n      icon: '<i class=\"fas fa-trash\"></i>',\r\n      text: localize('common.delete'),\r\n    };\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const form = $(event.target).closest('form');\r\n    form.find('.item.selected').each(function () {\r\n      const name = $(this).attr('name');\r\n      delete data[name];\r\n    });\r\n    data = expandObject(data);\r\n\r\n    if (!this.isObject) {\r\n      let reorganizedData = [];\r\n      for (let i = 0; i < this.presetData.length; i++) {\r\n        if (!data[i]) continue;\r\n        reorganizedData.push(data[i]);\r\n      }\r\n      data = reorganizedData;\r\n    }\r\n\r\n    this.callback(data);\r\n  }\r\n}\r\n\r\nclass PresetFieldModify extends PresetFieldSelect {\r\n  static name = 'PresetFieldModify';\r\n\r\n  constructor(data, callback, modifyOnSpawn) {\r\n    super(data, callback);\r\n    this.modifyOnSpawn = modifyOnSpawn ?? [];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-modify');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = {\r\n      icon: '<i class=\"fas fa-check\"></i>',\r\n      text: localize('CONTROLS.CommonSelect', false),\r\n    };\r\n    for (const field of data.fields) {\r\n      if (this.modifyOnSpawn.includes(field.name)) field.selected = true;\r\n    }\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    const form = $(event.target).closest('form');\r\n    const modifyOnSpawn = [];\r\n    form.find('.item.selected').each(function () {\r\n      let name = $(this).attr('name');\r\n      modifyOnSpawn.push(name);\r\n    });\r\n\r\n    this.callback(modifyOnSpawn);\r\n  }\r\n}\r\n\r\nclass PresetFolderConfig extends FolderConfig {\r\n  static name = 'PresetFolderConfig';\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'folder-edit'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFolderEdit.html`,\r\n      width: 360,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return this.object.id ? super.id : 'folder-create';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    if (this.object.id) return `${localize('FOLDER.Update', false)}: ${this.object.name}`;\r\n    return localize('FOLDER.Create', false);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.document-select').on('click', this._onDocumentChange.bind(this));\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    $(event.target).closest('.document-select').toggleClass('active');\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const folder = this.document.toObject();\r\n    const label = localize(Folder.implementation.metadata.label, false);\r\n\r\n    let folderDocs = folder.flags[MODULE_ID]?.types ?? ['ALL'];\r\n\r\n    let docs;\r\n\r\n    // This is a non-placeable folder type, so we will not display controls to change types\r\n    if (\r\n      this.options?.folder instanceof PresetPackFolder ||\r\n      (folderDocs.length === 1 && !UI_DOCS.includes(folderDocs[0]))\r\n    ) {\r\n      this.displayTypes = false;\r\n    } else {\r\n      this.displayTypes = true;\r\n      docs = [];\r\n      UI_DOCS.forEach((type) => {\r\n        if (type != 'FAVORITES')\r\n          docs.push({\r\n            name: type,\r\n            icon: DOC_ICONS[type],\r\n            active: folderDocs.includes(type),\r\n          });\r\n      });\r\n    }\r\n\r\n    return {\r\n      folder: folder,\r\n      name: folder._id ? folder.name : '',\r\n      newName: localFormat('DOCUMENT.New', { type: label }, false),\r\n      safeColor: folder.color ?? '#000000',\r\n      sortingModes: { a: 'FOLDER.SortAlphabetical', m: 'FOLDER.SortManual' },\r\n      submitText: localize(folder._id ? 'FOLDER.Update' : 'FOLDER.Create', false),\r\n      docs,\r\n      virtualPackFolder: this.options.folder instanceof PresetPackFolder,\r\n      group: this.options.folder?.group,\r\n    };\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    if (this.displayTypes) {\r\n      let visibleTypes = [];\r\n      $(this.form)\r\n        .find('.document-select.active')\r\n        .each(function () {\r\n          visibleTypes.push($(this).data('name'));\r\n        });\r\n      if (!visibleTypes.length) visibleTypes.push('ALL');\r\n\r\n      formData[`flags.${MODULE_ID}.types`] = visibleTypes;\r\n    }\r\n\r\n    let document = this.object;\r\n    if (this.options.folder instanceof PresetPackFolder) {\r\n      // This is a virtual folder used to store Compendium contents within\r\n      // Update using the provided interface\r\n      let update = {};\r\n      ['name', 'color', 'group'].forEach((k) => {\r\n        if (!formData[k]?.trim()) update['-=' + k] = null;\r\n        else update[k] = formData[k].trim();\r\n      });\r\n\r\n      await this.options.folder.update(update);\r\n    } else {\r\n      // This is a real folder, update/create it\r\n      if (!formData.name?.trim()) formData.name = Folder.implementation.defaultName();\r\n      if (this.object.id) await this.object.update(formData);\r\n      else {\r\n        this.object.updateSource(formData);\r\n        document = await Folder.create(this.object, { pack: this.object.pack });\r\n      }\r\n    }\r\n\r\n    this.options.resolve?.(document);\r\n    return document;\r\n  }\r\n}\r\n\r\nfunction checkMouseInWindow(event) {\r\n  let inWindow = false;\r\n\r\n  if (ui.sidebar?.element?.length) {\r\n    inWindow = _coordOverElement(event.pageX, event.pageY, ui.sidebar.element);\r\n  }\r\n  if (!inWindow) {\r\n    inWindow = _coordOverElement(event.pageX, event.pageY, $(event.target).closest('.window-app'));\r\n  }\r\n\r\n  return inWindow;\r\n}\r\n\r\nfunction _coordOverElement(x, y, element) {\r\n  var offset = element.offset();\r\n  let appX = offset.left;\r\n  let appY = offset.top;\r\n  let appW = element.width();\r\n  let appH = element.height();\r\n\r\n  if (x > appX && x < appX + appW && y > appY && y < appY + appH) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction getCompendiumDialog(resolve, { excludePack, exportTo = false, keepIdSelect = false } = {}) {\r\n  let config;\r\n  if (exportTo) {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.export-directory-message'),\r\n      buttonLabel: localize('FOLDER.Export', false),\r\n    };\r\n  } else {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.working-directory-message'),\r\n      buttonLabel: localize('common.swap'),\r\n    };\r\n  }\r\n\r\n  let options = '';\r\n  for (const p of game.packs) {\r\n    if (!p.locked && p.documentName === 'JournalEntry') {\r\n      if (p.collection === excludePack) continue;\r\n      const workingPack = p.collection === PresetCollection.workingPack;\r\n      options += `<option value=\"${p.collection}\" ${workingPack ? 'selected=\"selected\"' : ''}>${p.title}</option>`;\r\n    }\r\n  }\r\n\r\n  let content = `\r\n  <p style=\"color: orangered;\">${config.message}</p>\r\n  <div class=\"form-group\">\r\n    <label>${localize('PACKAGE.TagCompendium', false)}</label>\r\n    <div class=\"form-fields\">\r\n      <select style=\"width: 100%; margin-bottom: 10px;\">${options}</select>\r\n    </div>\r\n  </div>`;\r\n\r\n  if (keepIdSelect) {\r\n    content += `\r\n<div class=\"form-group\">\r\n    <label>${localize('presets.keep-ids')}</label>\r\n    <input type=\"checkbox\" name=\"keepId\" checked>\r\n    <p style=\"font-size: smaller;\">${localize('presets.keep-ids-hint')}</p>\r\n</div>`;\r\n  }\r\n\r\n  new Dialog({\r\n    title: config.title,\r\n    content: content,\r\n    buttons: {\r\n      export: {\r\n        label: config.buttonLabel,\r\n        callback: (html) => {\r\n          const pack = $(html).find('select').val();\r\n          if (keepIdSelect)\r\n            resolve({\r\n              pack,\r\n              keepId: $(html).find('[name=\"keepId\"]').is(':checked'),\r\n            });\r\n          else resolve(pack);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: localize('Cancel', false),\r\n        callback: () => resolve(keepIdSelect ? {} : null),\r\n      },\r\n    },\r\n    close: () => resolve(keepIdSelect ? {} : null),\r\n    default: 'cancel',\r\n  }).render(true);\r\n}\r\n\r\n/**\r\n * Controls select/multi-select flow for item lists\r\n * @param {*} e item click event\r\n * @param {*} itemList list of items that this item exists within\r\n */\r\nfunction itemSelect(e, itemList) {\r\n  const item = $(e.target).closest('.item');\r\n  const items = itemList.find('.item');\r\n  const lastSelected = items.filter('.last-selected');\r\n\r\n  if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {\r\n    lastSelected.removeClass('last-selected');\r\n    items.removeClass('selected');\r\n    item.addClass('selected').addClass('last-selected');\r\n  } else if (e.ctrlKey || e.metaKey) {\r\n    item.toggleClass('selected');\r\n    if (item.hasClass('selected')) {\r\n      lastSelected.removeClass('last-selected');\r\n      item.addClass('last-selected');\r\n    } else item.removeClass('last-index');\r\n  } else if (e.shiftKey) {\r\n    if (lastSelected.length) {\r\n      let itemIndex = items.index(item);\r\n      let lastSelectedIndex = items.index(lastSelected);\r\n\r\n      if (itemIndex === lastSelectedIndex) {\r\n        item.toggleClass('selected');\r\n        if (item.hasClass('selected')) item.addClass('last-selected');\r\n        else lastSelected.removeClass('last-selected');\r\n      } else {\r\n        let itemArr = items.toArray();\r\n        if (itemIndex > lastSelectedIndex) {\r\n          for (let i = lastSelectedIndex; i <= itemIndex; i++) $(itemArr[i]).addClass('selected');\r\n        } else {\r\n          for (let i = lastSelectedIndex; i >= itemIndex; i--) $(itemArr[i]).addClass('selected');\r\n        }\r\n      }\r\n    } else {\r\n      lastSelected.removeClass('last-selected');\r\n      item.toggleClass('selected');\r\n      if (item.hasClass('selected')) item.addClass('last-selected');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Return Mass Edit form that the mouse is over if any\r\n * @param {Number} mouseX\r\n * @param {Number} mouseY\r\n * @param {String} documentName\r\n * @returns {Application|null} MassEdit form\r\n */\r\nfunction hoverMassEditForm(mouseX, mouseY, documentName) {\r\n  const hitTest = function (app) {\r\n    const position = app.position;\r\n    const appX = position.left;\r\n    const appY = position.top;\r\n    const height = Number.isNumeric(position.height) ? position.height : $(app.element).height();\r\n    const width = Number.isNumeric(position.width) ? position.width : $(app.element).width();\r\n\r\n    if (mouseX > appX && mouseX < appX + width && mouseY > appY && mouseY < appY + height) return true;\r\n    return false;\r\n  };\r\n\r\n  const app = getMassEditForm();\r\n  if (app && app.documentName === documentName && hitTest(app)) return app;\r\n  return null;\r\n}\r\n\r\nexport function registerPresetBrowserHooks() {\r\n  // Intercept and prevent certain placeable drag and drop if they are hovering over the MassEditPresets form\r\n  // passing on the placeable to it to perform preset creation.\r\n  const dragDropHandler = function (wrapped, ...args) {\r\n    if (MassEditPresets.objectHover || PresetConfig.objectHover) {\r\n      this.mouseInteractionManager.cancel(...args);\r\n      const app = Object.values(ui.windows).find(\r\n        (x) =>\r\n          (MassEditPresets.objectHover && x instanceof MassEditPresets) ||\r\n          (PresetConfig.objectHover && x instanceof PresetConfig)\r\n      );\r\n      if (app) {\r\n        const placeables = canvas.activeLayer.controlled.length ? [...canvas.activeLayer.controlled] : [this];\r\n        app.dropPlaceable(placeables, ...args);\r\n      }\r\n      // Pass in a fake event that hopefully is enough to allow other modules to function\r\n      this._onDragLeftCancel(...args);\r\n    } else {\r\n      return wrapped(...args);\r\n    }\r\n  };\r\n\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    libWrapper.register(MODULE_ID, `${name}.prototype._onDragLeftDrop`, dragDropHandler, 'MIXED');\r\n  });\r\n\r\n  // Scene Control to open preset browser\r\n  Hooks.on('renderSceneControls', (sceneControls, html, options) => {\r\n    if (!game.user.isGM) return;\r\n    if (!game.settings.get(MODULE_ID, 'presetSceneControl')) return;\r\n\r\n    const presetControl = $(`\r\n<li class=\"scene-control mass-edit-scene-control\" data-control=\"me-presets\" aria-label=\"Mass Edit: Presets\" role=\"tab\" data-tooltip=\"Mass Edit: Presets\">\r\n  <i class=\"fa-solid fa-books\"></i>\r\n</li>\r\n  `);\r\n\r\n    presetControl.on('click', () => {\r\n      let documentName = canvas.activeLayer.constructor.documentName;\r\n      if (!SUPPORTED_PLACEABLES.includes(documentName)) documentName = 'ALL';\r\n\r\n      const presetForm = Object.values(ui.windows).find((app) => app instanceof MassEditPresets);\r\n      if (presetForm) {\r\n        presetForm.close();\r\n        return;\r\n      }\r\n\r\n      new MassEditPresets(null, null, documentName, {\r\n        left: presetControl.position().left + presetControl.width() + 40,\r\n      }).render(true);\r\n    });\r\n\r\n    html.find('.control-tools').find('.scene-control').last().after(presetControl);\r\n  });\r\n\r\n  // Change default behavior of JournalEntry click and context menu within the CompendiumDirectory\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'CompendiumDirectory.prototype._getEntryContextOptions',\r\n    function (wrapped, ...args) {\r\n      const options = wrapped(...args);\r\n      options.push({\r\n        name: 'Open Journal Compendium',\r\n        icon: '<i class=\"fas fa-book-open\"></i>',\r\n        condition: (li) => {\r\n          const pack = game.packs.get(li.data('pack'));\r\n          return pack.metadata.type === 'JournalEntry' && pack.index.get(META_INDEX_ID);\r\n        },\r\n        callback: (li) => {\r\n          const pack = game.packs.get(li.data('pack'));\r\n          pack.render(true);\r\n        },\r\n      });\r\n      console.log(options);\r\n      return options;\r\n    },\r\n    'WRAPPER'\r\n  );\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'CompendiumDirectory.prototype._onClickEntryName',\r\n    async function (wrapped, event) {\r\n      const element = event.currentTarget;\r\n      const packId = element.closest('[data-pack]').dataset.pack;\r\n      const pack = game.packs.get(packId);\r\n      if (pack.metadata.type === 'JournalEntry' && pack.index.get(META_INDEX_ID)) {\r\n        new MassEditPresets(null, null, 'ALL').render(true);\r\n        return;\r\n      }\r\n      return wrapped(event);\r\n    },\r\n    'MIXED'\r\n  );\r\n}\r\n","import { MODULE_ID, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { isImage, isAudio } from '../utils.js';\r\nimport { META_INDEX_FIELDS, META_INDEX_ID, PresetTree } from './collection.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\nimport { decodeURIComponentSafely, isVideo, placeableToData } from './utils.js';\r\n\r\nconst DOCUMENT_FIELDS = ['id', 'name', 'sort', 'folder'];\r\n\r\nconst PRESET_FIELDS = [\r\n  'id',\r\n  'name',\r\n  'data',\r\n  'sort',\r\n  'folder',\r\n  'uuid',\r\n  'documentName',\r\n  'addSubtract',\r\n  'randomize',\r\n  'img',\r\n  'gridSize',\r\n  'modifyOnSpawn',\r\n  'preSpawnScript',\r\n  'postSpawnScript',\r\n  'spawnRandom',\r\n  'attached',\r\n  'tags',\r\n  'preserveLinks',\r\n];\r\n\r\nexport const DOC_ICONS = {\r\n  ALL: 'fas fa-globe',\r\n  FAVORITES: 'fas fa-star',\r\n  Token: 'fas fa-user-circle',\r\n  MeasuredTemplate: 'fas fa-ruler-combined',\r\n  Tile: 'fa-solid fa-cubes',\r\n  Drawing: 'fa-solid fa-pencil-alt',\r\n  Wall: 'fa-solid fa-block-brick',\r\n  AmbientLight: 'fa-regular fa-lightbulb',\r\n  AmbientSound: 'fa-solid fa-music',\r\n  Note: 'fa-solid fa-bookmark',\r\n  Region: 'fa-regular fa-game-board',\r\n  Actor: 'fas fa-user-alt',\r\n  Scene: 'fas fa-map',\r\n  DEFAULT: 'fa-solid fa-question',\r\n};\r\n\r\nexport class Preset {\r\n  static isEditable(uuid) {\r\n    if (uuid.startsWith('virtual@')) return true;\r\n    let { collection } = foundry.utils.parseUuid(uuid);\r\n    if (!collection) return false;\r\n    return !collection.locked;\r\n  }\r\n\r\n  constructor(data) {\r\n    this.id = data.id ?? data._id ?? foundry.utils.randomID();\r\n    this.name = data.name ?? 'Mass Edit Preset';\r\n    this.documentName = data.documentName;\r\n    this.sort = data.sort ?? 0;\r\n    this.tags = data.tags ?? [];\r\n    this.addSubtract =\r\n      data.addSubtract instanceof Array\r\n        ? Object.fromEntries(data.addSubtract)\r\n        : foundry.utils.deepClone(data.addSubtract ?? {});\r\n    this.randomize =\r\n      data.randomize instanceof Array\r\n        ? Object.fromEntries(data.randomize)\r\n        : foundry.utils.deepClone(data.randomize ?? {});\r\n    this.data = foundry.utils.deepClone(data.data);\r\n    this.img = data.img;\r\n    this.folder = data.folder;\r\n    this.uuid = data.uuid;\r\n    this.gridSize = data.gridSize;\r\n    this.modifyOnSpawn = data.modifyOnSpawn;\r\n    this.preSpawnScript = data.preSpawnScript;\r\n    this.postSpawnScript = data.postSpawnScript;\r\n    this.attached = data.attached;\r\n    this.spawnRandom = data.spawnRandom;\r\n    this.preserveLinks = data.preserveLinks;\r\n    this._visible = true;\r\n    this._render = true;\r\n  }\r\n\r\n  get visible() {\r\n    return this._visible && this._render;\r\n  }\r\n\r\n  get icon() {\r\n    return DOC_ICONS[this.documentName] ?? DOC_ICONS.DEFAULT;\r\n  }\r\n\r\n  get thumbnail() {\r\n    if (!this.img) return CONST.DEFAULT_TOKEN;\r\n    else if (isAudio(this.img)) return 'icons/svg/sound.svg';\r\n    else if (isVideo(this.img)) return 'icons/svg/video.svg';\r\n    return this.img;\r\n  }\r\n\r\n  get pages() {\r\n    if (this.document?.pages.size) return this.document.toJSON().pages;\r\n    else if (this._pages) return this._pages;\r\n    return null;\r\n  }\r\n\r\n  set data(data) {\r\n    if (data instanceof Array) this._data = data.length ? data : [{}];\r\n    else if (data == null) this._data = [{}];\r\n    else this._data = [data];\r\n  }\r\n\r\n  get data() {\r\n    return this._data;\r\n  }\r\n\r\n  get isPlaceable() {\r\n    return SUPPORTED_PLACEABLES.includes(this.documentName);\r\n  }\r\n\r\n  get isFavorite() {\r\n    if (!Preset.favorites) Preset.favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n\r\n    return Boolean(Preset.favorites[this.uuid]);\r\n  }\r\n\r\n  get isEmpty() {\r\n    return foundry.utils.isEmpty(this.data[0]);\r\n  }\r\n\r\n  addPostSpawnHook(hook) {\r\n    if (!this._postSpawnHooks) this._postSpawnHooks = [];\r\n    this._postSpawnHooks.push(hook);\r\n  }\r\n\r\n  async callPostSpawnHooks(options) {\r\n    if (this._postSpawnHooks) {\r\n      for (const hook of this._postSpawnHooks) {\r\n        await hook(options);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads underlying JournalEntry document from the compendium\r\n   * @returns this\r\n   */\r\n  async load(force = false) {\r\n    if (this.document && !force) return this;\r\n    if (!this.document && this.uuid) {\r\n      this.document = await fromUuid(this.uuid);\r\n    }\r\n\r\n    if (this.document) {\r\n      const preset = this.document.getFlag(MODULE_ID, 'preset') ?? {};\r\n      this.documentName = preset.documentName;\r\n      this.img = preset.img;\r\n      this.data = preset.data;\r\n      this.randomize =\r\n        foundry.utils.getType(preset.randomize) === 'Object'\r\n          ? preset.randomize\r\n          : Object.fromEntries(preset.randomize ?? []);\r\n      this.addSubtract =\r\n        foundry.utils.getType(preset.addSubtract) === 'Object'\r\n          ? preset.addSubtract\r\n          : Object.fromEntries(preset.addSubtract ?? []);\r\n      this.gridSize = preset.gridSize;\r\n      this.modifyOnSpawn = preset.modifyOnSpawn;\r\n      this.preSpawnScript = preset.preSpawnScript;\r\n      this.postSpawnScript = preset.postSpawnScript;\r\n      this.attached = preset.attached;\r\n      this.spawnRandom = preset.spawnRandom;\r\n      this.preserveLinks = preset.preserveLinks;\r\n      this.tags = preset.tags ?? [];\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  async openJournal() {\r\n    if (!this.document) await this.load();\r\n    if (this.document) this.document.sheet.render(true);\r\n  }\r\n\r\n  /**\r\n   * Attach placeables\r\n   * @param {Placeable|Array[Placeable]} placeables\r\n   * @returns\r\n   */\r\n  async attach(placeables) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    if (!this.attached) this.attached = [];\r\n    for (const placeable of placeables) {\r\n      this.attached.push({ documentName: placeable.document.documentName, data: placeableToData(placeable) });\r\n    }\r\n\r\n    await this.update({ attached: this.attached });\r\n  }\r\n\r\n  /**\r\n   * Update preset with the provided data\r\n   * @param {Object} update\r\n   */\r\n  async update(update) {\r\n    if (this.document) {\r\n      const flagUpdate = {};\r\n      Object.keys(update).forEach((k) => {\r\n        if (k === 'randomize' || k === 'addSubtract') {\r\n          flagUpdate[k] = Object.entries(update[k]);\r\n          this[k] = update[k];\r\n        } else if (k === 'data' && !(update.data instanceof Array)) {\r\n          flagUpdate.data = this.data.map((d) => {\r\n            return foundry.utils.mergeObject(d, update.data);\r\n          });\r\n          this.data = flagUpdate.data;\r\n        } else if (PRESET_FIELDS.includes(k) && update[k] !== this[k]) {\r\n          flagUpdate[k] = update[k];\r\n          this[k] = update[k];\r\n        }\r\n      });\r\n\r\n      if (!foundry.utils.isEmpty(flagUpdate)) {\r\n        const docUpdate = { flags: { [MODULE_ID]: { preset: flagUpdate } } };\r\n        DOCUMENT_FIELDS.forEach((field) => {\r\n          if (field in flagUpdate && this.document[field] !== flagUpdate[field]) {\r\n            docUpdate[field] = flagUpdate[field];\r\n          }\r\n        });\r\n\r\n        await this.document.update(docUpdate);\r\n      }\r\n      await this._updateIndex(flagUpdate);\r\n    } else {\r\n      console.warn('Updating preset without document', this.id, this.uuid, this.name);\r\n    }\r\n  }\r\n\r\n  async _updateIndex(data) {\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((field) => {\r\n      if (field in data) update[field] = data[field];\r\n    });\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      const pack = game.packs.get(this.document.pack);\r\n      const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n      if (metaDoc) {\r\n        let tmp = {};\r\n        tmp[this.id] = update;\r\n        await metaDoc.setFlag(MODULE_ID, 'index', tmp);\r\n        delete PresetTree._packTrees[pack.metadata.name];\r\n      } else {\r\n        console.warn(`META INDEX missing in ${this.document.pack}`);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  toJSON() {\r\n    let json = {};\r\n    PRESET_FIELDS.forEach((field) => {\r\n      json[field] = this[field];\r\n    });\r\n\r\n    json.randomize = Object.entries(json.randomize ?? {});\r\n    json.addSubtract = Object.entries(json.addSubtract ?? {});\r\n    const pages = this.pages;\r\n    if (pages) json.pages = pages;\r\n\r\n    return json;\r\n  }\r\n\r\n  clone() {\r\n    const clone = new Preset(this.toJSON());\r\n    clone.document = this.document;\r\n    return clone;\r\n  }\r\n}\r\n\r\nexport class VirtualFilePreset extends Preset {\r\n  constructor(data) {\r\n    if (!data.name) data.name = data.src.split('/').pop();\r\n    data.name = decodeURIComponentSafely(data.name);\r\n\r\n    data.uuid = 'virtual@' + data.src;\r\n    data.documentName = isAudio(data.src) ? 'AmbientSound' : 'Tile';\r\n\r\n    if (data.documentName === 'Tile') {\r\n      data.data = [{ texture: { src: data.src }, x: 0, y: 0, rotation: 0 }];\r\n      data.img = data.src;\r\n    } else {\r\n      data.data = [{ path: data.src, radius: 20, x: 0, y: 0 }];\r\n      data.img = data.src;\r\n    }\r\n\r\n    data.gridSize = 150;\r\n    super(data);\r\n  }\r\n\r\n  get virtual() {\r\n    return true;\r\n  }\r\n\r\n  async load(force = false) {\r\n    if (this._storedReference) return this;\r\n\r\n    const p = await FileIndexer.getPreset(this.uuid);\r\n    if (p) this.tags = p.tags;\r\n    this._storedReference = p;\r\n\r\n    // Ambient Sound, no further processing required\r\n    if (this.data[0].path) return this;\r\n\r\n    // Load image/video metadata to retrieve the width/height\r\n    const src = this.data[0].texture?.src;\r\n\r\n    let width, height;\r\n    let prom;\r\n    if (isImage(src)) {\r\n      const img = new Image();\r\n      prom = new Promise((resolve) => {\r\n        img.onload = resolve;\r\n        img.src = src;\r\n      });\r\n\r\n      await Promise.race([\r\n        prom,\r\n        (async () => {\r\n          await new Promise((res) => setTimeout(res, 1000));\r\n        })(),\r\n      ]);\r\n\r\n      if (!img.complete || img.naturalWidth === 0) {\r\n        console.log('Image Load failed', src);\r\n        return null;\r\n      }\r\n\r\n      width = img.naturalWidth;\r\n      height = img.naturalHeight;\r\n    } else {\r\n      const video = document.createElement('video');\r\n      prom = new Promise((resolve) => {\r\n        video.onloadedmetadata = resolve;\r\n        video.src = src;\r\n        video.load();\r\n      });\r\n\r\n      await Promise.race([\r\n        prom,\r\n        (async () => {\r\n          await new Promise((res) => setTimeout(res, 1000));\r\n        })(),\r\n      ]);\r\n\r\n      width = video.videoWidth;\r\n      height = video.videoHeight;\r\n    }\r\n\r\n    this.data[0].width = width;\r\n    this.data[0].height = height;\r\n\r\n    return this;\r\n  }\r\n\r\n  async update(update) {\r\n    if (!update.hasOwnProperty('tags')) return;\r\n\r\n    if (this._storedReference) {\r\n      this._storedReference.tags = update.tags;\r\n      clearTimeout(VirtualFilePreset._updateTimeout);\r\n      VirtualFilePreset._updateTimeout = setTimeout(() => FileIndexer.saveIndexToCache(), 3000);\r\n    }\r\n  }\r\n\r\n  clone() {\r\n    const data = this.toJSON();\r\n    data.src = data.img;\r\n    return new VirtualFilePreset(data);\r\n  }\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport { PresetAPI } from './collection.js';\r\n\r\n/**\r\n * Tracking of folder open/close state\r\n */\r\nexport class FolderState {\r\n  static expanded(uuid) {\r\n    return game.folders._expanded[uuid];\r\n  }\r\n\r\n  static setExpanded(uuid, state) {\r\n    game.folders._expanded[uuid] = state;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert provided placeable into an object usable as Preset data\r\n * @param {Placeable} placeable\r\n * @returns\r\n */\r\nexport function placeableToData(placeable) {\r\n  const document = placeable.document ?? placeable;\r\n  const data = document.toObject();\r\n\r\n  // Check if `Token Attacher` has attached elements to this token\r\n  if (\r\n    document.documentName === 'Token' &&\r\n    game.modules.get('token-attacher')?.active &&\r\n    tokenAttacher?.generatePrototypeAttached\r\n  ) {\r\n    const attached = data.flags?.['token-attacher']?.attached || {};\r\n    if (!foundry.utils.isEmpty(attached)) {\r\n      const prototypeAttached = tokenAttacher.generatePrototypeAttached(data, attached);\r\n      foundry.utils.setProperty(data, 'flags.token-attacher.attached', null);\r\n      foundry.utils.setProperty(data, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n      foundry.utils.setProperty(data, 'flags.token-attacher.grid', {\r\n        size: canvas.grid.size,\r\n        w: canvas.grid.sizeX ?? canvas.grid.w, // v12\r\n        h: canvas.grid.sizeY ?? canvas.grid.h, // v12\r\n      });\r\n    }\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * Portions of code taken from Tagger (https://github.com/fantasycalendar/FoundryVTT-Tagger)\r\n * Applies Tagger module's tag rules\r\n * @param {Array[String]} tags\r\n * @returns {Array[String]}\r\n */\r\nexport function applyTaggerTagRules(tags) {\r\n  if (game.modules.get('tagger')?.active) {\r\n    const rules = {\r\n      /**\r\n       * Replaces a portion of the tag with a number based on how many objects in this scene has the same numbered tag\r\n       * @private\r\n       */\r\n      '{#}': (tag, regx) => {\r\n        const findTag = new RegExp('^' + tag.replace(regx, '([1-9]+[0-9]*)') + '$');\r\n        const existingDocuments = Tagger.getByTag(findTag);\r\n        if (!existingDocuments.length) return tag.replace(regx, 1);\r\n\r\n        const numbers = existingDocuments.map((existingDocument) => {\r\n          return Number(\r\n            Tagger.getTags(existingDocument)\r\n              .find((tag) => {\r\n                return tag.match(findTag);\r\n              })\r\n              .match(findTag)[1]\r\n          );\r\n        });\r\n\r\n        const length = Math.max(...numbers) + 1;\r\n        for (let i = 1; i <= length; i++) {\r\n          if (!numbers.includes(i)) {\r\n            return tag.replace(regx, i);\r\n          }\r\n        }\r\n      },\r\n\r\n      /**\r\n       *  Replaces the section of the tag with a random ID\r\n       *  @private\r\n       */\r\n      '{id}': (tag, regx, index) => {\r\n        let id = temporaryIds?.[tag]?.[index];\r\n        if (!id) {\r\n          if (!temporaryIds?.[tag]) {\r\n            temporaryIds[tag] = [];\r\n          }\r\n          id = foundry.utils.randomID();\r\n          temporaryIds[tag].push(id);\r\n        }\r\n        return tag.replace(regx, id);\r\n      },\r\n    };\r\n\r\n    const tagRules = Object.entries(rules).filter((entry) => {\r\n      entry[0] = new RegExp(`${entry[0]}`, 'g');\r\n      return entry;\r\n    });\r\n\r\n    tags = Tagger._validateTags(tags, 'TaggerHandler');\r\n\r\n    tags = tags.map((tag, index) => {\r\n      const applicableTagRules = tagRules.filter(([regx]) => {\r\n        return tag.match(regx);\r\n      });\r\n      if (!applicableTagRules.length) return tag;\r\n\r\n      applicableTagRules.forEach(([regx, method]) => {\r\n        tag = method(tag, regx, index);\r\n      });\r\n\r\n      return tag;\r\n    });\r\n  }\r\n  return tags;\r\n}\r\n\r\n/**\r\n * A Preset may not contain enough information within its data to spawn a placeable. This method populates\r\n * the data with some defaults so that a minimum viable placeable can be spawned.\r\n * @param {Preset} preset\r\n * @param {Object} presetData\r\n * @returns\r\n */\r\nexport function mergePresetDataToDefaultDoc(preset, presetData) {\r\n  let data;\r\n\r\n  // Set default values if needed\r\n  switch (preset.documentName) {\r\n    case 'Token':\r\n      data = { name: preset.name, elevation: 0, x: 0, y: 0, rotation: 0, width: 1, height: 1 };\r\n      break;\r\n    case 'Tile':\r\n      data = {\r\n        width: canvas.grid.sizeX ?? canvas.grid.w, // v12\r\n        height: canvas.grid.sizeY ?? canvas.grid.h, // v12\r\n        x: 0,\r\n        y: 0,\r\n        rotation: 0,\r\n        elevation: 0,\r\n      };\r\n      break;\r\n    case 'AmbientSound':\r\n      data = { radius: 20, x: 0, y: 0 };\r\n      break;\r\n    case 'Drawing':\r\n      data = {\r\n        shape: {\r\n          width: (canvas.grid.sizeX ?? canvas.grid.w) * 2, // v12\r\n          height: (canvas.grid.sizeY ?? canvas.grid.h) * 2, // v12\r\n          strokeWidth: 8,\r\n          strokeAlpha: 1.0,\r\n        },\r\n        x: 0,\r\n        y: 0,\r\n        rotation: 0,\r\n      };\r\n      break;\r\n    case 'MeasuredTemplate':\r\n      data = { distance: 10, x: 0, y: 0 };\r\n      break;\r\n    case 'AmbientLight':\r\n      data = { config: { dim: 20, bright: 20 }, x: 0, y: 0 };\r\n      break;\r\n    case 'Scene':\r\n      data = { name: preset.name };\r\n      break;\r\n    case 'Wall':\r\n      data = { c: [0, 0, canvas.grid.size, 0] };\r\n      break;\r\n    case 'Region':\r\n      data = {\r\n        name: preset.name,\r\n        shapes: [\r\n          {\r\n            type: 'rectangle',\r\n            hole: false,\r\n            x: 0,\r\n            y: 0,\r\n            width: (canvas.grid.sizeX ?? canvas.grid.w) * 2,\r\n            height: (canvas.grid.sizeX ?? canvas.grid.w) * 2,\r\n            rotation: 0,\r\n          },\r\n        ],\r\n      };\r\n      break;\r\n    default:\r\n      data = { x: 0, y: 0 };\r\n  }\r\n\r\n  return foundry.utils.mergeObject(data, presetData);\r\n}\r\n\r\nexport async function randomizeChildrenFolderColors(uuid, tree, callback) {\r\n  const folder = tree.allFolders.get(uuid);\r\n\r\n  const children = folder.children;\r\n  if (!children.length) return;\r\n\r\n  const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n    method: 'interpolateReverse',\r\n    space: 'srgb',\r\n    hue: 'longer',\r\n  });\r\n\r\n  let colorSlider;\r\n\r\n  const applyColors = async function (method, space, hue) {\r\n    const updates = children.map((c) => {\r\n      return {\r\n        color: '#000000',\r\n      };\r\n    });\r\n    const randObj = { color: { type: 'color', method, space, hue, colors: colorSlider.getColors() } };\r\n\r\n    await applyRandomization(updates, children, randObj);\r\n\r\n    for (let i = 0; i < children.length; i++) {\r\n      await children[i].update(updates[i]);\r\n    }\r\n\r\n    callback?.();\r\n  };\r\n\r\n  let dialog = new Dialog({\r\n    title: `Pick Range`,\r\n    content: `<form>${colorTemp}</form>`,\r\n    buttons: {\r\n      save: {\r\n        label: 'Apply',\r\n        callback: async (html) => {\r\n          applyColors(\r\n            html.find('[name=\"method\"]').val(),\r\n            html.find('[name=\"space\"]').val(),\r\n            html.find('[name=\"hue\"]').val()\r\n          );\r\n        },\r\n      },\r\n    },\r\n    render: (html) => {\r\n      import('../randomizer/slider.js').then((module) => {\r\n        colorSlider = new module.ColorSlider(html, [\r\n          { hex: '#663600', offset: 0 },\r\n          { hex: '#944f00', offset: 100 },\r\n        ]);\r\n        setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n      });\r\n    },\r\n  });\r\n\r\n  dialog.render(true);\r\n}\r\n\r\n/**\r\n * Calculates the necessary x and y offsets to place the mouse within the center of the preset data\r\n * assuming the mouse is on the top-left corner of the first element\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataCenterOffset(docToData) {\r\n  const b = getPresetDataBounds(docToData);\r\n  const center = { x: b.x + b.width / 2, y: b.y + b.height / 2 };\r\n  const transform = getTransformToOrigin(docToData);\r\n  return { x: center.x + transform.x, y: center.y + transform.y, z: 0 };\r\n}\r\n\r\n/**\r\n * Returns a transform that return first element to x:0, y:0 (z: 0)\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getTransformToOrigin(docToData) {\r\n  const [name, data] = docToData.entries().next().value;\r\n  const transform = {};\r\n  if (name === 'Wall') {\r\n    const c = data[0].c;\r\n    transform.x = -c[0];\r\n    transform.y = -c[1];\r\n    transform.z = 0;\r\n  } else if (name === 'Region') {\r\n    const b = getDataBounds(name, data[0]);\r\n    transform.x = -b.x1;\r\n    transform.y = -b.y1;\r\n    transform.z = -b.z1;\r\n  } else {\r\n    transform.x = -data[0].x;\r\n    transform.y = -data[0].y;\r\n    transform.z = -(data[0].elevation ?? 0);\r\n  }\r\n  return transform;\r\n}\r\n\r\n/**\r\n * Calculates and returns the overall bounds of the preset data\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataBounds(docToData) {\r\n  let x1 = Number.MAX_SAFE_INTEGER;\r\n  let y1 = Number.MAX_SAFE_INTEGER;\r\n  let x2 = Number.MIN_SAFE_INTEGER;\r\n  let y2 = Number.MIN_SAFE_INTEGER;\r\n  docToData.forEach((dataArr, documentName) => {\r\n    for (const data of dataArr) {\r\n      const b = getDataBounds(documentName, data);\r\n      if (b.x1 < x1) x1 = b.x1;\r\n      if (b.y1 < y1) y1 = b.y1;\r\n      if (b.x2 > x2) x2 = b.x2;\r\n      if (b.y2 > y2) y2 = b.y2;\r\n    }\r\n  });\r\n  return { x: x1, y: y1, width: x2 - x1, height: y2 - y1 };\r\n}\r\n\r\n/**\r\n * Calculates and returns bounds of placeable's data\r\n * @param {String} documentName\r\n * @param {Object} data\r\n * @returns\r\n */\r\nexport function getDataBounds(documentName, data) {\r\n  let x1, y1, x2, y2, z1, z2;\r\n\r\n  if (documentName === 'Wall') {\r\n    x1 = Math.min(data.c[0], data.c[2]);\r\n    y1 = Math.min(data.c[1], data.c[3]);\r\n    x2 = Math.max(data.c[0], data.c[2]);\r\n    y2 = Math.max(data.c[1], data.c[3]);\r\n    z1 = 0;\r\n    z2 = 0;\r\n  } else if (documentName === 'Region') {\r\n    x2 = -Infinity;\r\n    y2 = -Infinity;\r\n    x1 = Infinity;\r\n    y1 = Infinity;\r\n    z1 = data.elevation?.bottom ?? 0;\r\n    z2 = data.elevation?.top ?? 0;\r\n    data.shapes?.forEach((shape) => {\r\n      if (shape.points) {\r\n        for (let i = 0; i < shape.points.length; i += 2) {\r\n          let x = shape.points[i];\r\n          let y = shape.points[i + 1];\r\n          x1 = Math.min(x1, x);\r\n          y1 = Math.min(y1, y);\r\n          x2 = Math.max(x2, x);\r\n          y2 = Math.max(y2, y);\r\n        }\r\n      } else {\r\n        x1 = Math.min(x1, shape.x);\r\n        y1 = Math.min(y1, shape.y);\r\n        x2 = Math.max(x2, shape.x + (shape.radiusX ?? shape.width));\r\n        y2 = Math.max(y2, shape.y + (shape.radiusY ?? shape.height));\r\n      }\r\n    });\r\n    return { x1, y1, x2, y2, z1, z2 };\r\n  } else {\r\n    x1 = data.x || 0;\r\n    y1 = data.y || 0;\r\n    z1 = data.elevation ?? 0;\r\n\r\n    let width, height;\r\n    if (documentName === 'Tile') {\r\n      width = data.width;\r\n      height = data.height;\r\n    } else if (documentName === 'Drawing') {\r\n      width = data.shape.width;\r\n      height = data.shape.height;\r\n    } else if (documentName === 'Token') {\r\n      width = data.width * canvas.dimensions.size;\r\n      height = data.height * canvas.dimensions.size;\r\n    } else {\r\n      width = 0;\r\n      height = 0;\r\n    }\r\n\r\n    x2 = x1 + (width || 0);\r\n    y2 = y1 + (height || 0);\r\n    z2 = z1;\r\n  }\r\n  return { x1, y1, x2, y2, z1, z2 };\r\n}\r\n\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['jpg', 'jpeg', 'png', 'svg', 'webp', 'gif'].includes(extension);\r\n}\r\n\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['mp4', 'ogg', 'webm', 'm4v'].includes(extension);\r\n}\r\n\r\nexport function decodeURIComponentSafely(uri) {\r\n  try {\r\n    return decodeURIComponent(uri);\r\n  } catch (e) {\r\n    console.warn('URI Component not decodable: ' + uri);\r\n    return uri;\r\n  }\r\n}\r\n\r\nexport function encodeURIComponentSafely(uri) {\r\n  try {\r\n    return encodeURIComponent(uri);\r\n  } catch (e) {\r\n    console.warn('URI Component not encodable: ' + uri);\r\n    return uri;\r\n  }\r\n}\r\n\r\nexport async function readJSONFile(url) {\r\n  try {\r\n    return await jQuery.getJSON(url);\r\n  } catch (e) {}\r\n  return null;\r\n}\r\n\r\n/**\r\n * Handle dropping of AmbientSound presets onto the sidebar playlists\r\n */\r\nexport function registerSideBarPresetDropListener() {\r\n  Hooks.on('renderSidebar', (sidebar, html) => {\r\n    if (!game.user.isGM) return;\r\n    html.on('drop', async (event) => {\r\n      const playlistId = $(event.target).closest('.directory-item.playlist').data('document-id');\r\n      if (!playlistId) return;\r\n      const playlist = game.playlists.get(playlistId);\r\n      if (!playlist) return;\r\n\r\n      let data = event.originalEvent.dataTransfer.getData('text/plain');\r\n      if (!data) return;\r\n      data = JSON.parse(data);\r\n\r\n      let presets = (await PresetAPI.getPresets({ uuid: data.uuids, full: false })).filter(\r\n        (p) => p.documentName === 'AmbientSound'\r\n      );\r\n\r\n      for (const p of presets) {\r\n        await p.load();\r\n      }\r\n\r\n      const updates = [];\r\n\r\n      presets.forEach((p) => {\r\n        p.data.forEach((d) => {\r\n          if (d.path) {\r\n            updates.push({\r\n              name: p.name,\r\n              path: d.path,\r\n              channel: 'music',\r\n              repeat: false,\r\n              fade: null,\r\n              description: 'Mass Edit Preset',\r\n              volume: 0.52,\r\n              playing: false,\r\n              pausedTime: null,\r\n              flags: {},\r\n            });\r\n          }\r\n        });\r\n      });\r\n\r\n      PlaylistSound.create(updates, { parent: playlist });\r\n    });\r\n  });\r\n}\r\n","import { getData, regexStringReplace, wildcardStringReplace } from '../utils.js';\r\n\r\nexport function selectField(control) {\r\n  const formGroup = control.closest('.form-group');\r\n  formGroup.find('.mass-edit-checkbox input').prop('checked', true).trigger('change');\r\n  formGroup.find('.mass-edit-randomize').addClass('active');\r\n}\r\n\r\nexport function deselectField(control, configApp) {\r\n  const formGroup = control.closest('.form-group');\r\n\r\n  let allRandomizedRemoved = true;\r\n  if (configApp) {\r\n    formGroup.find('[name]').each(function () {\r\n      if (allRandomizedRemoved) allRandomizedRemoved = !Boolean(configApp.randomizeFields[this.name]);\r\n    });\r\n  }\r\n\r\n  if (allRandomizedRemoved) {\r\n    formGroup.find('.mass-edit-checkbox input').prop('checked', false).trigger('change');\r\n    formGroup.find('.mass-edit-randomize').removeClass('active');\r\n  }\r\n}\r\n\r\nexport function selectRandomizerFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    selectField(form.find(`[name=\"${key}\"]`));\r\n  }\r\n}\r\n\r\nexport async function applyRandomization(updates, objects, randomizeFields) {\r\n  // See if any field is to be randomized\r\n  if (!randomizeFields || foundry.utils.isEmpty(randomizeFields)) return;\r\n\r\n  let requiresCoordRandomization = false;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    for (const field of Object.keys(update)) {\r\n      if (field in randomizeFields) {\r\n        const obj = randomizeFields[field];\r\n\r\n        if (obj.type === 'select') {\r\n          update[field] = obj.selection[Math.floor(Math.random() * obj.selection.length)];\r\n        } else if (obj.type === 'number') {\r\n          obj.step = obj.step === 'any' ? 1 : Number(obj.step);\r\n          if (Number.isNaN(obj.step)) obj.step = 1;\r\n\r\n          if (obj.method === 'interpolate') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step + 1;\r\n            update[field] = (i % stepsInRange) * obj.step + obj.min;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step;\r\n            update[field] = (stepsInRange - (i % (stepsInRange + 1))) * obj.step + obj.min;\r\n          } else {\r\n            const stepsInRange = (obj.max - obj.min + (Number.isInteger(obj.step) ? 1 : 0)) / obj.step;\r\n            update[field] = Math.floor(Math.random() * stepsInRange) * obj.step + obj.min;\r\n          }\r\n        } else if (obj.type === 'boolean') {\r\n          update[field] = Math.random() < 0.5;\r\n        } else if (obj.type === 'color') {\r\n          // Convert to new format if needed\r\n          if (obj.color1) {\r\n            obj.colors = [\r\n              { hex: obj.color1, offset: 0 },\r\n              { hex: obj.color2, offset: 100 },\r\n            ];\r\n          }\r\n\r\n          // If space is discrete we simple choose a color, no blending required\r\n          if (obj.space === 'discrete') {\r\n            if (obj.method === 'interpolate') {\r\n              update[field] = obj.colors[i % obj.colors.length].hex;\r\n            } else if (obj.method === 'interpolateReverse') {\r\n              update[field] = obj.colors[obj.colors.length - 1 - (i % obj.colors.length)].hex;\r\n            } else {\r\n              update[field] = obj.colors[Math.floor(Math.random() * obj.colors.length)].hex;\r\n            }\r\n            continue;\r\n          }\r\n\r\n          let colors = obj.colors.map((c) => c);\r\n          if (colors[0].offset > 0) {\r\n            colors.unshift({ hex: colors[0].hex, offset: 0 });\r\n          }\r\n          if (colors[colors.length - 1].offset < 100) {\r\n            colors.push({ hex: colors[colors.length - 1].hex, offset: 100 });\r\n          }\r\n\r\n          // Calculate random offset\r\n          let rOffset;\r\n          if (obj.method === 'interpolate') {\r\n            rOffset = 1 - (i + 1) / updates.length;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            rOffset = (i + 1) / updates.length;\r\n          } else {\r\n            rOffset = Math.random();\r\n          }\r\n          rOffset *= 100;\r\n\r\n          // Find the two colors the random offset falls between\r\n          let j = 0;\r\n          while (j < colors.length - 1 && colors[j + 1].offset < rOffset) j++;\r\n          let color1, color2;\r\n          if (j === colors.length - 1) {\r\n            color1 = colors[j - 1];\r\n            color2 = colors[j];\r\n          } else {\r\n            color1 = colors[j];\r\n            color2 = colors[j + 1];\r\n          }\r\n\r\n          // Normalize the random offset\r\n          let rnOffset = rOffset - color1.offset;\r\n          rnOffset = rnOffset / (color2.offset - color1.offset);\r\n\r\n          // Create a Color.js range\r\n          const Color = (await import('../color/color.js')).default;\r\n          color1 = new Color(color1.hex);\r\n          color2 = new Color(color2.hex);\r\n          const space = obj.space || 'srgb';\r\n          const hue = obj.hue || 'shorter';\r\n          let range = color1.range(color2, {\r\n            space: space, // interpolation space\r\n            hue: hue,\r\n            outputSpace: 'srgb',\r\n          });\r\n\r\n          // Pick a color from range using normalized random offset\r\n          let rgb3 = range(rnOffset);\r\n          let hexColor = rgb3.toString({ format: 'hex' });\r\n          if (hexColor.length < 7) {\r\n            // 3 char hex, duplicate chars\r\n            hexColor = '#' + hexColor[1] + hexColor[1] + hexColor[2] + hexColor[2] + hexColor[3] + hexColor[3];\r\n          }\r\n          update[field] = hexColor;\r\n        } else if (obj.type === 'image') {\r\n          if (obj.method === 'sequential') {\r\n            update[field] = obj.images[i % obj.images.length];\r\n          } else {\r\n            update[field] = obj.images[Math.floor(Math.random() * obj.images.length)];\r\n          }\r\n\r\n          if (obj.maintainAspect) {\r\n            const width = objects?.[i]?.width ?? update.width;\r\n            const height = objects?.[i]?.height ?? update.height;\r\n            if (height != null && width != null) {\r\n              try {\r\n                const tex = await loadTexture(update[field]);\r\n                if (tex) {\r\n                  const tileRatio = width / height;\r\n                  const texRatio = tex.width / tex.height;\r\n                  if (texRatio !== tileRatio) {\r\n                    if (texRatio > tileRatio) {\r\n                      update['texture.scaleX'] = 1;\r\n                      update['texture.scaleY'] = tileRatio;\r\n                    } else {\r\n                      update['texture.scaleX'] = height / width;\r\n                      update['texture.scaleY'] = 1;\r\n                    }\r\n                  }\r\n                }\r\n              } catch (e) {}\r\n            }\r\n          }\r\n        } else if (obj.type === 'text') {\r\n          if (obj.method === 'findAndReplace' || obj.method === 'findAndReplaceRegex') {\r\n            if (objects) {\r\n              const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n              if (!data[field] && !obj.find) {\r\n                update[field] = obj.replace;\r\n              } else if (data[field]) {\r\n                // special handling for Tagger tags\r\n                if (field === 'flags.tagger.tags') {\r\n                  data[field] = data[field].join(',');\r\n                }\r\n\r\n                if (obj.method === 'findAndReplaceRegex') {\r\n                  update[field] = regexStringReplace(obj.find, obj.replace, data[field]);\r\n                } else {\r\n                  update[field] = wildcardStringReplace(obj.find, obj.replace, data[field]);\r\n                }\r\n              }\r\n            }\r\n          } else {\r\n            if (obj.method === 'unique') {\r\n              if (!obj.shuffled) {\r\n                shuffleArray(obj.strings);\r\n                obj.shuffled = true;\r\n                obj.i = -1;\r\n              }\r\n              obj.i++;\r\n              update[field] = obj.strings[obj.i % obj.strings.length];\r\n            } else {\r\n              update[field] = obj.strings[Math.floor(Math.random() * obj.strings.length)];\r\n            }\r\n          }\r\n        } else if (obj.type === 'coordinate') {\r\n          requiresCoordRandomization = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (requiresCoordRandomization) {\r\n    let coordCtrl;\r\n\r\n    // Sort placeables based on size\r\n    let pUpdates = [];\r\n    for (let i = 0; i < objects.length; i++) {\r\n      pUpdates.push({ p: objects[i], update: updates[i] });\r\n    }\r\n    pUpdates.sort(\r\n      (a, b) =>\r\n        (b.p.w ?? b.p.width ?? 0) + (b.p.h ?? b.p.height ?? 0) - (a.p.w ?? a.p.width ?? 0) - (a.p.h ?? a.p.height ?? 0)\r\n    );\r\n\r\n    for (const pUpdate of pUpdates) {\r\n      const obj = randomizeFields.x ?? randomizeFields.y;\r\n      if (obj.method === 'noOverlap') {\r\n        if (!coordCtrl) {\r\n          coordCtrl = {\r\n            freeId: 0,\r\n            boundingBox: obj.boundingBox,\r\n            freeRectangles: { 0: obj.boundingBox },\r\n            stepX: obj.stepX,\r\n            stepY: obj.stepY,\r\n          };\r\n        }\r\n        const [x, y] = randomPlace(pUpdate.p, coordCtrl);\r\n        pUpdate.update.x = x;\r\n        pUpdate.update.y = y;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the closest step increment to the provided number\r\n * @param {*} num\r\n * @param {*} step\r\n * @returns\r\n */\r\nexport function nearestStep(num, step) {\r\n  if (num % step <= step / 2) {\r\n    return num - (num % step);\r\n  }\r\n  return num - (num % step) + step;\r\n}\r\n\r\n/**\r\n * Generates a random number within the given range and step increment\r\n * @param {*} min\r\n * @param {*} max\r\n * @param {*} step\r\n * @returns\r\n */\r\nfunction randomNum(min, max, step) {\r\n  if (step === 'any') step = 1; // default to integer 1 just to avoid very large decimals\r\n  else step = Number(step);\r\n  const stepsInRange = (max - min) / step;\r\n  return Math.floor(Math.random() * (stepsInRange + (Number.isInteger(step) ? 1 : 0))) * step + min;\r\n}\r\n\r\n/**\r\n * In-place random shuffle of an array\r\n * @param {*} array\r\n * @returns\r\n */\r\nfunction shuffleArray(array) {\r\n  var i = array.length,\r\n    j = 0,\r\n    temp;\r\n\r\n  while (i--) {\r\n    j = Math.floor(Math.random() * (i + 1));\r\n\r\n    // swap randomly chosen element with current element\r\n    temp = array[i];\r\n    array[i] = array[j];\r\n    array[j] = temp;\r\n  }\r\n\r\n  return array;\r\n}\r\n\r\n/* ================================\r\n * === Coordinate Randomization ==\r\n * =============================== */\r\n\r\nfunction randomPlace(placeable, ctrl) {\r\n  const width = nearestStep(placeable.w ?? placeable.width, ctrl.stepX);\r\n  const height = nearestStep(placeable.h ?? placeable.height, ctrl.stepY);\r\n\r\n  const rec = { x: 0, y: 0, width: width, height: height };\r\n  const freeRectangles = ctrl.freeRectangles;\r\n\r\n  // get all free rectangles that can contain rec\r\n  let fittingRecs = Object.keys(freeRectangles).filter((id) => _canFit(freeRectangles[id], rec));\r\n\r\n  // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n\r\n  if (fittingRecs.length) {\r\n    // Pick a random free rectangle and choose a random location within so that it fits rec\r\n    const i = fittingRecs[Math.floor(Math.random() * fittingRecs.length)];\r\n    rec.x = randomNum(\r\n      freeRectangles[i].x,\r\n      Math.max(freeRectangles[i].x + freeRectangles[i].width - rec.width, 0),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      freeRectangles[i].y,\r\n      Math.max(freeRectangles[i].y + freeRectangles[i].height - rec.height, 0),\r\n      ctrl.stepY\r\n    );\r\n  } else {\r\n    // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n    rec.x = randomNum(\r\n      ctrl.boundingBox.x,\r\n      Math.max(ctrl.boundingBox.x + ctrl.boundingBox.width - rec.width, ctrl.boundingBox.x),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      ctrl.boundingBox.y,\r\n      Math.max(ctrl.boundingBox.y + ctrl.boundingBox.height - rec.height, ctrl.boundingBox.y),\r\n      ctrl.stepY\r\n    );\r\n  }\r\n\r\n  // Find all free rectangles that this spot overlaps\r\n  let overlaps = Object.keys(freeRectangles).filter((id) => _intersectRec(freeRectangles[id], rec));\r\n\r\n  for (const id of overlaps) {\r\n    const overlap = freeRectangles[id];\r\n    // remove original rectangle\r\n    delete freeRectangles[id];\r\n\r\n    // left split\r\n    if (overlap.x < rec.x) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: rec.x - overlap.x,\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // right split\r\n    if (overlap.x + overlap.width > rec.x + rec.width) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: rec.x + rec.width,\r\n          y: overlap.y,\r\n          width: overlap.x + overlap.width - (rec.x + rec.width),\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // top split\r\n    if (overlap.y < rec.y) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: overlap.width,\r\n          height: rec.y - overlap.y,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // bottom split\r\n    if (overlap.y + overlap.height > rec.y + rec.height) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: rec.y + rec.height,\r\n          width: overlap.width,\r\n          height: overlap.y + overlap.height - (rec.y + rec.height),\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n  }\r\n\r\n  return [rec.x, rec.y];\r\n}\r\n\r\n/**\r\n * Checks if rectangle rec2 can fit within rectangle rec1\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _canFit(rec1, rec2) {\r\n  return rec2.width <= rec1.width && rec2.height <= rec1.height;\r\n}\r\n\r\n/**\r\n * Checks whether rectangle rec1 and rectangle rec2 intersect\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _intersectRec(rec1, rec2) {\r\n  if (rec1.x < rec2.x + rec2.width && rec2.x < rec1.x + rec1.width && rec1.y < rec2.y + rec2.height)\r\n    return rec2.y < rec1.y + rec1.height;\r\n  else return false;\r\n}\r\n\r\n/**\r\n * Check if rectangle rec1 fully contains rectangle rec2\r\n * @param {*} rec1\r\n * @param {*} rec\r\n * @returns\r\n */\r\nfunction _fullyContains(rec1, rec2) {\r\n  return (\r\n    rec1.x <= rec2.x &&\r\n    rec1.x + rec1.width >= rec2.x + rec2.width &&\r\n    rec1.y <= rec2.y &&\r\n    rec1.y + rec1.height >= rec2.y + rec2.height\r\n  );\r\n}\r\n\r\n/**\r\n *\r\n * @param {*} freeRectangles\r\n * @param {*} rec\r\n * @param {*} ctrl\r\n * @returns\r\n */\r\nfunction _addAndMergeFreeRectangle(freeRectangles, rec, ctrl) {\r\n  const keys = Object.keys(freeRectangles);\r\n  for (const key of keys) {\r\n    if (_fullyContains(freeRectangles[key], rec)) {\r\n      return;\r\n    }\r\n  }\r\n  ctrl.freeId++;\r\n  freeRectangles[ctrl.freeId] = rec;\r\n}\r\n","// SPDX-License-Identifier: MIT\r\n// Copyright  2021 fvtt-lib-wrapper Rui Pinheiro\r\n\r\n'use strict';\r\n\r\n// A shim for the libWrapper library\r\nexport let libWrapper = undefined;\r\n\r\nexport const VERSIONS = [1, 12, 2];\r\nexport const TGT_SPLIT_RE = new RegExp(\r\n  '([^.[]+|\\\\[(\\'([^\\'\\\\\\\\]|\\\\\\\\.)+?\\'|\"([^\"\\\\\\\\]|\\\\\\\\.)+?\")\\\\])',\r\n  'g'\r\n);\r\nexport const TGT_CLEANUP_RE = new RegExp('(^\\\\[\\'|\\'\\\\]$|^\\\\[\"|\"\\\\]$)', 'g');\r\n\r\n// Main shim code\r\nHooks.once('init', () => {\r\n  // Check if the real module is already loaded - if so, use it\r\n  if (globalThis.libWrapper && !(globalThis.libWrapper.is_fallback ?? true)) {\r\n    libWrapper = globalThis.libWrapper;\r\n    return;\r\n  }\r\n\r\n  // Fallback implementation\r\n  libWrapper = class {\r\n    static get is_fallback() {\r\n      return true;\r\n    }\r\n\r\n    static get WRAPPER() {\r\n      return 'WRAPPER';\r\n    }\r\n    static get MIXED() {\r\n      return 'MIXED';\r\n    }\r\n    static get OVERRIDE() {\r\n      return 'OVERRIDE';\r\n    }\r\n\r\n    static register(package_id, target, fn, type = 'MIXED', { chain = undefined, bind = [] } = {}) {\r\n      const is_setter = target.endsWith('#set');\r\n      target = !is_setter ? target : target.slice(0, -4);\r\n      const split = target\r\n        .match(TGT_SPLIT_RE)\r\n        .map((x) => x.replace(/\\\\(.)/g, '$1').replace(TGT_CLEANUP_RE, ''));\r\n      const root_nm = split.splice(0, 1)[0];\r\n\r\n      let obj, fn_name;\r\n      if (split.length == 0) {\r\n        obj = globalThis;\r\n        fn_name = root_nm;\r\n      } else {\r\n        const _eval = eval;\r\n        fn_name = split.pop();\r\n        obj = split.reduce((x, y) => x[y], globalThis[root_nm] ?? _eval(root_nm));\r\n      }\r\n\r\n      let iObj = obj;\r\n      let descriptor = null;\r\n      while (iObj) {\r\n        descriptor = Object.getOwnPropertyDescriptor(iObj, fn_name);\r\n        if (descriptor) break;\r\n        iObj = Object.getPrototypeOf(iObj);\r\n      }\r\n      if (!descriptor || descriptor?.configurable === false)\r\n        throw new Error(\r\n          `libWrapper Shim: '${target}' does not exist, could not be found, or has a non-configurable descriptor.`\r\n        );\r\n\r\n      let original = null;\r\n      const wrapper =\r\n        chain ?? (type.toUpperCase?.() != 'OVERRIDE' && type != 3)\r\n          ? function (...args) {\r\n              return fn.call(this, original.bind(this), ...bind, ...args);\r\n            }\r\n          : function (...args) {\r\n              return fn.call(this, ...bind, ...args);\r\n            };\r\n      if (!is_setter) {\r\n        if (descriptor.value) {\r\n          original = descriptor.value;\r\n          descriptor.value = wrapper;\r\n        } else {\r\n          original = descriptor.get;\r\n          descriptor.get = wrapper;\r\n        }\r\n      } else {\r\n        if (!descriptor.set) throw new Error(`libWrapper Shim: '${target}' does not have a setter`);\r\n        original = descriptor.set;\r\n        descriptor.set = wrapper;\r\n      }\r\n\r\n      descriptor.configurable = true;\r\n      Object.defineProperty(obj, fn_name, descriptor);\r\n    }\r\n  };\r\n});\r\n","export async function applyDDTint(placeable, color) {\r\n  placeable = placeable.object ?? placeable;\r\n  color = _string2hex(color);\r\n  if (placeable instanceof PlaceableObject) {\r\n    if (isNaN(color)) {\r\n      await TokenMagic.deleteFilters(placeable, 'DDTint');\r\n    } else {\r\n      await TokenMagic.addUpdateFilters(placeable, [\r\n        {\r\n          filterType: 'ddTint',\r\n          filterId: 'DDTint',\r\n          tint: PIXI.utils.hex2rgb(color),\r\n        },\r\n      ]);\r\n    }\r\n  } else {\r\n    let filters = placeable['flags.tokenmagic.filters'];\r\n    if (isNaN(color)) {\r\n      if (filters) {\r\n        placeable['flags.tokenmagic.filters'] = filters.filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      placeable['flags.tokenmagic.filters'] = filters;\r\n    }\r\n  }\r\n}\r\n\r\nexport function getDDTint(placeable) {\r\n  let color = 0xff0000;\r\n  let obj = placeable.object ?? placeable;\r\n  if (obj._TMFXgetSprite) {\r\n    const filter = obj._TMFXgetSprite()?.filters?.find((f) => f.filterId === 'DDTint');\r\n    if (filter) color = PIXI.utils.rgb2hex(filter.uniforms.tint);\r\n  }\r\n  return _hex2string(color);\r\n}\r\n\r\nexport async function applyTMFXPreset(placeable, presetName, remove = false) {\r\n  placeable = placeable.object ?? placeable;\r\n  if (!(placeable instanceof PlaceableObject)) return;\r\n  if (presetName === 'DELETE ALL') {\r\n    await TokenMagic.deleteFilters(placeable);\r\n  } else if (remove) {\r\n    await TokenMagic.deleteFilters(placeable, presetName);\r\n  } else {\r\n    const preset = TokenMagic.getPreset(presetName);\r\n    if (preset) await TokenMagic.addUpdateFilters(placeable, foundry.utils.deepClone(preset));\r\n  }\r\n}\r\n\r\nfunction _hex2string(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toHex();\r\n  } else {\r\n    return PIXI.utils.hex2string(color);\r\n  }\r\n}\r\n\r\nfunction _string2hex(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toNumber();\r\n  } else {\r\n    return PIXI.utils.string2hex(color);\r\n  }\r\n}\r\n","import { AUDIO_EXTENSIONS, IMAGE_EXTENSIONS, MODULE_ID, SUPPORTED_PLACEABLES, VIDEO_EXTENSIONS } from './constants.js';\r\nimport { Picker } from './picker.js';\r\nimport { MassEditPresets } from './presets/forms.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\n\r\nexport function interpolateColor(u, c1, c2) {\r\n  return c1.map((a, i) => Math.floor((1 - u) * a + u * c2[i]));\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to an image\r\n */\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return IMAGE_EXTENSIONS.includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to a video\r\n */\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return VIDEO_EXTENSIONS.includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to an audio file\r\n */\r\nexport function isAudio(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return AUDIO_EXTENSIONS.includes(extension);\r\n}\r\n\r\nexport async function recursiveTraverse(path, source, bucket, files = []) {\r\n  const result = await FilePicker.browse(source, path, {\r\n    bucket: bucket,\r\n  });\r\n\r\n  if (result) {\r\n    for (const file of result.files) {\r\n      files.push(file);\r\n    }\r\n\r\n    for (const dir of result.dirs) {\r\n      await recursiveTraverse(dir, source, bucket, files);\r\n    }\r\n  }\r\n\r\n  return files;\r\n}\r\n\r\n// To get rid of v10 warnings\r\nexport function getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n\r\n// Flags are stored inconsistently. Absence of a flag, being set to null, undefined, empty object or empty string\r\n// should all be considered equal\r\nexport function flagCompare(data, flag, flagVal) {\r\n  if (data[flag] == flagVal) return true;\r\n\r\n  const falseyFlagVal =\r\n    flagVal == null ||\r\n    flagVal === false ||\r\n    flagVal === '' ||\r\n    (foundry.utils.getType(flagVal) === 'Object' && foundry.utils.isEmpty(flagVal));\r\n\r\n  const falseyDataVal =\r\n    data[flag] == null ||\r\n    data[flag] === false ||\r\n    data[flag] === '' ||\r\n    (foundry.utils.getType(data[flag]) === 'Object' && foundry.utils.isEmpty(data[flag]));\r\n\r\n  if (falseyFlagVal && falseyDataVal) return true;\r\n\r\n  // Special treatment for Tagger module's tags\r\n  // Instead of directly comparing string we check if it contains the string\r\n  if (flag === 'flags.tagger.tags') {\r\n    const tags = data[flag] || [];\r\n    let compTags = flagVal;\r\n    if (!Array.isArray(compTags)) {\r\n      compTags = flagVal ? flagVal.split(',').map((s) => s.trim()) : [];\r\n    }\r\n    for (const t of compTags) {\r\n      if (!tags.includes(t)) return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  if (flagVal && typeof flagVal === 'string' && flagVal.includes('*')) {\r\n    return wildcardStringMatch(flagVal, data[flag]);\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function hasFlagRemove(flag, formData) {\r\n  const comp = flag.split('.');\r\n  for (let i = comp.length - 1; i >= 1; i--) {\r\n    const tempFlag = comp.slice(0, i).join('.') + '.-=' + comp[i];\r\n    if (tempFlag in formData) {\r\n      return tempFlag;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function selectAddSubtractFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    form\r\n      .find(`[name=\"${key}\"]`)\r\n      .removeClass('me-add')\r\n      .removeClass('me-subtract')\r\n      .addClass(fields[key].method === 'add' ? 'me-add' : 'me-subtract')\r\n      .attr(\r\n        'title',\r\n        fields[key].method === 'add' ? `+ ${localize('form.adding')}` : `- ${localize('form.subtracting')}`\r\n      );\r\n  }\r\n}\r\n\r\nexport function getCommonData(objects) {\r\n  if (!objects || !objects.length) return {};\r\n  const commonData = foundry.utils.flattenObject(objects[0]);\r\n  for (let i = 1; i < objects.length; i++) {\r\n    const diff = foundry.utils.flattenObject(\r\n      foundry.utils.diffObject(commonData, foundry.utils.flattenObject(objects[i]))\r\n    );\r\n    for (const k of Object.keys(diff)) {\r\n      // Special handling for empty/undefined data\r\n      if ((diff[k] === '' || diff[k] == null) && (commonData[k] === '' || commonData[k] == null)) {\r\n        // matches, do not remove\r\n      } else {\r\n        delete commonData[k];\r\n      }\r\n    }\r\n  }\r\n  return commonData;\r\n}\r\n\r\n/**\r\n * Merges 'other' into 'original' without expanding and duplicating the 'original' if it contains dot notation using keys\r\n */\r\nexport function mergeObjectPreserveDot(original, other = {}, nestedKey = '') {\r\n  if (!other) return;\r\n  for (const [key, val] of Object.entries(original)) {\r\n    const fullKey = nestedKey ? nestedKey + '.' + key : key;\r\n    const t = foundry.utils.getType(val);\r\n    if (t === 'Object') mergeObjectPreserveDot(val, other, fullKey);\r\n    else {\r\n      const prop = foundry.utils.getProperty(other, fullKey);\r\n      if (prop !== undefined) {\r\n        original[key] = prop;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function panToFitPlaceables(placeables) {\r\n  placeables = placeables.map((p) => p.object ?? p).filter((p) => p.center);\r\n  if (placeables.length) {\r\n    if (placeables.length === 1) {\r\n      if (placeables[0].center?.x) {\r\n        canvas.animatePan({ x: placeables[0].center.x, y: placeables[0].center.y, duration: 250 });\r\n      }\r\n    } else {\r\n      // Determine top left and bottom right corners to later determine the view's center position and scale\r\n      const topLeft = { x: 999999999, y: 999999999 };\r\n      const bottomRight = { x: -999999999, y: -999999999 };\r\n\r\n      for (let p of placeables) {\r\n        let tlc = p;\r\n        if (p instanceof Wall) {\r\n          tlc = { x: p.center.x - p.width / 2, y: p.center.y - p.height / 2 };\r\n        }\r\n\r\n        if (tlc.x < topLeft.x) topLeft.x = tlc.x;\r\n        if (tlc.y < topLeft.y) topLeft.y = tlc.y;\r\n        if (tlc.x + p.width > bottomRight.x) bottomRight.x = tlc.x + p.width;\r\n        if (tlc.y + p.height > bottomRight.y) bottomRight.y = tlc.y + p.height;\r\n      }\r\n\r\n      // Checking if screen at current scale fits placeables along x and y axis\r\n      let scale = canvas.scene._viewPosition.scale;\r\n      // Adjust the size of the rectangle that placeable occupy in our scale calculations\r\n      // to account for UI elements\r\n      const padding = 100;\r\n      if (bottomRight.x - topLeft.x + padding > canvas.screenDimensions[0] / scale) {\r\n        scale = canvas.screenDimensions[0] / (bottomRight.x - topLeft.x + padding);\r\n      }\r\n      if (bottomRight.y - topLeft.y + padding > canvas.screenDimensions[1] / scale) {\r\n        scale = canvas.screenDimensions[1] / (bottomRight.y - topLeft.y + padding);\r\n      }\r\n\r\n      canvas.animatePan({\r\n        duration: 250,\r\n        scale,\r\n        x: (bottomRight.x - topLeft.x) / 2 + topLeft.x,\r\n        y: (bottomRight.y - topLeft.y) / 2 + topLeft.y,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns a hash code from a string\r\n * @param  {String} str The string to hash.\r\n * @return {Number}    A 32bit integer\r\n * @see http://werxltd.com/wp/2010/05/13/javascript-implementation-of-javas-string-hashcode-method/\r\n */\r\nexport function hashCode(str) {\r\n  let hash = 0;\r\n  for (let i = 0, len = str.length; i < len; i++) {\r\n    let chr = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + chr;\r\n    hash |= 0; // Convert to 32bit integer\r\n  }\r\n  return hash;\r\n}\r\n\r\nfunction escapeRegex(string) {\r\n  return string.replace(/[/\\-\\\\^$+?.()|[\\]{}]/g, '\\\\$&');\r\n}\r\n\r\nexport function wildcardStringMatch(sw, s2) {\r\n  return new RegExp('^' + escapeRegex(sw).replaceAll('*', '.*') + '$').test(s2);\r\n}\r\n\r\nexport function wildcardStringReplace(sw, replaceWith, s2) {\r\n  let re = new RegExp(escapeRegex(sw).replaceAll('*', '.*'), 'g');\r\n  return s2.replaceAll(re, replaceWith);\r\n}\r\n\r\nexport function regexStringReplace(sw, replaceWith, s2) {\r\n  try {\r\n    let re = new RegExp(sw, 'g');\r\n    return s2.replaceAll(re, replaceWith);\r\n  } catch (e) {}\r\n  return s2;\r\n}\r\n\r\nexport function flattenToDepth(obj, d = 0) {\r\n  if (d === 0) return obj;\r\n\r\n  const flat = {};\r\n  for (let [k, v] of Object.entries(obj)) {\r\n    let t = foundry.utils.getType(v);\r\n    if (t === 'Object') {\r\n      if (foundry.utils.isEmpty(v)) flat[k] = v;\r\n      let inner = flattenToDepth(v, d - 1);\r\n      for (let [ik, iv] of Object.entries(inner)) {\r\n        flat[`${k}.${ik}`] = iv;\r\n      }\r\n    } else flat[k] = v;\r\n  }\r\n  return flat;\r\n}\r\n\r\nexport function activeEffectPresetSelect(aeConfig) {\r\n  const showPresetGeneric = function (documentName) {\r\n    new MassEditPresets(\r\n      aeConfig,\r\n      async (preset) => {\r\n        if (!foundry.utils.isEmpty(preset.randomize)) {\r\n          await applyRandomization(preset.data, null, preset.randomize);\r\n        }\r\n\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        Object.keys(preset.data[0]).forEach((k) => {\r\n          let value;\r\n          if (foundry.utils.getType(preset.data[0][k]) === 'string') value = preset.data[0][k];\r\n          else value = JSON.stringify(preset.data[0][k]);\r\n\r\n          nChanges.push({\r\n            key: documentName === 'Token' ? 'ATL.' + k : k,\r\n            mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE,\r\n            priority: 20,\r\n            value,\r\n          });\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      documentName\r\n    ).render(true);\r\n  };\r\n\r\n  const showPresetActiveEffect = function () {\r\n    new MassEditPresets(\r\n      aeConfig,\r\n      (preset) => {\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        preset.data[0].changes?.forEach((change) => {\r\n          if (change.key) {\r\n            nChanges.push(\r\n              foundry.utils.mergeObject({ mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE, priority: 20 }, change)\r\n            );\r\n          }\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      'ActiveEffect'\r\n    ).render(true);\r\n  };\r\n\r\n  new Dialog({\r\n    title: localize('common.presets'),\r\n    content: ``,\r\n    buttons: {\r\n      activeEffect: {\r\n        label: 'ActiveEffect',\r\n        callback: () => showPresetActiveEffect(),\r\n      },\r\n      token: {\r\n        label: 'Token',\r\n        callback: () => showPresetGeneric('Token'),\r\n      },\r\n      actor: {\r\n        label: 'Actor',\r\n        callback: () => showPresetGeneric('Actor'),\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport function getDocumentName(doc) {\r\n  const documentName = doc.document ? doc.document.documentName : doc.documentName;\r\n  return documentName ?? 'NONE';\r\n}\r\n\r\nexport const DOCUMENT_CREATE_REQUESTS = {};\r\n\r\n/**\r\n * Creates documents either directly or by delegating the task to a GM\r\n * @param {String} documentName  document type to be created\r\n * @param {Array[Object]} data   data defining the documents\r\n * @param {String} sceneID       scene the documents should be created on\r\n * @returns placeable documents that have been created\r\n */\r\nexport async function createDocuments(documentName, data, sceneID) {\r\n  if (game.user.isGM) {\r\n    return game.scenes.get(sceneID).createEmbeddedDocuments(documentName, data);\r\n  }\r\n\r\n  const requestID = foundry.utils.randomID();\r\n\r\n  const message = {\r\n    handlerName: 'document',\r\n    args: { sceneID, documentName, data, requestID },\r\n    type: 'CREATE',\r\n  };\r\n  game.socket.emit(`module.${MODULE_ID}`, message);\r\n\r\n  // Self resolve in 4s if no response from a GM is received\r\n  setTimeout(() => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID]?.([]);\r\n  }, 4000);\r\n\r\n  return new Promise((resolve) => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID] = resolve;\r\n  });\r\n}\r\n\r\n/**\r\n * Resolves the delegated create documents request\r\n * @param {object} options\r\n * @param {String} options.requestID          request to be resolved\r\n * @param {String} options.sceneID            scene the documents have been created on\r\n * @param {String} options.documentName       type of document that has been created\r\n * @param {Array[String]} options.documentIDs array of document ids that have been created\r\n */\r\nexport function resolveCreateDocumentRequest({ requestID, sceneID, documentName, documentIDs } = {}) {\r\n  if (!DOCUMENT_CREATE_REQUESTS.hasOwnProperty(requestID)) return;\r\n\r\n  const scene = game.scenes.get(sceneID);\r\n  const documents = [];\r\n  for (const docID of documentIDs) {\r\n    documents.push(scene.getEmbeddedDocument(documentName, docID));\r\n  }\r\n\r\n  DOCUMENT_CREATE_REQUESTS[requestID](documents);\r\n  delete DOCUMENT_CREATE_REQUESTS[requestID];\r\n}\r\n\r\nexport async function updateEmbeddedDocumentsViaGM(documentName, updates, context, scene) {\r\n  if (game.user.isGM) {\r\n    return scene.updateEmbeddedDocuments(documentName, updates, context);\r\n  } else {\r\n    const message = {\r\n      handlerName: 'document',\r\n      args: { sceneID: scene.id, documentName, updates, context },\r\n      type: 'UPDATE',\r\n    };\r\n    game.socket.emit(`module.${MODULE_ID}`, message);\r\n  }\r\n}\r\n\r\nexport function isResponsibleGM() {\r\n  return game.users.filter((u) => u.active && u.isGM).sort((a, b) => b.role - a.role || a.id.compare(b.id))[0]?.isSelf;\r\n}\r\n\r\nexport function localize(path, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.localize(`MassEdit.${path}`);\r\n  return game.i18n.localize(path);\r\n}\r\n\r\nexport function localFormat(path, insert, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.format(`MassEdit.${path}`, insert);\r\n  return game.i18n.format(path, insert);\r\n}\r\n\r\nexport async function applyPresetToScene(preset) {\r\n  if (preset && canvas.scene) {\r\n    await preset.load();\r\n    const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n    const randomizer = preset.randomize;\r\n    if (!foundry.utils.isEmpty(randomizer)) {\r\n      await applyRandomization([data], null, randomizer);\r\n    }\r\n\r\n    await canvas.scene.update(data);\r\n\r\n    // Grid doesn't redraw on scene update, do it manually here\r\n    if ('grid.color' in data || 'grid.alpha' in data) {\r\n      canvas.grid.grid.draw({\r\n        color: (data['grid.color'] ?? canvas.scene.grid.color).replace('#', '0x'),\r\n        alpha: Number(data['grid.alpha'] ?? canvas.scene.grid.alpha),\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport async function executeScript(command, { actor, token, ...scope } = {}) {\r\n  // Add variables to the evaluation scope\r\n  const speaker = ChatMessage.implementation.getSpeaker({ actor, token });\r\n  const character = game.user.character;\r\n  token = token || (canvas.ready ? canvas.tokens.get(speaker.token) : null);\r\n  actor = actor || token?.actor || game.actors.get(speaker.actor);\r\n\r\n  // Unpack argument names and values\r\n  const argNames = Object.keys(scope);\r\n  if (argNames.some((k) => Number.isNumeric(k))) {\r\n    throw new Error('Illegal numeric Macro parameter passed to execution scope.');\r\n  }\r\n  const argValues = Object.values(scope);\r\n\r\n  // Define an AsyncFunction that wraps the macro content\r\n  const AsyncFunction = async function () {}.constructor;\r\n  // eslint-disable-next-line no-new-func\r\n  const fn = new AsyncFunction('speaker', 'actor', 'token', 'character', 'scope', ...argNames, `{${command}\\n}`);\r\n\r\n  // Attempt macro execution\r\n  try {\r\n    return await fn.call(this, speaker, actor, token, character, scope, ...argValues);\r\n  } catch (err) {\r\n    ui.notifications.error('MACRO.Error', { localize: true });\r\n  }\r\n}\r\n\r\nexport class SeededRandom {\r\n  /**\r\n   * Seeded variation of the Foundry's randomID(...) function.\r\n   * Generate a random string ID of a given requested length.\r\n   * @param {String} seed      Seed to be fed into random number generator\r\n   * @param {number} length    The length of the random ID to generate\r\n   * @return {string}          Return a string containing random letters and numbers\r\n   */\r\n  static randomID(seed, length = 16) {\r\n    seed = this.cyrb128(seed);\r\n    const random = this.sfc32(seed[0], seed[1], seed[2], seed[3]);\r\n\r\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    const r = Array.from({ length }, () => (random() * chars.length) >> 0);\r\n    return r.map((i) => chars[i]).join('');\r\n  }\r\n\r\n  // Courtesy of bryc\r\n  // github.com/bryc\r\n  static cyrb128(str) {\r\n    let h1 = 1779033703,\r\n      h2 = 3144134277,\r\n      h3 = 1013904242,\r\n      h4 = 2773480762;\r\n    for (let i = 0, k; i < str.length; i++) {\r\n      k = str.charCodeAt(i);\r\n      h1 = h2 ^ Math.imul(h1 ^ k, 597399067);\r\n      h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);\r\n      h3 = h4 ^ Math.imul(h3 ^ k, 951274213);\r\n      h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);\r\n    }\r\n    h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);\r\n    h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);\r\n    h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);\r\n    h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);\r\n    (h1 ^= h2 ^ h3 ^ h4), (h2 ^= h1), (h3 ^= h1), (h4 ^= h1);\r\n    return [h1 >>> 0, h2 >>> 0, h3 >>> 0, h4 >>> 0];\r\n  }\r\n\r\n  // Courtesy of Chris Doty-Humphrey\r\n  // https://pracrand.sourceforge.net/\r\n  static sfc32(a, b, c, d) {\r\n    return function () {\r\n      a |= 0;\r\n      b |= 0;\r\n      c |= 0;\r\n      d |= 0;\r\n      var t = (((a + b) | 0) + d) | 0;\r\n      d = (d + 1) | 0;\r\n      a = b ^ (b >>> 9);\r\n      b = (c + (c << 3)) | 0;\r\n      c = (c << 21) | (c >>> 11);\r\n      c = (c + t) | 0;\r\n      return (t >>> 0) / 4294967296;\r\n    };\r\n  }\r\n}\r\n\r\nexport class TagInput {\r\n  static simplifyString(str) {\r\n    return str.replace(/[^0-9a-zA-Z_\\- ]/gi, '').toLowerCase();\r\n  }\r\n\r\n  static registerHandlebarsHelper() {\r\n    Handlebars.registerHelper('tagInput', (options) => {\r\n      const name = options.hash.name;\r\n      const label = options.hash.label ?? 'Tags';\r\n      const listId = options.hash.listId;\r\n      const listEntries = options.hash.listEntries;\r\n\r\n      let tags = options.hash.tags;\r\n      if (!Handlebars.Utils.isArray(tags)) tags = [];\r\n\r\n      // Construct the HTML\r\n      let tagHtml = '';\r\n      tags.forEach((tag) => {\r\n        tagHtml += this._tagField(tag);\r\n      });\r\n\r\n      // DataList\r\n      let listAttr = '';\r\n      let dataList = '';\r\n      if (listId && listEntries) {\r\n        listAttr = `list=\"${listId}\"`;\r\n\r\n        dataList = `<datalist id=\"${listId}\"><option value=\"DELETE\"><option value=\"DELETE ALL\">`;\r\n        listEntries.forEach((le) => {\r\n          dataList += `<option value=\"${le}\">`;\r\n        });\r\n        dataList += `</datalist>`;\r\n      }\r\n\r\n      return new Handlebars.SafeString(`\r\n      ${dataList}\r\n      <fieldset>\r\n        <legend>${label}</legend>\r\n        <div class=\"form-group me-tags\">\r\n            <input type=\"text\" ${listAttr} class=\"tag-input\">  \r\n            <input type=\"text\" class=\"tag-hidden-input\" name=\"${name}\" value=\"${tags.join(',')}\" hidden>\r\n            <button type=\"button\" class=\"add-tag\"><i class=\"fas fa-save\" style=\"margin: auto;\"></i></button>\r\n            <div class=\"tag-container\">${tagHtml}</div>\r\n        </div>\r\n      </fieldset>\r\n    `);\r\n    });\r\n  }\r\n\r\n  static _tagField(tag) {\r\n    return `<div class=\"tag\"><span>${tag}</span> <a class=\"delete-tag\"><i class=\"fa-solid fa-x fa-xs\"></i></a></div>`;\r\n  }\r\n\r\n  static activateListeners(html, { change, simplifyTags = true } = {}) {\r\n    html.find('.me-tags .add-tag').on('click', (event) => {\r\n      const meTags = $(event.target).closest('.me-tags');\r\n      const input = meTags.find('.tag-input');\r\n\r\n      const newTags = input\r\n        .val()\r\n        .split(',')\r\n        .map((t) => {\r\n          t = t.trim();\r\n          if (simplifyTags) t = this.simplifyString(t);\r\n          return t;\r\n        })\r\n        .filter(Boolean);\r\n\r\n      if (newTags.length) {\r\n        input.val('');\r\n        const hiddenInput = meTags.find('.tag-hidden-input');\r\n        const currentTags = hiddenInput.val().split(',').filter(Boolean);\r\n        for (const tag of newTags) {\r\n          if (!currentTags.includes(tag)) {\r\n            currentTags.push(tag);\r\n            meTags.find('.tag-container').append(this._tagField(tag));\r\n          }\r\n        }\r\n        hiddenInput.attr('value', currentTags.join(','));\r\n        change?.(currentTags);\r\n      }\r\n    });\r\n\r\n    html.find('.me-tags').on('click', '.delete-tag', (event) => {\r\n      const tag = $(event.target).closest('.tag');\r\n\r\n      // Remove tag from hidden input\r\n      const tagValue = tag.find('span').text();\r\n      const hiddenInput = tag.closest('.me-tags').find('.tag-hidden-input');\r\n      const newTags = hiddenInput\r\n        .val()\r\n        .split(',')\r\n        .filter((t) => t !== tagValue);\r\n      hiddenInput.attr('value', newTags.join(','));\r\n\r\n      // Remove the tag element itself\r\n      tag.remove();\r\n\r\n      change?.(newTags);\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Activates Picker allowing drag selection of document across all placeables layers\r\n * @returns {Array[CanvasDocumentMixin]}\r\n */\r\nexport async function pickerSelectMultiLayerDocuments() {\r\n  // Activate picker to define select box\r\n  const coords = await new Promise(async (resolve) => {\r\n    Picker.activate(resolve);\r\n  });\r\n  if (!coords) return [];\r\n\r\n  // Selects placeables within the bounding box\r\n  const selectionRect = new PIXI.Rectangle(\r\n    coords.start.x,\r\n    coords.start.y,\r\n    coords.end.x - coords.start.x,\r\n    coords.end.y - coords.start.y\r\n  );\r\n\r\n  let selected = [];\r\n  SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n    canvas.getLayerByEmbeddedName(documentName).placeables.forEach((p) => {\r\n      const c = p.center;\r\n      if (selectionRect.contains(c.x, c.y)) selected.push(p.document);\r\n    });\r\n  });\r\n\r\n  return selected;\r\n}\r\n","module.exports = jQuery;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.f = {};\n// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = (chunkId) => {\n\treturn Promise.all(Object.keys(__webpack_require__.f).reduce((promises, key) => {\n\t\t__webpack_require__.f[key](chunkId, promises);\n\t\treturn promises;\n\t}, []));\n};","// This function allow to reference async chunks\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".bundle.js\";\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.p = \"modules/multi-token-edit/\";","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t792: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {\n\t\t// JSONP chunk loading for javascript\n\t\tvar installedChunkData = __webpack_require__.o(installedChunks, chunkId) ? installedChunks[chunkId] : undefined;\n\t\tif(installedChunkData !== 0) { // 0 means \"already installed\".\n\n\t\t\t// a Promise means \"currently loading\".\n\t\t\tif(installedChunkData) {\n\t\t\t\tpromises.push(installedChunkData[2]);\n\t\t\t} else {\n\t\t\t\tif(true) { // all chunks have JS\n\t\t\t\t\t// setup Promise in chunk cache\n\t\t\t\t\tvar promise = new Promise((resolve, reject) => (installedChunkData = installedChunks[chunkId] = [resolve, reject]));\n\t\t\t\t\tpromises.push(installedChunkData[2] = promise);\n\n\t\t\t\t\t// start chunk loading\n\t\t\t\t\tvar url = __webpack_require__.p + __webpack_require__.u(chunkId);\n\t\t\t\t\t// create error before stack unwound to get useful stacktrace later\n\t\t\t\t\tvar error = new Error();\n\t\t\t\t\tvar loadingEnded = (event) => {\n\t\t\t\t\t\tif(__webpack_require__.o(installedChunks, chunkId)) {\n\t\t\t\t\t\t\tinstalledChunkData = installedChunks[chunkId];\n\t\t\t\t\t\t\tif(installedChunkData !== 0) installedChunks[chunkId] = undefined;\n\t\t\t\t\t\t\tif(installedChunkData) {\n\t\t\t\t\t\t\t\tvar errorType = event && (event.type === 'load' ? 'missing' : event.type);\n\t\t\t\t\t\t\t\tvar realSrc = event && event.target && event.target.src;\n\t\t\t\t\t\t\t\terror.message = 'Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')';\n\t\t\t\t\t\t\t\terror.name = 'ChunkLoadError';\n\t\t\t\t\t\t\t\terror.type = errorType;\n\t\t\t\t\t\t\t\terror.request = realSrc;\n\t\t\t\t\t\t\t\tinstalledChunkData[1](error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t__webpack_require__.l(url, loadingEnded, \"chunk-\" + chunkId, chunkId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n};\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n// no on chunks loaded\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunk\"] = self[\"webpackChunk\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","import { MODULE_ID, SUPPORTED_PLACEABLES } from './constants.js';\r\nimport { DataTransform } from './picker.js';\r\nimport { getDataBounds } from './presets/utils.js';\r\n\r\n/**\r\n * Enable 'Select' tool for layers that do not have it. (AmbientLight, AmbientSound, MeasuredTemplate, and Note)\r\n */\r\nexport function enableUniversalSelectTool() {\r\n  if (game.modules.get('select-tool-everywhere')?.active) return;\r\n\r\n  const missingLayers = ['AmbientLight', 'AmbientSound', 'MeasuredTemplate', 'Note'];\r\n\r\n  missingLayers.forEach((layer) => {\r\n    Hooks.on(`refresh${layer}`, _placeableRefresh);\r\n  });\r\n\r\n  Hooks.on('canvasReady', () => {\r\n    missingLayers.forEach((layer) => (canvas.getLayerByEmbeddedName(layer).options.controllableObjects = true));\r\n    if (SUPPORTED_PLACEABLES.includes('Region')) canvas.regions.options.rotatableObjects = true;\r\n  });\r\n\r\n  Hooks.on('getSceneControlButtons', (controls) => _getControlButtons(controls));\r\n\r\n  // :: Fixes ::\r\n\r\n  // For notes the refresh hook is called while ControlIcon is still loading its texture (see ControlIcon.draw())\r\n  // Once the texture is loaded border visibility will be reset to false undoing our change in _placeableRefresh\r\n  // Instead delay and set visibility after draw to account for this\r\n  Hooks.on('drawNote', (note) => {\r\n    setTimeout(() => _placeableRefresh(note), 10);\r\n  });\r\n\r\n  // To avoid race conditions between multiple AmbientLight _onDragLeftCancel calls we'll defer the\r\n  // canvas.perception update within 'updateSource' via a 'defer' argument\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'AmbientLight.prototype._onDragLeftCancel',\r\n    function (...args) {\r\n      Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this, args);\r\n      // V12\r\n      if (this.initializeLightSource) this.initializeLightSource({ defer: true });\r\n      else this.updateSource({ defer: true });\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  if (foundry.utils.isNewerVersion(game.version, 12)) registerRegionWrappers();\r\n}\r\n\r\n/**\r\n * Insert select tool if missing\r\n */\r\nfunction _getControlButtons(controls) {\r\n  for (const control of controls) {\r\n    if (['lighting', 'sounds', 'measure'].includes(control.name)) {\r\n      if (!control.tools.find((t) => t.name === 'select')) {\r\n        control.tools.unshift({\r\n          name: 'select',\r\n          title: 'CONTROLS.CommonSelect',\r\n          icon: 'fas fa-expand',\r\n        });\r\n        control.activeTool = 'select';\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction _placeableRefresh(placeable) {\r\n  if (placeable.controlled) placeable.controlIcon.border.visible = true;\r\n}\r\n\r\nfunction registerRegionWrappers() {\r\n  // Enable drag\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype._canDrag',\r\n    function () {\r\n      return game.user.isGM;\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype._onDragLeftMove',\r\n    function (event) {\r\n      canvas._onDragCanvasPan(event);\r\n      const { clones, destination, origin } = event.interactionData;\r\n      const { x1, y1 } = getDataBounds('Region', this.document);\r\n\r\n      // Calculate the (snapped) position of the dragged object\r\n      let position = {\r\n        x: x1 + (destination.x - origin.x),\r\n        y: y1 + (destination.y - origin.y),\r\n      };\r\n\r\n      if (!event.shiftKey) position = this.layer.getSnappedPoint(position);\r\n\r\n      const dx = position.x - x1;\r\n      const dy = position.y - y1;\r\n      for (const c of clones || []) {\r\n        DataTransform.apply('Region', c.document.toObject(), { x: 0, y: 0 }, { x: dx, y: dy }, c);\r\n        c.visible = true;\r\n        c._onUpdate({ shapes: null });\r\n      }\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype._prepareDragLeftDropUpdates',\r\n    function (event) {\r\n      const updates = [];\r\n      for (const clone of event.interactionData.clones) {\r\n        updates.push({ _id: clone._original.id, shapes: clone.document.toObject(false).shapes });\r\n      }\r\n      return updates;\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  // Enable rotation\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype.rotate',\r\n    async function (delta, snap) {\r\n      if (game.paused && !game.user.isGM) {\r\n        ui.notifications.warn('GAME.PausedWarning', { localize: true });\r\n        return this;\r\n      }\r\n\r\n      const data = this.document.toObject();\r\n      const { x1, y1, x2, y2 } = getDataBounds('Region', data);\r\n      const origin = {\r\n        x: x1 + (x2 - x1) / 2,\r\n        y: y1 + (y2 - y1) / 2,\r\n      };\r\n\r\n      DataTransform.apply('Region', data, origin, { rotation: delta });\r\n      await this.document.update({ shapes: data.shapes }, { meRotation: delta });\r\n      return this;\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'RegionLayer.prototype._onMouseWheel',\r\n    function (event) {\r\n      // Identify the hovered light source\r\n      const region = this.hover;\r\n      if (!region || region.isPreview || region.document.shapes.some((s) => s.type === 'ellipse')) return;\r\n\r\n      // Determine the incremental angle of rotation from event data\r\n      const snap = event.shiftKey ? 15 : 3;\r\n      const delta = snap * Math.sign(event.delta);\r\n\r\n      region.rotate(delta, snap);\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { META_INDEX_ID, PresetCollection } from './collection.js';\r\n\r\nexport class V12Migrator {\r\n  static async migrateAllPacks({ migrateFunc = null, coreMigration = false } = {}) {\r\n    if (!migrateFunc && !coreMigration) {\r\n      ui.notifications.warn('Specify either a `migrateFunc` or enable `coreMigration` flag.');\r\n      return;\r\n    }\r\n\r\n    for (const pack of game.packs) {\r\n      if (pack.documentName !== 'JournalEntry') continue;\r\n      if (!pack.index.get(META_INDEX_ID)) continue;\r\n      else if (pack.locked) {\r\n        console.warn(`Mass Edit - Unable to migrate a locked compendium. ${pack.metadata.label}`);\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        this.migratePack({ pack, migrateFunc, coreMigration });\r\n      } catch (e) {\r\n        console.warn(`Mass Edit - Ran into an issue while migrating ${pack.metadata.label}`);\r\n        console.error(e);\r\n      }\r\n    }\r\n  }\r\n\r\n  static async migratePack({ pack = PresetCollection.workingPack, migrateFunc = null, coreMigration = false } = {}) {\r\n    if (foundry.utils.getType(pack) === 'string') {\r\n      let fPack = game.packs.get(pack) || game.packs.find((p) => p.metadata.label === pack);\r\n      if (!fPack) {\r\n        console.warn('Invalid pack: ' + pack);\r\n        return;\r\n      }\r\n      pack = fPack;\r\n    }\r\n\r\n    if (!pack.index.get(META_INDEX_ID)) {\r\n      console.warn(`Mass Edit - This is not a preset compendium. ${pack.metadata.label}`);\r\n      return;\r\n    }\r\n\r\n    if (pack.locked) {\r\n      console.warn(`Mass Edit - Unable to migrate a locked compendium. ${pack.metadata.label}`);\r\n      return;\r\n    }\r\n\r\n    if (!migrateFunc && !coreMigration) {\r\n      ui.notifications.warn('Specify either a `migrateFunc` or enable `coreMigration` flag.');\r\n      return;\r\n    }\r\n\r\n    const updates = [];\r\n    const documents = await pack.getDocuments();\r\n\r\n    for (const document of documents) {\r\n      const preset = document.getFlag(MODULE_ID, 'preset');\r\n      if (!preset) continue;\r\n\r\n      let update = {};\r\n\r\n      // Migrate Preset data\r\n      if (preset.data?.length) {\r\n        this._migrateData(preset.data, preset.documentName, coreMigration, migrateFunc);\r\n        foundry.utils.setProperty(update, `flags.${MODULE_ID}.preset.data`, preset.data);\r\n      }\r\n\r\n      // Convert attached Preset data\r\n      if (preset.attached?.length) {\r\n        for (const attached of preset.attached) {\r\n          this._migrateData([attached.data], attached.documentName, coreMigration, migrateFunc);\r\n        }\r\n        foundry.utils.setProperty(update, `flags.${MODULE_ID}.preset.attached`, preset.attached);\r\n      }\r\n\r\n      if (!foundry.utils.isEmpty(update)) {\r\n        update._id = document.id;\r\n        updates.push(update);\r\n      }\r\n    }\r\n\r\n    if (updates.length <= 0) {\r\n      ui.notifications.info('Mass Edit - No data to migrate: ' + pack.metadata.label);\r\n    } else {\r\n      await JournalEntry.updateDocuments(updates, { pack: pack.collection });\r\n      ui.notifications.notify('Mass Edit - Migrated ' + updates.length + ' presets within \"' + pack.metadata.label);\r\n    }\r\n  }\r\n\r\n  static _migrateData(dataArr, documentName, coreMigration = true, migrateFunc = null) {\r\n    const cls = getDocumentClass(documentName);\r\n\r\n    for (const data of dataArr) {\r\n      if (coreMigration) cls?.migrateData(data); // Core Foundry migration\r\n      if (migrateFunc) migrateFunc(data, documentName); // Custom migration function\r\n\r\n      // Token Attacher data traversal\r\n      const prototypeAttached = data.flags?.['token-attacher']?.prototypeAttached;\r\n      if (prototypeAttached) this._migratePrototypeAttached(prototypeAttached, coreMigration, migrateFunc);\r\n    }\r\n  }\r\n\r\n  static _migratePrototypeAttached(prototypeAttached, coreMigration = true, migrateFunc = null) {\r\n    for (const [documentName, attached] of Object.entries(prototypeAttached)) {\r\n      this._migrateData(attached, documentName, coreMigration, migrateFunc);\r\n    }\r\n  }\r\n}\r\n\r\n// Todo: support TA migration to Links\r\n// if (taToLinks) {\r\n//   p.name = p.name + ' - LINKED';\r\n//   const lData = [];\r\n//   p.data.forEach((d) => {\r\n//     const attached = foundry.utils.getProperty(d, 'flags.token-attacher.prototypeAttached');\r\n//     if (attached) {\r\n//       const link = { id: foundry.utils.randomID(), type: 0 };\r\n//       Object.keys(attached).forEach((embedName) => {\r\n//         attached[embedName].forEach((ad) => {\r\n//           foundry.utils.setProperty(ad, 'flags.multi-token-edit.links', [foundry.utils.deepClone(link)]);\r\n//           delete ad.flags?.['token-attacher'];\r\n//           lData.push({ documentName: embedName, data: ad });\r\n//         });\r\n//       });\r\n//       delete d.flags['token-attacher'];\r\n//       console.log(d);\r\n//       foundry.utils.setProperty(d, 'flags.multi-token-edit.links', [link]);\r\n\r\n//       p.attached = lData;\r\n//     }\r\n//   });\r\n// }\r\n","import { pasteData, showMassEdit, showGenericForm, getMassEditForm } from './applications/multiConfig.js';\r\nimport {\r\n  activeEffectPresetSelect,\r\n  createDocuments,\r\n  isResponsibleGM,\r\n  resolveCreateDocumentRequest,\r\n  TagInput,\r\n} from './scripts/utils.js';\r\nimport { libWrapper } from './scripts/shim/shim.js';\r\nimport { enableUniversalSelectTool } from './scripts/selectTool.js';\r\nimport { META_INDEX_ID, PresetAPI, PresetCollection } from './scripts/presets/collection.js';\r\nimport { registerPresetBrowserHooks } from './scripts/presets/forms.js';\r\nimport { registerKeybinds, registerSettings } from './scripts/settings.js';\r\nimport { Picker } from './scripts/picker.js';\r\nimport { BrushMenu, activateBrush, deactivateBush, openBrushMenu } from './scripts/brush.js';\r\nimport { V12Migrator } from './scripts/presets/migration.js';\r\nimport { deleteFromClipboard, performMassSearch, performMassUpdate } from './applications/formUtils.js';\r\nimport { registerSideBarPresetDropListener } from './scripts/presets/utils.js';\r\nimport { LinkerAPI, registerLinkerHooks } from './scripts/linker/linker.js';\r\nimport { MODULE_ID, SUPPORTED_SHEET_CONFIGS, SUPPORTED_PLACEABLES, UI_DOCS } from './scripts/constants.js';\r\n\r\n// Initialize module\r\nHooks.once('init', () => {\r\n  // We need to insert Region into relevant doc groups\r\n  // TODO: Once we move to a dedicated v12 version of the module we can\r\n  // make these groups static again\r\n  if (foundry.utils.isNewerVersion(game.version, 12)) {\r\n    SUPPORTED_PLACEABLES.unshift('Region');\r\n    UI_DOCS.push('Region');\r\n    SUPPORTED_SHEET_CONFIGS.push('Region');\r\n\r\n    //Register region behaviors\r\n    import('./scripts/behaviors/behaviors.js').then((module) => module.registerBehaviors());\r\n  }\r\n\r\n  // Allows users to drop AmbientSound presets onto playlists\r\n  registerSideBarPresetDropListener();\r\n\r\n  // Linker related hooks\r\n  registerLinkerHooks();\r\n\r\n  // TODO: Replace with core v12 implementation of tag HTML element\r\n  TagInput.registerHandlebarsHelper();\r\n\r\n  // Enable select tool for all layers\r\n  enableUniversalSelectTool();\r\n\r\n  // Settings/Keybindings\r\n  registerSettings();\r\n  registerKeybinds();\r\n\r\n  // Register copy-paste wrappers\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onCopy',\r\n    function (wrapped, ...args) {\r\n      if (window.getSelection().toString() === '') {\r\n        // Check if a Mass Config form is open and if so copy data from there\r\n        const meForm = getMassEditForm();\r\n        if (meForm?.performMassCopy()) return true;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      // Clear Mass Edit clipboard to allows core pasting again\r\n      if (result) deleteFromClipboard(canvas.activeLayer.constructor.documentName);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onPaste',\r\n    function (wrapped, ...args) {\r\n      if (pasteData()) return true;\r\n      return wrapped(...args);\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Register mouse wheel wrapper to scale/rotate preset previews\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'MouseManager.prototype._onWheel',\r\n    function (wrapped, ...args) {\r\n      const event = args[0];\r\n\r\n      if (\r\n        (Picker.isActive() || BrushMenu.isActive()) &&\r\n        (event.ctrlKey || event.shiftKey || event.metaKey || event.altKey)\r\n      ) {\r\n        // Prevent zooming the entire browser window\r\n        if (event.ctrlKey) event.preventDefault();\r\n\r\n        let dy = (event.delta = event.deltaY);\r\n        if (event.shiftKey && dy === 0) {\r\n          dy = event.delta = event.deltaX;\r\n        }\r\n        if (dy === 0) return;\r\n\r\n        if (event.altKey) Picker.addScaling(event.delta < 0 ? 0.05 : -0.05);\r\n        else if ((event.ctrlKey || event.metaKey) && event.shiftKey) BrushMenu.iterate(event.delta >= 0, true);\r\n        else if (event.ctrlKey || event.metaKey) Picker.addRotation(event.delta < 0 ? 2.5 : -2.5);\r\n        else if (event.shiftKey) Picker.addRotation(event.delta < 0 ? 15 : -15);\r\n        return;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Add SceneControl option to open Mass Edit form\r\n  if (game.settings.get(MODULE_ID, 'presetSceneControl')) {\r\n    libWrapper.register(\r\n      MODULE_ID,\r\n      'SceneNavigation.prototype._getContextMenuOptions',\r\n      function (wrapped, ...args) {\r\n        const options = wrapped(...args);\r\n        options.push({\r\n          name: 'Mass Edit',\r\n          icon: '<i class=\"fa-solid fa-pen-to-square\"></i>',\r\n          condition: game.user.isGM,\r\n          callback: (li) => {\r\n            const sceneId = li.attr('data-scene-id');\r\n            showMassEdit(game.scenes.get(sceneId));\r\n          },\r\n        });\r\n        return options;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n  }\r\n\r\n  registerPresetBrowserHooks();\r\n\r\n  // Handle broadcasts\r\n  // Needed to allow players to spawn Presets by delegating create document request to GMs\r\n  game.socket?.on(`module.${MODULE_ID}`, async (message) => {\r\n    const args = message.args;\r\n\r\n    if (message.handlerName === 'document' && message.type === 'UPDATE') {\r\n      if (!isResponsibleGM()) return;\r\n\r\n      game.scenes.get(args.sceneID).updateEmbeddedDocuments(args.documentName, args.updates, args.context);\r\n    } else if (message.handlerName === 'document' && message.type === 'CREATE') {\r\n      if (!isResponsibleGM()) return;\r\n\r\n      const documents = await createDocuments(args.documentName, args.data, args.sceneID);\r\n      const documentIDs = documents.map((d) => d.id);\r\n\r\n      const message = {\r\n        handlerName: 'document',\r\n        args: {\r\n          requestID: args.requestID,\r\n          sceneID: args.sceneID,\r\n          documentName: args.documentName,\r\n          documentIDs,\r\n        },\r\n        type: 'RESOLVE',\r\n      };\r\n      game.socket.emit(`module.${MODULE_ID}`, message);\r\n    } else if (message.handlerName === 'document' && message.type === 'DELETE') {\r\n      if (!isResponsibleGM()) return;\r\n      game.scenes.get(args.sceneId).deleteEmbeddedDocuments(args.embedName, args.ids);\r\n    } else if (message.handlerName === 'document' && message.type === 'RESOLVE') {\r\n      resolveCreateDocumentRequest(args);\r\n    }\r\n  });\r\n\r\n  // 'Spotlight Omnisearch' support\r\n  Hooks.on('spotlightOmnisearch.indexBuilt', (INDEX, promises) => {\r\n    if (!game.user.isGM) return;\r\n    // First turn-off preset compendium from being included in omnisearch indexing\r\n    const old = game.settings.get('spotlight-omnisearch', 'compendiumConfig');\r\n    game.packs\r\n      .filter((p) => p.documentName === 'JournalEntry' && p.index.get(META_INDEX_ID))\r\n      .forEach((p) => (old[p.collection] = false));\r\n    game.settings.set('spotlight-omnisearch', 'compendiumConfig', old);\r\n\r\n    // Insert preset index\r\n    const promise = PresetCollection.buildSpotlightOmnisearchIndex(INDEX);\r\n    promises.push(promise);\r\n  });\r\n\r\n  globalThis.MassEdit = {\r\n    showGenericForm,\r\n    performMassUpdate,\r\n    performMassSearch,\r\n    showMassEdit,\r\n    getPreset: PresetAPI.getPreset,\r\n    getPresets: PresetAPI.getPresets,\r\n    createPreset: PresetAPI.createPreset,\r\n    spawnPreset: PresetAPI.spawnPreset,\r\n    activateBrush: activateBrush,\r\n    deactivateBrush: deactivateBush,\r\n    openBrushMenu: openBrushMenu,\r\n    migratePack: (pack, options = {}) => V12Migrator.migratePack(pack, options),\r\n    migrateAllPacks: (options = {}) => V12Migrator.migrateAllPacks(options),\r\n    linker: LinkerAPI,\r\n  };\r\n\r\n  game.modules.get(MODULE_ID).api = {\r\n    ...globalThis.MassEdit,\r\n  };\r\n});\r\n\r\n// Deactivate brush/picker on scene change\r\n\r\nHooks.on('canvasReady', () => {\r\n  if (BrushMenu.isActive()) BrushMenu.close();\r\n  else if (Picker.isActive()) Picker.destroy();\r\n});\r\n\r\n// Attach Mass Config buttons to Token and Tile HUDs\r\nHooks.on('renderTokenHUD', (hud, html, tokenData) => {\r\n  if (canvas.tokens.controlled.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"config\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\nHooks.on('renderTileHUD', (hud, html, tileData) => {\r\n  const controlledTiles = canvas.background\r\n    ? canvas.background.controlled.concat(canvas.foreground.controlled)\r\n    : canvas.tiles.controlled;\r\n\r\n  if (controlledTiles.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"underfoot\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\n\r\nHooks.on('renderActiveEffectConfig', (app) => {\r\n  const el = $(app.form).find('.effects-header .key');\r\n  if (el.length) {\r\n    const me = $('<i title=\"Apply \\'Mass Edit\\' preset\" style=\"font-size:smaller;color:brown;\"> <a>[ME]</a></i>');\r\n    me.on('click', () => activeEffectPresetSelect(app));\r\n    el.append(me);\r\n  }\r\n});\r\n","import CSSEdit, { STYLES } from '../applications/cssEdit.js';\r\nimport { copyToClipboard } from '../applications/formUtils.js';\r\nimport { MassEditGenericForm } from '../applications/generic/genericForm.js';\r\nimport {\r\n  getMassEditForm,\r\n  getSelected,\r\n  pasteData,\r\n  showMassActorForm,\r\n  showMassEdit,\r\n  showMassSelect,\r\n} from '../applications/multiConfig.js';\r\nimport { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from './constants.js';\r\nimport { LinkerAPI } from './linker/linker.js';\r\nimport { editPreviewPlaceables, Picker } from './picker.js';\r\nimport { PresetCollection } from './presets/collection.js';\r\nimport { MassEditPresets } from './presets/forms.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { activeEffectPresetSelect, getDocumentName, localize } from './utils.js';\r\n\r\nexport function registerSettings() {\r\n  // Register Settings\r\n  game.settings.register(MODULE_ID, 'cssStyle', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'Solid Background',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'cssCustom', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: STYLES.Default,\r\n  });\r\n\r\n  game.settings.registerMenu(MODULE_ID, 'cssEdit', {\r\n    name: localize('settings.cssEdit.name'),\r\n    hint: localize('settings.cssEdit.hint'),\r\n    label: '',\r\n    scope: 'world',\r\n    icon: 'fas fa-cog',\r\n    type: CSSEdit,\r\n    restricted: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'singleDocDefaultConfig', {\r\n    name: localize('settings.singleDocDefaultConfig.name'),\r\n    hint: localize('settings.singleDocDefaultConfig.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'rangeToTextbox', {\r\n    name: localize('settings.rangeToTextbox.name'),\r\n    hint: localize('settings.rangeToTextbox.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'indexer', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      indexDirs: [\r\n        { target: 'modules', source: 'data' },\r\n        { target: 'sounds', source: 'public' },\r\n      ],\r\n      cacheDir: { target: '', source: 'data' },\r\n      overrideTags: false,\r\n      ignoreExternal: false,\r\n      fileFilters: ['Thumb', '-thumb', 'Thumbnail', 'thumbnail'],\r\n      folderFilters: ['Thumb', 'thumb'],\r\n    },\r\n  });\r\n\r\n  // ===============\r\n  // Preset Settings\r\n\r\n  game.settings.register(MODULE_ID, 'workingPack', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'world.mass-edit-presets-main',\r\n    onChange: (val) => {\r\n      PresetCollection.workingPack = val;\r\n    },\r\n  });\r\n  PresetCollection.workingPack = game.settings.get(MODULE_ID, 'workingPack');\r\n\r\n  game.settings.register(MODULE_ID, 'docPresets', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Array,\r\n    default: [],\r\n  });\r\n\r\n  // Temp setting needed for migration\r\n  game.settings.register(MODULE_ID, 'presetsMigrated', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  // Temp setting needed for migration\r\n  game.settings.register(MODULE_ID, 'presetsCompMigrated', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetDocLock', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: '',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetLayerSwitch', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetExtComp', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetVirtualDir', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetScaling', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetSortMode', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'manual',\r\n  });\r\n\r\n  // p = preset only\r\n  // pf = preset & folder\r\n  game.settings.register(MODULE_ID, 'presetSearchMode', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'pf',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetSceneControl', {\r\n    name: 'Scene Controls: Preset Button',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n    onChange: () => {\r\n      ui.controls.render();\r\n    },\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetFavorites', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // end of Preset Settings\r\n  // ======================\r\n\r\n  game.settings.register(MODULE_ID, 'pinnedFields', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'customControls', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // Disable until duplicate flag value bug is fixed\r\n  // game.settings.register(MODULE_ID, 'enableFlagsTab', {\r\n  //   name: localize('settings.enableFlagsTab.name'),\r\n  //   hint: localize('settings.enableFlagsTab.hint'),\r\n  //   scope: 'world',\r\n  //   config: true,\r\n  //   type: Boolean,\r\n  //   default: true,\r\n  // });\r\n\r\n  game.settings.register(MODULE_ID, 'autoSnap', {\r\n    name: localize('settings.autoSnap.name'),\r\n    hint: localize('settings.autoSnap.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'panToSearch', {\r\n    name: localize('settings.panToSearch.name'),\r\n    hint: localize('settings.panToSearch.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'preSelectAutoApply', {\r\n    name: 'Pre-Select Auto-apply',\r\n    hint: 'Should the auto-apply button be ticked by default on Mass Edit forms.',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  if (game.modules.get('tokenmagic')?.active) {\r\n    game.settings.register(MODULE_ID, 'tmfxFieldsEnable', {\r\n      name: localize('settings.tmfxFieldsEnable.name'),\r\n      hint: localize('settings.tmfxFieldsEnable.hint'),\r\n      scope: 'world',\r\n      config: true,\r\n      type: Boolean,\r\n      default: true,\r\n    });\r\n  }\r\n\r\n  game.settings.register(MODULE_ID, 'brush', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      random: true,\r\n      group: false,\r\n      spawner: true,\r\n      eraser: false,\r\n      lock: false,\r\n      snap: false,\r\n      scaleToGrid: true,\r\n    },\r\n  });\r\n}\r\n\r\nexport function registerKeybinds() {\r\n  game.keybindings.register(MODULE_ID, 'linker', {\r\n    name: localize('keybindings.linkerMenu.name'),\r\n    hint: localize('keybindings.linkerMenu.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyQ',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.openMenu();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'smartLink', {\r\n    name: 'Smart Link',\r\n    hint: 'Initiate smart document linking.',\r\n    editable: [\r\n      {\r\n        key: 'KeyL',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.smartLink({ multiLayer: !Boolean(LinkerAPI._getSelected().length) });\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'smartUnlink', {\r\n    name: 'Smart Un-Link',\r\n    hint: 'Initiate smart document un-linking.',\r\n    editable: [\r\n      {\r\n        key: 'KeyU',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.removeLinksFromSelected({ notification: true, multiLayer: !Boolean(LinkerAPI._getSelected().length) });\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'deleteAllLinked', {\r\n    name: 'Delete Selected & Linked',\r\n    hint: 'Deletes currently selected placeable and all placeables linked to it via the `Linker Menu`',\r\n    editable: [\r\n      {\r\n        key: 'Delete',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.deleteSelectedLinkedPlaceables();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'placeablePreviewEdit', {\r\n    name: localize('keybindings.placeableEdit.name'),\r\n    hint: localize('keybindings.placeableEdit.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyD',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: editPreviewPlaceables,\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'mirrorX', {\r\n    name: 'Mirror Preview Horizontally',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyH',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => Picker.mirrorX(),\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'mirrorY', {\r\n    name: 'Mirror Preview Vertically',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyV',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => Picker.mirrorY(),\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'editKey', {\r\n    name: localize('keybindings.editKey.name'),\r\n    hint: localize('keybindings.editKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyE',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = getMassEditForm();\r\n      if (app) {\r\n        app.close();\r\n        return;\r\n      }\r\n      showMassEdit();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'copyKey', {\r\n    name: localize('common.copy'),\r\n    hint: 'Copy data from within an opened Mass Edit form OR the selected and all linked placeables.',\r\n    editable: [\r\n      {\r\n        key: 'KeyC',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      // Check if a Mass Config form is open and if so copy data from there\r\n      if (window.getSelection().toString() === '') {\r\n        const app = Object.values(ui.windows).find((app) => app.meObjects != null);\r\n        if (app) return app.performMassCopy();\r\n      }\r\n\r\n      // If no form is open attempt to copy the selected placeable and its linked placeables\r\n      const selected = LinkerAPI._getSelected().map((s) => s.document);\r\n      if (selected.length) {\r\n        const linked = Array.from(\r\n          LinkerAPI.getHardLinkedDocuments(selected).filter((l) => !selected.find((s) => s.id === l.id))\r\n        );\r\n\r\n        const preset = new Preset({\r\n          documentName: selected[0].documentName,\r\n          data: selected.map((s) => s.toObject()),\r\n          attached: linked.map((l) => {\r\n            return { documentName: l.documentName, data: l.toObject() };\r\n          }),\r\n        });\r\n        copyToClipboard(preset);\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'pasteKey', {\r\n    name: localize('common.paste'),\r\n    hint: 'Paste data onto selected placeables or spawn it as a new placeable.',\r\n    editable: [\r\n      {\r\n        key: 'KeyV',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      pasteData();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'selectKey', {\r\n    name: localize('keybindings.selectKey.name'),\r\n    hint: localize('keybindings.selectKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyF',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      showMassSelect();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApply', {\r\n    name: localize('keybindings.presetApply.name'),\r\n    hint: localize('keybindings.presetApply.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyX',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof MassEditPresets);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n\r\n      // Special logic for populating Active Effect\r\n      const aeConfig = Object.values(ui.windows).find((x) => x instanceof ActiveEffectConfig);\r\n      if (aeConfig) {\r\n        activeEffectPresetSelect(aeConfig);\r\n        return;\r\n      }\r\n\r\n      const documentName = canvas.activeLayer.constructor.documentName;\r\n      if (!SUPPORTED_PLACEABLES.includes(documentName)) return;\r\n      new MassEditPresets(null, null, documentName).render(true);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApplyScene', {\r\n    name: localize('keybindings.presetApplyScene.name'),\r\n    hint: localize('keybindings.presetApplyScene.hint'),\r\n    editable: [],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof MassEditPresets);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n      new MassEditPresets(null, null, 'Scene').render(true);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'genericFormKey', {\r\n    name: localize('keybindings.genericForm.name'),\r\n    hint: localize('keybindings.genericForm.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyR',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      let [target, selected] = getSelected(null, false);\r\n      if (!target) return;\r\n      const documentName = getDocumentName(target);\r\n      if (![...SUPPORTED_COLLECTIONS, 'Token'].includes(documentName)) return;\r\n\r\n      if (documentName === 'Token') {\r\n        showMassActorForm(selected, { massEdit: true });\r\n      } else {\r\n        new MassEditGenericForm(selected, { massEdit: true, documentName }).render(true);\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n}\r\n"],"names":["leafPrototypes","getProto","inProgress","getInUseStyle","styleInUse","game","settings","get","STYLES","CSSEdit","FormApplication","constructor","super","defaultOptions","foundry","utils","mergeObject","id","classes","template","resizable","minimizable","title","width","height","getData","options","data","css","styles","Object","keys","push","disableCSS","activateListeners","html","$","on","event","target","value","find","val","prop","_updateObject","formData","selectedStyle","set","Default","TokenDataAdapter","updateToForm","update","mirrorX","scale","Math","abs","mirrorY","dataToForm","token","doc","document","texture","scaleX","scaleY","formToData","forEach","k","correctDetectionModes","correctDetectionModeOrder","randomizeFields","indexMap","i","v","entries","startsWith","comps","split","newKey","rVal","detectionModeMatch","searchModes","tokenModes","m1","m2","enabled","range","detectionModes","length","mergedModes","deepClone","filter","d","dm","found","tdm","modifyPresetData","app","pModes","values","expandObject","modes","_getSubmitData","dataClone","randomize","addSubtract","modCustomFields","fields","key","j","startingModeLength","_previewChanges","render","ADAPTERS","Token","PlaylistSound","PlaylistSoundDataAdapter","obj","AudioHelper","inputToVolume","note","volume","volumeToInput","Note","NoteDataAdapter","src","GeneralDataAdapter","documentName","adapter","performMassSearch","command","selectedFields","scope","selected","control","pan","performDocSearch","includes","Array","from","collections","scenes","canvas","scene","performMassSearchScene","activeLayer","controlled","map","c","release","setTimeout","f","object","releaseOthers","docs","matches","flattenObject","toObject","async","performMassUpdate","objects","applyType","this","simplified","callback","isEmpty","callbackOnUpdate","updates","context","total","o","_id","addSubtractFields","field","ctrl","currentTags","isArray","s","trim","modTags","tag","method","index","indexOf","splice","t","join","type","toAdd","replace","min","max","applyAddSubtract","checkApplySpecialFields","tokens","actor","Scene","updateDocuments","splitUpdates","parent","sceneUpdate","updateEmbeddedDocuments","isPrototype","sceneId","actorUpdates","prototypeToken","Actor","hasOwnProperty","TokenMagic","flags","depth","onInputChange","className","checked","deselectTabs","meChk","closest","selectTabs","massEdit","_performOnInputChangeUpdate","modUpdate","tab","siblings","attr","addClass","removeClass","getCommonDocData","getObjFormData","pasteDataUpdate","preset","suppressNotif","excludePosition","transform","getClipboardData","meObjects","ogData","floor","random","DataTransform","apply","x","y","insertKeys","inplace","elevation","call","ui","notifications","info","count","CLIPBOARD","copyToClipboard","clipboard","copyPlainText","JSON","stringify","deleteFromClipboard","injectVisibility","form","hidden","newHtml","tabs","first","append","last","after","genAction","toggle","genToggleUtil","objToString","hasMassEditUpdateDependency","context2","genUpdateWithMassEditDep","macroTracking","macro","genUpdate","genDelete","genTargets","p","genIDTargets","genSelected","genSearch","opts","matchAny","tagger","match","allScenes","tags","genTaggerTargets","genAllTargets","Error","modules","active","mdsClasses","JournalEntry","Playlist","Item","RollTable","Cards","generateMacro","placeables","dep","depWarning","module","hasSpecialField","hasMassEditDependency","genMacroDependencies","name","select","genRunMacro","Macro","create","sheet","specialFields","sf","MacroForm","mainObject","selectable","selectScopeEnabled","targetingOptions","label","hasAddSubtract","hasRandom","hasMEControls","hiddenControl","macros","m","_onShowReturnJson","store","parse","content","Dialog","buttons","Ok","hide","setPosition","e","warn","_onRemoveJson","click","contextmenu","toggleFields","update2","change","show","WithBaseMassEditForm","cls","BaseMassEditForm","massSelect","randomizerEnabled","commonData","_setMEActions","isNewerVersion","version","meForm","rangeSpanToTextbox","baseDocument","massUpdateObject","getSelectedFields","presetEdit","modUpdateType","getFlag","element","each","_","me_checkbox","is","limits","undefined","removeFlag","getType","input","hasClass","performMassCopy","_setStyle","styleName","prepend","_injectGlobalDeleteButton","buttonA","delete","close","no","default","_activateAutoSelectListeners","bind","_processFormGroup","formGroup","typeOverride","insertRNGControl","fieldType","span","replaceWith","defaultValue","removeAttr","randomControl","checkbox","before","_processAllFormGroups","processFormGroup","_processPreset","timeoutRequired","setFlag","_applyPreset","customMerge","obj1","obj2","el","trigger","refreshPreset","_registerRandomizerListeners","then","showRandomizeDialog","_registerBrushRefreshListeners","_registerNumericalInputListeners","parseFloat","_registerInputChangeCallback","inputChangeCallback","_registerNavigationTabMassSelect","dataset","group","meCheckboxes","selecting","not","_insertModuleSpecificFields","_createAction","chk","insertBefore","Levels3DPreview","_insertSpecialFields","getPresets","currentDDTint","scaleInput","_active","_insertModUpdateCheckboxes","preSelectAutoApply","button","modButton","stopPropagation","isChecked","insertAfter","_registerMutateObserver","MutationObserver","mutations","mutation","addedNodes","node","observe","characterData","attributes","childList","subtree","_onClose","force","deactivate","linkedPresetForm","_openMacroForm","_activateBrushTool","activate","_openEditPermissions","ids","Set","entry","has","add","WithMassPermissions","_openPresetBrowser","left","position","top","preventPositionOverride","_openViewApplyJSON","selFields","json","_showMassActorForm","actions","action","meMacroGen","meBrush","meEditPermissions","mePresetBrowser","meJSON","meTokenActor","setProperty","_meGetSubmitButtons","icon","n","_getMeControls","class","visible","WithMassEditFormApplicationV2","MassEditForm","_attachFrameListeners","_onRender","FormDataExtended","_prepareSubmitData","_getHeaderControls","concat","_preparePartContext","partId","_prepareContext","b","_options","renderContext","WithMassEditFormApplication","preview","clone","_removeFooterButtons","_insertSubmitButtons","style","wrap","htmlButtons","_meSubmitInserted","footer","_onChangeInput","edit","_onChangeColorPicker","_onChangeRange","meApply","submitter","_resetPreview","_getHeaderButtons","controls","onclick","remove","WithMassEditForm","base","applications","api","ApplicationV2","BASE_APPLICATION","WithMassConfig","sheets","CONFIG","sheetClasses","pop","MEF","MassConfig","constructorName","defineProperty","prototype","DocumentOwnershipConfig","MassPermissions","ownership","metaLevels","CONST","DOCUMENT_META_OWNERSHIP_LEVELS","addMissingPerms","perms","users","u","DEFAULT","flatData","diff","diffObject","massPermissions","user","level","recursive","noHook","CUSTOM_CONTROLS","shieldType","step","blend","radius","intensity","lightAlpha","gridPadding","lightSize","animated","time","speed","fire","fireBlend","animType","val2","val1","loopDuration","amplitude","electric","xglow","auraType","auraIntensity","subAuraIntensity","threshold","thickness","glow","outerStrength","innerStrength","padding","alpha","zapshadow","alphaTolerance","sprite","blendMode","translationX","translationY","rotation","xfire","dispersion","ascii","size","dot","angle","godray","rgbSplit","redX","redY","greenX","greenY","blueX","blueY","polymorph","shadow","blur","flood","billowy","tintIntensity","glint","constructNav","allData","customControls","pins","nav","dataGroup","items","tabSelectors","navSelector","contentSelector","initial","pinned","_constructControls","pinned_groups","flatObject","genControl","dataTab","groups","unshift","containsNav","name2","_hasNonNullKeys","_genLabel","newNav","toUpperCase","charAt","slice","IMAGE_FIELDS","COLOR_FIELDS","isColorField","toLowerCase","editableLabel","allowedArrayElTypes","getProperty","number","colorPickerNumber","colorValue","Color","toString","text","varName","filePicker","colorPicker","boolean","every","array","jsonArray","disabled","WMC","MassEditGenericForm","a","noTabs","editableLabels","pinnedFields","getTemplate","star","editNumber","col","Number","fromString","allControls","docControls","unsetCustomControl","save","defineRangeControl","defineSelectControl","LAYER_MAPPINGS","Tile","Drawing","Wall","AmbientLight","AmbientSound","MeasuredTemplate","SCENE_DOC_MAPPINGS","getControlled","getHover","hover","getSelectedDocuments","placeableSelect","supportedDocs","playlistId","sounds","soundId","documentId","notes","eid","entryId","getSelected","placeable","sort","p1","p2","showMassSelect","basePlaceable","showMassEdit","forceForm","showMassActorForm","selectedTokens","actors","pasteData","spawnPreset","showGenericForm","Promise","resolve","getMassEditForm","windows","instances","Brush","static","Map","_checkDensity","pos","grid","spawnDensity","spawnPoints","sqrt","_performBrushDocumentUpdate","callPostSpawnHooks","documents","updatedPlaceables","BrushMenu","iterate","_performBrushDocumentCreate","now","Date","getTime","lastSpawnTime","Picker","_performBrushDocumentDelete","hoveredPlaceable","_brushDelete","_hitTestWall","point","wall","line","hitArea","contains","_hitTestRegion","region","bounds","_hitTestControlIcon","between","controlIcon","_hitTestTile","foreground","overhead","_hoverTestArea","hBounds","pBounds","_hitTestArea","_onBrushMove","getLocalPosition","brushOverlay","layer","getLayerByEmbeddedName","_clearHover","hitTest","hoverTest","_onHoverOut","_onHoverIn","_onBrushClickMove","spawner","eraser","_on3DBrushClick","z","clear","genPreview","coordPicker","previewOnly","center","taPreview","snapToGrid","snap","scaleToGrid","deactivateCallback","refresh","ready","destroy","interaction","renderer","events","cursorStyles","_activate3d","PIXI","Container","dimensions","rect","cursor","interactive","zIndex","Infinity","feedPos","mDownWithinCanvas","nativeEvent","which","stage","addChild","mouseInteractionManager","permissions","clickLeft","mouseMoveCallback","mouseClickCallback","mouseWheelClickCallback","removeChild","addPresets","presets","_instance","isActive","Boolean","removePreset","forward","scrollY","window","innerHeight","_settings","_it","_createIndex","pI","dI","_index","_activateBrush","_applyColor","_applyTmfxPresets","tmfxPreset","_applyTaggerTags","_deactivateCallback","_getTransform","density","randomColor","color","pPath","ddTint","_applyDDTint","filters","tmFilters","filterId","tmFilterId","tmFilterInternalId","randomID","tmFilterType","filterOwner","userId","tmParams","tint","hex2rgb","updateId","rank","addPostSpawnHook","Tagger","addTags","deleteFilters","presetName","getPreset","addUpdateFilters","activePreset","tmfxActive","taggerActive","rotationRangeLabel","slider","slide","_updateBrushSettings","scaleRangeLabel","densityRangeLabel","_toggleSetting","_resetToDefaults","_onClickPreset","_onRightClickPreset","_onRandomizeColor","_onColorChange","_onColorMenu","_onEditTaglikeField","simplifyTags","listId","listEntries","subMenu","_toggleSubMenu","Handlebars","compile","allowProtoMethodsByDefault","allowProtoPropertiesByDefault","cString","currentTarget","isNaN","valueOf","presetIndex","findIndex","colorTemp","renderTemplate","lockMethod","space","hue","colorSlider","dialog","colors","getColors","ColorSlider","hex","offset","uuid","wasActivePreset","lock","accumulatedTransform","getTransformAccumulator","stepsInRange","_generateBrushMacro","genMacro","img","uuids","resetTransformAccumulator","activateBrush","mode","deactivateBush","openBrushMenu","load","MODULE_ID","SUPPORTED_PLACEABLES","UI_DOCS","SUPPORTED_SHEET_CONFIGS","SUPPORTED_COLLECTIONS","IMAGE_EXTENSIONS","VIDEO_EXTENSIONS","AUDIO_EXTENSIONS","FILE_EXTENSIONS","LINKER_DOC_ICONS","Region","showPlaceableTypeSelectDialog","config","importPresetFromJSONDialog","reject","import","readTextFromFile","files","PROCESSED_UPDATES","LINK_TYPES","TWO_WAY","RECEIVE","SEND","registerLinkerHooks","Hooks","preUpdate","register","wrapped","args","history","undone","LinkerAPI","h","createEmbeddedDocuments","isUndo","keepId","processLinks","origin","links","docUpdates","processedLinks","sourceId","linked","getEmbeddedCollection","some","l1","l2","_source","dLinks","l","updateQueue","PromiseQueue","queue","operation","catch","ignoreLinks","positionUpdate","rotationUpdate","keyboard","isModifierActive","KeyboardManager","MODIFIER_KEYS","ALT","puLinks","modifiedTime","previousSource","linkSources","currentSource","previousBounds","currentBounds","x1","y1","dRotation","meRotation","x2","y2","dElevation","isNumeric","bottom","calculateTransform","animate","RidingMovement","forced","openMenu","openLinkerMenu","smartLink","multiLayer","_getSelected","_smartLink","link","getLinks","openSmartLinkMenu","numUpdates","addLink","getLinkedDocuments","allLinked","_findLinked","getHardLinkedDocuments","_findHardLinked","hasLink","linkId","removeLink","unsetFlag","removeLinks","removeLinksFromSelected","notification","numRemoved","w","unlink","deleteSelectedLinkedPlaceables","toDelete","deleteEmbeddedDocuments","shift","removeAllLinksOnCurrentScene","updateLinkLabelOnCurrentScene","updated","removeLinkFromScene","fLinks","objectClass","embeddedName","_getLinkedDocumentsUsingLink","_highlightDocuments","dg","debug","lineStyle","drawRect","_clearHighlight","Mouse3D","_boundOn3DMouseDown","_on3DMouseDown","_boundOn3dMouseMove","_on3dMouseMove","_boundOn3dMouseWheel","_on3dMouseWheel","_createTracker","_activate3DListeners","tracker","deactivate3DListeners","THREE","Mesh","SphereGeometry","MeshBasicMaterial","opacity","transparent","wireframe","userData","ignoreHover","mPos","interactionManager","canvas3dMousePosition","domElement","addEventListener","removeEventListener","posVec","ruler","pos3DToCanvas","currentHover","delayMoveTimer","cPos","camera","intersects","computeSightCollisionFrom3DPositions","intersect","ctrlKey","shiftKey","metaKey","altKey","preventDefault","dy","delta","deltaY","deltaX","addScaling","addRotation","pickerOverlay","_rotation","setPositions","mousePosition","_transformAccumulator","_scale","_mirrorX","_mirrorY","PreciseText","canvasTextStyle","_fontSize","anchor","previews","previewDocuments","_genPreviews","centerOnCursor","previewData","SHIFT","snapped","getSnappedPoint","pd","z1","_pData","renderFlags","_meSort","_meElevation","_l3dPreview","collision","_onUpdate","shapes","initializeLightSource","initializeSoundSource","lastX","lastY","client","off","boundStart","boundEnd","minX","maxX","minY","maxY","start","end","children","clearPreviewContainer","_createPreview","createData","getDocumentClass","_object","eventMode","occlusion","draw","tooltip","renderable","_overridePlaceableVisibility","createTile","l3dPreview","tiles","castShadow","addToken","addLight","lights","toCreate","dataArr","shape","points","_genTAPreviews","attached","ratio","attachedData","_parseTAPreview","dataList","xy","radiusX","radiusY","taIndex","transformWall","transformTile","transformNote","transformToken","transformMeasuredTemplate","transformAmbientLight","transformAmbientSound","transformDrawing","transformRegion","console","log","dr","toRadians","rotatePoint","rectCenter","docShape","dataShape","PolygonShapeData","gridScale","distance","direction","toDegrees","dim","bright","posCanvasTo3d","mesh","multiplyScalar","MathUtils","degToRad","sizeX","sizeY","rot","dx","cos","sin","editPreviewPlaceables","docToData","mainDocumentName","tokenAttacher","generatePrototypeAttached","prototypeAttached","originalDocToData","coords","originalData","DEFAULT_PACK","META_INDEX_ID","META_INDEX_FIELDS","PresetCollection","getTree","externalCompendiums","virtualDirectory","setFormVisibility","pack","mainTree","MassEdit","_initCompendium","workingPack","PresetTree","init","forceLoad","extFolders","packs","collection","tree","hasVisible","topFolder","PresetPackFolder","allFolders","folder","vTree","getVirtualDirectoryTree","VirtualFileFolder","folders","_groupExtFolders","timeEnd","f1","f2","localeCompare","groupless","newExtFolders","groupFolder","PresetVirtualFolder","draggable","_cleanIndex","metaDoc","metaIndex","locked","idx","_packTrees","metadata","_sortFolders","sorting","_sortPresets","numeric","packToPresets","getDocument","contents","mIndex","compendium","updateDoc","toJSON","pages","_initMetaDocument","updatePresets","createDocuments","full","_constructVirtualFilePreset","documentType","embedded","parseUuid","substring","sorted","metaUpdate","deleteIds","deleteDocuments","CompendiumCollection","createCompendium","GAMEMASTER","PLAYER","ASSISTANT","packageType","deleteFolder","deleteAll","folderDoc","fromUuid","traverseFolder","deleteSubfolders","deleteContents","_searchPresetTree","_searchPresetList","allPresets","_searchPresetFolder","toSearch","folderName","buildSpotlightOmnisearchIndex","soIndex","SearchTerm","SpotlightOmnisearch","onClick","spotlightOmnisearch","setDraggingState","PresetAPI","onDragEnd","canvasCoordinatesFromClient","clientX","clientY","getActions","openJournal","buildTerm","description","keywords","format","_folderName","createPresetFromActor","presetData","gridSize","createPresetFromActorUuid","createPreset","defPreset","taggerTag","pickerLabel","layerSwitch","modifyPrompt","spawnRandom","modifyOnSpawn","toModify","modified","tmpData","reorganizedData","modifySpawnData","presetAttached","preSpawnScript","preserveLinks","newLinkId","oldId","behaviors","system","pos3d","canvas2dMousePosition","posTransform","author","downKeys","destinationTags","maxSort","t1","t2","isGM","allDocuments","postSpawnScript","PresetFolder","isEditable","types","expanded","virtual","bucket","source","subtext","indexable","packFolderData","setVisibility","topLevelFolders","folderContents","topLevelPresets","_updateIndex","matched","_visible","sortedFolders","sortedPresets","_render","isFavorite","_setChildAndParentFoldersVisible","CACHE_NAME","FileIndexer","_loadedTree","cache","loadMainIndexCache","prePend","ForgeVTT","usingTheForge","ForgeAPI","getUserId","s3","buckets","endpoint","host","_indexToVirtualFolder","sFolder","buildIndex","_buildingIndex","scannedSources","foundCaches","dir","indexDirs","_buildFauxForgeBrowser","iDir","generateIndex","sPath","dirs","mergeIndex","cacheFile","loadIndexCache","mergeCaches","currentCache","tagsOnly","overrideNullTagsOnly","overrideTags","_writeIndexToCache","cacheTo","cacheFrom","indexSourceFrom","indexSourceTo","indexTo","indexFrom","dirFrom","dirTo","fileFrom","fileTo","saveIndexToCache","path","notify","sourceFolder","sourceCache","_cacheFolder","str","tFile","StringCompress","compress","FilePicker","upload","saveFolderToCache","wFolder","pFolder","fDic","_cachePreset","pDic","decompressCache","error","parentDirPath","fullPath","fileFolder","childFolder","file","noscan","_browse","indexerFile","endsWith","simplifyString","folderFilters","fileName","fileFilters","ignoreExternal","_getAuthorFromModule","cacheDir","ext","_fauxForgeBrowser","browse","paths","replaceAll","insertFile","pDirPath","chDirPath","pDir","components","URL","pathname","moduleFile","authors","compressedStream","Blob","stream","pipeThrough","CompressionStream","chunks","chunk","streamAsyncIterator","blob","File","filePath","response","fetch","ok","decompress","body","decompressedStream","DecompressionStream","stringBytes","concatUint8Arrays","TextDecoder","decode","uint8arrays","buffer","arrayBuffer","Uint8Array","reader","getReader","done","read","releaseLock","IndexerForm","_onAddDirectory","_onDeleteDirectory","_onFileFiltersChange","_onFolderFiltersChange","_onToggleCheckbox","chkBox","_updateIndexerSettings","clearTimeout","_onInputTimeOut","selectFolder","selection","directory","activeSource","current","fp","result","TrackerDialog","cancelCallback","incrementCount","stop","_state","Application","RENDER_STATES","RENDERED","RENDERING","trackProgress","cancel","countFolderItems","reduce","sum","SortingHelpersFixed","performIntegerSort","sortKey","sortBefore","defaultIdx","sib","_sortBefore","_sortAfter","SORT_INTEGER_DENSITY","isFinite","round","performIntegerSortMulti","sources","increment","TagSelector","presetsApp","_tagSelector","tagMap","getTagsOfRendered","searchedTagsArr","getSearchedTags","activeTags","_onClickTag","_getFolderTags","_getPresetTags","MassEditPresets","lastSearch","searchInput","search","SORT_MODES","manual","alphabetical","SEARCH_MODES","pf","configApp","previousPosition","dragType","dragData","draggedElements","docLock","displayExtCompendiums","displayVirtualDirectory","createEnabled","isPlaceable","allowDocumentSwap","docLockActive","layerSwitchActive","scaling","extCompActive","virtDirActive","sortMode","searchMode","displayDragDropMessage","currentDocument","hoverOverlay","_original","isDragging","objectHover","dropPlaceable","itemList","itemSelect","_activeBrush","_toggleBrush","_playPreview","_endPreview","item","originalEvent","dataTransfer","clearData","setData","targetItem","domRect","getBoundingClientRect","prc","offsetY","reverse","_onItemSort","folderUuid","inWindow","sidebar","_coordOverElement","pageX","pageY","checkMouseInWindow","_onPresetDragOut","_folderToggle","targetFolder","_foundryDrop","_onFolderSort","inside","presetItems","_onToggleSort","_onToggleLock","_onToggleExtComp","_onToggleVirtDir","_onToggleScaling","_onToggleLayerSwitch","_onDocumentChange","_onDoubleClickPreset","_onCreateFolder","_onPresetCreate","_onPresetUpdate","_onToggleFavorite","_onApplyPreset","_onToggleTagSelector","headerSearch","_onSearchInput","_onToggleSearch","_contextMenu","_previewTimeout","_renderPlayPreview","audio","play","_mePreview","thumbnail","_videoPreviewElement","empty","visualViewport","playing","folderElement","_folderCollapse","_folderExpand","setExpanded","sortable","fromUuidSync","TextEditor","getDragEventData","_importTracker","_importActorFolder","parentFolder","nFolder","Folder","implementation","child","_setInteractivityState","state","ContextMenu","_getItemContextOptions","hookName","onOpen","_getFolderContextOptions","condition","_onEditSelectedPresets","_onActivateBrush","_onOpenJournal","_onApplyToSelected","_onCopySelectedPresets","keepFolder","_onCopyPresetToClipboard","_onCopyUUID","_onExportSelectedPresets","_onExportSelectedPresetsToComp","_onDeleteSelectedPresets","header","_onFolderEdit","_onExportFolder","_onFolderDelete","getCompendiumDialog","exportTo","keepIdSelect","_onCopyFolder","parentId","_getSelectedPresets","editableOnly","virtualOnly","selector","exportPresets","_editPresets","confirm","i18n","defaultName","PresetFolderConfig","_searchTimer","_onSearch","newSearch","previousSearch","_resetSearchState","_renderContent","_searchFoundPresets","_searchFolder","_searchPreset","forceRender","childFolderMatch","presetMatch","containsMatch","_resetSearchStateFolder","_resetSearchStatePreset","sourceUuid","targetUuid","sourceUuids","sourceUuidsSet","newSort","searchControl","newMode","lockControl","currentLock","newLock","switchControl","newDocumentName","eventTarget","PresetConfig","mouseX","mouseY","appX","appY","hoverMassEditForm","mouseZ","_onMouseMove","worldTransform","tx","ty","starControl","favorites","popOut","currentPosition","getComputedStyle","tarW","offsetWidth","minW","parseInt","minWidth","MIN_WINDOW_WIDTH","maxW","maxWidth","innerWidth","clamp","clamped","tarH","offsetHeight","minH","minHeight","MIN_WINDOW_HEIGHT","maxH","maxHeight","leftT","topT","posSet","scaledWidth","tarL","maxL","scaledHeight","tarT","maxT","ActiveEffectConfig","_getActiveEffectFields","isCreate","yes","defaultYes","actorToPreset","changes","ev","_onWorkingPackChange","_onOpenIndexer","_onExport","_onImport","getDocuments","importCount","_pages","saveDataToFile","prefix","submitOnClose","displayFieldDelete","displayFieldModify","at","multiEdit","_submitData","minlength","tva","modifyDisabled","deleteDisabled","documentEdit","_onEditDocument","_onAssignDocument","_onDeleteFields","_onSpawnFields","onAttachedRemove","tvaButton","showArtSelect","imgSrc","searchType","updateData","removeTags","PresetFieldModify","PresetFieldDelete","documentClass","tempDoc","_updatePresets","_renderOuter","_createDocumentIdLink","idLink","createElement","classList","setAttribute","tooltipDirection","innerHTML","PresetFieldSelect","isObject","_onFieldClick","singleData","FolderConfig","toggleClass","folderDocs","displayTypes","newName","safeColor","sortingModes","submitText","virtualPackFolder","visibleTypes","updateSource","appW","appH","excludePack","message","buttonLabel","export","lastSelected","itemIndex","lastSelectedIndex","itemArr","toArray","registerPresetBrowserHooks","dragDropHandler","_onDragLeftCancel","libWrapper","sceneControls","presetControl","presetForm","li","packId","DOCUMENT_FIELDS","PRESET_FIELDS","DOC_ICONS","ALL","FAVORITES","Preset","fromEntries","DEFAULT_TOKEN","_data","hook","_postSpawnHooks","attach","flagUpdate","docUpdate","tmp","VirtualFilePreset","_storedReference","prom","Image","onload","race","res","complete","naturalWidth","naturalHeight","video","onloadedmetadata","videoWidth","videoHeight","_updateTimeout","FolderState","_expanded","placeableToData","applyTaggerTagRules","rules","regx","findTag","RegExp","existingDocuments","getByTag","numbers","existingDocument","getTags","temporaryIds","tagRules","_validateTags","applicableTagRules","mergePresetDataToDefaultDoc","strokeWidth","strokeAlpha","hole","randomizeChildrenFolderColors","randObj","applyColors","getPresetDataCenterOffset","MAX_SAFE_INTEGER","MIN_SAFE_INTEGER","getDataBounds","getPresetDataBounds","getTransformToOrigin","next","z2","isVideo","extension","decodeURIComponentSafely","uri","decodeURIComponent","encodeURIComponentSafely","encodeURIComponent","readJSONFile","url","jQuery","getJSON","registerSideBarPresetDropListener","playlist","playlists","channel","repeat","fade","pausedTime","selectField","deselectField","allRandomizedRemoved","selectRandomizerFields","applyRandomization","requiresCoordRandomization","isInteger","color1","color2","rOffset","rnOffset","hexColor","outputSpace","images","maintainAspect","tex","loadTexture","tileRatio","texRatio","shuffled","shuffleArray","strings","coordCtrl","pUpdates","pUpdate","freeId","boundingBox","freeRectangles","stepX","stepY","randomPlace","nearestStep","num","randomNum","temp","rec","fittingRecs","_canFit","rec1","rec2","overlaps","_intersectRec","overlap","_addAndMergeFreeRectangle","TGT_SPLIT_RE","TGT_CLEANUP_RE","once","globalThis","is_fallback","WRAPPER","MIXED","OVERRIDE","package_id","fn","chain","is_setter","root_nm","fn_name","_eval","eval","iObj","descriptor","getOwnPropertyDescriptor","getPrototypeOf","configurable","original","wrapper","applyDDTint","toNumber","string2hex","_string2hex","PlaceableObject","filterType","getDDTint","_TMFXgetSprite","rgb2hex","uniforms","toHex","hex2string","_hex2string","applyTMFXPreset","isImage","isAudio","recursiveTraverse","flagCompare","flag","flagVal","falseyFlagVal","falseyDataVal","compTags","wildcardStringMatch","hasFlagRemove","comp","tempFlag","selectAddSubtractFields","localize","getCommonData","mergeObjectPreserveDot","other","nestedKey","fullKey","panToFitPlaceables","animatePan","duration","topLeft","bottomRight","tlc","_viewPosition","screenDimensions","escapeRegex","string","sw","s2","test","wildcardStringReplace","re","regexStringReplace","activeEffectPresetSelect","aeConfig","showPresetGeneric","nChanges","ACTIVE_EFFECT_MODES","priority","nc","activeEffect","getDocumentName","DOCUMENT_CREATE_REQUESTS","sceneID","requestID","handlerName","socket","emit","resolveCreateDocumentRequest","documentIDs","docID","getEmbeddedDocument","updateEmbeddedDocumentsViaGM","isResponsibleGM","role","compare","isSelf","moduleLocalization","localFormat","insert","applyPresetToScene","randomizer","executeScript","speaker","ChatMessage","getSpeaker","character","argNames","argValues","AsyncFunction","err","SeededRandom","seed","cyrb128","sfc32","chars","h1","h2","h3","h4","charCodeAt","imul","TagInput","registerHandlebarsHelper","registerHelper","hash","Utils","tagHtml","_tagField","listAttr","le","SafeString","meTags","newTags","hiddenInput","tagValue","pickerSelectMultiLayerDocuments","selectionRect","Rectangle","exports","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","__esModule","ns","r","def","getOwnPropertyNames","definition","enumerable","chunkId","all","promises","script","needAttach","scripts","getElementsByTagName","getAttribute","charset","timeout","onScriptComplete","prev","onerror","doneFns","parentNode","head","appendChild","Symbol","toStringTag","installedChunks","installedChunkData","promise","errorType","realSrc","request","webpackJsonpCallback","parentChunkLoadingFunction","chunkIds","moreModules","runtime","chunkLoadingGlobal","self","enableUniversalSelectTool","missingLayers","_placeableRefresh","controllableObjects","regions","rotatableObjects","tools","activeTool","_getControlButtons","defer","_onDragCanvasPan","clones","destination","interactionData","paused","isPreview","sign","rotate","border","V12Migrator","migrateAllPacks","migrateFunc","coreMigration","migratePack","fPack","_migrateData","migrateData","_migratePrototypeAttached","registerBehaviors","String","registerMenu","hint","restricted","onChange","keybindings","editable","modifiers","onDown","precedence","KEYBINDING_PRECEDENCE","NORMAL","getSelection","embedName","INDEX","old","deactivateBrush","linker","hud","tokenData","tileData","background","me"],"sourceRoot":""}