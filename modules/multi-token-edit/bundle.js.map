{"version":3,"file":"bundle.js","mappings":"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","sources":["webpack:///webpack/runtime/create fake namespace object","webpack:///webpack/runtime/load script","webpack:///./multi-token-edit/applications/cssEdit.js","webpack:///./multi-token-edit/applications/dataAdapters.js","webpack:///./multi-token-edit/scripts/tmfx.js","webpack:///./multi-token-edit/applications/history.js","webpack:///./multi-token-edit/scripts/macro/action.js","webpack:///./multi-token-edit/scripts/macro/targets.js","webpack:///./multi-token-edit/scripts/macro/generator.js","webpack:///./multi-token-edit/applications/macro.js","webpack:///./multi-token-edit/applications/forms.js","webpack:///./multi-token-edit/scripts/fieldInjector.js","webpack:///./multi-token-edit/data/custom-controls.js","webpack:///./multi-token-edit/applications/generic/genericForm.js","webpack:///./multi-token-edit/applications/generic/navGenerator.js","webpack:///./multi-token-edit/applications/multiConfig.js","webpack:///./multi-token-edit/scripts/brush.js","webpack:///./multi-token-edit/scripts/dialogs.js","webpack:///./multi-token-edit/scripts/picker.js","webpack:///./multi-token-edit/scripts/presets/collection.js","webpack:///./multi-token-edit/applications/progressDialog.js","webpack:///./multi-token-edit/scripts/fixedSort.js","webpack:///./multi-token-edit/scripts/presets/forms.js","webpack:///./multi-token-edit/scripts/presets/preset.js","webpack:///./multi-token-edit/scripts/presets/utils.js","webpack:///./multi-token-edit/scripts/randomizer/randomizerUtils.js","webpack:///./multi-token-edit/scripts/utils.js","webpack:///external var \"jQuery\"","webpack:///./multi-token-edit/scripts/shim/shim.js","webpack:///./multi-token-edit/scripts/selectTool.js","webpack:///./multi-token-edit/multi-token-edit.mjs","webpack:///./multi-token-edit/scripts/settings.js","webpack:///webpack/bootstrap","webpack:///webpack/runtime/compat get default export","webpack:///webpack/runtime/define property getters","webpack:///webpack/runtime/ensure chunk","webpack:///webpack/runtime/get javascript chunk filename","webpack:///webpack/runtime/hasOwnProperty shorthand","webpack:///webpack/runtime/make namespace object","webpack:///webpack/runtime/publicPath","webpack:///webpack/runtime/jsonp chunk loading","webpack:///webpack/startup"],"sourcesContent":["var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n\t__webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; typeof current == 'object' && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => (def[key] = () => (value[key])));\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","var inProgress = {};\n// data-webpack is not used as build has no uniqueName\n// loadScript function to load a script via script tag\n__webpack_require__.l = (url, done, key, chunkId) => {\n\tif(inProgress[url]) { inProgress[url].push(done); return; }\n\tvar script, needAttach;\n\tif(key !== undefined) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tfor(var i = 0; i < scripts.length; i++) {\n\t\t\tvar s = scripts[i];\n\t\t\tif(s.getAttribute(\"src\") == url) { script = s; break; }\n\t\t}\n\t}\n\tif(!script) {\n\t\tneedAttach = true;\n\t\tscript = document.createElement('script');\n\n\t\tscript.charset = 'utf-8';\n\t\tscript.timeout = 120;\n\t\tif (__webpack_require__.nc) {\n\t\t\tscript.setAttribute(\"nonce\", __webpack_require__.nc);\n\t\t}\n\n\n\t\tscript.src = url;\n\t}\n\tinProgress[url] = [done];\n\tvar onScriptComplete = (prev, event) => {\n\t\t// avoid mem leaks in IE.\n\t\tscript.onerror = script.onload = null;\n\t\tclearTimeout(timeout);\n\t\tvar doneFns = inProgress[url];\n\t\tdelete inProgress[url];\n\t\tscript.parentNode && script.parentNode.removeChild(script);\n\t\tdoneFns && doneFns.forEach((fn) => (fn(event)));\n\t\tif(prev) return prev(event);\n\t}\n\tvar timeout = setTimeout(onScriptComplete.bind(null, undefined, { type: 'timeout', target: script }), 120000);\n\tscript.onerror = onScriptComplete.bind(null, script.onerror);\n\tscript.onload = onScriptComplete.bind(null, script.onload);\n\tneedAttach && document.head.appendChild(script);\n};","import { MODULE_ID } from '../scripts/utils.js';\r\n\r\nexport function getInUseStyle() {\r\n  const styleInUse = game.settings.get(MODULE_ID, 'cssStyle');\r\n  if (styleInUse in STYLES) {\r\n    return [styleInUse, STYLES[styleInUse]];\r\n  } else {\r\n    return ['CUSTOM', game.settings.get(MODULE_ID, 'cssCustom') || ''];\r\n  }\r\n}\r\n\r\nexport default class CSSEdit extends FormApplication {\r\n  constructor() {\r\n    super({}, {});\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-css',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/cssEdit.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: 'Edit CSS',\r\n      width: 490,\r\n      height: 730,\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    const [styleInUse, css] = getInUseStyle();\r\n    data.styleInUse = styleInUse;\r\n    data.css = css;\r\n\r\n    data.styles = Object.keys(STYLES);\r\n    data.styles.push('CUSTOM');\r\n    data.disableCSS = styleInUse !== 'CUSTOM';\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    $(html).on('change', '.selectStyle', (event) => {\r\n      let css;\r\n      if (event.target.value === 'CUSTOM') {\r\n        css = game.settings.get(MODULE_ID, 'cssCustom');\r\n      } else {\r\n        css = STYLES[event.target.value];\r\n      }\r\n      $(html)\r\n        .find('.cssTextArea')\r\n        .val(css)\r\n        .prop('disabled', event.target.value !== 'CUSTOM');\r\n      $(html).find('.previewStyle').html(css);\r\n    });\r\n    $(html).on('input', '.cssTextArea', (event) => {\r\n      $(html).find('.previewStyle').html(event.target.value);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (formData.selectedStyle === 'CUSTOM') {\r\n      game.settings.set(MODULE_ID, 'cssCustom', formData.css);\r\n    }\r\n    game.settings.set(MODULE_ID, 'cssStyle', formData.selectedStyle);\r\n  }\r\n}\r\n\r\n// Pre-made styles\r\nexport const STYLES = {\r\n  Default: `.form-group.meCommon {\r\n  outline: green dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  outline: rgb(255, 204, 110) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  outline: rgb(246, 175, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  outline: rgb(118, 242, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // No Outline\r\n  // ==================\r\n  'No Outline': `.form-group.meCommon {}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Striped Background\r\n  // ==================\r\n  'Striped Background': `.form-group.meCommon {\r\n  background: repeating-linear-gradient(\r\n  45deg,\r\n  rgba(155, 233, 155, 0.8),\r\n  rgba(155, 233, 155, 0.8) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: repeating-linear-gradient(\r\n  135deg,\r\n  rgba(255, 207, 118, 0.5),\r\n  rgba(255, 207, 118, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(237, 149, 255, 0.3),\r\n  rgba(237, 149, 255, 0.3) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(118, 242, 255, 0.5),\r\n  rgba(118, 242, 255, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Solid Background\r\n  // ==================\r\n  'Solid Background': `.form-group.meCommon {\r\n  background: rgba(155, 233, 155, 0.8)\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\noutline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: rgba(255, 207, 118, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: rgba(237, 149, 255, 0.3)\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: rgba(118, 242, 255, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}`,\r\n};\r\n","class PlaylistSoundDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('lvolume' in formData) {\r\n      formData['volume'] = AudioHelper.inputToVolume(formData['lvolume']);\r\n      delete formData['lvolume'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    data['lvolume'] = (note.document ?? note).volume;\r\n  }\r\n\r\n  static updateToForm(update) {\r\n    if ('volume' in update) {\r\n      update['lvolume'] = AudioHelper.volumeToInput(update['volume']);\r\n      delete update.volume;\r\n    }\r\n  }\r\n}\r\n\r\nclass NoteDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('icon.selected' in formData || 'icon.custom' in formData) {\r\n      formData['texture.src'] = formData['icon.selected'] || formData['icon.custom'];\r\n      delete formData['icon.selected'];\r\n      delete formData['icon.custom'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    const doc = note.document ?? note;\r\n    if (doc.texture?.src != null) {\r\n      data['icon.selected'] = doc.texture.src;\r\n      data['icon.custom'] = doc.texture.src;\r\n    }\r\n  }\r\n}\r\n\r\nexport class TokenDataAdapter {\r\n  static updateToForm(update) {\r\n    if ('texture.scaleX' in update) {\r\n      update.mirrorX = update['texture.scaleX'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleX']);\r\n    }\r\n    if ('texture.scaleY' in update) {\r\n      update.mirrorY = update['texture.scaleY'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleY']);\r\n    }\r\n  }\r\n\r\n  static dataToForm(token, data) {\r\n    const doc = token.document ?? token;\r\n    if (doc.texture?.scaleX != null) data.scale = Math.abs(doc.texture.scaleX);\r\n    if (doc.texture?.scaleX != null) data.mirrorX = doc.texture.scaleX < 0;\r\n    if (doc.texture?.scaleY != null) data.mirrorY = doc.texture.scaleY < 0;\r\n  }\r\n\r\n  static formToData(token, formData) {\r\n    const doc = token.document ?? token;\r\n\r\n    // Scale/mirroring\r\n    if ('scale' in formData || 'mirrorX' in formData || 'mirrorY' in formData) {\r\n      if (!('scale' in formData)) formData.scale = Math.abs(doc.texture.scaleX);\r\n      if (!('mirrorX' in formData)) formData.mirrorX = doc.texture.scaleX < 0;\r\n      if (!('mirrorY' in formData)) formData.mirrorY = doc.texture.scaleY < 0;\r\n      formData['texture.scaleX'] = formData.scale * (formData.mirrorX ? -1 : 1);\r\n      formData['texture.scaleY'] = formData.scale * (formData.mirrorY ? -1 : 1);\r\n      ['scale', 'mirrorX', 'mirrorY'].forEach((k) => delete formData[k]);\r\n    }\r\n\r\n    // Detection modes\r\n    TokenDataAdapter.correctDetectionModes(doc, formData);\r\n  }\r\n\r\n  static correctDetectionModeOrder(data, randomizeFields) {\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          i++;\r\n        }\r\n        const newKey = `detectionModes.${indexMap[comps[1]]}.${comps[2]}`;\r\n        delete data[k];\r\n        data[newKey] = v;\r\n        if (randomizeFields && k in randomizeFields) {\r\n          const rVal = randomizeFields[k];\r\n          delete randomizeFields[k];\r\n          randomizeFields[newKey] = rVal;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static detectionModeMatch(searchModes, tokenModes) {\r\n    for (const m1 of searchModes) {\r\n      if (!('id' in m1)) continue; // Ignore mode search attempts without ids as they can't be matched up\r\n      for (const m2 of tokenModes) {\r\n        if (m1.id === m2.id) {\r\n          if ('enabled' in m1 && m1.enabled !== m2.enabled) return false;\r\n          if ('range' in m1 && m1.range !== m2.range) return false;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  static correctDetectionModes(token, data) {\r\n    const detectionModes = [];\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          detectionModes.push({});\r\n          i++;\r\n        }\r\n        const dm = detectionModes[indexMap[comps[1]]];\r\n        dm[comps[2]] = v;\r\n        // data[`${comps[0]}.${indexMap[comps[1]]}.${comps[2]}`] = v;\r\n        delete data[k];\r\n      }\r\n    }\r\n\r\n    if (!detectionModes.length) return;\r\n\r\n    // Merge current detectionModes assigned to the token and the new ones being added\r\n    const mergedModes = foundry.utils.deepClone(token.detectionModes).filter((d) => d.id);\r\n    for (const dm of detectionModes) {\r\n      if (dm.id == null) continue;\r\n\r\n      let found = false;\r\n      for (const tdm of mergedModes) {\r\n        if (tdm.id === dm.id) {\r\n          foundry.utils.mergeObject(tdm, dm);\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n      if (!found) mergedModes.push(foundry.utils.mergeObject({ id: '', range: 0, enabled: true }, dm));\r\n    }\r\n    data.detectionModes = mergedModes;\r\n  }\r\n\r\n  static modifyPresetData(app, data) {\r\n    const pModes = Object.values(foundry.utils.expandObject(data)?.detectionModes || {});\r\n    if (!pModes.length) return;\r\n\r\n    const modes = Object.values(foundry.utils.expandObject(app._getSubmitData())?.detectionModes || {});\r\n\r\n    const dataClone = foundry.utils.deepClone(data);\r\n    const randomize = data['mass-edit-randomize'] ?? {};\r\n    const addSubtract = data['mass-edit-addSubtract'] ?? {};\r\n\r\n    const modCustomFields = function (fields, key, i, k, data) {\r\n      if (`detectionModes.${i}.${k}` in fields) {\r\n        delete fields[`detectionModes.${i}.${k}`];\r\n        fields[`detectionModes.${j}.${k}`] = data[key][`detectionModes.${i}.${k}`];\r\n      }\r\n    };\r\n\r\n    const startingModeLength = modes.length;\r\n    for (let i = 0; i < pModes.length; i++) {\r\n      if (!('id' in pModes[i])) continue;\r\n      let found = false;\r\n      for (let j = 0; j < startingModeLength; j++) {\r\n        if (pModes[i].id === modes[j].id) {\r\n          found = true;\r\n          Object.keys(pModes[i]).forEach((k) => {\r\n            delete data[`detectionModes.${i}.${k}`];\r\n            data[`detectionModes.${j}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n            modCustomFields(randomize, 'mass-edit-randomize', i, k, dataClone);\r\n            modCustomFields(addSubtract, 'mass-edit-addSubtract', i, k, dataClone);\r\n          });\r\n        }\r\n      }\r\n      if (!found) {\r\n        modes.push({ id: '', range: 0, enabled: true });\r\n        Object.keys(pModes[i]).forEach((k) => {\r\n          delete data[`detectionModes.${i}.${k}`];\r\n          data[`detectionModes.${modes.length - 1}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n\r\n          if (`detectionModes.${i}.${k}` in randomize) {\r\n            delete randomize[`detectionModes.${i}.${k}`];\r\n            randomize[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-randomize'][`detectionModes.${i}.${k}`];\r\n          }\r\n          if (`detectionModes.${i}.${k}` in addSubtract) {\r\n            delete addSubtract[`detectionModes.${i}.${k}`];\r\n            addSubtract[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-addSubtract'][`detectionModes.${i}.${k}`];\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    if (startingModeLength !== modes.length) {\r\n      app._previewChanges({ detectionModes: modes });\r\n      app.render();\r\n      return true;\r\n    }\r\n  }\r\n}\r\n\r\nconst ADAPTERS = {\r\n  Token: TokenDataAdapter,\r\n  PlaylistSound: PlaylistSoundDataAdapter,\r\n  Note: NoteDataAdapter,\r\n};\r\n\r\nexport class GeneralDataAdapter {\r\n  static formToData(docName, obj, formData) {\r\n    const adapter = ADAPTERS[docName];\r\n    if (adapter && adapter.formToData) {\r\n      adapter.formToData(obj, formData);\r\n    }\r\n  }\r\n\r\n  static dataToForm(docName, obj, formData) {\r\n    const adapter = ADAPTERS[docName];\r\n    if (adapter && adapter.dataToForm) {\r\n      adapter.dataToForm(obj, formData);\r\n    }\r\n  }\r\n\r\n  static updateToForm(docName, update) {\r\n    const adapter = ADAPTERS[docName];\r\n    if (adapter && adapter.updateToForm) {\r\n      adapter.updateToForm(update);\r\n    }\r\n  }\r\n}\r\n","export async function applyDDTint(placeable, color) {\r\n  placeable = placeable.object ?? placeable;\r\n  color = _string2hex(color);\r\n  if (placeable instanceof PlaceableObject) {\r\n    if (isNaN(color)) {\r\n      await TokenMagic.deleteFilters(placeable, 'DDTint');\r\n    } else {\r\n      await TokenMagic.addUpdateFilters(placeable, [\r\n        {\r\n          filterType: 'ddTint',\r\n          filterId: 'DDTint',\r\n          tint: PIXI.utils.hex2rgb(color),\r\n        },\r\n      ]);\r\n    }\r\n  } else {\r\n    let filters = placeable['flags.tokenmagic.filters'];\r\n    if (isNaN(color)) {\r\n      if (filters) {\r\n        placeable['flags.tokenmagic.filters'] = filters.filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      placeable['flags.tokenmagic.filters'] = filters;\r\n    }\r\n  }\r\n}\r\n\r\nexport function getDDTint(placeable) {\r\n  let color = 0xff0000;\r\n  let obj = placeable.object ?? placeable;\r\n  if (obj._TMFXgetSprite) {\r\n    const filter = obj._TMFXgetSprite()?.filters?.find((f) => f.filterId === 'DDTint');\r\n    if (filter) color = PIXI.utils.rgb2hex(filter.uniforms.tint);\r\n  }\r\n  return _hex2string(color);\r\n}\r\n\r\nexport async function applyTMFXPreset(placeable, presetName, remove = false) {\r\n  placeable = placeable.object ?? placeable;\r\n  if (!(placeable instanceof PlaceableObject)) return;\r\n  if (presetName === 'DELETE ALL') {\r\n    await TokenMagic.deleteFilters(placeable);\r\n  } else if (remove) {\r\n    await TokenMagic.deleteFilters(placeable, presetName);\r\n  } else {\r\n    const preset = TokenMagic.getPreset(presetName);\r\n    if (preset) await TokenMagic.addUpdateFilters(placeable, foundry.utils.deepClone(preset));\r\n  }\r\n}\r\n\r\nfunction _hex2string(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toHex();\r\n  } else {\r\n    return PIXI.utils.hex2string(color);\r\n  }\r\n}\r\n\r\nfunction _string2hex(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toNumber();\r\n  } else {\r\n    return PIXI.utils.string2hex(color);\r\n  }\r\n}\r\n","import { HISTORY } from '../multi-token-edit.mjs';\r\nimport { Preset } from '../scripts/presets/preset.js';\r\nimport { MODULE_ID, localize } from '../scripts/utils.js';\r\nimport { GeneralDataAdapter } from './dataAdapters.js';\r\nimport { copyToClipboard } from './forms.js';\r\nimport { LAYER_MAPPINGS } from './multiConfig.js';\r\n\r\nexport default class MassEditHistory extends FormApplication {\r\n  constructor(docName, callback) {\r\n    super({}, {});\r\n    this.callback = callback;\r\n    this.docName = docName;\r\n    this.history = foundry.utils.deepClone(HISTORY);\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-history',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/history.html`,\r\n      resizable: false,\r\n      minimizable: false,\r\n      title: `History`,\r\n      width: 400,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return `[${this.docName}] ${localize('common.history')}`;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    const historyItems = (this.history[this.docName] ?? []).reverse();\r\n    data.updates = [];\r\n\r\n    let formHasDiff = false;\r\n\r\n    const getTitle = function (fields, rdm, addSubtract) {\r\n      let title = '';\r\n      for (const k of Object.keys(fields)) {\r\n        if (['_id', 'mass-edit-randomize', 'mass-edit-addSubtract'].includes(k)) continue;\r\n\r\n        if (k in rdm) {\r\n          title += `${k}: {{randomized}}\\n`;\r\n        } else if (k in addSubtract) {\r\n          const val = 'value' in addSubtract[k] ? addSubtract[k].value : fields[k];\r\n          title += `${k}: ${addSubtract[k].method === 'add' ? '+' : '-'}${val}\\n`;\r\n        } else {\r\n          title += `${k}: ${fields[k]}\\n`;\r\n        }\r\n      }\r\n      return title;\r\n    };\r\n\r\n    for (const item of historyItems) {\r\n      const rdm = item.ctrl['mass-edit-randomize'] || {};\r\n      const addSubtract = item.ctrl['mass-edit-addSubtract'] || {};\r\n\r\n      const fullTitle = getTitle(foundry.utils.deepClone(item.update), rdm, addSubtract);\r\n      const title = getTitle(foundry.utils.deepClone(item.diff), rdm, addSubtract);\r\n\r\n      const hasDifferences = fullTitle !== title;\r\n      if (hasDifferences) formHasDiff = true;\r\n\r\n      data.updates.push({\r\n        label: item['timestamp'],\r\n        title: title,\r\n        fullTitle: fullTitle,\r\n        id: item._id,\r\n        hasDifferences: hasDifferences,\r\n      });\r\n    }\r\n\r\n    data.includeDiff = formHasDiff;\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.on('click', '.doc-id', (event) => {\r\n      const id = $(event.target).closest('div').find('button')[0].dataset.id;\r\n      const layer = LAYER_MAPPINGS[this.docName];\r\n      if (layer) {\r\n        let placeable = canvas[layer].placeables.find((p) => p.id === id) || null;\r\n        if (placeable) {\r\n          canvas.animatePan({ x: placeable.center.x, y: placeable.center.y, duration: 250 });\r\n        }\r\n      }\r\n    });\r\n\r\n    const copy = function (event, type, history, docName) {\r\n      const index = $(event.target).closest('li')[0].dataset.index;\r\n      const docHistory = history[docName] ?? [];\r\n      const historyItem = docHistory[index];\r\n      if (historyItem) {\r\n        const preset = new Preset({\r\n          documentName: docName,\r\n          data: foundry.utils.deepClone(historyItem[type]),\r\n          randomize: historyItem.ctrl['mass-edit-randomize'],\r\n          addSubtract: historyItem.ctrl['mass-edit-addSubtract'],\r\n        });\r\n        copyToClipboard(preset);\r\n      }\r\n    };\r\n\r\n    html.on('click', '.doc-copy-update', (event) => {\r\n      copy(event, 'update', this.history, this.docName);\r\n    });\r\n\r\n    html.on('click', '.doc-copy-diff', (event) => {\r\n      copy(event, 'diff', this.history, this.docName);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    const index = $(event.submitter).closest('li')[0].dataset.index;\r\n    const docHistory = this.history[this.docName] ?? [];\r\n    const historyItem = docHistory[index];\r\n    if (historyItem) {\r\n      const update = foundry.utils.deepClone(historyItem[event.submitter.name]);\r\n      GeneralDataAdapter.updateToForm(this.docName, update);\r\n\r\n      const preset = new Preset({\r\n        documentName: this.docName,\r\n        data: update,\r\n        randomize: historyItem.ctrl['mass-edit-randomize'],\r\n        addSubtract: historyItem.ctrl['mass-edit-addSubtract'],\r\n      });\r\n\r\n      this.callback(preset);\r\n    }\r\n  }\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { hasMassEditUpdateDependency, objToString } from './generator.js';\r\n\r\nexport function genAction(options, docName) {\r\n  if (options.method === 'update' || options.method === 'toggle') {\r\n    let command = ``;\r\n\r\n    if (options.method === 'toggle') command += genToggleUtil(options);\r\n\r\n    // Insert 'update' objects\r\n\r\n    command += `\\n// Updates to be applied\r\nconst update = ${objToString(options.fields)};\\n`;\r\n    if (options.method === 'toggle') command += `const update2 = ${objToString(options.toggle.fields)};\\n\\n`;\r\n\r\n    // Insert Mass Edit control objects\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      command += `\\n// Mass Edit control objects\\n`;\r\n      if (options.randomize) command += `const randomizeFields = ${objToString(options.randomize)};\\n`;\r\n      if (options.addSubtract) command += `const addSubtractFields = ${objToString(options.addSubtract)};\\n`;\r\n      if (options.toggle) {\r\n        if (options.toggle.randomize)\r\n          command += `const randomizeFieldsToggleOff = ${objToString(options.toggle?.randomize)};\\n`;\r\n        if (options.toggle.addSubtract)\r\n          command += `const addSubtractFieldsToggleOff = ${objToString(options.toggle?.addSubtract)};\\n`;\r\n      }\r\n    }\r\n\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      return command + genUpdateWithMassEditDep(options, docName);\r\n    } else {\r\n      return command + genUpdate(options, docName);\r\n    }\r\n  } else if (options.method === 'massEdit') {\r\n    return `\\n// Open Mass Edit Form\r\nawait MassEdit.api.showMassEdit(targets, '${docName}');`;\r\n  } else if (options.method === 'delete') {\r\n    return genDelete(options, docName);\r\n  }\r\n}\r\n\r\nfunction genDelete(options, docName) {\r\n  let command = `\\n// Delete ${docName}s`;\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    if (options.target.scope === 'selected' || options.target.scope === 'scene') {\r\n      command += `\\ncanvas.scene.deleteEmbeddedDocuments('${docName}', targets.map(t => t.id));`;\r\n    } else {\r\n      command += `\\nconst toDelete = {};\r\ntargets.forEach( t => {\r\n  const sceneID = t.parent.id;\r\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\r\n  toDelete[sceneID].push(t.id);\r\n});\r\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${docName}', toDelete[sceneID]));\r\n      `;\r\n    }\r\n  } else {\r\n    command += `\\n${docName}.deleteDocuments(targets.map( t => t.id ));`;\r\n  }\r\n  return command;\r\n}\r\n\r\nfunction genUpdate(options, docName) {\r\n  // Update related code\r\n  let command = '';\r\n\r\n  // Macro only execution, ignore update code\r\n  if (foundry.utils.isEmpty(options.fields) && !options.toggle) {\r\n    return '';\r\n  } else if (options.toggle && foundry.utils.isEmpty(options.toggle.fields) && foundry.utils.isEmpty(options.fields)) {\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n\r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n    `;\r\n  }\r\n\r\n  // We start generating update code here\r\n  // Are there macros to execute?\r\n  const macroTracking = (options.macro || options.toggle?.macro) && options.toggle;\r\n\r\n  if (macroTracking) {\r\n    command += `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  `;\r\n  }\r\n\r\n  // Setting up updates\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    command += '\\nconst updates = {};';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n\r\n  updates[sceneId].push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n  \r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n    updates[sceneId].push(u);\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    command += '\\nconst updates = [];';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    }\r\n  }\r\n\r\n  // Executing updates\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    command += `\r\nfor(const sceneId of Object.keys(updates)) {\r\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${docName}', updates[sceneId]);\r\n}\r\n  `;\r\n  } else if (docName === 'PlaylistSound') {\r\n    command += `\r\nfor (let i = 0; i < targets.length; i++) {\r\n  delete updates[i]._id;\r\n  targets[i].document.update(updates[i]);\r\n}\r\n  `;\r\n  } else {\r\n    command += `\\n${docName}.updateDocuments(updates);\\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genUpdateWithMassEditDep(options, docName) {\r\n  let context = [];\r\n  if (options.randomize) context.push('randomizeFields');\r\n  if (options.addSubtract) context.push('addSubtractFields');\r\n  context = context.join(', ');\r\n\r\n  if (options.method === 'toggle') {\r\n    let context2 = [];\r\n    if (options.toggle?.randomize) context2.push('randomizeFields: randomizeFieldsToggleOff');\r\n    if (options.toggle?.addSubtract) context2.push('addSubtractFields: addSubtractFieldsToggleOff');\r\n    context2 = context2.join(', ');\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  \r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n  \r\nawait MassEdit.api.performMassUpdate.call({${context}}, update, toggleOnTargets, '${docName}');\r\nawait MassEdit.api.performMassUpdate.call({${context2}}, update2, toggleOffTargets, '${docName}');\r\n`;\r\n  } else {\r\n    return `await MassEdit.api.performMassUpdate.call({${context}}, update, targets, '${docName}');\\n`;\r\n  }\r\n}\r\n\r\nfunction genToggleUtil(options) {\r\n  let command = `\\n// Toggle; Helper function`;\r\n  if (options.toggle.method === 'field') {\r\n    command += `\r\nconst toggleOn = function (obj, fields) {\r\n  const data = foundry.utils.flattenObject(obj.toObject());\r\n  fields = foundry.utils.flattenObject(fields);\r\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\r\n};\r\n  `;\r\n  } else {\r\n    command += `\r\nconst macro = this;\r\nconst toggleOn = function (obj) {\r\n  if (obj.getFlag('world', \\`macro-\\${macro.id}-toggleOn\\`)) {\r\n    obj.unsetFlag('world', \\`macro-\\${macro.id}-toggleOn\\`);\r\n    return true;\r\n  } else {\r\n    obj.setFlag('world', \\`macro-\\${macro.id}-toggleOn\\`, true);\r\n    return false;\r\n  }\r\n};\r\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { objToString } from './generator.js';\r\n\r\nexport function genTargets(options, docName, selected) {\r\n  const target = options.target;\r\n  if (target.method === 'ids') {\r\n    return genIDTargets(target, docName, selected);\r\n  } else if (target.method === 'search') {\r\n    return genSearch(target, docName);\r\n  } else if (target.method === 'tagger') {\r\n    return genTaggerTargets(target, docName);\r\n  } else if (target.method === 'all') {\r\n    return genAllTargets(target, docName);\r\n  } else {\r\n    throw new Error('Invalid target method: ' + target.method);\r\n  }\r\n}\r\n\r\nfunction genSearch(target, docName) {\r\n  let fields = objToString(target.fields);\r\n  if (target.scope === 'selected') {\r\n    let command = genSelected(docName);\r\n    command += `\\ntargets = await MassEdit.api.performMassSearch('search', '${docName}' , ${fields}, { scope: 'selected', selected: targets, control: false, pan: false });`;\r\n    return command;\r\n  } else if (target.scope === 'scene') {\r\n    return `const targets = await MassEdit.api.performMassSearch('search', '${docName}' , ${fields}, { scope: 'scene', control: false, pan: false });`;\r\n  } else if (target.scope === 'world') {\r\n    return `const targets = await MassEdit.api.performMassSearch('search', '${docName}' , ${fields}, { scope: 'world', control: false, pan: false });`;\r\n  }\r\n}\r\n\r\n// Construct all selected document retriever\r\n// const selected = [...];\r\nfunction genSelected(docName) {\r\n  let command = '';\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    return `let targets = canvas.getLayerByEmbeddedName('${docName}').controlled.map(o => o.document);\\n\\n`;\r\n  } else if (game.modules.get('multiple-document-selection')?.active) {\r\n    const mdsClasses = {\r\n      Actor: 'actor',\r\n      Scene: 'scene',\r\n      JournalEntry: 'journalentry',\r\n      Playlist: 'sound',\r\n      Item: 'item',\r\n      RollTable: 'RollTable',\r\n      Cards: 'cards',\r\n    };\r\n\r\n    command += 'let targets = [];\\n';\r\n\r\n    if (docName === 'Playlist') {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[docName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n  if (d) targets.push(d);\r\n});\r\n`;\r\n    } else {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[docName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('${docName}').get(this.dataset.documentId);\r\n  if (d) targets.push(d);\r\n});\r\n  `;\r\n    }\r\n    return command;\r\n  } else {\r\n    throw new Error(`'Selected' is not a supported options for ${docName}s`);\r\n  }\r\n}\r\n\r\nfunction genAllTargets(target, docName) {\r\n  if (target.scope === 'selected') {\r\n    return genSelected(docName);\r\n  } else if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    if (target.scope === 'scene') {\r\n      return `const targets = canvas.getLayerByEmbeddedName('${docName}').placeables.map(o => o.document);\\n\\n`;\r\n    } else if (target.scope === 'world') {\r\n      return `const targets = [];\r\nArray.from(game.scenes).forEach( scene => {\r\n  Array.from( scene.getEmbeddedCollection('${docName}') ).forEach(embed => targets.push(embed));\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    return `const targets = Array.from(game.collections.get('${docName}'));`;\r\n  }\r\n}\r\n\r\nfunction genTaggerTargets(target, docName) {\r\n  let command = '';\r\n  const opts = {\r\n    matchAny: target.tagger.match === 'any',\r\n    allScenes: target.scope === 'world',\r\n  };\r\n\r\n  if (target.scope === 'selected') {\r\n    command += genSelected(docName);\r\n    command += `targets = Tagger.getByTag('${target.tagger.tags}', { matchAny: ${\r\n      target.tagger.match === 'any'\r\n    }, objects: targets }).filter(t => t.documentName === '${docName}');\\n\\n`;\r\n  } else if (target.scope === 'scene') {\r\n    command += `const targets = Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )}).filter(t => t.documentName === '${docName}');\\n\\n`;\r\n  } else if (target.scope === 'world') {\r\n    command += `const targets = [];`;\r\n    command += `Object.values(Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )})).forEach(item => item.forEach(t => { if(t.documentName === '${docName}') targets.push(t) }));`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genIDTargets(target, docName, selected) {\r\n  let command = `const ids = [${selected.map((p) => `\"${p.id}\"`).join(',')}];\\n`;\r\n  command += `const targets = [];`;\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    command += `\r\nids.forEach( id => {\r\n  Array.from(game.scenes).forEach( scene => {\r\n    let embed = scene.getEmbeddedDocument('${docName}', id);\r\n    if(embed) targets.push(embed)\r\n  });\r\n});\r\n`;\r\n  } else {\r\n    command += `\r\nids.forEach(id => { \r\n  const doc = ${docName}.get(id);\r\n  if(doc) targets.push(doc);\r\n});`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, localFormat } from '../utils.js';\r\nimport { genAction } from './action.js';\r\nimport { genTargets } from './targets.js';\r\n\r\n// Util to stringify a json object\r\nexport function objToString(obj) {\r\n  if (!obj) return null;\r\n  return JSON.stringify(obj, null, 2);\r\n}\r\n\r\nexport async function generateMacro(docName, placeables, options) {\r\n  let command = '';\r\n\r\n  // Dependencies get checked first\r\n  command += genMacroDependencies(options, docName);\r\n  command += genTargets(options, docName, placeables);\r\n  command += genAction(options, docName);\r\n  if (options.macro || options.toggle?.macro) {\r\n    command += genRunMacro(options, docName);\r\n  }\r\n\r\n  if (command) {\r\n    // Create Macro\r\n    const macro = await Macro.create({\r\n      name: options.name,\r\n      type: 'script',\r\n      scope: 'global',\r\n      command: command,\r\n    });\r\n    macro.sheet.render(true);\r\n  }\r\n}\r\n\r\nfunction genRunMacro(options, docName) {\r\n  let command = `\\n\r\n// ===================\r\n// = Macro Execution =\r\n// ===================\r\n\r\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\r\nconst layer = canvas.getLayerByEmbeddedName('${docName}');\r\n`;\r\n  // Run macros if applicable\r\n  if (options.macro) {\r\n    command += `\r\n// Apply macro\r\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${options.macro.name}')\r\nif (applyMacro && ${options.toggle ? 'toggleOnTargets' : 'targets'}.length) {\r\n  ${\r\n    options.macro.select\r\n      ? `layer.activate();\\n  layer.releaseAll();\\n  ${\r\n          options.toggle ? 'toggleOnTargets' : 'targets'\r\n        }.forEach(t => t.object?.control({ releaseOthers: false }));\\n`\r\n      : ''\r\n  }\r\n  if (advancedMacro) applyMacro.execute(${options.toggle ? 'toggleOnTargets' : 'targets'});\r\n  else applyMacro.execute({token, actor});\r\n  ${options.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  if (options.toggle?.macro) {\r\n    command += `\r\n// Apply macro on toggle off\r\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${options.toggle.macro.name}')\r\nif (offMacro && toggleOffTargets.length) {\r\n  ${\r\n    options.toggle.macro.select\r\n      ? 'layer.activate();\\n  layer.releaseAll();\\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\\n'\r\n      : ''\r\n  }\r\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\r\n  else offMacro.execute({token, actor});\r\n  ${options.toggle.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  return command;\r\n}\r\n\r\nexport function hasMassEditDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    options.target.method === 'search' ||\r\n    options.method === 'massEdit' ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nexport function hasMassEditUpdateDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nfunction genMacroDependencies(options, docName) {\r\n  let dep = '';\r\n\r\n  const depWarning = (module) => {\r\n    return `ui.notifications.warn('${localFormat('macro.dependency-warning', {\r\n      module,\r\n    })}');`;\r\n  };\r\n\r\n  if (options.target.method === 'tagger')\r\n    dep += `\r\nif (!game.modules.get('tagger')?.active) {\r\n  ${depWarning('Tagger')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (hasMassEditDependency(options))\r\n    dep += `\r\nconst MassEdit = game.modules.get('${MODULE_ID}');\r\nif(!MassEdit?.active){\r\n  ${depWarning('Mass Edit')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (SUPPORTED_COLLECTIONS.includes(docName) && options.target.scope === 'select')\r\n    dep += `\r\nif (!game.modules.get('multiple-document-selection')?.active) {\r\n  ${depWarning('Multiple Document Selection')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  return dep;\r\n}\r\n\r\nexport function hasSpecialField(fields) {\r\n  const specialFields = ['tokenmagic.ddTint', 'tokenmagic.preset', 'massedit.scale', 'massedit.texture.scale'];\r\n  for (const sf of specialFields) {\r\n    if (sf in fields) return true;\r\n  }\r\n  return false;\r\n}\r\n","import { generateMacro, hasSpecialField } from '../scripts/macro/generator.js';\r\nimport { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES, localFormat, localize } from '../scripts/utils.js';\r\nimport { GeneralDataAdapter } from './dataAdapters.js';\r\n\r\nexport default class MacroForm extends FormApplication {\r\n  constructor(object, placeables, docName, fields, randomizeFields, addSubtractFields) {\r\n    super({}, {});\r\n    this.mainObject = object;\r\n    this.placeables = placeables;\r\n    this.docName = docName;\r\n    this.fields = fields;\r\n    this.randomizeFields = randomizeFields;\r\n    this.addSubtractFields = addSubtractFields;\r\n\r\n    if (\r\n      (randomizeFields && !foundry.utils.isEmpty(randomizeFields)) ||\r\n      (addSubtractFields && !foundry.utils.isEmpty(addSubtractFields))\r\n    ) {\r\n      // keep selected fields in form format\r\n    } else {\r\n      GeneralDataAdapter.formToData(this.docName, this.mainObject, this.fields);\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-macro',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/macro.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generate Macro`,\r\n      width: 400,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    data.docName = this.docName;\r\n    data.fields = JSON.stringify(this.fields, null, 2);\r\n    data.selectable = SUPPORTED_PLACEABLES.includes(this.docName);\r\n    data.selectScopeEnabled =\r\n      data.selectable ||\r\n      (SUPPORTED_COLLECTIONS.includes(this.docName) && game.modules.get('multiple-document-selection')?.active);\r\n\r\n    // Define targeting options based on the document being updated\r\n    const targetingOptions = [\r\n      {\r\n        value: 'all',\r\n        title: localFormat('macro.target-all-title', { document: this.docName }),\r\n        label: localize('common.all'),\r\n      },\r\n      {\r\n        value: 'ids',\r\n        title: localize('macro.target-ids-title'),\r\n        label: localize('macro.target-ids'),\r\n      },\r\n      {\r\n        value: 'search',\r\n        title: localFormat('macro.target-search-title', { document: this.docName }),\r\n        label: localize('FILES.Search', false),\r\n      },\r\n    ];\r\n    if (SUPPORTED_PLACEABLES.includes(this.docName) && game.modules.get('tagger')?.active) {\r\n      targetingOptions.push({\r\n        value: 'tagger',\r\n        title: localize('macro.target-tagger-title'),\r\n        label: 'Tagger',\r\n      });\r\n    }\r\n    data.targetingOptions = targetingOptions;\r\n\r\n    if (this.addSubtractFields && !foundry.utils.isEmpty(this.addSubtractFields)) {\r\n      data.hasAddSubtract = true;\r\n      data.addSubtract = JSON.stringify(this.addSubtractFields);\r\n    }\r\n\r\n    if (this.randomizeFields && !foundry.utils.isEmpty(this.randomizeFields)) {\r\n      data.hasRandom = true;\r\n      data.randomize = JSON.stringify(this.randomizeFields);\r\n    }\r\n\r\n    data.hasMEControls = data.hasAddSubtract || data.hasRandom || hasSpecialField(this.fields);\r\n\r\n    // Visibility Toggle\r\n    data.hiddenControl = ['Token', 'Tile', 'Drawing', 'AmbientLight', 'AmbientSound', 'MeasuredTemplate'].includes(\r\n      this.docName\r\n    );\r\n\r\n    // Macros\r\n    data.macros = game.collections.get('Macro').map((m) => m.name);\r\n\r\n    return data;\r\n  }\r\n\r\n  _onShowReturnJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    const data = JSON.parse(store.val());\r\n\r\n    let content = `<textarea name=\"json\" style=\"width:100%; height: 300px;\">${JSON.stringify(\r\n      data,\r\n      null,\r\n      2\r\n    )}</textarea>`;\r\n    new Dialog({\r\n      title: `JSON`,\r\n      content: content,\r\n      buttons: {\r\n        Ok: {\r\n          label: localize('Save', false),\r\n          callback: (html) => {\r\n            try {\r\n              const val = JSON.parse(html.find('[name=\"json\"]').val() || '{}');\r\n              if (foundry.utils.isEmpty(val)) {\r\n                control.hide();\r\n                store.prop('disabled', true);\r\n                this.setPosition({ height: 'auto' });\r\n              } else {\r\n                store.val(JSON.stringify(val));\r\n              }\r\n            } catch (e) {\r\n              ui.notifications.warn('Invalid data. Failed to save.');\r\n            }\r\n          },\r\n        },\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  _onRemoveJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    control.hide();\r\n    store.prop('disabled', true);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    ['randomize', 'addSubtract', 'toggle.randomize', 'toggle.addSubtract'].forEach((name) => {\r\n      const className = name.replace('.', '');\r\n      html.find(`.${className}`).click((event) => {\r\n        this._onShowReturnJson($(event.target).parent(), name);\r\n      });\r\n      html.find(`.${className}`).contextmenu((event) => {\r\n        this._onRemoveJson($(event.target).parent(), name);\r\n      });\r\n    });\r\n\r\n    html.find('.toggleVisibility').click((event) => {\r\n      const fields = html.find('[name=\"fields\"]');\r\n      const toggleFields = html.find('[name=\"toggle.fields\"]');\r\n\r\n      let update,\r\n        update2 = {};\r\n\r\n      try {\r\n        update = JSON.parse(fields.val());\r\n        update.hidden = !update.hidden;\r\n        fields.val(JSON.stringify(update, null, 2));\r\n\r\n        update2 = JSON.parse(toggleFields.val());\r\n        update2.hidden = !update.hidden;\r\n        toggleFields.val(JSON.stringify(update2, null, 2));\r\n      } catch (e) {}\r\n    });\r\n\r\n    html.find('[name=\"target.method\"]').change((event) => {\r\n      // Hide/show tagger controls\r\n      if (event.target.value === 'tagger') {\r\n        html.find('.taggerControl').show();\r\n        html.find('[name=\"tags\"').attr('required', true);\r\n      } else {\r\n        html.find('.taggerControl').hide();\r\n        html.find('[name=\"tags\"').attr('required', false);\r\n      }\r\n\r\n      // Hide/show scope\r\n      if (event.target.value === 'ids') html.find('[name=\"target.scope\"]').closest('.form-group').hide();\r\n      else html.find('[name=\"target.scope\"]').closest('.form-group').show();\r\n\r\n      if (event.target.value === 'search') html.find('[name=\"target.fields\"]').closest('div').show();\r\n      else html.find('[name=\"target.fields\"]').closest('div').hide();\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.find('[name=\"method\"]').on('change', (event) => {\r\n      if (event.target.value === 'toggle') {\r\n        let data = foundry.utils.flattenObject(getData(this.mainObject).toObject());\r\n\r\n        const toggleFields = {};\r\n        Object.keys(this.fields).forEach((k) => (toggleFields[k] = data[k]));\r\n        html.find('[name=\"toggle.fields\"]').val(JSON.stringify(toggleFields, null, 2));\r\n        html.find('.toggleControl').show();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.toggleControl').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n\r\n      if (event.target.value === 'massEdit' || event.target.value === 'delete') {\r\n        html.find('.fields').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.fields').show();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    formData = expandObject(formData);\r\n\r\n    // Cleanup form data so that the macro generator only receives necessary information\r\n    formData.fields = JSON.parse(formData.fields);\r\n    if (formData.method !== 'toggle') delete formData.toggle;\r\n    else formData.toggle.fields = JSON.parse(formData.toggle.fields);\r\n\r\n    if (!formData.macro.name) delete formData.macro;\r\n    if (formData.toggle?.macro && !formData.toggle.macro.name) delete formData.toggle.macro;\r\n\r\n    if (formData.target.method !== 'tagger') delete formData.target.tagger;\r\n    if (formData.target.method !== 'search') delete formData.target.fields;\r\n    else formData.target.fields = JSON.parse(formData.target.fields);\r\n\r\n    if (formData.randomize) formData.randomize = JSON.parse(formData.randomize);\r\n    if (formData.toggle?.randomize) formData.toggle.randomize = JSON.parse(formData.toggle.randomize);\r\n    if (formData.addSubtract) formData.addSubtract = JSON.parse(formData.addSubtract);\r\n    if (formData.toggle?.addSubtract) formData.toggle.addSubtract = JSON.parse(formData.toggle.addSubtract);\r\n\r\n    generateMacro(this.docName, this.placeables, formData);\r\n  }\r\n}\r\n\r\nfunction getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n","import { Brush } from '../scripts/brush.js';\r\nimport { injectFlagTab, injectVisibility } from '../scripts/fieldInjector.js';\r\nimport { DataTransform } from '../scripts/picker.js';\r\nimport { MassEditPresets } from '../scripts/presets/forms.js';\r\nimport { Preset } from '../scripts/presets/preset.js';\r\nimport { applyRandomization, selectRandomizerFields } from '../scripts/randomizer/randomizerUtils.js';\r\nimport { applyDDTint, applyTMFXPreset, getDDTint } from '../scripts/tmfx.js';\r\nimport {\r\n  applyAddSubtract,\r\n  flagCompare,\r\n  getCommonData,\r\n  getData,\r\n  getDocumentName,\r\n  hasFlagRemove,\r\n  localFormat,\r\n  localize,\r\n  mergeObjectPreserveDot,\r\n  MODULE_ID,\r\n  panToFitPlaceables,\r\n  selectAddSubtractFields,\r\n  SUPPORTED_COLLECTIONS,\r\n  SUPPORTED_HISTORY_DOCS,\r\n  SUPPORTED_PLACEABLES,\r\n  wildcardStringMatch,\r\n} from '../scripts/utils.js';\r\nimport { getInUseStyle } from './cssEdit.js';\r\nimport { GeneralDataAdapter, TokenDataAdapter } from './dataAdapters.js';\r\nimport MassEditHistory from './history.js';\r\nimport MacroForm from './macro.js';\r\nimport { SCENE_DOC_MAPPINGS, showMassActorForm, showMassEdit } from './multiConfig.js';\r\n\r\n// ==================================\r\n// ========= Applications ===========\r\n// ==================================\r\n\r\nexport const WithMassEditForm = (cls) => {\r\n  class MassEditForm extends cls {\r\n    constructor(doc, docs, options) {\r\n      super(doc, options);\r\n      this.meObjects = docs;\r\n      this.documentName = options.documentName ?? doc.document?.documentName ?? doc.documentName ?? 'NONE';\r\n      this.commonData = options.commonData || {};\r\n      this.randomizerEnabled = options.massEdit;\r\n      this.massFormButtons = [\r\n        {\r\n          title: localize(`common.apply`),\r\n          value: 'permissions',\r\n          icon: 'far fa-save',\r\n        },\r\n      ];\r\n\r\n      this.randomizeFields = {};\r\n      this.addSubtractFields = {};\r\n      this.meForm = true;\r\n    }\r\n\r\n    async getData(options) {\r\n      // During Preset editing we will be editing AmbientLight document directly, which causes the preview to be set to null\r\n      // and Foundry complaining about being unable to read data from it. So we set the preview manually here\r\n      if (this.documentName === 'AmbientLight' && !this.preview) {\r\n        this.preview = this.meObjects[0].clone();\r\n      }\r\n      const data = super.getData(options);\r\n      return data;\r\n    }\r\n\r\n    // Add styles and controls to the sheet\r\n    async activateListeners(html) {\r\n      await super.activateListeners(html);\r\n      injectVisibility(this);\r\n\r\n      if (SUPPORTED_PLACEABLES.includes(this.documentName) || SUPPORTED_COLLECTIONS.includes(this.documentName))\r\n        this._injectGlobalDeleteButton(html);\r\n\r\n      // Set style\r\n      const [styleName, css] = getInUseStyle();\r\n      $(html).prepend(`<style>${css}</style>`);\r\n\r\n      // On any field being changed we want to automatically select the form-group to be included in the update\r\n      html.on('input', 'textarea, input[type=\"text\"], input[type=\"number\"]', onInputChange.bind(this));\r\n      html.on('change', 'textarea, input, select', onInputChange.bind(this));\r\n      html.on('paste', 'input', onInputChange.bind(this));\r\n      html.on('click', 'button', onInputChange.bind(this));\r\n\r\n      const rangeSpanToTextbox = game.settings.get(MODULE_ID, 'rangeToTextbox');\r\n\r\n      // Attach classes and controls to all relevant form-groups\r\n      const commonData = foundry.utils.flattenObject(this.commonData || {});\r\n      const insertRNGControl = this.randomizerEnabled;\r\n      const processFormGroup = function (formGroup, typeOverride = null) {\r\n        // We only want to attach extra controls if the form-group contains named fields\r\n        if (!$(formGroup).find('[name]').length) return;\r\n        // Return if a checkbox is already inserted\r\n        if ($(formGroup).find('.mass-edit-checkbox').length) return;\r\n        // if ($(formGroup).find('[name]:disabled').length) return;\r\n\r\n        // Check if fields within this form-group are part of common data or control a flag\r\n        let fieldType = 'meCommon';\r\n        if (commonData) {\r\n          $(formGroup)\r\n            .find('[name]')\r\n            .each(function () {\r\n              const name = $(this).attr('name');\r\n\r\n              if (rangeSpanToTextbox && $(this).attr('type') === 'range') {\r\n                const span = $(formGroup).find('span.range-value');\r\n                if (span.length) {\r\n                  span.replaceWith(\r\n                    $(\r\n                      `<input name=\"${name}\" class=\"range-value\" type=\"number\" step=\"any\" value=\"${this.defaultValue}\" min=\"${this.min}\" max=\"${this.max}\"></input>`\r\n                    )\r\n                  );\r\n                  $(this).removeAttr('name');\r\n                }\r\n              }\r\n\r\n              if (name.startsWith('flags.')) {\r\n                fieldType = 'meFlag';\r\n              } else if (!(name in commonData)) {\r\n                // We want to ignore certain fields from commonData checks e.g. light invert-radius\r\n\r\n                if (name === 'invert-radius') {\r\n                } else {\r\n                  fieldType = 'meDiff';\r\n                }\r\n              }\r\n            });\r\n        }\r\n\r\n        // Add randomizer controls\r\n        let randomControl = '';\r\n        if (insertRNGControl) {\r\n          randomControl = '<div class=\"mass-edit-randomize\"></div>';\r\n        }\r\n\r\n        fieldType = typeOverride ?? fieldType;\r\n\r\n        // Insert the checkbox\r\n        const checkbox = $(\r\n          `<div class=\"mass-edit-checkbox ${fieldType}\">${randomControl}<input class=\"mass-edit-control\" type=\"checkbox\" data-dtype=\"Boolean\"}></div>`\r\n        );\r\n        if ($(formGroup).find('p.hint, p.notes').length) {\r\n          $(formGroup).find('p.hint, p.notes').first().before(checkbox);\r\n        } else {\r\n          $(formGroup).append(checkbox);\r\n        }\r\n\r\n        // Assign field type to the form group. Will be used to set appropriate visual look\r\n        $(formGroup).addClass(fieldType);\r\n      };\r\n\r\n      // Add checkboxes to each form-group to control highlighting and which fields are to be saved\r\n      $(html)\r\n        .find('.form-group')\r\n        .each(function (_) {\r\n          processFormGroup(this);\r\n        });\r\n      const context = this;\r\n\r\n      // Register randomize listener if enabled\r\n      if (this.randomizerEnabled) {\r\n        $(html).on('contextmenu', '.mass-edit-checkbox', (event) => {\r\n          import('../scripts/randomizer/randomizerForm.js').then((module) => {\r\n            module.showRandomizeDialog($(event.target).closest('.form-group'), context);\r\n          });\r\n        });\r\n      }\r\n\r\n      // Register numerical input listeners to toggle between subtract, and add modes\r\n      $(html).on(\r\n        'contextmenu',\r\n        'input[type=range], input[type=number], input[name=\"flags.tagger.tags\"], input[type=\"text\"], input[name=\"tokenmagic.preset\"]',\r\n        (event) => {\r\n          const name = event.target.name;\r\n          if (!name) return;\r\n\r\n          const input = $(event.target);\r\n          if (name in this.addSubtractFields) {\r\n            if (this.addSubtractFields[name].method === 'add') {\r\n              this.addSubtractFields[name].method = 'subtract';\r\n              input.removeClass('me-add').addClass('me-subtract');\r\n              input.attr('title', '- Subtracting');\r\n              const ctrl = { method: 'subtract' };\r\n              if (event.target.min) {\r\n                ctrl.min = parseFloat(event.target.min);\r\n              }\r\n              ctrl.type = input.attr('type');\r\n              this.addSubtractFields[name] = ctrl;\r\n            } else {\r\n              delete this.addSubtractFields[name];\r\n              input.removeClass('me-subtract');\r\n              input.attr('title', '');\r\n            }\r\n          } else {\r\n            input.addClass('me-add');\r\n            input.attr('title', '+ Adding');\r\n            const ctrl = { method: 'add' };\r\n            if (event.target.max) {\r\n              ctrl.max = parseFloat(event.target.max);\r\n            }\r\n            ctrl.type = input.attr('type');\r\n            this.addSubtractFields[name] = ctrl;\r\n          }\r\n\r\n          // Select nearest mass edit checkbox\r\n          onInputChange(event);\r\n\r\n          // Make brush aware of add/subtract changes\r\n          Brush.refreshPreset();\r\n        }\r\n      );\r\n\r\n      // Remove all buttons in the footer\r\n      $(html).find('.sheet-footer > button').remove();\r\n\r\n      // Special handling for Walls sheet\r\n      $(html).find('button[type=\"submit\"]').remove();\r\n\r\n      // Add submit buttons\r\n      let htmlButtons = '';\r\n      if (!this._meSubmitInserted) {\r\n        this._meSubmitInserted = true;\r\n        for (const button of this.massFormButtons) {\r\n          htmlButtons += `<button class=\"me-submit\" type=\"submit\" value=\"${button.value}\"><i class=\"${button.icon}\"></i> ${button.title}</button>`;\r\n          // Auto update control\r\n          if (this.options.massEdit && !this.options.simplified && !this.options.presetEdit)\r\n            htmlButtons += `<div class=\"me-mod-update\" title=\"${localize(\r\n              `form.immediate-update-title`\r\n            )}\"><input type=\"checkbox\" data-submit=\"${button.value}\"><i class=\"fas fa-cogs\"></i></div>`;\r\n        }\r\n        if (this.options.massSelect && SUPPORTED_PLACEABLES.includes(this.documentName)) {\r\n          htmlButtons += `<div class=\"me-mod-update\" title=\"${localize(\r\n            `form.global-search-title`\r\n          )}\"><input type=\"checkbox\" data-submit=\"world\"><i class=\"far fa-globe\"></i></div>`;\r\n        }\r\n\r\n        let footer = $(html).find('.sheet-footer').last();\r\n        if (footer.length) {\r\n          footer.append(htmlButtons);\r\n        } else {\r\n          footer = $(`<footer class=\"sheet-footer flexrow\">${htmlButtons}</footer>`);\r\n          $(html).closest('form').append(footer);\r\n        }\r\n\r\n        // Auto update listeners\r\n        footer.find('.me-mod-update > input').on('change', (event) => {\r\n          event.stopPropagation();\r\n          const isChecked = event.target.checked;\r\n          footer.find('.me-mod-update > input').not(this).prop('checked', false);\r\n          $(event.target).prop('checked', isChecked);\r\n          this.modUpdate = isChecked;\r\n          this.modUpdateType = event.target.dataset?.submit;\r\n        });\r\n      }\r\n\r\n      if (this.options.inputChangeCallback) {\r\n        html.on('change', 'input, select', async (event) => {\r\n          setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n        });\r\n      }\r\n\r\n      // Select/Deselect all Mass Edit checkboxes when right-clicking the navigation tabs\r\n      html.on('contextmenu', 'nav > .item', (event) => {\r\n        const tab = event.target.dataset?.tab;\r\n        if (tab) {\r\n          const group = $(event.target).closest('nav').attr('data-group');\r\n          let meCheckboxes;\r\n          if (group) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(\r\n                `.tab[data-tab=\"${tab}\"][data-group=\"${group}\"], .matt-tab[data-tab=\"${tab}\"][data-group=\"${group}\"]`\r\n              )\r\n              .find('.mass-edit-control');\r\n          }\r\n          if (!meCheckboxes || meCheckboxes.length === 0) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(`.tab[data-tab=\"${tab}\"], .matt-tab[data-tab=\"${tab}\"]`)\r\n              .find('.mass-edit-control');\r\n          }\r\n\r\n          let selecting = true;\r\n\r\n          if (meCheckboxes.not(':checked').length === 0) {\r\n            selecting = false;\r\n          }\r\n          meCheckboxes.prop('checked', selecting);\r\n\r\n          // Select/Deselect tabs\r\n          meCheckboxes.each(function () {\r\n            if (selecting) selectTabs(this);\r\n            else deselectTabs(this);\r\n          });\r\n\r\n          // Trigger change on one of the checkboxes to initiate processes that respond to them\r\n          // being toggled\r\n          meCheckboxes.first().trigger('change');\r\n        }\r\n      });\r\n\r\n      // =====================\r\n      // Module specific logic\r\n      // =====================\r\n\r\n      // Monk's Active Tiles\r\n      if (this.documentName === 'Tile' && this._createAction) {\r\n        let chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>Mass Edit: ${localize(`form.actions`)}</label>\r\n            <div class=\"form-fields\">\r\n                <input type=\"hidden\" name=\"flags.monks-active-tiles.actions\">\r\n            </div>\r\n          `);\r\n        $(html).find('.matt-tab[data-tab=\"trigger-actions\"]').prepend(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n\r\n        chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>Mass Edit: ${localize(`form.images`)}</label>\r\n            <div class=\"form-fields\">\r\n                <input type=\"hidden\" name=\"flags.monks-active-tiles.files\">\r\n            </div>\r\n          `);\r\n        chk.insertBefore('.matt-tab[data-tab=\"trigger-images\"] .files-list');\r\n        processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ((this.documentName === 'Tile' || this.documentName === 'Token') && game.Levels3DPreview) {\r\n        let chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>Mass Edit: ${localize(`form.shaders`)}</label>\r\n            <div class=\"form-fields\">\r\n                <input type=\"hidden\" name=\"flags.levels-3d-preview.shaders\">\r\n            </div>\r\n          `);\r\n        $(html).find('#shader-config').after(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n      }\r\n      //\r\n\r\n      // =====================\r\n      // = Additional Fields =\r\n      // =====================\r\n\r\n      // // Token Magic FX\r\n      if (\r\n        (this.documentName === 'Tile' || this.documentName === 'Token') &&\r\n        !this.options?.simplified &&\r\n        game.modules.get('tokenmagic')?.active &&\r\n        game.settings.get(MODULE_ID, 'tmfxFieldsEnable')\r\n      ) {\r\n        let content = '<datalist id=\"tmfxPresets\"><option value=\"DELETE ALL\">';\r\n        TokenMagic.getPresets().forEach((p) => (content += `<option value=\"${p.name}\">`));\r\n        content += `</datalist><input list=\"tmfxPresets\" name=\"tokenmagic.preset\">`;\r\n\r\n        let chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>${localize('common.preset')} <span class=\"units\">(TMFX)</span></label>\r\n            <div class=\"form-fields\">\r\n              ${content}\r\n            </div>\r\n          `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n\r\n        const currentDDTint = getDDTint(this.object.object ?? this.object);\r\n        chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>DungeonDraft <span class=\"units\">(TMFX)</span></label>\r\n            <div class=\"form-fields\">\r\n              <input class=\"color\" type=\"text\" name=\"tokenmagic.ddTint\" value=\"${currentDDTint}\">\r\n              <input type=\"color\" value=\"${currentDDTint}\" data-edit=\"tokenmagic.ddTint\">\r\n            </div>\r\n          `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      if (this.documentName === 'Tile') {\r\n        let scaleInput = $(`\r\n        <div class=\"form-group slim\">\r\n          <label>${localize('Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n          <div class=\"form-fields\">\r\n            <label>${localize('Width', false)} | ${localize('Height', false)} ${\r\n          game.Levels3DPreview?._active ? '| Depth' : ''\r\n        }</label>\r\n            <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.scale\" min=\"0\">\r\n          </div>\r\n        </div>`);\r\n        $(html).find('[name=\"width\"]').closest('.form-group').before(scaleInput);\r\n        processFormGroup(scaleInput, 'meInsert');\r\n\r\n        scaleInput = $(`\r\n          <div class=\"form-group slim\">\r\n            <label>${localize('TILE.Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n            <div class=\"form-fields\">\r\n              <label>${localize('TILE.ScaleX', false)} | ${localize('TILE.ScaleY', false)}</label>\r\n              <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.texture.scale\" min=\"0\">\r\n            </div>\r\n          </div>`);\r\n        $(html).find('[name=\"texture.scaleX\"]').closest('.form-group').before(scaleInput);\r\n        processFormGroup(scaleInput, 'meInsert');\r\n      }\r\n\r\n      // Resizes the window\r\n      this.setPosition();\r\n      this.element[0].style.height = ''; // don't want a statically set height\r\n\r\n      // TokenConfig might be changed by some modules after activateListeners is processed\r\n      // Look out for these updates and add checkboxes for any newly added form-groups\r\n      const mutate = (mutations) => {\r\n        mutations.forEach((mutation) => {\r\n          mutation.addedNodes.forEach((node) => {\r\n            if ($(node).hasClass('form-group')) {\r\n              processFormGroup(node);\r\n            } else {\r\n              $(node)\r\n                .find('.form-group')\r\n                .each(function () {\r\n                  if (!$(this).find('.mass-edit-checkbox').length) {\r\n                    processFormGroup(this);\r\n                  }\r\n                });\r\n            }\r\n          });\r\n        });\r\n      };\r\n\r\n      const observer = new MutationObserver(mutate);\r\n      observer.observe(html[0], {\r\n        characterData: false,\r\n        attributes: false,\r\n        childList: true,\r\n        subtree: true,\r\n      });\r\n\r\n      if (this.documentName === 'Token') {\r\n        $(html)\r\n          .find('fieldset.detection-mode')\r\n          .each(function (_) {\r\n            $(this).wrap('<div class=\"form-group\"></div>');\r\n          });\r\n      }\r\n\r\n      // Inject Flags tab\r\n      injectFlagTab(this);\r\n    }\r\n\r\n    getSelectedFields(formData) {\r\n      if (!formData) formData = this._getSubmitData();\r\n\r\n      // Some module flags get un-flattened\r\n      // Flatten them again before attempting to find selected\r\n      formData = foundry.utils.flattenObject(formData);\r\n\r\n      // Modules Specific Logic\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in formData) {\r\n        formData['flags.levels-3d-preview.shaders'] = this.object.getFlag('levels-3d-preview', 'shaders');\r\n      }\r\n      // == End of Module specific logic\r\n\r\n      // Token _getSubmitData() performs conversions related to scale, we need to undo them here\r\n      // so that named fields on the form match up and can be selected\r\n      if (this.documentName === 'Token') {\r\n        if (formData['texture.scaleX']) {\r\n          formData.scale = Math.abs(formData['texture.scaleX']);\r\n          formData.mirrorX = formData['texture.scaleX'] < 0;\r\n          formData.mirrorY = formData['texture.scaleY'] < 0;\r\n        }\r\n      } else if (this.documentName === 'Note') {\r\n        if (formData['texture.src']) {\r\n          formData['icon.selected'] = formData['texture.src'];\r\n          formData['icon.custom'] = formData['texture.src'];\r\n        }\r\n      }\r\n\r\n      const selectedFields = {};\r\n      const form = $(this.form);\r\n      const addSubtractFields = this.addSubtractFields;\r\n      const app = this;\r\n\r\n      form.find('.form-group').each(function (_) {\r\n        const me_checkbox = $(this).find('.mass-edit-checkbox > input');\r\n        if (me_checkbox.length && me_checkbox.is(':checked')) {\r\n          $(this)\r\n            .find('[name]')\r\n            .each(function (_) {\r\n              const name = $(this).attr('name');\r\n\r\n              // Module specific logic\r\n              if (name === 'flags.limits') {\r\n                const limits = foundry.utils.flattenObject(app.object.toObject().flags['limits'] ?? {});\r\n                for (const [k, v] of Object.entries(limits)) {\r\n                  selectedFields['flags.limits.' + k] = v;\r\n                }\r\n              }\r\n              // == End of Module specific logic\r\n\r\n              // Some modules will process their flags to remove them using -= notation\r\n              // Need to account for this when selecting fields\r\n              if (formData[name] === undefined && name.startsWith('flags.')) {\r\n                const removeFlag = hasFlagRemove(name, formData);\r\n                if (removeFlag) {\r\n                  selectedFields[removeFlag] = null;\r\n                }\r\n              } else {\r\n                selectedFields[name] = formData[name];\r\n                if (name in addSubtractFields) {\r\n                  addSubtractFields[name].value = formData[name];\r\n                }\r\n              }\r\n\r\n              if (foundry.utils.getType(selectedFields[name]) === 'string') {\r\n                const input = $(this);\r\n                if (input.hasClass('tva-array')) {\r\n                  if (v.trim()) {\r\n                    selectedFields[name] = selectedFields[name]\r\n                      .trim()\r\n                      .split(',')\r\n                      .map((s) => s.trim());\r\n                  } else {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                } else if (input.hasClass('tva-jsonArray')) {\r\n                  try {\r\n                    selectedFields[name] = JSON.parse(selectedFields[name]);\r\n                  } catch (e) {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                }\r\n              }\r\n            });\r\n        }\r\n      });\r\n\r\n      // // Module specific logic\r\n      // if (game.modules.get('barbrawl')?.active) {\r\n      //   for (const [k, v] of Object.entries(selectedFields)) {\r\n      //     if (k.startsWith('flags.barbrawl')) {\r\n      //       let details = form.find(`[name=\"${k}\"]`).closest('.indent-details');\r\n      //       let id = details.attr('id');\r\n      //       if (id) selectedFields[`flags.barbrawl.resourceBars.${id}.id`] = id;\r\n      //     }\r\n      //   }\r\n      // }\r\n      // // End of Module specific logic\r\n\r\n      return selectedFields;\r\n    }\r\n\r\n    // Overriding here to prevent the underlying object from being updated as inputs change on the form\r\n    // Relevant for AmbientLight, Tile, and Token sheets\r\n    async _onChangeInput(event) {\r\n      if (!['AmbientLight', 'Tile', 'Token'].includes(this.documentName)) {\r\n        super._onChangeInput(event);\r\n        return;\r\n      }\r\n\r\n      // // Handle form element updates\r\n      const el = event.target;\r\n      if (el.type === 'color' && el.dataset.edit) this._onChangeColorPicker(event);\r\n      else if (el.type === 'range') this._onChangeRange(event);\r\n    }\r\n\r\n    _getHeaderButtons() {\r\n      let buttons = super._getHeaderButtons();\r\n      return buttons.filter((b) => b.class !== 'configure-sheet');\r\n    }\r\n\r\n    _injectGlobalDeleteButton(html) {\r\n      const control = $(\r\n        `<div class=\"me-global-delete\"><a title=\"${localize(\r\n          'form.global-delete-title'\r\n        )}\"><i class=\"far fa-times-octagon fa-2x\"></i></a></div>`\r\n      );\r\n      control.click((event) => {\r\n        new Dialog({\r\n          title: 'Confirm',\r\n          content: `\r\n          <h2 style=\"color: red; text-align: center;\">${localFormat('form.delete-warning', {\r\n            count: this.meObjects.length,\r\n            document: this.documentName,\r\n          })}</h2>\r\n          <p>${localize('form.proceed')}</p>`,\r\n          buttons: {\r\n            buttonA: {\r\n              label: localize('Yes', false),\r\n              callback: () => {\r\n                this.meObjects.forEach((obj) => {\r\n                  let doc = obj.document ?? obj;\r\n                  if (doc.delete) doc.delete();\r\n                });\r\n                this.close();\r\n              },\r\n            },\r\n            no: {\r\n              label: localize('No', false),\r\n            },\r\n          },\r\n          default: 'buttonA',\r\n        }).render(true);\r\n      });\r\n      html.closest('form').append(control);\r\n    }\r\n  }\r\n\r\n  return MassEditForm;\r\n};\r\n\r\nexport const WithMassConfig = (docName = 'NONE') => {\r\n  let cls;\r\n  const sheets = CONFIG[docName]?.sheetClasses;\r\n  if (!sheets || docName === 'Actor') {\r\n    cls = FormApplication;\r\n\r\n    cls = FormApplication;\r\n  } else {\r\n    cls = Object.values(Object.values(sheets).pop() ?? {}).pop()?.cls;\r\n  }\r\n\r\n  const MEF = WithMassEditForm(cls);\r\n\r\n  class MassConfig extends MEF {\r\n    constructor(target, docs, options) {\r\n      if (options.massSelect) options.randomizerEnabled = false;\r\n      const docName = options.documentName ?? getDocumentName(target);\r\n      if (!options.commonData) options.commonData = getCommonDocData(docs, docName);\r\n\r\n      super(target.document ? target.document : target, docs, options);\r\n      this.docName = docName;\r\n\r\n      // Add submit buttons\r\n      let buttons = [];\r\n      if (this.options.massSelect) {\r\n        buttons = [\r\n          { title: localize('FILES.Search', false), value: 'search', icon: 'fas fa-search' },\r\n          { title: localize('form.search-and-edit'), value: 'searchAndEdit', icon: 'fas fa-search' },\r\n        ];\r\n      } else if (this.documentName === 'Note' && !this.options.presetEdit) {\r\n        // If we're editing notes and there are some on a different scene\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id === canvas.scene.id).length) {\r\n          buttons.push({\r\n            title: localize('form.apply-on-current-scene'),\r\n            value: 'currentScene',\r\n            icon: 'far fa-save',\r\n          });\r\n        }\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id !== canvas.scene.id).length) {\r\n          buttons.push({\r\n            title: localize('form.apply-on-all-scenes'),\r\n            value: 'allScenes',\r\n            icon: 'fas fa-globe',\r\n          });\r\n        }\r\n      } else {\r\n        buttons = [{ title: localize('common.apply'), value: 'apply', icon: 'far fa-save' }];\r\n        // Extra control for Tokens to update their Actors Token prototype\r\n        if (\r\n          this.documentName === 'Token' &&\r\n          !this.options.simplified &&\r\n          !this.meObjects[0].constructor?.name?.startsWith('PrototypeToken') &&\r\n          !this.options.presetEdit\r\n        ) {\r\n          buttons.push({\r\n            title: localize('form.apply-update-proto'),\r\n            value: 'applyToPrototype',\r\n            icon: 'far fa-save',\r\n          });\r\n        }\r\n      }\r\n\r\n      this.massFormButtons = buttons;\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      await this.massUpdateObject(event, formData);\r\n\r\n      // On v11 certain placeable will freeze the canvas layer if parent _updateObject is not called\r\n      if (['Token', 'AmbientLight'].includes(this.docName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n    }\r\n\r\n    async massUpdateObject(event, formData) {\r\n      if (!event.submitter?.value) return;\r\n\r\n      // Gather up all named fields that have mass-edit-checkbox checked\r\n      const selectedFields = this.getSelectedFields(formData);\r\n\r\n      // Detection modes may have been selected out of order\r\n      // Fix that here\r\n      if (this.docName === 'Token') {\r\n        TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n      }\r\n\r\n      // Preset editing\r\n      if (this.options.presetEdit) {\r\n        this.options.callback?.({\r\n          data: selectedFields,\r\n          addSubtract: this.addSubtractFields,\r\n          randomize: this.randomizeFields,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Search and Select mode\r\n      if (this.options.massSelect) {\r\n        return performMassSearch(event.submitter.value, this.docName, selectedFields, {\r\n          scope: this.modUpdate ? this.modUpdateType : null,\r\n        });\r\n      } else {\r\n        // Edit mode\r\n        return performMassUpdate.call(this, selectedFields, this.meObjects, this.docName, event.submitter.value);\r\n      }\r\n    }\r\n\r\n    _performOnInputChangeUpdate() {\r\n      const selectedFields = this.getSelectedFields();\r\n      performMassUpdate.call(this, selectedFields, this.meObjects, this.docName, this.modUpdateType);\r\n    }\r\n\r\n    /**\r\n     * Copy currently selected field to the clipboard\r\n     */\r\n    performMassCopy({ command = '', selectedFields = null } = {}) {\r\n      if (!selectedFields) {\r\n        selectedFields = this.getSelectedFields();\r\n        if (this.documentName === 'Token') {\r\n          TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n        }\r\n      }\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return false;\r\n\r\n      const preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: selectedFields,\r\n        randomize: this.randomizeFields,\r\n        addSubtract: this.addSubtractFields,\r\n      });\r\n\r\n      copyToClipboard(preset, command, this.isPrototype);\r\n      return true;\r\n    }\r\n\r\n    _getHeaderButtons() {\r\n      const buttons = super._getHeaderButtons();\r\n      if (this.options.presetEdit) return buttons;\r\n\r\n      // Macro Generator\r\n      if (SUPPORTED_PLACEABLES.includes(this.docName) || SUPPORTED_COLLECTIONS.includes(this.docName)) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-macro',\r\n          icon: 'fas fa-terminal',\r\n          onclick: () => {\r\n            const selectedFields = this.getSelectedFields();\r\n            new MacroForm(\r\n              this.object,\r\n              this.meObjects,\r\n              this.docName,\r\n              selectedFields,\r\n              this.randomizeFields,\r\n              this.addSubtractFields\r\n            ).render(true);\r\n          },\r\n        });\r\n      }\r\n\r\n      // Brush Tool\r\n      if (SUPPORTED_PLACEABLES.includes(this.docName)) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-brush',\r\n          icon: 'fas fa-paint-brush',\r\n          onclick: () => {\r\n            Brush.activate({ app: this });\r\n          },\r\n        });\r\n      }\r\n\r\n      // Edit Permissions\r\n      if (['Token', 'Note', 'Actor'].includes(this.docName)) {\r\n        let docs = [];\r\n        const ids = new Set();\r\n        for (const p of this.meObjects) {\r\n          let d;\r\n          if (this.docName === 'Actor' || this.docName === 'JournalEntry') d = p;\r\n          else if (this.docName === 'Token' && p.actor) d = p.actor;\r\n          else if (this.docName === 'Note' && p.entry) d = p.entry;\r\n\r\n          // Only retain unique docs\r\n          if (d && !ids.has(d.id)) {\r\n            docs.push(d);\r\n            ids.add(d.id);\r\n          }\r\n        }\r\n\r\n        if (docs.length)\r\n          buttons.unshift({\r\n            label: '',\r\n            class: 'mass-edit-permissions',\r\n            icon: 'fas fa-lock fa-fw',\r\n            onclick: () => {\r\n              let MP = WithMassPermissions();\r\n              new MP(docs[0], docs).render(true);\r\n            },\r\n          });\r\n      }\r\n\r\n      if (!this.options.simplified) {\r\n        // Open Preset form\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-presets',\r\n          icon: 'fas fa-box',\r\n          onclick: () => {\r\n            this.linkedPresetForm = new MassEditPresets(this, null, this.docName, {\r\n              left: this.position.left - 370,\r\n              top: this.position.top,\r\n              preventPositionOverride: true,\r\n            });\r\n            this.linkedPresetForm.render(true);\r\n          },\r\n        });\r\n      }\r\n\r\n      // Apply JSON data onto the form\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-apply',\r\n        icon: 'far fa-money-check-edit',\r\n        onclick: (ev) => {\r\n          let selFields = expandObject(this.getSelectedFields());\r\n          if (foundry.utils.isEmpty(selFields)) selFields = '';\r\n          else selFields = JSON.stringify(selFields, null, 2);\r\n          let content = `<textarea class=\"json\" style=\"width:100%; height: 300px;\">${selFields}</textarea>`;\r\n          new Dialog({\r\n            title: localize('form.apply-json'),\r\n            content: content,\r\n            buttons: {\r\n              apply: {\r\n                label: localize('common.apply'),\r\n                callback: (html) => {\r\n                  let json = {};\r\n                  try {\r\n                    json = JSON.parse(html.find('.json').val());\r\n                  } catch (e) {}\r\n\r\n                  if (!foundry.utils.isEmpty(json)) {\r\n                    const preset = new Preset({\r\n                      documentName: this.docName,\r\n                      data: foundry.utils.flattenObject(json),\r\n                    });\r\n                    this._processPreset(preset);\r\n                  }\r\n                },\r\n              },\r\n            },\r\n          }).render(true);\r\n        },\r\n      });\r\n\r\n      // History\r\n      if (game.settings.get(MODULE_ID, 'enableHistory') && SUPPORTED_HISTORY_DOCS.includes(this.docName)) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-history',\r\n          icon: 'fas fa-history',\r\n          onclick: () => {\r\n            new MassEditHistory(this.docName, async (preset) => this._processPreset(preset)).render(true);\r\n          },\r\n        });\r\n      }\r\n\r\n      // Toggle between Token and Actor forms\r\n      if (this.documentName === 'Token' && this.meObjects.filter((t) => t.actor).length) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-actors',\r\n          icon: 'fas fa-user',\r\n          onclick: () => {\r\n            if (\r\n              showMassActorForm(this.meObjects, {\r\n                massEdit: this.options.massEdit,\r\n              })\r\n            ) {\r\n              this.close();\r\n            }\r\n          },\r\n        });\r\n      }\r\n\r\n      return buttons;\r\n    }\r\n\r\n    async activateListeners(html) {\r\n      await super.activateListeners(html);\r\n      // We want to update fields used by brush control every time a field changes on the form\r\n      html.on('input', 'textarea, input[type=\"text\"], input[type=\"number\"]', () => Brush.refreshPreset());\r\n      html.on('change', 'textarea, input, select', () => Brush.refreshPreset());\r\n      html.on('paste', 'input', () => Brush.refreshPreset());\r\n      html.on('click', 'button', () => Brush.refreshPreset());\r\n    }\r\n\r\n    async close(options = {}) {\r\n      Brush.deactivate();\r\n      options.force = true;\r\n\r\n      if (['Token', 'AmbientLight'].includes(this.docName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n      if (this.linkedPresetForm) this.linkedPresetForm.close();\r\n      return super.close(options);\r\n    }\r\n\r\n    // Some forms will manipulate themselves via modifying internal objects and re-rendering\r\n    // In such cases we want to preserve the selected fields\r\n    render(force, options = {}) {\r\n      // If it's being re-rendered with an action \"update\" in means it's ClientDocumentMixin response to _onUpdate\r\n      // We can ignore these\r\n      if (options.action === 'update') return;\r\n      // Form hasn't been rendered yet, aka first render pass, ignore it\r\n      if (!this.form) return super.render(force, options);\r\n\r\n      // Fetch the currently selected fields before re-rendering\r\n      const selectedFields = this.getSelectedFields();\r\n      const randomize = this.randomizeFields;\r\n      const addSubtract = this.addSubtractFields;\r\n\r\n      // Render, the selections will be wiped\r\n      super.render(force, options);\r\n\r\n      // Re-select fields, we're reusing preset functions here.\r\n      // Timeout require for this module including others to apply their\r\n      // modifications to the configuration window\r\n      setTimeout(() => {\r\n        if (this.form) {\r\n          this._applyPreset(\r\n            new Preset({\r\n              data: selectedFields,\r\n              randomize,\r\n              addSubtract,\r\n            })\r\n          );\r\n        }\r\n      }, 1000);\r\n    }\r\n\r\n    async _processPreset(preset) {\r\n      // This will be called when a preset or history item is selected or JSON data is being directly applied\r\n      // The code bellow handles it being applied to the current form\r\n\r\n      // =====================\r\n      // Module specific logic\r\n      // =====================\r\n      let timeoutRequired = false;\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n      // Monk's Active Tiles\r\n      if ('flags.monks-active-tiles.actions' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.setFlag('monks-active-tiles', 'actions', data['flags.monks-active-tiles.actions']);\r\n      }\r\n\r\n      if ('flags.monks-active-tiles.files' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.setFlag('monks-active-tiles', 'files', data['flags.monks-active-tiles.files']);\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.setFlag('levels-3d-preview', 'shaders', data['flags.levels-3d-preview.shaders']);\r\n      }\r\n\r\n      // Limits\r\n      if ('flags.limits.light.enabled' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.update({ flags: { limits: expandObject(data).flags.limits } });\r\n      }\r\n\r\n      if (this.documentName === 'Token') {\r\n        timeoutRequired = TokenDataAdapter.modifyPresetData(this, data);\r\n      }\r\n\r\n      if (timeoutRequired) {\r\n        setTimeout(() => {\r\n          this._applyPreset(preset);\r\n        }, 250);\r\n        return;\r\n      }\r\n\r\n      this._applyPreset(preset);\r\n    }\r\n\r\n    _applyPreset(preset) {\r\n      const form = $(this.form);\r\n\r\n      const customMerge = (obj1, obj2) => {\r\n        if (!obj2) return obj1;\r\n        for (const [k, v] of Object.entries(obj2)) {\r\n          obj1[k] = v;\r\n        }\r\n        return obj1;\r\n      };\r\n\r\n      this.randomizeFields = customMerge(this.randomizeFields, preset.randomize);\r\n      this.addSubtractFields = customMerge(this.addSubtractFields, preset.addSubtract);\r\n      selectRandomizerFields(form, this.randomizeFields);\r\n      selectAddSubtractFields(form, this.addSubtractFields);\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n      GeneralDataAdapter.dataToForm(this.documentName, preset.data[0], data);\r\n      for (const key of Object.keys(data)) {\r\n        const el = form.find(`[name=\"${key}\"]`);\r\n        if (el.is(':checkbox')) {\r\n          el.prop('checked', data[key]);\r\n        } else {\r\n          el.val(data[key]);\r\n        }\r\n        el.trigger('change');\r\n      }\r\n\r\n      // Make brush aware of randomized field changes\r\n      Brush.refreshPreset();\r\n    }\r\n\r\n    get title() {\r\n      if (this.options.massSelect) return localFormat('form.mass-search-title', { document: this.documentName });\r\n      return localFormat('form.mass-edit-title', { document: this.documentName, count: this.meObjects.length });\r\n    }\r\n  }\r\n\r\n  const constructorName = `Mass${docName}Config`;\r\n  Object.defineProperty(MassConfig.prototype.constructor, 'name', { value: constructorName });\r\n  return MassConfig;\r\n};\r\n\r\n// ====================\r\n// ===== UTILS ========\r\n// ====================\r\n\r\n/**\r\n *\r\n * @param {Document} docs\r\n * @param {Preset} preset\r\n * @param {boolean} suppressNotif\r\n * @returns\r\n */\r\nexport function pasteDataUpdate(docs, preset, suppressNotif = false, excludePosition = false, transform = null) {\r\n  if (!docs || !docs.length) return false;\r\n\r\n  let docName = docs[0].document ? docs[0].document.documentName : docs[0].documentName;\r\n\r\n  preset = preset ?? getClipboardData(docName);\r\n  let applyType;\r\n\r\n  // Special handling for Tokens/Actors\r\n  if (!preset) {\r\n    if (docName === 'Token') {\r\n      if (!preset) {\r\n        preset = getClipboardData('TokenProto');\r\n        applyType = 'applyToPrototype';\r\n      }\r\n\r\n      if (!preset) {\r\n        preset = getClipboardData('Actor');\r\n        docName = 'Actor';\r\n        docs = docs.filter((d) => d.actor).map((d) => d.actor);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (preset) {\r\n    if (preset.documentName !== docName) return;\r\n\r\n    const context = { meObjects: docs };\r\n    if (!foundry.utils.isEmpty(preset.randomize)) context.randomizeFields = preset.randomize;\r\n    if (!foundry.utils.isEmpty(preset.addSubtract)) context.addSubtractFields = preset.addSubtract;\r\n\r\n    let data = foundry.utils.deepClone(preset.data[Math.floor(Math.random() * preset.data.length)]);\r\n    if (transform) DataTransform.apply(docName, data, { x: 0, y: 0 }, transform);\r\n    if (excludePosition) {\r\n      delete data.x;\r\n      delete data.y;\r\n      delete data.c;\r\n    }\r\n\r\n    performMassUpdate.call(context, foundry.utils.flattenObject(data), docs, preset.documentName, applyType);\r\n    if (!suppressNotif)\r\n      ui.notifications.info(\r\n        localFormat('clipboard.paste', {\r\n          document: preset.documentName,\r\n          count: docs.length,\r\n        })\r\n      );\r\n\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function performMassSearch(\r\n  command,\r\n  docName,\r\n  selectedFields,\r\n  { scope = null, selected = null, control = true, pan = true } = {}\r\n) {\r\n  const found = [];\r\n\r\n  if (scope === 'selected') {\r\n    performDocSearch(selected, docName, selectedFields, found);\r\n  } else if (SUPPORTED_COLLECTIONS.includes(docName)) {\r\n    performDocSearch(Array.from(game.collections.get(docName)), docName, selectedFields, found);\r\n  } else {\r\n    let scenes = [];\r\n    if (scope === 'world') scenes = Array.from(game.scenes);\r\n    else if (canvas.scene) scenes = [canvas.scene];\r\n\r\n    for (const scene of scenes) {\r\n      performMassSearchScene(scene, docName, selectedFields, found);\r\n    }\r\n  }\r\n\r\n  // Select found placeables/documents\r\n  if (control) {\r\n    // First release/de-select the currently selected placeable on the current scene\r\n    canvas.activeLayer.controlled.map((c) => c).forEach((c) => c.release());\r\n\r\n    setTimeout(() => {\r\n      found.forEach((f) => {\r\n        let obj = f.object ?? f;\r\n        if (obj.control) obj.control({ releaseOthers: false });\r\n      });\r\n\r\n      if (pan && found.length && game.settings.get(MODULE_ID, 'panToSearch')) {\r\n        panToFitPlaceables(found);\r\n      }\r\n    }, 100);\r\n  }\r\n  if (command === 'searchAndEdit') {\r\n    setTimeout(() => {\r\n      showMassEdit(found, docName);\r\n    }, 500);\r\n  }\r\n  return found;\r\n}\r\n\r\nfunction performMassSearchScene(scene, docName, selectedFields, found) {\r\n  const docs = Array.from(scene[SCENE_DOC_MAPPINGS[docName]]);\r\n  performDocSearch(docs, docName, selectedFields, found);\r\n}\r\n\r\nfunction performDocSearch(docs, docName, selectedFields, found) {\r\n  // Next select objects that match the selected fields\r\n  for (const c of docs) {\r\n    let matches = true;\r\n    const data = foundry.utils.flattenObject(getData(c).toObject());\r\n\r\n    // Special processing for some placeable types\r\n    // Necessary when form data is not directly mappable to placeable\r\n    GeneralDataAdapter.dataToForm(docName, c, data);\r\n\r\n    for (const [k, v] of Object.entries(selectedFields)) {\r\n      // Special handling for flags\r\n      if (k.startsWith('flags.')) {\r\n        if (!flagCompare(data, k, v)) {\r\n          matches = false;\r\n          break;\r\n        }\r\n        // Special handling for empty strings and undefined\r\n      } else if ((v === '' || v == null) && (data[k] !== '' || data[k] != null)) {\r\n        // matches\r\n      } else if (typeof v === 'string' && v.includes('*') && wildcardStringMatch(v, data[k])) {\r\n        // Wildcard matched\r\n      } else if (data[k] != v) {\r\n        // Detection mode keys cannot be treated in isolation\r\n        // We skip them here and will check them later\r\n        if (docName === 'Token') {\r\n          if (k.startsWith('detectionModes')) {\r\n            continue;\r\n          }\r\n        }\r\n\r\n        matches = false;\r\n        break;\r\n      }\r\n    }\r\n    if (matches) {\r\n      // We skipped detectionMode matching in the previous step and do it now instead\r\n      if (docName === 'Token') {\r\n        const modes = Object.values(foundry.utils.expandObject(selectedFields)?.detectionModes || {});\r\n\r\n        if (!TokenDataAdapter.detectionModeMatch(modes, c.detectionModes)) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      found.push(c);\r\n    }\r\n  }\r\n}\r\n\r\nexport async function performMassUpdate(data, objects, docName, applyType) {\r\n  // Used by GenericForms, we want just the data, and no updates\r\n  if (this.options?.simplified) {\r\n    if (this.options.callback) this.options.callback(data);\r\n    return;\r\n  }\r\n  if (foundry.utils.isEmpty(data)) {\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Make sure we're working with documents and not placeables\r\n  objects = objects.map((o) => o.document ?? o);\r\n\r\n  // Update docs\r\n  const updates = [];\r\n  const context = {};\r\n\r\n  const total = objects.length;\r\n  for (let i = 0; i < total; i++) {\r\n    const update = foundry.utils.deepClone(data);\r\n    update._id = objects[i].id;\r\n\r\n    // push update\r\n    updates.push(update);\r\n  }\r\n\r\n  // If history is enabled we'll want to attach additional controls to the updates\r\n  // so that they can be tracked.\r\n  if (game.settings.get(MODULE_ID, 'enableHistory')) {\r\n    context['mass-edit-randomize'] = [foundry.utils.deepClone(this.randomizeFields)];\r\n    context['mass-edit-addSubtract'] = [foundry.utils.deepClone(this.addSubtractFields)];\r\n  }\r\n\r\n  // Applies randomization\r\n  if (this) await applyRandomization(updates, objects, this.randomizeFields);\r\n  if (this) applyAddSubtract(updates, objects, docName, this.addSubtractFields);\r\n\r\n  // Necessary when form data is not directly mappable to placeable\r\n  for (let i = 0; i < total; i++) {\r\n    GeneralDataAdapter.formToData(docName, objects[i], updates[i]);\r\n  }\r\n\r\n  await checkApplySpecialFields(docName, updates, objects);\r\n\r\n  if (docName === 'Actor') {\r\n    // Perform Updates\r\n    // There is a lot of wonkiness related to updating of real/synthetic actors. It's probably best\r\n    // to simply update the Actors directly\r\n\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      if (this.options?.tokens) this.options.tokens[i].actor.update(update);\r\n      else objects[i].update(update);\r\n    }\r\n  } else if (docName === 'Scene') {\r\n    Scene.updateDocuments(updates, context);\r\n  } else if (docName === 'PlaylistSound') {\r\n    for (let i = 0; i < objects.length; i++) {\r\n      delete updates[i]._id;\r\n      objects[i].update(updates[i], context);\r\n    }\r\n  } else if (docName === 'Note') {\r\n    // Notes can be updated across different scenes\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].scene ?? objects[i].parent;\r\n      if (applyType === 'currentScene' && scene.id !== canvas.scene.id) continue;\r\n      if (!(scene.id in splitUpdates)) {\r\n        splitUpdates[scene.id] = { scene: scene, updates: [] };\r\n      }\r\n      splitUpdates[scene.id].updates.push(updates[i]);\r\n    }\r\n    for (const sceneUpdate of Object.values(splitUpdates)) {\r\n      sceneUpdate.scene.updateEmbeddedDocuments(docName, sceneUpdate.updates, context);\r\n    }\r\n  } else if (!this.isPrototype && SUPPORTED_PLACEABLES.includes(docName)) {\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].parent;\r\n      if (!splitUpdates[scene.id]) splitUpdates[scene.id] = [];\r\n      splitUpdates[scene.id].push(updates[i]);\r\n    }\r\n\r\n    for (const sceneId of Object.keys(splitUpdates)) {\r\n      game.scenes.get(sceneId)?.updateEmbeddedDocuments(docName, splitUpdates[sceneId], context);\r\n    }\r\n  } else if (SUPPORTED_COLLECTIONS.includes(docName)) {\r\n    objects[0].constructor?.updateDocuments(updates, context);\r\n  } else {\r\n    // Note a placeable or otherwise specially handled doc type\r\n    // Simply merge the fields directly into the object\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      mergeObjectPreserveDot(objects[i], foundry.utils.mergeObject(objects[i], update));\r\n    }\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n  }\r\n\r\n  // May need to also update Token prototypes\r\n  if ((applyType === 'applyToPrototype' || this.isPrototype) && docName === 'Token') {\r\n    const actorUpdates = {};\r\n    for (let i = 0; i < objects.length; i++) {\r\n      const actor = objects[i].actor;\r\n      if (actor) actorUpdates[actor.id] = { _id: actor.id, prototypeToken: updates[i] };\r\n    }\r\n    if (!foundry.utils.isEmpty(actorUpdates)) {\r\n      const updates = [];\r\n      for (const id of Object.keys(actorUpdates)) {\r\n        updates.push(actorUpdates[id]);\r\n      }\r\n      Actor.updateDocuments(updates);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Processes Mass Edit inserted custom fields\r\n * @param {String} docName\r\n * @param {*} updates\r\n * @param {*} objects\r\n */\r\nexport async function checkApplySpecialFields(docName, updates, objects) {\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const object = objects[i];\r\n\r\n    // Token Magic FX specific processing\r\n    if (update.hasOwnProperty('tokenmagic.ddTint') && typeof TokenMagic !== 'undefined') {\r\n      await applyDDTint(object, update['tokenmagic.ddTint']);\r\n    }\r\n    if (update.hasOwnProperty('tokenmagic.preset') && typeof TokenMagic !== 'undefined') {\r\n      await applyTMFXPreset(\r\n        object,\r\n        update['tokenmagic.preset'],\r\n        this?.addSubtractFields?.['tokenmagic.preset']?.method === 'subtract'\r\n      );\r\n    }\r\n\r\n    // Mass Edit inserted fields\r\n    if (docName === 'Tile') {\r\n      if (update.hasOwnProperty('massedit.scale')) {\r\n        const scale = update['massedit.scale'];\r\n        update.width = object.width * scale;\r\n        update.height = object.height * scale;\r\n\r\n        // 3D Support\r\n        if (object.flags?.['levels-3d-preview']?.depth != null) {\r\n          update['flags.levels-3d-preview.depth'] = object.flags['levels-3d-preview'].depth *= scale;\r\n        } else if (object['flags.levels-3d-preview.depth'] != null) {\r\n          update['flags.levels-3d-preview.depth'] = object['flags.levels-3d-preview.depth'] * scale;\r\n        }\r\n      }\r\n\r\n      if (update.hasOwnProperty('massedit.texture.scale')) {\r\n        update['texture.scaleX'] = update['massedit.texture.scale'];\r\n        update['texture.scaleY'] = update['massedit.texture.scale'];\r\n        delete update['massedit.texture.scale'];\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Toggle checkbox if input has been detected inside it's form-group\r\nasync function onInputChange(event) {\r\n  if (event.target.className === 'mass-edit-control') {\r\n    if (!event.target.checked) {\r\n      // If the checkbox has been unchecked we may need to remove highlighting from tabs\r\n      deselectTabs(event.target);\r\n      return;\r\n    }\r\n  }\r\n\r\n  const meChk = $(event.target).closest('.form-group').find('.mass-edit-checkbox input');\r\n  meChk.prop('checked', true);\r\n\r\n  // Highlight tabs if they exist\r\n  selectTabs(meChk[0]);\r\n\r\n  // Immediately update the placeables\r\n  if (this && this.options.massEdit && this._performOnInputChangeUpdate && this.modUpdate)\r\n    this._performOnInputChangeUpdate();\r\n}\r\n\r\nfunction selectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .addClass('mass-edit-tab-selected');\r\n    selectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nfunction deselectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length && tab.find('.mass-edit-checkbox input:checked').length === 0) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .removeClass('mass-edit-tab-selected');\r\n    deselectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nexport function getObjFormData(obj, docName) {\r\n  const data = foundry.utils.flattenObject(getData(obj).toObject());\r\n\r\n  // Special processing for some placeable types\r\n  // Necessary when form data is not directly mappable to placeable\r\n  GeneralDataAdapter.dataToForm(docName, obj, data);\r\n\r\n  return data;\r\n}\r\n\r\n// Merge all data and determine what is common between the docs\r\nfunction getCommonDocData(docs, docName) {\r\n  if (!docName) getDocumentName(docs[0]);\r\n  const objects = docs.map((d) => getObjFormData(d, docName));\r\n  return getCommonData(objects);\r\n}\r\n\r\nexport const WithMassPermissions = () => {\r\n  let MEF = WithMassEditForm(DocumentOwnershipConfig);\r\n\r\n  class MassPermissions extends MEF {\r\n    constructor(target, docs, options = {}) {\r\n      // Generate common permissions\r\n      const data = getData(docs[0]);\r\n      const commonData = foundry.utils.flattenObject(data.ownership);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      // Permissions are only present if they differ from default, for simplicity simple add them before comparing\r\n      const addMissingPerms = function (perms) {\r\n        game.users.forEach((u) => {\r\n          if (!(u.id in perms)) perms[u.id] = metaLevels.DEFAULT;\r\n        });\r\n\r\n        if (!('default' in perms)) perms.default = metaLevels.DEFAULT;\r\n      };\r\n      addMissingPerms(commonData);\r\n\r\n      for (let i = 1; i < docs.length; i++) {\r\n        const data = getData(docs[i]);\r\n        const flatData = foundry.utils.flattenObject(data.ownership);\r\n        addMissingPerms(flatData);\r\n        const diff = foundry.utils.flattenObject(foundry.utils.diffObject(commonData, flatData));\r\n        for (const k of Object.keys(diff)) {\r\n          delete commonData[k];\r\n        }\r\n      }\r\n\r\n      options.commonData = commonData;\r\n      options.massPermissions = true;\r\n\r\n      super(target, docs, options);\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      const selectedFields = this.getSelectedFields(formData);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return;\r\n\r\n      const ids = new Set();\r\n      const updates = [];\r\n      for (const d of this.meObjects) {\r\n        if (!ids.has(d.id)) {\r\n          const data = getData(d);\r\n          const ownership = foundry.utils.deepClone(data.ownership);\r\n\r\n          for (let [user, level] of Object.entries(selectedFields)) {\r\n            if (level === metaLevels.DEFAULT) delete ownership[user];\r\n            else ownership[user] = level;\r\n          }\r\n\r\n          ids.add(d.id);\r\n          updates.push({ _id: d.id, ownership: ownership });\r\n        }\r\n      }\r\n\r\n      this.meObjects[0].constructor.updateDocuments(updates, {\r\n        diff: false,\r\n        recursive: false,\r\n        noHook: true,\r\n      });\r\n    }\r\n\r\n    get title() {\r\n      return `Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`;\r\n    }\r\n  }\r\n\r\n  return MassPermissions;\r\n};\r\n\r\n// ==================================\r\n// ========== CLIPBOARD =============\r\n// ==================================\r\n\r\nconst CLIPBOARD = {};\r\n\r\nexport function copyToClipboard(preset, command, isPrototype) {\r\n  CLIPBOARD[preset.documentName] = preset;\r\n\r\n  // Special handling for Actors/Tokens\r\n  if (preset.documentName === 'Token' && isPrototype) {\r\n    CLIPBOARD['TokenProto'] = preset;\r\n  } else if (preset.documentName === 'Token') {\r\n    if (command === 'copyProto') {\r\n      delete CLIPBOARD['Token'];\r\n      CLIPBOARD['TokenProto'] = preset;\r\n    }\r\n  }\r\n\r\n  // Also copy the fields to the game clipboard as plain text\r\n  game.clipboard.copyPlainText(\r\n    JSON.stringify(foundry.utils.deepClone(preset.data.length === 1 ? preset.data[0] : preset.data), null, 2)\r\n  );\r\n\r\n  ui.notifications.info(\r\n    localFormat('clipboard.copy', {\r\n      document: preset.documentName,\r\n    })\r\n  );\r\n}\r\n\r\nexport function deleteFromClipboard(docName) {\r\n  delete CLIPBOARD[docName];\r\n  if (docName === 'Token') delete CLIPBOARD['TokenProto'];\r\n}\r\n\r\nexport function getClipboardData(docName) {\r\n  return CLIPBOARD[docName];\r\n}\r\n","import { constructNav } from '../applications/generic/navGenerator.js';\r\nimport { MODULE_ID, getDocumentName, localize } from './utils.js';\r\n\r\nexport function injectVisibility(app) {\r\n  const docName = getDocumentName(app.meObjects[0]);\r\n\r\n  // Only the following docs necessitate hidden field\r\n  if (!['AmbientLight', 'AmbientSound'].includes(docName)) return;\r\n\r\n  const form = $(app.form);\r\n\r\n  const isInjected = form.find('input[name=\"hidden\"]');\r\n  if (isInjected.length) return;\r\n\r\n  const hidden = app.object.hidden;\r\n  const newHtml = `\r\n  <div class=\"form-group\">\r\n    <label>${localize(`Hidden`, false)}</label>\r\n    <div class=\"form-fields\">\r\n        <input type=\"checkbox\" name=\"hidden\" ${hidden ? 'checked' : ''}>\r\n    </div>\r\n  </div>\r\n`;\r\n\r\n  const tabs = form.find('div.tab');\r\n  if (tabs.length) {\r\n    tabs.first().append(newHtml);\r\n  } else {\r\n    form.find('.form-group').last().after(newHtml);\r\n  }\r\n\r\n  app.setPosition({ height: 'auto' });\r\n}\r\n\r\nexport async function injectFlagTab(app) {\r\n  // Disable for now, until duplicate value fix is found\r\n  return;\r\n  if (!game.settings.get(MODULE_ID, 'enableFlagsTab')) return;\r\n  if (app.constructor.name === 'MassEditGenericForm') return;\r\n  const doc = app.meObjects[0];\r\n  let flags = foundry.utils.flattenObject((doc.document ?? doc).flags ?? {});\r\n\r\n  const html = $(app.form);\r\n  for (const [k, v] of Object.entries(flags)) {\r\n    if (html.find(`[name=\"flags.${k}\"]`).length) {\r\n      delete flags[k];\r\n    }\r\n  }\r\n\r\n  if (foundry.utils.isEmpty(flags)) return;\r\n\r\n  flags = expandObject(flags);\r\n\r\n  // Need to wait for other modules to perform their processing first\r\n  // Mainly MATT Active Tiles\r\n  if (getDocumentName(doc) === 'Wall') await new Promise((resolve) => setTimeout(resolve, 150));\r\n\r\n  const [flagNav, flagTabs] = constructNav({ flags: flags });\r\n  delete flagNav.items;\r\n  app.options.tabs = (app.options.tabs ?? []).concat(flagTabs);\r\n  if (app.tabs) app.tabs = app._createTabHandlers();\r\n  else app._tabs = app._createTabHandlers();\r\n\r\n  if (!flagNav.tabs.length) return;\r\n  flagNav.tabs[0].nav?.items?.forEach((item) => {\r\n    const mod = game.modules.get(item.dataTab.replace('flags.', ''));\r\n    if (mod) item.label = mod.title;\r\n  });\r\n\r\n  await getTemplate(`modules/${MODULE_ID}/templates/generic/form-group.html`);\r\n  await getTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`);\r\n  let htmlNav = await renderTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`, flagNav);\r\n\r\n  htmlNav = $(htmlNav);\r\n\r\n  // Remove pins or replace them with trash cans depending on whether this is a Mass Edit or Search form\r\n  if (app.options.massSelect) {\r\n    htmlNav.find('.me-pinned').remove();\r\n  } else {\r\n    htmlNav.find('.me-pinned').replaceWith(`<a class=\"me-delete-flag\" title=\"DELETE\"><i class=\"fas fa-trash\"></i></a>`);\r\n    html.on('click', '.me-delete-flag', (event) => {\r\n      const delFlag = $(event.target).closest('a');\r\n      delFlag.toggleClass('active');\r\n      const toDelete = delFlag.hasClass('active');\r\n      const namedElements = delFlag.closest('.form-group').find('[name]');\r\n      namedElements.each(function () {\r\n        const name = this.name;\r\n        if (toDelete && !name.includes('-=')) {\r\n          let nArr = name.split('.');\r\n          nArr[nArr.length - 1] = '-=' + nArr[nArr.length - 1];\r\n          this.name = nArr.join('.');\r\n        } else if (!toDelete) {\r\n          this.name = name.replace('-=', '');\r\n        }\r\n      });\r\n      namedElements.first().trigger('change');\r\n    });\r\n  }\r\n\r\n  // Insert Flags tab into\r\n  const sheetMainNav = html.find('.sheet-tabs').first();\r\n  if (!sheetMainNav.length) return;\r\n  sheetMainNav.append('<a class=\"item\" data-tab=\"flags\"><i class=\"fa-solid fa-flag\"></i> Flags</a>');\r\n\r\n  if (!sheetMainNav.attr('data-group')) {\r\n    htmlNav.removeAttr('data-group');\r\n  }\r\n  html.find('footer').last().before(htmlNav);\r\n\r\n  // For special jsonArray fields provide the ability to expand them via a dialog\r\n  html.find('.tva-jsonArray').on('dblclick', (event) => {\r\n    let content = `<textarea style=\"width:100%; height: 100%;\">${event.target.value}</textarea>`;\r\n    new Dialog(\r\n      {\r\n        title: `Edit`,\r\n        content: content,\r\n        buttons: {},\r\n        render: (html) => {\r\n          html.find('textarea').on('input', (ev) => {\r\n            $(event.target).val(ev.target.value).trigger('input');\r\n          });\r\n          html.closest('section').find('.dialog-buttons').remove();\r\n        },\r\n      },\r\n      { resizable: true, height: 300 }\r\n    ).render(true);\r\n  });\r\n\r\n  app._activateCoreListeners(html);\r\n}\r\n","export const CUSTOM_CONTROLS = {\n  field: {\n    shieldType: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n    blend: {\n      range: true,\n      min: '0',\n      max: '16',\n      step: '1',\n    },\n    scale: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    radius: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    intensity: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    lightAlpha: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    gridPadding: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    lightSize: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    animated: {\n      time: {\n        speed: {\n          range: true,\n          min: '0',\n          max: '0.05',\n          step: '0.0001',\n        },\n      },\n    },\n  },\n  fire: {\n    fireBlend: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n    blend: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n    animated: {\n      intensity: {\n        animType: {\n          select: true,\n          options: [\n            'syncChaoticOscillation',\n            'syncSinOscillation',\n            'syncCosOscillation',\n            'chaoticOscillation',\n            'halfSinOscillation',\n            'sinOscillation',\n            'halfCosOscillation',\n            'cosOscillation',\n            'syncColorOscillation',\n            'halfColorOscillation',\n            'colorOscillation',\n          ],\n        },\n        val2: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n        val1: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n        loopDuration: {\n          range: true,\n          min: '0',\n          max: '50000',\n          step: '100',\n        },\n      },\n      amplitude: {\n        animType: {\n          select: true,\n          options: [\n            'syncChaoticOscillation',\n            'syncSinOscillation',\n            'syncCosOscillation',\n            'chaoticOscillation',\n            'halfSinOscillation',\n            'sinOscillation',\n            'halfCosOscillation',\n            'cosOscillation',\n            'syncColorOscillation',\n            'halfColorOscillation',\n            'colorOscillation',\n          ],\n        },\n        loopDuration: {\n          range: true,\n          min: '0',\n          max: '50000',\n          step: '100',\n        },\n        val1: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n        val2: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n      },\n    },\n    intensity: {\n      range: true,\n      min: '0',\n      max: '100',\n      step: '0.1',\n    },\n  },\n  electric: {\n    blend: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n  },\n  xglow: {\n    auraType: {\n      range: true,\n      min: '0',\n      max: '2',\n      step: '1',\n    },\n    scale: {\n      range: true,\n      min: '0',\n      max: '30',\n      step: '0.1',\n    },\n    auraIntensity: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    subAuraIntensity: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    threshold: {\n      range: true,\n      min: '0',\n      max: '2',\n      step: '0.01',\n    },\n    thickness: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n  },\n  glow: {\n    outerStrength: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    innerStrength: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    padding: {\n      range: true,\n      min: '0',\n      max: '100',\n      step: '1',\n    },\n    alpha: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n  },\n  zapshadow: {\n    alphaTolerance: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n  },\n  sprite: {\n    blendMode: {\n      range: true,\n      min: '0',\n      max: '16',\n      step: '1',\n    },\n    gridPadding: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.1',\n    },\n    scaleX: {\n      range: true,\n      min: '0',\n      max: '3',\n      step: '0.01',\n    },\n    scaleY: {\n      range: true,\n      min: '0',\n      max: '3',\n      step: '0.01',\n    },\n    translationX: {\n      range: true,\n      min: '-1',\n      max: '1',\n      step: '0.001',\n    },\n    translationY: {\n      range: true,\n      min: '-1',\n      max: '1',\n      step: '0.001',\n    },\n    rotation: {\n      range: true,\n      min: '0',\n      max: '360',\n      step: '1',\n    },\n    alpha: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n  },\n  xfire: {\n    blend: {\n      range: true,\n      min: '0',\n      max: '16',\n      step: '1',\n    },\n    amplitude: {\n      range: true,\n      min: '0',\n      max: '10',\n      step: '0.01',\n    },\n    dispersion: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    scaleX: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    scaleY: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    animated: {\n      time: {\n        speed: {\n          range: true,\n          min: '-0.0050',\n          max: '0.0050',\n          step: '0.0001',\n        },\n      },\n    },\n  },\n  transform: {\n    gridPadding: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    scaleX: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.1',\n    },\n    scaleY: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.1',\n    },\n  },\n  ascii: {\n    animated: {\n      size: {\n        val1: {\n          range: true,\n          min: '-5',\n          max: '5',\n          step: '0.01',\n        },\n        val2: {\n          range: true,\n          min: '-5',\n          max: '5',\n          step: '0.01',\n        },\n      },\n    },\n    size: {\n      range: true,\n      min: '1',\n      max: '64',\n      step: '1',\n    },\n  },\n  dot: {\n    scale: {\n      range: true,\n      min: '0',\n      max: '10',\n      step: '0.1',\n    },\n    angle: {\n      range: true,\n      min: '0',\n      max: '360',\n      step: '1',\n    },\n  },\n  godray: {\n    blendMode: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '1',\n    },\n    padding: {\n      range: true,\n      min: '-5',\n      max: '50',\n      step: '0.1',\n    },\n  },\n  rgbSplit: {\n    redX: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    redY: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    greenX: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    greenY: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    blueX: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    blueY: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n  },\n  polymorph: {\n    type: {\n      range: true,\n      min: '0',\n      max: '9',\n      step: '1',\n    },\n  },\n  shadow: {\n    blur: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '1',\n    },\n  },\n  flood: {\n    billowy: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    tintIntensity: {\n      range: true,\n      min: '0.0',\n      max: '1',\n      step: '0.01',\n    },\n    glint: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n    scale: {\n      range: true,\n      min: '5',\n      max: '500',\n      step: '1',\n    },\n    animated: {\n      time: {\n        speed: {\n          range: true,\n          min: '0.00001',\n          max: '0.001',\n          step: '0.00001',\n        },\n      },\n    },\n  },\n};\n","import { CUSTOM_CONTROLS } from '../../data/custom-controls.js';\r\nimport { MODULE_ID, getCommonData, localize } from '../../scripts/utils.js';\r\nimport { WithMassConfig } from '../forms.js';\r\nimport { showMassEdit } from '../multiConfig.js';\r\nimport { constructNav, isColorField } from './navGenerator.js';\r\n\r\nconst WMC = WithMassConfig();\r\nexport class MassEditGenericForm extends WMC {\r\n  constructor(docs, options = {}) {\r\n    const objects = docs.map((a) => (a.toObject ? a.toObject() : a));\r\n    let allData = {};\r\n    for (let i = objects.length; i >= 0; i--) {\r\n      foundry.utils.mergeObject(allData, objects[i]);\r\n    }\r\n\r\n    if (options.noTabs) {\r\n      allData = foundry.utils.flattenObject(allData);\r\n    }\r\n\r\n    let documentName = options.documentName ?? 'NONE';\r\n\r\n    let customControls = foundry.utils.mergeObject(\r\n      CUSTOM_CONTROLS[documentName] ?? {},\r\n      game.settings.get(MODULE_ID, 'customControls')[documentName] ?? {}\r\n    );\r\n    customControls = foundry.utils.mergeObject(customControls, options.customControls?.[documentName] ?? {});\r\n\r\n    const [nav, tabSelectors] = constructNav(allData, documentName, customControls, !options.noTabs);\r\n    const commonData = getCommonData(objects);\r\n\r\n    super(docs[0], docs, {\r\n      tabs: tabSelectors,\r\n      commonData: commonData,\r\n      ...options,\r\n    });\r\n\r\n    this.allData = allData;\r\n    this.nav = nav;\r\n    this.editableLabels = {};\r\n\r\n    this.pinnedFields = game.settings.get(MODULE_ID, 'pinnedFields')[this.documentName] ?? {};\r\n    this.customControls = customControls;\r\n\r\n    if (options.callback) {\r\n      this.callbackOnUpdate = options.callback;\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-generic-form',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/generic/genericForm.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generic`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n    if (this.options.tokens) {\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-tokens',\r\n        icon: 'fas fa-user-circle',\r\n        onclick: () => {\r\n          showMassEdit(this.options.tokens, 'Token');\r\n          this.close();\r\n        },\r\n      });\r\n    }\r\n    return buttons;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = await super.getData(options);\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`, 'me-navHeaderPartial');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/form-group.html`, 'me-form-group');\r\n\r\n    data.nav = this.nav;\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.me-pinned').click((event) => {\r\n      const star = $(event.target).parent();\r\n      const control = star.closest('.form-group').find('[name]');\r\n      const name = control.attr('name');\r\n      if (star.hasClass('active')) {\r\n        star.removeClass('active');\r\n        delete this.pinnedFields[name];\r\n      } else {\r\n        star.addClass('active');\r\n        this.pinnedFields[name] = { label: name };\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label').on('input', (event) => {\r\n      const name = $(event.target).closest('.form-group').find('[name]').attr('name');\r\n      this.editableLabels[name] = event.target.value;\r\n    });\r\n\r\n    html.find('.color-number').on('change', (event) => {\r\n      if (event.target.dataset?.editNumber) {\r\n        let col = 0;\r\n        try {\r\n          col = Number(Color.fromString(event.target.value));\r\n        } catch (e) {}\r\n\r\n        $(event.target).siblings(`[name=\"${event.target.dataset.editNumber}\"]`).val(col).trigger('input');\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label, label').on('contextmenu', (event) => {\r\n      const formGroup = $(event.target).closest('.form-group');\r\n      if (!formGroup.length) return;\r\n      const input = formGroup.find('[name]');\r\n      const name = input.attr('name');\r\n      if (name) {\r\n        if (isColorField(name)) return;\r\n\r\n        const type = input.attr('type');\r\n        if (type === 'range') {\r\n          unsetCustomControl(name, this.documentName);\r\n          return;\r\n        } else if (type === 'number') {\r\n          defineRangeControl(name, input.val(), this.customControls, this.documentName);\r\n        } else if (type === 'text') {\r\n          defineSelectControl(name, input.val(), this.customControls, this.documentName);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (this.options.inputChangeCallback) {\r\n      html.on('change', 'input, select', async (event) => {\r\n        setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    super._updateObject(event, formData);\r\n\r\n    // Save pinned field values and labels\r\n    const pinned = game.settings.get(MODULE_ID, 'pinnedFields');\r\n    pinned[this.documentName] = this.pinnedFields;\r\n\r\n    for (const name of Object.keys(this.pinnedFields)) {\r\n      this.pinnedFields[name].value = formData[name];\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(this.editableLabels)) {\r\n      for (const [name, label] of Object.entries(this.editableLabels)) {\r\n        if (name in this.pinnedFields) {\r\n          this.pinnedFields[name].label = label;\r\n          this.pinnedFields[name].value = formData[name];\r\n        }\r\n      }\r\n      this.editableLabels = {};\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'pinnedFields', pinned);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    if (this.callbackOnUpdate) this.callbackOnUpdate(null);\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\nfunction defineRangeControl(name, val, customControls, docName, { min = null, max = null, step = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>Range</label>\r\n  <div class=\"form-fields\">\r\n    <label>${localize('Minimum', false)}</label>\r\n    <input type=\"number\" value=\"${min ?? val}\" name=\"min\" step=\"any\">\r\n    <label>${localize('Maximum', false)}</label>\r\n    <input type=\"number\" value=\"${max ?? val}\" name=\"max\" step=\"any\">\r\n    <label>${localize('generic-form.step-size')}</label>\r\n    <input type=\"number\" value=\"${step ?? 1}\" name=\"step\" step=\"any\">\r\n  </div>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-range'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const min = html.find('[name=\"min\"]').val() || val;\r\n          const max = html.find('[name=\"max\"]').val() || val;\r\n          const step = html.find('[name=\"step\"]').val() || 1;\r\n\r\n          setProperty(customControls, name, { range: true, min, max, step });\r\n          const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n          allControls[docName] = customControls;\r\n          game.settings.set(MODULE_ID, 'customControls', allControls);\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction defineSelectControl(name, val, customControls, docName, { options = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>${localize('common.options')}</label>\r\n  <textarea name=\"options\">${options ? options.join('\\n') : val}</textarea>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-dropdown'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const options = html.find('[name=\"options\"]').val().trim();\r\n          if (options) {\r\n            setProperty(customControls, name, {\r\n              select: true,\r\n              options: options.split('\\n').filter((o) => o),\r\n            });\r\n            const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n            allControls[docName] = customControls;\r\n            game.settings.set(MODULE_ID, 'customControls', allControls);\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction unsetCustomControl(name, docName) {\r\n  const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n  let docControls = allControls[docName] || {};\r\n  setProperty(docControls, name, null);\r\n  game.settings.set(MODULE_ID, 'customControls', allControls);\r\n}\r\n","import { MODULE_ID, localize } from '../../scripts/utils.js';\r\n\r\nexport function constructNav(allData, documentName, customControls, pins = true) {\r\n  const nav = {\r\n    dataGroup: 'main',\r\n    items: [],\r\n    tabs: [],\r\n  };\r\n  const tabSelectors = [{ navSelector: '.tabs[data-group=\"main\"]', contentSelector: 'form', initial: 'me-pinned' }];\r\n\r\n  // Limit the form to just the keys marked as editable\r\n  let editableKeys;\r\n  // if (documentName === 'Actor') {\r\n  //   editableKeys = ['name', 'img', 'system', 'data', 'folder', 'flags'];\r\n  // }\r\n\r\n  let object = {};\r\n  if (!editableKeys) object = allData;\r\n  else {\r\n    for (const k of editableKeys) {\r\n      if (k in allData) {\r\n        object[k] = allData[k];\r\n      }\r\n    }\r\n  }\r\n\r\n  const pinned = documentName ? game.settings.get(MODULE_ID, 'pinnedFields')[documentName] || {} : {};\r\n\r\n  _constructControls(nav, object, tabSelectors, '', pinned, customControls, pins);\r\n\r\n  const pinned_groups = [];\r\n  const flatObject = foundry.utils.flattenObject(object);\r\n  for (const [k, v] of Object.entries(pinned)) {\r\n    const value = k in flatObject ? flatObject[k] : v.value;\r\n\r\n    let control = genControl(foundry.utils.getType(value), v.label, value, k, {}, true, customControls, pins);\r\n    control.pinned = true;\r\n    pinned_groups.push(control);\r\n  }\r\n  if (pinned_groups.length) {\r\n    // No tabs constructed means this is not a nested object, however since we have pinned fields\r\n    // we need to separate main object fields from the pinned ones\r\n    if (!nav.items.length) {\r\n      nav.items.push({ dataTab: 'main-me-main', label: 'Main' });\r\n      nav.tabs.push({ dataTab: 'main-me-main', groups: nav.groups });\r\n      delete nav.groups;\r\n    }\r\n\r\n    nav.items.unshift({\r\n      dataTab: 'me-pinned',\r\n      dataTab: 'me-pinned',\r\n      label: localize('generic-form.pinned'),\r\n    });\r\n    nav.tabs.unshift({ dataTab: 'me-pinned', groups: pinned_groups });\r\n  }\r\n\r\n  return [nav, tabSelectors];\r\n}\r\n\r\nfunction _constructControls(nav, data, tabSelectors, name, pinned, customControls, pins) {\r\n  const groups = [];\r\n  let containsNav = false;\r\n  for (const [k, v] of Object.entries(data)) {\r\n    const name2 = name ? name + '.' + k : k;\r\n    if (v !== null) {\r\n      let t = foundry.utils.getType(v);\r\n      let control;\r\n      if (t === 'Object') {\r\n        if (_hasNonNullKeys(v)) {\r\n          nav.items.push({ dataTab: name2, label: _genLabel(k) });\r\n          const newNav = { dataGroup: name2, items: [], tabs: [] };\r\n          nav.tabs.push({ dataTab: name2, nav: newNav });\r\n          tabSelectors.push({\r\n            navSelector: `.tabs[data-group=\"${name2}\"]`,\r\n            contentSelector: `.tab[data-tab=\"${name2}\"]`,\r\n            initial: k + '-me-main',\r\n          });\r\n          _constructControls(newNav, v, tabSelectors, name2, pinned, customControls, pins);\r\n          containsNav = true;\r\n        }\r\n      } else {\r\n        control = genControl(t, _genLabel(k), v, name2, pinned, false, customControls, pins);\r\n      }\r\n      if (control) {\r\n        groups.push(control);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (groups.length) {\r\n    if (containsNav) {\r\n      nav.items.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        label: 'Main',\r\n      });\r\n      nav.tabs.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        groups,\r\n      });\r\n    } else {\r\n      nav.groups = groups;\r\n    }\r\n  }\r\n}\r\n\r\nfunction _hasNonNullKeys(obj) {\r\n  if (foundry.utils.isEmpty(obj)) return false;\r\n  for (const [k, v] of Object.entries(obj)) {\r\n    if (foundry.utils.getType(v) === 'Object') {\r\n      if (_hasNonNullKeys(v)) return true;\r\n    } else if (v != null) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction _genLabel(key) {\r\n  if (key.length <= 3) return key.toUpperCase();\r\n  return key.charAt(0).toUpperCase() + key.slice(1);\r\n}\r\n\r\nconst IMAGE_FIELDS = ['img', 'image', 'src', 'texture'];\r\nconst COLOR_FIELDS = ['tint'];\r\n\r\nexport function isColorField(name) {\r\n  name = name.split('.').pop();\r\n  return COLOR_FIELDS.includes(name) || name.toLowerCase().includes('color');\r\n}\r\n\r\nfunction genControl(type, label, value, name, pinned, editableLabel = false, customControls = {}, pins) {\r\n  const allowedArrayElTypes = ['number', 'string'];\r\n\r\n  let control = { label: label, value, name, editableLabel, pins };\r\n  if (getProperty(customControls, name)) {\r\n    control = foundry.utils.mergeObject(control, getProperty(customControls, name));\r\n  } else if (type === 'number') {\r\n    control.number = true;\r\n    const varName = name.split('.').pop();\r\n    if (isColorField(varName)) {\r\n      control.colorPickerNumber = true;\r\n      try {\r\n        control.colorValue = new Color(value).toString();\r\n      } catch (e) {}\r\n    }\r\n  } else if (type === 'string') {\r\n    control.text = true;\r\n    const varName = name.split('.').pop();\r\n    if (\r\n      IMAGE_FIELDS.includes(varName) ||\r\n      varName.toLowerCase().includes('image') ||\r\n      varName.toLowerCase().includes('path')\r\n    )\r\n      control.filePicker = true;\r\n    else if (isColorField(varName)) control.colorPicker = true;\r\n  } else if (type === 'boolean') {\r\n    control.boolean = true;\r\n  } else if (type === 'Array' && value.every((el) => allowedArrayElTypes.includes(foundry.utils.getType(el)))) {\r\n    control.value = value.join(', ');\r\n    control.array = true;\r\n  } else if (type === 'Array') {\r\n    control.jsonArray = true;\r\n    control.value = JSON.stringify(value, null, 2);\r\n  } else {\r\n    control.disabled = true;\r\n    control.text = true;\r\n    control.editableLabel = false;\r\n  }\r\n  if (control && name in pinned) {\r\n    control.pinned = true;\r\n    control.disabled = true;\r\n    control.name = null;\r\n  }\r\n  return control;\r\n}\r\n","import { showPlaceableTypeSelectDialog } from '../scripts/dialogs.js';\r\nimport { PresetAPI } from '../scripts/presets/collection.js';\r\nimport { getData, getDocumentName, MODULE_ID, SUPPORT_SHEET_CONFIGS, SUPPORTED_COLLECTIONS } from '../scripts/utils.js';\r\nimport { getClipboardData, pasteDataUpdate, WithMassConfig } from './forms.js';\r\nimport { MassEditGenericForm } from './generic/genericForm.js';\r\n\r\nexport const LAYER_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lighting',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\nexport const SCENE_DOC_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lights',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\n// Retrieve currently controlled placeables\r\nexport function getControlled() {\r\n  if (canvas.activeLayer.controlled.length) {\r\n    return canvas.activeLayer.controlled;\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve hovered over placeable\r\nfunction getHover() {\r\n  let docName = canvas.activeLayer.constructor.documentName;\r\n  // Walls do not properly cleanup hover state\r\n  if (!['Wall'].includes(docName)) {\r\n    if (canvas.activeLayer.hover) {\r\n      return [canvas.activeLayer.hover];\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve documents selected using Multiple Document Selection module (https://github.com/ironmonk88/multiple-document-selection)\r\nfunction getSelectedDocuments(placeableSelect) {\r\n  const supportedDocs = [\r\n    { name: 'Actor', class: 'actor' },\r\n    { name: 'Scene', class: 'scene' },\r\n    { name: 'JournalEntry', class: 'journalentry' },\r\n    { name: 'Playlist', class: 'sound' },\r\n    { name: 'Item', class: 'item' },\r\n    { name: 'RollTable', class: 'rolltable' },\r\n    { name: 'Cards', class: 'cards' },\r\n  ];\r\n  for (const doc of supportedDocs) {\r\n    const selected = [];\r\n    $(`.directory-list .${doc.class}.selected`).each(function (_) {\r\n      let d;\r\n      if (doc.name === 'Playlist') {\r\n        d = game.collections.get(doc.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n      } else {\r\n        d = game.collections.get(doc.name).get(this.dataset.documentId);\r\n      }\r\n\r\n      if (d) {\r\n        // JournalEntries themselves do not have configs, but notes that they correspond to on the scene do\r\n        if (placeableSelect && doc.name === 'JournalEntry') {\r\n          game.collections.get('Scene').forEach((s) =>\r\n            s.notes.forEach((n) => {\r\n              const eid = n.entryId ?? n.data.entryId;\r\n              if (d.id === eid) {\r\n                selected.push(n);\r\n              }\r\n            })\r\n          );\r\n          // canvas.notes.placeables\r\n          //   .filter((n) => d.id === (n.entryId ?? n.data.entryId))\r\n          //   .forEach((n) => selected.push(n));\r\n        } else {\r\n          if (d) selected.push(d);\r\n        }\r\n      }\r\n    });\r\n    if (selected.length) {\r\n      return selected;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function getSelected(base, placeable = true) {\r\n  let selected;\r\n  if (base) {\r\n    if (Array.isArray(base)) selected = base;\r\n    else selected = [base];\r\n  }\r\n  if (!selected) selected = getSelectedDocuments(placeable);\r\n  if (!selected) selected = getControlled();\r\n\r\n  // Sort placeable on the scene using their (x, y) coordinates\r\n  if (selected && selected.length > 1 && selected[0].x != null && selected[0].y != null) {\r\n    selected.sort((p1, p2) => {\r\n      const c = p1.y - p2.y;\r\n      if (c === 0) {\r\n        return p1.x - p2.x;\r\n      }\r\n      return c;\r\n    });\r\n  }\r\n\r\n  // We want one object to be treated as the target for the form\r\n  // Will prioritize hovered placeable for this purpose\r\n  let hover = getHover();\r\n  hover = hover ? hover[0] : hover;\r\n\r\n  if (!selected && hover) selected = [hover];\r\n  if (!hover && selected) hover = selected[0];\r\n\r\n  if (!hover && !selected) return [null, null];\r\n\r\n  if (hover && getDocumentName(hover) !== getDocumentName(selected[0])) {\r\n    hover = selected[0];\r\n  }\r\n\r\n  return [hover, selected];\r\n}\r\n\r\n// Show placeable search\r\nexport function showMassSelect(basePlaceable) {\r\n  let [target, selected] = getSelected(basePlaceable);\r\n\r\n  if (!target) {\r\n    showPlaceableTypeSelectDialog();\r\n    return;\r\n  }\r\n\r\n  const docName = getDocumentName(target);\r\n\r\n  const options = {\r\n    commonData: foundry.utils.flattenObject(getData(target).toObject()),\r\n    massSelect: true,\r\n    documentName: docName,\r\n  };\r\n\r\n  if (SUPPORT_SHEET_CONFIGS.includes(docName) && docName !== 'Actor') {\r\n    const MassConfig = WithMassConfig(docName);\r\n    new MassConfig(target, selected, options).render(true, {});\r\n  } else if (SUPPORTED_COLLECTIONS.includes(docName)) {\r\n    new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\n// show placeable edit\r\nexport async function showMassEdit(found = null, documentName, options = {}) {\r\n  let [target, selected] = getSelected(found);\r\n\r\n  // If there are no placeable in control or just one, then either exit or display the default config window\r\n  if (!selected || !selected.length) return;\r\n\r\n  if (!options.forceForm && game.settings.get(MODULE_ID, 'singleDocDefaultConfig')) {\r\n    if (selected.length === 1) {\r\n      if (selected[0].sheet) selected[0].sheet.render(true, {});\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Display modified config window\r\n  if (!documentName) documentName = getDocumentName(target);\r\n  options = { ...options, massEdit: true, documentName };\r\n  if (SUPPORT_SHEET_CONFIGS.includes(documentName)) {\r\n    if (documentName === 'Actor') {\r\n      target = target.prototypeToken;\r\n      selected = selected.map((s) => s.prototypeToken);\r\n      options.documentName = 'Token';\r\n    }\r\n    const MassConfig = WithMassConfig(options.documentName);\r\n    return new MassConfig(target, selected, options).render(true, {});\r\n  } else {\r\n    return new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\nexport function showMassActorForm(selectedTokens, options) {\r\n  const tokens = [];\r\n  const actors = [];\r\n  selectedTokens.forEach((s) => {\r\n    if (s.actor) {\r\n      tokens.push(s);\r\n      actors.push(s.actor);\r\n    }\r\n  });\r\n\r\n  if (actors.length) {\r\n    new MassEditGenericForm(actors, {\r\n      tokens,\r\n      documentName: 'Actor',\r\n      ...options,\r\n    }).render(true);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function pasteData() {\r\n  let selected;\r\n  if (!selected) selected = getSelectedDocuments();\r\n  if (!selected) selected = getControlled();\r\n  if (!selected) selected = getHover();\r\n\r\n  if (selected) return pasteDataUpdate(selected);\r\n  else {\r\n    let docName = canvas.activeLayer.constructor.documentName;\r\n    const preset = getClipboardData(docName);\r\n    if (preset) {\r\n      PresetAPI.spawnPreset({ preset });\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Displays a Generic Mass Edit form for the passed in data object/s\r\n * @param {Array|Object} data Object/s to be edited using the form\r\n * @param {String} name the name to be assigned internally to this data which will be used to manage presets and pins\r\n * @returns Promised resolved once the opened form is submitted\r\n */\r\nexport function showGenericForm(data, name = 'GenericData', options) {\r\n  return new Promise((resolve) => {\r\n    new MassEditGenericForm(Array.isArray(data) ? data : [data], {\r\n      documentName: name,\r\n      callback: () => resolve(),\r\n      ...options,\r\n    }).render(true);\r\n  });\r\n}\r\n","import { pasteDataUpdate } from '../applications/forms.js';\r\nimport { Picker } from './picker.js';\r\nimport { PresetAPI, PresetCollection } from './presets/collection.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\nimport { MODULE_ID } from './utils.js';\r\n\r\nexport class Brush {\r\n  static app;\r\n  static deactivateCallback;\r\n  static spawner;\r\n  static eraser;\r\n  static lastSpawnTime;\r\n  // @type {Preset}\r\n  static preset;\r\n  static brushOverlay;\r\n  static updatedPlaceables = new Map();\r\n  static hoveredPlaceables = new Set();\r\n  static hoveredPlaceable;\r\n  static documentName;\r\n  static active = false;\r\n  static hitTest;\r\n\r\n  static registered3dListener = false;\r\n  // Trick to keep consistent signatures for bound 3d brush callbacks\r\n  // Required to be able to remove these function once the 3d brush is deactivated\r\n  static {\r\n    this._boundOn3DBrushClick = this._on3DBrushClick.bind(this);\r\n    this._boundOn3dMouseMove = this._on3dMouseMove.bind(this);\r\n  }\r\n\r\n  static _performBrushDocumentUpdate(pos, placeable) {\r\n    if (pos) this._animateCrossTranslate(pos.x, pos.y);\r\n    pasteDataUpdate([placeable], this.preset, true, true, this.transform);\r\n    this.updatedPlaceables.set(placeable.id, placeable);\r\n    BrushMenu.iterate();\r\n  }\r\n\r\n  static _performBrushDocumentCreate(pos) {\r\n    const now = new Date().getTime();\r\n    if (!this.lastSpawnTime || now - this.lastSpawnTime > 100) {\r\n      this.lastSpawnTime = now;\r\n      if (pos.z == null) Picker.resolve(pos);\r\n      else PresetAPI.spawnPreset({ preset: this.preset, ...pos, center: true, snapToGrid: this.snap });\r\n      BrushMenu.iterate();\r\n    }\r\n  }\r\n\r\n  static _performBrushDocumentDelete(placeable) {\r\n    this.hoveredPlaceable = null;\r\n    placeable.document?.delete();\r\n  }\r\n\r\n  static _hitTestWall(point, wall) {\r\n    return wall.line.hitArea.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hitTestControlIcon(point, placeable) {\r\n    return (\r\n      Number.between(\r\n        point.x,\r\n        placeable.x - placeable.controlIcon.width / 2,\r\n        placeable.x + placeable.controlIcon.width / 2\r\n      ) &&\r\n      Number.between(\r\n        point.y,\r\n        placeable.y - placeable.controlIcon.height / 2,\r\n        placeable.y + placeable.controlIcon.height / 2\r\n      )\r\n    );\r\n  }\r\n\r\n  static _hitTestTile(point, placeable) {\r\n    const foreground = ui.controls.control.foreground ?? false;\r\n    if (placeable.document.overhead !== foreground) return false;\r\n    return this._hitTestArea(point, placeable);\r\n  }\r\n\r\n  static _hoverTestArea(placeable) {\r\n    return (\r\n      this.hoveredPlaceable &&\r\n      this.hoveredPlaceable.hitArea.width * this.hoveredPlaceable.hitArea.height >\r\n        placeable.hitArea.width * placeable.hitArea.height\r\n    );\r\n  }\r\n\r\n  static _hitTestArea(point, placeable) {\r\n    return (\r\n      Number.between(point.x, placeable.x, placeable.x + placeable.hitArea.width) &&\r\n      Number.between(point.y, placeable.y, placeable.y + placeable.hitArea.height)\r\n    );\r\n  }\r\n\r\n  static _onBrushMove(event) {\r\n    const pos = event.data.getLocalPosition(this.brushOverlay);\r\n    const layer = canvas.getLayerByEmbeddedName(this.documentName);\r\n    this._clearHover(event, pos);\r\n\r\n    for (const p of layer.placeables) {\r\n      if (p.visible && this.hitTest(pos, p) && !this.updatedPlaceables.has(p.id) && this.hoveredPlaceable !== p) {\r\n        if (this.hoverTest?.(p)) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoverTest && this.hoveredPlaceable && this.hoveredPlaceable !== p) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoveredPlaceable) {\r\n          this.hoveredPlaceable = p;\r\n        }\r\n\r\n        this.hoveredPlaceable._onHoverIn(event);\r\n      }\r\n    }\r\n  }\r\n\r\n  static _clearHover(event, pos, force = false) {\r\n    if (this.hoveredPlaceable) {\r\n      if (force || !this.hoveredPlaceable.visible || !this.hitTest(pos, this.hoveredPlaceable)) {\r\n        this.hoveredPlaceable._onHoverOut(event);\r\n        this.hoveredPlaceable = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  static _onBrushClickMove(event) {\r\n    if (this.spawner) {\r\n      this._performBrushDocumentCreate(event.data.getLocalPosition(this.brushOverlay));\r\n    } else if (\r\n      this.hoveredPlaceable &&\r\n      this.hoveredPlaceable.visible &&\r\n      !this.updatedPlaceables.has(this.hoveredPlaceable.id)\r\n    ) {\r\n      if (this.eraser) this._performBrushDocumentDelete(this.hoveredPlaceable);\r\n      else this._performBrushDocumentUpdate(event.data.getLocalPosition(this.brushOverlay), this.hoveredPlaceable);\r\n    }\r\n  }\r\n\r\n  static _on3DBrushClick(event) {\r\n    if (this.brush3d) {\r\n      if (this.spawner) {\r\n        if (this.brush3d?.position) {\r\n          const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.brush3d.position);\r\n          this._performBrushDocumentCreate({ x: posVec.x, y: posVec.y, z: posVec.z });\r\n        }\r\n      } else {\r\n        const p = game.Levels3DPreview.interactionManager.currentHover?.placeable;\r\n        if (p && p.document.documentName === this.documentName) {\r\n          game.Levels3DPreview.interactionManager._downCameraPosition.set(0, 0, 0);\r\n          if (this.eraser) this._performBrushDocumentDelete(p);\r\n          else this._performBrushDocumentUpdate(null, p);\r\n        }\r\n        this.updatedPlaceables.clear();\r\n      }\r\n    }\r\n  }\r\n\r\n  static refreshPreset() {\r\n    if (this.active && this.app) {\r\n      this.preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: this.app.getSelectedFields(),\r\n        randomize: this.app.randomizeFields,\r\n        addSubtract: this.app.addSubtractFields,\r\n      });\r\n    }\r\n  }\r\n\r\n  static async genPreview() {\r\n    if (!game.Levels3DPreview?._active)\r\n      PresetAPI.spawnPreset({\r\n        preset: this.preset,\r\n        coordPicker: true,\r\n        previewOnly: true,\r\n        center: true,\r\n        taPreview: 'ALL',\r\n        transform: this.transform,\r\n        snapToGrid: this.snap,\r\n      });\r\n  }\r\n\r\n  /**\r\n   * @param {Object} options\r\n   * @param {MassEditForm} options.app\r\n   * @param {Preset} options.preset\r\n   * @returns\r\n   */\r\n  static activate({\r\n    app = null,\r\n    preset = null,\r\n    deactivateCallback = null,\r\n    spawner = false,\r\n    eraser = false,\r\n    refresh = false,\r\n    transform = {},\r\n    snap = true,\r\n  } = {}) {\r\n    this.deactivate(refresh);\r\n    if (!canvas.ready) return false;\r\n    if (!app && !preset) return false;\r\n\r\n    if (this.brushOverlay) {\r\n      this.brushOverlay.destroy(true);\r\n    }\r\n\r\n    // Setup fields to be used for updates\r\n    this.app = app;\r\n    this.preset = preset;\r\n    this.transform = transform;\r\n    this.deactivateCallback = deactivateCallback;\r\n    this.spawner = spawner;\r\n    this.eraser = eraser;\r\n    this.snap = snap;\r\n    if (this.app) {\r\n      this.documentName = this.app.documentName;\r\n    } else {\r\n      this.documentName = this.preset.documentName;\r\n    }\r\n    if (!refresh) this.updatedPlaceables.clear();\r\n\r\n    const interaction = canvas.app.renderer.events;\r\n    if (!interaction.cursorStyles['brush']) {\r\n      interaction.cursorStyles['brush'] = `url('modules/${MODULE_ID}/images/brush_icon.png'), auto`;\r\n      interaction.cursorStyles['brush_spawn'] = `url('modules/${MODULE_ID}/images/brush_icon_spawn.png'), auto`;\r\n      interaction.cursorStyles['eraser'] = `url('modules/${MODULE_ID}/images/brush_icon_eraser.png'), auto`;\r\n    }\r\n\r\n    this.active = true;\r\n    this.refreshPreset();\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      return this._activate3d();\r\n    }\r\n\r\n    // Determine hit test test function to be used for pointer hover detection\r\n    if (this.spawner) {\r\n      this.hitTest = () => false;\r\n      this.genPreview();\r\n    } else {\r\n      switch (this.documentName) {\r\n        case 'Wall':\r\n          this.hitTest = this._hitTestWall;\r\n          break;\r\n        case 'AmbientLight':\r\n        case 'MeasuredTemplate':\r\n        case 'AmbientSound':\r\n        case 'Note':\r\n          this.hitTest = this._hitTestControlIcon;\r\n          break;\r\n        case 'Tile':\r\n          this.hitTest = this._hitTestTile;\r\n          this.hoverTest = this._hoverTestArea;\r\n          break;\r\n        default:\r\n          this.hitTest = this._hitTestArea;\r\n          this.hoverTest = this._hoverTestArea;\r\n      }\r\n    }\r\n\r\n    // Create the brush overlay\r\n    this.brushOverlay = new PIXI.Container();\r\n    this.brushOverlay.hitArea = canvas.dimensions.rect;\r\n\r\n    let cursor = 'brush';\r\n    if (spawner) cursor = 'brush_spawn';\r\n    else if (eraser) cursor = 'eraser';\r\n    this.brushOverlay.cursor = cursor;\r\n\r\n    this.brushOverlay.interactive = true;\r\n    this.brushOverlay.zIndex = Infinity;\r\n\r\n    this.brushOverlay.on('mousemove', (event) => {\r\n      Picker.feedPos(event.data.getLocalPosition(this.brushOverlay));\r\n      this._onBrushMove(event);\r\n      if (!this.mDownWithinCanvas) return; // Fix to prevent mouse interaction within apps\r\n      if (event.buttons === 1) this._onBrushClickMove(event);\r\n    });\r\n    this.brushOverlay.on('mouseup', (event) => {\r\n      this.mDownWithinCanvas = false; // Fix to prevent mouse interaction within apps\r\n      if (event.nativeEvent.which !== 2) {\r\n        this._onBrushClickMove(event);\r\n      }\r\n      this.updatedPlaceables.clear();\r\n    });\r\n\r\n    this.brushOverlay.on('mousedown', (event) => {\r\n      this.mDownWithinCanvas = true; // Fix to prevent mouse interaction within apps\r\n    });\r\n\r\n    this.brushOverlay.on('click', (event) => {\r\n      if (event.nativeEvent.which == 2) {\r\n        this.deactivate();\r\n      }\r\n    });\r\n\r\n    canvas.stage.addChild(this.brushOverlay);\r\n\r\n    // Disable canvas events to prevent selects and object placements on click\r\n    canvas.mouseInteractionManager.permissions.clickLeft = false;\r\n    // canvas.mouseInteractionManager.permissions.longPress = false;\r\n\r\n    return true;\r\n  }\r\n\r\n  static brush3dDelayMoveTimer;\r\n\r\n  static _on3dMouseMove() {\r\n    if (!this.brush3d || this.brush3dDelayMoveTimer) return;\r\n\r\n    const brush = this;\r\n    this.brush3dDelayMoveTimer = setTimeout(function () {\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      const cPos = game.Levels3DPreview.interactionManager.camera.position;\r\n\r\n      const intersects = game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(\r\n        cPos,\r\n        mPos,\r\n        'collision',\r\n        false,\r\n        false,\r\n        false,\r\n        true\r\n      );\r\n\r\n      if (intersects[0]) {\r\n        const intersect = intersects[0];\r\n        brush.brush3d.position.set(intersect.point.x, intersect.point.y, intersect.point.z);\r\n      }\r\n      brush.brush3dDelayMoveTimer = null;\r\n    }, 100); // Will do the ajax stuff after 1000 ms, or 1 s\r\n  }\r\n\r\n  static deactivate3DListeners() {\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('click', this._boundOn3DBrushClick, false);\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n  }\r\n\r\n  static _activate3DListeners() {\r\n    // Remove listeners if they are already set\r\n    this.deactivate3DListeners();\r\n\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('click', this._boundOn3DBrushClick, false);\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n  }\r\n\r\n  static _activate3d() {\r\n    const THREE = game.Levels3DPreview.THREE;\r\n\r\n    if (!this.brush3d) {\r\n      this.brush3d = new THREE.Mesh(\r\n        new THREE.SphereGeometry(0.01, 8, 8),\r\n        new THREE.MeshBasicMaterial({\r\n          opacity: 0.5,\r\n          transparent: true,\r\n          color: 0x00ff00,\r\n          wireframe: true,\r\n        })\r\n      );\r\n\r\n      this.brush3d.userData.interactive = false;\r\n      this.brush3d.userData.ignoreHover = true;\r\n\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      this.brush3d.position.set(mPos.x, mPos.y, mPos.z);\r\n\r\n      game.Levels3DPreview.scene.add(this.brush3d);\r\n    }\r\n\r\n    // Activate listeners\r\n    this._activate3DListeners();\r\n\r\n    return true;\r\n  }\r\n\r\n  static deactivate(refresh = false) {\r\n    if (this.active) {\r\n      canvas.mouseInteractionManager.permissions.clickLeft = true;\r\n      //canvas.mouseInteractionManager.permissions.longPress = true;\r\n      if (this.brushOverlay) this.brushOverlay.parent?.removeChild(this.brushOverlay);\r\n      if (this.brush3d && game.Levels3DPreview?._active) {\r\n        game.Levels3DPreview.scene.remove(this.brush3d);\r\n        this.brush3d = null;\r\n        this.deactivate3DListeners();\r\n      }\r\n      this.active = false;\r\n\r\n      if (!refresh) {\r\n        this.updatedPlaceables.clear();\r\n        this._clearHover(null, null, true);\r\n      }\r\n      this.hoverTest = null;\r\n      if (!refresh) this.deactivateCallback?.();\r\n      if (this.spawner) Picker.destroy();\r\n      this.spawner = false;\r\n      this.eraser = false;\r\n      this.deactivateCallback = null;\r\n      this.app = null;\r\n      this.preset = null;\r\n      this.transform = null;\r\n      return true;\r\n    }\r\n  }\r\n\r\n  static async _animateCrossTranslate(x, y) {\r\n    let cross = new PIXI.Text('+', {\r\n      fontFamily: 'Arial',\r\n      fontSize: 11,\r\n      fill: 0x00ff11,\r\n      align: 'center',\r\n    });\r\n    cross = this.brushOverlay.addChild(cross);\r\n    cross.x = x + Math.random() * 16 - 8;\r\n    cross.y = y;\r\n    const translate = [{ parent: cross, attribute: 'y', to: y - 50 }];\r\n\r\n    const completed = await CanvasAnimation.animate(translate, {\r\n      duration: 700,\r\n      name: foundry.utils.randomID(5),\r\n    });\r\n    if (completed) {\r\n      this.brushOverlay.removeChild(cross).destroy();\r\n    }\r\n  }\r\n}\r\n\r\n// =================================================\r\n\r\nexport class BrushMenu extends FormApplication {\r\n  static addPresets(presets = []) {\r\n    if (!this._instance) return this.render(presets);\r\n    else this._instance.addPresets(presets);\r\n  }\r\n\r\n  static isActive() {\r\n    return Boolean(this._instance);\r\n  }\r\n\r\n  static removePreset(id) {\r\n    if (!this._instance) return;\r\n    this._instance.removePreset(id);\r\n  }\r\n\r\n  static iterate(forward = true) {\r\n    if (!this._instance) return;\r\n    this._instance.iterate(forward);\r\n  }\r\n\r\n  static render(presets, settings = {}) {\r\n    if (this._instance) this.addPresets(presets);\r\n    else {\r\n      this._instance = new BrushMenu(presets, settings);\r\n      this._instance.render(true);\r\n    }\r\n  }\r\n\r\n  static async close() {\r\n    return this._instance?.close(true);\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-brush-menu',\r\n      template: `modules/${MODULE_ID}/templates/preset/brush.html`,\r\n      classes: ['mass-edit-dark-window'],\r\n      resizable: false,\r\n      minimizable: false,\r\n      width: 200,\r\n      height: 'auto',\r\n      scrollY: ['.presets'],\r\n    });\r\n  }\r\n\r\n  constructor(presets, settings = {}) {\r\n    super({}, { left: 10, top: window.innerHeight / 2 });\r\n    this.presets = presets ?? [];\r\n    this.preset = this.presets[0].clone();\r\n    this.preset.data = this.preset.data[0];\r\n    this._settings = foundry.utils.mergeObject(game.settings.get(MODULE_ID, 'brush'), settings);\r\n    this._it = -1;\r\n    this._createIndex();\r\n    this.iterate();\r\n  }\r\n\r\n  _createIndex() {\r\n    const index = [];\r\n\r\n    if (this._settings.group) {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        index.push({ pI });\r\n      }\r\n    } else {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        const preset = this.presets[pI];\r\n        for (let dI = 0; dI < preset.data.length; dI++) {\r\n          index.push({ pI, dI });\r\n        }\r\n      }\r\n    }\r\n    this._index = index;\r\n    if (this._it >= this._index.length) this._it = this._index.length - 1;\r\n  }\r\n\r\n  async _activateBrush(refresh = true) {\r\n    const index = this._index[this._it];\r\n    const p = this.presets[index.pI];\r\n    this.preset = p.clone();\r\n    if (index.hasOwnProperty('dI')) this.preset.data = [this.preset.data[index.dI]];\r\n\r\n    // Apply Color\r\n    await this._applyColor();\r\n\r\n    Brush.activate({\r\n      preset: this.preset,\r\n      deactivateCallback: this._deactivateCallback.bind(this),\r\n      spawner: this._settings.spawner,\r\n      eraser: this._settings.eraser,\r\n      transform: this._getTransform(),\r\n      refresh,\r\n      snap: this._settings.snap,\r\n    });\r\n  }\r\n\r\n  async _applyColor() {\r\n    if (this._settings.randomColor || this._settings.color) {\r\n      let pPath;\r\n      const docName = this.preset.documentName;\r\n      if (docName === 'Token' || docName === 'Tile') pPath = 'texture.tint';\r\n      else if (docName === 'AmbientLight') pPath = 'config.color';\r\n\r\n      if (pPath) {\r\n        if (this._settings.randomColor) {\r\n          const updates = this.preset.data.map(() => {\r\n            return { color: '' };\r\n          });\r\n          await applyRandomization(updates, null, { color: { type: 'color', ...this._settings.randomColor } });\r\n\r\n          this.preset.data.forEach((d, i) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, updates[i].color);\r\n            else foundry.utils.setProperty(d, pPath, updates[i].color);\r\n          });\r\n        } else {\r\n          this.preset.data.forEach((d) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, this._settings.color);\r\n            else foundry.utils.setProperty(d, pPath, this._settings.color);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  _applyDDTint(data, color) {\r\n    let filters = foundry.utils.getProperty(data, 'flags.tokenmagic.filters');\r\n\r\n    if (!color) {\r\n      if (filters) {\r\n        foundry.utils.setProperty(\r\n          data,\r\n          'flags.tokenmagic.filters',\r\n          filters.filter((f) => f.tmFilters.filterId !== 'DDTint')\r\n        );\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      foundry.utils.setProperty(data, 'flags.tokenmagic.filters', filters);\r\n    }\r\n  }\r\n\r\n  get title() {\r\n    return 'Brush';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    return {\r\n      presets: this.presets,\r\n      activePreset: this.preset,\r\n      ...this._settings,\r\n      tmfx: game.modules.get('tokenmagic')?.active,\r\n    };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const settings = this._settings;\r\n    const app = this;\r\n\r\n    import('./jquery-ui/jquery-ui.js').then((module) => {\r\n      const rotationRangeLabel = html.find('.rotation-range-label');\r\n      html.find('.rotation-slider').slider({\r\n        range: true,\r\n        min: -180,\r\n        max: 180,\r\n        values: settings.rotation,\r\n        slide: function (event, ui) {\r\n          rotationRangeLabel.text(`${ui.values[0]}° - ${ui.values[1]}°`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ rotation: ui.values });\r\n        },\r\n      });\r\n\r\n      const scaleRangeLabel = html.find('.scale-range-label');\r\n      html.find('.scale-slider').slider({\r\n        range: true,\r\n        min: 0.1,\r\n        max: 4,\r\n        step: 0.01,\r\n        values: settings.scale,\r\n        slide: function (event, ui) {\r\n          scaleRangeLabel.text(`${ui.values[0]} - ${ui.values[1]}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ scale: ui.values });\r\n        },\r\n      });\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.find('.toggle-button').on('click', this._toggleSetting.bind(this));\r\n    html.find('.reset').on('click', this._resetToDefaults.bind(this));\r\n    html.on('click', '.preset', this._onClickPreset.bind(this));\r\n    html.on('contextmenu', '.preset', this._onRightClickPreset.bind(this));\r\n    html.find('.randomize-color').on('click', this._onRandomizeColor.bind(this));\r\n    html.find('input[type=\"color\"]').on('change', this._onColorChange.bind(this));\r\n    html.find('.color').on('input paste', this._onColorChange.bind(this));\r\n  }\r\n\r\n  async _onColorChange(event) {\r\n    let cString = $(event.currentTarget).val();\r\n    if (!cString) this._updateBrushSettings({ color: '' });\r\n    else {\r\n      let color = Color.fromString(cString);\r\n      if (!Number.isNaN(color.valueOf())) this._updateBrushSettings({ color: cString });\r\n    }\r\n  }\r\n\r\n  async _onClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    if (presetIndex != null) {\r\n      this._it = this._index.findIndex((i) => i.pI === presetIndex);\r\n      await this._activateBrush();\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRandomizeColor() {\r\n    const randomColor = this._settings.randomColor ?? {};\r\n    const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n      method: 'random',\r\n      lockMethod: true,\r\n      space: randomColor.space,\r\n      hue: randomColor.hue,\r\n    });\r\n\r\n    let colorSlider;\r\n    let dialog = new Dialog({\r\n      title: `Pick Range`,\r\n      content: `<form>${colorTemp}</form>`,\r\n      buttons: {\r\n        save: {\r\n          label: 'Apply',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: {\r\n                method: 'random',\r\n                space: html.find('[name=\"space\"]').val(),\r\n                hue: html.find('[name=\"hue\"]').val(),\r\n                colors: colorSlider.getColors(),\r\n              },\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n        remove: {\r\n          label: 'Remove',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: null,\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n      },\r\n      render: (html) => {\r\n        import('./randomizer/slider.js').then((module) => {\r\n          colorSlider = new module.ColorSlider(\r\n            html,\r\n            randomColor.colors ?? [\r\n              { hex: '#ff0000', offset: 0 },\r\n              { hex: '#ff0000', offset: 100 },\r\n            ]\r\n          );\r\n          setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n        });\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async _onRightClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    const preset = this.presets[presetIndex];\r\n    if (preset) this.removePreset(preset.id);\r\n  }\r\n\r\n  async _resetToDefaults() {\r\n    await this._updateBrushSettings({ scale: [1, 1], rotation: [0, 0] });\r\n    this.render(true);\r\n  }\r\n\r\n  async _toggleSetting(event) {\r\n    const control = $(event.target).closest('.toggle-button');\r\n    const update = { [control.data('name')]: !control.hasClass('active') };\r\n\r\n    if (update.spawner) update.eraser = false;\r\n    if (update.eraser) update.spawner = false;\r\n\r\n    await this._updateBrushSettings(update);\r\n\r\n    if (update.random) await this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async _updateBrushSettings(update) {\r\n    foundry.utils.mergeObject(this._settings, update);\r\n    await game.settings.set(MODULE_ID, 'brush', this._settings);\r\n\r\n    if (update.hasOwnProperty('group')) this._createIndex();\r\n    await this._activateBrush();\r\n  }\r\n\r\n  addPresets(presets = []) {\r\n    for (const preset of presets) {\r\n      if (!this.presets.find((p) => p.id === preset.id)) this.presets.push(preset);\r\n    }\r\n    this._createIndex();\r\n    this.render(true);\r\n  }\r\n\r\n  removePreset(id) {\r\n    const presetIndex = this.presets.findIndex((p) => p.id === id);\r\n    if (presetIndex === -1) return;\r\n\r\n    const wasActivePreset = this._index[this._it]?.pI === presetIndex;\r\n\r\n    this.presets = this.presets.filter((p) => p.id !== id);\r\n    if (this.presets.length === 0) return this.close(true);\r\n\r\n    this._createIndex();\r\n\r\n    if (wasActivePreset) this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async iterate(forward = true) {\r\n    if (!this._settings.lock) {\r\n      if (this._settings.random) this._it = Math.floor(Math.random() * this._index.length);\r\n      else {\r\n        this._it += forward ? 1 : -1;\r\n        if (this._it < 0) this._it = this._index.length - 1;\r\n        else this._it %= this._index.length;\r\n      }\r\n    } else {\r\n      if (this._it === -1) this._it = 0;\r\n    }\r\n\r\n    await this._activateBrush();\r\n    this.render(true);\r\n  }\r\n\r\n  _getTransform() {\r\n    const settings = this._settings;\r\n    const transform = {};\r\n    if (settings.scale[0] === settings.scale[1]) transform.scale = settings.scale[0];\r\n    else {\r\n      const stepsInRange = (settings.scale[1] - settings.scale[0]) / 0.01;\r\n      transform.scale = Math.floor(Math.random() * stepsInRange) * 0.01 + settings.scale[0];\r\n    }\r\n\r\n    if (settings.rotation[0] === settings.rotation[1]) transform.rotation = settings.rotation[0];\r\n    else {\r\n      const stepsInRange = (settings.rotation[1] - settings.rotation[0] + 1) / 1;\r\n      transform.rotation = Math.floor(Math.random() * stepsInRange) * 1 + settings.rotation[0];\r\n    }\r\n    return transform;\r\n  }\r\n\r\n  _deactivateCallback() {\r\n    this.close(true);\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-brush-macro',\r\n      icon: 'fa-solid fa-code',\r\n      onclick: this._generateBrushMacro.bind(this),\r\n    });\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _generateBrushMacro() {\r\n    const uuids = this.presets.map((p) => p.uuid).filter(Boolean);\r\n    if (!uuids.length) return;\r\n\r\n    const command = `MassEdit.openBrushMenu({ \r\n  uuid: ${JSON.stringify(uuids, null, 4)}\r\n},\r\n${JSON.stringify(this._settings, null, 2)}\r\n);`;\r\n\r\n    const macro = await Macro.create({\r\n      name: 'Brush Macro',\r\n      type: 'script',\r\n      scope: 'global',\r\n      command,\r\n      img: `modules/${MODULE_ID}/images/brush_icon.png`,\r\n    });\r\n    macro.sheet.render(true);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    Brush.deactivate();\r\n    BrushMenu._instance = null;\r\n    Picker.destroy();\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\n/**\r\n * API method to activate the brush.\r\n * @param {Object} options See MassEdit.getPreset(...)\r\n * @param {String} mode update|spawn\r\n */\r\nexport async function activateBrush(options, mode = 'spawner') {\r\n  const preset = await PresetAPI.getPreset(options);\r\n  if (preset) {\r\n    Brush.activate({ preset, spawner: mode === 'spawner' });\r\n  }\r\n}\r\n\r\n/**\r\n * API method to de-activate the brush.\r\n */\r\nexport function deactivateBush() {\r\n  Brush.deactivate();\r\n}\r\n\r\n/**\r\n * Open Brush Menu using the provided presets\r\n * @param {Object} options See MassEdit.getPresets(...)\r\n * @param {Object} settings Brush Menu control settings\r\n */\r\nexport async function openBrushMenu(options, settings = {}) {\r\n  const presets = await PresetAPI.getPresets(options);\r\n  if (!presets?.length) return;\r\n  for (const preset of presets) await preset.load();\r\n  await BrushMenu.close();\r\n  BrushMenu.render(presets, settings);\r\n}\r\n","import { LAYER_MAPPINGS, showMassSelect } from '../applications/multiConfig.js';\r\nimport { SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES, localFormat, localize } from './utils.js';\r\n\r\nexport function showPlaceableTypeSelectDialog() {\r\n  let content = '';\r\n  for (const config of SUPPORTED_PLACEABLES.concat(SUPPORTED_COLLECTIONS)) {\r\n    content += `<option value=\"${config}\">${config}</option>`;\r\n  }\r\n  content = `<label>${localize('dialog.search-document')}</label>\r\n    <select style=\"width: 100%;\" name=\"documentName\">${content}</select>`;\r\n\r\n  new Dialog({\r\n    title: 'Document SEARCH',\r\n    content: content,\r\n    buttons: {\r\n      select: {\r\n        icon: '<i class=\"fas fa-check\"></i>',\r\n        label: 'Select',\r\n        callback: (html) => {\r\n          const documentName = html.find(\"select[name='documentName']\").val();\r\n\r\n          let docs = [];\r\n          if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n            const layer = LAYER_MAPPINGS[documentName];\r\n            if (layer && canvas[layer].placeables.length) {\r\n              docs = canvas[layer].placeables;\r\n            }\r\n          } else {\r\n            docs = Array.from(game.collections.get(documentName));\r\n          }\r\n\r\n          if (docs.length) {\r\n            showMassSelect(docs[0]);\r\n          } else {\r\n            ui.notifications.warn(localFormat('dialog.document-not-found', { document: documentName }));\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport async function importPresetFromJSONDialog() {\r\n  const content = `\r\n  <div class=\"form-group\">\r\n      <label for=\"data\">${localize('FILES.SelectFile', false)} </label>\r\n      <input type=\"file\" name=\"data\">\r\n  </div>\r\n  `;\r\n\r\n  let dialog = new Promise((resolve, reject) => {\r\n    new Dialog(\r\n      {\r\n        title: localize('presets.import'),\r\n        content: content,\r\n        buttons: {\r\n          import: {\r\n            icon: '<i class=\"fas fa-file-import\"></i>',\r\n            label: localize('common.import'),\r\n            callback: async (html) => {\r\n              let presets;\r\n              readTextFromFile(html.find('[name=\"data\"]')[0].files[0]).then((json) => {\r\n                try {\r\n                  presets = JSON.parse(json);\r\n                } catch (e) {}\r\n                resolve(presets);\r\n              });\r\n            },\r\n          },\r\n          no: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: localize('Cancel', false),\r\n            callback: () => resolve(false),\r\n          },\r\n        },\r\n        default: 'no',\r\n      },\r\n      {\r\n        width: 400,\r\n      }\r\n    ).render(true);\r\n  });\r\n  return await dialog;\r\n}\r\n","import { getPresetDataCenterOffset } from './presets/utils.js';\r\nimport { SUPPORTED_PLACEABLES } from './utils.js';\r\n\r\n/**\r\n * Cross-hair and optional preview image/label that can be activated to allow the user to select\r\n * an area on the screen.\r\n */\r\nexport class Picker {\r\n  static pickerOverlay;\r\n  static boundStart;\r\n  static boundEnd;\r\n  static callback;\r\n\r\n  static isActive() {\r\n    return Boolean(this.pickerOverlay);\r\n  }\r\n\r\n  static addRotation(rotation) {\r\n    this._rotation += rotation;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static addScaling(scale) {\r\n    this._scale += scale;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  /**\r\n   * Activates the picker overlay.\r\n   * @param {Function} callback callback function with coordinates returned as starting and ending bounds of a rectangles\r\n   *                            { start: {x1, y1}, end: {x2, y2} }\r\n   * @param {Object}  preview\r\n   * @param {String}  preview.documentName (optional) preview placeables document name\r\n   * @param {Map[String,Array]}  preview.previewData    (req) preview placeables data\r\n   * @param {String}  preview.taPreview            (optional) Designates the preview placeable when spawning a `Token Attacher` prefab.\r\n   *                                                e.g. \"Tile\", \"Tile.1\", \"MeasuredTemplate.3\"\r\n   * @param {Boolean} preview.snap                  (optional) if true returned coordinates will be snapped to grid\r\n   * @param {String}  preview.label                  (optional) preview placeables document name\r\n   */\r\n  static async activate(callback, preview) {\r\n    this.destroy();\r\n\r\n    const pickerOverlay = new PIXI.Container();\r\n    this.callback = callback;\r\n\r\n    if (preview) {\r\n      let label;\r\n      if (preview.label) {\r\n        label = new PreciseText(preview.label, { ...CONFIG.canvasTextStyle, _fontSize: 24 });\r\n        label.anchor.set(0.5, 1);\r\n        pickerOverlay.addChild(label);\r\n      }\r\n\r\n      let { previews, layer, previewDocuments } = await this._genPreviews(preview);\r\n      this._rotation = preview.rotation ?? 0;\r\n      this._scale = preview.scale ?? 1;\r\n\r\n      // Position offset to center preview over the mouse\r\n      let offset;\r\n      if (preview.center) offset = getPresetDataCenterOffset(preview.previewData);\r\n      else offset = { x: 0, y: 0 };\r\n\r\n      const setPositions = function (pos) {\r\n        if (!pos) return;\r\n        if (preview.center) offset = getPresetDataCenterOffset(preview.previewData);\r\n        if (preview.snap && layer && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT))\r\n          pos = canvas.grid.getSnappedPosition(pos.x, pos.y, layer.gridPrecision);\r\n\r\n        // calculate transform\r\n        const fpX = previews[0].document.documentName === 'Wall' ? previews[0].document.c[0] : previews[0].document.x;\r\n        const fpY = previews[0].document.documentName === 'Wall' ? previews[0].document.c[1] : previews[0].document.y;\r\n        let transform = { x: pos.x - fpX - offset.x, y: pos.y - fpY - offset.y };\r\n        if (Picker._rotation != 0) {\r\n          transform.rotation = Picker._rotation;\r\n          Picker._rotation = 0;\r\n        }\r\n        if (Picker._scale != 1) {\r\n          transform.scale = Picker._scale;\r\n          Picker._scale = 1;\r\n        }\r\n\r\n        for (const preview of previews) {\r\n          const doc = preview.document;\r\n          DataTransform.apply(doc.documentName, preview._pData ?? doc, pos, transform, preview);\r\n\r\n          // =====\r\n          // Hacks\r\n          // =====\r\n          preview.document.alpha = 0.4;\r\n          preview.renderFlags.set({ refresh: true });\r\n          preview.visible = true;\r\n\r\n          // Tile z order, to make sure previews are rendered on-top\r\n          if (!preview.z) preview.z = preview.document.z;\r\n          if (preview.z) preview.document.z = preview.z + 9999999;\r\n\r\n          if (preview.controlIcon && !preview.controlIcon._meVInsert) {\r\n            preview.controlIcon.alpha = 0.4;\r\n\r\n            // ControlIcon visibility is difficult to set and keep as true\r\n            // Lets hack it by defining a getter that always returns true\r\n            Object.defineProperty(preview.controlIcon, 'visible', {\r\n              get: function () {\r\n                return true;\r\n              },\r\n              set: function () {},\r\n            });\r\n            preview.controlIcon._meVInsert = true;\r\n          }\r\n          // End of Hacks\r\n        }\r\n\r\n        if (label) {\r\n          label.x = pos.x;\r\n          label.y = pos.y - 38;\r\n        }\r\n\r\n        pickerOverlay.previewDocuments = previewDocuments;\r\n\r\n        // Changing scaling offsets the center position\r\n        // Let's immediately reposition back to it\r\n        if (preview.center && transform.scale != null) {\r\n          setPositions(pos);\r\n        }\r\n      };\r\n\r\n      pickerOverlay.on('pointermove', (event) => {\r\n        setPositions(event.data.getLocalPosition(pickerOverlay));\r\n      });\r\n      setPositions(canvas.mousePosition);\r\n      setPositions(canvas.mousePosition);\r\n      pickerOverlay.setPositions = setPositions;\r\n    }\r\n\r\n    if (!preview.previewOnly) {\r\n      pickerOverlay.hitArea = canvas.dimensions.rect;\r\n      pickerOverlay.cursor = 'crosshair';\r\n      pickerOverlay.interactive = true;\r\n      pickerOverlay.zIndex = 5;\r\n      pickerOverlay.on('remove', () => pickerOverlay.off('pick'));\r\n      pickerOverlay.on('mousedown', (event) => {\r\n        Picker.boundStart = event.data.getLocalPosition(pickerOverlay);\r\n      });\r\n      pickerOverlay.on('mouseup', (event) => {\r\n        Picker.boundEnd = event.data.getLocalPosition(pickerOverlay);\r\n      });\r\n      pickerOverlay.on('click', (event) => {\r\n        if (event.nativeEvent.which == 2) {\r\n          this.callback?.(null);\r\n        } else {\r\n          const minX = Math.min(this.boundStart.x, this.boundEnd.x);\r\n          const maxX = Math.max(this.boundStart.x, this.boundEnd.x);\r\n          const minY = Math.min(this.boundStart.y, this.boundEnd.y);\r\n          const maxY = Math.max(this.boundStart.y, this.boundEnd.y);\r\n          this.callback?.({ start: { x: minX, y: minY }, end: { x: maxX, y: maxY } });\r\n        }\r\n        this.destroy();\r\n      });\r\n\r\n      canvas.stage.addChild(pickerOverlay);\r\n    }\r\n    this.pickerOverlay = pickerOverlay;\r\n  }\r\n\r\n  static feedPos(pos) {\r\n    this.pickerOverlay?.setPositions?.(pos);\r\n  }\r\n\r\n  static resolve(pos) {\r\n    if (this.callback) {\r\n      if (pos == null) this.callback(null);\r\n      else this.callback?.({ start: { x: pos.x, y: pos.y, z: pos.z }, end: { x: pos.x, y: pos.y, z: pos.z } });\r\n    }\r\n    this.destroy();\r\n  }\r\n\r\n  static destroy() {\r\n    if (this.pickerOverlay) {\r\n      this.pickerOverlay.parent?.removeChild(this.pickerOverlay);\r\n      if (this.pickerOverlay.previewDocuments)\r\n        this.pickerOverlay.previewDocuments.forEach((name) =>\r\n          canvas.getLayerByEmbeddedName(name)?.clearPreviewContainer()\r\n        );\r\n\r\n      this.pickerOverlay.destroy(true);\r\n      this.pickerOverlay.children?.forEach((c) => c.destroy(true));\r\n      this.callback?.(null);\r\n      this.pickerOverlay = null;\r\n    }\r\n    this.callback = null;\r\n  }\r\n\r\n  // Modified Foundry _createPreview\r\n  // Does not throw warning if user lacks document create permissions\r\n  static async _createPreview(createData) {\r\n    const documentName = this.constructor.documentName;\r\n    const cls = getDocumentClass(documentName);\r\n    createData._id = foundry.utils.randomID(); // Needed to allow rendering of multiple previews at the same time\r\n    const document = new cls(createData, { parent: canvas.scene });\r\n\r\n    const object = new CONFIG[documentName].objectClass(document);\r\n    this.preview.addChild(object);\r\n    await object.draw();\r\n\r\n    return object;\r\n  }\r\n\r\n  static async _genPreviews(preview) {\r\n    if (!preview.previewData) return { previews: [] };\r\n\r\n    const previewDocuments = new Set();\r\n    const previews = [];\r\n    const transform = {};\r\n\r\n    for (const [documentName, dataArr] of preview.previewData.entries()) {\r\n      const layer = canvas.getLayerByEmbeddedName(documentName);\r\n      for (const data of dataArr) {\r\n        // Create Preview\r\n        const previewObject = await this._createPreview.call(layer, deepClone(data));\r\n        previewObject._pData = data;\r\n        previews.push(previewObject);\r\n        previewDocuments.add(documentName);\r\n\r\n        // Set initial transform which will set first preview to (0, 0) and all others relative to it\r\n        if (transform.x == null) {\r\n          if (documentName === 'Wall') {\r\n            transform.x = -previewObject.document.c[0];\r\n            transform.y = -previewObject.document.c[1];\r\n          } else {\r\n            transform.x = -previewObject.document.x;\r\n            transform.y = -previewObject.document.y;\r\n          }\r\n        }\r\n\r\n        if (preview.taPreview && documentName === 'Token') {\r\n          const documentNames = await this._genTAPreviews(data, preview.taPreview, previewObject, previews);\r\n          documentNames.forEach((dName) => previewDocuments.add(dName));\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const preview of previews) {\r\n      const doc = preview.document;\r\n      DataTransform.apply(doc.documentName, preview._pData ?? doc, { x: 0, y: 0 }, transform, preview);\r\n    }\r\n    return { previews, layer: canvas.getLayerByEmbeddedName(preview.documentName), previewDocuments };\r\n  }\r\n\r\n  static _parseTAPreview(taPreview, attached) {\r\n    if (taPreview === 'ALL') return attached;\r\n\r\n    const attachedData = {};\r\n    taPreview = taPreview.split(',');\r\n\r\n    for (const taIndex of taPreview) {\r\n      let [name, index] = taIndex.trim().split('.');\r\n      if (!attached[name]) continue;\r\n\r\n      if (index == null) {\r\n        attachedData[name] = attached[name];\r\n      } else {\r\n        if (attached[name][index]) {\r\n          if (!attachedData[name]) attachedData[name] = [];\r\n          attachedData[name].push(attached[name][index]);\r\n        }\r\n      }\r\n    }\r\n\r\n    return attachedData;\r\n  }\r\n\r\n  static async _genTAPreviews(data, taPreview, parent, previews) {\r\n    if (!game.modules.get('token-attacher')?.active) return [];\r\n\r\n    const attached = getProperty(data, 'flags.token-attacher.prototypeAttached');\r\n    const pos = getProperty(data, 'flags.token-attacher.pos');\r\n    const grid = getProperty(data, 'flags.token-attacher.grid');\r\n\r\n    if (!(attached && pos && grid)) return [];\r\n\r\n    const documentNames = new Set();\r\n\r\n    const ratio = canvas.grid.size / grid.size;\r\n    const attachedData = this._parseTAPreview(taPreview, attached);\r\n\r\n    for (const [name, dataList] of Object.entries(attachedData)) {\r\n      for (let data of dataList) {\r\n        if (['Token', 'Tile', 'Drawing'].includes(name)) {\r\n          data.width *= ratio;\r\n          data.height *= ratio;\r\n        }\r\n\r\n        const taPreviewObject = await this._createPreview.call(canvas.getLayerByEmbeddedName(name), data);\r\n        documentNames.add(name);\r\n        previews.push(taPreviewObject);\r\n\r\n        const doc = taPreviewObject.document;\r\n        if (name === 'Wall') {\r\n          doc.c[0] = parent.document.x + (data.c[0] - pos.xy.x) * ratio;\r\n          doc.c[1] = parent.document.y + (data.c[1] - pos.xy.y) * ratio;\r\n          doc.c[2] = parent.document.x + (data.c[2] - pos.xy.x) * ratio;\r\n          doc.c[3] = parent.document.y + (data.c[3] - pos.xy.y) * ratio;\r\n        } else {\r\n          doc.x = parent.document.x + (data.x - pos.xy.x) * ratio;\r\n          doc.y = parent.document.y + (data.y - pos.xy.y) * ratio;\r\n        }\r\n      }\r\n    }\r\n\r\n    return documentNames;\r\n  }\r\n}\r\n\r\nexport class DataTransform {\r\n  /**\r\n   * Transform placeable data and optionally an accompanying preview with the provided delta transform\r\n   * @param {String} docName\r\n   * @param {Object} data\r\n   * @param {Object} origin\r\n   * @param {Object} transform\r\n   * @param {PlaceableObject} preview\r\n   */\r\n  static apply(docName, data, origin, transform, preview) {\r\n    if (transform.x == null) transform.x = 0;\r\n    if (transform.y == null) transform.y = 0;\r\n\r\n    if (docName === 'Wall') {\r\n      this.transformWall(data, origin, transform, preview);\r\n    } else if (docName === 'Tile') {\r\n      this.transformTile(data, origin, transform, preview);\r\n    } else if (docName == 'Note') {\r\n      this.transformNote(data, origin, transform, preview);\r\n    } else if (docName === 'Token') {\r\n      this.transformToken(data, origin, transform, preview);\r\n    } else if (docName === 'MeasuredTemplate') {\r\n      this.transformMeasuredTemplate(data, origin, transform, preview);\r\n    } else if (docName === 'AmbientLight') {\r\n      this.transformAmbientLight(data, origin, transform, preview);\r\n    } else if (docName === 'AmbientSound') {\r\n      this.transformAmbientSound(data, origin, transform, preview);\r\n    } else if (docName === 'Drawing') {\r\n      this.transformDrawing(data, origin, transform, preview);\r\n    } else {\r\n      data.x += transform.x;\r\n      data.y += transform.y;\r\n      if (preview) {\r\n        preview.document.x = data.x;\r\n        preview.document.y = data.y;\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformNote(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (preview) {\r\n      preview.document.x = data.x;\r\n      preview.document.y = data.y;\r\n    }\r\n  }\r\n\r\n  static transformAmbientSound(data, origin, transform, preview) {\r\n    // 3D support\r\n    const bottom = data.flags?.levels?.rangeBottom;\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.radius *= scale;\r\n      }\r\n      // 3D Support\r\n      if (bottom != null && bottom != '') {\r\n        data.flags.levels.rangeBottom *= scale;\r\n        data.flags.levels.rangeTop *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      setProperty(data, 'flags.levels.rangeBottom', (bottom ?? 0) + transform.z);\r\n      setProperty(data, 'flags.levels.rangeTop', (bottom ?? 0) + transform.z);\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.radius = data.radius;\r\n    }\r\n  }\r\n\r\n  static transformWall(data, origin, transform, preview) {\r\n    const c = deepClone(data.c);\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      c[0] *= scale;\r\n      c[1] *= scale;\r\n      c[2] *= scale;\r\n      c[3] *= scale;\r\n    }\r\n\r\n    c[0] += transform.x;\r\n    c[1] += transform.y;\r\n    c[2] += transform.x;\r\n    c[3] += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [c[0], c[1]] = this.rotatePoint(origin.x, origin.y, c[0], c[1], dr);\r\n      [c[2], c[3]] = this.rotatePoint(origin.x, origin.y, c[2], c[3], dr);\r\n    }\r\n\r\n    data.c = c;\r\n    if (preview) preview.document.c = c;\r\n  }\r\n\r\n  static transformMeasuredTemplate(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.distance *= scale;\r\n        if (data.width) data.width *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.direction += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.direction = data.direction;\r\n      doc.distance = data.distance;\r\n      doc.width = data.width;\r\n    }\r\n  }\r\n\r\n  static transformAmbientLight(data, origin, transform, preview) {\r\n    // 3D support\r\n    const bottom = data.flags?.levels?.rangeBottom;\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.config.dim *= scale;\r\n        data.config.bright *= scale;\r\n      }\r\n      // 3D Support\r\n      if (bottom != null && bottom != '') {\r\n        data.flags.levels.rangeBottom *= scale;\r\n        data.flags.levels.rangeTop *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      setProperty(data, 'flags.levels.rangeBottom', (bottom ?? 0) + transform.z);\r\n      setProperty(data, 'flags.levels.rangeTop', (bottom ?? 0) + transform.z);\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.rotation = data.rotation;\r\n      doc.config.dim = data.config.dim;\r\n      doc.config.bright = data.config.bright;\r\n    }\r\n  }\r\n\r\n  static transformTile(data, origin, transform, preview) {\r\n    // 3D support\r\n    const depth = data.flags?.['levels-3d-preview']?.depth;\r\n    const bottom = data.flags?.levels?.rangeBottom;\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.width *= scale;\r\n      data.height *= scale;\r\n\r\n      // 3D Support\r\n      if (depth != null && depth != '') data.flags['levels-3d-preview'].depth *= scale;\r\n      if (bottom != null && bottom != '') {\r\n        data.flags.levels.rangeBottom *= scale;\r\n        data.flags.levels.rangeTop *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      setProperty(data, 'flags.levels.rangeBottom', (bottom ?? 0) + transform.z);\r\n      setProperty(data, 'flags.levels.rangeTop', (bottom ?? 0) + transform.z);\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.width / 2, y: data.y + data.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.width / 2;\r\n      data.y = rectCenter.y - data.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n      doc.rotation = data.rotation;\r\n    }\r\n  }\r\n\r\n  static transformDrawing(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.shape.width *= scale;\r\n      data.shape.height *= scale;\r\n      if (data.shape.points) {\r\n        const points = data.shape.points;\r\n        for (let i = 0; i < points.length; i++) {\r\n          points[i] *= scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.shape.width / 2, y: data.y + data.shape.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.shape.width / 2;\r\n      data.y = rectCenter.y - data.shape.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.shape.width = data.shape.width;\r\n      doc.shape.height = data.shape.height;\r\n      doc.shape.points = data.shape.points;\r\n      doc.rotation = data.rotation;\r\n    }\r\n  }\r\n\r\n  static transformToken(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.width *= scale;\r\n        data.height *= scale;\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    data.elevation += transform.z ?? 0;\r\n\r\n    const grid = canvas.grid;\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + (data.width * grid.w) / 2, y: data.y + (data.height * grid.h) / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - (data.width * grid.w) / 2;\r\n      data.y = rectCenter.y - (data.height * grid.h) / 2;\r\n      data.rotation = (data.rotation + Math.toDegrees(dr)) % 360;\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.elevation = data.elevation;\r\n      doc.rotation = data.rotation;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rotates one point around the other\r\n   * @param {Number} x pivot point\r\n   * @param {Number} y pivot point\r\n   * @param {Number} x2 point to be rotated\r\n   * @param {Number} y2 point to be rotated\r\n   * @param {Number} rot rotation in radians\r\n   * @returns\r\n   */\r\n  static rotatePoint(x, y, x2, y2, rot) {\r\n    const dx = x2 - x,\r\n      dy = y2 - y;\r\n    return [x + Math.cos(rot) * dx - Math.sin(rot) * dy, y + Math.sin(rot) * dx + Math.cos(rot) * dy];\r\n  }\r\n}\r\n\r\nexport async function editPreviewPlaceables() {\r\n  const docToPlaceables = new Map();\r\n\r\n  SUPPORTED_PLACEABLES.forEach((docName) => {\r\n    const controlled = canvas.getLayerByEmbeddedName(docName).controlled;\r\n    if (controlled.length) {\r\n      docToPlaceables.set(\r\n        docName,\r\n        controlled.map((p) => p)\r\n      );\r\n    }\r\n  });\r\n\r\n  if (!docToPlaceables.size) {\r\n    // Activate picker to define select box\r\n    const coords = await new Promise(async (resolve) => {\r\n      Picker.activate(resolve);\r\n    });\r\n    if (!coords) return;\r\n\r\n    // Selects placeables within the bounding box\r\n    const selectionRect = new PIXI.Rectangle(\r\n      coords.start.x,\r\n      coords.start.y,\r\n      coords.end.x - coords.start.x,\r\n      coords.end.y - coords.start.y\r\n    );\r\n\r\n    SUPPORTED_PLACEABLES.forEach((docName) => {\r\n      let insideRect = [];\r\n      canvas.getLayerByEmbeddedName(docName).placeables.forEach((p) => {\r\n        const c = p.center;\r\n        if (selectionRect.contains(c.x, c.y)) insideRect.push(p);\r\n      });\r\n      if (insideRect.length) docToPlaceables.set(docName, insideRect);\r\n    });\r\n  }\r\n\r\n  if (!docToPlaceables.size) return;\r\n\r\n  // Generate data from the selected placeables and pass them to Picker to create previews\r\n  const docToData = new Map();\r\n  const originalDocTolData = new Map();\r\n\r\n  let mainDocName;\r\n  docToPlaceables.forEach((placeables, documentName) => {\r\n    if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n      let data = placeables.map((p) => p.document.toCompendium(null, { keepId: true }));\r\n\r\n      if (\r\n        documentName === 'Token' &&\r\n        game.modules.get('token-attacher')?.active &&\r\n        tokenAttacher?.generatePrototypeAttached\r\n      ) {\r\n        for (const d of data) {\r\n          const attached = d.flags?.['token-attacher']?.attached || {};\r\n          if (!foundry.utils.isEmpty(attached)) {\r\n            const prototypeAttached = tokenAttacher.generatePrototypeAttached(d, attached);\r\n            setProperty(d, 'flags.token-attacher.attached', null);\r\n            setProperty(d, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n            setProperty(d, 'flags.token-attacher.grid', {\r\n              size: canvas.grid.size,\r\n              w: canvas.grid.w,\r\n              h: canvas.grid.h,\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      docToData.set(documentName, data);\r\n      originalDocTolData.set(documentName, deepClone(data));\r\n      if (!mainDocName) mainDocName = documentName;\r\n    }\r\n  });\r\n\r\n  if (!docToData.size) return;\r\n\r\n  Picker.activate(\r\n    async (coords) => {\r\n      if (coords == null) return;\r\n\r\n      docToData.forEach((data, documentName) => {\r\n        let updates = [];\r\n\r\n        const originalData = originalDocTolData.get(documentName);\r\n        for (let i = 0; i < originalData.length; i++) {\r\n          const diff = foundry.utils.diffObject(originalData[i], data[i]);\r\n          if (!foundry.utils.isEmpty(diff)) {\r\n            diff._id = originalData[i]._id;\r\n            delete diff.flags;\r\n            updates.push(diff);\r\n          }\r\n        }\r\n        if (updates.length) canvas.scene.updateEmbeddedDocuments(documentName, updates);\r\n      });\r\n    },\r\n    {\r\n      documentName: mainDocName,\r\n      previewData: docToData,\r\n      snap: true,\r\n      taPreview: 'ALL',\r\n      center: true,\r\n    }\r\n  );\r\n}\r\n","import { checkApplySpecialFields } from '../../applications/forms.js';\r\nimport { Brush } from '../brush.js';\r\nimport { DataTransform, Picker } from '../picker.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport {\r\n  MODULE_ID,\r\n  SUPPORTED_PLACEABLES,\r\n  SeededRandom,\r\n  UI_DOCS,\r\n  applyPresetToScene,\r\n  createDocuments,\r\n  executeScript,\r\n  localize,\r\n} from '../utils.js';\r\nimport { Preset } from './preset.js';\r\nimport {\r\n  FolderState,\r\n  getPresetDataCenterOffset,\r\n  getTransformToOrigin,\r\n  mergePresetDataToDefaultDoc,\r\n  modifySpawnData,\r\n  placeableToData,\r\n} from './utils.js';\r\n\r\nexport const DEFAULT_PACK = 'world.mass-edit-presets-main';\r\nexport const META_INDEX_ID = 'MassEditMetaData';\r\nexport const META_INDEX_FIELDS = ['id', 'img', 'documentName', 'tags'];\r\n\r\nexport class PresetCollection {\r\n  static presets;\r\n\r\n  static workingPack;\r\n\r\n  static async getTree(type, mainOnly = false) {\r\n    let pack;\r\n    let mainTree;\r\n    try {\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await this.packToTree(pack, type);\r\n    } catch (e) {\r\n      // Fail-safe. Return back to DEFAULT_PACK\r\n      console.log(e);\r\n      console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`);\r\n      console.log('RETURNING TO DEFAULT');\r\n      await game.settings.set(MODULE_ID, 'workingPack', DEFAULT_PACK);\r\n      this.workingPack = DEFAULT_PACK;\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await this.packToTree(pack, type);\r\n    }\r\n\r\n    const extFolders = [];\r\n\r\n    if (!mainOnly) {\r\n      for (const p of game.packs) {\r\n        if (p.collection !== this.workingPack && p.index.get(META_INDEX_ID)) {\r\n          const tree = await this.packToTree(p, type);\r\n          if (!tree.hasVisible) continue;\r\n\r\n          const topFolder = new PresetPackFolder({ pack: p, tree });\r\n          extFolders.push(topFolder);\r\n\r\n          // Collate all folders with the main tree\r\n          mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n          for (const [uuid, folder] of tree.allFolders) {\r\n            mainTree.allFolders.set(uuid, folder);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    mainTree.extFolders = this._groupExtFolders(extFolders, mainTree.allFolders);\r\n\r\n    return mainTree;\r\n  }\r\n\r\n  static async packToTree(pack, type) {\r\n    if (!pack) return null;\r\n\r\n    if (CONFIG.debug.MassEdit) console.time(pack.title);\r\n\r\n    // Setup folders ready for parent/children processing\r\n    const folders = new Map();\r\n    const topLevelFolders = new Map();\r\n    const folderContents = pack.folders.contents;\r\n    for (const f of folderContents) {\r\n      const folder = new PresetFolder({\r\n        id: f._id,\r\n        uuid: f.uuid,\r\n        name: f.name,\r\n        sorting: f.sorting,\r\n        color: f.color,\r\n        sort: f.sort,\r\n        draggable: f.pack === this.workingPack,\r\n        folder: f.folder?.uuid,\r\n        visible: type ? (f.flags[MODULE_ID]?.types || ['ALL']).includes(type) : true,\r\n      });\r\n      folders.set(folder.uuid, folder);\r\n      topLevelFolders.set(f.uuid, folder);\r\n    }\r\n\r\n    // If folders have parent folders add them as children and remove them as a top level folder\r\n    for (const f of folderContents) {\r\n      if (f.folder) {\r\n        const parent = folders.get(f.folder.uuid);\r\n        parent.children.push(folders.get(f.uuid));\r\n        topLevelFolders.delete(f.uuid);\r\n      }\r\n    }\r\n\r\n    // Process presets\r\n    const allPresets = [];\r\n    const topLevelPresets = [];\r\n    let hasVisible = false; // tracks whether there exists at least one visible preset within this tree\r\n    const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n    let metaIndex = metaDoc?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n\r\n    // TEMP - 06/03/2024\r\n    // Due to poor implementation of Folder+Folder Content delete, there are likely to be some indexes which were not removed\r\n    // Lets clean them up here for now\r\n    PresetCollection._cleanIndex(pack, metaDoc, metaIndex);\r\n    // Remove after sufficient enough time has passed to have reasonable confidence that All/Most users have executed this ^\r\n\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n\r\n      // If no document name is available (missing metadata) attempt to load the preset to retrieve it\r\n      // If still no name is found, skip it\r\n      if (!preset.documentName) {\r\n        console.log(`Missing MetaData. Attempting document load: ${preset.id} | ${preset.name}`);\r\n        await preset.load();\r\n        if (!preset.documentName) continue;\r\n        if (!pack.locked) preset._updateIndex(preset); // Insert missing preset into metadata index\r\n      }\r\n\r\n      if (type) {\r\n        if (type === 'ALL') {\r\n          if (!UI_DOCS.includes(preset.documentName)) preset._visible = false;\r\n        } else if (type === 'FAVORITES') {\r\n          if (!preset.isFavorite) preset._visible = false;\r\n        } else if (preset.documentName !== type) preset._visible = false;\r\n      }\r\n\r\n      if (preset.folder) {\r\n        let matched = false;\r\n        for (const [uuid, folder] of folders) {\r\n          if (folder.id === preset.folder) {\r\n            folder.presets.push(preset);\r\n            matched = true;\r\n            if (type === 'FAVORITES' && preset.isFavorite) this._setChildAndParentFoldersVisible(folder, folders);\r\n            break;\r\n          }\r\n        }\r\n        if (!matched) topLevelPresets.push(preset);\r\n      } else topLevelPresets.push(preset);\r\n\r\n      allPresets.push(preset);\r\n      hasVisible |= preset._visible;\r\n    }\r\n\r\n    // Sort folders\r\n    const sorting = game.settings.get(MODULE_ID, 'presetSortMode') === 'manual' ? 'm' : 'a';\r\n    const sortedFolders = this._sortFolders(Array.from(topLevelFolders.values()), sorting);\r\n    const sortedPresets = this._sortPresets(topLevelPresets, sorting);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n\r\n    return {\r\n      folders: sortedFolders,\r\n      presets: sortedPresets,\r\n      allPresets,\r\n      allFolders: folders,\r\n      hasVisible,\r\n      metaDoc,\r\n    };\r\n  }\r\n\r\n  static _setChildAndParentFoldersVisible(folder, folders) {\r\n    folder.visible = true;\r\n    if (folder.folder) this._setChildAndParentFoldersVisible(folders.get(folder.folder), folders);\r\n  }\r\n\r\n  static _groupExtFolders(folders, allFolders) {\r\n    folders = folders.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n\r\n    const groups = {};\r\n    const groupless = [];\r\n    folders.forEach((f) => {\r\n      if (f.group) {\r\n        if (!(f.group in groups)) groups[f.group] = [];\r\n        groups[f.group].push(f);\r\n      } else {\r\n        groupless.push(f);\r\n      }\r\n    });\r\n\r\n    const newExtFolders = [];\r\n    for (const [group, folders] of Object.entries(groups)) {\r\n      const id = SeededRandom.randomID(group); // For export operation a real ID is needed. Lets keep it consistent by seeding\r\n      const uuid = 'virtual.' + group; // faux uuid\r\n\r\n      const groupFolder = new PresetVirtualFolder({\r\n        id,\r\n        uuid,\r\n        name: group,\r\n        children: folders,\r\n        draggable: false,\r\n      });\r\n\r\n      allFolders.set(uuid, groupFolder);\r\n      newExtFolders.push(groupFolder);\r\n    }\r\n\r\n    return newExtFolders.concat(groupless).sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n  }\r\n\r\n  // Fixing meta index by removing loose indexes\r\n  // 06/03/2024\r\n  static async _cleanIndex(pack, metaDoc, metaIndex) {\r\n    if (pack.locked || !metaDoc || foundry.utils.isEmpty(metaIndex)) return;\r\n    const index = pack.index;\r\n\r\n    const update = {};\r\n    for (const idx of Object.keys(metaIndex)) {\r\n      if (!index.has(idx)) update['-=' + idx] = null;\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(update)) metaDoc.setFlag(MODULE_ID, 'index', update);\r\n  }\r\n\r\n  static _sortFolders(folders, sorting = 'a') {\r\n    for (const folder of folders) {\r\n      folder.children = this._sortFolders(folder.children, folder.sorting);\r\n      folder.presets = this._sortPresets(folder.presets, folder.sorting);\r\n    }\r\n\r\n    if (sorting === 'a') return folders.sort((f1, f2) => f1.name.localeCompare(f2.name, 'en', { numeric: true }));\r\n    else return folders.sort((f1, f2) => f1.sort - f2.sort);\r\n  }\r\n\r\n  static _sortPresets(presets, sorting = 'a') {\r\n    if (sorting === 'a') return presets.sort((p1, p2) => p1.name.localeCompare(p2.name, 'en', { numeric: true }));\r\n    else return presets.sort((p1, p2) => p1.sort - p2.sort);\r\n  }\r\n\r\n  static async packToPresets(pack) {\r\n    if (!pack) return [];\r\n\r\n    const presets = [];\r\n\r\n    let metaIndex = (await pack.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  static async update(preset) {\r\n    const compendium = await this._initCompendium(this.workingPack);\r\n    const doc = await compendium.getDocument(preset.id);\r\n    const updateDoc = {\r\n      name: preset.name,\r\n      flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n    };\r\n    const pages = preset.pages;\r\n    if (pages) updateDoc.pages = pages;\r\n    await doc.update(updateDoc);\r\n\r\n    const metaDoc = await this._initMetaDocument(this.workingPack);\r\n    const update = {};\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n  }\r\n\r\n  /**\r\n   * Update multiple presets at the same time\r\n   * @param {*} updates\r\n   */\r\n  static async updatePresets(updates) {\r\n    // TODO update meta and preset itself\r\n    await JournalEntry.updateDocuments(updates, { pack: this.workingPack });\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async set(preset, pack) {\r\n    if (!pack) pack = this.workingPack;\r\n\r\n    if (preset instanceof Array) {\r\n      for (const p of preset) {\r\n        await PresetCollection.set(p, pack);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const compendium = await this._initCompendium(pack);\r\n    if (compendium.index.get(preset.id)) {\r\n      await this.update(preset);\r\n      return;\r\n    }\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: preset.id,\r\n          name: preset.name,\r\n          pages: preset.pages ?? [],\r\n          folder: preset.folder,\r\n          flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n\r\n    preset.uuid = documents[0].uuid;\r\n    preset.document = documents[0];\r\n\r\n    const metaDoc = await this._initMetaDocument(pack);\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n  }\r\n\r\n  static async get(uuid, { full = true } = {}) {\r\n    let { collection, documentId, documentType, embedded, doc } = foundry.utils.parseUuid(uuid);\r\n    const index = collection.index.get(documentId);\r\n\r\n    if (index) {\r\n      const metaIndex = (await collection.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n      const mIndex = metaIndex[index._id];\r\n\r\n      const preset = new Preset({ ...index, ...mIndex, pack: collection.collection });\r\n      if (full) await preset.load();\r\n      return preset;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async delete(presets) {\r\n    if (!presets) return;\r\n    if (!(presets instanceof Array)) presets = [presets];\r\n\r\n    // Sort by compendium\r\n    const sorted = {};\r\n    for (const preset of presets) {\r\n      let { collection } = foundry.utils.parseUuid(preset.uuid);\r\n      collection = collection.collection;\r\n      if (!sorted[collection]) sorted[collection] = [preset];\r\n      else sorted[collection].push(preset);\r\n    }\r\n\r\n    for (const pack of Object.keys(sorted)) {\r\n      const compendium = await game.packs.get(pack);\r\n      if (!compendium) continue;\r\n\r\n      const metaDoc = await this._initMetaDocument(pack);\r\n      const metaUpdate = {};\r\n\r\n      const deleteIds = [];\r\n      for (const preset of sorted[pack]) {\r\n        deleteIds.push(preset.id);\r\n        metaUpdate['-=' + preset.id] = null;\r\n      }\r\n\r\n      await JournalEntry.deleteDocuments(deleteIds, { pack });\r\n      metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n    }\r\n  }\r\n\r\n  static async _initCompendium(pack) {\r\n    let compendium = game.packs.get(pack);\r\n    if (!compendium && pack === DEFAULT_PACK) {\r\n      compendium = await CompendiumCollection.createCompendium({\r\n        label: 'Mass Edit: Presets (MAIN)',\r\n        type: 'JournalEntry',\r\n        ownership: {\r\n          GAMEMASTER: 'NONE',\r\n          PLAYER: 'NONE',\r\n          ASSISTANT: 'NONE',\r\n        },\r\n        packageType: 'world',\r\n      });\r\n\r\n      await this._initMetaDocument(pack);\r\n    }\r\n\r\n    return compendium;\r\n  }\r\n\r\n  static async _initMetaDocument(pack) {\r\n    const compendium = game.packs.get(pack);\r\n    const metaDoc = await compendium.getDocument(META_INDEX_ID);\r\n    if (metaDoc) return metaDoc;\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: META_INDEX_ID,\r\n          name: '!!! METADATA: DO NOT DELETE !!!',\r\n          flags: { [MODULE_ID]: { index: {} } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n    return documents[0];\r\n  }\r\n\r\n  static async deleteFolder(uuid, deleteAll = false) {\r\n    const folderDoc = await fromUuid(uuid);\r\n    if (folderDoc.compendium.locked) return;\r\n\r\n    if (deleteAll) {\r\n      const metaDoc = folderDoc.compendium.get(META_INDEX_ID);\r\n      if (!metaDoc) return;\r\n\r\n      const metaUpdate = {};\r\n      const traverseFolder = function (folder) {\r\n        folder.contents.forEach((j) => (metaUpdate['-=' + j._id] = null));\r\n        folder.children.forEach((c) => traverseFolder(c.folder));\r\n      };\r\n      traverseFolder(folderDoc);\r\n\r\n      metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n    }\r\n\r\n    return await folderDoc.delete({ deleteSubfolders: deleteAll, deleteContents: deleteAll });\r\n  }\r\n\r\n  static _searchPresetTree(tree, options) {\r\n    const presets = [];\r\n\r\n    if (!options.folder) this._searchPresetList(tree.allPresets, presets, options);\r\n    tree.allFolders.forEach((folder) => this._searchPresetFolder(folder, presets, options));\r\n\r\n    return presets;\r\n  }\r\n\r\n  static _searchPresetFolder(folder, presets, options) {\r\n    if (options.folder && folder.name !== options.folder) return;\r\n    this._searchPresetList(folder.presets, presets, options, folder.name);\r\n  }\r\n\r\n  static _searchPresetList(toSearch, presets, { name, type, tags } = {}, folderName) {\r\n    for (const preset of toSearch) {\r\n      let match = true;\r\n      if (name && name !== preset.name) match = false;\r\n      if (type && type !== preset.documentName) match = false;\r\n      if (match && tags) {\r\n        if (tags.matchAny) match = tags.tags.some((t) => preset.tags.includes(t));\r\n        else match = tags.tags.every((t) => preset.tags.includes(t));\r\n      }\r\n\r\n      if (match) presets.push(preset);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build preset index for 'Spotlight Omnisearch' module\r\n   * @param {Array[CONFIG.SpotlightOmnisearch.SearchTerm]} soIndex\r\n   */\r\n  static async buildSpotlightOmnisearchIndex(soIndex) {\r\n    const tree = await PresetCollection.getTree();\r\n\r\n    const SearchTerm = CONFIG.SpotlightOmnisearch.SearchTerm;\r\n\r\n    const onClick = async function () {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        ui.spotlightOmnisearch?.setDraggingState(true);\r\n        await PresetAPI.spawnPreset({\r\n          preset: this.data,\r\n          coordPicker: true,\r\n          taPreview: 'ALL',\r\n          scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n        });\r\n        ui.spotlightOmnisearch?.setDraggingState(false);\r\n      }\r\n    };\r\n\r\n    const onDragEnd = function (event) {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        const { x, y } = canvas.canvasCoordinatesFromClient({ x: event.clientX, y: event.clientY });\r\n        PresetAPI.spawnPreset({\r\n          preset: this.data,\r\n          x,\r\n          y,\r\n          scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n        });\r\n      } else if (this.data.documentName === 'Scene') {\r\n        applyPresetToScene(this.data);\r\n      }\r\n    };\r\n\r\n    const deactivateCallback = function () {\r\n      ui.spotlightOmnisearch?.setDraggingState(false);\r\n    };\r\n\r\n    const getActions = function () {\r\n      const actions = [\r\n        {\r\n          name: 'MassEdit.presets.open-journal',\r\n          icon: '<i class=\"fas fa-book-open fa-fw\"></i>',\r\n          callback: () => {\r\n            this.data.openJournal();\r\n          },\r\n        },\r\n      ];\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        actions.push({\r\n          name: `MassEdit.presets.controls.activate-brush`,\r\n          icon: '<i class=\"fas fa-paint-brush\"></i>',\r\n          callback: async () => {\r\n            canvas.getLayerByEmbeddedName(this.data.documentName)?.activate();\r\n            if (Brush.activate({ preset: await this.data.load(), deactivateCallback })) {\r\n              ui.spotlightOmnisearch.setDraggingState(true);\r\n            }\r\n          },\r\n        });\r\n      }\r\n      return actions;\r\n    };\r\n\r\n    const buildTerm = function (preset) {\r\n      soIndex.push(\r\n        new SearchTerm({\r\n          name: preset.name,\r\n          description: 'Mass Edit: Preset',\r\n          type: preset.documentName + ' preset',\r\n          img: preset.img,\r\n          icon: ['fa-solid fa-books', preset.icon],\r\n          keywords: preset.tags,\r\n          onClick,\r\n          onDragEnd,\r\n          data: preset,\r\n          actions: getActions,\r\n        })\r\n      );\r\n    };\r\n\r\n    tree.presets.forEach(buildTerm);\r\n    tree.allFolders.forEach((f) => f.presets.forEach(buildTerm));\r\n  }\r\n}\r\n\r\nexport class PresetAPI {\r\n  static name = 'PresetAPI';\r\n\r\n  /**\r\n   * Retrieve preset\r\n   * @param {object} [options={}]\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Tags to match a preset against. Can be provided as an object containing 'tags' array and 'match' any flag.\r\n   *                                                     Comma separated string, or a list of strings. In the latter 2 case 'matchAny' is assumed true\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {Boolean} [options.random]                   If multiple presets are found a random one will be chosen\r\n   * @returns {Preset}\r\n   */\r\n  static async getPreset({ uuid, name, type, folder, tags, random = false } = {}) {\r\n    if (uuid) return await PresetCollection.get(uuid);\r\n    else if (!name && !type && !folder && !tags)\r\n      throw Error('UUID, Name, Type, and/or Folder required to retrieve a Preset.');\r\n\r\n    if (tags) {\r\n      if (Array.isArray(tags)) tags = { tags, matchAny: true };\r\n      else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny: true };\r\n    }\r\n\r\n    const presets = PresetCollection._searchPresetTree(await PresetCollection.getTree(), {\r\n      name,\r\n      type,\r\n      folder,\r\n      tags,\r\n    });\r\n\r\n    const preset = random ? presets[Math.floor(Math.random() * presets.length)] : presets[0];\r\n    return preset?.clone().load();\r\n  }\r\n\r\n  /**\r\n   * Retrieve presets\r\n   * @param {object} [options={}]\r\n   * @param {String|Array[String]} [options.uuid]        Preset UUID/s\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {String|Array[String]|Object} [options.tags] See PresetAPI.getPreset\r\n   * @param {String} [options.format]                    The form to return placeables in ('preset', 'name', 'nameAndFolder')\r\n   * @returns {Array[Preset]|Array[String]|Array[Object]}\r\n   */\r\n  static async getPresets({ uuid, name, type, folder, format = 'preset', tags } = {}) {\r\n    let presets;\r\n    if (uuid) {\r\n      presets = [];\r\n      const uuids = Array.isArray(uuid) ? uuid : [uuid];\r\n      for (const uuid of uuids) {\r\n        const preset = await PresetCollection.get(uuid);\r\n        if (preset) presets.push(preset);\r\n      }\r\n    } else if (!name && !type && !folder && !tags) {\r\n      throw Error('UUID, Name, Type, Folder and/or Tags required to retrieve a Preset.');\r\n    } else {\r\n      if (tags) {\r\n        if (Array.isArray(tags)) tags = { tags, matchAny: true };\r\n        else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny: true };\r\n      }\r\n\r\n      presets = PresetCollection._searchPresetTree(await PresetCollection.getTree(), {\r\n        name,\r\n        type,\r\n        folder,\r\n        tags,\r\n      });\r\n    }\r\n\r\n    if (format === 'name') return presets.map((p) => p.name);\r\n    else if (format === 'nameAndFolder')\r\n      return presets.map((p) => {\r\n        return { name: p.name, folder: p._folderName };\r\n      });\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Create a Token preset from the provided Actor\r\n   */\r\n  static async createPresetFromActor(actor, { keepId = false, folder } = {}) {\r\n    if (!actor || actor.documentName !== 'Actor') return;\r\n\r\n    const presetData = {\r\n      id: keepId ? actor.id : null,\r\n      name: actor.name,\r\n      documentName: 'Token',\r\n      img: actor.img,\r\n      data: [actor.prototypeToken.toJSON()],\r\n      folder: folder,\r\n    };\r\n\r\n    presetData.gridSize = canvas.scene.grid.size;\r\n\r\n    const preset = new Preset(presetData);\r\n    await PresetCollection.set(preset);\r\n    return preset;\r\n  }\r\n\r\n  static async createPresetFromActorUuid(uuid, options = {}) {\r\n    const actor = await fromUuid(uuid);\r\n    if (!actor.documentName === 'Actor') return;\r\n\r\n    return await this.createPresetFromActor(actor, options);\r\n  }\r\n\r\n  /**\r\n   * Create Presets from passed in placeables\r\n   * @param {PlaceableObject|Array[PlaceableObject]} placeables Placeable/s to create the presets from.\r\n   * @param {object} [options={}]                               Optional Preset information\r\n   * @param {String} [options.name]                             Preset name\r\n   * @param {String} [options.img]                              Preset thumbnail image\r\n   * @returns {Preset|Array[Preset]}\r\n   */\r\n  static async createPreset(placeables, options = {}) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    // Alike placeables will be made into single presets. Lets batch them up together.\r\n\r\n    const groups = {};\r\n    for (const placeable of placeables) {\r\n      const docName = placeable.document.documentName;\r\n      if (!groups.hasOwnProperty(docName)) groups[docName] = [];\r\n      groups[docName].push(placeable);\r\n    }\r\n\r\n    const presets = [];\r\n    for (const [docName, placeables] of Object.entries(groups)) {\r\n      const data = [];\r\n      for (const placeable of placeables) {\r\n        data.push(placeableToData(placeable));\r\n      }\r\n\r\n      // Preset data before merging with user provided\r\n      const defPreset = {\r\n        name: localize('presets.default-name'),\r\n        documentName: docName,\r\n        data: data,\r\n      };\r\n\r\n      // Assign preset image\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n        case 'Tile':\r\n        case 'Note':\r\n          defPreset.img = data[0].texture.src;\r\n          break;\r\n        case 'AmbientSound':\r\n          defPreset.img = 'icons/svg/sound.svg';\r\n          break;\r\n        case 'AmbientLight':\r\n          defPreset.img = 'icons/svg/light.svg';\r\n          break;\r\n        case 'Drawing':\r\n          defPreset.img = 'icons/svg/acid.svg';\r\n          break;\r\n        case 'MeasuredTemplate':\r\n          defPreset.img = 'icons/svg/circle.svg';\r\n          break;\r\n      }\r\n\r\n      //  Assign preset name\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n          defPreset.name = data[0].name;\r\n          break;\r\n        default:\r\n          const taggerTag = data[0].flags?.tagger?.tags?.[0];\r\n          if (taggerTag) defPreset.name = taggerTag;\r\n          break;\r\n      }\r\n\r\n      defPreset.gridSize = placeables[0].document.parent.grid.size;\r\n\r\n      foundry.utils.mergeObject(defPreset, options, { inplace: true });\r\n\r\n      const preset = new Preset(defPreset);\r\n      await PresetCollection.set(preset);\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Spawn a preset on the scene (uuid, name or preset itself are required).\r\n   * By default the current mouse position is used.\r\n   * @param {object} [options={}]\r\n   * @param {Preset} [options.preset]                    Preset\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Preset tags, See PresetAPI.getPreset\r\n   * @param {Boolean} [options.random]                   If a unique preset could not be found, a random one will be chosen from the matched list\r\n   * @param {Number} [options.x]                         Spawn canvas x coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.y]                         Spawn canvas y coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.z]                         Spawn canvas z coordinate (3D Canvas)\r\n   * @param {Boolean} [options.snapToGrid]               If 'true' snaps spawn position to the grid.\r\n   * @param {Boolean} [options.hidden]                   If 'true' preset will be spawned hidden.\r\n   * @param {Boolean} [options.layerSwitch]              If 'true' the layer of the spawned preset will be activated.\r\n   * @param {Boolean} [options.scaleToGrid]              If 'true' Tiles, Drawings, and Walls will be scaled relative to grid size.\r\n   * @param {Boolean} [options.modifyPrompt]             If 'true' a field modification prompt will be shown if configured via `Preset Edit > Modify` form\r\n   * @param {Boolean} [options.coordPicker]              If 'true' a crosshair and preview will be enabled allowing spawn position to be picked\r\n   * @param {String} [options.pickerLabel]               Label displayed above crosshair when `coordPicker` is enabled\r\n   * @param {String} [options.taPreview]                 Designates the preview placeable when spawning a `Token Attacher` prefab.\r\n   *                                                      Accepted values are \"ALL\" (for all elements) and document name optionally followed by an index number\r\n   *                                                      e.g. \"ALL\", \"Tile\", \"AmbientLight.1\"\r\n   * @returns {Array[Document]}\r\n   */\r\n  static async spawnPreset({\r\n    uuid,\r\n    preset,\r\n    name,\r\n    type,\r\n    folder,\r\n    tags,\r\n    random = false,\r\n    x,\r\n    y,\r\n    z,\r\n    coordPicker = false,\r\n    pickerLabel,\r\n    taPreview,\r\n    snapToGrid = true,\r\n    hidden = false,\r\n    layerSwitch = false,\r\n    scaleToGrid = false,\r\n    modifyPrompt = true,\r\n    center = false,\r\n    transform = {},\r\n    previewOnly = false,\r\n    sceneId,\r\n  } = {}) {\r\n    if (!canvas.ready) throw Error(\"Canvas need to be 'ready' for a preset to be spawned.\");\r\n    if (!(uuid || preset || name || type || folder || tags))\r\n      throw Error('ID, Name, Folder, Tags, or Preset is needed to spawn it.');\r\n    if (!coordPicker && ((x == null && y != null) || (x != null && y == null)))\r\n      throw Error('Need both X and Y coordinates to spawn a preset.');\r\n\r\n    if (preset) await preset.load();\r\n    preset = preset ?? (await PresetAPI.getPreset({ uuid, name, type, folder, tags, random }));\r\n    if (!preset) throw Error(`No preset could be found matching: { uuid: \"${uuid}\", name: \"${name}\", type: \"${type}\"}`);\r\n\r\n    let presetData = deepClone(preset.data);\r\n\r\n    // Instead of using the entire data group use only one random one\r\n    if (preset.spawnRandom && presetData.length)\r\n      presetData = [presetData[Math.floor(Math.random() * presetData.length)]];\r\n\r\n    // Display prompt to modify data if needed\r\n    if (modifyPrompt && preset.modifyOnSpawn?.length) {\r\n      presetData = await modifySpawnData(presetData, preset.modifyOnSpawn);\r\n      // presetData being returned as null means that the modify field form has been canceled\r\n      // in which case we should cancel spawning as well\r\n      if (presetData == null) return;\r\n    }\r\n\r\n    // Populate preset data with default placeable data\r\n    presetData = presetData.map((data) => {\r\n      return mergePresetDataToDefaultDoc(preset, data);\r\n    });\r\n    presetData = presetData.map((d) => foundry.utils.flattenObject(d));\r\n    if (!foundry.utils.isEmpty(preset.randomize)) await applyRandomization(presetData, null, preset.randomize); // Randomize data if needed\r\n    await checkApplySpecialFields(preset.documentName, presetData, presetData); // Apply Special fields (TMFX)\r\n    presetData = presetData.map((d) => foundry.utils.expandObject(d));\r\n\r\n    if (preset.preSpawnScript) {\r\n      await executeScript(preset.preSpawnScript, { data: presetData });\r\n    }\r\n\r\n    // Lets sort the preset data as well as any attached placeable data into document groups\r\n    // documentName -> data array\r\n    const docToData = new Map();\r\n    docToData.set(preset.documentName, presetData);\r\n    if (preset.attached) {\r\n      for (const attached of preset.attached) {\r\n        if (!docToData.get(attached.documentName)) docToData.set(attached.documentName, []);\r\n        const data = deepClone(attached.data);\r\n        docToData.get(attached.documentName).push(data);\r\n      }\r\n    }\r\n\r\n    // Scale data relative to grid size\r\n    if (scaleToGrid) {\r\n      const scale = canvas.grid.size / (preset.gridSize || 100);\r\n      docToData.forEach((dataArr, documentName) => {\r\n        dataArr.forEach((data) => DataTransform.apply(documentName, data, { x: 0, y: 0 }, { scale, gridScale: true }));\r\n      });\r\n    }\r\n\r\n    // ==================\r\n    // Determine spawn position\r\n    if (coordPicker) {\r\n      const coords = await new Promise(async (resolve) => {\r\n        Picker.activate(resolve, {\r\n          documentName: preset.documentName,\r\n          previewData: docToData,\r\n          snap: snapToGrid,\r\n          label: pickerLabel,\r\n          taPreview: taPreview,\r\n          center,\r\n          previewOnly,\r\n          ...transform,\r\n        });\r\n      });\r\n      if (coords == null) return [];\r\n      x = coords.end.x;\r\n      y = coords.end.y;\r\n      if (coords.end.z != null) z = coords.end.z;\r\n    } else if (x == null || y == null) {\r\n      if (game.Levels3DPreview?._active) {\r\n        const pos3d = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n        x = pos3d.x;\r\n        y = pos3d.y;\r\n        z = pos3d.z;\r\n      } else {\r\n        x = canvas.mousePosition.x;\r\n        y = canvas.mousePosition.y;\r\n\r\n        if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n          x -= canvas.dimensions.size / 2;\r\n          y -= canvas.dimensions.size / 2;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (center) {\r\n      const offset = getPresetDataCenterOffset(docToData);\r\n      x -= offset.x;\r\n      y -= offset.y;\r\n    }\r\n\r\n    let pos = { x, y };\r\n\r\n    if (snapToGrid && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)) {\r\n      pos = canvas.grid.getSnappedPosition(\r\n        pos.x,\r\n        pos.y,\r\n        canvas.getLayerByEmbeddedName(preset.documentName).gridPrecision\r\n      );\r\n    }\r\n    pos.z = z;\r\n    // ==================\r\n\r\n    // ==================\r\n    // Set positions taking into account relative distances between each object\r\n\r\n    const posTransform = getTransformToOrigin(docToData);\r\n    posTransform.x += pos.x;\r\n    posTransform.y += pos.y;\r\n\r\n    // 3D Support\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      if (pos.z == null) posTransform.z = 0;\r\n      else posTransform.z += pos.z;\r\n    }\r\n\r\n    docToData.forEach((dataArr, documentName) => {\r\n      dataArr.forEach((data) => {\r\n        DataTransform.apply(documentName, data, { x: 0, y: 0 }, posTransform);\r\n\r\n        // Assign ownership for Drawings and MeasuredTemplates\r\n        if (['Drawing', 'MeasuredTemplate'].includes(documentName)) {\r\n          if (documentName === 'Drawing') data.author = game.user.id;\r\n          else if (documentName === 'MeasuredTemplate') data.user = game.user.id;\r\n        }\r\n\r\n        // Hide\r\n        if (hidden || game.keyboard.downKeys.has('AltLeft')) data.hidden = true;\r\n      });\r\n    });\r\n\r\n    // ==================\r\n\r\n    if (layerSwitch) {\r\n      if (game.user.isGM || ['Token', 'MeasuredTemplate', 'Note'].includes(preset.documentName))\r\n        canvas.getLayerByEmbeddedName(preset.documentName)?.activate();\r\n    }\r\n\r\n    // Create Documents\r\n    const allDocuments = [];\r\n\r\n    for (const [documentName, dataArr] of docToData.entries()) {\r\n      const documents = await createDocuments(documentName, dataArr, sceneId ?? canvas.scene.id);\r\n      documents.forEach((d) => allDocuments.push(d));\r\n    }\r\n\r\n    // Execute post spawn scripts\r\n    if (preset.postSpawnScript) {\r\n      await executeScript(preset.postSpawnScript, {\r\n        documents: allDocuments,\r\n        objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n      });\r\n    }\r\n\r\n    return allDocuments;\r\n  }\r\n}\r\n\r\nclass PresetFolder {\r\n  constructor({\r\n    id,\r\n    uuid,\r\n    name,\r\n    sorting = 'm',\r\n    color = '#000000',\r\n    sort = 0,\r\n    children = [],\r\n    presets = [],\r\n    draggable = true,\r\n    folder = null,\r\n    visible = true,\r\n    render = true,\r\n  } = {}) {\r\n    this.id = id;\r\n    this.uuid = uuid;\r\n    this.name = name;\r\n    this.sorting = sorting;\r\n    this.color = color;\r\n    this.sort = sort;\r\n    this.children = children;\r\n    this.children.forEach((c) => {\r\n      c.folder = this.id;\r\n    });\r\n    this.presets = presets;\r\n    this.draggable = draggable;\r\n    this.folder = folder;\r\n    this.visible = visible;\r\n    this.render = render;\r\n    this.expanded = FolderState.expanded(this.uuid);\r\n  }\r\n\r\n  async update(data) {\r\n    const doc = await fromUuid(this.uuid);\r\n    if (doc) await doc.update(data);\r\n  }\r\n}\r\n\r\nexport class PresetVirtualFolder extends PresetFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.virtual = true;\r\n  }\r\n\r\n  async update(data) {}\r\n}\r\n\r\nexport class PresetPackFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    const tree = options.tree;\r\n    const pack = options.pack;\r\n    const packFolderData = tree.metaDoc.getFlag(MODULE_ID, 'folder') ?? {};\r\n    const uuid = pack.collection;\r\n    super({\r\n      uuid,\r\n      id: SeededRandom.randomID(uuid),\r\n      name: packFolderData.name ?? pack.title,\r\n      children: tree.folders,\r\n      presets: tree.presets,\r\n      draggable: false,\r\n      color: packFolderData.color ?? '#000000',\r\n    });\r\n    this.group = packFolderData.group;\r\n  }\r\n\r\n  get pack() {\r\n    return this.uuid;\r\n  }\r\n\r\n  async update(data = {}) {\r\n    const pack = game.packs.get(this.pack);\r\n    if (pack.locked) return;\r\n    if (data.hasOwnProperty('name') && data.name === pack.title) delete data.name;\r\n    if (foundry.utils.isEmpty(data)) return;\r\n\r\n    const metaDoc = await PresetCollection._initMetaDocument(this.pack);\r\n    await metaDoc.setFlag(MODULE_ID, 'folder', data);\r\n  }\r\n}\r\n","class TrackerDialog extends Dialog {\r\n  constructor(options, { total, cancelCallback, left, top }) {\r\n    super(options, { left, top });\r\n    this.count = 0;\r\n    this.total = total;\r\n    this.cancelCallback = cancelCallback;\r\n  }\r\n\r\n  incrementCount() {\r\n    this.count++;\r\n    this.element?.find('.count').html(this.count);\r\n  }\r\n\r\n  stop() {\r\n    this.close(true);\r\n  }\r\n\r\n  get active() {\r\n    return this._state === Application.RENDER_STATES.RENDERED || this._state === Application.RENDER_STATES.RENDERING;\r\n  }\r\n}\r\n\r\nexport async function trackProgress({ title = 'Progress', cancelCallback, total } = {}) {\r\n  if (!total) return;\r\n\r\n  let content = `\r\n<div>\r\n<div  style=\"display: block; text-align: center; padding: 5px;\"><i class=\"fas fa-circle-notch fa-spin fa-3x\"></i></div>\r\n    <p style=\"text-align: center;\"><span class=\"count\">count</span>/${total}</p>\r\n</div>`;\r\n\r\n  const dialog = new TrackerDialog(\r\n    {\r\n      title,\r\n      content,\r\n      buttons: {\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-stop\"></i>',\r\n          label: 'Stop/Cancel',\r\n          callback: () => {\r\n            cancelCallback?.();\r\n          },\r\n        },\r\n      },\r\n      default: 'cancel',\r\n    },\r\n    { total, cancelCallback, left: 50, top: 50 }\r\n  );\r\n\r\n  await dialog._render(true);\r\n\r\n  return dialog;\r\n}\r\n\r\nexport function countFolderItems(folder) {\r\n  if (folder.presets) {\r\n    return (\r\n      folder.presets.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c);\r\n      }, 0)\r\n    );\r\n  } else {\r\n    return (\r\n      folder.contents.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c.folder);\r\n      }, 0)\r\n    );\r\n  }\r\n}\r\n","/**\r\n * A collection of functions related to sorting objects within a parent container.\r\n */\r\nexport class SortingHelpersFixed {\r\n  /**\r\n   * Given a source object to sort, a target to sort relative to, and an Array of siblings in the container:\r\n   * Determine the updated sort keys for the source object, or all siblings if a reindex is required.\r\n   * Return an Array of updates to perform, it is up to the caller to dispatch these updates.\r\n   * Each update is structured as:\r\n   * {\r\n   *   target: object,\r\n   *   update: {sortKey: sortValue}\r\n   * }\r\n   *\r\n   * @param {object} source       The source object being sorted\r\n   * @param {object} [options]    Options which modify the sort behavior\r\n   * @param {object|null} [options.target]  The target object relative which to sort\r\n   * @param {object[]} [options.siblings]   The Array of siblings which the source should be sorted within\r\n   * @param {string} [options.sortKey=sort] The property name within the source object which defines the sort key\r\n   * @param {boolean} [options.sortBefore]  Explicitly sort before (true) or sort after( false).\r\n   *                                        If undefined the sort order will be automatically determined.\r\n   * @returns {object[]}          An Array of updates for the caller of the helper function to perform\r\n   */\r\n  static performIntegerSort(\r\n    source,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > 1) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: Math.round(0.5 * (min + max)) },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Reindex all siblings\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, source);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  static performIntegerSortMulti(\r\n    sources,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    let source = sources[0];\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY * (sources.length - i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > sources.length) {\r\n      let increment = Math.floor((1 / (sources.length + 1)) * Math.abs(max - min));\r\n      if (increment === 0) increment = 1;\r\n      min = Math.min(max, min);\r\n\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + increment * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Reindex all\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, ...sources);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort before the target\r\n   * @private\r\n   */\r\n  static _sortBefore(siblings, idx, sortKey) {\r\n    let max = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let min = siblings[idx - 1] ? siblings[idx - 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort after the target\r\n   * @private\r\n   */\r\n  static _sortAfter(siblings, idx, sortKey) {\r\n    let min = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let max = siblings[idx + 1] ? siblings[idx + 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n}\r\n","import { TokenDataAdapter } from '../../applications/dataAdapters.js';\r\nimport { copyToClipboard, pasteDataUpdate } from '../../applications/forms.js';\r\nimport { showMassEdit } from '../../applications/multiConfig.js';\r\nimport { countFolderItems, trackProgress } from '../../applications/progressDialog.js';\r\nimport { BrushMenu } from '../brush.js';\r\nimport { importPresetFromJSONDialog } from '../dialogs.js';\r\nimport { SortingHelpersFixed } from '../fixedSort.js';\r\nimport {\r\n  MODULE_ID,\r\n  SUPPORTED_PLACEABLES,\r\n  TagInput,\r\n  UI_DOCS,\r\n  applyPresetToScene,\r\n  localFormat,\r\n  localize,\r\n} from '../utils.js';\r\nimport { META_INDEX_ID, PresetAPI, PresetCollection, PresetPackFolder, PresetVirtualFolder } from './collection.js';\r\nimport { DOC_ICONS, Preset } from './preset.js';\r\nimport { FolderState, mergePresetDataToDefaultDoc, placeableToData, randomizeChildrenFolderColors } from './utils.js';\r\n\r\nconst SEARCH_MIN_CHAR = 2;\r\n\r\n// const FLAG_DATA = {\r\n//   documentName: null,\r\n//   data: null,\r\n//   addSubtract: null,\r\n//   randomize: null,\r\n// };\r\n\r\nconst SORT_MODES = {\r\n  manual: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeManual', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-short-wide\"></i>',\r\n  },\r\n  alphabetical: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeAlpha', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-a-z\"></i>',\r\n  },\r\n};\r\n\r\nconst SEARCH_MODES = {\r\n  p: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets');\r\n    },\r\n    icon: '<i class=\"fas fa-search\"></i>',\r\n  },\r\n  pf: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets-folders');\r\n    },\r\n    icon: '<i class=\"fa-solid fa-folder-magnifying-glass\"></i>',\r\n  },\r\n};\r\n\r\nexport class MassEditPresets extends FormApplication {\r\n  static objectHover = false;\r\n  static lastSearch;\r\n\r\n  constructor(configApp, callback, docName, options = {}) {\r\n    // Restore position and dimensions the previously closed window\r\n    if (!options.preventPositionOverride && MassEditPresets.previousPosition) {\r\n      options = { ...options, ...MassEditPresets.previousPosition };\r\n    }\r\n\r\n    super({}, options);\r\n    this.callback = callback;\r\n\r\n    // Drag/Drop tracking\r\n    this.dragType = null;\r\n    this.dragData = null;\r\n    this.draggedElements = null;\r\n\r\n    if (!configApp && UI_DOCS.includes(docName)) {\r\n      const docLock = game.settings.get(MODULE_ID, 'presetDocLock');\r\n      this.docName = docLock || docName;\r\n    } else {\r\n      this.configApp = configApp;\r\n      this.docName = docName || this.configApp.documentName;\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-presets',\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presets.html`,\r\n      resizable: true,\r\n      minimizable: true,\r\n      width: 350,\r\n      height: 900,\r\n      scrollY: ['.item-list'],\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    let title = localize('common.presets');\r\n    if (!UI_DOCS.includes(this.docName)) title += ` [${this.docName}]`;\r\n    else title += ` [${localize('common.placeable')}]`;\r\n    return title;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/preset.html`, 'me-preset');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/presetFolder.html`, 'me-preset-folder');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/presetsContent.html`, 'me-presets-content');\r\n\r\n    const displayExtCompendiums = game.settings.get(MODULE_ID, 'presetExtComp');\r\n\r\n    this.tree = await PresetCollection.getTree(this.docName, !displayExtCompendiums);\r\n    data.presets = this.tree.presets;\r\n    data.folders = this.tree.folders;\r\n    data.extFolders = this.tree.extFolders.length ? this.tree.extFolders : null;\r\n\r\n    data.createEnabled = Boolean(this.configApp);\r\n    data.isPlaceable =\r\n      SUPPORTED_PLACEABLES.includes(this.docName) || this.docName === 'ALL' || this.docName === 'FAVORITES';\r\n    data.allowDocumentSwap = UI_DOCS.includes(this.docName) && !this.configApp;\r\n    data.docLockActive = game.settings.get(MODULE_ID, 'presetDocLock') === this.docName;\r\n    data.layerSwitchActive = game.settings.get(MODULE_ID, 'presetLayerSwitch');\r\n    data.scaling = game.settings.get(MODULE_ID, 'presetScaling');\r\n    data.extCompActive = displayExtCompendiums;\r\n    data.sortMode = SORT_MODES[game.settings.get(MODULE_ID, 'presetSortMode')];\r\n    data.searchMode = SEARCH_MODES[game.settings.get(MODULE_ID, 'presetSearchMode')];\r\n    data.displayDragDropMessage = data.allowDocumentSwap && !(this.tree.presets.length || this.tree.folders.length);\r\n    data.canvas3dActive = Boolean(game.Levels3DPreview?._active);\r\n\r\n    data.lastSearch = MassEditPresets.lastSearch;\r\n\r\n    data.docs = UI_DOCS.reduce((obj, key) => {\r\n      return {\r\n        ...obj,\r\n        [key]: DOC_ICONS[key],\r\n      };\r\n    }, {});\r\n\r\n    data.documents = UI_DOCS;\r\n    data.currentDocument = this.docName;\r\n\r\n    data.callback = Boolean(this.callback);\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          MassEditPresets.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          MassEditPresets.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        hoverOverlay.hide();\r\n        MassEditPresets.objectHover = false;\r\n      });\r\n\r\n    // Create Preset from Selected\r\n    html.find('.create-preset').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // =====================\r\n    // Preset multi-select & drag Listeners\r\n    const itemList = html.find('.item-list');\r\n\r\n    // Multi-select\r\n    html.on('click', '.item', (event) => {\r\n      itemSelect(event, itemList);\r\n      if (this._activeBrush) this._toggleBrush(event);\r\n    });\r\n\r\n    // Hide/Show preset tags and favorite control\r\n    html.on('mouseenter', '.item', (event) => {\r\n      $(event.currentTarget).find('.tags, .preset-favorite').addClass('show');\r\n    });\r\n\r\n    html.on('mouseleave', '.item', (event) => {\r\n      $(event.currentTarget).find('.tags, .preset-favorite').removeClass('show');\r\n    });\r\n\r\n    html.on('dragstart', '.item', (event) => {\r\n      this.dragType = 'item';\r\n\r\n      const item = $(event.target).closest('.item');\r\n\r\n      // Drag has been started on an item that hasn't been selected\r\n      // Assume that this is the only item to be dragged and select it\r\n      if (!item.hasClass('selected')) {\r\n        itemList.find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n        item.addClass('selected').addClass('last-selected');\r\n      }\r\n\r\n      const uuids = [];\r\n      itemList.find('.item.selected').each(function () {\r\n        uuids.push($(this).data('uuid'));\r\n      });\r\n      this.dragData = uuids;\r\n      this.draggedElements = itemList.find('.item.selected');\r\n    });\r\n    html.on('dragleave', '.item.editable', (event) => {\r\n      $(event.target).closest('.item').removeClass('drag-bot').removeClass('drag-top');\r\n    });\r\n\r\n    html.on('dragover', '.item.editable', (event) => {\r\n      if (this.dragType !== 'item') return;\r\n      if (!this.draggedElements.hasClass('editable')) return;\r\n\r\n      const targetItem = $(event.target).closest('.item');\r\n\r\n      // Check that we're not above a selected item  (i.e. item being dragged)\r\n      if (targetItem.hasClass('selected')) return;\r\n\r\n      // Determine if mouse is hovered over top, middle, or bottom\r\n      var domRect = event.currentTarget.getBoundingClientRect();\r\n      let prc = event.offsetY / domRect.height;\r\n\r\n      if (prc < 0.2) {\r\n        targetItem.removeClass('drag-bot').addClass('drag-top');\r\n      } else if (prc > 0.8) {\r\n        targetItem.removeClass('drag-top').addClass('drag-bot');\r\n      }\r\n    });\r\n\r\n    html.on('drop', '.item.editable', (event) => {\r\n      if (this.dragType !== 'item') return;\r\n      if (!this.draggedElements.hasClass('editable')) return;\r\n\r\n      const targetItem = $(event.target).closest('.item');\r\n\r\n      const top = targetItem.hasClass('drag-top');\r\n      targetItem.removeClass('drag-bot').removeClass('drag-top');\r\n\r\n      const uuids = this.dragData;\r\n      if (uuids) {\r\n        if (!targetItem.hasClass('selected')) {\r\n          // Move HTML Elements\r\n          (top ? uuids : uuids.reverse()).forEach((uuid) => {\r\n            const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n            if (item) {\r\n              if (top) item.insertBefore(targetItem);\r\n              else item.insertAfter(targetItem);\r\n            }\r\n          });\r\n\r\n          this._onItemSort(uuids, targetItem.data('uuid'), {\r\n            before: top,\r\n            folderUuid: targetItem.closest('.folder').data('uuid'),\r\n          });\r\n        }\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n\r\n    html.on('dragend', '.item', (event) => {\r\n      if (!checkMouseInWindow(event)) {\r\n        this._onPresetDragOut(event);\r\n      }\r\n    });\r\n\r\n    // ================\r\n    // Folder Listeners\r\n    html.on('click', '.folder > header', (event) => this._folderToggle($(event.target).closest('.folder')));\r\n\r\n    html.on('dragstart', '.folder.editable', (event) => {\r\n      if (this.dragType == 'item') return;\r\n      this.dragType = 'folder';\r\n\r\n      const folder = $(event.target).closest('.folder');\r\n      const uuids = [folder.data('uuid')];\r\n\r\n      $(event.target)\r\n        .find('.folder')\r\n        .each(function () {\r\n          uuids.push($(this).data('uuid'));\r\n        });\r\n\r\n      this.dragData = uuids;\r\n    });\r\n\r\n    html.on('dragleave', '.folder.editable header', (event) => {\r\n      $(event.target).closest('.folder').removeClass('drag-mid').removeClass('drag-top');\r\n    });\r\n\r\n    html.on('dragover', '.folder.editable header', (event) => {\r\n      const targetFolder = $(event.target).closest('.folder');\r\n\r\n      if (this.dragType === 'folder') {\r\n        // Check that we're not above folders being dragged\r\n        if (this.dragData.includes(targetFolder.data('uuid'))) return;\r\n\r\n        // Determine if mouse is hovered over top, middle, or bottom\r\n        var domRect = event.currentTarget.getBoundingClientRect();\r\n        let prc = event.offsetY / domRect.height;\r\n\r\n        if (prc < 0.2) {\r\n          targetFolder.removeClass('drag-mid').addClass('drag-top');\r\n        } else {\r\n          targetFolder.removeClass('drag-top').addClass('drag-mid');\r\n        }\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('editable')) {\r\n        targetFolder.addClass('drag-mid');\r\n      }\r\n    });\r\n\r\n    html.on('drop', '.folder.editable header', (event) => {\r\n      if (this._foundryDrop(event)) return;\r\n      const targetFolder = $(event.target).closest('.folder');\r\n\r\n      if (this.dragType === 'folder') {\r\n        const top = targetFolder.hasClass('drag-top');\r\n        targetFolder.removeClass('drag-mid').removeClass('drag-top');\r\n\r\n        const uuids = this.dragData;\r\n        if (uuids) {\r\n          if (uuids.includes(targetFolder.data('uuid'))) return;\r\n\r\n          const uuid = uuids[0];\r\n          const folder = html.find(`.folder[data-uuid=\"${uuid}\"]`);\r\n          if (folder) {\r\n            // Move HTML Elements\r\n            if (top) folder.insertBefore(targetFolder);\r\n            else targetFolder.find('.folder-items').first().append(folder);\r\n\r\n            if (top) {\r\n              this._onFolderSort(uuid, targetFolder.data('uuid'), {\r\n                inside: false,\r\n                folderUuid: targetFolder.parent().closest('.folder').data('uuid') ?? null,\r\n              });\r\n            } else {\r\n              this._onFolderSort(uuid, null, {\r\n                inside: true,\r\n                folderUuid: targetFolder.data('uuid'),\r\n              });\r\n            }\r\n          }\r\n        }\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('editable')) {\r\n        targetFolder.removeClass('drag-mid');\r\n        const uuids = this.dragData;\r\n\r\n        // Move HTML Elements\r\n        const presetItems = targetFolder.children('.preset-items');\r\n        uuids?.forEach((uuid) => {\r\n          const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n          if (item.length) presetItems.append(item);\r\n        });\r\n\r\n        this._onItemSort(uuids, null, {\r\n          folderUuid: targetFolder.data('uuid'),\r\n        });\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n\r\n    html.on('drop', '.top-level-preset-items', (event) => {\r\n      if (this._foundryDrop(event)) return;\r\n      if (this.dragType === 'folder') {\r\n        // Move HTML Elements\r\n        const target = html.find('.top-level-folder-items');\r\n        const folder = html.find(`.folder[data-uuid=\"${this.dragData[0]}\"]`);\r\n        target.append(folder);\r\n\r\n        this._onFolderSort(this.dragData[0], null);\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('editable')) {\r\n        const uuids = this.dragData;\r\n\r\n        // Move HTML Elements\r\n        const target = html.find('.top-level-preset-items');\r\n        uuids?.forEach((uuid) => {\r\n          const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n          if (item.length) target.append(item);\r\n        });\r\n\r\n        this._onItemSort(uuids, null);\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n    // End of Folder Listeners\r\n    // ================\r\n\r\n    html.on('click', '.toggle-sort', this._onToggleSort.bind(this));\r\n    html.on('click', '.toggle-search-mode', this._onToggleSearch.bind(this));\r\n    html.on('click', '.toggle-doc-lock', this._onToggleLock.bind(this));\r\n    html.on('click', '.toggle-ext-comp', this._onToggleExtComp.bind(this));\r\n    html.on('click', '.toggle-scaling', this._onToggleScaling.bind(this));\r\n    html.on('click', '.toggle-layer-switch', this._onToggleLayerSwitch.bind(this));\r\n    html.on('click', '.document-select', this._onDocumentChange.bind(this));\r\n    html.on('dblclick', '.item', this._onDoubleClickPreset.bind(this));\r\n    html.on('click', '.create-folder', this._onCreateFolder.bind(this));\r\n    html.on('click', '.preset-create', this._onPresetCreate.bind(this));\r\n    html.on('click', '.preset-update a', this._onPresetUpdate.bind(this));\r\n    html.on('click', '.preset-favorite', this._onToggleFavorite.bind(this));\r\n    html.on('click', '.preset-callback', this._onApplyPreset.bind(this));\r\n\r\n    const headerSearch = html.find('.header-search input');\r\n    headerSearch.on('input', (event) => this._onSearchInput(event));\r\n    if ((MassEditPresets.lastSearch?.length ?? 0) >= SEARCH_MIN_CHAR) headerSearch.trigger('input');\r\n\r\n    // Activate context menu\r\n    this._contextMenu(html.find('.item-list'));\r\n  }\r\n\r\n  _folderToggle(folderElement) {\r\n    const uuid = folderElement.data('uuid');\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder.expanded) this._folderCollapse(folderElement, folder);\r\n    else this._folderExpand(folderElement, folder);\r\n  }\r\n\r\n  async _folderExpand(folderElement, folder) {\r\n    FolderState.setExpanded(folder.uuid, true);\r\n    folder.expanded = true;\r\n\r\n    if (folderElement.find('.folder-items').length) {\r\n      folderElement.removeClass('collapsed');\r\n      folderElement.find('header h3 i').first().removeClass('fa-folder-closed').addClass('fa-folder-open');\r\n    } else {\r\n      let content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/presetFolder.html`, {\r\n        folder,\r\n        createEnabled: Boolean(this.configApp),\r\n        callback: Boolean(this.callback),\r\n        editable: fromUuidSync(folder.uuid)?.pack === PresetCollection.workingPack,\r\n      });\r\n      folderElement.replaceWith(content);\r\n    }\r\n  }\r\n\r\n  _folderCollapse(folderElement, folder) {\r\n    folderElement.addClass('collapsed');\r\n    folderElement.find('header h3 i').first().removeClass('fa-folder-open').addClass('fa-folder-closed');\r\n\r\n    FolderState.setExpanded(folder.uuid, false);\r\n    folder.expanded = false;\r\n  }\r\n\r\n  /**\r\n   * Process drag and drop of an Actor or Folder of actors\r\n   * @param {*} event\r\n   * @returns\r\n   */\r\n  _foundryDrop(event) {\r\n    const data = TextEditor.getDragEventData(event.originalEvent);\r\n    if (!isEmpty(data)) {\r\n      if (data.type === 'Folder') {\r\n        const folder = fromUuidSync(data.uuid);\r\n        if (folder.type !== 'Actor') return false;\r\n        if (this._importTracker?.active) return false;\r\n\r\n        trackProgress({\r\n          title: 'Converting Actors',\r\n          total: countFolderItems(folder),\r\n        }).then(async (tracker) => {\r\n          this._importTracker = tracker;\r\n          await this._importActorFolder(folder, null, { keepId: true });\r\n          this._importTracker?.stop();\r\n        });\r\n        return true;\r\n      } else if (data.type === 'Actor') {\r\n        PresetAPI.createPresetFromActorUuid(data.uuid, { keepId: true }).then((preset) => {\r\n          if (preset) this.render(true);\r\n        });\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  async _importActorFolder(folder, parentFolder = null, options = {}) {\r\n    let nFolder = new Folder.implementation(\r\n      {\r\n        _id: options.keepId ? folder.id : null,\r\n        name: folder.name,\r\n        type: 'JournalEntry',\r\n        sorting: folder.sorting,\r\n        folder: parentFolder,\r\n        color: folder.color ?? '#000000',\r\n        flags: { [MODULE_ID]: { types: ['ALL', 'Token'] } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    nFolder = await Folder.create(nFolder, { pack: nFolder.pack, keepId: options.keepId });\r\n\r\n    for (const child of folder.children) {\r\n      if (!this._importTracker?.active) break;\r\n      await this._importActorFolder(child.folder, nFolder.id, options);\r\n    }\r\n\r\n    for (const actor of folder.contents) {\r\n      if (!this._importTracker?.active) break;\r\n      await PresetAPI.createPresetFromActorUuid(actor.uuid, { folder: nFolder.id, keepId: options.keepId });\r\n      this._importTracker.incrementCount();\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onDoubleClickPreset(event) {\r\n    BrushMenu.close();\r\n    if (game.Levels3DPreview?._active) return;\r\n    const uuid = $(event.target).closest('.item').data('uuid');\r\n    if (!uuid) return;\r\n\r\n    const preset = await PresetAPI.getPreset({ uuid });\r\n    if (!preset) return;\r\n\r\n    if (preset.documentName === 'Scene') {\r\n      ui.notifications.info(`Mass Edit: ${localize('common.apply')} [${preset.name}]`);\r\n      applyPresetToScene(preset);\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    ui.notifications.info(`Mass Edit: ${localize('presets.spawning')} [${preset.name}]`);\r\n\r\n    this._setInteractivityState(false);\r\n    await PresetAPI.spawnPreset({\r\n      preset,\r\n      coordPicker: true,\r\n      taPreview: 'ALL',\r\n      layerSwitch: game.settings.get(MODULE_ID, 'presetLayerSwitch'),\r\n      scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n      center: true,\r\n    });\r\n    this._setInteractivityState(true);\r\n  }\r\n\r\n  /**\r\n   * Sets the window app as translucent and inactive to mouse pointer events\r\n   * @param {Boolean} state true = active, false = inactive\r\n   */\r\n  _setInteractivityState(state) {\r\n    if (state) this.element.removeClass('inactive');\r\n    else this.element.addClass('inactive');\r\n  }\r\n\r\n  _contextMenu(html) {\r\n    ContextMenu.create(this, html, '.item', this._getItemContextOptions(), {\r\n      hookName: 'MassEditPresetContext',\r\n      onOpen: this._onRightClickPreset.bind(this),\r\n    });\r\n    ContextMenu.create(this, html, '.folder header', this._getFolderContextOptions(), {\r\n      hookName: 'MassEditFolderContext',\r\n    });\r\n  }\r\n\r\n  _getItemContextOptions() {\r\n    return [\r\n      {\r\n        name: localize('CONTROLS.CommonEdit', false),\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (item) => item.hasClass('editable'),\r\n        callback: (item) => this._onEditSelectedPresets(item),\r\n      },\r\n      {\r\n        name: 'Brush',\r\n        icon: '<i class=\"fa-solid fa-paintbrush\"></i>',\r\n        condition: (item) => SUPPORTED_PLACEABLES.includes(item.data('doc-name')),\r\n        callback: (item) => this._onActivateBrush(item),\r\n      },\r\n      {\r\n        name: localize('presets.open-journal'),\r\n        icon: '<i class=\"fas fa-book-open\"></i>',\r\n        callback: (item) => this._onOpenJournal(item),\r\n      },\r\n      {\r\n        name: localize('presets.apply-to-selected'),\r\n        icon: '<i class=\"fas fa-arrow-circle-right\"></i>',\r\n        condition: (item) =>\r\n          SUPPORTED_PLACEABLES.includes(item.data('doc-name')) &&\r\n          canvas.getLayerByEmbeddedName(item.data('doc-name')).controlled.length,\r\n        callback: (item) => this._onApplyToSelected(item),\r\n      },\r\n      {\r\n        name: localize('Duplicate', false),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => item.hasClass('editable'),\r\n        callback: (item) => this._onCopySelectedPresets(null, { keepFolder: true, keepId: false }),\r\n      },\r\n      {\r\n        name: localize('presets.copy-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => $(this.form).find('.item-list').find('.item.selected').length === 1,\r\n        callback: (item) => this._onCopyPresetToClipboard(),\r\n      },\r\n      {\r\n        name: localize('presets.export-as-json'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (item) => this._onExportSelectedPresets(),\r\n      },\r\n      {\r\n        name: localize('presets.export-to-compendium'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (item) => this._onExportSelectedPresetsToComp(),\r\n      },\r\n      {\r\n        name: localize('CONTROLS.CommonDelete', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (item) => item.hasClass('editable'),\r\n        callback: (item) => this._onDeleteSelectedPresets(item),\r\n      },\r\n    ];\r\n  }\r\n\r\n  _getFolderContextOptions() {\r\n    return [\r\n      {\r\n        name: 'Edit',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !(folder instanceof PresetVirtualFolder) || folder instanceof PresetPackFolder;\r\n        },\r\n        callback: (header) => this._onFolderEdit(header),\r\n      },\r\n      {\r\n        name: 'Export to Compendium',\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (header) => this._onExportFolder(header.closest('.folder').data('uuid')),\r\n      },\r\n      {\r\n        name: localize('FOLDER.Remove', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (header) => header.closest('.folder').hasClass('editable'),\r\n        callback: (header) => this._onFolderDelete(header.closest('.folder').data('uuid')),\r\n      },\r\n      {\r\n        name: localize('FOLDER.Delete', false),\r\n        icon: '<i class=\"fas fa-dumpster\"></i>',\r\n        condition: (header) => header.closest('.folder').hasClass('editable'),\r\n        callback: (header) =>\r\n          this._onFolderDelete(header.closest('.folder').data('uuid'), {\r\n            deleteAll: true,\r\n          }),\r\n      },\r\n      {\r\n        name: 'Randomize Child Folder Colors',\r\n        icon: '<i class=\"fas fa-dice\"></i>',\r\n        condition: () => CONFIG.debug.MassEdit,\r\n        callback: (header) =>\r\n          randomizeChildrenFolderColors(header.closest('.folder').data('uuid'), this.tree, () => this.render(true)),\r\n      },\r\n    ];\r\n  }\r\n\r\n  async _onExportFolder(uuid) {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack && !this._importTracker?.active) {\r\n      const folder = this.tree.allFolders.get(uuid);\r\n      if (folder) {\r\n        this._importTracker = await trackProgress({\r\n          title: 'Exporting Folder',\r\n          total: countFolderItems(this.tree.allFolders.get(uuid)),\r\n        });\r\n        await this._onCopyFolder(uuid, null, pack, true, keepId);\r\n        this._importTracker?.stop();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onCopyFolder(uuid, parentId = null, pack, render = true, keepId = true) {\r\n    if (!pack) pack = PresetCollection.workingPack;\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    const folderDoc = await fromUuid(uuid);\r\n\r\n    if (folder) {\r\n      let types;\r\n      if (folderDoc) types = folderDoc.flags[MODULE_ID]?.types ?? ['ALL'];\r\n      else types = ['ALL'];\r\n\r\n      const data = {\r\n        _id: keepId ? folder.id : null,\r\n        name: folder.name,\r\n        color: folder.color,\r\n        sorting: folder.sorting,\r\n        folder: parentId,\r\n        flags: { [MODULE_ID]: { types } },\r\n        type: 'JournalEntry',\r\n      };\r\n      const nFolder = await Folder.create(data, { pack, keepId });\r\n\r\n      for (const preset of folder.presets) {\r\n        if (!this._importTracker?.active) break;\r\n        const p = (await preset.load()).clone();\r\n        p.folder = nFolder.id;\r\n        if (!keepId) p.id = foundry.utils.randomID();\r\n        await PresetCollection.set(p, pack);\r\n        this._importTracker?.incrementCount();\r\n      }\r\n\r\n      for (const child of folder.children) {\r\n        if (!this._importTracker?.active) break;\r\n        await this._onCopyFolder(child.uuid, nFolder.id, pack, false, keepId);\r\n      }\r\n\r\n      if (render) this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onExportSelectedPresetsToComp() {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack) this._onCopySelectedPresets(pack, { keepId });\r\n  }\r\n\r\n  async _onCopySelectedPresets(pack, { keepFolder = false, keepId = true } = {}) {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    for (const preset of selected) {\r\n      const p = preset.clone();\r\n      if (!keepFolder) p.folder = null;\r\n      if (!keepId) p.id = foundry.utils.randomID();\r\n      await PresetCollection.set(p, pack);\r\n    }\r\n    if (selected.length) this.render(true);\r\n  }\r\n\r\n  async _onCopyPresetToClipboard() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    if (selected.length) copyToClipboard(selected[0]);\r\n  }\r\n\r\n  async _getSelectedPresets({ editableOnly = false, full = true } = {}) {\r\n    const uuids = [];\r\n    const items = this.element.find('.item-list').find('.item.selected' + (editableOnly ? '.editable' : ''));\r\n    items.each(function () {\r\n      const uuid = $(this).data('uuid');\r\n      uuids.push(uuid);\r\n    });\r\n\r\n    const selected = [];\r\n    for (const uuid of uuids) {\r\n      const preset = await PresetCollection.get(uuid, { full });\r\n      if (preset) selected.push(preset);\r\n    }\r\n    return [selected, items];\r\n  }\r\n\r\n  async _onExportSelectedPresets() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    exportPresets(selected);\r\n  }\r\n\r\n  async _onEditSelectedPresets(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: true });\r\n    if (selected.length) {\r\n      // Position edit window just bellow the item\r\n      const options = item.offset();\r\n      options.top += item.height();\r\n\r\n      this._editPresets(selected, options);\r\n    }\r\n  }\r\n\r\n  async _onDeleteSelectedPresets(item) {\r\n    const [selected, items] = await this._getSelectedPresets({ editableOnly: true, full: false });\r\n    if (selected.length) {\r\n      const confirm =\r\n        selected.length === 0\r\n          ? true\r\n          : await Dialog.confirm({\r\n              title: `${localize('common.delete')} [ ${selected.length} ]`,\r\n              content: `<p>${localize('AreYouSure', false)}</p><p>${localFormat('presets.delete-presets-warn', {\r\n                count: selected.length,\r\n              })}</p>`,\r\n            });\r\n\r\n      if (confirm) {\r\n        await PresetCollection.delete(selected);\r\n        items.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onOpenJournal(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: false });\r\n    selected.forEach((p) => p.openJournal());\r\n  }\r\n\r\n  async _onApplyToSelected(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: false });\r\n    if (!selected.length) return;\r\n\r\n    // Confirm that all presets are of the same document type\r\n    const types = new Set();\r\n    for (const s of selected) {\r\n      types.add(s.documentName);\r\n      if (types.size > 1) {\r\n        ui.notifications.warn(localize('presets.apply-to-selected-warn'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    const controlled = canvas.getLayerByEmbeddedName(selected[0].documentName).controlled;\r\n    if (!controlled.length) return;\r\n\r\n    for (const s of selected) {\r\n      pasteDataUpdate(controlled, s, false, true);\r\n    }\r\n  }\r\n\r\n  async _onCreateFolder(event) {\r\n    const types = [];\r\n    if (this.docName === 'ALL') {\r\n      types.push('ALL');\r\n    } else if (UI_DOCS.includes(this.docName)) {\r\n      types.push('ALL', this.docName);\r\n    } else {\r\n      types.push(this.docName);\r\n    }\r\n\r\n    const folder = new Folder.implementation(\r\n      {\r\n        name: Folder.defaultName(),\r\n        type: 'JournalEntry',\r\n        sorting: 'm',\r\n        flags: { [MODULE_ID]: { types } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    await new Promise((resolve) => {\r\n      new PresetFolderConfig(folder, { resolve }).render(true);\r\n    });\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onFolderEdit(header) {\r\n    const uuid = $(header).closest('.folder').data('uuid');\r\n    const pFolder = this.tree.allFolders.get(uuid);\r\n\r\n    let folder;\r\n    if (pFolder instanceof PresetPackFolder) {\r\n      // This is a virtual pack folder\r\n      folder = new Folder.implementation(\r\n        {\r\n          _id: pFolder.id,\r\n          name: pFolder.name,\r\n          type: 'JournalEntry',\r\n          color: pFolder.color,\r\n          sorting: pFolder.sorting,\r\n        },\r\n        { pack: pFolder.uuid }\r\n      );\r\n    } else {\r\n      folder = await fromUuid($(header).closest('.folder').data('uuid'));\r\n    }\r\n\r\n    new Promise((resolve) => {\r\n      const options = { resolve, ...header.offset(), folder: pFolder };\r\n      options.top += header.height();\r\n\r\n      new PresetFolderConfig(folder, options).render(true);\r\n    }).then(() => this.render(true));\r\n  }\r\n\r\n  async _onFolderDelete(uuid, { render = true, deleteAll = false } = {}) {\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder) {\r\n      let confirm;\r\n\r\n      if (deleteAll) {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Delete', false)}: ${folder.name}`,\r\n          content: `<div style=\"color:red;\"><h4>${localize('AreYouSure', false)}</h4><p>${localize(\r\n            'FOLDER.DeleteWarning',\r\n            false\r\n          )}</p></div>`,\r\n        });\r\n      } else {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Remove', false)}: ${folder.name}`,\r\n          content: `<h4>${localize('AreYouSure', false)}</h4><p>${localize('FOLDER.RemoveWarning', false)}</p>`,\r\n        });\r\n      }\r\n\r\n      if (confirm) {\r\n        await PresetCollection.deleteFolder(uuid, deleteAll);\r\n        if (render) this.render(true);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Throttle input and perform preset search\r\n  _onSearchInput(event) {\r\n    clearTimeout(this._searchTimer);\r\n    this._searchTimer = setTimeout(() => this._onSearch(event), 250);\r\n  }\r\n\r\n  async _onSearch(event) {\r\n    let newSearch = event.target.value;\r\n    let previousSearch = MassEditPresets.lastSearch || '';\r\n    MassEditPresets.lastSearch = newSearch;\r\n\r\n    if (previousSearch.length >= SEARCH_MIN_CHAR && newSearch.length < SEARCH_MIN_CHAR) {\r\n      $(event.target).removeClass('active');\r\n      this._resetSearchState();\r\n      this._renderContent();\r\n      return;\r\n    }\r\n\r\n    if (newSearch.length < SEARCH_MIN_CHAR) return;\r\n\r\n    const filter = event.target.value\r\n      .trim()\r\n      .toLowerCase()\r\n      .split(' ')\r\n      .filter((w) => w.length >= SEARCH_MIN_CHAR);\r\n    if (!filter.length) return;\r\n    $(event.target).addClass('active');\r\n\r\n    this.tree.folders.forEach((f) => this._searchFolder(filter, f));\r\n    this.tree.extFolders.forEach((f) => this._searchFolder(filter, f));\r\n    this.tree.presets.forEach((p) => this._searchPreset(filter, p));\r\n\r\n    this._renderContent();\r\n  }\r\n\r\n  _searchFolder(filter, folder, forceRender = false) {\r\n    const folderName = folder.name.toLowerCase();\r\n    let match = filter.every((k) => folderName.includes(k));\r\n\r\n    let childFolderMatch = false;\r\n    for (const f of folder.children) {\r\n      if (this._searchFolder(filter, f, match || forceRender)) childFolderMatch = true;\r\n    }\r\n\r\n    let presetMatch = false;\r\n    for (const p of folder.presets) {\r\n      if (this._searchPreset(filter, p, match || forceRender)) presetMatch = true;\r\n    }\r\n\r\n    const containsMatch = match || childFolderMatch || presetMatch;\r\n    folder.expanded = childFolderMatch || presetMatch;\r\n    folder.render = containsMatch || forceRender;\r\n\r\n    return containsMatch;\r\n  }\r\n\r\n  _searchPreset(filter, preset, forceRender = false) {\r\n    const presetName = preset.name.toLowerCase();\r\n    if (filter.every((k) => presetName.includes(k)) || filter.every((k) => preset.tags.includes(k))) {\r\n      preset._render = true;\r\n      return true;\r\n    } else {\r\n      preset._render = false || forceRender;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _resetSearchState() {\r\n    this.tree.folders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.extFolders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStateFolder(folder) {\r\n    folder.expanded = FolderState.expanded(folder.uuid);\r\n    folder.render = true;\r\n    folder.children.forEach((f) => this._resetSearchStateFolder(f));\r\n    folder.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStatePreset(preset) {\r\n    preset._render = true;\r\n  }\r\n\r\n  async _renderContent() {\r\n    const content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/presetsContent.html`, {\r\n      callback: Boolean(this.callback),\r\n      presets: this.tree.presets,\r\n      folders: this.tree.folders,\r\n      createEnabled: Boolean(this.configApp),\r\n      extFolders: this.tree.extFolders.length ? this.tree.extFolders : null,\r\n    });\r\n    this.element.find('.item-list').html(content);\r\n  }\r\n\r\n  async _onFolderSort(sourceUuid, targetUuid, { inside = true, folderUuid = null } = {}) {\r\n    let source = this.tree.allFolders.get(sourceUuid);\r\n    let target = this.tree.allFolders.get(targetUuid);\r\n\r\n    let folders;\r\n    if (folderUuid) folders = this.tree.allFolders.get(folderUuid).children;\r\n    else folders = this.tree.folders;\r\n\r\n    const siblings = [];\r\n    for (const folder of folders) {\r\n      if (folder.uuid !== sourceUuid) siblings.push(folder);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSort(source, {\r\n      target,\r\n      siblings,\r\n      sortBefore: true,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await Folder.updateDocuments(updates, { pack: PresetCollection.workingPack });\r\n    }\r\n    this.render(true);\r\n  }\r\n\r\n  async _onItemSort(sourceUuids, targetUuid, { before = true, folderUuid = null } = {}) {\r\n    const sourceUuidsSet = new Set(sourceUuids);\r\n    const sources = this.tree.allPresets.filter((p) => sourceUuidsSet.has(p.uuid));\r\n\r\n    let target = this.tree.allPresets.find((p) => p.uuid === targetUuid);\r\n\r\n    // Determine siblings based on folder\r\n    let presets;\r\n    if (folderUuid) presets = this.tree.allFolders.get(folderUuid).presets;\r\n    else presets = this.tree.presets;\r\n\r\n    const siblings = [];\r\n    for (const preset of presets) {\r\n      if (!sourceUuidsSet.has(preset.uuid)) siblings.push(preset);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSortMulti(sources, {\r\n      target,\r\n      siblings,\r\n      sortBefore: before,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await PresetCollection.updatePresets(updates);\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSort(event) {\r\n    const currentSort = game.settings.get(MODULE_ID, 'presetSortMode');\r\n    const newSort = currentSort === 'manual' ? 'alphabetical' : 'manual';\r\n    await game.settings.set(MODULE_ID, 'presetSortMode', newSort);\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSearch(event) {\r\n    const searchControl = $(event.target).closest('.toggle-search-mode');\r\n\r\n    const currentMode = game.settings.get(MODULE_ID, 'presetSearchMode');\r\n    const newMode = currentMode === 'p' ? 'pf' : 'p';\r\n    await game.settings.set(MODULE_ID, 'presetSearchMode', newMode);\r\n\r\n    const mode = SEARCH_MODES[newMode];\r\n    searchControl.attr('data-tooltip', mode.tooltip).html(mode.icon);\r\n\r\n    $(this.form).find('.header-search input').trigger('input');\r\n  }\r\n\r\n  _onToggleLock(event) {\r\n    const lockControl = $(event.target).closest('.toggle-doc-lock');\r\n\r\n    let currentLock = game.settings.get(MODULE_ID, 'presetDocLock');\r\n    let newLock = this.docName;\r\n\r\n    if (newLock !== currentLock) lockControl.addClass('active');\r\n    else {\r\n      lockControl.removeClass('active');\r\n      newLock = '';\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'presetDocLock', newLock);\r\n  }\r\n\r\n  _onToggleLayerSwitch(event) {\r\n    const switchControl = $(event.target).closest('.toggle-layer-switch');\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetLayerSwitch');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    game.settings.set(MODULE_ID, 'presetLayerSwitch', value);\r\n  }\r\n\r\n  async _onToggleExtComp(event) {\r\n    const switchControl = $(event.target).closest('.toggle-ext-comp');\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetExtComp');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    await game.settings.set(MODULE_ID, 'presetExtComp', value);\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleScaling(event) {\r\n    const switchControl = $(event.target).closest('.toggle-scaling');\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetScaling');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    game.settings.set(MODULE_ID, 'presetScaling', value);\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    const newDocName = $(event.target).closest('.document-select').data('name');\r\n    if (newDocName != this.docName) {\r\n      this.docName = newDocName;\r\n\r\n      if (game.settings.get(MODULE_ID, 'presetLayerSwitch'))\r\n        canvas.getLayerByEmbeddedName(this.docName === 'Actor' ? 'Token' : this.docName)?.activate();\r\n\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRightClickPreset(eventTarget) {\r\n    const item = $(eventTarget).closest('.item');\r\n\r\n    // If right-clicked item is not selected, de-select the others and select it\r\n    if (!item.hasClass('selected')) {\r\n      item.closest('.item-list').find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n      item.addClass('selected').addClass('last-selected');\r\n    }\r\n  }\r\n\r\n  _editPresets(presets, options = {}, event) {\r\n    options.callback = () => this.render(true);\r\n    if (!('left' in options) && event) {\r\n      options.left = event.originalEvent.x - PresetConfig.defaultOptions.width / 2;\r\n      options.top = event.originalEvent.y;\r\n    }\r\n    new PresetConfig(presets, options).render(true);\r\n  }\r\n\r\n  async _onApplyPreset(event) {\r\n    if (this.callback) {\r\n      const uuid = $(event.target).closest('.item').data('uuid');\r\n      this.callback(await PresetCollection.get(uuid));\r\n    }\r\n  }\r\n\r\n  async _onPresetDragOut(event) {\r\n    const uuid = $(event.originalEvent.target).closest('.item').data('uuid');\r\n    const preset = await PresetCollection.get(uuid);\r\n    if (!preset) return;\r\n\r\n    // If released on top of a Mass Edit form, apply the preset to it instead of spawning it\r\n    const form = hoverMassEditForm(event.pageX, event.pageY, preset.documentName);\r\n    if (form) {\r\n      form._applyPreset(preset);\r\n      return;\r\n    }\r\n\r\n    // If it's a scene preset apply it to the currently active scene\r\n    if (preset.documentName === 'Scene') {\r\n      applyPresetToScene(preset);\r\n      return;\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    // For some reason canvas.mousePosition does not get updated during drag and drop\r\n    // Acquire the cursor position transformed to Canvas coordinates\r\n    let mouseX;\r\n    let mouseY;\r\n    let mouseZ;\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      game.Levels3DPreview.interactionManager._onMouseMove(event, true);\r\n      const { x, y, z } = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n      mouseX = x;\r\n      mouseY = y;\r\n      mouseZ = z;\r\n    } else {\r\n      const [x, y] = [event.clientX, event.clientY];\r\n      const t = canvas.stage.worldTransform;\r\n\r\n      mouseX = (x - t.tx) / canvas.stage.scale.x;\r\n      mouseY = (y - t.ty) / canvas.stage.scale.y;\r\n\r\n      if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n        mouseX -= canvas.dimensions.size / 2;\r\n        mouseY -= canvas.dimensions.size / 2;\r\n      }\r\n    }\r\n\r\n    PresetAPI.spawnPreset({\r\n      preset,\r\n      x: mouseX,\r\n      y: mouseY,\r\n      z: mouseZ,\r\n      mousePosition: false,\r\n      layerSwitch: game.settings.get(MODULE_ID, 'presetLayerSwitch'),\r\n      scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n    });\r\n  }\r\n\r\n  async _onToggleFavorite(event) {\r\n    const item = $(event.target).closest('.item');\r\n    const uuid = item.data('uuid');\r\n    const starControl = item.find('.preset-favorite i');\r\n\r\n    if (uuid) {\r\n      const favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n      if (starControl.hasClass('fa-regular')) {\r\n        starControl.removeClass('fa-regular').addClass('fa-solid');\r\n        favorites[uuid] = true;\r\n      } else {\r\n        starControl.removeClass('fa-solid').addClass('fa-regular');\r\n        delete favorites[uuid];\r\n      }\r\n      game.settings.set(MODULE_ID, 'presetFavorites', favorites);\r\n      Preset.favorites = favorites;\r\n    }\r\n  }\r\n\r\n  async _onActivateBrush(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: false });\r\n    BrushMenu.addPresets(selected);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * Application.setPosition(...) has been modified to use css transform for window translation across the screen\r\n   * instead of top/left css properties which force full-window style recomputation\r\n   */\r\n  setPosition({ left, top, width, height, scale } = {}) {\r\n    if (!this.popOut && !this.options.resizable) return; // Only configure position for popout or resizable apps.\r\n    const el = this.element[0];\r\n    const currentPosition = this.position;\r\n    const pop = this.popOut;\r\n    const styles = window.getComputedStyle(el);\r\n    if (scale === null) scale = 1;\r\n    scale = scale ?? currentPosition.scale ?? 1;\r\n\r\n    // If Height is \"auto\" unset current preference\r\n    if (height === 'auto' || this.options.height === 'auto') {\r\n      el.style.height = '';\r\n      height = null;\r\n    }\r\n\r\n    // Update width if an explicit value is passed, or if no width value is set on the element\r\n    if (!el.style.width || width) {\r\n      const tarW = width || el.offsetWidth;\r\n      const minW = parseInt(styles.minWidth) || (pop ? MIN_WINDOW_WIDTH : 0);\r\n      const maxW = el.style.maxWidth || window.innerWidth / scale;\r\n      currentPosition.width = width = Math.clamped(tarW, minW, maxW);\r\n      el.style.width = `${width}px`;\r\n      if (width * scale + currentPosition.left > window.innerWidth) left = currentPosition.left;\r\n    }\r\n    width = el.offsetWidth;\r\n\r\n    // Update height if an explicit value is passed, or if no height value is set on the element\r\n    if (!el.style.height || height) {\r\n      const tarH = height || el.offsetHeight + 1;\r\n      const minH = parseInt(styles.minHeight) || (pop ? MIN_WINDOW_HEIGHT : 0);\r\n      const maxH = el.style.maxHeight || window.innerHeight / scale;\r\n      currentPosition.height = height = Math.clamped(tarH, minH, maxH);\r\n      el.style.height = `${height}px`;\r\n      if (height * scale + currentPosition.top > window.innerHeight + 1) top = currentPosition.top - 1;\r\n    }\r\n    height = el.offsetHeight;\r\n\r\n    let leftT, topT;\r\n    // Update Left\r\n    if ((pop && !this.posSet) || Number.isFinite(left)) {\r\n      const scaledWidth = width * scale;\r\n      const tarL = Number.isFinite(left) ? left : (window.innerWidth - scaledWidth) / 2;\r\n      const maxL = Math.max(window.innerWidth - scaledWidth, 0);\r\n      currentPosition.left = left = Math.clamped(tarL, 0, maxL);\r\n      leftT = left;\r\n    }\r\n\r\n    // Update Top\r\n    if ((pop && !this.posSet) || Number.isFinite(top)) {\r\n      const scaledHeight = height * scale;\r\n      const tarT = Number.isFinite(top) ? top : (window.innerHeight - scaledHeight) / 2;\r\n      const maxT = Math.max(window.innerHeight - scaledHeight, 0);\r\n      currentPosition.top = Math.clamped(tarT, 0, maxT);\r\n\r\n      topT = currentPosition.top;\r\n    }\r\n\r\n    let transform = '';\r\n\r\n    // Update Scale\r\n    if (scale) {\r\n      currentPosition.scale = Math.max(scale, 0);\r\n\r\n      if (scale === 1) transform += ``;\r\n      else transform += `scale(${scale})`;\r\n    }\r\n\r\n    if (leftT || topT) {\r\n      this.posSet = true;\r\n      transform += 'translate(' + leftT + 'px,' + topT + 'px)';\r\n    }\r\n\r\n    if (transform) {\r\n      el.style.transform = transform;\r\n    }\r\n\r\n    // Track position post window close\r\n    if (!this.options.preventPositionOverride) {\r\n      const { left, top, width, height } = this.position;\r\n      MassEditPresets.previousPosition = { left, top, width, height };\r\n    }\r\n\r\n    // Return the updated position object\r\n    return currentPosition;\r\n  }\r\n\r\n  async close(options = {}) {\r\n    MassEditPresets.objectHover = false;\r\n    return super.close(options);\r\n  }\r\n\r\n  async _onPresetUpdate(event) {\r\n    const preset = await PresetCollection.get($(event.target).closest('.item').data('uuid'));\r\n    if (!preset) return;\r\n\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const randomize = foundry.utils.deepClone(this.configApp.randomizeFields || {});\r\n    const addSubtract = foundry.utils.deepClone(this.configApp.addSubtractFields || {});\r\n\r\n    // Detection modes may have been selected out of order\r\n    // Fix that here\r\n    if (this.docName === 'Token') {\r\n      TokenDataAdapter.correctDetectionModeOrder(selectedFields, randomize);\r\n    }\r\n\r\n    preset.update({ data: selectedFields, randomize, addSubtract });\r\n\r\n    ui.notifications.info(`Preset \"${preset.name}\" updated`);\r\n  }\r\n\r\n  async _onPresetCreate(event) {\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const preset = new Preset({\r\n      name: localize('presets.default-name'),\r\n      documentName: this.docName,\r\n      data: selectedFields,\r\n      addSubtract: this.configApp.addSubtractFields,\r\n      randomize: this.configApp.randomizeFields,\r\n    });\r\n\r\n    await PresetCollection.set(preset);\r\n    this.render(true);\r\n\r\n    this._editPresets([preset], { isCreate: true }, event);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped on the form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n\r\n    // Switch to just created preset's category before rendering if not set to 'ALL'\r\n    const documentName = placeables[0].document.documentName;\r\n    if (this.docName !== 'ALL' && this.docName !== documentName) this.docName = documentName;\r\n\r\n    const options = { isCreate: true };\r\n    options.left = this.position.left + this.position.width + 20;\r\n    options.top = this.position.top;\r\n\r\n    this._editPresets(presets, options, event);\r\n    this.render(true);\r\n  }\r\n\r\n  async actorToPreset(actor) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n  }\r\n\r\n  _getActiveEffectFields() {\r\n    return { changes: foundry.utils.deepClone(this.configApp.object.changes ?? []) };\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-change-compendium',\r\n      icon: 'fa-solid fa-gear',\r\n      onclick: (ev) => this._onWorkingPackChange(),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-import',\r\n      icon: 'fas fa-file-import',\r\n      onclick: (ev) => this._onImport(ev),\r\n    });\r\n\r\n    if (CONFIG.debug.MassEdit) {\r\n      buttons.unshift({\r\n        label: 'Debug',\r\n        class: 'mass-edit-debug',\r\n        icon: 'fas fa-bug',\r\n        onclick: (ev) => {\r\n          console.log({\r\n            index: game.packs.get(PresetCollection.workingPack).get(META_INDEX_ID)?.flags[MODULE_ID]?.index,\r\n            tree: this.tree,\r\n          });\r\n        },\r\n      });\r\n    }\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _onWorkingPackChange() {\r\n    let pack = await new Promise((resolve) => getCompendiumDialog(resolve, {}));\r\n    if (pack && pack !== PresetCollection.workingPack) {\r\n      await game.settings.set(MODULE_ID, 'workingPack', pack);\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onExport() {\r\n    const tree = await PresetCollection.getTree(null, true);\r\n    exportPresets(tree.allPresets);\r\n  }\r\n\r\n  async _onImport() {\r\n    const json = await importPresetFromJSONDialog();\r\n    if (!json) return;\r\n\r\n    let importCount = 0;\r\n\r\n    if (foundry.utils.getType(json) === 'Array') {\r\n      for (const p of json) {\r\n        if (!('documentName' in p)) continue;\r\n        if (!('data' in p) || foundry.utils.isEmpty(p.data)) continue;\r\n\r\n        const preset = new Preset(p);\r\n        preset._pages = p.pages;\r\n\r\n        await PresetCollection.set(preset);\r\n        importCount++;\r\n      }\r\n    }\r\n\r\n    ui.notifications.info(`Mass Edit: ${localFormat('presets.imported', { count: importCount })}`);\r\n\r\n    if (importCount) this.render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (this.callback) {\r\n      this.callback(await PresetCollection.get(event.submitter.data.id));\r\n    }\r\n  }\r\n}\r\n\r\nasync function exportPresets(presets, fileName) {\r\n  if (!presets.length) return;\r\n\r\n  for (const preset of presets) {\r\n    await preset.load();\r\n  }\r\n\r\n  presets = presets.map((p) => {\r\n    const preset = p.clone();\r\n    preset.folder = null;\r\n    preset.uuid = null;\r\n    return preset;\r\n  });\r\n\r\n  saveDataToFile(JSON.stringify(presets, null, 2), 'text/json', (fileName ?? 'mass-edit-presets') + '.json');\r\n}\r\n\r\nexport class PresetConfig extends FormApplication {\r\n  static name = 'PresetConfig';\r\n\r\n  /**\r\n   * @param {Array[Preset]} presets\r\n   */\r\n  constructor(presets, options = {}) {\r\n    super({}, options);\r\n    this.presets = presets;\r\n    this.callback = options.callback;\r\n    this.isCreate = options.isCreate;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetEdit.html`,\r\n      width: 360,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return 'mass-edit-preset-edit';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    if (this.presets.length > 1) return `Presets [${this.presets.length}]`;\r\n    else return `Preset: ${this.presets[0].name.substring(0, 20)}${this.presets[0].name.length > 20 ? '...' : ''}`;\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    return buttons;\r\n  }\r\n\r\n  _onExport() {\r\n    let fileName;\r\n    if (this.presets.length === 1) {\r\n      fileName = 'mass-edit-preset-' + this.presets[0].name.replace(' ', '_').replace(/\\W/g, '');\r\n    }\r\n    exportPresets(this.presets, fileName);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = {};\r\n    data.advancedOpen = this.advancedOpen;\r\n\r\n    data.preset = {};\r\n    if (this.presets.length === 1) {\r\n      data.preset = deepClone(this.presets[0].toJSON());\r\n      data.displayFieldDelete = true;\r\n      data.displayFieldModify = true;\r\n\r\n      data.attached = this.attached || data.preset.attached;\r\n      if (data.attached) {\r\n        data.attached = data.attached.map((at) => {\r\n          let tooltip = at.documentName;\r\n          if (at.documentName === 'Token' && at.data.name) tooltip += ': ' + at.data.name;\r\n          return {\r\n            icon: DOC_ICONS[at.documentName] ?? DOC_ICONS.DEFAULT,\r\n            tooltip,\r\n          };\r\n        });\r\n      }\r\n    } else {\r\n      data.multiEdit = true;\r\n      data.preset = {};\r\n    }\r\n\r\n    // Form data stored if re-render was required\r\n    if (this._submitData) {\r\n      foundry.utils.mergeObject(data.preset, this._submitData);\r\n    }\r\n\r\n    data.minlength = this.presets.length > 1 ? 0 : 1;\r\n    data.tva = game.modules.get('token-variants')?.active;\r\n\r\n    if (this.data && !(this.data instanceof Array)) {\r\n      data.modifyDisabled = true;\r\n      data.deleteDisabled = true;\r\n    }\r\n\r\n    // Check if all presets are for the same document type and thus can be edited using a Mass Edit form\r\n    const docName = this.presets[0].documentName;\r\n    if (docName !== 'Actor' && this.presets.every((p) => p.documentName === docName)) {\r\n      data.documentEdit = docName;\r\n      data.isPlaceable = SUPPORTED_PLACEABLES.includes(docName);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    // Auto-select so that the pre-defined names can be conveniently erased\r\n    html.find('[name=\"name\"]').select();\r\n\r\n    html.find('.edit-document').on('click', this._onEditDocument.bind(this));\r\n    html.find('.assign-document').on('click', this._onAssignDocument.bind(this));\r\n    html.find('.delete-fields').on('click', this._onDeleteFields.bind(this));\r\n    html.find('.spawn-fields').on('click', this._onSpawnFields.bind(this));\r\n    html.find('summary').on('click', () => setTimeout(() => this.setPosition({ height: 'auto' }), 30));\r\n    html.find('.attached').on('click', this.onAttachedRemove.bind(this));\r\n    html.find('.attach-selected').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // TVA Support\r\n    const tvaButton = html.find('.token-variants-image-select-button');\r\n    tvaButton.on('click', (event) => {\r\n      game.modules.get('token-variants').api.showArtSelect('Preset', {\r\n        callback: (imgSrc, name) => {\r\n          tvaButton.siblings(`[name=\"${tvaButton.data('target')}\"]`).val(imgSrc);\r\n        },\r\n        searchType: 'Item',\r\n      });\r\n    });\r\n\r\n    // Advanced Options tracking between renders\r\n    html.find('details').on('toggle', (event) => {\r\n      this.advancedOpen = Boolean($(event.target).attr('open'));\r\n    });\r\n\r\n    //Hover\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (this.presets.length !== 1) return;\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          PresetConfig.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          PresetConfig.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        if (this.presets.length !== 1) return;\r\n        hoverOverlay.hide();\r\n        PresetConfig.objectHover = false;\r\n      });\r\n\r\n    //Tags\r\n    TagInput.activateListeners(html, () => this.setPosition({ height: 'auto' }));\r\n  }\r\n\r\n  _getSubmitData(updateData = {}) {\r\n    const data = super._getSubmitData(updateData);\r\n\r\n    data.name = data.name.trim();\r\n    data.img = data.img.trim() || null;\r\n    data.preSpawnScript = data.preSpawnScript?.trim();\r\n    data.postSpawnScript = data.postSpawnScript?.trim();\r\n    data.tags = data.tags ? data.tags.split(',') : [];\r\n    data.addTags = data.addTags ? data.addTags.split(',') : [];\r\n    data.removeTags = data.removeTags ? data.removeTags.split(',') : [];\r\n\r\n    return data;\r\n  }\r\n\r\n  async render(force = false) {\r\n    if (this.form) this._submitData = this._getSubmitData();\r\n    return await super.render(force);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped ont he form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    this.advancedOpen = true;\r\n\r\n    if (!this.attached) this.attached = deepClone(this.presets[0].attached ?? []);\r\n    placeables.forEach((p) => this.attached.push({ documentName: p.document.documentName, data: placeableToData(p) }));\r\n\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async onAttachedRemove(event) {\r\n    const index = $(event.target).closest('.attached').data('index');\r\n    this.attached = this.attached || deepClone(this.presets[0].attached);\r\n    this.attached.splice(index, 1);\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async _onSpawnFields() {\r\n    new PresetFieldModify(\r\n      this.data ?? this.presets[0].data,\r\n      (modifyOnSpawn) => {\r\n        this.modifyOnSpawn = modifyOnSpawn;\r\n      },\r\n      this.modifyOnSpawn ?? this.presets[0].modifyOnSpawn\r\n    ).render(true);\r\n  }\r\n\r\n  async _onDeleteFields() {\r\n    new PresetFieldDelete(this.data ?? this.presets[0].data, (data) => {\r\n      this.data = data;\r\n    }).render(true);\r\n  }\r\n\r\n  async _onAssignDocument() {\r\n    const layer = canvas.getLayerByEmbeddedName(this.presets[0].documentName);\r\n    if (!layer) return;\r\n\r\n    const data = layer.controlled.map((p) => placeableToData(p));\r\n    if (data.length) {\r\n      this.data = data;\r\n      ui.notifications.info(\r\n        localFormat('presets.assign', {\r\n          count: data.length,\r\n          document: this.presets[0].documentName,\r\n        })\r\n      );\r\n      this.gridSize = canvas.grid.size;\r\n      this.modifyOnSpawn = [];\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onEditDocument() {\r\n    const documents = [];\r\n    const cls = CONFIG[this.presets[0].documentName].documentClass;\r\n\r\n    for (const p of this.presets) {\r\n      p.data.forEach((d) => documents.push(new cls(mergePresetDataToDefaultDoc(p, d))));\r\n    }\r\n\r\n    const app = await showMassEdit(documents, null, {\r\n      presetEdit: true,\r\n      callback: (obj) => {\r\n        this.addSubtract = {};\r\n        this.randomize = {};\r\n        for (const k of Object.keys(obj.data)) {\r\n          if (k in obj.randomize) this.randomize[k] = obj.randomize[k];\r\n          if (k in obj.addSubtract) this.addSubtract[k] = obj.addSubtract[k];\r\n        }\r\n        this.data = obj.data;\r\n        this.render(true);\r\n      },\r\n      forceForm: true,\r\n    });\r\n\r\n    // For randomize and addSubtract only take into account the first preset\r\n    // and apply them to the form\r\n    const preset = new Preset({\r\n      data: {},\r\n      randomize: this.presets[0].randomize,\r\n      addSubtract: this.presets[0].addSubtract,\r\n    });\r\n    setTimeout(() => {\r\n      app._applyPreset(preset);\r\n    }, 400);\r\n  }\r\n\r\n  async _updatePresets(formData) {\r\n    for (const preset of this.presets) {\r\n      let update;\r\n      if (this.isCreate) {\r\n        update = {\r\n          name: formData.name || preset.name || localize('presets.default-name'),\r\n          img: formData.img ?? preset.img,\r\n        };\r\n      } else {\r\n        update = {\r\n          name: formData.name || preset.name,\r\n          img: formData.img || preset.img,\r\n        };\r\n      }\r\n\r\n      if (this.data) update.data = this.data;\r\n      if (this.addSubtract) update.addSubtract = this.addSubtract;\r\n      if (this.randomize) update.randomize = this.randomize;\r\n      if (this.modifyOnSpawn) update.modifyOnSpawn = this.modifyOnSpawn;\r\n      if (this.gridSize) update.gridSize = this.gridSize;\r\n      if (this.attached) update.attached = this.attached;\r\n      if (formData.preSpawnScript != null) update.preSpawnScript = formData.preSpawnScript;\r\n      if (formData.postSpawnScript != null) update.postSpawnScript = formData.postSpawnScript;\r\n      if (formData.spawnRandom != null) update.spawnRandom = formData.spawnRandom;\r\n\r\n      // If this is a single preset config, we override all tags\r\n      // If not we merge\r\n      if (this.presets.length === 1) {\r\n        update.tags = formData.tags;\r\n      } else if (formData.addTags.length || formData.removeTags.length) {\r\n        let tags = preset.tags ?? [];\r\n        if (formData.addTags.length) tags = Array.from(new Set(tags.concat(formData.addTags)));\r\n        if (formData.removeTags.length) tags = tags.filter((t) => !formData.removeTags.includes(t));\r\n        update.tags = tags;\r\n      }\r\n\r\n      await preset.update(update);\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    await this._updatePresets(formData);\r\n\r\n    if (this.callback) this.callback(this.presets);\r\n    return this.presets;\r\n  }\r\n\r\n  /** @inheritDoc */\r\n  async _renderOuter() {\r\n    const html = await super._renderOuter();\r\n    this._createDocumentIdLink(html);\r\n    return html;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Create an ID link button in the header which displays the JournalEntry ID and copies it to clipboard\r\n   * @param {jQuery} html\r\n   * @protected\r\n   */\r\n  _createDocumentIdLink(html) {\r\n    const title = html.find('.window-title');\r\n    const label = localize('DOCUMENT.JournalEntry', false);\r\n    const idLink = document.createElement('a');\r\n    idLink.classList.add('document-id-link');\r\n    idLink.setAttribute('alt', 'Copy document id');\r\n    idLink.dataset.tooltip = `${label}: ${this.presets.map((p) => p.id).join(', ')}`;\r\n    idLink.dataset.tooltipDirection = 'UP';\r\n    idLink.innerHTML = '<i class=\"fa-solid fa-passport\"></i>';\r\n    idLink.addEventListener('click', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.id).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'id',\r\n          id: this.presets.map((p) => p.id).join(', '),\r\n        })\r\n      );\r\n    });\r\n    idLink.addEventListener('contextmenu', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.uuid).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'uuid',\r\n          id: this.presets.map((p) => p.uuid).join(', '),\r\n        })\r\n      );\r\n    });\r\n    title.append(idLink);\r\n  }\r\n}\r\n\r\nclass PresetFieldSelect extends FormApplication {\r\n  static name = 'PresetFieldSelect';\r\n\r\n  constructor(data, callback) {\r\n    super();\r\n    this.presetData = data;\r\n    this.isObject = !(data instanceof Array);\r\n    this.callback = callback;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'preset-field-select', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFieldSelect.html`,\r\n      width: 600,\r\n      resizable: false,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.item').on('click', this._onFieldClick);\r\n  }\r\n\r\n  _onFieldClick(e) {\r\n    itemSelect(e, $(e.target).closest('.preset-field-list'));\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const singleData = !this.isObject && this.presetData.length === 1;\r\n\r\n    let index;\r\n    let fields = [];\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (!singleData) {\r\n        const i = k.split('.')[0];\r\n        if (!index) {\r\n          fields.push({ header: true, index: 0 });\r\n        } else if (i !== index) {\r\n          fields.push({ header: true, index: i });\r\n        }\r\n        index = i;\r\n      }\r\n\r\n      let label = k;\r\n      if (singleData) label = label.substring(label.indexOf('.') + 1);\r\n\r\n      let value;\r\n      const t = foundry.utils.getType(v);\r\n      if (t === 'Object' || t === 'Array' || t === 'null') value = JSON.stringify(v);\r\n      else value = v;\r\n\r\n      fields.push({ name: k, label, value, selected: false });\r\n    }\r\n\r\n    return { fields };\r\n  }\r\n}\r\n\r\nclass PresetFieldDelete extends PresetFieldSelect {\r\n  static name = 'PresetFieldDelete';\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-delete');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = { icon: '<i class=\"fas fa-trash\"></i>', text: localize('common.delete') };\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const form = $(event.target).closest('form');\r\n    form.find('.item.selected').each(function () {\r\n      const name = $(this).attr('name');\r\n      delete data[name];\r\n    });\r\n    data = expandObject(data);\r\n\r\n    if (!this.isObject) {\r\n      let reorganizedData = [];\r\n      for (let i = 0; i < this.presetData.length; i++) {\r\n        if (!data[i]) continue;\r\n        reorganizedData.push(data[i]);\r\n      }\r\n      data = reorganizedData;\r\n    }\r\n\r\n    this.callback(data);\r\n  }\r\n}\r\n\r\nclass PresetFieldModify extends PresetFieldSelect {\r\n  static name = 'PresetFieldModify';\r\n\r\n  constructor(data, callback, modifyOnSpawn) {\r\n    super(data, callback);\r\n    this.modifyOnSpawn = modifyOnSpawn ?? [];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-modify');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = { icon: '<i class=\"fas fa-check\"></i>', text: localize('CONTROLS.CommonSelect', false) };\r\n    for (const field of data.fields) {\r\n      if (this.modifyOnSpawn.includes(field.name)) field.selected = true;\r\n    }\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    const form = $(event.target).closest('form');\r\n    const modifyOnSpawn = [];\r\n    form.find('.item.selected').each(function () {\r\n      let name = $(this).attr('name');\r\n      modifyOnSpawn.push(name);\r\n    });\r\n\r\n    this.callback(modifyOnSpawn);\r\n  }\r\n}\r\n\r\nclass PresetFolderConfig extends FolderConfig {\r\n  static name = 'PresetFolderConfig';\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'folder-edit'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFolderEdit.html`,\r\n      width: 360,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return this.object.id ? super.id : 'folder-create';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    if (this.object.id) return `${localize('FOLDER.Update', false)}: ${this.object.name}`;\r\n    return localize('FOLDER.Create', false);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.document-select').on('click', this._onDocumentChange.bind(this));\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    $(event.target).closest('.document-select').toggleClass('active');\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const folder = this.document.toObject();\r\n    const label = localize(Folder.implementation.metadata.label, false);\r\n\r\n    let folderDocs = folder.flags[MODULE_ID]?.types ?? ['ALL'];\r\n\r\n    let docs;\r\n\r\n    // This is a non-placeable folder type, so we will not display controls to change types\r\n    if (\r\n      this.options?.folder instanceof PresetPackFolder ||\r\n      (folderDocs.length === 1 && !UI_DOCS.includes(folderDocs[0]))\r\n    ) {\r\n      this.displayTypes = false;\r\n    } else {\r\n      this.displayTypes = true;\r\n      docs = [];\r\n      UI_DOCS.forEach((type) => {\r\n        docs.push({ name: type, icon: DOC_ICONS[type], active: folderDocs.includes(type) });\r\n      });\r\n    }\r\n\r\n    return {\r\n      folder: folder,\r\n      name: folder._id ? folder.name : '',\r\n      newName: localFormat('DOCUMENT.New', { type: label }, false),\r\n      safeColor: folder.color ?? '#000000',\r\n      sortingModes: { a: 'FOLDER.SortAlphabetical', m: 'FOLDER.SortManual' },\r\n      submitText: localize(folder._id ? 'FOLDER.Update' : 'FOLDER.Create', false),\r\n      docs,\r\n      virtualPackFolder: this.options.folder instanceof PresetPackFolder,\r\n      group: this.options.folder?.group,\r\n    };\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    if (this.displayTypes) {\r\n      let visibleTypes = [];\r\n      $(this.form)\r\n        .find('.document-select.active')\r\n        .each(function () {\r\n          visibleTypes.push($(this).data('name'));\r\n        });\r\n      if (!visibleTypes.length) visibleTypes.push('ALL');\r\n\r\n      formData[`flags.${MODULE_ID}.types`] = visibleTypes;\r\n    }\r\n\r\n    let document = this.object;\r\n    if (this.options.folder instanceof PresetPackFolder) {\r\n      // This is a virtual folder used to store Compendium contents within\r\n      // Update using the provided interface\r\n      let update = {};\r\n      ['name', 'color', 'group'].forEach((k) => {\r\n        if (!formData[k]?.trim()) update['-=' + k] = null;\r\n        else update[k] = formData[k].trim();\r\n      });\r\n\r\n      await this.options.folder.update(update);\r\n    } else {\r\n      // This is a real folder, update/create it\r\n      if (!formData.name?.trim()) formData.name = Folder.implementation.defaultName();\r\n      if (this.object.id) await this.object.update(formData);\r\n      else {\r\n        this.object.updateSource(formData);\r\n        document = await Folder.create(this.object, { pack: this.object.pack });\r\n      }\r\n    }\r\n\r\n    this.options.resolve?.(document);\r\n    return document;\r\n  }\r\n}\r\n\r\nfunction checkMouseInWindow(event) {\r\n  let app = $(event.target).closest('.window-app');\r\n  var offset = app.offset();\r\n  let appX = offset.left;\r\n  let appY = offset.top;\r\n  let appW = app.width();\r\n  let appH = app.height();\r\n\r\n  var mouseX = event.pageX;\r\n  var mouseY = event.pageY;\r\n\r\n  if (mouseX > appX && mouseX < appX + appW && mouseY > appY && mouseY < appY + appH) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction getCompendiumDialog(resolve, { excludePack, exportTo = false, keepIdSelect = false } = {}) {\r\n  let config;\r\n  if (exportTo) {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.export-directory-message'),\r\n      buttonLabel: localize('FOLDER.Export', false),\r\n    };\r\n  } else {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.working-directory-message'),\r\n      buttonLabel: localize('common.swap'),\r\n    };\r\n  }\r\n\r\n  let options = '';\r\n  for (const p of game.packs) {\r\n    if (!p.locked && p.documentName === 'JournalEntry') {\r\n      if (p.collection === excludePack) continue;\r\n      const workingPack = p.collection === PresetCollection.workingPack;\r\n      options += `<option value=\"${p.collection}\" ${workingPack ? 'selected=\"selected\"' : ''}>${p.title}</option>`;\r\n    }\r\n  }\r\n\r\n  let content = `\r\n  <p style=\"color: orangered;\">${config.message}</p>\r\n  <div class=\"form-group\">\r\n    <label>${localize('PACKAGE.TagCompendium', false)}</label>\r\n    <div class=\"form-fields\">\r\n      <select style=\"width: 100%; margin-bottom: 10px;\">${options}</select>\r\n    </div>\r\n  </div>`;\r\n\r\n  if (keepIdSelect) {\r\n    content += `\r\n<div class=\"form-group\">\r\n    <label>${localize('presets.keep-ids')}</label>\r\n    <input type=\"checkbox\" name=\"keepId\" checked>\r\n    <p style=\"font-size: smaller;\">${localize('presets.keep-ids-hint')}</p>\r\n</div>`;\r\n  }\r\n\r\n  new Dialog({\r\n    title: config.title,\r\n    content: content,\r\n    buttons: {\r\n      export: {\r\n        label: config.buttonLabel,\r\n        callback: (html) => {\r\n          const pack = $(html).find('select').val();\r\n          if (keepIdSelect) resolve({ pack, keepId: $(html).find('[name=\"keepId\"]').is(':checked') });\r\n          else resolve(pack);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: localize('Cancel', false),\r\n        callback: () => resolve(keepIdSelect ? {} : null),\r\n      },\r\n    },\r\n    close: () => resolve(keepIdSelect ? {} : null),\r\n    default: 'cancel',\r\n  }).render(true);\r\n}\r\n\r\n/**\r\n * Controls select/multi-select flow for item lists\r\n * @param {*} e item click event\r\n * @param {*} itemList list of items that this item exists within\r\n */\r\nfunction itemSelect(e, itemList) {\r\n  const item = $(e.target).closest('.item');\r\n  const items = itemList.find('.item');\r\n  const lastSelected = items.filter('.last-selected');\r\n\r\n  if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {\r\n    lastSelected.removeClass('last-selected');\r\n    items.removeClass('selected');\r\n    item.addClass('selected').addClass('last-selected');\r\n  } else if (e.ctrlKey || e.metaKey) {\r\n    item.toggleClass('selected');\r\n    if (item.hasClass('selected')) {\r\n      lastSelected.removeClass('last-selected');\r\n      item.addClass('last-selected');\r\n    } else item.removeClass('last-index');\r\n  } else if (e.shiftKey) {\r\n    if (lastSelected.length) {\r\n      let itemIndex = items.index(item);\r\n      let lastSelectedIndex = items.index(lastSelected);\r\n\r\n      if (itemIndex === lastSelectedIndex) {\r\n        item.toggleClass('selected');\r\n        if (item.hasClass('selected')) item.addClass('last-selected');\r\n        else lastSelected.removeClass('last-selected');\r\n      } else {\r\n        let itemArr = items.toArray();\r\n        if (itemIndex > lastSelectedIndex) {\r\n          for (let i = lastSelectedIndex; i <= itemIndex; i++) $(itemArr[i]).addClass('selected');\r\n        } else {\r\n          for (let i = lastSelectedIndex; i >= itemIndex; i--) $(itemArr[i]).addClass('selected');\r\n        }\r\n      }\r\n    } else {\r\n      lastSelected.removeClass('last-selected');\r\n      item.toggleClass('selected');\r\n      if (item.hasClass('selected')) item.addClass('last-selected');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Return Mass Edit form that the mouse is over if any\r\n * @param {Number} mouseX\r\n * @param {Number} mouseY\r\n * @param {String} documentName\r\n * @returns {Application|null} MassEdit form\r\n */\r\nfunction hoverMassEditForm(mouseX, mouseY, documentName) {\r\n  const hitTest = function (app) {\r\n    const position = app.position;\r\n    const appX = position.left;\r\n    const appY = position.top;\r\n\r\n    if (mouseX > appX && mouseX < appX + position.width && mouseY > appY && mouseY < appY + position.height)\r\n      return true;\r\n    return false;\r\n  };\r\n\r\n  return Object.values(ui.windows).find((app) => app.meForm && app.documentName === documentName && hitTest(app));\r\n}\r\n","import { MODULE_ID, SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { META_INDEX_FIELDS, META_INDEX_ID } from './collection.js';\r\nimport { placeableToData } from './utils.js';\r\n\r\nconst DOCUMENT_FIELDS = ['id', 'name', 'sort', 'folder'];\r\n\r\nconst PRESET_FIELDS = [\r\n  'id',\r\n  'name',\r\n  'data',\r\n  'sort',\r\n  'folder',\r\n  'uuid',\r\n  'documentName',\r\n  'addSubtract',\r\n  'randomize',\r\n  'img',\r\n  'gridSize',\r\n  'modifyOnSpawn',\r\n  'preSpawnScript',\r\n  'postSpawnScript',\r\n  'spawnRandom',\r\n  'attached',\r\n  'tags',\r\n];\r\n\r\nexport const DOC_ICONS = {\r\n  ALL: 'fas fa-globe',\r\n  FAVORITES: 'fas fa-star',\r\n  Token: 'fas fa-user-circle',\r\n  MeasuredTemplate: 'fas fa-ruler-combined',\r\n  Tile: 'fa-solid fa-cubes',\r\n  Drawing: 'fa-solid fa-pencil-alt',\r\n  Wall: 'fa-solid fa-block-brick',\r\n  AmbientLight: 'fa-regular fa-lightbulb',\r\n  AmbientSound: 'fa-solid fa-music',\r\n  Note: 'fa-solid fa-bookmark',\r\n  Actor: 'fas fa-user-alt',\r\n  Scene: 'fas fa-map',\r\n  DEFAULT: 'fa-solid fa-question',\r\n};\r\n\r\nexport class Preset {\r\n  static name = 'Preset';\r\n  document;\r\n\r\n  constructor(data) {\r\n    this.id = data.id ?? data._id ?? foundry.utils.randomID();\r\n    this.name = data.name ?? 'Mass Edit Preset';\r\n    this.documentName = data.documentName;\r\n    this.sort = data.sort ?? 0;\r\n    this.tags = data.tags ?? [];\r\n    this.addSubtract =\r\n      data.addSubtract instanceof Array\r\n        ? Object.fromEntries(data.addSubtract)\r\n        : foundry.utils.deepClone(data.addSubtract ?? {});\r\n    this.randomize =\r\n      data.randomize instanceof Array\r\n        ? Object.fromEntries(data.randomize)\r\n        : foundry.utils.deepClone(data.randomize ?? {});\r\n    this.data = foundry.utils.deepClone(data.data);\r\n    this.img = data.img;\r\n    this.folder = data.folder;\r\n    this.uuid = data.uuid;\r\n    this.gridSize = data.gridSize;\r\n    this.modifyOnSpawn = data.modifyOnSpawn;\r\n    this.preSpawnScript = data.preSpawnScript;\r\n    this.postSpawnScript = data.postSpawnScript;\r\n    this.attached = data.attached;\r\n    this.spawnRandom = data.spawnRandom;\r\n    this._visible = true;\r\n    this._render = true;\r\n  }\r\n\r\n  get visible() {\r\n    return this._visible && this._render;\r\n  }\r\n\r\n  get icon() {\r\n    return DOC_ICONS[this.documentName] ?? DOC_ICONS.DEFAULT;\r\n  }\r\n\r\n  get thumbnail() {\r\n    return this.img || CONST.DEFAULT_TOKEN;\r\n  }\r\n\r\n  get pages() {\r\n    if (this.document?.pages.size) return this.document.toJSON().pages;\r\n    else if (this._pages) return this._pages;\r\n    return null;\r\n  }\r\n\r\n  set data(data) {\r\n    if (data instanceof Array) this._data = data;\r\n    else if (data == null) this._data = null;\r\n    else this._data = [data];\r\n  }\r\n\r\n  get isPlaceable() {\r\n    return SUPPORTED_PLACEABLES.includes(this.documentName);\r\n  }\r\n\r\n  get isFavorite() {\r\n    if (!Preset.favorites) Preset.favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n    return Boolean(Preset.favorites[this.uuid]);\r\n  }\r\n\r\n  get data() {\r\n    return this._data;\r\n  }\r\n\r\n  /**\r\n   * Loads underlying JournalEntry document from the compendium\r\n   * @returns this\r\n   */\r\n  async load() {\r\n    if (!this.document && this.uuid) {\r\n      this.document = await fromUuid(this.uuid);\r\n      if (this.document) {\r\n        const preset = this.document.getFlag(MODULE_ID, 'preset') ?? {};\r\n        this.documentName = preset.documentName;\r\n        this.img = preset.img;\r\n        this.data = preset.data;\r\n        this.randomize =\r\n          foundry.utils.getType(preset.randomize) === 'Object'\r\n            ? preset.randomize\r\n            : Object.fromEntries(preset.randomize ?? []);\r\n        this.addSubtract =\r\n          foundry.utils.getType(preset.addSubtract) === 'Object'\r\n            ? preset.addSubtract\r\n            : Object.fromEntries(preset.addSubtract ?? []);\r\n        this.gridSize = preset.gridSize;\r\n        this.modifyOnSpawn = preset.modifyOnSpawn;\r\n        this.preSpawnScript = preset.preSpawnScript;\r\n        this.postSpawnScript = preset.postSpawnScript;\r\n        this.attached = preset.attached;\r\n        this.spawnRandom = preset.spawnRandom;\r\n        this.tags = preset.tags ?? [];\r\n      }\r\n    }\r\n    return this;\r\n  }\r\n\r\n  async openJournal() {\r\n    if (!this.document) await this.load();\r\n    if (this.document) this.document.sheet.render(true);\r\n  }\r\n\r\n  /**\r\n   * Attach placeables\r\n   * @param {Placeable|Array[Placeable]} placeables\r\n   * @returns\r\n   */\r\n  async attach(placeables) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    if (!this.attached) this.attached = [];\r\n    for (const placeable of placeables) {\r\n      this.attached.push({ documentName: placeable.document.documentName, data: placeableToData(placeable) });\r\n    }\r\n\r\n    await this.update({ attached: this.attached });\r\n  }\r\n\r\n  /**\r\n   * Update preset with the provided data\r\n   * @param {Object} update\r\n   */\r\n  async update(update) {\r\n    if (this.document) {\r\n      const flagUpdate = {};\r\n      Object.keys(update).forEach((k) => {\r\n        if (k === 'randomize' || k === 'addSubtract') {\r\n          flagUpdate[k] = Object.entries(update[k]);\r\n          this[k] = update[k];\r\n        } else if (k === 'data' && !(update.data instanceof Array)) {\r\n          flagUpdate.data = this.data.map((d) => {\r\n            return foundry.utils.mergeObject(d, update.data);\r\n          });\r\n          this.data = flagUpdate.data;\r\n        } else if (PRESET_FIELDS.includes(k) && update[k] !== this[k]) {\r\n          flagUpdate[k] = update[k];\r\n          this[k] = update[k];\r\n        }\r\n      });\r\n\r\n      if (!foundry.utils.isEmpty(flagUpdate)) {\r\n        const docUpdate = { flags: { [MODULE_ID]: { preset: flagUpdate } } };\r\n        DOCUMENT_FIELDS.forEach((field) => {\r\n          if (field in flagUpdate && this.document[field] !== flagUpdate[field]) {\r\n            docUpdate[field] = flagUpdate[field];\r\n          }\r\n        });\r\n\r\n        await this.document.update(docUpdate);\r\n      }\r\n      await this._updateIndex(flagUpdate);\r\n    } else {\r\n      console.warn('Updating preset without document', this.id, this.uuid, this.name);\r\n    }\r\n  }\r\n\r\n  async _updateIndex(data) {\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((field) => {\r\n      if (field in data) update[field] = data[field];\r\n    });\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      const pack = game.packs.get(this.document.pack);\r\n      const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n      if (metaDoc) {\r\n        let tmp = {};\r\n        tmp[this.id] = update;\r\n        await metaDoc.setFlag(MODULE_ID, 'index', tmp);\r\n      } else {\r\n        console.warn(`META INDEX missing in ${this.document.pack}`);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  toJSON() {\r\n    let json = {};\r\n    PRESET_FIELDS.forEach((field) => {\r\n      json[field] = this[field];\r\n    });\r\n\r\n    json.randomize = Object.entries(json.randomize ?? {});\r\n    json.addSubtract = Object.entries(json.addSubtract ?? {});\r\n    const pages = this.pages;\r\n    if (pages) json.pages = pages;\r\n\r\n    return json;\r\n  }\r\n\r\n  clone() {\r\n    const clone = new Preset(this.toJSON());\r\n    clone.document = this.document;\r\n    return clone;\r\n  }\r\n}\r\n","import { showGenericForm } from '../../applications/multiConfig.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { Preset } from './preset.js';\r\n\r\n/**\r\n * Tracking of folder open/close state\r\n */\r\nexport class FolderState {\r\n  static expanded(uuid) {\r\n    return game.folders._expanded[uuid];\r\n  }\r\n\r\n  static setExpanded(uuid, state) {\r\n    game.folders._expanded[uuid] = state;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert provided placeable into an object usable as Preset data\r\n * @param {Placeable} placeable\r\n * @returns\r\n */\r\nexport function placeableToData(placeable) {\r\n  const data = placeable.document.toCompendium();\r\n\r\n  // Check if `Token Attacher` has attached elements to this token\r\n  if (\r\n    placeable.document.documentName === 'Token' &&\r\n    game.modules.get('token-attacher')?.active &&\r\n    tokenAttacher?.generatePrototypeAttached\r\n  ) {\r\n    const attached = data.flags?.['token-attacher']?.attached || {};\r\n    if (!foundry.utils.isEmpty(attached)) {\r\n      const prototypeAttached = tokenAttacher.generatePrototypeAttached(data, attached);\r\n      setProperty(data, 'flags.token-attacher.attached', null);\r\n      setProperty(data, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n      setProperty(data, 'flags.token-attacher.grid', {\r\n        size: canvas.grid.size,\r\n        w: canvas.grid.w,\r\n        h: canvas.grid.h,\r\n      });\r\n    }\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * Opens a GenericMassEdit form to modify specific fields within the provided data\r\n * @param {Object} data            data to be modified\r\n * @param {Array[String]} toModify fields within data to be modified\r\n * @returns modified data or null if form was canceled\r\n */\r\nexport async function modifySpawnData(data, toModify) {\r\n  const fields = {};\r\n  const flatData = foundry.utils.flattenObject(data);\r\n  for (const field of toModify) {\r\n    if (field in flatData) {\r\n      if (flatData[field] == null) fields[field] = '';\r\n      else fields[field] = flatData[field];\r\n    }\r\n  }\r\n\r\n  if (!foundry.utils.isEmpty(fields)) {\r\n    await new Promise((resolve) => {\r\n      showGenericForm(fields, 'PresetFieldModify', {\r\n        callback: (modified) => {\r\n          if (foundry.utils.isEmpty(modified)) {\r\n            if (modified == null) data = null;\r\n            resolve();\r\n            return;\r\n          }\r\n\r\n          for (const [k, v] of Object.entries(modified)) {\r\n            flatData[k] = v;\r\n          }\r\n\r\n          const tmpData = foundry.utils.expandObject(flatData);\r\n\r\n          const reorganizedData = [];\r\n          for (let i = 0; i < data.length; i++) {\r\n            reorganizedData.push(tmpData[i]);\r\n          }\r\n          data = reorganizedData;\r\n          resolve();\r\n        },\r\n        simplified: true,\r\n        noTabs: true,\r\n      });\r\n    });\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * A Preset may not contain enough information within its data to spawn a placeable. This method populates\r\n * the data with some defaults so that a minimum viable placeable can be spawned.\r\n * @param {Preset} preset\r\n * @param {Object} presetData\r\n * @returns\r\n */\r\nexport function mergePresetDataToDefaultDoc(preset, presetData) {\r\n  let data;\r\n\r\n  // Set default values if needed\r\n  switch (preset.documentName) {\r\n    case 'Token':\r\n      data = { name: preset.name, elevation: 0, x: 0, y: 0 };\r\n      break;\r\n    case 'Tile':\r\n      data = { width: canvas.grid.w, height: canvas.grid.h, x: 0, y: 0 };\r\n      break;\r\n    case 'AmbientSound':\r\n      data = { radius: 20, x: 0, y: 0 };\r\n      break;\r\n    case 'Drawing':\r\n      data = {\r\n        shape: {\r\n          width: canvas.grid.w * 2,\r\n          height: canvas.grid.h * 2,\r\n          strokeWidth: 8,\r\n          strokeAlpha: 1.0,\r\n        },\r\n        x: 0,\r\n        y: 0,\r\n      };\r\n      break;\r\n    case 'MeasuredTemplate':\r\n      data = { distance: 10, x: 0, y: 0 };\r\n      break;\r\n    case 'AmbientLight':\r\n      data = { config: { dim: 20, bright: 20 }, x: 0, y: 0 };\r\n      break;\r\n    case 'Scene':\r\n      data = { name: preset.name };\r\n      break;\r\n    default:\r\n      data = { x: 0, y: 0 };\r\n  }\r\n\r\n  return foundry.utils.mergeObject(data, presetData);\r\n}\r\n\r\nexport async function randomizeChildrenFolderColors(uuid, tree, callback) {\r\n  const folder = tree.allFolders.get(uuid);\r\n\r\n  const children = folder.children;\r\n  if (!children.length) return;\r\n\r\n  const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n    method: 'interpolateReverse',\r\n    space: 'srgb',\r\n    hue: 'longer',\r\n  });\r\n\r\n  let colorSlider;\r\n\r\n  const applyColors = async function (method, space, hue) {\r\n    const updates = children.map((c) => {\r\n      return {\r\n        color: '#000000',\r\n      };\r\n    });\r\n    const randObj = { color: { type: 'color', method, space, hue, colors: colorSlider.getColors() } };\r\n\r\n    await applyRandomization(updates, children, randObj);\r\n\r\n    for (let i = 0; i < children.length; i++) {\r\n      await children[i].update(updates[i]);\r\n    }\r\n\r\n    callback?.();\r\n  };\r\n\r\n  let dialog = new Dialog({\r\n    title: `Pick Range`,\r\n    content: `<form>${colorTemp}</form>`,\r\n    buttons: {\r\n      save: {\r\n        label: 'Apply',\r\n        callback: async (html) => {\r\n          applyColors(\r\n            html.find('[name=\"method\"]').val(),\r\n            html.find('[name=\"space\"]').val(),\r\n            html.find('[name=\"hue\"]').val()\r\n          );\r\n        },\r\n      },\r\n    },\r\n    render: (html) => {\r\n      import('../randomizer/slider.js').then((module) => {\r\n        colorSlider = new module.ColorSlider(html, [\r\n          { hex: '#663600', offset: 0 },\r\n          { hex: '#944f00', offset: 100 },\r\n        ]);\r\n        setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n      });\r\n    },\r\n  });\r\n\r\n  dialog.render(true);\r\n}\r\n\r\n/**\r\n * Calculates the necessary x and y offsets to place the mouse within the center of the preset data\r\n * assuming the mouse is on the top-left corner of the first element\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataCenterOffset(docToData) {\r\n  const b = getPresetDataBounds(docToData);\r\n  const center = { x: b.x + b.width / 2, y: b.y + b.height / 2 };\r\n  const transform = getTransformToOrigin(docToData);\r\n  return { x: center.x + transform.x, y: center.y + transform.y };\r\n}\r\n\r\n/**\r\n * Returns a transform that return first element to x:0, y:0 (z: 0)\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getTransformToOrigin(docToData) {\r\n  const [name, data] = docToData.entries().next().value;\r\n  const transform = {};\r\n  if (name === 'Wall') {\r\n    const c = data[0].c;\r\n    transform.x = -c[0];\r\n    transform.y = -c[1];\r\n  } else {\r\n    transform.x = -data[0].x;\r\n    transform.y = -data[0].y;\r\n    if (game.Levels3DPreview?._active) {\r\n      const height = data[0].elevation ?? data[0].flags?.levels?.rangeBottom ?? 0;\r\n      transform.z = -height;\r\n    }\r\n  }\r\n  return transform;\r\n}\r\n\r\n/**\r\n * Calculates and returns the overall bounds of the preset data\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataBounds(docToData) {\r\n  let x1 = Number.MAX_SAFE_INTEGER;\r\n  let y1 = Number.MAX_SAFE_INTEGER;\r\n  let x2 = Number.MIN_SAFE_INTEGER;\r\n  let y2 = Number.MIN_SAFE_INTEGER;\r\n  docToData.forEach((dataArr, docName) => {\r\n    for (const data of dataArr) {\r\n      const b = getDataBounds(docName, data);\r\n      if (b.x1 < x1) x1 = b.x1;\r\n      if (b.y1 < y1) y1 = b.y1;\r\n      if (b.x2 > x2) x2 = b.x2;\r\n      if (b.y2 > y2) y2 = b.y2;\r\n    }\r\n  });\r\n  return { x: x1, y: y1, width: x2 - x1, height: y2 - y1 };\r\n}\r\n\r\n/**\r\n * Calculates and returns bounds of placeable's data\r\n * @param {String} docName\r\n * @param {Object} data\r\n * @returns\r\n */\r\nfunction getDataBounds(docName, data) {\r\n  let x1, y1, x2, y2;\r\n\r\n  if (docName === 'Wall') {\r\n    x1 = Math.min(data.c[0], data.c[2]);\r\n    y1 = Math.min(data.c[1], data.c[3]);\r\n    x2 = Math.max(data.c[0], data.c[2]);\r\n    y2 = Math.max(data.c[1], data.c[3]);\r\n  } else {\r\n    x1 = data.x || 0;\r\n    y1 = data.y || 0;\r\n\r\n    let width, height;\r\n    if (docName === 'Tile') {\r\n      width = data.width;\r\n      height = data.height;\r\n    } else if (docName === 'Drawing') {\r\n      width = data.shape.width;\r\n      height = data.shape.height;\r\n    } else if (docName === 'Token') {\r\n      width = data.width * canvas.dimensions.size;\r\n      height = data.height * canvas.dimensions.size;\r\n    } else {\r\n      width = 0;\r\n      height = 0;\r\n    }\r\n\r\n    x2 = x1 + (width || 0);\r\n    y2 = y1 + (height || 0);\r\n  }\r\n  return { x1, y1, x2, y2 };\r\n}\r\n","import { getData, regexStringReplace, wildcardStringReplace } from '../utils.js';\r\n\r\nexport function selectField(control) {\r\n  const formGroup = control.closest('.form-group');\r\n  formGroup.find('.mass-edit-checkbox input').prop('checked', true).trigger('change');\r\n  formGroup.find('.mass-edit-randomize').addClass('active');\r\n}\r\n\r\nexport function deselectField(control, configApp) {\r\n  const formGroup = control.closest('.form-group');\r\n\r\n  let allRandomizedRemoved = true;\r\n  if (configApp) {\r\n    formGroup.find('[name]').each(function () {\r\n      if (allRandomizedRemoved) allRandomizedRemoved = !Boolean(configApp.randomizeFields[this.name]);\r\n    });\r\n  }\r\n\r\n  if (allRandomizedRemoved) {\r\n    formGroup.find('.mass-edit-checkbox input').prop('checked', false).trigger('change');\r\n    formGroup.find('.mass-edit-randomize').removeClass('active');\r\n  }\r\n}\r\n\r\nexport function selectRandomizerFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    selectField(form.find(`[name=\"${key}\"]`));\r\n  }\r\n}\r\n\r\nexport async function applyRandomization(updates, objects, randomizeFields) {\r\n  // See if any field is to be randomized\r\n  if (!randomizeFields || foundry.utils.isEmpty(randomizeFields)) return;\r\n\r\n  let requiresCoordRandomization = false;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    for (const field of Object.keys(update)) {\r\n      if (field in randomizeFields) {\r\n        const obj = randomizeFields[field];\r\n\r\n        if (obj.type === 'select') {\r\n          update[field] = obj.selection[Math.floor(Math.random() * obj.selection.length)];\r\n        } else if (obj.type === 'number') {\r\n          obj.step = obj.step === 'any' ? 1 : Number(obj.step);\r\n          if (Number.isNaN(obj.step)) obj.step = 1;\r\n\r\n          if (obj.method === 'interpolate') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step + 1;\r\n            update[field] = (i % stepsInRange) * obj.step + obj.min;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step;\r\n            update[field] = (stepsInRange - (i % (stepsInRange + 1))) * obj.step + obj.min;\r\n          } else {\r\n            const stepsInRange = (obj.max - obj.min + (Number.isInteger(obj.step) ? 1 : 0)) / obj.step;\r\n            update[field] = Math.floor(Math.random() * stepsInRange) * obj.step + obj.min;\r\n          }\r\n        } else if (obj.type === 'boolean') {\r\n          update[field] = Math.random() < 0.5;\r\n        } else if (obj.type === 'color') {\r\n          // Convert to new format if needed\r\n          if (obj.color1) {\r\n            obj.colors = [\r\n              { hex: obj.color1, offset: 0 },\r\n              { hex: obj.color2, offset: 100 },\r\n            ];\r\n          }\r\n\r\n          // If space is discrete we simple choose a color, no blending required\r\n          if (obj.space === 'discrete') {\r\n            if (obj.method === 'interpolate') {\r\n              update[field] = obj.colors[i % obj.colors.length].hex;\r\n            } else if (obj.method === 'interpolateReverse') {\r\n              update[field] = obj.colors[obj.colors.length - 1 - (i % obj.colors.length)].hex;\r\n            } else {\r\n              update[field] = obj.colors[Math.floor(Math.random() * obj.colors.length)].hex;\r\n            }\r\n            continue;\r\n          }\r\n\r\n          let colors = obj.colors.map((c) => c);\r\n          if (colors[0].offset > 0) {\r\n            colors.unshift({ hex: colors[0].hex, offset: 0 });\r\n          }\r\n          if (colors[colors.length - 1].offset < 100) {\r\n            colors.push({ hex: colors[colors.length - 1].hex, offset: 100 });\r\n          }\r\n\r\n          // Calculate random offset\r\n          let rOffset;\r\n          if (obj.method === 'interpolate') {\r\n            rOffset = 1 - (i + 1) / updates.length;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            rOffset = (i + 1) / updates.length;\r\n          } else {\r\n            rOffset = Math.random();\r\n          }\r\n          rOffset *= 100;\r\n\r\n          // Find the two colors the random offset falls between\r\n          let j = 0;\r\n          while (j < colors.length - 1 && colors[j + 1].offset < rOffset) j++;\r\n          let color1, color2;\r\n          if (j === colors.length - 1) {\r\n            color1 = colors[j - 1];\r\n            color2 = colors[j];\r\n          } else {\r\n            color1 = colors[j];\r\n            color2 = colors[j + 1];\r\n          }\r\n\r\n          // Normalize the random offset\r\n          let rnOffset = rOffset - color1.offset;\r\n          rnOffset = rnOffset / (color2.offset - color1.offset);\r\n\r\n          // Create a Color.js range\r\n          const Color = (await import('../color/color.js')).default;\r\n          color1 = new Color(color1.hex);\r\n          color2 = new Color(color2.hex);\r\n          const space = obj.space || 'srgb';\r\n          const hue = obj.hue || 'shorter';\r\n          let range = color1.range(color2, {\r\n            space: space, // interpolation space\r\n            hue: hue,\r\n            outputSpace: 'srgb',\r\n          });\r\n\r\n          // Pick a color from range using normalized random offset\r\n          let rgb3 = range(rnOffset);\r\n          let hexColor = rgb3.toString({ format: 'hex' });\r\n          if (hexColor.length < 7) {\r\n            // 3 char hex, duplicate chars\r\n            hexColor = '#' + hexColor[1] + hexColor[1] + hexColor[2] + hexColor[2] + hexColor[3] + hexColor[3];\r\n          }\r\n          update[field] = hexColor;\r\n        } else if (obj.type === 'image') {\r\n          if (obj.method === 'sequential') {\r\n            update[field] = obj.images[i % obj.images.length];\r\n          } else {\r\n            update[field] = obj.images[Math.floor(Math.random() * obj.images.length)];\r\n          }\r\n\r\n          if (obj.maintainAspect) {\r\n            const width = objects?.[i]?.width ?? update.width;\r\n            const height = objects?.[i]?.height ?? update.height;\r\n            if (height != null && width != null) {\r\n              try {\r\n                const tex = await loadTexture(update[field]);\r\n                if (tex) {\r\n                  const tileRatio = width / height;\r\n                  const texRatio = tex.width / tex.height;\r\n                  if (texRatio !== tileRatio) {\r\n                    if (texRatio > tileRatio) {\r\n                      update['texture.scaleX'] = 1;\r\n                      update['texture.scaleY'] = tileRatio;\r\n                    } else {\r\n                      update['texture.scaleX'] = height / width;\r\n                      update['texture.scaleY'] = 1;\r\n                    }\r\n                  }\r\n                }\r\n              } catch (e) {}\r\n            }\r\n          }\r\n        } else if (obj.type === 'text') {\r\n          if (obj.method === 'findAndReplace' || obj.method === 'findAndReplaceRegex') {\r\n            if (objects) {\r\n              const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n              if (!data[field] && !obj.find) {\r\n                update[field] = obj.replace;\r\n              } else if (data[field]) {\r\n                // special handling for Tagger tags\r\n                if (field === 'flags.tagger.tags') {\r\n                  data[field] = data[field].join(',');\r\n                }\r\n\r\n                if (obj.method === 'findAndReplaceRegex') {\r\n                  update[field] = regexStringReplace(obj.find, obj.replace, data[field]);\r\n                } else {\r\n                  update[field] = wildcardStringReplace(obj.find, obj.replace, data[field]);\r\n                }\r\n              }\r\n            }\r\n          } else {\r\n            if (obj.method === 'unique') {\r\n              if (!obj.shuffled) {\r\n                shuffleArray(obj.strings);\r\n                obj.shuffled = true;\r\n                obj.i = -1;\r\n              }\r\n              obj.i++;\r\n              update[field] = obj.strings[obj.i % obj.strings.length];\r\n            } else {\r\n              update[field] = obj.strings[Math.floor(Math.random() * obj.strings.length)];\r\n            }\r\n          }\r\n        } else if (obj.type === 'coordinate') {\r\n          requiresCoordRandomization = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (requiresCoordRandomization) {\r\n    let coordCtrl;\r\n\r\n    // Sort placeables based on size\r\n    let pUpdates = [];\r\n    for (let i = 0; i < objects.length; i++) {\r\n      pUpdates.push({ p: objects[i], update: updates[i] });\r\n    }\r\n    pUpdates.sort(\r\n      (a, b) =>\r\n        (b.p.w ?? b.p.width ?? 0) + (b.p.h ?? b.p.height ?? 0) - (a.p.w ?? a.p.width ?? 0) - (a.p.h ?? a.p.height ?? 0)\r\n    );\r\n\r\n    for (const pUpdate of pUpdates) {\r\n      const obj = randomizeFields.x ?? randomizeFields.y;\r\n      if (obj.method === 'noOverlap') {\r\n        if (!coordCtrl) {\r\n          coordCtrl = {\r\n            freeId: 0,\r\n            boundingBox: obj.boundingBox,\r\n            freeRectangles: { 0: obj.boundingBox },\r\n            stepX: obj.stepX,\r\n            stepY: obj.stepY,\r\n          };\r\n        }\r\n        const [x, y] = randomPlace(pUpdate.p, coordCtrl);\r\n        pUpdate.update.x = x;\r\n        pUpdate.update.y = y;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the closest step increment to the provided number\r\n * @param {*} num\r\n * @param {*} step\r\n * @returns\r\n */\r\nexport function nearestStep(num, step) {\r\n  if (num % step <= step / 2) {\r\n    return num - (num % step);\r\n  }\r\n  return num - (num % step) + step;\r\n}\r\n\r\n/**\r\n * Generates a random number within the given range and step increment\r\n * @param {*} min\r\n * @param {*} max\r\n * @param {*} step\r\n * @returns\r\n */\r\nfunction randomNum(min, max, step) {\r\n  if (step === 'any') step = 1; // default to integer 1 just to avoid very large decimals\r\n  else step = Number(step);\r\n  const stepsInRange = (max - min) / step;\r\n  return Math.floor(Math.random() * (stepsInRange + (Number.isInteger(step) ? 1 : 0))) * step + min;\r\n}\r\n\r\n/**\r\n * In-place random shuffle of an array\r\n * @param {*} array\r\n * @returns\r\n */\r\nfunction shuffleArray(array) {\r\n  var i = array.length,\r\n    j = 0,\r\n    temp;\r\n\r\n  while (i--) {\r\n    j = Math.floor(Math.random() * (i + 1));\r\n\r\n    // swap randomly chosen element with current element\r\n    temp = array[i];\r\n    array[i] = array[j];\r\n    array[j] = temp;\r\n  }\r\n\r\n  return array;\r\n}\r\n\r\n/* ================================\r\n * === Coordinate Randomization ==\r\n * =============================== */\r\n\r\nfunction randomPlace(placeable, ctrl) {\r\n  const width = nearestStep(placeable.w ?? placeable.width, ctrl.stepX);\r\n  const height = nearestStep(placeable.h ?? placeable.height, ctrl.stepY);\r\n\r\n  const rec = { x: 0, y: 0, width: width, height: height };\r\n  const freeRectangles = ctrl.freeRectangles;\r\n\r\n  // get all free rectangles that can contain rec\r\n  let fittingRecs = Object.keys(freeRectangles).filter((id) => _canFit(freeRectangles[id], rec));\r\n\r\n  // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n\r\n  if (fittingRecs.length) {\r\n    // Pick a random free rectangle and choose a random location within so that it fits rec\r\n    const i = fittingRecs[Math.floor(Math.random() * fittingRecs.length)];\r\n    rec.x = randomNum(\r\n      freeRectangles[i].x,\r\n      Math.max(freeRectangles[i].x + freeRectangles[i].width - rec.width, 0),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      freeRectangles[i].y,\r\n      Math.max(freeRectangles[i].y + freeRectangles[i].height - rec.height, 0),\r\n      ctrl.stepY\r\n    );\r\n  } else {\r\n    // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n    rec.x = randomNum(\r\n      ctrl.boundingBox.x,\r\n      Math.max(ctrl.boundingBox.x + ctrl.boundingBox.width - rec.width, ctrl.boundingBox.x),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      ctrl.boundingBox.y,\r\n      Math.max(ctrl.boundingBox.y + ctrl.boundingBox.height - rec.height, ctrl.boundingBox.y),\r\n      ctrl.stepY\r\n    );\r\n  }\r\n\r\n  // Find all free rectangles that this spot overlaps\r\n  let overlaps = Object.keys(freeRectangles).filter((id) => _intersectRec(freeRectangles[id], rec));\r\n\r\n  for (const id of overlaps) {\r\n    const overlap = freeRectangles[id];\r\n    // remove original rectangle\r\n    delete freeRectangles[id];\r\n\r\n    // left split\r\n    if (overlap.x < rec.x) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: rec.x - overlap.x,\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // right split\r\n    if (overlap.x + overlap.width > rec.x + rec.width) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: rec.x + rec.width,\r\n          y: overlap.y,\r\n          width: overlap.x + overlap.width - (rec.x + rec.width),\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // top split\r\n    if (overlap.y < rec.y) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: overlap.width,\r\n          height: rec.y - overlap.y,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // bottom split\r\n    if (overlap.y + overlap.height > rec.y + rec.height) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: rec.y + rec.height,\r\n          width: overlap.width,\r\n          height: overlap.y + overlap.height - (rec.y + rec.height),\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n  }\r\n\r\n  return [rec.x, rec.y];\r\n}\r\n\r\n/**\r\n * Checks if rectangle rec2 can fit within rectangle rec1\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _canFit(rec1, rec2) {\r\n  return rec2.width <= rec1.width && rec2.height <= rec1.height;\r\n}\r\n\r\n/**\r\n * Checks whether rectangle rec1 and rectangle rec2 intersect\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _intersectRec(rec1, rec2) {\r\n  if (rec1.x < rec2.x + rec2.width && rec2.x < rec1.x + rec1.width && rec1.y < rec2.y + rec2.height)\r\n    return rec2.y < rec1.y + rec1.height;\r\n  else return false;\r\n}\r\n\r\n/**\r\n * Check if rectangle rec1 fully contains rectangle rec2\r\n * @param {*} rec1\r\n * @param {*} rec\r\n * @returns\r\n */\r\nfunction _fullyContains(rec1, rec2) {\r\n  return (\r\n    rec1.x <= rec2.x &&\r\n    rec1.x + rec1.width >= rec2.x + rec2.width &&\r\n    rec1.y <= rec2.y &&\r\n    rec1.y + rec1.height >= rec2.y + rec2.height\r\n  );\r\n}\r\n\r\n/**\r\n *\r\n * @param {*} freeRectangles\r\n * @param {*} rec\r\n * @param {*} ctrl\r\n * @returns\r\n */\r\nfunction _addAndMergeFreeRectangle(freeRectangles, rec, ctrl) {\r\n  const keys = Object.keys(freeRectangles);\r\n  for (const key of keys) {\r\n    if (_fullyContains(freeRectangles[key], rec)) {\r\n      return;\r\n    }\r\n  }\r\n  ctrl.freeId++;\r\n  freeRectangles[ctrl.freeId] = rec;\r\n}\r\n","import { GeneralDataAdapter } from '../applications/dataAdapters.js';\r\nimport { MassEditPresets } from './presets/forms.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\n\r\nexport const SUPPORTED_PLACEABLES = [\r\n  'Token',\r\n  'MeasuredTemplate',\r\n  'Tile',\r\n  'Drawing',\r\n  'Wall',\r\n  'AmbientLight',\r\n  'AmbientSound',\r\n  'Note',\r\n];\r\n\r\nexport const UI_DOCS = ['FAVORITES', 'ALL', ...SUPPORTED_PLACEABLES];\r\n\r\nexport const SUPPORT_SHEET_CONFIGS = [...SUPPORTED_PLACEABLES, 'Actor', 'PlaylistSound', 'Scene'];\r\n\r\nexport const SUPPORTED_HISTORY_DOCS = [...SUPPORTED_PLACEABLES, 'Scene', 'Actor', 'PlaylistSound'];\r\n\r\nexport const SUPPORTED_COLLECTIONS = ['Item', 'Cards', 'RollTable', 'Actor', 'JournalEntry', 'Scene'];\r\n\r\nexport function interpolateColor(u, c1, c2) {\r\n  return c1.map((a, i) => Math.floor((1 - u) * a + u * c2[i]));\r\n}\r\n\r\nexport const MODULE_ID = 'multi-token-edit';\r\n\r\n/**\r\n * Returns true of provided path points to an image\r\n */\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['jpg', 'jpeg', 'png', 'svg', 'webp', 'gif'].includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to a video\r\n */\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['mp4', 'ogg', 'webm', 'm4v'].includes(extension);\r\n}\r\n\r\nexport async function recursiveTraverse(path, source, bucket, files = []) {\r\n  const result = await FilePicker.browse(source, path, {\r\n    bucket: bucket,\r\n  });\r\n\r\n  if (result) {\r\n    for (const file of result.files) {\r\n      files.push(file);\r\n    }\r\n\r\n    for (const dir of result.dirs) {\r\n      await recursiveTraverse(dir, source, bucket, files);\r\n    }\r\n  }\r\n\r\n  return files;\r\n}\r\n\r\n// To get rid of v10 warnings\r\nexport function getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n\r\n// Flags are stored inconsistently. Absence of a flag, being set to null, undefined, empty object or empty string\r\n// should all be considered equal\r\nexport function flagCompare(data, flag, flagVal) {\r\n  if (data[flag] == flagVal) return true;\r\n\r\n  const falseyFlagVal =\r\n    flagVal == null ||\r\n    flagVal === false ||\r\n    flagVal === '' ||\r\n    (foundry.utils.getType(flagVal) === 'Object' && foundry.utils.isEmpty(flagVal));\r\n\r\n  const falseyDataVal =\r\n    data[flag] == null ||\r\n    data[flag] === false ||\r\n    data[flag] === '' ||\r\n    (foundry.utils.getType(data[flag]) === 'Object' && foundry.utils.isEmpty(data[flag]));\r\n\r\n  if (falseyFlagVal && falseyDataVal) return true;\r\n\r\n  // Special treatment for Tagger module's tags\r\n  // Instead of directly comparing string we check if it contains the string\r\n  if (flag === 'flags.tagger.tags') {\r\n    const tags = data[flag] || [];\r\n    let compTags = flagVal;\r\n    if (!Array.isArray(compTags)) {\r\n      compTags = flagVal ? flagVal.split(',').map((s) => s.trim()) : [];\r\n    }\r\n    for (const t of compTags) {\r\n      if (!tags.includes(t)) return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  if (flagVal && typeof flagVal === 'string' && flagVal.includes('*')) {\r\n    return wildcardStringMatch(flagVal, data[flag]);\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function hasFlagRemove(flag, formData) {\r\n  const comp = flag.split('.');\r\n  for (let i = comp.length - 1; i >= 1; i--) {\r\n    const tempFlag = comp.slice(0, i).join('.') + '.-=' + comp[i];\r\n    if (tempFlag in formData) {\r\n      return tempFlag;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function selectAddSubtractFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    form\r\n      .find(`[name=\"${key}\"]`)\r\n      .removeClass('me-add')\r\n      .removeClass('me-subtract')\r\n      .addClass(fields[key].method === 'add' ? 'me-add' : 'me-subtract')\r\n      .attr(\r\n        'title',\r\n        fields[key].method === 'add' ? `+ ${localize('form.adding')}` : `- ${localize('form.subtracting')}`\r\n      );\r\n  }\r\n}\r\n\r\nexport function applyAddSubtract(updates, objects, docName, addSubtractFields) {\r\n  // See if any field need to be added or subtracted\r\n  if (!addSubtractFields || foundry.utils.isEmpty(addSubtractFields)) return;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n\r\n    GeneralDataAdapter.dataToForm(docName, objects[i], data);\r\n\r\n    for (const field of Object.keys(update)) {\r\n      if (field in addSubtractFields && field in data) {\r\n        const ctrl = addSubtractFields[field];\r\n        let val = data[field];\r\n\r\n        // Special processing for Tagger module fields\r\n        if (field === 'flags.tagger.tags') {\r\n          const currentTags = Array.isArray(val) ? val : (val ?? '').split(',').map((s) => s.trim());\r\n          const modTags = (update[field] ?? '').split(',').map((s) => s.trim());\r\n          for (const tag of modTags) {\r\n            if (ctrl.method === 'add') {\r\n              if (!currentTags.includes(tag)) currentTags.push(tag);\r\n            } else if (ctrl.method === 'subtract') {\r\n              const index = currentTags.indexOf(tag);\r\n              if (index > -1) currentTags.splice(index, 1);\r\n            }\r\n          }\r\n          update[field] = currentTags.filter((t) => t).join(',');\r\n          continue;\r\n        } else if (ctrl.type === 'text') {\r\n          if (ctrl.method === 'add') {\r\n            const toAdd = 'value' in ctrl ? ctrl.value : update[field];\r\n            if (toAdd.startsWith('>>')) {\r\n              val = toAdd.replace('>>', '') + val;\r\n            } else {\r\n              val += toAdd;\r\n            }\r\n          } else {\r\n            val = val.replace('value' in ctrl ? ctrl.value : update[field], '');\r\n          }\r\n          update[field] = val;\r\n          continue;\r\n        }\r\n\r\n        if (ctrl.method === 'add') {\r\n          val += 'value' in ctrl ? ctrl.value : update[field];\r\n        } else {\r\n          val -= 'value' in ctrl ? ctrl.value : update[field];\r\n        }\r\n        if ('min' in ctrl && val < ctrl.min) {\r\n          val = ctrl.min;\r\n        } else if ('max' in ctrl && val > ctrl.max) {\r\n          val = ctrl.max;\r\n        }\r\n        update[field] = val;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function getCommonData(objects) {\r\n  if (!objects || !objects.length) return {};\r\n  const commonData = foundry.utils.flattenObject(objects[0]);\r\n  for (let i = 1; i < objects.length; i++) {\r\n    const diff = foundry.utils.flattenObject(\r\n      foundry.utils.diffObject(commonData, foundry.utils.flattenObject(objects[i]))\r\n    );\r\n    for (const k of Object.keys(diff)) {\r\n      // Special handling for empty/undefined data\r\n      if ((diff[k] === '' || diff[k] == null) && (commonData[k] === '' || commonData[k] == null)) {\r\n        // matches, do not remove\r\n      } else {\r\n        delete commonData[k];\r\n      }\r\n    }\r\n  }\r\n  return commonData;\r\n}\r\n\r\n/**\r\n * Merges 'other' into 'original' without expanding and duplicating the 'original' if it contains dot notation using keys\r\n */\r\nexport function mergeObjectPreserveDot(original, other = {}, nestedKey = '') {\r\n  if (!other) return;\r\n  for (const [key, val] of Object.entries(original)) {\r\n    const fullKey = nestedKey ? nestedKey + '.' + key : key;\r\n    const t = foundry.utils.getType(val);\r\n    if (t === 'Object') mergeObjectPreserveDot(val, other, fullKey);\r\n    else {\r\n      const prop = getProperty(other, fullKey);\r\n      if (prop !== undefined) {\r\n        original[key] = prop;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function panToFitPlaceables(placeables) {\r\n  placeables = placeables.map((p) => p.object ?? p).filter((p) => p.center);\r\n  if (placeables.length) {\r\n    if (placeables.length === 1) {\r\n      if (placeables[0].center?.x) {\r\n        canvas.animatePan({ x: placeables[0].center.x, y: placeables[0].center.y, duration: 250 });\r\n      }\r\n    } else {\r\n      // Determine top left and bottom right corners to later determine the view's center position and scale\r\n      const topLeft = { x: 999999999, y: 999999999 };\r\n      const bottomRight = { x: -999999999, y: -999999999 };\r\n\r\n      for (let p of placeables) {\r\n        let tlc = p;\r\n        if (p instanceof Wall) {\r\n          tlc = { x: p.center.x - p.width / 2, y: p.center.y - p.height / 2 };\r\n        }\r\n\r\n        if (tlc.x < topLeft.x) topLeft.x = tlc.x;\r\n        if (tlc.y < topLeft.y) topLeft.y = tlc.y;\r\n        if (tlc.x + p.width > bottomRight.x) bottomRight.x = tlc.x + p.width;\r\n        if (tlc.y + p.height > bottomRight.y) bottomRight.y = tlc.y + p.height;\r\n      }\r\n\r\n      // Checking if screen at current scale fits placeables along x and y axis\r\n      let scale = canvas.scene._viewPosition.scale;\r\n      // Adjust the size of the rectangle that placeable occupy in our scale calculations\r\n      // to account for UI elements\r\n      const padding = 100;\r\n      if (bottomRight.x - topLeft.x + padding > canvas.screenDimensions[0] / scale) {\r\n        scale = canvas.screenDimensions[0] / (bottomRight.x - topLeft.x + padding);\r\n      }\r\n      if (bottomRight.y - topLeft.y + padding > canvas.screenDimensions[1] / scale) {\r\n        scale = canvas.screenDimensions[1] / (bottomRight.y - topLeft.y + padding);\r\n      }\r\n\r\n      canvas.animatePan({\r\n        duration: 250,\r\n        scale,\r\n        x: (bottomRight.x - topLeft.x) / 2 + topLeft.x,\r\n        y: (bottomRight.y - topLeft.y) / 2 + topLeft.y,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns a hash code from a string\r\n * @param  {String} str The string to hash.\r\n * @return {Number}    A 32bit integer\r\n * @see http://werxltd.com/wp/2010/05/13/javascript-implementation-of-javas-string-hashcode-method/\r\n */\r\nexport function hashCode(str) {\r\n  let hash = 0;\r\n  for (let i = 0, len = str.length; i < len; i++) {\r\n    let chr = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + chr;\r\n    hash |= 0; // Convert to 32bit integer\r\n  }\r\n  return hash;\r\n}\r\n\r\nfunction escapeRegex(string) {\r\n  return string.replace(/[/\\-\\\\^$+?.()|[\\]{}]/g, '\\\\$&');\r\n}\r\n\r\nexport function wildcardStringMatch(sw, s2) {\r\n  return new RegExp('^' + escapeRegex(sw).replaceAll('*', '.*') + '$').test(s2);\r\n}\r\n\r\nexport function wildcardStringReplace(sw, replaceWith, s2) {\r\n  let re = new RegExp(escapeRegex(sw).replaceAll('*', '.*'), 'g');\r\n  return s2.replaceAll(re, replaceWith);\r\n}\r\n\r\nexport function regexStringReplace(sw, replaceWith, s2) {\r\n  try {\r\n    let re = new RegExp(sw, 'g');\r\n    return s2.replaceAll(re, replaceWith);\r\n  } catch (e) {}\r\n  return s2;\r\n}\r\n\r\nexport function flattenToDepth(obj, d = 0) {\r\n  if (d === 0) return obj;\r\n\r\n  const flat = {};\r\n  for (let [k, v] of Object.entries(obj)) {\r\n    let t = foundry.utils.getType(v);\r\n    if (t === 'Object') {\r\n      if (foundry.utils.isEmpty(v)) flat[k] = v;\r\n      let inner = flattenToDepth(v, d - 1);\r\n      for (let [ik, iv] of Object.entries(inner)) {\r\n        flat[`${k}.${ik}`] = iv;\r\n      }\r\n    } else flat[k] = v;\r\n  }\r\n  return flat;\r\n}\r\n\r\n// TODO\r\nexport function activeEffectPresetSelect(aeConfig) {\r\n  const showPresetGeneric = function (docName) {\r\n    new MassEditPresets(\r\n      aeConfig,\r\n      async (preset) => {\r\n        if (!foundry.utils.isEmpty(preset.randomize)) {\r\n          await applyRandomization(preset.data, null, preset.randomize);\r\n        }\r\n\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        Object.keys(preset.data[0]).forEach((k) => {\r\n          let value;\r\n          if (foundry.utils.getType(preset.data[0][k]) === 'string') value = preset.data[0][k];\r\n          else value = JSON.stringify(preset.data[0][k]);\r\n\r\n          nChanges.push({\r\n            key: docName === 'Token' ? 'ATL.' + k : k,\r\n            mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE,\r\n            priority: 20,\r\n            value,\r\n          });\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      docName\r\n    ).render(true);\r\n  };\r\n\r\n  const showPresetActiveEffect = function () {\r\n    new MassEditPresets(\r\n      aeConfig,\r\n      (preset) => {\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        preset.data[0].changes?.forEach((change) => {\r\n          if (change.key) {\r\n            nChanges.push(\r\n              foundry.utils.mergeObject({ mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE, priority: 20 }, change)\r\n            );\r\n          }\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      'ActiveEffect'\r\n    ).render(true);\r\n  };\r\n\r\n  new Dialog({\r\n    title: localize('common.presets'),\r\n    content: ``,\r\n    buttons: {\r\n      activeEffect: {\r\n        label: 'ActiveEffect',\r\n        callback: () => showPresetActiveEffect(),\r\n      },\r\n      token: {\r\n        label: 'Token',\r\n        callback: () => showPresetGeneric('Token'),\r\n      },\r\n      actor: {\r\n        label: 'Actor',\r\n        callback: () => showPresetGeneric('Actor'),\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport function getDocumentName(doc) {\r\n  const docName = doc.document ? doc.document.documentName : doc.documentName;\r\n  return docName ?? 'NONE';\r\n}\r\n\r\nexport const DOCUMENT_CREATE_REQUESTS = {};\r\n\r\n/**\r\n * Creates documents either directly or by delegating the task to a GM\r\n * @param {String} documentName  document type to be created\r\n * @param {Array[Object]} data   data defining the documents\r\n * @param {String} sceneID       scene the documents should be created on\r\n * @returns placeable documents that have been created\r\n */\r\nexport async function createDocuments(documentName, data, sceneID) {\r\n  if (game.user.isGM) {\r\n    return game.scenes.get(sceneID).createEmbeddedDocuments(documentName, data);\r\n  }\r\n\r\n  const requestID = foundry.utils.randomID();\r\n\r\n  const message = {\r\n    handlerName: 'document',\r\n    args: { sceneID, documentName, data, requestID },\r\n    type: 'CREATE',\r\n  };\r\n  game.socket.emit(`module.${MODULE_ID}`, message);\r\n\r\n  // Self resolve in 4s if no response from a GM is received\r\n  setTimeout(() => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID]?.([]);\r\n  }, 4000);\r\n\r\n  return new Promise((resolve) => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID] = resolve;\r\n  });\r\n}\r\n\r\n/**\r\n * Resolves the delegated create documents request\r\n * @param {object} options\r\n * @param {String} options.requestID          request to be resolved\r\n * @param {String} options.sceneID            scene the documents have been created on\r\n * @param {String} options.documentName       type of document that has been created\r\n * @param {Array[String]} options.documentIDs array of document ids that have been created\r\n */\r\nexport function resolveCreateDocumentRequest({ requestID, sceneID, documentName, documentIDs } = {}) {\r\n  if (!DOCUMENT_CREATE_REQUESTS.hasOwnProperty(requestID)) return;\r\n\r\n  const scene = game.scenes.get(sceneID);\r\n  const documents = [];\r\n  for (const docID of documentIDs) {\r\n    documents.push(scene.getEmbeddedDocument(documentName, docID));\r\n  }\r\n\r\n  DOCUMENT_CREATE_REQUESTS[requestID](documents);\r\n  delete DOCUMENT_CREATE_REQUESTS[requestID];\r\n}\r\n\r\nexport function localize(path, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.localize(`MassEdit.${path}`);\r\n  return game.i18n.localize(path);\r\n}\r\n\r\nexport function localFormat(path, insert, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.format(`MassEdit.${path}`, insert);\r\n  return game.i18n.format(path, insert);\r\n}\r\n\r\nexport async function applyPresetToScene(preset) {\r\n  if (preset && canvas.scene) {\r\n    await preset.load();\r\n    const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n    const randomizer = preset.randomize;\r\n    if (!foundry.utils.isEmpty(randomizer)) {\r\n      await applyRandomization([data], null, randomizer);\r\n    }\r\n\r\n    await canvas.scene.update(data);\r\n\r\n    // Grid doesn't redraw on scene update, do it manually here\r\n    if ('grid.color' in data || 'grid.alpha' in data) {\r\n      canvas.grid.grid.draw({\r\n        color: (data['grid.color'] ?? canvas.scene.grid.color).replace('#', '0x'),\r\n        alpha: Number(data['grid.alpha'] ?? canvas.scene.grid.alpha),\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport async function executeScript(command, { actor, token, ...scope } = {}) {\r\n  // Add variables to the evaluation scope\r\n  const speaker = ChatMessage.implementation.getSpeaker({ actor, token });\r\n  const character = game.user.character;\r\n  token = token || (canvas.ready ? canvas.tokens.get(speaker.token) : null);\r\n  actor = actor || token?.actor || game.actors.get(speaker.actor);\r\n\r\n  // Unpack argument names and values\r\n  const argNames = Object.keys(scope);\r\n  if (argNames.some((k) => Number.isNumeric(k))) {\r\n    throw new Error('Illegal numeric Macro parameter passed to execution scope.');\r\n  }\r\n  const argValues = Object.values(scope);\r\n\r\n  // Define an AsyncFunction that wraps the macro content\r\n  const AsyncFunction = async function () {}.constructor;\r\n  // eslint-disable-next-line no-new-func\r\n  const fn = new AsyncFunction('speaker', 'actor', 'token', 'character', 'scope', ...argNames, `{${command}\\n}`);\r\n\r\n  // Attempt macro execution\r\n  try {\r\n    return await fn.call(this, speaker, actor, token, character, scope, ...argValues);\r\n  } catch (err) {\r\n    ui.notifications.error('MACRO.Error', { localize: true });\r\n  }\r\n}\r\n\r\nexport class SeededRandom {\r\n  /**\r\n   * Seeded variation of the Foundry's randomID(...) function.\r\n   * Generate a random string ID of a given requested length.\r\n   * @param {String} seed      Seed to be fed into random number generator\r\n   * @param {number} length    The length of the random ID to generate\r\n   * @return {string}          Return a string containing random letters and numbers\r\n   */\r\n  static randomID(seed, length = 16) {\r\n    seed = this.cyrb128(seed);\r\n    const random = this.sfc32(seed[0], seed[1], seed[2], seed[3]);\r\n\r\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    const r = Array.from({ length }, () => (random() * chars.length) >> 0);\r\n    return r.map((i) => chars[i]).join('');\r\n  }\r\n\r\n  // Courtesy of bryc\r\n  // github.com/bryc\r\n  static cyrb128(str) {\r\n    let h1 = 1779033703,\r\n      h2 = 3144134277,\r\n      h3 = 1013904242,\r\n      h4 = 2773480762;\r\n    for (let i = 0, k; i < str.length; i++) {\r\n      k = str.charCodeAt(i);\r\n      h1 = h2 ^ Math.imul(h1 ^ k, 597399067);\r\n      h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);\r\n      h3 = h4 ^ Math.imul(h3 ^ k, 951274213);\r\n      h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);\r\n    }\r\n    h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);\r\n    h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);\r\n    h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);\r\n    h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);\r\n    (h1 ^= h2 ^ h3 ^ h4), (h2 ^= h1), (h3 ^= h1), (h4 ^= h1);\r\n    return [h1 >>> 0, h2 >>> 0, h3 >>> 0, h4 >>> 0];\r\n  }\r\n\r\n  // Courtesy of Chris Doty-Humphrey\r\n  // https://pracrand.sourceforge.net/\r\n  static sfc32(a, b, c, d) {\r\n    return function () {\r\n      a |= 0;\r\n      b |= 0;\r\n      c |= 0;\r\n      d |= 0;\r\n      var t = (((a + b) | 0) + d) | 0;\r\n      d = (d + 1) | 0;\r\n      a = b ^ (b >>> 9);\r\n      b = (c + (c << 3)) | 0;\r\n      c = (c << 21) | (c >>> 11);\r\n      c = (c + t) | 0;\r\n      return (t >>> 0) / 4294967296;\r\n    };\r\n  }\r\n}\r\n\r\nexport class TagInput {\r\n  static registerHandlebarsHelper() {\r\n    Handlebars.registerHelper('tagInput', (options) => {\r\n      const name = options.hash.name;\r\n      const label = options.hash.label ?? 'Tags';\r\n\r\n      let tags = options.hash.tags;\r\n      if (!Handlebars.Utils.isArray(tags)) tags = [];\r\n\r\n      // Construct the HTML\r\n      let tagHtml = '';\r\n      tags.forEach((tag) => {\r\n        tagHtml += this._tagField(tag);\r\n      });\r\n\r\n      return new Handlebars.SafeString(`\r\n      <fieldset>\r\n        <legend>${label}</legend>\r\n        <div class=\"form-group me-tags\">\r\n            <input type=\"text\" class=\"tag-input\">  \r\n            <input type=\"text\" class=\"tag-hidden-input\" name=\"${name}\" value=\"${tags.join(',')}\" hidden>\r\n            <button type=\"button\" class=\"add-tag\"><i class=\"fas fa-save\"></i></button>\r\n            <div class=\"tag-container\">${tagHtml}</div>\r\n        </div>\r\n      </fieldset>\r\n    `);\r\n    });\r\n  }\r\n\r\n  static _tagField(tag) {\r\n    return `<div class=\"tag\"><span>${tag}</span> <a class=\"delete-tag\"><i class=\"fa-solid fa-x fa-xs\"></i></a></div>`;\r\n  }\r\n\r\n  static activateListeners(html, resize) {\r\n    html.find('.me-tags .add-tag').on('click', (event) => {\r\n      const meTags = $(event.target).closest('.me-tags');\r\n      const input = meTags.find('.tag-input');\r\n\r\n      const newTags = input\r\n        .val()\r\n        .split(',')\r\n        .map((t) =>\r\n          t\r\n            .trim()\r\n            .replace(/[^0-9a-zA-Z_\\- ]/gi, '')\r\n            .toLowerCase()\r\n        )\r\n        .filter(Boolean);\r\n\r\n      if (newTags.length) {\r\n        input.val('');\r\n        const hiddenInput = meTags.find('.tag-hidden-input');\r\n        const currentTags = hiddenInput.val().split(',').filter(Boolean);\r\n        for (const tag of newTags) {\r\n          if (!currentTags.includes(tag)) {\r\n            currentTags.push(tag);\r\n            meTags.find('.tag-container').append(this._tagField(tag));\r\n          }\r\n        }\r\n        hiddenInput.attr('value', currentTags.join(','));\r\n        if (resize) resize();\r\n      }\r\n    });\r\n\r\n    html.find('.me-tags').on('click', '.delete-tag', (event) => {\r\n      const tag = $(event.target).closest('.tag');\r\n\r\n      // Remove tag from hidden input\r\n      const tagValue = tag.find('span').text();\r\n      const hiddenInput = tag.closest('.me-tags').find('.tag-hidden-input');\r\n      const newTags = hiddenInput\r\n        .val()\r\n        .split(',')\r\n        .filter((t) => t !== tagValue)\r\n        .join(',');\r\n      hiddenInput.attr('value', newTags);\r\n\r\n      // Remove the tag element itself\r\n      tag.remove();\r\n\r\n      if (resize) resize();\r\n    });\r\n  }\r\n}\r\n","module.exports = jQuery;","// SPDX-License-Identifier: MIT\r\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\r\n\r\n'use strict';\r\n\r\n// A shim for the libWrapper library\r\nexport let libWrapper = undefined;\r\n\r\nexport const VERSIONS = [1, 12, 2];\r\nexport const TGT_SPLIT_RE = new RegExp(\r\n  '([^.[]+|\\\\[(\\'([^\\'\\\\\\\\]|\\\\\\\\.)+?\\'|\"([^\"\\\\\\\\]|\\\\\\\\.)+?\")\\\\])',\r\n  'g'\r\n);\r\nexport const TGT_CLEANUP_RE = new RegExp('(^\\\\[\\'|\\'\\\\]$|^\\\\[\"|\"\\\\]$)', 'g');\r\n\r\n// Main shim code\r\nHooks.once('init', () => {\r\n  // Check if the real module is already loaded - if so, use it\r\n  if (globalThis.libWrapper && !(globalThis.libWrapper.is_fallback ?? true)) {\r\n    libWrapper = globalThis.libWrapper;\r\n    return;\r\n  }\r\n\r\n  // Fallback implementation\r\n  libWrapper = class {\r\n    static get is_fallback() {\r\n      return true;\r\n    }\r\n\r\n    static get WRAPPER() {\r\n      return 'WRAPPER';\r\n    }\r\n    static get MIXED() {\r\n      return 'MIXED';\r\n    }\r\n    static get OVERRIDE() {\r\n      return 'OVERRIDE';\r\n    }\r\n\r\n    static register(package_id, target, fn, type = 'MIXED', { chain = undefined, bind = [] } = {}) {\r\n      const is_setter = target.endsWith('#set');\r\n      target = !is_setter ? target : target.slice(0, -4);\r\n      const split = target\r\n        .match(TGT_SPLIT_RE)\r\n        .map((x) => x.replace(/\\\\(.)/g, '$1').replace(TGT_CLEANUP_RE, ''));\r\n      const root_nm = split.splice(0, 1)[0];\r\n\r\n      let obj, fn_name;\r\n      if (split.length == 0) {\r\n        obj = globalThis;\r\n        fn_name = root_nm;\r\n      } else {\r\n        const _eval = eval;\r\n        fn_name = split.pop();\r\n        obj = split.reduce((x, y) => x[y], globalThis[root_nm] ?? _eval(root_nm));\r\n      }\r\n\r\n      let iObj = obj;\r\n      let descriptor = null;\r\n      while (iObj) {\r\n        descriptor = Object.getOwnPropertyDescriptor(iObj, fn_name);\r\n        if (descriptor) break;\r\n        iObj = Object.getPrototypeOf(iObj);\r\n      }\r\n      if (!descriptor || descriptor?.configurable === false)\r\n        throw new Error(\r\n          `libWrapper Shim: '${target}' does not exist, could not be found, or has a non-configurable descriptor.`\r\n        );\r\n\r\n      let original = null;\r\n      const wrapper =\r\n        chain ?? (type.toUpperCase?.() != 'OVERRIDE' && type != 3)\r\n          ? function (...args) {\r\n              return fn.call(this, original.bind(this), ...bind, ...args);\r\n            }\r\n          : function (...args) {\r\n              return fn.call(this, ...bind, ...args);\r\n            };\r\n      if (!is_setter) {\r\n        if (descriptor.value) {\r\n          original = descriptor.value;\r\n          descriptor.value = wrapper;\r\n        } else {\r\n          original = descriptor.get;\r\n          descriptor.get = wrapper;\r\n        }\r\n      } else {\r\n        if (!descriptor.set) throw new Error(`libWrapper Shim: '${target}' does not have a setter`);\r\n        original = descriptor.set;\r\n        descriptor.set = wrapper;\r\n      }\r\n\r\n      descriptor.configurable = true;\r\n      Object.defineProperty(obj, fn_name, descriptor);\r\n    }\r\n  };\r\n});\r\n","import { MODULE_ID } from './utils.js';\r\n\r\n/**\r\n * Enable 'Select' tool for layers that do not have it. (AmbientLight, AmbientSound, MeasuredTemplate, and Note)\r\n */\r\nexport function enableUniversalSelectTool() {\r\n  if (game.modules.get('select-tool-everywhere')?.active) return;\r\n\r\n  const missingLayers = ['AmbientLight', 'AmbientSound', 'MeasuredTemplate', 'Note'];\r\n\r\n  missingLayers.forEach((layer) => {\r\n    Hooks.on(`refresh${layer}`, _placeableRefresh);\r\n  });\r\n\r\n  Hooks.on('canvasReady', () =>\r\n    missingLayers.forEach((layer) => (canvas.getLayerByEmbeddedName(layer).options.controllableObjects = true))\r\n  );\r\n\r\n  Hooks.on('getSceneControlButtons', (controls) => _getControlButtons(controls));\r\n\r\n  // :: Fixes ::\r\n\r\n  // For notes the refresh hook is called while ControlIcon is still loading its texture (see ControlIcon.draw())\r\n  // Once the texture is loaded border visibility will be reset to false undoing our change in _placeableRefresh\r\n  // Instead delay and set visibility after draw to account for this\r\n  Hooks.on('drawNote', (note) => {\r\n    setTimeout(() => _placeableRefresh(note), 10);\r\n  });\r\n\r\n  // To avoid race conditions between multiple AmbientLight _onDragLeftCancel calls we'll defer the\r\n  // canvas.perception update within 'updateSource' via a 'defer' argument\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'AmbientLight.prototype._onDragLeftCancel',\r\n    function (...args) {\r\n      Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this, args);\r\n      this.updateSource({ defer: true });\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n}\r\n\r\n/**\r\n * Insert select tool if missing\r\n */\r\nfunction _getControlButtons(controls) {\r\n  for (const control of controls) {\r\n    if (['lighting', 'sounds', 'measure'].includes(control.name)) {\r\n      if (!control.tools.find((t) => t.name === 'select')) {\r\n        control.tools.unshift({\r\n          name: 'select',\r\n          title: 'CONTROLS.CommonSelect',\r\n          icon: 'fas fa-expand',\r\n        });\r\n        control.activeTool = 'select';\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction _placeableRefresh(placeable) {\r\n  if (placeable.controlled) placeable.controlIcon.border.visible = true;\r\n}\r\n","import { pasteData, showMassEdit, showGenericForm } from './applications/multiConfig.js';\r\n\r\nimport {\r\n  checkApplySpecialFields,\r\n  deleteFromClipboard,\r\n  getObjFormData,\r\n  performMassSearch,\r\n  performMassUpdate,\r\n} from './applications/forms.js';\r\nimport { MassEditGenericForm } from './applications/generic/genericForm.js';\r\nimport {\r\n  activeEffectPresetSelect,\r\n  applyAddSubtract,\r\n  createDocuments,\r\n  flagCompare,\r\n  MODULE_ID,\r\n  resolveCreateDocumentRequest,\r\n  SUPPORTED_HISTORY_DOCS,\r\n  SUPPORTED_PLACEABLES,\r\n  TagInput,\r\n} from './scripts/utils.js';\r\nimport { GeneralDataAdapter } from './applications/dataAdapters.js';\r\nimport { applyRandomization } from './scripts/randomizer/randomizerUtils.js';\r\nimport { libWrapper } from './scripts/shim/shim.js';\r\nimport { enableUniversalSelectTool } from './scripts/selectTool.js';\r\nimport { Preset } from './scripts/presets/preset.js';\r\nimport { DEFAULT_PACK, META_INDEX_ID, PresetAPI, PresetCollection } from './scripts/presets/collection.js';\r\nimport { MassEditPresets, PresetConfig } from './scripts/presets/forms.js';\r\nimport { registerKeybinds, registerSettings } from './scripts/settings.js';\r\nimport { Picker } from './scripts/picker.js';\r\nimport { BrushMenu, activateBrush, deactivateBush, openBrushMenu } from './scripts/brush.js';\r\n\r\nexport const HISTORY = {};\r\n\r\n// Initialize module\r\nHooks.once('init', () => {\r\n  TagInput.registerHandlebarsHelper();\r\n\r\n  registerSettings();\r\n  registerKeybinds();\r\n  enableUniversalSelectTool(); // Enable select tool for all layers\r\n\r\n  // Register history related hooks\r\n  if (game.settings.get(MODULE_ID, 'enableHistory'))\r\n    SUPPORTED_HISTORY_DOCS.forEach((docName) => {\r\n      Hooks.on(`preUpdate${docName}`, (doc, update, options, userId) => {\r\n        updateHistory(doc, update, options, userId);\r\n      });\r\n    });\r\n\r\n  // Register copy-paste wrappers\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onCopy',\r\n    function (wrapped, ...args) {\r\n      if (window.getSelection().toString() === '') {\r\n        // Check if a Mass Config form is open and if so copy data from there\r\n        const meForm = Object.values(ui.windows).find((app) => app.meObjects != null);\r\n        if (meForm?.performMassCopy()) return true;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      // Clear Mass Edit clipboard to allows core pasting again\r\n      if (result) deleteFromClipboard(canvas.activeLayer.constructor.documentName);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onPaste',\r\n    function (wrapped, ...args) {\r\n      if (pasteData()) return true;\r\n      return wrapped(...args);\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Register mouse wheel wrapper to scale/rotate preset previews\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'MouseManager.prototype._onWheel',\r\n    function (wrapped, ...args) {\r\n      const event = args[0];\r\n\r\n      if (\r\n        (Picker.isActive() || BrushMenu.isActive()) &&\r\n        (event.ctrlKey || event.shiftKey || event.metaKey || event.altKey)\r\n      ) {\r\n        // Prevent zooming the entire browser window\r\n        if (event.ctrlKey) event.preventDefault();\r\n\r\n        let dy = (event.delta = event.deltaY);\r\n        if (event.shiftKey && dy === 0) {\r\n          dy = event.delta = event.deltaX;\r\n        }\r\n        if (dy === 0) return;\r\n\r\n        if (event.altKey) Picker.addScaling(event.delta < 0 ? 0.05 : -0.05);\r\n        else if ((event.ctrlKey || event.metaKey) && event.shiftKey) BrushMenu.iterate(event.delta >= 0);\r\n        else if (event.ctrlKey || event.metaKey) Picker.addRotation(event.delta < 0 ? 2.5 : -2.5);\r\n        else if (event.shiftKey) Picker.addRotation(event.delta < 0 ? 15 : -15);\r\n        return;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Add SceneControl option to open Mass Edit form\r\n  if (game.settings.get(MODULE_ID, 'presetSceneControl')) {\r\n    libWrapper.register(\r\n      MODULE_ID,\r\n      'SceneNavigation.prototype._getContextMenuOptions',\r\n      function (wrapped, ...args) {\r\n        const options = wrapped(...args);\r\n        options.push({\r\n          name: 'Mass Edit',\r\n          icon: '<i class=\"fa-solid fa-pen-to-square\"></i>',\r\n          condition: game.user.isGM,\r\n          callback: (li) => {\r\n            const sceneId = li.attr('data-scene-id');\r\n            showMassEdit(game.scenes.get(sceneId));\r\n          },\r\n        });\r\n        return options;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n  }\r\n\r\n  // Intercept and prevent certain placeable drag and drop if they are hovering over the MassEditPresets form\r\n  // passing on the placeable to it to perform preset creation.\r\n  const dragDropHandler = function (wrapped, ...args) {\r\n    if (MassEditPresets.objectHover || PresetConfig.objectHover) {\r\n      this.mouseInteractionManager.cancel(...args);\r\n      const app = Object.values(ui.windows).find(\r\n        (x) =>\r\n          (MassEditPresets.objectHover && x instanceof MassEditPresets) ||\r\n          (PresetConfig.objectHover && x instanceof PresetConfig)\r\n      );\r\n      if (app) {\r\n        const placeables = canvas.activeLayer.controlled.length ? [...canvas.activeLayer.controlled] : [this];\r\n        app.dropPlaceable(placeables, ...args);\r\n      }\r\n      // Pass in a fake event that hopefully is enough to allow other modules to function\r\n      this._onDragLeftCancel(...args);\r\n    } else {\r\n      return wrapped(...args);\r\n    }\r\n  };\r\n\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    libWrapper.register(MODULE_ID, `${name}.prototype._onDragLeftDrop`, dragDropHandler, 'MIXED');\r\n  });\r\n\r\n  // Handle broadcasts\r\n  // Needed to allow players to spawn Presets by delegating create document request to GMs\r\n  game.socket?.on(`module.${MODULE_ID}`, async (message) => {\r\n    const args = message.args;\r\n\r\n    if (message.handlerName === 'document' && message.type === 'CREATE') {\r\n      const isResponsibleGM = !game.users\r\n        .filter((user) => user.isGM && (user.active || user.isActive))\r\n        .some((other) => other.id < game.user.id);\r\n      if (!isResponsibleGM) return;\r\n\r\n      const documents = await createDocuments(args.documentName, args.data, args.sceneID);\r\n      const documentIDs = documents.map((d) => d.id);\r\n\r\n      const message = {\r\n        handlerName: 'document',\r\n        args: {\r\n          requestID: args.requestID,\r\n          sceneID: args.sceneID,\r\n          documentName: args.documentName,\r\n          documentIDs,\r\n        },\r\n        type: 'RESOLVE',\r\n      };\r\n      game.socket.emit(`module.${MODULE_ID}`, message);\r\n    } else if (message.handlerName === 'document' && message.type === 'RESOLVE') {\r\n      resolveCreateDocumentRequest(args);\r\n    }\r\n  });\r\n\r\n  // 'Spotlight Omnisearch' support\r\n  Hooks.on('spotlightOmnisearch.indexBuilt', (INDEX, promises) => {\r\n    if (!game.user.isGM) return;\r\n    // First turn-off preset compendium from being included in omnisearch indexing\r\n    const old = game.settings.get('spotlight-omnisearch', 'compendiumConfig');\r\n    game.packs\r\n      .filter((p) => p.documentName === 'JournalEntry' && p.index.get(META_INDEX_ID))\r\n      .forEach((p) => (old[p.collection] = false));\r\n    game.settings.set('spotlight-omnisearch', 'compendiumConfig', old);\r\n\r\n    // Insert preset index\r\n    const promise = PresetCollection.buildSpotlightOmnisearchIndex(INDEX);\r\n    promises.push(promise);\r\n  });\r\n\r\n  globalThis.MassEdit = {\r\n    GeneralDataAdapter,\r\n    MassEditGenericForm,\r\n    showGenericForm,\r\n    performMassUpdate,\r\n    performMassSearch,\r\n    showMassEdit,\r\n    getPreset: PresetAPI.getPreset,\r\n    getPresets: PresetAPI.getPresets,\r\n    createPreset: PresetAPI.createPreset,\r\n    spawnPreset: PresetAPI.spawnPreset,\r\n    activateBrush: activateBrush,\r\n    deactivateBrush: deactivateBush,\r\n    openBrushMenu: openBrushMenu,\r\n  };\r\n\r\n  game.modules.get(MODULE_ID).api = {\r\n    ...globalThis.MassEdit,\r\n    applyRandomization, // Deprecated\r\n    applyAddSubtract, // Deprecated\r\n    checkApplySpecialFields, // Deprecated\r\n  };\r\n});\r\n\r\n// Preset Scene Control\r\nHooks.on('renderSceneControls', (sceneControls, html, options) => {\r\n  if (!game.user.isGM) return;\r\n  if (!game.settings.get(MODULE_ID, 'presetSceneControl')) return;\r\n\r\n  const presetControl = $(`\r\n<li class=\"scene-control mass-edit-scene-control\" data-control=\"me-presets\" aria-label=\"Mass Edit: Presets\" role=\"tab\" data-tooltip=\"Mass Edit: Presets\">\r\n  <i class=\"fa-solid fa-books\"></i>\r\n</li>\r\n  `);\r\n\r\n  presetControl.on('click', () => {\r\n    let docName = canvas.activeLayer.constructor.documentName;\r\n    if (!SUPPORTED_PLACEABLES.includes(docName)) docName = 'ALL';\r\n\r\n    const presetForm = Object.values(ui.windows).find((app) => app instanceof MassEditPresets);\r\n    if (presetForm) {\r\n      presetForm.close();\r\n      return;\r\n    }\r\n\r\n    new MassEditPresets(null, null, docName, {\r\n      left: presetControl.position().left + presetControl.width() + 40,\r\n    }).render(true);\r\n  });\r\n\r\n  html.find('.control-tools').find('.scene-control').last().after(presetControl);\r\n});\r\n\r\n// Migrate Presets (02/11/2023)\r\nHooks.on('ready', async () => {\r\n  if (!game.packs.get(PresetCollection.workingPack)) {\r\n    game.settings.set(MODULE_ID, 'workingPack', DEFAULT_PACK);\r\n  }\r\n\r\n  if (!game.settings.get(MODULE_ID, 'presetsMigrated')) {\r\n    const presets = game.settings.get(MODULE_ID, 'presets');\r\n    if (foundry.utils.getType(presets) === 'Object' && !foundry.utils.isEmpty(presets)) {\r\n      let newPresets = [];\r\n      for (const documentName of Object.keys(presets)) {\r\n        for (const name of Object.keys(presets[documentName])) {\r\n          let oldPreset = presets[documentName][name];\r\n          let newPreset = { id: foundry.utils.randomID() };\r\n\r\n          newPreset.name = name;\r\n          newPreset.documentName = documentName;\r\n          newPreset.color =\r\n            oldPreset['mass-edit-preset-color'] !== '#ffffff' ? oldPreset['mass-edit-preset-color'] : null;\r\n          newPreset.order = oldPreset['mass-edit-preset-order'] ?? -1;\r\n          newPreset.addSubtract = oldPreset['mass-edit-addSubtract'] ?? {};\r\n          newPreset.randomize = oldPreset['mass-edit-randomize'] ?? {};\r\n\r\n          delete oldPreset['mass-edit-preset-color'];\r\n          delete oldPreset['mass-edit-preset-order'];\r\n          delete oldPreset['mass-edit-addSubtract'];\r\n          delete oldPreset['mass-edit-randomize'];\r\n          delete oldPreset['mass-edit-keybind'];\r\n          newPreset.data = foundry.utils.deepClone(oldPreset);\r\n\r\n          newPresets.push(newPreset);\r\n        }\r\n        game.settings.set(MODULE_ID, 'docPresets', newPresets);\r\n      }\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'presetsMigrated', true);\r\n  }\r\n\r\n  if (!game.settings.get(MODULE_ID, 'presetsCompMigrated')) {\r\n    const docPresets = game.settings.get(MODULE_ID, 'docPresets');\r\n    const presets = docPresets.map((p) => new Preset(p));\r\n    if (presets.length) PresetCollection.set(presets);\r\n    game.settings.set(MODULE_ID, 'presetsCompMigrated', true);\r\n  }\r\n});\r\n\r\n// Attach Mass Config buttons to Token and Tile HUDs\r\n\r\nHooks.on('renderTokenHUD', (hud, html, tokenData) => {\r\n  if (canvas.tokens.controlled.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"config\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\nHooks.on('renderTileHUD', (hud, html, tileData) => {\r\n  const controlledTiles = canvas.background\r\n    ? canvas.background.controlled.concat(canvas.foreground.controlled)\r\n    : canvas.tiles.controlled;\r\n\r\n  if (controlledTiles.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"underfoot\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\n\r\n//\r\n// History Utilities\r\n//\r\n\r\n// Retrieve only the data that is different\r\nfunction getDiffData(obj, docName, update, protoData = true) {\r\n  const flatUpdate = foundry.utils.flattenObject(update);\r\n  const flatObjData = getObjFormData(obj, docName, protoData);\r\n  const diff = foundry.utils.diffObject(flatObjData, flatUpdate);\r\n\r\n  for (const [k, v] of Object.entries(diff)) {\r\n    // Special handling for empty/undefined data\r\n    if ((v === '' || v == null) && (flatObjData[k] === '' || flatObjData[k] == null)) {\r\n      // matches\r\n      delete diff[k];\r\n    }\r\n\r\n    if (k.startsWith('flags.'))\r\n      if (flagCompare(flatObjData, k, v)) {\r\n        delete diff[k];\r\n      }\r\n\r\n    if (docName === 'Token' && ['light.angle', 'rotation'].includes(k)) {\r\n      if (v % 360 === flatObjData[k] % 360) {\r\n        delete diff[k];\r\n      }\r\n    }\r\n  }\r\n\r\n  return diff;\r\n}\r\n\r\nfunction updateHistory(obj, update, options, userId) {\r\n  if (game.user.id !== userId || !game.settings.get(MODULE_ID, 'enableHistory')) return;\r\n\r\n  const historyItem = { timestamp: new Date().toLocaleTimeString(), ctrl: {} };\r\n  ['mass-edit-randomize', 'mass-edit-addSubtract'].forEach((ctrl) => {\r\n    if (ctrl in options) {\r\n      historyItem.ctrl[ctrl] = options[ctrl][0];\r\n    }\r\n  });\r\n  let cUpdate = foundry.utils.deepClone(update);\r\n  delete cUpdate._id;\r\n\r\n  let docName = obj.document ? obj.document.documentName : obj.documentName;\r\n  if (docName === 'Actor') {\r\n    if (cUpdate.prototypeToken || cUpdate.token) {\r\n      saveHistory(\r\n        obj.prototypeToken ?? obj.token,\r\n        cUpdate.prototypeToken ?? cUpdate.token,\r\n        foundry.utils.deepClone(historyItem),\r\n        update._id,\r\n        'Token'\r\n      );\r\n    }\r\n  }\r\n\r\n  saveHistory(obj, cUpdate, historyItem, update._id, docName);\r\n}\r\n\r\nfunction saveHistory(obj, update, historyItem, _id, docName) {\r\n  if (!obj || foundry.utils.isEmpty(update)) return;\r\n\r\n  historyItem.update = foundry.utils.flattenObject(update);\r\n  historyItem.diff = getDiffData(obj, docName, update);\r\n  historyItem._id = _id;\r\n\r\n  const maxLength = game.settings.get(MODULE_ID, 'historyMaxLength') ?? 0;\r\n  const docHistory = HISTORY[docName] ?? [];\r\n  docHistory.push(historyItem);\r\n\r\n  if (docHistory.length > maxLength) {\r\n    docHistory.splice(0, 1);\r\n  }\r\n\r\n  HISTORY[docName] = docHistory;\r\n}\r\n\r\nHooks.on('renderActiveEffectConfig', (app) => {\r\n  const el = $(app.form).find('.effects-header .key');\r\n  if (el.length) {\r\n    const me = $('<i title=\"Apply \\'Mass Edit\\' preset\" style=\"font-size:smaller;color:brown;\"> <a>[ME]</a></i>');\r\n    me.on('click', () => activeEffectPresetSelect(app));\r\n    el.append(me);\r\n  }\r\n});\r\n","import CSSEdit, { STYLES } from '../applications/cssEdit.js';\r\nimport { MassEditGenericForm } from '../applications/generic/genericForm.js';\r\nimport {\r\n  getSelected,\r\n  pasteData,\r\n  showMassActorForm,\r\n  showMassEdit,\r\n  showMassSelect,\r\n} from '../applications/multiConfig.js';\r\nimport { editPreviewPlaceables } from './picker.js';\r\nimport { PresetCollection } from './presets/collection.js';\r\nimport { MassEditPresets } from './presets/forms.js';\r\nimport {\r\n  MODULE_ID,\r\n  SUPPORTED_COLLECTIONS,\r\n  SUPPORTED_PLACEABLES,\r\n  activeEffectPresetSelect,\r\n  getDocumentName,\r\n  localize,\r\n} from './utils.js';\r\n\r\nexport function registerSettings() {\r\n  // Register Settings\r\n  game.settings.register(MODULE_ID, 'cssStyle', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'Solid Background',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'cssCustom', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: STYLES.Default,\r\n  });\r\n\r\n  game.settings.registerMenu(MODULE_ID, 'cssEdit', {\r\n    name: localize('settings.cssEdit.name'),\r\n    hint: localize('settings.cssEdit.hint'),\r\n    label: '',\r\n    scope: 'world',\r\n    icon: 'fas fa-cog',\r\n    type: CSSEdit,\r\n    restricted: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'singleDocDefaultConfig', {\r\n    name: localize('settings.singleDocDefaultConfig.name'),\r\n    hint: localize('settings.singleDocDefaultConfig.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'rangeToTextbox', {\r\n    name: localize('settings.rangeToTextbox.name'),\r\n    hint: localize('settings.rangeToTextbox.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  // Deprecated\r\n  game.settings.register(MODULE_ID, 'presets', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // ===============\r\n  // Preset Settings\r\n\r\n  game.settings.register(MODULE_ID, 'workingPack', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'world.mass-edit-presets-main',\r\n    onChange: (val) => {\r\n      PresetCollection.workingPack = val;\r\n    },\r\n  });\r\n  PresetCollection.workingPack = game.settings.get(MODULE_ID, 'workingPack');\r\n\r\n  game.settings.register(MODULE_ID, 'docPresets', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Array,\r\n    default: [],\r\n  });\r\n\r\n  // Temp setting needed for migration\r\n  game.settings.register(MODULE_ID, 'presetsMigrated', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  // Temp setting needed for migration\r\n  game.settings.register(MODULE_ID, 'presetsCompMigrated', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetDocLock', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: '',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetLayerSwitch', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetExtComp', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetScaling', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetSortMode', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'manual',\r\n  });\r\n\r\n  // p = preset only\r\n  // pf = preset & folder\r\n  game.settings.register(MODULE_ID, 'presetSearchMode', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'pf',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetSceneControl', {\r\n    name: 'Scene Controls: Preset Button',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n    onChange: () => {\r\n      ui.controls.render();\r\n    },\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetFavorites', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // end of Preset Settings\r\n  // ======================\r\n\r\n  game.settings.register(MODULE_ID, 'pinnedFields', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'customControls', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // Disable until duplicate flag value bug is fixed\r\n  // game.settings.register(MODULE_ID, 'enableFlagsTab', {\r\n  //   name: localize('settings.enableFlagsTab.name'),\r\n  //   hint: localize('settings.enableFlagsTab.hint'),\r\n  //   scope: 'world',\r\n  //   config: true,\r\n  //   type: Boolean,\r\n  //   default: true,\r\n  // });\r\n\r\n  game.settings.register(MODULE_ID, 'enableHistory', {\r\n    name: localize('settings.enableHistory.name'),\r\n    hint: localize('settings.enableHistory.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'historyMaxLength', {\r\n    name: localize('settings.historyMaxLength.name'),\r\n    hint: localize('settings.historyMaxLength.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Number,\r\n    default: 10,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'autoSnap', {\r\n    name: localize('settings.autoSnap.name'),\r\n    hint: localize('settings.autoSnap.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'panToSearch', {\r\n    name: localize('settings.panToSearch.name'),\r\n    hint: localize('settings.panToSearch.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  if (game.modules.get('tokenmagic')?.active) {\r\n    game.settings.register(MODULE_ID, 'tmfxFieldsEnable', {\r\n      name: localize('settings.tmfxFieldsEnable.name'),\r\n      hint: localize('settings.tmfxFieldsEnable.hint'),\r\n      scope: 'world',\r\n      config: true,\r\n      type: Boolean,\r\n      default: true,\r\n    });\r\n  }\r\n\r\n  game.settings.register(MODULE_ID, 'brush', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      random: true,\r\n      group: false,\r\n      spawner: true,\r\n      eraser: false,\r\n      lock: false,\r\n      snap: false,\r\n    },\r\n  });\r\n}\r\n\r\nexport function registerKeybinds() {\r\n  game.keybindings.register(MODULE_ID, 'placeablePreviewEdit', {\r\n    name: 'Select Edit Placeables',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyD',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: editPreviewPlaceables,\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'editKey', {\r\n    name: localize('keybindings.editKey.name'),\r\n    hint: localize('keybindings.editKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyE',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w.meObjects);\r\n      if (app) {\r\n        app.close();\r\n        return;\r\n      }\r\n      showMassEdit();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'copyKey', {\r\n    name: 'Copy',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyC',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      // Check if a Mass Config form is open and if so copy data from there\r\n      if (window.getSelection().toString() === '') {\r\n        Object.values(ui.windows)\r\n          .find((app) => app.meObjects != null)\r\n          ?.performMassCopy();\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'pasteKey', {\r\n    name: 'Paste',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyV',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      pasteData();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'selectKey', {\r\n    name: localize('keybindings.selectKey.name'),\r\n    hint: localize('keybindings.selectKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyF',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      showMassSelect();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApply', {\r\n    name: localize('keybindings.presetApply.name'),\r\n    hint: localize('keybindings.presetApply.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyX',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof MassEditPresets);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n\r\n      // Special logic for populating Active Effect\r\n      const aeConfig = Object.values(ui.windows).find((x) => x instanceof ActiveEffectConfig);\r\n      if (aeConfig) {\r\n        activeEffectPresetSelect(aeConfig);\r\n        return;\r\n      }\r\n\r\n      const docName = canvas.activeLayer.constructor.documentName;\r\n      if (!SUPPORTED_PLACEABLES.includes(docName)) return;\r\n      new MassEditPresets(null, null, docName).render(true);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApplyScene', {\r\n    name: localize('keybindings.presetApplyScene.name'),\r\n    hint: localize('keybindings.presetApplyScene.hint'),\r\n    editable: [],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof MassEditPresets);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n      new MassEditPresets(null, null, 'Scene').render(true);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'genericFormKey', {\r\n    name: localize('keybindings.genericForm.name'),\r\n    hint: localize('keybindings.genericForm.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyR',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      let [target, selected] = getSelected(null, false);\r\n      if (!target) return;\r\n      const docName = getDocumentName(target);\r\n      if (![...SUPPORTED_COLLECTIONS, 'Token'].includes(docName)) return;\r\n\r\n      if (docName === 'Token') {\r\n        showMassActorForm(selected, { massEdit: true });\r\n      } else {\r\n        new MassEditGenericForm(selected, { massEdit: true, documentName: docName }).render(true);\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.f = {};\n// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = (chunkId) => {\n\treturn Promise.all(Object.keys(__webpack_require__.f).reduce((promises, key) => {\n\t\t__webpack_require__.f[key](chunkId, promises);\n\t\treturn promises;\n\t}, []));\n};","// This function allow to reference async chunks\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".bundle.js\";\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.p = \"modules/multi-token-edit/\";","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t792: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {\n\t\t// JSONP chunk loading for javascript\n\t\tvar installedChunkData = __webpack_require__.o(installedChunks, chunkId) ? installedChunks[chunkId] : undefined;\n\t\tif(installedChunkData !== 0) { // 0 means \"already installed\".\n\n\t\t\t// a Promise means \"currently loading\".\n\t\t\tif(installedChunkData) {\n\t\t\t\tpromises.push(installedChunkData[2]);\n\t\t\t} else {\n\t\t\t\tif(true) { // all chunks have JS\n\t\t\t\t\t// setup Promise in chunk cache\n\t\t\t\t\tvar promise = new Promise((resolve, reject) => (installedChunkData = installedChunks[chunkId] = [resolve, reject]));\n\t\t\t\t\tpromises.push(installedChunkData[2] = promise);\n\n\t\t\t\t\t// start chunk loading\n\t\t\t\t\tvar url = __webpack_require__.p + __webpack_require__.u(chunkId);\n\t\t\t\t\t// create error before stack unwound to get useful stacktrace later\n\t\t\t\t\tvar error = new Error();\n\t\t\t\t\tvar loadingEnded = (event) => {\n\t\t\t\t\t\tif(__webpack_require__.o(installedChunks, chunkId)) {\n\t\t\t\t\t\t\tinstalledChunkData = installedChunks[chunkId];\n\t\t\t\t\t\t\tif(installedChunkData !== 0) installedChunks[chunkId] = undefined;\n\t\t\t\t\t\t\tif(installedChunkData) {\n\t\t\t\t\t\t\t\tvar errorType = event && (event.type === 'load' ? 'missing' : event.type);\n\t\t\t\t\t\t\t\tvar realSrc = event && event.target && event.target.src;\n\t\t\t\t\t\t\t\terror.message = 'Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')';\n\t\t\t\t\t\t\t\terror.name = 'ChunkLoadError';\n\t\t\t\t\t\t\t\terror.type = errorType;\n\t\t\t\t\t\t\t\terror.request = realSrc;\n\t\t\t\t\t\t\t\tinstalledChunkData[1](error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t__webpack_require__.l(url, loadingEnded, \"chunk-\" + chunkId, chunkId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n};\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n// no on chunks loaded\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunk\"] = self[\"webpackChunk\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(165);\n"],"names":["leafPrototypes","getProto","inProgress","getInUseStyle","styleInUse","game","settings","get","STYLES","CSSEdit","FormApplication","constructor","super","defaultOptions","foundry","utils","mergeObject","id","classes","template","resizable","minimizable","title","width","height","getData","options","data","css","styles","Object","keys","push","disableCSS","activateListeners","html","$","on","event","target","value","find","val","prop","_updateObject","formData","selectedStyle","set","Default","TokenDataAdapter","updateToForm","update","mirrorX","scale","Math","abs","mirrorY","dataToForm","token","doc","document","texture","scaleX","scaleY","formToData","forEach","k","correctDetectionModes","correctDetectionModeOrder","randomizeFields","indexMap","i","v","entries","startsWith","comps","split","newKey","rVal","detectionModeMatch","searchModes","tokenModes","m1","m2","enabled","range","detectionModes","length","mergedModes","deepClone","filter","d","dm","found","tdm","modifyPresetData","app","pModes","values","expandObject","modes","_getSubmitData","dataClone","randomize","addSubtract","modCustomFields","fields","key","j","startingModeLength","_previewChanges","render","ADAPTERS","Token","PlaylistSound","PlaylistSoundDataAdapter","obj","AudioHelper","inputToVolume","note","volume","volumeToInput","Note","NoteDataAdapter","src","GeneralDataAdapter","docName","adapter","async","applyDDTint","placeable","color","object","PIXI","Color","toNumber","string2hex","_string2hex","PlaceableObject","isNaN","TokenMagic","deleteFilters","addUpdateFilters","filterType","filterId","tint","hex2rgb","filters","f","tmFilters","tmFilterId","tmFilterInternalId","randomID","tmFilterType","filterOwner","userId","tmParams","updateId","rank","getDDTint","_TMFXgetSprite","rgb2hex","uniforms","toHex","hex2string","_hex2string","applyTMFXPreset","presetName","remove","preset","getPreset","MassEditHistory","callback","this","history","historyItems","reverse","updates","formHasDiff","getTitle","rdm","includes","method","item","ctrl","fullTitle","diff","hasDifferences","label","_id","includeDiff","closest","dataset","layer","canvas","placeables","p","animatePan","x","center","y","duration","copy","type","index","historyItem","copyToClipboard","documentName","submitter","name","genAction","command","toggle","genToggleUtil","objToString","hasMassEditUpdateDependency","context","join","context2","genUpdateWithMassEditDep","isEmpty","macroTracking","macro","genUpdate","scope","genDelete","genTargets","selected","map","genIDTargets","genSelected","genSearch","opts","matchAny","tagger","match","allScenes","tags","genTaggerTargets","genAllTargets","Error","modules","active","mdsClasses","Actor","Scene","JournalEntry","Playlist","Item","RollTable","Cards","JSON","stringify","generateMacro","dep","depWarning","module","hasSpecialField","hasMassEditDependency","genMacroDependencies","select","genRunMacro","Macro","create","sheet","specialFields","sf","MacroForm","addSubtractFields","mainObject","selectable","selectScopeEnabled","targetingOptions","hasAddSubtract","hasRandom","hasMEControls","hiddenControl","macros","collections","m","_onShowReturnJson","control","store","siblings","parse","content","Dialog","buttons","Ok","hide","setPosition","e","ui","notifications","warn","_onRemoveJson","className","replace","click","parent","contextmenu","toggleFields","update2","hidden","change","show","attr","flattenObject","toObject","WithMassEditForm","cls","MassEditForm","docs","meObjects","commonData","randomizerEnabled","massEdit","massFormButtons","icon","meForm","preview","clone","form","newHtml","tabs","first","append","last","after","injectVisibility","_injectGlobalDeleteButton","styleName","prepend","onInputChange","bind","rangeSpanToTextbox","insertRNGControl","processFormGroup","formGroup","typeOverride","fieldType","each","span","replaceWith","defaultValue","min","max","removeAttr","randomControl","checkbox","before","addClass","_","then","showRandomizeDialog","input","removeClass","parseFloat","refreshPreset","htmlButtons","_meSubmitInserted","button","simplified","presetEdit","massSelect","footer","stopPropagation","isChecked","checked","not","modUpdate","modUpdateType","submit","inputChangeCallback","setTimeout","getSelectedFields","tab","group","meCheckboxes","selecting","selectTabs","deselectTabs","trigger","_createAction","chk","insertBefore","Levels3DPreview","getPresets","currentDDTint","scaleInput","_active","element","style","MutationObserver","mutations","mutation","addedNodes","node","hasClass","observe","characterData","attributes","childList","subtree","wrap","injectFlagTab","getFlag","selectedFields","me_checkbox","is","limits","flags","undefined","removeFlag","getType","trim","s","_onChangeInput","el","edit","_onChangeColorPicker","_onChangeRange","_getHeaderButtons","b","class","count","buttonA","delete","close","no","default","WithMassConfig","sheets","CONFIG","sheetClasses","pop","MEF","MassConfig","objects","getObjFormData","getCommonDocData","n","scene","massUpdateObject","_resetPreview","performMassSearch","performMassUpdate","call","_performOnInputChangeUpdate","performMassCopy","isPrototype","unshift","onclick","activate","ids","Set","actor","entry","has","add","WithMassPermissions","linkedPresetForm","left","position","top","preventPositionOverride","ev","selFields","apply","json","_processPreset","t","deactivate","force","action","_applyPreset","timeoutRequired","setFlag","customMerge","obj1","obj2","constructorName","defineProperty","prototype","pasteDataUpdate","suppressNotif","excludePosition","transform","applyType","getClipboardData","floor","random","DataTransform","c","info","pan","performDocSearch","Array","from","scenes","performMassSearchScene","activeLayer","controlled","release","releaseOthers","matches","callbackOnUpdate","total","o","checkApplySpecialFields","tokens","updateDocuments","splitUpdates","sceneUpdate","updateEmbeddedDocuments","sceneId","actorUpdates","prototypeToken","hasOwnProperty","depth","meChk","DocumentOwnershipConfig","MassPermissions","ownership","metaLevels","CONST","DOCUMENT_META_OWNERSHIP_LEVELS","addMissingPerms","perms","users","u","DEFAULT","flatData","diffObject","massPermissions","user","level","recursive","noHook","CLIPBOARD","clipboard","copyPlainText","deleteFromClipboard","CUSTOM_CONTROLS","field","shieldType","step","blend","radius","intensity","lightAlpha","gridPadding","lightSize","animated","time","speed","fire","fireBlend","animType","val2","val1","loopDuration","amplitude","electric","xglow","auraType","auraIntensity","subAuraIntensity","threshold","thickness","glow","outerStrength","innerStrength","padding","alpha","zapshadow","alphaTolerance","sprite","blendMode","translationX","translationY","rotation","xfire","dispersion","ascii","size","dot","angle","godray","rgbSplit","redX","redY","greenX","greenY","blueX","blueY","polymorph","shadow","blur","flood","billowy","tintIntensity","glint","WMC","MassEditGenericForm","a","allData","noTabs","customControls","nav","tabSelectors","editableLabels","pinnedFields","getTemplate","star","editNumber","col","Number","fromString","allControls","docControls","setProperty","unsetCustomControl","save","defineRangeControl","defineSelectControl","pinned","constructNav","pins","dataGroup","items","navSelector","contentSelector","initial","_constructControls","pinned_groups","flatObject","genControl","dataTab","groups","containsNav","name2","_hasNonNullKeys","_genLabel","newNav","toUpperCase","charAt","slice","IMAGE_FIELDS","COLOR_FIELDS","isColorField","toLowerCase","editableLabel","allowedArrayElTypes","getProperty","number","colorPickerNumber","colorValue","toString","text","varName","filePicker","colorPicker","boolean","every","array","jsonArray","disabled","LAYER_MAPPINGS","Tile","Drawing","Wall","AmbientLight","AmbientSound","MeasuredTemplate","SCENE_DOC_MAPPINGS","getControlled","getHover","hover","getSelectedDocuments","placeableSelect","supportedDocs","playlistId","sounds","soundId","documentId","notes","eid","entryId","getSelected","base","isArray","sort","p1","p2","showMassSelect","basePlaceable","showMassEdit","forceForm","showMassActorForm","selectedTokens","actors","pasteData","spawnPreset","showGenericForm","Promise","resolve","Brush","static","Map","_boundOn3DBrushClick","_on3DBrushClick","_boundOn3dMouseMove","_on3dMouseMove","_performBrushDocumentUpdate","pos","_animateCrossTranslate","updatedPlaceables","BrushMenu","iterate","_performBrushDocumentCreate","now","Date","getTime","lastSpawnTime","z","Picker","snapToGrid","snap","_performBrushDocumentDelete","hoveredPlaceable","_hitTestWall","point","wall","line","hitArea","contains","_hitTestControlIcon","between","controlIcon","_hitTestTile","foreground","controls","overhead","_hitTestArea","_hoverTestArea","_onBrushMove","getLocalPosition","brushOverlay","getLayerByEmbeddedName","_clearHover","visible","hitTest","hoverTest","_onHoverOut","_onHoverIn","_onBrushClickMove","spawner","eraser","brush3d","posVec","ruler","pos3DToCanvas","interactionManager","currentHover","_downCameraPosition","clear","genPreview","coordPicker","previewOnly","taPreview","deactivateCallback","refresh","ready","destroy","interaction","renderer","events","cursorStyles","_activate3d","Container","dimensions","rect","cursor","interactive","zIndex","Infinity","feedPos","mDownWithinCanvas","nativeEvent","which","stage","addChild","mouseInteractionManager","permissions","clickLeft","brush3dDelayMoveTimer","brush","mPos","canvas3dMousePosition","cPos","camera","intersects","computeSightCollisionFrom3DPositions","intersect","deactivate3DListeners","domElement","removeEventListener","_activate3DListeners","addEventListener","THREE","Mesh","SphereGeometry","MeshBasicMaterial","opacity","transparent","wireframe","userData","ignoreHover","removeChild","cross","Text","fontFamily","fontSize","fill","align","translate","attribute","to","CanvasAnimation","animate","addPresets","presets","_instance","isActive","Boolean","removePreset","forward","scrollY","window","innerHeight","_settings","_it","_createIndex","pI","dI","_index","_activateBrush","_applyColor","_deactivateCallback","_getTransform","randomColor","pPath","ddTint","_applyDDTint","activePreset","tmfx","rotationRangeLabel","slider","slide","_updateBrushSettings","scaleRangeLabel","_toggleSetting","_resetToDefaults","_onClickPreset","_onRightClickPreset","_onRandomizeColor","_onColorChange","cString","currentTarget","valueOf","presetIndex","findIndex","colorTemp","renderTemplate","lockMethod","space","hue","colorSlider","dialog","colors","getColors","ColorSlider","hex","offset","wasActivePreset","lock","stepsInRange","_generateBrushMacro","uuids","uuid","img","activateBrush","mode","deactivateBush","openBrushMenu","load","showPlaceableTypeSelectDialog","config","concat","importPresetFromJSONDialog","reject","import","readTextFromFile","files","pickerOverlay","addRotation","_rotation","setPositions","mousePosition","addScaling","_scale","PreciseText","canvasTextStyle","_fontSize","anchor","previews","previewDocuments","_genPreviews","previewData","keyboard","isModifierActive","KeyboardManager","MODIFIER_KEYS","SHIFT","grid","getSnappedPosition","gridPrecision","fpX","fpY","_pData","renderFlags","_meVInsert","off","boundStart","boundEnd","minX","maxX","minY","maxY","start","end","clearPreviewContainer","children","_createPreview","createData","getDocumentClass","objectClass","draw","dataArr","previewObject","_genTAPreviews","dName","_parseTAPreview","attached","attachedData","taIndex","documentNames","ratio","dataList","taPreviewObject","xy","origin","transformWall","transformTile","transformNote","transformToken","transformMeasuredTemplate","transformAmbientLight","transformAmbientSound","transformDrawing","dr","toRadians","rotatePoint","bottom","levels","rangeBottom","gridScale","rangeTop","distance","direction","toDegrees","dim","bright","rectCenter","shape","points","elevation","w","h","x2","y2","rot","dx","dy","cos","sin","editPreviewPlaceables","docToPlaceables","coords","selectionRect","Rectangle","insideRect","docToData","originalDocTolData","mainDocName","toCompendium","keepId","tokenAttacher","generatePrototypeAttached","prototypeAttached","originalData","DEFAULT_PACK","META_INDEX_ID","META_INDEX_FIELDS","PresetCollection","getTree","mainOnly","pack","mainTree","_initCompendium","workingPack","packToTree","console","log","extFolders","packs","collection","tree","hasVisible","topFolder","PresetPackFolder","allFolders","folder","_groupExtFolders","debug","MassEdit","folders","topLevelFolders","folderContents","contents","PresetFolder","sorting","draggable","types","allPresets","topLevelPresets","metaDoc","getDocument","metaIndex","_cleanIndex","idx","mIndex","locked","_updateIndex","_visible","isFavorite","matched","_setChildAndParentFoldersVisible","sortedFolders","_sortFolders","sortedPresets","_sortPresets","timeEnd","f1","f2","localeCompare","groupless","newExtFolders","groupFolder","PresetVirtualFolder","numeric","packToPresets","compendium","updateDoc","toJSON","pages","_initMetaDocument","updatePresets","documents","createDocuments","full","documentType","embedded","parseUuid","sorted","metaUpdate","deleteIds","deleteDocuments","CompendiumCollection","createCompendium","GAMEMASTER","PLAYER","ASSISTANT","packageType","deleteFolder","deleteAll","folderDoc","fromUuid","traverseFolder","deleteSubfolders","deleteContents","_searchPresetTree","_searchPresetList","_searchPresetFolder","toSearch","folderName","some","buildSpotlightOmnisearchIndex","soIndex","SearchTerm","SpotlightOmnisearch","onClick","spotlightOmnisearch","setDraggingState","PresetAPI","scaleToGrid","onDragEnd","canvasCoordinatesFromClient","clientX","clientY","getActions","actions","openJournal","buildTerm","description","keywords","format","_folderName","createPresetFromActor","presetData","gridSize","createPresetFromActorUuid","createPreset","defPreset","taggerTag","inplace","pickerLabel","layerSwitch","modifyPrompt","spawnRandom","modifyOnSpawn","preSpawnScript","pos3d","canvas2dMousePosition","posTransform","author","downKeys","isGM","allDocuments","postSpawnScript","expanded","virtual","packFolderData","TrackerDialog","cancelCallback","incrementCount","stop","_state","Application","RENDER_STATES","RENDERED","RENDERING","trackProgress","cancel","_render","countFolderItems","reduce","sum","SortingHelpersFixed","performIntegerSort","source","sortKey","sortBefore","defaultIdx","sib","_sortBefore","_sortAfter","SORT_INTEGER_DENSITY","isFinite","round","splice","performIntegerSortMulti","sources","increment","SORT_MODES","manual","tooltip","alphabetical","SEARCH_MODES","pf","MassEditPresets","configApp","previousPosition","dragType","dragData","draggedElements","docLock","displayExtCompendiums","createEnabled","isPlaceable","allowDocumentSwap","docLockActive","layerSwitchActive","scaling","extCompActive","sortMode","searchMode","displayDragDropMessage","canvas3dActive","lastSearch","currentDocument","hoverOverlay","_original","isDragging","objectHover","dropPlaceable","itemList","itemSelect","_activeBrush","_toggleBrush","targetItem","domRect","getBoundingClientRect","prc","offsetY","insertAfter","_onItemSort","folderUuid","appX","appY","appW","appH","mouseX","pageX","mouseY","pageY","checkMouseInWindow","_onPresetDragOut","_folderToggle","targetFolder","_foundryDrop","_onFolderSort","inside","presetItems","_onToggleSort","_onToggleSearch","_onToggleLock","_onToggleExtComp","_onToggleScaling","_onToggleLayerSwitch","_onDocumentChange","_onDoubleClickPreset","_onCreateFolder","_onPresetCreate","_onPresetUpdate","_onToggleFavorite","_onApplyPreset","headerSearch","_onSearchInput","_contextMenu","folderElement","_folderCollapse","_folderExpand","setExpanded","editable","fromUuidSync","TextEditor","getDragEventData","originalEvent","_importTracker","tracker","_importActorFolder","parentFolder","nFolder","Folder","implementation","child","_setInteractivityState","state","ContextMenu","_getItemContextOptions","hookName","onOpen","_getFolderContextOptions","condition","_onEditSelectedPresets","_onActivateBrush","_onOpenJournal","_onApplyToSelected","_onCopySelectedPresets","keepFolder","_onCopyPresetToClipboard","_onExportSelectedPresets","_onExportSelectedPresetsToComp","_onDeleteSelectedPresets","header","_onFolderEdit","_onExportFolder","_onFolderDelete","getCompendiumDialog","exportTo","keepIdSelect","_onCopyFolder","parentId","_getSelectedPresets","editableOnly","exportPresets","_editPresets","confirm","defaultName","PresetFolderConfig","pFolder","clearTimeout","_searchTimer","_onSearch","newSearch","previousSearch","_resetSearchState","_renderContent","_searchFolder","_searchPreset","forceRender","childFolderMatch","presetMatch","containsMatch","_resetSearchStateFolder","_resetSearchStatePreset","sourceUuid","targetUuid","result","sourceUuids","sourceUuidsSet","newSort","searchControl","newMode","lockControl","currentLock","newLock","switchControl","newDocName","eventTarget","PresetConfig","windows","hoverMassEditForm","mouseZ","_onMouseMove","worldTransform","tx","ty","starControl","favorites","popOut","currentPosition","getComputedStyle","tarW","offsetWidth","minW","parseInt","minWidth","MIN_WINDOW_WIDTH","maxW","maxWidth","innerWidth","clamped","tarH","offsetHeight","minH","minHeight","MIN_WINDOW_HEIGHT","maxH","maxHeight","leftT","topT","posSet","scaledWidth","tarL","maxL","scaledHeight","tarT","maxT","ActiveEffectConfig","_getActiveEffectFields","isCreate","actorToPreset","changes","_onWorkingPackChange","_onExport","_onImport","importCount","_pages","fileName","saveDataToFile","substring","submitOnClose","advancedOpen","displayFieldDelete","displayFieldModify","at","multiEdit","_submitData","minlength","tva","modifyDisabled","deleteDisabled","documentEdit","_onEditDocument","_onAssignDocument","_onDeleteFields","_onSpawnFields","onAttachedRemove","tvaButton","api","showArtSelect","imgSrc","searchType","updateData","addTags","removeTags","PresetFieldModify","PresetFieldDelete","documentClass","_updatePresets","_renderOuter","_createDocumentIdLink","idLink","createElement","classList","setAttribute","tooltipDirection","innerHTML","preventDefault","i18n","PresetFieldSelect","isObject","_onFieldClick","singleData","indexOf","reorganizedData","FolderConfig","toggleClass","metadata","folderDocs","displayTypes","newName","safeColor","sortingModes","submitText","virtualPackFolder","visibleTypes","updateSource","excludePack","message","buttonLabel","export","lastSelected","ctrlKey","metaKey","shiftKey","itemIndex","lastSelectedIndex","itemArr","toArray","DOCUMENT_FIELDS","PRESET_FIELDS","DOC_ICONS","ALL","FAVORITES","Preset","fromEntries","thumbnail","DEFAULT_TOKEN","_data","attach","flagUpdate","docUpdate","tmp","FolderState","_expanded","placeableToData","modifySpawnData","toModify","modified","tmpData","mergePresetDataToDefaultDoc","strokeWidth","strokeAlpha","randomizeChildrenFolderColors","randObj","applyColors","getPresetDataCenterOffset","x1","MAX_SAFE_INTEGER","y1","MIN_SAFE_INTEGER","getDataBounds","getPresetDataBounds","getTransformToOrigin","next","selectField","deselectField","allRandomizedRemoved","selectRandomizerFields","applyRandomization","requiresCoordRandomization","selection","isInteger","color1","color2","rOffset","rnOffset","hexColor","outputSpace","images","maintainAspect","tex","loadTexture","tileRatio","texRatio","shuffled","shuffleArray","strings","coordCtrl","pUpdates","pUpdate","freeId","boundingBox","freeRectangles","stepX","stepY","randomPlace","nearestStep","num","randomNum","temp","rec","fittingRecs","_canFit","rec1","rec2","overlaps","_intersectRec","overlap","_addAndMergeFreeRectangle","SUPPORTED_PLACEABLES","UI_DOCS","SUPPORT_SHEET_CONFIGS","SUPPORTED_HISTORY_DOCS","SUPPORTED_COLLECTIONS","MODULE_ID","isImage","path","extension","isVideo","recursiveTraverse","bucket","FilePicker","browse","file","dir","dirs","flagCompare","flag","flagVal","falseyFlagVal","falseyDataVal","compTags","wildcardStringMatch","hasFlagRemove","comp","tempFlag","selectAddSubtractFields","localize","applyAddSubtract","currentTags","modTags","tag","toAdd","getCommonData","mergeObjectPreserveDot","original","other","nestedKey","fullKey","panToFitPlaceables","topLeft","bottomRight","tlc","_viewPosition","screenDimensions","escapeRegex","string","sw","s2","RegExp","replaceAll","test","wildcardStringReplace","re","regexStringReplace","activeEffectPresetSelect","aeConfig","showPresetGeneric","nChanges","ACTIVE_EFFECT_MODES","OVERRIDE","priority","nc","activeEffect","getDocumentName","DOCUMENT_CREATE_REQUESTS","sceneID","createEmbeddedDocuments","requestID","handlerName","args","socket","emit","resolveCreateDocumentRequest","documentIDs","docID","getEmbeddedDocument","moduleLocalization","localFormat","insert","applyPresetToScene","randomizer","executeScript","speaker","ChatMessage","getSpeaker","character","argNames","isNumeric","argValues","fn","AsyncFunction","err","error","SeededRandom","seed","cyrb128","sfc32","chars","str","h1","h2","h3","h4","charCodeAt","imul","TagInput","registerHandlebarsHelper","Handlebars","registerHelper","hash","Utils","tagHtml","_tagField","SafeString","resize","meTags","newTags","hiddenInput","tagValue","exports","jQuery","TGT_SPLIT_RE","TGT_CLEANUP_RE","_placeableRefresh","border","Hooks","once","globalThis","libWrapper","is_fallback","WRAPPER","MIXED","register","package_id","chain","is_setter","endsWith","root_nm","fn_name","_eval","eval","iObj","descriptor","getOwnPropertyDescriptor","getPrototypeOf","configurable","wrapper","HISTORY","saveHistory","protoData","flatUpdate","flatObjData","getDiffData","maxLength","docHistory","String","registerMenu","hint","restricted","onChange","keybindings","modifiers","onDown","precedence","KEYBINDING_PRECEDENCE","NORMAL","getSelection","missingLayers","controllableObjects","tools","activeTool","_getControlButtons","_onDragLeftCancel","defer","enableUniversalSelectTool","timestamp","toLocaleTimeString","cUpdate","updateHistory","wrapped","altKey","delta","deltaY","deltaX","li","dragDropHandler","INDEX","promises","old","promise","deactivateBrush","sceneControls","presetControl","presetForm","newPresets","oldPreset","newPreset","order","hud","tokenData","tileData","background","tiles","me","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","__esModule","ns","r","def","current","getOwnPropertyNames","definition","enumerable","chunkId","all","l","url","done","script","needAttach","scripts","getElementsByTagName","getAttribute","charset","timeout","onScriptComplete","prev","onerror","onload","doneFns","parentNode","head","appendChild","Symbol","toStringTag","installedChunks","installedChunkData","errorType","realSrc","request","webpackJsonpCallback","parentChunkLoadingFunction","chunkIds","moreModules","runtime","chunkLoadingGlobal","self"],"sourceRoot":""}