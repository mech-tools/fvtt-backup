{"version":3,"file":"bundle.js","mappings":"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","sources":["webpack:///webpack/runtime/create fake namespace object","webpack:///webpack/runtime/load script","webpack:///./multi-token-edit/applications/cssEdit.js","webpack:///./multi-token-edit/applications/dataAdapters.js","webpack:///./multi-token-edit/scripts/tmfx.js","webpack:///./multi-token-edit/scripts/macro/action.js","webpack:///./multi-token-edit/scripts/macro/targets.js","webpack:///./multi-token-edit/scripts/macro/generator.js","webpack:///./multi-token-edit/applications/macro.js","webpack:///./multi-token-edit/applications/forms.js","webpack:///./multi-token-edit/scripts/fieldInjector.js","webpack:///./multi-token-edit/data/custom-controls.js","webpack:///./multi-token-edit/applications/generic/genericForm.js","webpack:///./multi-token-edit/applications/generic/navGenerator.js","webpack:///./multi-token-edit/applications/multiConfig.js","webpack:///./multi-token-edit/scripts/brush.js","webpack:///./multi-token-edit/scripts/dialogs.js","webpack:///./multi-token-edit/scripts/picker.js","webpack:///./multi-token-edit/scripts/presets/collection.js","webpack:///./multi-token-edit/scripts/presets/fileIndexer.js","webpack:///./multi-token-edit/applications/progressDialog.js","webpack:///./multi-token-edit/scripts/fixedSort.js","webpack:///./multi-token-edit/scripts/presets/forms.js","webpack:///./multi-token-edit/scripts/presets/preset.js","webpack:///./multi-token-edit/scripts/presets/utils.js","webpack:///./multi-token-edit/scripts/randomizer/randomizerUtils.js","webpack:///./multi-token-edit/scripts/utils.js","webpack:///external var \"jQuery\"","webpack:///webpack/bootstrap","webpack:///webpack/runtime/compat get default export","webpack:///webpack/runtime/define property getters","webpack:///webpack/runtime/ensure chunk","webpack:///webpack/runtime/get javascript chunk filename","webpack:///webpack/runtime/hasOwnProperty shorthand","webpack:///webpack/runtime/make namespace object","webpack:///webpack/runtime/publicPath","webpack:///webpack/runtime/jsonp chunk loading","webpack:///./multi-token-edit/scripts/shim/shim.js","webpack:///./multi-token-edit/scripts/selectTool.js","webpack:///./multi-token-edit/multi-token-edit.mjs","webpack:///./multi-token-edit/scripts/settings.js"],"sourcesContent":["var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n\t__webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; typeof current == 'object' && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => (def[key] = () => (value[key])));\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","var inProgress = {};\n// data-webpack is not used as build has no uniqueName\n// loadScript function to load a script via script tag\n__webpack_require__.l = (url, done, key, chunkId) => {\n\tif(inProgress[url]) { inProgress[url].push(done); return; }\n\tvar script, needAttach;\n\tif(key !== undefined) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tfor(var i = 0; i < scripts.length; i++) {\n\t\t\tvar s = scripts[i];\n\t\t\tif(s.getAttribute(\"src\") == url) { script = s; break; }\n\t\t}\n\t}\n\tif(!script) {\n\t\tneedAttach = true;\n\t\tscript = document.createElement('script');\n\n\t\tscript.charset = 'utf-8';\n\t\tscript.timeout = 120;\n\t\tif (__webpack_require__.nc) {\n\t\t\tscript.setAttribute(\"nonce\", __webpack_require__.nc);\n\t\t}\n\n\n\t\tscript.src = url;\n\t}\n\tinProgress[url] = [done];\n\tvar onScriptComplete = (prev, event) => {\n\t\t// avoid mem leaks in IE.\n\t\tscript.onerror = script.onload = null;\n\t\tclearTimeout(timeout);\n\t\tvar doneFns = inProgress[url];\n\t\tdelete inProgress[url];\n\t\tscript.parentNode && script.parentNode.removeChild(script);\n\t\tdoneFns && doneFns.forEach((fn) => (fn(event)));\n\t\tif(prev) return prev(event);\n\t}\n\tvar timeout = setTimeout(onScriptComplete.bind(null, undefined, { type: 'timeout', target: script }), 120000);\n\tscript.onerror = onScriptComplete.bind(null, script.onerror);\n\tscript.onload = onScriptComplete.bind(null, script.onload);\n\tneedAttach && document.head.appendChild(script);\n};","import { MODULE_ID } from '../scripts/utils.js';\r\n\r\nexport function getInUseStyle() {\r\n  const styleInUse = game.settings.get(MODULE_ID, 'cssStyle');\r\n  if (styleInUse in STYLES) {\r\n    return [styleInUse, STYLES[styleInUse]];\r\n  } else {\r\n    return ['CUSTOM', game.settings.get(MODULE_ID, 'cssCustom') || ''];\r\n  }\r\n}\r\n\r\nexport default class CSSEdit extends FormApplication {\r\n  constructor() {\r\n    super({}, {});\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-css',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/cssEdit.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: 'Edit CSS',\r\n      width: 490,\r\n      height: 730,\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    const [styleInUse, css] = getInUseStyle();\r\n    data.styleInUse = styleInUse;\r\n    data.css = css;\r\n\r\n    data.styles = Object.keys(STYLES);\r\n    data.styles.push('CUSTOM');\r\n    data.disableCSS = styleInUse !== 'CUSTOM';\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    $(html).on('change', '.selectStyle', (event) => {\r\n      let css;\r\n      if (event.target.value === 'CUSTOM') {\r\n        css = game.settings.get(MODULE_ID, 'cssCustom');\r\n      } else {\r\n        css = STYLES[event.target.value];\r\n      }\r\n      $(html)\r\n        .find('.cssTextArea')\r\n        .val(css)\r\n        .prop('disabled', event.target.value !== 'CUSTOM');\r\n      $(html).find('.previewStyle').html(css);\r\n    });\r\n    $(html).on('input', '.cssTextArea', (event) => {\r\n      $(html).find('.previewStyle').html(event.target.value);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (formData.selectedStyle === 'CUSTOM') {\r\n      game.settings.set(MODULE_ID, 'cssCustom', formData.css);\r\n    }\r\n    game.settings.set(MODULE_ID, 'cssStyle', formData.selectedStyle);\r\n  }\r\n}\r\n\r\n// Pre-made styles\r\nexport const STYLES = {\r\n  Default: `.form-group.meCommon {\r\n  outline: green dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  outline: rgb(255, 204, 110) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  outline: rgb(246, 175, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  outline: rgb(118, 242, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // No Outline\r\n  // ==================\r\n  'No Outline': `.form-group.meCommon {}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Striped Background\r\n  // ==================\r\n  'Striped Background': `.form-group.meCommon {\r\n  background: repeating-linear-gradient(\r\n  45deg,\r\n  rgba(155, 233, 155, 0.8),\r\n  rgba(155, 233, 155, 0.8) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: repeating-linear-gradient(\r\n  135deg,\r\n  rgba(255, 207, 118, 0.5),\r\n  rgba(255, 207, 118, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(237, 149, 255, 0.3),\r\n  rgba(237, 149, 255, 0.3) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(118, 242, 255, 0.5),\r\n  rgba(118, 242, 255, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Solid Background\r\n  // ==================\r\n  'Solid Background': `.form-group.meCommon {\r\n  background: rgba(155, 233, 155, 0.8)\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\noutline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: rgba(255, 207, 118, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: rgba(237, 149, 255, 0.3)\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: rgba(118, 242, 255, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}`,\r\n};\r\n","class PlaylistSoundDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('lvolume' in formData) {\r\n      formData['volume'] = AudioHelper.inputToVolume(formData['lvolume']);\r\n      delete formData['lvolume'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    data['lvolume'] = (note.document ?? note).volume;\r\n  }\r\n\r\n  static updateToForm(update) {\r\n    if ('volume' in update) {\r\n      update['lvolume'] = AudioHelper.volumeToInput(update['volume']);\r\n      delete update.volume;\r\n    }\r\n  }\r\n}\r\n\r\nclass NoteDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('icon.selected' in formData || 'icon.custom' in formData) {\r\n      formData['texture.src'] = formData['icon.selected'] || formData['icon.custom'];\r\n      delete formData['icon.selected'];\r\n      delete formData['icon.custom'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    const doc = note.document ?? note;\r\n    if (doc.texture?.src != null) {\r\n      data['icon.selected'] = doc.texture.src;\r\n      data['icon.custom'] = doc.texture.src;\r\n    }\r\n  }\r\n}\r\n\r\nexport class TokenDataAdapter {\r\n  static updateToForm(update) {\r\n    if ('texture.scaleX' in update) {\r\n      update.mirrorX = update['texture.scaleX'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleX']);\r\n    }\r\n    if ('texture.scaleY' in update) {\r\n      update.mirrorY = update['texture.scaleY'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleY']);\r\n    }\r\n  }\r\n\r\n  static dataToForm(token, data) {\r\n    const doc = token.document ?? token;\r\n    if (doc.texture?.scaleX != null) data.scale = Math.abs(doc.texture.scaleX);\r\n    if (doc.texture?.scaleX != null) data.mirrorX = doc.texture.scaleX < 0;\r\n    if (doc.texture?.scaleY != null) data.mirrorY = doc.texture.scaleY < 0;\r\n  }\r\n\r\n  static formToData(token, formData) {\r\n    const doc = token.document ?? token;\r\n\r\n    // Scale/mirroring\r\n    if ('scale' in formData || 'mirrorX' in formData || 'mirrorY' in formData) {\r\n      if (!('scale' in formData)) formData.scale = Math.abs(doc.texture.scaleX);\r\n      if (!('mirrorX' in formData)) formData.mirrorX = doc.texture.scaleX < 0;\r\n      if (!('mirrorY' in formData)) formData.mirrorY = doc.texture.scaleY < 0;\r\n      formData['texture.scaleX'] = formData.scale * (formData.mirrorX ? -1 : 1);\r\n      formData['texture.scaleY'] = formData.scale * (formData.mirrorY ? -1 : 1);\r\n      ['scale', 'mirrorX', 'mirrorY'].forEach((k) => delete formData[k]);\r\n    }\r\n\r\n    // Detection modes\r\n    TokenDataAdapter.correctDetectionModes(doc, formData);\r\n  }\r\n\r\n  static correctDetectionModeOrder(data, randomizeFields) {\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          i++;\r\n        }\r\n        const newKey = `detectionModes.${indexMap[comps[1]]}.${comps[2]}`;\r\n        delete data[k];\r\n        data[newKey] = v;\r\n        if (randomizeFields && k in randomizeFields) {\r\n          const rVal = randomizeFields[k];\r\n          delete randomizeFields[k];\r\n          randomizeFields[newKey] = rVal;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static detectionModeMatch(searchModes, tokenModes) {\r\n    for (const m1 of searchModes) {\r\n      if (!('id' in m1)) continue; // Ignore mode search attempts without ids as they can't be matched up\r\n      for (const m2 of tokenModes) {\r\n        if (m1.id === m2.id) {\r\n          if ('enabled' in m1 && m1.enabled !== m2.enabled) return false;\r\n          if ('range' in m1 && m1.range !== m2.range) return false;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  static correctDetectionModes(token, data) {\r\n    const detectionModes = [];\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          detectionModes.push({});\r\n          i++;\r\n        }\r\n        const dm = detectionModes[indexMap[comps[1]]];\r\n        dm[comps[2]] = v;\r\n        // data[`${comps[0]}.${indexMap[comps[1]]}.${comps[2]}`] = v;\r\n        delete data[k];\r\n      }\r\n    }\r\n\r\n    if (!detectionModes.length) return;\r\n\r\n    // Merge current detectionModes assigned to the token and the new ones being added\r\n    const mergedModes = foundry.utils.deepClone(token.detectionModes).filter((d) => d.id);\r\n    for (const dm of detectionModes) {\r\n      if (dm.id == null) continue;\r\n\r\n      let found = false;\r\n      for (const tdm of mergedModes) {\r\n        if (tdm.id === dm.id) {\r\n          foundry.utils.mergeObject(tdm, dm);\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n      if (!found) mergedModes.push(foundry.utils.mergeObject({ id: '', range: 0, enabled: true }, dm));\r\n    }\r\n    data.detectionModes = mergedModes;\r\n  }\r\n\r\n  static modifyPresetData(app, data) {\r\n    const pModes = Object.values(foundry.utils.expandObject(data)?.detectionModes || {});\r\n    if (!pModes.length) return;\r\n\r\n    const modes = Object.values(foundry.utils.expandObject(app._getSubmitData())?.detectionModes || {});\r\n\r\n    const dataClone = foundry.utils.deepClone(data);\r\n    const randomize = data['mass-edit-randomize'] ?? {};\r\n    const addSubtract = data['mass-edit-addSubtract'] ?? {};\r\n\r\n    const modCustomFields = function (fields, key, i, k, data) {\r\n      if (`detectionModes.${i}.${k}` in fields) {\r\n        delete fields[`detectionModes.${i}.${k}`];\r\n        fields[`detectionModes.${j}.${k}`] = data[key][`detectionModes.${i}.${k}`];\r\n      }\r\n    };\r\n\r\n    const startingModeLength = modes.length;\r\n    for (let i = 0; i < pModes.length; i++) {\r\n      if (!('id' in pModes[i])) continue;\r\n      let found = false;\r\n      for (let j = 0; j < startingModeLength; j++) {\r\n        if (pModes[i].id === modes[j].id) {\r\n          found = true;\r\n          Object.keys(pModes[i]).forEach((k) => {\r\n            delete data[`detectionModes.${i}.${k}`];\r\n            data[`detectionModes.${j}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n            modCustomFields(randomize, 'mass-edit-randomize', i, k, dataClone);\r\n            modCustomFields(addSubtract, 'mass-edit-addSubtract', i, k, dataClone);\r\n          });\r\n        }\r\n      }\r\n      if (!found) {\r\n        modes.push({ id: '', range: 0, enabled: true });\r\n        Object.keys(pModes[i]).forEach((k) => {\r\n          delete data[`detectionModes.${i}.${k}`];\r\n          data[`detectionModes.${modes.length - 1}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n\r\n          if (`detectionModes.${i}.${k}` in randomize) {\r\n            delete randomize[`detectionModes.${i}.${k}`];\r\n            randomize[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-randomize'][`detectionModes.${i}.${k}`];\r\n          }\r\n          if (`detectionModes.${i}.${k}` in addSubtract) {\r\n            delete addSubtract[`detectionModes.${i}.${k}`];\r\n            addSubtract[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-addSubtract'][`detectionModes.${i}.${k}`];\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    if (startingModeLength !== modes.length) {\r\n      app._previewChanges({ detectionModes: modes });\r\n      app.render();\r\n      return true;\r\n    }\r\n  }\r\n}\r\n\r\nconst ADAPTERS = {\r\n  Token: TokenDataAdapter,\r\n  PlaylistSound: PlaylistSoundDataAdapter,\r\n  Note: NoteDataAdapter,\r\n};\r\n\r\nexport class GeneralDataAdapter {\r\n  static formToData(docName, obj, formData) {\r\n    const adapter = ADAPTERS[docName];\r\n    if (adapter && adapter.formToData) {\r\n      adapter.formToData(obj, formData);\r\n    }\r\n  }\r\n\r\n  static dataToForm(docName, obj, formData) {\r\n    const adapter = ADAPTERS[docName];\r\n    if (adapter && adapter.dataToForm) {\r\n      adapter.dataToForm(obj, formData);\r\n    }\r\n  }\r\n\r\n  static updateToForm(docName, update) {\r\n    const adapter = ADAPTERS[docName];\r\n    if (adapter && adapter.updateToForm) {\r\n      adapter.updateToForm(update);\r\n    }\r\n  }\r\n}\r\n","export async function applyDDTint(placeable, color) {\r\n  placeable = placeable.object ?? placeable;\r\n  color = _string2hex(color);\r\n  if (placeable instanceof PlaceableObject) {\r\n    if (isNaN(color)) {\r\n      await TokenMagic.deleteFilters(placeable, 'DDTint');\r\n    } else {\r\n      await TokenMagic.addUpdateFilters(placeable, [\r\n        {\r\n          filterType: 'ddTint',\r\n          filterId: 'DDTint',\r\n          tint: PIXI.utils.hex2rgb(color),\r\n        },\r\n      ]);\r\n    }\r\n  } else {\r\n    let filters = placeable['flags.tokenmagic.filters'];\r\n    if (isNaN(color)) {\r\n      if (filters) {\r\n        placeable['flags.tokenmagic.filters'] = filters.filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      placeable['flags.tokenmagic.filters'] = filters;\r\n    }\r\n  }\r\n}\r\n\r\nexport function getDDTint(placeable) {\r\n  let color = 0xff0000;\r\n  let obj = placeable.object ?? placeable;\r\n  if (obj._TMFXgetSprite) {\r\n    const filter = obj._TMFXgetSprite()?.filters?.find((f) => f.filterId === 'DDTint');\r\n    if (filter) color = PIXI.utils.rgb2hex(filter.uniforms.tint);\r\n  }\r\n  return _hex2string(color);\r\n}\r\n\r\nexport async function applyTMFXPreset(placeable, presetName, remove = false) {\r\n  placeable = placeable.object ?? placeable;\r\n  if (!(placeable instanceof PlaceableObject)) return;\r\n  if (presetName === 'DELETE ALL') {\r\n    await TokenMagic.deleteFilters(placeable);\r\n  } else if (remove) {\r\n    await TokenMagic.deleteFilters(placeable, presetName);\r\n  } else {\r\n    const preset = TokenMagic.getPreset(presetName);\r\n    if (preset) await TokenMagic.addUpdateFilters(placeable, foundry.utils.deepClone(preset));\r\n  }\r\n}\r\n\r\nfunction _hex2string(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toHex();\r\n  } else {\r\n    return PIXI.utils.hex2string(color);\r\n  }\r\n}\r\n\r\nfunction _string2hex(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toNumber();\r\n  } else {\r\n    return PIXI.utils.string2hex(color);\r\n  }\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { hasMassEditUpdateDependency, objToString } from './generator.js';\r\n\r\nexport function genAction(options, docName) {\r\n  if (options.method === 'update' || options.method === 'toggle') {\r\n    let command = ``;\r\n\r\n    if (options.method === 'toggle') command += genToggleUtil(options);\r\n\r\n    // Insert 'update' objects\r\n\r\n    command += `\\n// Updates to be applied\r\nconst update = ${objToString(options.fields)};\\n`;\r\n    if (options.method === 'toggle') command += `const update2 = ${objToString(options.toggle.fields)};\\n\\n`;\r\n\r\n    // Insert Mass Edit control objects\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      command += `\\n// Mass Edit control objects\\n`;\r\n      if (options.randomize) command += `const randomizeFields = ${objToString(options.randomize)};\\n`;\r\n      if (options.addSubtract) command += `const addSubtractFields = ${objToString(options.addSubtract)};\\n`;\r\n      if (options.toggle) {\r\n        if (options.toggle.randomize)\r\n          command += `const randomizeFieldsToggleOff = ${objToString(options.toggle?.randomize)};\\n`;\r\n        if (options.toggle.addSubtract)\r\n          command += `const addSubtractFieldsToggleOff = ${objToString(options.toggle?.addSubtract)};\\n`;\r\n      }\r\n    }\r\n\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      return command + genUpdateWithMassEditDep(options, docName);\r\n    } else {\r\n      return command + genUpdate(options, docName);\r\n    }\r\n  } else if (options.method === 'massEdit') {\r\n    return `\\n// Open Mass Edit Form\r\nawait MassEdit.api.showMassEdit(targets, '${docName}');`;\r\n  } else if (options.method === 'delete') {\r\n    return genDelete(options, docName);\r\n  }\r\n}\r\n\r\nfunction genDelete(options, docName) {\r\n  let command = `\\n// Delete ${docName}s`;\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    if (options.target.scope === 'selected' || options.target.scope === 'scene') {\r\n      command += `\\ncanvas.scene.deleteEmbeddedDocuments('${docName}', targets.map(t => t.id));`;\r\n    } else {\r\n      command += `\\nconst toDelete = {};\r\ntargets.forEach( t => {\r\n  const sceneID = t.parent.id;\r\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\r\n  toDelete[sceneID].push(t.id);\r\n});\r\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${docName}', toDelete[sceneID]));\r\n      `;\r\n    }\r\n  } else {\r\n    command += `\\n${docName}.deleteDocuments(targets.map( t => t.id ));`;\r\n  }\r\n  return command;\r\n}\r\n\r\nfunction genUpdate(options, docName) {\r\n  // Update related code\r\n  let command = '';\r\n\r\n  // Macro only execution, ignore update code\r\n  if (foundry.utils.isEmpty(options.fields) && !options.toggle) {\r\n    return '';\r\n  } else if (options.toggle && foundry.utils.isEmpty(options.toggle.fields) && foundry.utils.isEmpty(options.fields)) {\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n\r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n    `;\r\n  }\r\n\r\n  // We start generating update code here\r\n  // Are there macros to execute?\r\n  const macroTracking = (options.macro || options.toggle?.macro) && options.toggle;\r\n\r\n  if (macroTracking) {\r\n    command += `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  `;\r\n  }\r\n\r\n  // Setting up updates\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    command += '\\nconst updates = {};';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n\r\n  updates[sceneId].push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n  \r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n    updates[sceneId].push(u);\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    command += '\\nconst updates = [];';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    }\r\n  }\r\n\r\n  // Executing updates\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    command += `\r\nfor(const sceneId of Object.keys(updates)) {\r\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${docName}', updates[sceneId]);\r\n}\r\n  `;\r\n  } else if (docName === 'PlaylistSound') {\r\n    command += `\r\nfor (let i = 0; i < targets.length; i++) {\r\n  delete updates[i]._id;\r\n  targets[i].document.update(updates[i]);\r\n}\r\n  `;\r\n  } else {\r\n    command += `\\n${docName}.updateDocuments(updates);\\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genUpdateWithMassEditDep(options, docName) {\r\n  let context = [];\r\n  if (options.randomize) context.push('randomizeFields');\r\n  if (options.addSubtract) context.push('addSubtractFields');\r\n  context = context.join(', ');\r\n\r\n  if (options.method === 'toggle') {\r\n    let context2 = [];\r\n    if (options.toggle?.randomize) context2.push('randomizeFields: randomizeFieldsToggleOff');\r\n    if (options.toggle?.addSubtract) context2.push('addSubtractFields: addSubtractFieldsToggleOff');\r\n    context2 = context2.join(', ');\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  \r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n  \r\nawait MassEdit.api.performMassUpdate.call({${context}}, update, toggleOnTargets, '${docName}');\r\nawait MassEdit.api.performMassUpdate.call({${context2}}, update2, toggleOffTargets, '${docName}');\r\n`;\r\n  } else {\r\n    return `await MassEdit.api.performMassUpdate.call({${context}}, update, targets, '${docName}');\\n`;\r\n  }\r\n}\r\n\r\nfunction genToggleUtil(options) {\r\n  let command = `\\n// Toggle; Helper function`;\r\n  if (options.toggle.method === 'field') {\r\n    command += `\r\nconst toggleOn = function (obj, fields) {\r\n  const data = foundry.utils.flattenObject(obj.toObject());\r\n  fields = foundry.utils.flattenObject(fields);\r\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\r\n};\r\n  `;\r\n  } else {\r\n    command += `\r\nconst macro = this;\r\nconst toggleOn = function (obj) {\r\n  if (obj.getFlag('world', \\`macro-\\${macro.id}-toggleOn\\`)) {\r\n    obj.unsetFlag('world', \\`macro-\\${macro.id}-toggleOn\\`);\r\n    return true;\r\n  } else {\r\n    obj.setFlag('world', \\`macro-\\${macro.id}-toggleOn\\`, true);\r\n    return false;\r\n  }\r\n};\r\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { objToString } from './generator.js';\r\n\r\nexport function genTargets(options, docName, selected) {\r\n  const target = options.target;\r\n  if (target.method === 'ids') {\r\n    return genIDTargets(target, docName, selected);\r\n  } else if (target.method === 'search') {\r\n    return genSearch(target, docName);\r\n  } else if (target.method === 'tagger') {\r\n    return genTaggerTargets(target, docName);\r\n  } else if (target.method === 'all') {\r\n    return genAllTargets(target, docName);\r\n  } else {\r\n    throw new Error('Invalid target method: ' + target.method);\r\n  }\r\n}\r\n\r\nfunction genSearch(target, docName) {\r\n  let fields = objToString(target.fields);\r\n  if (target.scope === 'selected') {\r\n    let command = genSelected(docName);\r\n    command += `\\ntargets = await MassEdit.api.performMassSearch('search', '${docName}' , ${fields}, { scope: 'selected', selected: targets, control: false, pan: false });`;\r\n    return command;\r\n  } else if (target.scope === 'scene') {\r\n    return `const targets = await MassEdit.api.performMassSearch('search', '${docName}' , ${fields}, { scope: 'scene', control: false, pan: false });`;\r\n  } else if (target.scope === 'world') {\r\n    return `const targets = await MassEdit.api.performMassSearch('search', '${docName}' , ${fields}, { scope: 'world', control: false, pan: false });`;\r\n  }\r\n}\r\n\r\n// Construct all selected document retriever\r\n// const selected = [...];\r\nfunction genSelected(docName) {\r\n  let command = '';\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    return `let targets = canvas.getLayerByEmbeddedName('${docName}').controlled.map(o => o.document);\\n\\n`;\r\n  } else if (game.modules.get('multiple-document-selection')?.active) {\r\n    const mdsClasses = {\r\n      Actor: 'actor',\r\n      Scene: 'scene',\r\n      JournalEntry: 'journalentry',\r\n      Playlist: 'sound',\r\n      Item: 'item',\r\n      RollTable: 'RollTable',\r\n      Cards: 'cards',\r\n    };\r\n\r\n    command += 'let targets = [];\\n';\r\n\r\n    if (docName === 'Playlist') {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[docName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n  if (d) targets.push(d);\r\n});\r\n`;\r\n    } else {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[docName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('${docName}').get(this.dataset.documentId);\r\n  if (d) targets.push(d);\r\n});\r\n  `;\r\n    }\r\n    return command;\r\n  } else {\r\n    throw new Error(`'Selected' is not a supported options for ${docName}s`);\r\n  }\r\n}\r\n\r\nfunction genAllTargets(target, docName) {\r\n  if (target.scope === 'selected') {\r\n    return genSelected(docName);\r\n  } else if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    if (target.scope === 'scene') {\r\n      return `const targets = canvas.getLayerByEmbeddedName('${docName}').placeables.map(o => o.document);\\n\\n`;\r\n    } else if (target.scope === 'world') {\r\n      return `const targets = [];\r\nArray.from(game.scenes).forEach( scene => {\r\n  Array.from( scene.getEmbeddedCollection('${docName}') ).forEach(embed => targets.push(embed));\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    return `const targets = Array.from(game.collections.get('${docName}'));`;\r\n  }\r\n}\r\n\r\nfunction genTaggerTargets(target, docName) {\r\n  let command = '';\r\n  const opts = {\r\n    matchAny: target.tagger.match === 'any',\r\n    allScenes: target.scope === 'world',\r\n  };\r\n\r\n  if (target.scope === 'selected') {\r\n    command += genSelected(docName);\r\n    command += `targets = Tagger.getByTag('${target.tagger.tags}', { matchAny: ${\r\n      target.tagger.match === 'any'\r\n    }, objects: targets }).filter(t => t.documentName === '${docName}');\\n\\n`;\r\n  } else if (target.scope === 'scene') {\r\n    command += `const targets = Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )}).filter(t => t.documentName === '${docName}');\\n\\n`;\r\n  } else if (target.scope === 'world') {\r\n    command += `const targets = [];`;\r\n    command += `Object.values(Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )})).forEach(item => item.forEach(t => { if(t.documentName === '${docName}') targets.push(t) }));`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genIDTargets(target, docName, selected) {\r\n  let command = `const ids = [${selected.map((p) => `\"${p.id}\"`).join(',')}];\\n`;\r\n  command += `const targets = [];`;\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(docName)) {\r\n    command += `\r\nids.forEach( id => {\r\n  Array.from(game.scenes).forEach( scene => {\r\n    let embed = scene.getEmbeddedDocument('${docName}', id);\r\n    if(embed) targets.push(embed)\r\n  });\r\n});\r\n`;\r\n  } else {\r\n    command += `\r\nids.forEach(id => { \r\n  const doc = ${docName}.get(id);\r\n  if(doc) targets.push(doc);\r\n});`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, localFormat } from '../utils.js';\r\nimport { genAction } from './action.js';\r\nimport { genTargets } from './targets.js';\r\n\r\n// Util to stringify a json object\r\nexport function objToString(obj) {\r\n  if (!obj) return null;\r\n  return JSON.stringify(obj, null, 2);\r\n}\r\n\r\nexport async function generateMacro(docName, placeables, options) {\r\n  let command = '';\r\n\r\n  // Dependencies get checked first\r\n  command += genMacroDependencies(options, docName);\r\n  command += genTargets(options, docName, placeables);\r\n  command += genAction(options, docName);\r\n  if (options.macro || options.toggle?.macro) {\r\n    command += genRunMacro(options, docName);\r\n  }\r\n\r\n  if (command) {\r\n    // Create Macro\r\n    const macro = await Macro.create({\r\n      name: options.name,\r\n      type: 'script',\r\n      scope: 'global',\r\n      command: command,\r\n    });\r\n    macro.sheet.render(true);\r\n  }\r\n}\r\n\r\nfunction genRunMacro(options, docName) {\r\n  let command = `\\n\r\n// ===================\r\n// = Macro Execution =\r\n// ===================\r\n\r\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\r\nconst layer = canvas.getLayerByEmbeddedName('${docName}');\r\n`;\r\n  // Run macros if applicable\r\n  if (options.macro) {\r\n    command += `\r\n// Apply macro\r\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${options.macro.name}')\r\nif (applyMacro && ${options.toggle ? 'toggleOnTargets' : 'targets'}.length) {\r\n  ${\r\n    options.macro.select\r\n      ? `layer.activate();\\n  layer.releaseAll();\\n  ${\r\n          options.toggle ? 'toggleOnTargets' : 'targets'\r\n        }.forEach(t => t.object?.control({ releaseOthers: false }));\\n`\r\n      : ''\r\n  }\r\n  if (advancedMacro) applyMacro.execute(${options.toggle ? 'toggleOnTargets' : 'targets'});\r\n  else applyMacro.execute({token, actor});\r\n  ${options.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  if (options.toggle?.macro) {\r\n    command += `\r\n// Apply macro on toggle off\r\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${options.toggle.macro.name}')\r\nif (offMacro && toggleOffTargets.length) {\r\n  ${\r\n    options.toggle.macro.select\r\n      ? 'layer.activate();\\n  layer.releaseAll();\\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\\n'\r\n      : ''\r\n  }\r\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\r\n  else offMacro.execute({token, actor});\r\n  ${options.toggle.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  return command;\r\n}\r\n\r\nexport function hasMassEditDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    options.target.method === 'search' ||\r\n    options.method === 'massEdit' ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nexport function hasMassEditUpdateDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nfunction genMacroDependencies(options, docName) {\r\n  let dep = '';\r\n\r\n  const depWarning = (module) => {\r\n    return `ui.notifications.warn('${localFormat('macro.dependency-warning', {\r\n      module,\r\n    })}');`;\r\n  };\r\n\r\n  if (options.target.method === 'tagger')\r\n    dep += `\r\nif (!game.modules.get('tagger')?.active) {\r\n  ${depWarning('Tagger')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (hasMassEditDependency(options))\r\n    dep += `\r\nconst MassEdit = game.modules.get('${MODULE_ID}');\r\nif(!MassEdit?.active){\r\n  ${depWarning('Mass Edit')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (SUPPORTED_COLLECTIONS.includes(docName) && options.target.scope === 'select')\r\n    dep += `\r\nif (!game.modules.get('multiple-document-selection')?.active) {\r\n  ${depWarning('Multiple Document Selection')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  return dep;\r\n}\r\n\r\nexport function hasSpecialField(fields) {\r\n  const specialFields = ['tokenmagic.ddTint', 'tokenmagic.preset', 'massedit.scale', 'massedit.texture.scale'];\r\n  for (const sf of specialFields) {\r\n    if (sf in fields) return true;\r\n  }\r\n  return false;\r\n}\r\n","import { generateMacro, hasSpecialField } from '../scripts/macro/generator.js';\r\nimport { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES, localFormat, localize } from '../scripts/utils.js';\r\nimport { GeneralDataAdapter } from './dataAdapters.js';\r\n\r\nexport default class MacroForm extends FormApplication {\r\n  constructor(object, placeables, docName, fields, randomizeFields, addSubtractFields) {\r\n    super({}, {});\r\n    this.mainObject = object;\r\n    this.placeables = placeables;\r\n    this.docName = docName;\r\n    this.fields = fields;\r\n    this.randomizeFields = randomizeFields;\r\n    this.addSubtractFields = addSubtractFields;\r\n\r\n    if (\r\n      (randomizeFields && !foundry.utils.isEmpty(randomizeFields)) ||\r\n      (addSubtractFields && !foundry.utils.isEmpty(addSubtractFields))\r\n    ) {\r\n      // keep selected fields in form format\r\n    } else {\r\n      GeneralDataAdapter.formToData(this.docName, this.mainObject, this.fields);\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-macro',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/macro.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generate Macro`,\r\n      width: 400,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    data.docName = this.docName;\r\n    data.fields = JSON.stringify(this.fields, null, 2);\r\n    data.selectable = SUPPORTED_PLACEABLES.includes(this.docName);\r\n    data.selectScopeEnabled =\r\n      data.selectable ||\r\n      (SUPPORTED_COLLECTIONS.includes(this.docName) && game.modules.get('multiple-document-selection')?.active);\r\n\r\n    // Define targeting options based on the document being updated\r\n    const targetingOptions = [\r\n      {\r\n        value: 'all',\r\n        title: localFormat('macro.target-all-title', { document: this.docName }),\r\n        label: localize('common.all'),\r\n      },\r\n      {\r\n        value: 'ids',\r\n        title: localize('macro.target-ids-title'),\r\n        label: localize('macro.target-ids'),\r\n      },\r\n      {\r\n        value: 'search',\r\n        title: localFormat('macro.target-search-title', { document: this.docName }),\r\n        label: localize('FILES.Search', false),\r\n      },\r\n    ];\r\n    if (SUPPORTED_PLACEABLES.includes(this.docName) && game.modules.get('tagger')?.active) {\r\n      targetingOptions.push({\r\n        value: 'tagger',\r\n        title: localize('macro.target-tagger-title'),\r\n        label: 'Tagger',\r\n      });\r\n    }\r\n    data.targetingOptions = targetingOptions;\r\n\r\n    if (this.addSubtractFields && !foundry.utils.isEmpty(this.addSubtractFields)) {\r\n      data.hasAddSubtract = true;\r\n      data.addSubtract = JSON.stringify(this.addSubtractFields);\r\n    }\r\n\r\n    if (this.randomizeFields && !foundry.utils.isEmpty(this.randomizeFields)) {\r\n      data.hasRandom = true;\r\n      data.randomize = JSON.stringify(this.randomizeFields);\r\n    }\r\n\r\n    data.hasMEControls = data.hasAddSubtract || data.hasRandom || hasSpecialField(this.fields);\r\n\r\n    // Visibility Toggle\r\n    data.hiddenControl = ['Token', 'Tile', 'Drawing', 'AmbientLight', 'AmbientSound', 'MeasuredTemplate'].includes(\r\n      this.docName\r\n    );\r\n\r\n    // Macros\r\n    data.macros = game.collections.get('Macro').map((m) => m.name);\r\n\r\n    return data;\r\n  }\r\n\r\n  _onShowReturnJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    const data = JSON.parse(store.val());\r\n\r\n    let content = `<textarea name=\"json\" style=\"width:100%; height: 300px;\">${JSON.stringify(\r\n      data,\r\n      null,\r\n      2\r\n    )}</textarea>`;\r\n    new Dialog({\r\n      title: `JSON`,\r\n      content: content,\r\n      buttons: {\r\n        Ok: {\r\n          label: localize('Save', false),\r\n          callback: (html) => {\r\n            try {\r\n              const val = JSON.parse(html.find('[name=\"json\"]').val() || '{}');\r\n              if (foundry.utils.isEmpty(val)) {\r\n                control.hide();\r\n                store.prop('disabled', true);\r\n                this.setPosition({ height: 'auto' });\r\n              } else {\r\n                store.val(JSON.stringify(val));\r\n              }\r\n            } catch (e) {\r\n              ui.notifications.warn('Invalid data. Failed to save.');\r\n            }\r\n          },\r\n        },\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  _onRemoveJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    control.hide();\r\n    store.prop('disabled', true);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    ['randomize', 'addSubtract', 'toggle.randomize', 'toggle.addSubtract'].forEach((name) => {\r\n      const className = name.replace('.', '');\r\n      html.find(`.${className}`).click((event) => {\r\n        this._onShowReturnJson($(event.target).parent(), name);\r\n      });\r\n      html.find(`.${className}`).contextmenu((event) => {\r\n        this._onRemoveJson($(event.target).parent(), name);\r\n      });\r\n    });\r\n\r\n    html.find('.toggleVisibility').click((event) => {\r\n      const fields = html.find('[name=\"fields\"]');\r\n      const toggleFields = html.find('[name=\"toggle.fields\"]');\r\n\r\n      let update,\r\n        update2 = {};\r\n\r\n      try {\r\n        update = JSON.parse(fields.val());\r\n        update.hidden = !update.hidden;\r\n        fields.val(JSON.stringify(update, null, 2));\r\n\r\n        update2 = JSON.parse(toggleFields.val());\r\n        update2.hidden = !update.hidden;\r\n        toggleFields.val(JSON.stringify(update2, null, 2));\r\n      } catch (e) {}\r\n    });\r\n\r\n    html.find('[name=\"target.method\"]').change((event) => {\r\n      // Hide/show tagger controls\r\n      if (event.target.value === 'tagger') {\r\n        html.find('.taggerControl').show();\r\n        html.find('[name=\"tags\"').attr('required', true);\r\n      } else {\r\n        html.find('.taggerControl').hide();\r\n        html.find('[name=\"tags\"').attr('required', false);\r\n      }\r\n\r\n      // Hide/show scope\r\n      if (event.target.value === 'ids') html.find('[name=\"target.scope\"]').closest('.form-group').hide();\r\n      else html.find('[name=\"target.scope\"]').closest('.form-group').show();\r\n\r\n      if (event.target.value === 'search') html.find('[name=\"target.fields\"]').closest('div').show();\r\n      else html.find('[name=\"target.fields\"]').closest('div').hide();\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.find('[name=\"method\"]').on('change', (event) => {\r\n      if (event.target.value === 'toggle') {\r\n        let data = foundry.utils.flattenObject(getData(this.mainObject).toObject());\r\n\r\n        const toggleFields = {};\r\n        Object.keys(this.fields).forEach((k) => (toggleFields[k] = data[k]));\r\n        html.find('[name=\"toggle.fields\"]').val(JSON.stringify(toggleFields, null, 2));\r\n        html.find('.toggleControl').show();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.toggleControl').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n\r\n      if (event.target.value === 'massEdit' || event.target.value === 'delete') {\r\n        html.find('.fields').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.fields').show();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    formData = expandObject(formData);\r\n\r\n    // Cleanup form data so that the macro generator only receives necessary information\r\n    formData.fields = JSON.parse(formData.fields);\r\n    if (formData.method !== 'toggle') delete formData.toggle;\r\n    else formData.toggle.fields = JSON.parse(formData.toggle.fields);\r\n\r\n    if (!formData.macro.name) delete formData.macro;\r\n    if (formData.toggle?.macro && !formData.toggle.macro.name) delete formData.toggle.macro;\r\n\r\n    if (formData.target.method !== 'tagger') delete formData.target.tagger;\r\n    if (formData.target.method !== 'search') delete formData.target.fields;\r\n    else formData.target.fields = JSON.parse(formData.target.fields);\r\n\r\n    if (formData.randomize) formData.randomize = JSON.parse(formData.randomize);\r\n    if (formData.toggle?.randomize) formData.toggle.randomize = JSON.parse(formData.toggle.randomize);\r\n    if (formData.addSubtract) formData.addSubtract = JSON.parse(formData.addSubtract);\r\n    if (formData.toggle?.addSubtract) formData.toggle.addSubtract = JSON.parse(formData.toggle.addSubtract);\r\n\r\n    generateMacro(this.docName, this.placeables, formData);\r\n  }\r\n}\r\n\r\nfunction getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n","import { Brush } from '../scripts/brush.js';\r\nimport { injectFlagTab, injectVisibility } from '../scripts/fieldInjector.js';\r\nimport { DataTransform } from '../scripts/picker.js';\r\nimport { MassEditPresets } from '../scripts/presets/forms.js';\r\nimport { Preset } from '../scripts/presets/preset.js';\r\nimport { applyRandomization, selectRandomizerFields } from '../scripts/randomizer/randomizerUtils.js';\r\nimport { applyDDTint, applyTMFXPreset, getDDTint } from '../scripts/tmfx.js';\r\nimport {\r\n  applyAddSubtract,\r\n  flagCompare,\r\n  getCommonData,\r\n  getData,\r\n  getDocumentName,\r\n  hasFlagRemove,\r\n  localFormat,\r\n  localize,\r\n  mergeObjectPreserveDot,\r\n  MODULE_ID,\r\n  panToFitPlaceables,\r\n  selectAddSubtractFields,\r\n  SUPPORTED_COLLECTIONS,\r\n  SUPPORTED_PLACEABLES,\r\n  wildcardStringMatch,\r\n} from '../scripts/utils.js';\r\nimport { getInUseStyle } from './cssEdit.js';\r\nimport { GeneralDataAdapter, TokenDataAdapter } from './dataAdapters.js';\r\nimport MacroForm from './macro.js';\r\nimport { SCENE_DOC_MAPPINGS, showMassActorForm, showMassEdit } from './multiConfig.js';\r\n\r\n// ==================================\r\n// ========= Applications ===========\r\n// ==================================\r\n\r\nexport const WithMassEditForm = (cls) => {\r\n  class MassEditForm extends cls {\r\n    constructor(doc, docs, options) {\r\n      super(doc, options);\r\n      this.meObjects = docs;\r\n      this.documentName = options.documentName ?? doc.document?.documentName ?? doc.documentName ?? 'NONE';\r\n      this.commonData = options.commonData || {};\r\n      this.randomizerEnabled = options.massEdit;\r\n      this.massFormButtons = [\r\n        {\r\n          title: localize(`common.apply`),\r\n          value: 'permissions',\r\n          icon: 'far fa-save',\r\n        },\r\n      ];\r\n\r\n      this.randomizeFields = {};\r\n      this.addSubtractFields = {};\r\n      this.meForm = true;\r\n    }\r\n\r\n    async getData(options) {\r\n      // During Preset editing we will be editing AmbientLight document directly, which causes the preview to be set to null\r\n      // and Foundry complaining about being unable to read data from it. So we set the preview manually here\r\n      if (this.documentName === 'AmbientLight' && !this.preview) {\r\n        this.preview = this.meObjects[0].clone();\r\n      }\r\n      const data = super.getData(options);\r\n      return data;\r\n    }\r\n\r\n    // Add styles and controls to the sheet\r\n    async activateListeners(html) {\r\n      await super.activateListeners(html);\r\n      injectVisibility(this);\r\n\r\n      if (SUPPORTED_PLACEABLES.includes(this.documentName) || SUPPORTED_COLLECTIONS.includes(this.documentName))\r\n        this._injectGlobalDeleteButton(html);\r\n\r\n      // Set style\r\n      const [styleName, css] = getInUseStyle();\r\n      $(html).prepend(`<style>${css}</style>`);\r\n\r\n      // On any field being changed we want to automatically select the form-group to be included in the update\r\n      html.on('input', 'textarea, input[type=\"text\"], input[type=\"number\"]', onInputChange.bind(this));\r\n      html.on('change', 'textarea, input, select', onInputChange.bind(this));\r\n      html.on('paste', 'input', onInputChange.bind(this));\r\n      html.on('click', 'button', onInputChange.bind(this));\r\n\r\n      const rangeSpanToTextbox = game.settings.get(MODULE_ID, 'rangeToTextbox');\r\n\r\n      // Attach classes and controls to all relevant form-groups\r\n      const commonData = foundry.utils.flattenObject(this.commonData || {});\r\n      const insertRNGControl = this.randomizerEnabled;\r\n      const processFormGroup = function (formGroup, typeOverride = null) {\r\n        // We only want to attach extra controls if the form-group contains named fields\r\n        if (!$(formGroup).find('[name]').length) return;\r\n        // Return if a checkbox is already inserted\r\n        if ($(formGroup).find('.mass-edit-checkbox').length) return;\r\n        // if ($(formGroup).find('[name]:disabled').length) return;\r\n\r\n        // Check if fields within this form-group are part of common data or control a flag\r\n        let fieldType = 'meCommon';\r\n        if (commonData) {\r\n          $(formGroup)\r\n            .find('[name]')\r\n            .each(function () {\r\n              const name = $(this).attr('name');\r\n\r\n              if (rangeSpanToTextbox && $(this).attr('type') === 'range') {\r\n                const span = $(formGroup).find('span.range-value');\r\n                if (span.length) {\r\n                  span.replaceWith(\r\n                    $(\r\n                      `<input name=\"${name}\" class=\"range-value\" type=\"number\" step=\"any\" value=\"${this.defaultValue}\" min=\"${this.min}\" max=\"${this.max}\"></input>`\r\n                    )\r\n                  );\r\n                  $(this).removeAttr('name');\r\n                }\r\n              }\r\n\r\n              if (name.startsWith('flags.')) {\r\n                fieldType = 'meFlag';\r\n              } else if (!(name in commonData)) {\r\n                // We want to ignore certain fields from commonData checks e.g. light invert-radius\r\n\r\n                if (name === 'invert-radius') {\r\n                } else {\r\n                  fieldType = 'meDiff';\r\n                }\r\n              }\r\n            });\r\n        }\r\n\r\n        // Add randomizer controls\r\n        let randomControl = '';\r\n        if (insertRNGControl) {\r\n          randomControl = '<div class=\"mass-edit-randomize\"></div>';\r\n        }\r\n\r\n        fieldType = typeOverride ?? fieldType;\r\n\r\n        // Insert the checkbox\r\n        const checkbox = $(\r\n          `<div class=\"mass-edit-checkbox ${fieldType}\">${randomControl}<input class=\"mass-edit-control\" type=\"checkbox\" data-dtype=\"Boolean\"}></div>`\r\n        );\r\n        if ($(formGroup).find('p.hint, p.notes').length) {\r\n          $(formGroup).find('p.hint, p.notes').first().before(checkbox);\r\n        } else {\r\n          $(formGroup).append(checkbox);\r\n        }\r\n\r\n        // Assign field type to the form group. Will be used to set appropriate visual look\r\n        $(formGroup).addClass(fieldType);\r\n      };\r\n\r\n      // Add checkboxes to each form-group to control highlighting and which fields are to be saved\r\n      $(html)\r\n        .find('.form-group')\r\n        .each(function (_) {\r\n          processFormGroup(this);\r\n        });\r\n      const context = this;\r\n\r\n      // Register randomize listener if enabled\r\n      if (this.randomizerEnabled) {\r\n        $(html).on('contextmenu', '.mass-edit-checkbox', (event) => {\r\n          import('../scripts/randomizer/randomizerForm.js').then((module) => {\r\n            module.showRandomizeDialog($(event.target).closest('.form-group'), context);\r\n          });\r\n        });\r\n      }\r\n\r\n      // Register numerical input listeners to toggle between subtract, and add modes\r\n      $(html).on(\r\n        'contextmenu',\r\n        'input[type=range], input[type=number], input[name=\"flags.tagger.tags\"], input[type=\"text\"], input[name=\"tokenmagic.preset\"]',\r\n        (event) => {\r\n          const name = event.target.name;\r\n          if (!name) return;\r\n\r\n          const input = $(event.target);\r\n          if (name in this.addSubtractFields) {\r\n            if (this.addSubtractFields[name].method === 'add') {\r\n              this.addSubtractFields[name].method = 'subtract';\r\n              input.removeClass('me-add').addClass('me-subtract');\r\n              input.attr('title', '- Subtracting');\r\n              const ctrl = { method: 'subtract' };\r\n              if (event.target.min) {\r\n                ctrl.min = parseFloat(event.target.min);\r\n              }\r\n              ctrl.type = input.attr('type');\r\n              this.addSubtractFields[name] = ctrl;\r\n            } else {\r\n              delete this.addSubtractFields[name];\r\n              input.removeClass('me-subtract');\r\n              input.attr('title', '');\r\n            }\r\n          } else {\r\n            input.addClass('me-add');\r\n            input.attr('title', '+ Adding');\r\n            const ctrl = { method: 'add' };\r\n            if (event.target.max) {\r\n              ctrl.max = parseFloat(event.target.max);\r\n            }\r\n            ctrl.type = input.attr('type');\r\n            this.addSubtractFields[name] = ctrl;\r\n          }\r\n\r\n          // Select nearest mass edit checkbox\r\n          onInputChange(event);\r\n\r\n          // Make brush aware of add/subtract changes\r\n          Brush.refreshPreset();\r\n        }\r\n      );\r\n\r\n      // Remove all buttons in the footer\r\n      $(html).find('.sheet-footer > button').remove();\r\n\r\n      // Special handling for Walls sheet\r\n      $(html).find('button[type=\"submit\"]').remove();\r\n\r\n      // Add submit buttons\r\n      let htmlButtons = '';\r\n      if (!this._meSubmitInserted) {\r\n        this._meSubmitInserted = true;\r\n        for (const button of this.massFormButtons) {\r\n          htmlButtons += `<button class=\"me-submit\" type=\"submit\" value=\"${button.value}\"><i class=\"${button.icon}\"></i> ${button.title}</button>`;\r\n          // Auto update control\r\n          if (this.options.massEdit && !this.options.simplified && !this.options.presetEdit)\r\n            htmlButtons += `<div class=\"me-mod-update\" title=\"${localize(\r\n              `form.immediate-update-title`\r\n            )}\"><input type=\"checkbox\" data-submit=\"${button.value}\"><i class=\"fas fa-cogs\"></i></div>`;\r\n        }\r\n        if (this.options.massSelect && SUPPORTED_PLACEABLES.includes(this.documentName)) {\r\n          htmlButtons += `<div class=\"me-mod-update\" title=\"${localize(\r\n            `form.global-search-title`\r\n          )}\"><input type=\"checkbox\" data-submit=\"world\"><i class=\"far fa-globe\"></i></div>`;\r\n        }\r\n\r\n        let footer = $(html).find('.sheet-footer').last();\r\n        if (footer.length) {\r\n          footer.append(htmlButtons);\r\n        } else {\r\n          footer = $(`<footer class=\"sheet-footer flexrow\">${htmlButtons}</footer>`);\r\n          $(html).closest('form').append(footer);\r\n        }\r\n\r\n        // Auto update listeners\r\n        footer.find('.me-mod-update > input').on('change', (event) => {\r\n          event.stopPropagation();\r\n          const isChecked = event.target.checked;\r\n          footer.find('.me-mod-update > input').not(this).prop('checked', false);\r\n          $(event.target).prop('checked', isChecked);\r\n          this.modUpdate = isChecked;\r\n          this.modUpdateType = event.target.dataset?.submit;\r\n        });\r\n      }\r\n\r\n      if (this.options.inputChangeCallback) {\r\n        html.on('change', 'input, select', async (event) => {\r\n          setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n        });\r\n      }\r\n\r\n      // Select/Deselect all Mass Edit checkboxes when right-clicking the navigation tabs\r\n      html.on('contextmenu', 'nav > .item', (event) => {\r\n        const tab = event.target.dataset?.tab;\r\n        if (tab) {\r\n          const group = $(event.target).closest('nav').attr('data-group');\r\n          let meCheckboxes;\r\n          if (group) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(\r\n                `.tab[data-tab=\"${tab}\"][data-group=\"${group}\"], .matt-tab[data-tab=\"${tab}\"][data-group=\"${group}\"]`\r\n              )\r\n              .find('.mass-edit-control');\r\n          }\r\n          if (!meCheckboxes || meCheckboxes.length === 0) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(`.tab[data-tab=\"${tab}\"], .matt-tab[data-tab=\"${tab}\"]`)\r\n              .find('.mass-edit-control');\r\n          }\r\n\r\n          let selecting = true;\r\n\r\n          if (meCheckboxes.not(':checked').length === 0) {\r\n            selecting = false;\r\n          }\r\n          meCheckboxes.prop('checked', selecting);\r\n\r\n          // Select/Deselect tabs\r\n          meCheckboxes.each(function () {\r\n            if (selecting) selectTabs(this);\r\n            else deselectTabs(this);\r\n          });\r\n\r\n          // Trigger change on one of the checkboxes to initiate processes that respond to them\r\n          // being toggled\r\n          meCheckboxes.first().trigger('change');\r\n        }\r\n      });\r\n\r\n      // =====================\r\n      // Module specific logic\r\n      // =====================\r\n\r\n      // Monk's Active Tiles\r\n      if (this.documentName === 'Tile' && this._createAction) {\r\n        let chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>Mass Edit: ${localize(`form.actions`)}</label>\r\n            <div class=\"form-fields\">\r\n                <input type=\"hidden\" name=\"flags.monks-active-tiles.actions\">\r\n            </div>\r\n          `);\r\n        $(html).find('.matt-tab[data-tab=\"trigger-actions\"]').prepend(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n\r\n        chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>Mass Edit: ${localize(`form.images`)}</label>\r\n            <div class=\"form-fields\">\r\n                <input type=\"hidden\" name=\"flags.monks-active-tiles.files\">\r\n            </div>\r\n          `);\r\n        chk.insertBefore('.matt-tab[data-tab=\"trigger-images\"] .files-list');\r\n        processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ((this.documentName === 'Tile' || this.documentName === 'Token') && game.Levels3DPreview) {\r\n        let chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>Mass Edit: ${localize(`form.shaders`)}</label>\r\n            <div class=\"form-fields\">\r\n                <input type=\"hidden\" name=\"flags.levels-3d-preview.shaders\">\r\n            </div>\r\n          `);\r\n        $(html).find('#shader-config').after(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n      }\r\n      //\r\n\r\n      // =====================\r\n      // = Additional Fields =\r\n      // =====================\r\n\r\n      // // Token Magic FX\r\n      if (\r\n        (this.documentName === 'Tile' || this.documentName === 'Token') &&\r\n        !this.options?.simplified &&\r\n        game.modules.get('tokenmagic')?.active &&\r\n        game.settings.get(MODULE_ID, 'tmfxFieldsEnable')\r\n      ) {\r\n        let content = '<datalist id=\"tmfxPresets\"><option value=\"DELETE ALL\">';\r\n        TokenMagic.getPresets().forEach((p) => (content += `<option value=\"${p.name}\">`));\r\n        content += `</datalist><input list=\"tmfxPresets\" name=\"tokenmagic.preset\">`;\r\n\r\n        let chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>${localize('common.preset')} <span class=\"units\">(TMFX)</span></label>\r\n            <div class=\"form-fields\">\r\n              ${content}\r\n            </div>\r\n          `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n\r\n        const currentDDTint = getDDTint(this.object.object ?? this.object);\r\n        chk = $(`\r\n          <div class=\"form-group\">\r\n            <label>DungeonDraft <span class=\"units\">(TMFX)</span></label>\r\n            <div class=\"form-fields\">\r\n              <input class=\"color\" type=\"text\" name=\"tokenmagic.ddTint\" value=\"${currentDDTint}\">\r\n              <input type=\"color\" value=\"${currentDDTint}\" data-edit=\"tokenmagic.ddTint\">\r\n            </div>\r\n          `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      if (this.documentName === 'Tile') {\r\n        let scaleInput = $(`\r\n        <div class=\"form-group slim\">\r\n          <label>${localize('Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n          <div class=\"form-fields\">\r\n            <label>${localize('Width', false)} | ${localize('Height', false)} ${\r\n          game.Levels3DPreview?._active ? '| Depth' : ''\r\n        }</label>\r\n            <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.scale\" min=\"0\">\r\n          </div>\r\n        </div>`);\r\n        $(html).find('[name=\"width\"]').closest('.form-group').before(scaleInput);\r\n        processFormGroup(scaleInput, 'meInsert');\r\n\r\n        scaleInput = $(`\r\n          <div class=\"form-group slim\">\r\n            <label>${localize('TILE.Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n            <div class=\"form-fields\">\r\n              <label>${localize('TILE.ScaleX', false)} | ${localize('TILE.ScaleY', false)}</label>\r\n              <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.texture.scale\" min=\"0\">\r\n            </div>\r\n          </div>`);\r\n        $(html).find('[name=\"texture.scaleX\"]').closest('.form-group').before(scaleInput);\r\n        processFormGroup(scaleInput, 'meInsert');\r\n      }\r\n\r\n      // Resizes the window\r\n      this.setPosition();\r\n      this.element[0].style.height = ''; // don't want a statically set height\r\n\r\n      // TokenConfig might be changed by some modules after activateListeners is processed\r\n      // Look out for these updates and add checkboxes for any newly added form-groups\r\n      const mutate = (mutations) => {\r\n        mutations.forEach((mutation) => {\r\n          mutation.addedNodes.forEach((node) => {\r\n            if ($(node).hasClass('form-group')) {\r\n              processFormGroup(node);\r\n            } else {\r\n              $(node)\r\n                .find('.form-group')\r\n                .each(function () {\r\n                  if (!$(this).find('.mass-edit-checkbox').length) {\r\n                    processFormGroup(this);\r\n                  }\r\n                });\r\n            }\r\n          });\r\n        });\r\n      };\r\n\r\n      const observer = new MutationObserver(mutate);\r\n      observer.observe(html[0], {\r\n        characterData: false,\r\n        attributes: false,\r\n        childList: true,\r\n        subtree: true,\r\n      });\r\n\r\n      if (this.documentName === 'Token') {\r\n        $(html)\r\n          .find('fieldset.detection-mode')\r\n          .each(function (_) {\r\n            $(this).wrap('<div class=\"form-group\"></div>');\r\n          });\r\n      }\r\n\r\n      // Inject Flags tab\r\n      injectFlagTab(this);\r\n    }\r\n\r\n    getSelectedFields(formData) {\r\n      if (!formData) formData = this._getSubmitData();\r\n\r\n      // Some module flags get un-flattened\r\n      // Flatten them again before attempting to find selected\r\n      formData = foundry.utils.flattenObject(formData);\r\n\r\n      // Modules Specific Logic\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in formData) {\r\n        formData['flags.levels-3d-preview.shaders'] = this.object.getFlag('levels-3d-preview', 'shaders');\r\n      }\r\n      // == End of Module specific logic\r\n\r\n      // Token _getSubmitData() performs conversions related to scale, we need to undo them here\r\n      // so that named fields on the form match up and can be selected\r\n      if (this.documentName === 'Token') {\r\n        if (formData['texture.scaleX']) {\r\n          formData.scale = Math.abs(formData['texture.scaleX']);\r\n          formData.mirrorX = formData['texture.scaleX'] < 0;\r\n          formData.mirrorY = formData['texture.scaleY'] < 0;\r\n        }\r\n      } else if (this.documentName === 'Note') {\r\n        if (formData['texture.src']) {\r\n          formData['icon.selected'] = formData['texture.src'];\r\n          formData['icon.custom'] = formData['texture.src'];\r\n        }\r\n      }\r\n\r\n      const selectedFields = {};\r\n      const form = $(this.form);\r\n      const addSubtractFields = this.addSubtractFields;\r\n      const app = this;\r\n\r\n      form.find('.form-group').each(function (_) {\r\n        const me_checkbox = $(this).find('.mass-edit-checkbox > input');\r\n        if (me_checkbox.length && me_checkbox.is(':checked')) {\r\n          $(this)\r\n            .find('[name]')\r\n            .each(function (_) {\r\n              const name = $(this).attr('name');\r\n\r\n              // Module specific logic\r\n              if (name === 'flags.limits') {\r\n                const limits = foundry.utils.flattenObject(app.object.toObject().flags['limits'] ?? {});\r\n                for (const [k, v] of Object.entries(limits)) {\r\n                  selectedFields['flags.limits.' + k] = v;\r\n                }\r\n              }\r\n              // == End of Module specific logic\r\n\r\n              // Some modules will process their flags to remove them using -= notation\r\n              // Need to account for this when selecting fields\r\n              if (formData[name] === undefined && name.startsWith('flags.')) {\r\n                const removeFlag = hasFlagRemove(name, formData);\r\n                if (removeFlag) {\r\n                  selectedFields[removeFlag] = null;\r\n                }\r\n              } else {\r\n                selectedFields[name] = formData[name];\r\n                if (name in addSubtractFields) {\r\n                  addSubtractFields[name].value = formData[name];\r\n                }\r\n              }\r\n\r\n              if (foundry.utils.getType(selectedFields[name]) === 'string') {\r\n                const input = $(this);\r\n                if (input.hasClass('tva-array')) {\r\n                  if (v.trim()) {\r\n                    selectedFields[name] = selectedFields[name]\r\n                      .trim()\r\n                      .split(',')\r\n                      .map((s) => s.trim());\r\n                  } else {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                } else if (input.hasClass('tva-jsonArray')) {\r\n                  try {\r\n                    selectedFields[name] = JSON.parse(selectedFields[name]);\r\n                  } catch (e) {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                }\r\n              }\r\n            });\r\n        }\r\n      });\r\n\r\n      // // Module specific logic\r\n      // if (game.modules.get('barbrawl')?.active) {\r\n      //   for (const [k, v] of Object.entries(selectedFields)) {\r\n      //     if (k.startsWith('flags.barbrawl')) {\r\n      //       let details = form.find(`[name=\"${k}\"]`).closest('.indent-details');\r\n      //       let id = details.attr('id');\r\n      //       if (id) selectedFields[`flags.barbrawl.resourceBars.${id}.id`] = id;\r\n      //     }\r\n      //   }\r\n      // }\r\n      // // End of Module specific logic\r\n\r\n      return selectedFields;\r\n    }\r\n\r\n    // Overriding here to prevent the underlying object from being updated as inputs change on the form\r\n    // Relevant for AmbientLight, Tile, and Token sheets\r\n    async _onChangeInput(event) {\r\n      if (!['AmbientLight', 'Tile', 'Token'].includes(this.documentName)) {\r\n        super._onChangeInput(event);\r\n        return;\r\n      }\r\n\r\n      // // Handle form element updates\r\n      const el = event.target;\r\n      if (el.type === 'color' && el.dataset.edit) this._onChangeColorPicker(event);\r\n      else if (el.type === 'range') this._onChangeRange(event);\r\n    }\r\n\r\n    _getHeaderButtons() {\r\n      let buttons = super._getHeaderButtons();\r\n      return buttons.filter((b) => b.class !== 'configure-sheet');\r\n    }\r\n\r\n    _injectGlobalDeleteButton(html) {\r\n      const control = $(\r\n        `<div class=\"me-global-delete\"><a title=\"${localize(\r\n          'form.global-delete-title'\r\n        )}\"><i class=\"far fa-times-octagon fa-2x\"></i></a></div>`\r\n      );\r\n      control.click((event) => {\r\n        new Dialog({\r\n          title: 'Confirm',\r\n          content: `\r\n          <h2 style=\"color: red; text-align: center;\">${localFormat('form.delete-warning', {\r\n            count: this.meObjects.length,\r\n            document: this.documentName,\r\n          })}</h2>\r\n          <p>${localize('form.proceed')}</p>`,\r\n          buttons: {\r\n            buttonA: {\r\n              label: localize('Yes', false),\r\n              callback: () => {\r\n                this.meObjects.forEach((obj) => {\r\n                  let doc = obj.document ?? obj;\r\n                  if (doc.delete) doc.delete();\r\n                });\r\n                this.close();\r\n              },\r\n            },\r\n            no: {\r\n              label: localize('No', false),\r\n            },\r\n          },\r\n          default: 'buttonA',\r\n        }).render(true);\r\n      });\r\n      html.closest('form').append(control);\r\n    }\r\n  }\r\n\r\n  return MassEditForm;\r\n};\r\n\r\nexport const WithMassConfig = (docName = 'NONE') => {\r\n  let cls;\r\n  const sheets = CONFIG[docName]?.sheetClasses;\r\n  if (!sheets || docName === 'Actor') {\r\n    cls = FormApplication;\r\n\r\n    cls = FormApplication;\r\n  } else {\r\n    cls = Object.values(Object.values(sheets).pop() ?? {}).pop()?.cls;\r\n  }\r\n\r\n  const MEF = WithMassEditForm(cls);\r\n\r\n  class MassConfig extends MEF {\r\n    constructor(target, docs, options) {\r\n      if (options.massSelect) options.randomizerEnabled = false;\r\n      const docName = options.documentName ?? getDocumentName(target);\r\n      if (!options.commonData) options.commonData = getCommonDocData(docs, docName);\r\n\r\n      super(target.document ? target.document : target, docs, options);\r\n      this.docName = docName;\r\n\r\n      // Add submit buttons\r\n      let buttons = [];\r\n      if (this.options.massSelect) {\r\n        buttons = [\r\n          { title: localize('FILES.Search', false), value: 'search', icon: 'fas fa-search' },\r\n          { title: localize('form.search-and-edit'), value: 'searchAndEdit', icon: 'fas fa-search' },\r\n        ];\r\n      } else if (this.documentName === 'Note' && !this.options.presetEdit) {\r\n        // If we're editing notes and there are some on a different scene\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id === canvas.scene.id).length) {\r\n          buttons.push({\r\n            title: localize('form.apply-on-current-scene'),\r\n            value: 'currentScene',\r\n            icon: 'far fa-save',\r\n          });\r\n        }\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id !== canvas.scene.id).length) {\r\n          buttons.push({\r\n            title: localize('form.apply-on-all-scenes'),\r\n            value: 'allScenes',\r\n            icon: 'fas fa-globe',\r\n          });\r\n        }\r\n      } else {\r\n        buttons = [{ title: localize('common.apply'), value: 'apply', icon: 'far fa-save' }];\r\n        // Extra control for Tokens to update their Actors Token prototype\r\n        if (\r\n          this.documentName === 'Token' &&\r\n          !this.options.simplified &&\r\n          !this.meObjects[0].constructor?.name?.startsWith('PrototypeToken') &&\r\n          !this.options.presetEdit\r\n        ) {\r\n          buttons.push({\r\n            title: localize('form.apply-update-proto'),\r\n            value: 'applyToPrototype',\r\n            icon: 'far fa-save',\r\n          });\r\n        }\r\n      }\r\n\r\n      this.massFormButtons = buttons;\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      await this.massUpdateObject(event, formData);\r\n\r\n      // On v11 certain placeable will freeze the canvas layer if parent _updateObject is not called\r\n      if (['Token', 'AmbientLight'].includes(this.docName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n    }\r\n\r\n    async massUpdateObject(event, formData) {\r\n      if (!event.submitter?.value) return;\r\n\r\n      // Gather up all named fields that have mass-edit-checkbox checked\r\n      const selectedFields = this.getSelectedFields(formData);\r\n\r\n      // Detection modes may have been selected out of order\r\n      // Fix that here\r\n      if (this.docName === 'Token') {\r\n        TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n      }\r\n\r\n      // Preset editing\r\n      if (this.options.presetEdit) {\r\n        this.options.callback?.({\r\n          data: selectedFields,\r\n          addSubtract: this.addSubtractFields,\r\n          randomize: this.randomizeFields,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Search and Select mode\r\n      if (this.options.massSelect) {\r\n        return performMassSearch(event.submitter.value, this.docName, selectedFields, {\r\n          scope: this.modUpdate ? this.modUpdateType : null,\r\n        });\r\n      } else {\r\n        // Edit mode\r\n        return performMassUpdate.call(this, selectedFields, this.meObjects, this.docName, event.submitter.value);\r\n      }\r\n    }\r\n\r\n    _performOnInputChangeUpdate() {\r\n      const selectedFields = this.getSelectedFields();\r\n      performMassUpdate.call(this, selectedFields, this.meObjects, this.docName, this.modUpdateType);\r\n    }\r\n\r\n    /**\r\n     * Copy currently selected field to the clipboard\r\n     */\r\n    performMassCopy({ command = '', selectedFields = null } = {}) {\r\n      if (!selectedFields) {\r\n        selectedFields = this.getSelectedFields();\r\n        if (this.documentName === 'Token') {\r\n          TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n        }\r\n      }\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return false;\r\n\r\n      const preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: selectedFields,\r\n        randomize: this.randomizeFields,\r\n        addSubtract: this.addSubtractFields,\r\n      });\r\n\r\n      copyToClipboard(preset, command, this.isPrototype);\r\n      return true;\r\n    }\r\n\r\n    _getHeaderButtons() {\r\n      const buttons = super._getHeaderButtons();\r\n      if (this.options.presetEdit) return buttons;\r\n\r\n      // Macro Generator\r\n      if (SUPPORTED_PLACEABLES.includes(this.docName) || SUPPORTED_COLLECTIONS.includes(this.docName)) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-macro',\r\n          icon: 'fas fa-terminal',\r\n          onclick: () => {\r\n            const selectedFields = this.getSelectedFields();\r\n            new MacroForm(\r\n              this.object,\r\n              this.meObjects,\r\n              this.docName,\r\n              selectedFields,\r\n              this.randomizeFields,\r\n              this.addSubtractFields\r\n            ).render(true);\r\n          },\r\n        });\r\n      }\r\n\r\n      // Brush Tool\r\n      if (SUPPORTED_PLACEABLES.includes(this.docName)) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-brush',\r\n          icon: 'fas fa-paint-brush',\r\n          onclick: () => {\r\n            Brush.activate({ app: this });\r\n          },\r\n        });\r\n      }\r\n\r\n      // Edit Permissions\r\n      if (['Token', 'Note', 'Actor'].includes(this.docName)) {\r\n        let docs = [];\r\n        const ids = new Set();\r\n        for (const p of this.meObjects) {\r\n          let d;\r\n          if (this.docName === 'Actor' || this.docName === 'JournalEntry') d = p;\r\n          else if (this.docName === 'Token' && p.actor) d = p.actor;\r\n          else if (this.docName === 'Note' && p.entry) d = p.entry;\r\n\r\n          // Only retain unique docs\r\n          if (d && !ids.has(d.id)) {\r\n            docs.push(d);\r\n            ids.add(d.id);\r\n          }\r\n        }\r\n\r\n        if (docs.length)\r\n          buttons.unshift({\r\n            label: '',\r\n            class: 'mass-edit-permissions',\r\n            icon: 'fas fa-lock fa-fw',\r\n            onclick: () => {\r\n              let MP = WithMassPermissions();\r\n              new MP(docs[0], docs).render(true);\r\n            },\r\n          });\r\n      }\r\n\r\n      if (!this.options.simplified) {\r\n        // Open Preset form\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-presets',\r\n          icon: 'fas fa-box',\r\n          onclick: () => {\r\n            this.linkedPresetForm = new MassEditPresets(this, null, this.docName, {\r\n              left: this.position.left - 370,\r\n              top: this.position.top,\r\n              preventPositionOverride: true,\r\n            });\r\n            this.linkedPresetForm.render(true);\r\n          },\r\n        });\r\n      }\r\n\r\n      // Apply JSON data onto the form\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-apply',\r\n        icon: 'far fa-money-check-edit',\r\n        onclick: (ev) => {\r\n          let selFields = expandObject(this.getSelectedFields());\r\n          if (foundry.utils.isEmpty(selFields)) selFields = '';\r\n          else selFields = JSON.stringify(selFields, null, 2);\r\n          let content = `<textarea class=\"json\" style=\"width:100%; height: 300px;\">${selFields}</textarea>`;\r\n          new Dialog({\r\n            title: localize('form.apply-json'),\r\n            content: content,\r\n            buttons: {\r\n              apply: {\r\n                label: localize('common.apply'),\r\n                callback: (html) => {\r\n                  let json = {};\r\n                  try {\r\n                    json = JSON.parse(html.find('.json').val());\r\n                  } catch (e) {}\r\n\r\n                  if (!foundry.utils.isEmpty(json)) {\r\n                    const preset = new Preset({\r\n                      documentName: this.docName,\r\n                      data: foundry.utils.flattenObject(json),\r\n                    });\r\n                    this._processPreset(preset);\r\n                  }\r\n                },\r\n              },\r\n            },\r\n          }).render(true);\r\n        },\r\n      });\r\n\r\n      // Toggle between Token and Actor forms\r\n      if (this.documentName === 'Token' && this.meObjects.filter((t) => t.actor).length) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-actors',\r\n          icon: 'fas fa-user',\r\n          onclick: () => {\r\n            if (\r\n              showMassActorForm(this.meObjects, {\r\n                massEdit: this.options.massEdit,\r\n              })\r\n            ) {\r\n              this.close();\r\n            }\r\n          },\r\n        });\r\n      }\r\n\r\n      return buttons;\r\n    }\r\n\r\n    async activateListeners(html) {\r\n      await super.activateListeners(html);\r\n      // We want to update fields used by brush control every time a field changes on the form\r\n      html.on('input', 'textarea, input[type=\"text\"], input[type=\"number\"]', () => Brush.refreshPreset());\r\n      html.on('change', 'textarea, input, select', () => Brush.refreshPreset());\r\n      html.on('paste', 'input', () => Brush.refreshPreset());\r\n      html.on('click', 'button', () => Brush.refreshPreset());\r\n    }\r\n\r\n    async close(options = {}) {\r\n      Brush.deactivate();\r\n      options.force = true;\r\n\r\n      if (['Token', 'AmbientLight'].includes(this.docName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n      if (this.linkedPresetForm) this.linkedPresetForm.close();\r\n      return super.close(options);\r\n    }\r\n\r\n    // Some forms will manipulate themselves via modifying internal objects and re-rendering\r\n    // In such cases we want to preserve the selected fields\r\n    render(force, options = {}) {\r\n      // If it's being re-rendered with an action \"update\" in means it's ClientDocumentMixin response to _onUpdate\r\n      // We can ignore these\r\n      if (options.action === 'update') return;\r\n      // Form hasn't been rendered yet, aka first render pass, ignore it\r\n      if (!this.form) return super.render(force, options);\r\n\r\n      // Fetch the currently selected fields before re-rendering\r\n      const selectedFields = this.getSelectedFields();\r\n      const randomize = this.randomizeFields;\r\n      const addSubtract = this.addSubtractFields;\r\n\r\n      // Render, the selections will be wiped\r\n      super.render(force, options);\r\n\r\n      // Re-select fields, we're reusing preset functions here.\r\n      // Timeout require for this module including others to apply their\r\n      // modifications to the configuration window\r\n      setTimeout(() => {\r\n        if (this.form) {\r\n          this._applyPreset(\r\n            new Preset({\r\n              data: selectedFields,\r\n              randomize,\r\n              addSubtract,\r\n            })\r\n          );\r\n        }\r\n      }, 1000);\r\n    }\r\n\r\n    async _processPreset(preset) {\r\n      // This will be called when a preset item is selected or JSON data is being directly applied\r\n      // The code bellow handles it being applied to the current form\r\n\r\n      // =====================\r\n      // Module specific logic\r\n      // =====================\r\n      let timeoutRequired = false;\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n      // Monk's Active Tiles\r\n      if ('flags.monks-active-tiles.actions' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.setFlag('monks-active-tiles', 'actions', data['flags.monks-active-tiles.actions']);\r\n      }\r\n\r\n      if ('flags.monks-active-tiles.files' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.setFlag('monks-active-tiles', 'files', data['flags.monks-active-tiles.files']);\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.setFlag('levels-3d-preview', 'shaders', data['flags.levels-3d-preview.shaders']);\r\n      }\r\n\r\n      // Limits\r\n      if ('flags.limits.light.enabled' in data) {\r\n        timeoutRequired = true;\r\n        await this.object.update({ flags: { limits: expandObject(data).flags.limits } });\r\n      }\r\n\r\n      if (this.documentName === 'Token') {\r\n        timeoutRequired = TokenDataAdapter.modifyPresetData(this, data);\r\n      }\r\n\r\n      if (timeoutRequired) {\r\n        setTimeout(() => {\r\n          this._applyPreset(preset);\r\n        }, 250);\r\n        return;\r\n      }\r\n\r\n      this._applyPreset(preset);\r\n    }\r\n\r\n    _applyPreset(preset) {\r\n      const form = $(this.form);\r\n\r\n      const customMerge = (obj1, obj2) => {\r\n        if (!obj2) return obj1;\r\n        for (const [k, v] of Object.entries(obj2)) {\r\n          obj1[k] = v;\r\n        }\r\n        return obj1;\r\n      };\r\n\r\n      this.randomizeFields = customMerge(this.randomizeFields, preset.randomize);\r\n      this.addSubtractFields = customMerge(this.addSubtractFields, preset.addSubtract);\r\n      selectRandomizerFields(form, this.randomizeFields);\r\n      selectAddSubtractFields(form, this.addSubtractFields);\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n      GeneralDataAdapter.dataToForm(this.documentName, preset.data[0], data);\r\n      for (const key of Object.keys(data)) {\r\n        const el = form.find(`[name=\"${key}\"]`);\r\n        if (el.is(':checkbox')) {\r\n          el.prop('checked', data[key]);\r\n        } else {\r\n          el.val(data[key]);\r\n        }\r\n        el.trigger('change');\r\n      }\r\n\r\n      // Make brush aware of randomized field changes\r\n      Brush.refreshPreset();\r\n    }\r\n\r\n    get title() {\r\n      if (this.options.massSelect) return localFormat('form.mass-search-title', { document: this.documentName });\r\n      return localFormat('form.mass-edit-title', { document: this.documentName, count: this.meObjects.length });\r\n    }\r\n  }\r\n\r\n  const constructorName = `Mass${docName}Config`;\r\n  Object.defineProperty(MassConfig.prototype.constructor, 'name', { value: constructorName });\r\n  return MassConfig;\r\n};\r\n\r\n// ====================\r\n// ===== UTILS ========\r\n// ====================\r\n\r\n/**\r\n *\r\n * @param {Document} docs\r\n * @param {Preset} preset\r\n * @param {boolean} suppressNotif\r\n * @returns\r\n */\r\nexport function pasteDataUpdate(docs, preset, suppressNotif = false, excludePosition = false, transform = null) {\r\n  if (!docs || !docs.length) return false;\r\n\r\n  let docName = docs[0].document ? docs[0].document.documentName : docs[0].documentName;\r\n\r\n  preset = preset ?? getClipboardData(docName);\r\n  let applyType;\r\n\r\n  // Special handling for Tokens/Actors\r\n  if (!preset) {\r\n    if (docName === 'Token') {\r\n      if (!preset) {\r\n        preset = getClipboardData('TokenProto');\r\n        applyType = 'applyToPrototype';\r\n      }\r\n\r\n      if (!preset) {\r\n        preset = getClipboardData('Actor');\r\n        docName = 'Actor';\r\n        docs = docs.filter((d) => d.actor).map((d) => d.actor);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (preset) {\r\n    if (preset.documentName !== docName) return;\r\n\r\n    const context = { meObjects: docs };\r\n    if (!foundry.utils.isEmpty(preset.randomize)) context.randomizeFields = preset.randomize;\r\n    if (!foundry.utils.isEmpty(preset.addSubtract)) context.addSubtractFields = preset.addSubtract;\r\n\r\n    let data = foundry.utils.deepClone(preset.data[Math.floor(Math.random() * preset.data.length)]);\r\n    if (transform) DataTransform.apply(docName, data, { x: 0, y: 0 }, transform);\r\n    if (excludePosition) {\r\n      delete data.x;\r\n      delete data.y;\r\n      delete data.c;\r\n    }\r\n\r\n    performMassUpdate.call(context, foundry.utils.flattenObject(data), docs, preset.documentName, applyType);\r\n    if (!suppressNotif)\r\n      ui.notifications.info(\r\n        localFormat('clipboard.paste', {\r\n          document: preset.documentName,\r\n          count: docs.length,\r\n        })\r\n      );\r\n\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function performMassSearch(\r\n  command,\r\n  docName,\r\n  selectedFields,\r\n  { scope = null, selected = null, control = true, pan = true } = {}\r\n) {\r\n  const found = [];\r\n\r\n  if (scope === 'selected') {\r\n    performDocSearch(selected, docName, selectedFields, found);\r\n  } else if (SUPPORTED_COLLECTIONS.includes(docName)) {\r\n    performDocSearch(Array.from(game.collections.get(docName)), docName, selectedFields, found);\r\n  } else {\r\n    let scenes = [];\r\n    if (scope === 'world') scenes = Array.from(game.scenes);\r\n    else if (canvas.scene) scenes = [canvas.scene];\r\n\r\n    for (const scene of scenes) {\r\n      performMassSearchScene(scene, docName, selectedFields, found);\r\n    }\r\n  }\r\n\r\n  // Select found placeables/documents\r\n  if (control) {\r\n    // First release/de-select the currently selected placeable on the current scene\r\n    canvas.activeLayer.controlled.map((c) => c).forEach((c) => c.release());\r\n\r\n    setTimeout(() => {\r\n      found.forEach((f) => {\r\n        let obj = f.object ?? f;\r\n        if (obj.control) obj.control({ releaseOthers: false });\r\n      });\r\n\r\n      if (pan && found.length && game.settings.get(MODULE_ID, 'panToSearch')) {\r\n        panToFitPlaceables(found);\r\n      }\r\n    }, 100);\r\n  }\r\n  if (command === 'searchAndEdit') {\r\n    setTimeout(() => {\r\n      showMassEdit(found, docName);\r\n    }, 500);\r\n  }\r\n  return found;\r\n}\r\n\r\nfunction performMassSearchScene(scene, docName, selectedFields, found) {\r\n  const docs = Array.from(scene[SCENE_DOC_MAPPINGS[docName]]);\r\n  performDocSearch(docs, docName, selectedFields, found);\r\n}\r\n\r\nfunction performDocSearch(docs, docName, selectedFields, found) {\r\n  // Next select objects that match the selected fields\r\n  for (const c of docs) {\r\n    let matches = true;\r\n    const data = foundry.utils.flattenObject(getData(c).toObject());\r\n\r\n    // Special processing for some placeable types\r\n    // Necessary when form data is not directly mappable to placeable\r\n    GeneralDataAdapter.dataToForm(docName, c, data);\r\n\r\n    for (const [k, v] of Object.entries(selectedFields)) {\r\n      // Special handling for flags\r\n      if (k.startsWith('flags.')) {\r\n        if (!flagCompare(data, k, v)) {\r\n          matches = false;\r\n          break;\r\n        }\r\n        // Special handling for empty strings and undefined\r\n      } else if ((v === '' || v == null) && (data[k] !== '' || data[k] != null)) {\r\n        // matches\r\n      } else if (typeof v === 'string' && v.includes('*') && wildcardStringMatch(v, data[k])) {\r\n        // Wildcard matched\r\n      } else if (data[k] != v) {\r\n        // Detection mode keys cannot be treated in isolation\r\n        // We skip them here and will check them later\r\n        if (docName === 'Token') {\r\n          if (k.startsWith('detectionModes')) {\r\n            continue;\r\n          }\r\n        }\r\n\r\n        matches = false;\r\n        break;\r\n      }\r\n    }\r\n    if (matches) {\r\n      // We skipped detectionMode matching in the previous step and do it now instead\r\n      if (docName === 'Token') {\r\n        const modes = Object.values(foundry.utils.expandObject(selectedFields)?.detectionModes || {});\r\n\r\n        if (!TokenDataAdapter.detectionModeMatch(modes, c.detectionModes)) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      found.push(c);\r\n    }\r\n  }\r\n}\r\n\r\nexport async function performMassUpdate(data, objects, docName, applyType) {\r\n  // Used by GenericForms, we want just the data, and no updates\r\n  if (this.options?.simplified) {\r\n    if (this.options.callback) this.options.callback(data);\r\n    return;\r\n  }\r\n  if (foundry.utils.isEmpty(data)) {\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Make sure we're working with documents and not placeables\r\n  objects = objects.map((o) => o.document ?? o);\r\n\r\n  // Update docs\r\n  const updates = [];\r\n  const context = {};\r\n\r\n  const total = objects.length;\r\n  for (let i = 0; i < total; i++) {\r\n    const update = foundry.utils.deepClone(data);\r\n    update._id = objects[i].id;\r\n\r\n    // push update\r\n    updates.push(update);\r\n  }\r\n\r\n  // Applies randomization\r\n  if (this) await applyRandomization(updates, objects, this.randomizeFields);\r\n  if (this) applyAddSubtract(updates, objects, docName, this.addSubtractFields);\r\n\r\n  // Necessary when form data is not directly mappable to placeable\r\n  for (let i = 0; i < total; i++) {\r\n    GeneralDataAdapter.formToData(docName, objects[i], updates[i]);\r\n  }\r\n\r\n  await checkApplySpecialFields(docName, updates, objects);\r\n\r\n  if (docName === 'Actor') {\r\n    // Perform Updates\r\n    // There is a lot of wonkiness related to updating of real/synthetic actors. It's probably best\r\n    // to simply update the Actors directly\r\n\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      if (this.options?.tokens) this.options.tokens[i].actor.update(update);\r\n      else objects[i].update(update);\r\n    }\r\n  } else if (docName === 'Scene') {\r\n    Scene.updateDocuments(updates, context);\r\n  } else if (docName === 'PlaylistSound') {\r\n    for (let i = 0; i < objects.length; i++) {\r\n      delete updates[i]._id;\r\n      objects[i].update(updates[i], context);\r\n    }\r\n  } else if (docName === 'Note') {\r\n    // Notes can be updated across different scenes\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].scene ?? objects[i].parent;\r\n      if (applyType === 'currentScene' && scene.id !== canvas.scene.id) continue;\r\n      if (!(scene.id in splitUpdates)) {\r\n        splitUpdates[scene.id] = { scene: scene, updates: [] };\r\n      }\r\n      splitUpdates[scene.id].updates.push(updates[i]);\r\n    }\r\n    for (const sceneUpdate of Object.values(splitUpdates)) {\r\n      sceneUpdate.scene.updateEmbeddedDocuments(docName, sceneUpdate.updates, context);\r\n    }\r\n  } else if (!this.isPrototype && SUPPORTED_PLACEABLES.includes(docName)) {\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].parent;\r\n      if (!splitUpdates[scene.id]) splitUpdates[scene.id] = [];\r\n      splitUpdates[scene.id].push(updates[i]);\r\n    }\r\n\r\n    for (const sceneId of Object.keys(splitUpdates)) {\r\n      game.scenes.get(sceneId)?.updateEmbeddedDocuments(docName, splitUpdates[sceneId], context);\r\n    }\r\n  } else if (SUPPORTED_COLLECTIONS.includes(docName)) {\r\n    objects[0].constructor?.updateDocuments(updates, context);\r\n  } else {\r\n    // Note a placeable or otherwise specially handled doc type\r\n    // Simply merge the fields directly into the object\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      mergeObjectPreserveDot(objects[i], foundry.utils.mergeObject(objects[i], update));\r\n    }\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n  }\r\n\r\n  // May need to also update Token prototypes\r\n  if ((applyType === 'applyToPrototype' || this.isPrototype) && docName === 'Token') {\r\n    const actorUpdates = {};\r\n    for (let i = 0; i < objects.length; i++) {\r\n      const actor = objects[i].actor;\r\n      if (actor) actorUpdates[actor.id] = { _id: actor.id, prototypeToken: updates[i] };\r\n    }\r\n    if (!foundry.utils.isEmpty(actorUpdates)) {\r\n      const updates = [];\r\n      for (const id of Object.keys(actorUpdates)) {\r\n        updates.push(actorUpdates[id]);\r\n      }\r\n      Actor.updateDocuments(updates);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Processes Mass Edit inserted custom fields\r\n * @param {String} docName\r\n * @param {*} updates\r\n * @param {*} objects\r\n */\r\nexport async function checkApplySpecialFields(docName, updates, objects) {\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const object = objects[i];\r\n\r\n    // Token Magic FX specific processing\r\n    if (update.hasOwnProperty('tokenmagic.ddTint') && typeof TokenMagic !== 'undefined') {\r\n      await applyDDTint(object, update['tokenmagic.ddTint']);\r\n    }\r\n    if (update.hasOwnProperty('tokenmagic.preset') && typeof TokenMagic !== 'undefined') {\r\n      await applyTMFXPreset(\r\n        object,\r\n        update['tokenmagic.preset'],\r\n        this?.addSubtractFields?.['tokenmagic.preset']?.method === 'subtract'\r\n      );\r\n    }\r\n\r\n    // Mass Edit inserted fields\r\n    if (docName === 'Tile') {\r\n      if (update.hasOwnProperty('massedit.scale')) {\r\n        const scale = update['massedit.scale'];\r\n        update.width = object.width * scale;\r\n        update.height = object.height * scale;\r\n\r\n        // 3D Support\r\n        if (object.flags?.['levels-3d-preview']?.depth != null) {\r\n          update['flags.levels-3d-preview.depth'] = object.flags['levels-3d-preview'].depth *= scale;\r\n        } else if (object['flags.levels-3d-preview.depth'] != null) {\r\n          update['flags.levels-3d-preview.depth'] = object['flags.levels-3d-preview.depth'] * scale;\r\n        }\r\n      }\r\n\r\n      if (update.hasOwnProperty('massedit.texture.scale')) {\r\n        update['texture.scaleX'] = update['massedit.texture.scale'];\r\n        update['texture.scaleY'] = update['massedit.texture.scale'];\r\n        delete update['massedit.texture.scale'];\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Toggle checkbox if input has been detected inside it's form-group\r\nasync function onInputChange(event) {\r\n  if (event.target.className === 'mass-edit-control') {\r\n    if (!event.target.checked) {\r\n      // If the checkbox has been unchecked we may need to remove highlighting from tabs\r\n      deselectTabs(event.target);\r\n      return;\r\n    }\r\n  }\r\n\r\n  const meChk = $(event.target).closest('.form-group').find('.mass-edit-checkbox input');\r\n  meChk.prop('checked', true);\r\n\r\n  // Highlight tabs if they exist\r\n  selectTabs(meChk[0]);\r\n\r\n  // Immediately update the placeables\r\n  if (this && this.options.massEdit && this._performOnInputChangeUpdate && this.modUpdate)\r\n    this._performOnInputChangeUpdate();\r\n}\r\n\r\nfunction selectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .addClass('mass-edit-tab-selected');\r\n    selectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nfunction deselectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length && tab.find('.mass-edit-checkbox input:checked').length === 0) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .removeClass('mass-edit-tab-selected');\r\n    deselectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nexport function getObjFormData(obj, docName) {\r\n  const data = foundry.utils.flattenObject(getData(obj).toObject());\r\n\r\n  // Special processing for some placeable types\r\n  // Necessary when form data is not directly mappable to placeable\r\n  GeneralDataAdapter.dataToForm(docName, obj, data);\r\n\r\n  return data;\r\n}\r\n\r\n// Merge all data and determine what is common between the docs\r\nfunction getCommonDocData(docs, docName) {\r\n  if (!docName) getDocumentName(docs[0]);\r\n  const objects = docs.map((d) => getObjFormData(d, docName));\r\n  return getCommonData(objects);\r\n}\r\n\r\nexport const WithMassPermissions = () => {\r\n  let MEF = WithMassEditForm(DocumentOwnershipConfig);\r\n\r\n  class MassPermissions extends MEF {\r\n    constructor(target, docs, options = {}) {\r\n      // Generate common permissions\r\n      const data = getData(docs[0]);\r\n      const commonData = foundry.utils.flattenObject(data.ownership);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      // Permissions are only present if they differ from default, for simplicity simple add them before comparing\r\n      const addMissingPerms = function (perms) {\r\n        game.users.forEach((u) => {\r\n          if (!(u.id in perms)) perms[u.id] = metaLevels.DEFAULT;\r\n        });\r\n\r\n        if (!('default' in perms)) perms.default = metaLevels.DEFAULT;\r\n      };\r\n      addMissingPerms(commonData);\r\n\r\n      for (let i = 1; i < docs.length; i++) {\r\n        const data = getData(docs[i]);\r\n        const flatData = foundry.utils.flattenObject(data.ownership);\r\n        addMissingPerms(flatData);\r\n        const diff = foundry.utils.flattenObject(foundry.utils.diffObject(commonData, flatData));\r\n        for (const k of Object.keys(diff)) {\r\n          delete commonData[k];\r\n        }\r\n      }\r\n\r\n      options.commonData = commonData;\r\n      options.massPermissions = true;\r\n\r\n      super(target, docs, options);\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      const selectedFields = this.getSelectedFields(formData);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return;\r\n\r\n      const ids = new Set();\r\n      const updates = [];\r\n      for (const d of this.meObjects) {\r\n        if (!ids.has(d.id)) {\r\n          const data = getData(d);\r\n          const ownership = foundry.utils.deepClone(data.ownership);\r\n\r\n          for (let [user, level] of Object.entries(selectedFields)) {\r\n            if (level === metaLevels.DEFAULT) delete ownership[user];\r\n            else ownership[user] = level;\r\n          }\r\n\r\n          ids.add(d.id);\r\n          updates.push({ _id: d.id, ownership: ownership });\r\n        }\r\n      }\r\n\r\n      this.meObjects[0].constructor.updateDocuments(updates, {\r\n        diff: false,\r\n        recursive: false,\r\n        noHook: true,\r\n      });\r\n    }\r\n\r\n    get title() {\r\n      return `Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`;\r\n    }\r\n  }\r\n\r\n  return MassPermissions;\r\n};\r\n\r\n// ==================================\r\n// ========== CLIPBOARD =============\r\n// ==================================\r\n\r\nconst CLIPBOARD = {};\r\n\r\nexport function copyToClipboard(preset, command, isPrototype) {\r\n  CLIPBOARD[preset.documentName] = preset;\r\n\r\n  // Special handling for Actors/Tokens\r\n  if (preset.documentName === 'Token' && isPrototype) {\r\n    CLIPBOARD['TokenProto'] = preset;\r\n  } else if (preset.documentName === 'Token') {\r\n    if (command === 'copyProto') {\r\n      delete CLIPBOARD['Token'];\r\n      CLIPBOARD['TokenProto'] = preset;\r\n    }\r\n  }\r\n\r\n  // Also copy the fields to the game clipboard as plain text\r\n  game.clipboard.copyPlainText(\r\n    JSON.stringify(foundry.utils.deepClone(preset.data.length === 1 ? preset.data[0] : preset.data), null, 2)\r\n  );\r\n\r\n  ui.notifications.info(\r\n    localFormat('clipboard.copy', {\r\n      document: preset.documentName,\r\n    })\r\n  );\r\n}\r\n\r\nexport function deleteFromClipboard(docName) {\r\n  delete CLIPBOARD[docName];\r\n  if (docName === 'Token') delete CLIPBOARD['TokenProto'];\r\n}\r\n\r\nexport function getClipboardData(docName) {\r\n  return CLIPBOARD[docName];\r\n}\r\n","import { constructNav } from '../applications/generic/navGenerator.js';\r\nimport { MODULE_ID, getDocumentName, localize } from './utils.js';\r\n\r\nexport function injectVisibility(app) {\r\n  const docName = getDocumentName(app.meObjects[0]);\r\n\r\n  // Only the following docs necessitate hidden field\r\n  if (!['AmbientLight', 'AmbientSound'].includes(docName)) return;\r\n\r\n  const form = $(app.form);\r\n\r\n  const isInjected = form.find('input[name=\"hidden\"]');\r\n  if (isInjected.length) return;\r\n\r\n  const hidden = app.object.hidden;\r\n  const newHtml = `\r\n  <div class=\"form-group\">\r\n    <label>${localize(`Hidden`, false)}</label>\r\n    <div class=\"form-fields\">\r\n        <input type=\"checkbox\" name=\"hidden\" ${hidden ? 'checked' : ''}>\r\n    </div>\r\n  </div>\r\n`;\r\n\r\n  const tabs = form.find('div.tab');\r\n  if (tabs.length) {\r\n    tabs.first().append(newHtml);\r\n  } else {\r\n    form.find('.form-group').last().after(newHtml);\r\n  }\r\n\r\n  app.setPosition({ height: 'auto' });\r\n}\r\n\r\nexport async function injectFlagTab(app) {\r\n  // Disable for now, until duplicate value fix is found\r\n  return;\r\n  if (!game.settings.get(MODULE_ID, 'enableFlagsTab')) return;\r\n  if (app.constructor.name === 'MassEditGenericForm') return;\r\n  const doc = app.meObjects[0];\r\n  let flags = foundry.utils.flattenObject((doc.document ?? doc).flags ?? {});\r\n\r\n  const html = $(app.form);\r\n  for (const [k, v] of Object.entries(flags)) {\r\n    if (html.find(`[name=\"flags.${k}\"]`).length) {\r\n      delete flags[k];\r\n    }\r\n  }\r\n\r\n  if (foundry.utils.isEmpty(flags)) return;\r\n\r\n  flags = expandObject(flags);\r\n\r\n  // Need to wait for other modules to perform their processing first\r\n  // Mainly MATT Active Tiles\r\n  if (getDocumentName(doc) === 'Wall') await new Promise((resolve) => setTimeout(resolve, 150));\r\n\r\n  const [flagNav, flagTabs] = constructNav({ flags: flags });\r\n  delete flagNav.items;\r\n  app.options.tabs = (app.options.tabs ?? []).concat(flagTabs);\r\n  if (app.tabs) app.tabs = app._createTabHandlers();\r\n  else app._tabs = app._createTabHandlers();\r\n\r\n  if (!flagNav.tabs.length) return;\r\n  flagNav.tabs[0].nav?.items?.forEach((item) => {\r\n    const mod = game.modules.get(item.dataTab.replace('flags.', ''));\r\n    if (mod) item.label = mod.title;\r\n  });\r\n\r\n  await getTemplate(`modules/${MODULE_ID}/templates/generic/form-group.html`);\r\n  await getTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`);\r\n  let htmlNav = await renderTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`, flagNav);\r\n\r\n  htmlNav = $(htmlNav);\r\n\r\n  // Remove pins or replace them with trash cans depending on whether this is a Mass Edit or Search form\r\n  if (app.options.massSelect) {\r\n    htmlNav.find('.me-pinned').remove();\r\n  } else {\r\n    htmlNav.find('.me-pinned').replaceWith(`<a class=\"me-delete-flag\" title=\"DELETE\"><i class=\"fas fa-trash\"></i></a>`);\r\n    html.on('click', '.me-delete-flag', (event) => {\r\n      const delFlag = $(event.target).closest('a');\r\n      delFlag.toggleClass('active');\r\n      const toDelete = delFlag.hasClass('active');\r\n      const namedElements = delFlag.closest('.form-group').find('[name]');\r\n      namedElements.each(function () {\r\n        const name = this.name;\r\n        if (toDelete && !name.includes('-=')) {\r\n          let nArr = name.split('.');\r\n          nArr[nArr.length - 1] = '-=' + nArr[nArr.length - 1];\r\n          this.name = nArr.join('.');\r\n        } else if (!toDelete) {\r\n          this.name = name.replace('-=', '');\r\n        }\r\n      });\r\n      namedElements.first().trigger('change');\r\n    });\r\n  }\r\n\r\n  // Insert Flags tab into\r\n  const sheetMainNav = html.find('.sheet-tabs').first();\r\n  if (!sheetMainNav.length) return;\r\n  sheetMainNav.append('<a class=\"item\" data-tab=\"flags\"><i class=\"fa-solid fa-flag\"></i> Flags</a>');\r\n\r\n  if (!sheetMainNav.attr('data-group')) {\r\n    htmlNav.removeAttr('data-group');\r\n  }\r\n  html.find('footer').last().before(htmlNav);\r\n\r\n  // For special jsonArray fields provide the ability to expand them via a dialog\r\n  html.find('.tva-jsonArray').on('dblclick', (event) => {\r\n    let content = `<textarea style=\"width:100%; height: 100%;\">${event.target.value}</textarea>`;\r\n    new Dialog(\r\n      {\r\n        title: `Edit`,\r\n        content: content,\r\n        buttons: {},\r\n        render: (html) => {\r\n          html.find('textarea').on('input', (ev) => {\r\n            $(event.target).val(ev.target.value).trigger('input');\r\n          });\r\n          html.closest('section').find('.dialog-buttons').remove();\r\n        },\r\n      },\r\n      { resizable: true, height: 300 }\r\n    ).render(true);\r\n  });\r\n\r\n  app._activateCoreListeners(html);\r\n}\r\n","export const CUSTOM_CONTROLS = {\n  field: {\n    shieldType: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n    blend: {\n      range: true,\n      min: '0',\n      max: '16',\n      step: '1',\n    },\n    scale: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    radius: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    intensity: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    lightAlpha: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    gridPadding: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    lightSize: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    animated: {\n      time: {\n        speed: {\n          range: true,\n          min: '0',\n          max: '0.05',\n          step: '0.0001',\n        },\n      },\n    },\n  },\n  fire: {\n    fireBlend: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n    blend: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n    animated: {\n      intensity: {\n        animType: {\n          select: true,\n          options: [\n            'syncChaoticOscillation',\n            'syncSinOscillation',\n            'syncCosOscillation',\n            'chaoticOscillation',\n            'halfSinOscillation',\n            'sinOscillation',\n            'halfCosOscillation',\n            'cosOscillation',\n            'syncColorOscillation',\n            'halfColorOscillation',\n            'colorOscillation',\n          ],\n        },\n        val2: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n        val1: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n        loopDuration: {\n          range: true,\n          min: '0',\n          max: '50000',\n          step: '100',\n        },\n      },\n      amplitude: {\n        animType: {\n          select: true,\n          options: [\n            'syncChaoticOscillation',\n            'syncSinOscillation',\n            'syncCosOscillation',\n            'chaoticOscillation',\n            'halfSinOscillation',\n            'sinOscillation',\n            'halfCosOscillation',\n            'cosOscillation',\n            'syncColorOscillation',\n            'halfColorOscillation',\n            'colorOscillation',\n          ],\n        },\n        loopDuration: {\n          range: true,\n          min: '0',\n          max: '50000',\n          step: '100',\n        },\n        val1: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n        val2: {\n          range: true,\n          min: '0',\n          max: '5',\n          step: '0.1',\n        },\n      },\n    },\n    intensity: {\n      range: true,\n      min: '0',\n      max: '100',\n      step: '0.1',\n    },\n  },\n  electric: {\n    blend: {\n      range: true,\n      min: '0',\n      max: '13',\n      step: '1',\n    },\n  },\n  xglow: {\n    auraType: {\n      range: true,\n      min: '0',\n      max: '2',\n      step: '1',\n    },\n    scale: {\n      range: true,\n      min: '0',\n      max: '30',\n      step: '0.1',\n    },\n    auraIntensity: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    subAuraIntensity: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    threshold: {\n      range: true,\n      min: '0',\n      max: '2',\n      step: '0.01',\n    },\n    thickness: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n  },\n  glow: {\n    outerStrength: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    innerStrength: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    padding: {\n      range: true,\n      min: '0',\n      max: '100',\n      step: '1',\n    },\n    alpha: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n  },\n  zapshadow: {\n    alphaTolerance: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n  },\n  sprite: {\n    blendMode: {\n      range: true,\n      min: '0',\n      max: '16',\n      step: '1',\n    },\n    gridPadding: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.1',\n    },\n    scaleX: {\n      range: true,\n      min: '0',\n      max: '3',\n      step: '0.01',\n    },\n    scaleY: {\n      range: true,\n      min: '0',\n      max: '3',\n      step: '0.01',\n    },\n    translationX: {\n      range: true,\n      min: '-1',\n      max: '1',\n      step: '0.001',\n    },\n    translationY: {\n      range: true,\n      min: '-1',\n      max: '1',\n      step: '0.001',\n    },\n    rotation: {\n      range: true,\n      min: '0',\n      max: '360',\n      step: '1',\n    },\n    alpha: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n  },\n  xfire: {\n    blend: {\n      range: true,\n      min: '0',\n      max: '16',\n      step: '1',\n    },\n    amplitude: {\n      range: true,\n      min: '0',\n      max: '10',\n      step: '0.01',\n    },\n    dispersion: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '0.1',\n    },\n    scaleX: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    scaleY: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    animated: {\n      time: {\n        speed: {\n          range: true,\n          min: '-0.0050',\n          max: '0.0050',\n          step: '0.0001',\n        },\n      },\n    },\n  },\n  transform: {\n    gridPadding: {\n      range: true,\n      min: '0',\n      max: '50',\n      step: '0.1',\n    },\n    scaleX: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.1',\n    },\n    scaleY: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.1',\n    },\n  },\n  ascii: {\n    animated: {\n      size: {\n        val1: {\n          range: true,\n          min: '-5',\n          max: '5',\n          step: '0.01',\n        },\n        val2: {\n          range: true,\n          min: '-5',\n          max: '5',\n          step: '0.01',\n        },\n      },\n    },\n    size: {\n      range: true,\n      min: '1',\n      max: '64',\n      step: '1',\n    },\n  },\n  dot: {\n    scale: {\n      range: true,\n      min: '0',\n      max: '10',\n      step: '0.1',\n    },\n    angle: {\n      range: true,\n      min: '0',\n      max: '360',\n      step: '1',\n    },\n  },\n  godray: {\n    blendMode: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '1',\n    },\n    padding: {\n      range: true,\n      min: '-5',\n      max: '50',\n      step: '0.1',\n    },\n  },\n  rgbSplit: {\n    redX: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    redY: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    greenX: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    greenY: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    blueX: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n    blueY: {\n      range: true,\n      min: '-50',\n      max: '50',\n      step: '1',\n    },\n  },\n  polymorph: {\n    type: {\n      range: true,\n      min: '0',\n      max: '9',\n      step: '1',\n    },\n  },\n  shadow: {\n    blur: {\n      range: true,\n      min: '0',\n      max: '20',\n      step: '1',\n    },\n  },\n  flood: {\n    billowy: {\n      range: true,\n      min: '0',\n      max: '5',\n      step: '0.01',\n    },\n    tintIntensity: {\n      range: true,\n      min: '0.0',\n      max: '1',\n      step: '0.01',\n    },\n    glint: {\n      range: true,\n      min: '0',\n      max: '1',\n      step: '0.01',\n    },\n    scale: {\n      range: true,\n      min: '5',\n      max: '500',\n      step: '1',\n    },\n    animated: {\n      time: {\n        speed: {\n          range: true,\n          min: '0.00001',\n          max: '0.001',\n          step: '0.00001',\n        },\n      },\n    },\n  },\n};\n","import { CUSTOM_CONTROLS } from '../../data/custom-controls.js';\r\nimport { MODULE_ID, getCommonData, localize } from '../../scripts/utils.js';\r\nimport { WithMassConfig } from '../forms.js';\r\nimport { showMassEdit } from '../multiConfig.js';\r\nimport { constructNav, isColorField } from './navGenerator.js';\r\n\r\nconst WMC = WithMassConfig();\r\nexport class MassEditGenericForm extends WMC {\r\n  constructor(docs, options = {}) {\r\n    const objects = docs.map((a) => (a.toObject ? a.toObject() : a));\r\n    let allData = {};\r\n    for (let i = objects.length; i >= 0; i--) {\r\n      foundry.utils.mergeObject(allData, objects[i]);\r\n    }\r\n\r\n    if (options.noTabs) {\r\n      allData = foundry.utils.flattenObject(allData);\r\n    }\r\n\r\n    let documentName = options.documentName ?? 'NONE';\r\n\r\n    let customControls = foundry.utils.mergeObject(\r\n      CUSTOM_CONTROLS[documentName] ?? {},\r\n      game.settings.get(MODULE_ID, 'customControls')[documentName] ?? {}\r\n    );\r\n    customControls = foundry.utils.mergeObject(customControls, options.customControls?.[documentName] ?? {});\r\n\r\n    const [nav, tabSelectors] = constructNav(allData, documentName, customControls, !options.noTabs);\r\n    const commonData = getCommonData(objects);\r\n\r\n    super(docs[0], docs, {\r\n      tabs: tabSelectors,\r\n      commonData: commonData,\r\n      ...options,\r\n    });\r\n\r\n    this.allData = allData;\r\n    this.nav = nav;\r\n    this.editableLabels = {};\r\n\r\n    this.pinnedFields = game.settings.get(MODULE_ID, 'pinnedFields')[this.documentName] ?? {};\r\n    this.customControls = customControls;\r\n\r\n    if (options.callback) {\r\n      this.callbackOnUpdate = options.callback;\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-generic-form',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/generic/genericForm.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generic`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n    if (this.options.tokens) {\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-tokens',\r\n        icon: 'fas fa-user-circle',\r\n        onclick: () => {\r\n          showMassEdit(this.options.tokens, 'Token');\r\n          this.close();\r\n        },\r\n      });\r\n    }\r\n    return buttons;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = await super.getData(options);\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`, 'me-navHeaderPartial');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/form-group.html`, 'me-form-group');\r\n\r\n    data.nav = this.nav;\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.me-pinned').click((event) => {\r\n      const star = $(event.target).parent();\r\n      const control = star.closest('.form-group').find('[name]');\r\n      const name = control.attr('name');\r\n      if (star.hasClass('active')) {\r\n        star.removeClass('active');\r\n        delete this.pinnedFields[name];\r\n      } else {\r\n        star.addClass('active');\r\n        this.pinnedFields[name] = { label: name };\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label').on('input', (event) => {\r\n      const name = $(event.target).closest('.form-group').find('[name]').attr('name');\r\n      this.editableLabels[name] = event.target.value;\r\n    });\r\n\r\n    html.find('.color-number').on('change', (event) => {\r\n      if (event.target.dataset?.editNumber) {\r\n        let col = 0;\r\n        try {\r\n          col = Number(Color.fromString(event.target.value));\r\n        } catch (e) {}\r\n\r\n        $(event.target).siblings(`[name=\"${event.target.dataset.editNumber}\"]`).val(col).trigger('input');\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label, label').on('contextmenu', (event) => {\r\n      const formGroup = $(event.target).closest('.form-group');\r\n      if (!formGroup.length) return;\r\n      const input = formGroup.find('[name]');\r\n      const name = input.attr('name');\r\n      if (name) {\r\n        if (isColorField(name)) return;\r\n\r\n        const type = input.attr('type');\r\n        if (type === 'range') {\r\n          unsetCustomControl(name, this.documentName);\r\n          return;\r\n        } else if (type === 'number') {\r\n          defineRangeControl(name, input.val(), this.customControls, this.documentName);\r\n        } else if (type === 'text') {\r\n          defineSelectControl(name, input.val(), this.customControls, this.documentName);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (this.options.inputChangeCallback) {\r\n      html.on('change', 'input, select', async (event) => {\r\n        setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    super._updateObject(event, formData);\r\n\r\n    // Save pinned field values and labels\r\n    const pinned = game.settings.get(MODULE_ID, 'pinnedFields');\r\n    pinned[this.documentName] = this.pinnedFields;\r\n\r\n    for (const name of Object.keys(this.pinnedFields)) {\r\n      this.pinnedFields[name].value = formData[name];\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(this.editableLabels)) {\r\n      for (const [name, label] of Object.entries(this.editableLabels)) {\r\n        if (name in this.pinnedFields) {\r\n          this.pinnedFields[name].label = label;\r\n          this.pinnedFields[name].value = formData[name];\r\n        }\r\n      }\r\n      this.editableLabels = {};\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'pinnedFields', pinned);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    if (this.callbackOnUpdate) this.callbackOnUpdate(null);\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\nfunction defineRangeControl(name, val, customControls, docName, { min = null, max = null, step = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>Range</label>\r\n  <div class=\"form-fields\">\r\n    <label>${localize('Minimum', false)}</label>\r\n    <input type=\"number\" value=\"${min ?? val}\" name=\"min\" step=\"any\">\r\n    <label>${localize('Maximum', false)}</label>\r\n    <input type=\"number\" value=\"${max ?? val}\" name=\"max\" step=\"any\">\r\n    <label>${localize('generic-form.step-size')}</label>\r\n    <input type=\"number\" value=\"${step ?? 1}\" name=\"step\" step=\"any\">\r\n  </div>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-range'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const min = html.find('[name=\"min\"]').val() || val;\r\n          const max = html.find('[name=\"max\"]').val() || val;\r\n          const step = html.find('[name=\"step\"]').val() || 1;\r\n\r\n          setProperty(customControls, name, { range: true, min, max, step });\r\n          const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n          allControls[docName] = customControls;\r\n          game.settings.set(MODULE_ID, 'customControls', allControls);\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction defineSelectControl(name, val, customControls, docName, { options = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>${localize('common.options')}</label>\r\n  <textarea name=\"options\">${options ? options.join('\\n') : val}</textarea>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-dropdown'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const options = html.find('[name=\"options\"]').val().trim();\r\n          if (options) {\r\n            setProperty(customControls, name, {\r\n              select: true,\r\n              options: options.split('\\n').filter((o) => o),\r\n            });\r\n            const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n            allControls[docName] = customControls;\r\n            game.settings.set(MODULE_ID, 'customControls', allControls);\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction unsetCustomControl(name, docName) {\r\n  const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n  let docControls = allControls[docName] || {};\r\n  setProperty(docControls, name, null);\r\n  game.settings.set(MODULE_ID, 'customControls', allControls);\r\n}\r\n","import { MODULE_ID, localize } from '../../scripts/utils.js';\r\n\r\nexport function constructNav(allData, documentName, customControls, pins = true) {\r\n  const nav = {\r\n    dataGroup: 'main',\r\n    items: [],\r\n    tabs: [],\r\n  };\r\n  const tabSelectors = [{ navSelector: '.tabs[data-group=\"main\"]', contentSelector: 'form', initial: 'me-pinned' }];\r\n\r\n  // Limit the form to just the keys marked as editable\r\n  let editableKeys;\r\n  // if (documentName === 'Actor') {\r\n  //   editableKeys = ['name', 'img', 'system', 'data', 'folder', 'flags'];\r\n  // }\r\n\r\n  let object = {};\r\n  if (!editableKeys) object = allData;\r\n  else {\r\n    for (const k of editableKeys) {\r\n      if (k in allData) {\r\n        object[k] = allData[k];\r\n      }\r\n    }\r\n  }\r\n\r\n  const pinned = documentName ? game.settings.get(MODULE_ID, 'pinnedFields')[documentName] || {} : {};\r\n\r\n  _constructControls(nav, object, tabSelectors, '', pinned, customControls, pins);\r\n\r\n  const pinned_groups = [];\r\n  const flatObject = foundry.utils.flattenObject(object);\r\n  for (const [k, v] of Object.entries(pinned)) {\r\n    const value = k in flatObject ? flatObject[k] : v.value;\r\n\r\n    let control = genControl(foundry.utils.getType(value), v.label, value, k, {}, true, customControls, pins);\r\n    control.pinned = true;\r\n    pinned_groups.push(control);\r\n  }\r\n  if (pinned_groups.length) {\r\n    // No tabs constructed means this is not a nested object, however since we have pinned fields\r\n    // we need to separate main object fields from the pinned ones\r\n    if (!nav.items.length) {\r\n      nav.items.push({ dataTab: 'main-me-main', label: 'Main' });\r\n      nav.tabs.push({ dataTab: 'main-me-main', groups: nav.groups });\r\n      delete nav.groups;\r\n    }\r\n\r\n    nav.items.unshift({\r\n      dataTab: 'me-pinned',\r\n      dataTab: 'me-pinned',\r\n      label: localize('generic-form.pinned'),\r\n    });\r\n    nav.tabs.unshift({ dataTab: 'me-pinned', groups: pinned_groups });\r\n  }\r\n\r\n  return [nav, tabSelectors];\r\n}\r\n\r\nfunction _constructControls(nav, data, tabSelectors, name, pinned, customControls, pins) {\r\n  const groups = [];\r\n  let containsNav = false;\r\n  for (const [k, v] of Object.entries(data)) {\r\n    const name2 = name ? name + '.' + k : k;\r\n    if (v !== null) {\r\n      let t = foundry.utils.getType(v);\r\n      let control;\r\n      if (t === 'Object') {\r\n        if (_hasNonNullKeys(v)) {\r\n          nav.items.push({ dataTab: name2, label: _genLabel(k) });\r\n          const newNav = { dataGroup: name2, items: [], tabs: [] };\r\n          nav.tabs.push({ dataTab: name2, nav: newNav });\r\n          tabSelectors.push({\r\n            navSelector: `.tabs[data-group=\"${name2}\"]`,\r\n            contentSelector: `.tab[data-tab=\"${name2}\"]`,\r\n            initial: k + '-me-main',\r\n          });\r\n          _constructControls(newNav, v, tabSelectors, name2, pinned, customControls, pins);\r\n          containsNav = true;\r\n        }\r\n      } else {\r\n        control = genControl(t, _genLabel(k), v, name2, pinned, false, customControls, pins);\r\n      }\r\n      if (control) {\r\n        groups.push(control);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (groups.length) {\r\n    if (containsNav) {\r\n      nav.items.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        label: 'Main',\r\n      });\r\n      nav.tabs.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        groups,\r\n      });\r\n    } else {\r\n      nav.groups = groups;\r\n    }\r\n  }\r\n}\r\n\r\nfunction _hasNonNullKeys(obj) {\r\n  if (foundry.utils.isEmpty(obj)) return false;\r\n  for (const [k, v] of Object.entries(obj)) {\r\n    if (foundry.utils.getType(v) === 'Object') {\r\n      if (_hasNonNullKeys(v)) return true;\r\n    } else if (v != null) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction _genLabel(key) {\r\n  if (key.length <= 3) return key.toUpperCase();\r\n  return key.charAt(0).toUpperCase() + key.slice(1);\r\n}\r\n\r\nconst IMAGE_FIELDS = ['img', 'image', 'src', 'texture'];\r\nconst COLOR_FIELDS = ['tint'];\r\n\r\nexport function isColorField(name) {\r\n  name = name.split('.').pop();\r\n  return COLOR_FIELDS.includes(name) || name.toLowerCase().includes('color');\r\n}\r\n\r\nfunction genControl(type, label, value, name, pinned, editableLabel = false, customControls = {}, pins) {\r\n  const allowedArrayElTypes = ['number', 'string'];\r\n\r\n  let control = { label: label, value, name, editableLabel, pins };\r\n  if (getProperty(customControls, name)) {\r\n    control = foundry.utils.mergeObject(control, getProperty(customControls, name));\r\n  } else if (type === 'number') {\r\n    control.number = true;\r\n    const varName = name.split('.').pop();\r\n    if (isColorField(varName)) {\r\n      control.colorPickerNumber = true;\r\n      try {\r\n        control.colorValue = new Color(value).toString();\r\n      } catch (e) {}\r\n    }\r\n  } else if (type === 'string') {\r\n    control.text = true;\r\n    const varName = name.split('.').pop();\r\n    if (\r\n      IMAGE_FIELDS.includes(varName) ||\r\n      varName.toLowerCase().includes('image') ||\r\n      varName.toLowerCase().includes('path')\r\n    )\r\n      control.filePicker = true;\r\n    else if (isColorField(varName)) control.colorPicker = true;\r\n  } else if (type === 'boolean') {\r\n    control.boolean = true;\r\n  } else if (type === 'Array' && value.every((el) => allowedArrayElTypes.includes(foundry.utils.getType(el)))) {\r\n    control.value = value.join(', ');\r\n    control.array = true;\r\n  } else if (type === 'Array') {\r\n    control.jsonArray = true;\r\n    control.value = JSON.stringify(value, null, 2);\r\n  } else {\r\n    control.disabled = true;\r\n    control.text = true;\r\n    control.editableLabel = false;\r\n  }\r\n  if (control && name in pinned) {\r\n    control.pinned = true;\r\n    control.disabled = true;\r\n    control.name = null;\r\n  }\r\n  return control;\r\n}\r\n","import { showPlaceableTypeSelectDialog } from '../scripts/dialogs.js';\r\nimport { PresetAPI } from '../scripts/presets/collection.js';\r\nimport { getData, getDocumentName, MODULE_ID, SUPPORT_SHEET_CONFIGS, SUPPORTED_COLLECTIONS } from '../scripts/utils.js';\r\nimport { getClipboardData, pasteDataUpdate, WithMassConfig } from './forms.js';\r\nimport { MassEditGenericForm } from './generic/genericForm.js';\r\n\r\nexport const LAYER_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lighting',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\nexport const SCENE_DOC_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lights',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\n// Retrieve currently controlled placeables\r\nexport function getControlled() {\r\n  if (canvas.activeLayer.controlled.length) {\r\n    return canvas.activeLayer.controlled;\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve hovered over placeable\r\nfunction getHover() {\r\n  let docName = canvas.activeLayer.constructor.documentName;\r\n  // Walls do not properly cleanup hover state\r\n  if (!['Wall'].includes(docName)) {\r\n    if (canvas.activeLayer.hover) {\r\n      return [canvas.activeLayer.hover];\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve documents selected using Multiple Document Selection module (https://github.com/ironmonk88/multiple-document-selection)\r\nfunction getSelectedDocuments(placeableSelect) {\r\n  const supportedDocs = [\r\n    { name: 'Actor', class: 'actor' },\r\n    { name: 'Scene', class: 'scene' },\r\n    { name: 'JournalEntry', class: 'journalentry' },\r\n    { name: 'Playlist', class: 'sound' },\r\n    { name: 'Item', class: 'item' },\r\n    { name: 'RollTable', class: 'rolltable' },\r\n    { name: 'Cards', class: 'cards' },\r\n  ];\r\n  for (const doc of supportedDocs) {\r\n    const selected = [];\r\n    $(`.directory-list .${doc.class}.selected`).each(function (_) {\r\n      let d;\r\n      if (doc.name === 'Playlist') {\r\n        d = game.collections.get(doc.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n      } else {\r\n        d = game.collections.get(doc.name).get(this.dataset.documentId);\r\n      }\r\n\r\n      if (d) {\r\n        // JournalEntries themselves do not have configs, but notes that they correspond to on the scene do\r\n        if (placeableSelect && doc.name === 'JournalEntry') {\r\n          game.collections.get('Scene').forEach((s) =>\r\n            s.notes.forEach((n) => {\r\n              const eid = n.entryId ?? n.data.entryId;\r\n              if (d.id === eid) {\r\n                selected.push(n);\r\n              }\r\n            })\r\n          );\r\n          // canvas.notes.placeables\r\n          //   .filter((n) => d.id === (n.entryId ?? n.data.entryId))\r\n          //   .forEach((n) => selected.push(n));\r\n        } else {\r\n          if (d) selected.push(d);\r\n        }\r\n      }\r\n    });\r\n    if (selected.length) {\r\n      return selected;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function getSelected(base, placeable = true) {\r\n  let selected;\r\n  if (base) {\r\n    if (Array.isArray(base)) selected = base;\r\n    else selected = [base];\r\n  }\r\n  if (!selected) selected = getSelectedDocuments(placeable);\r\n  if (!selected) selected = getControlled();\r\n\r\n  // Sort placeable on the scene using their (x, y) coordinates\r\n  if (selected && selected.length > 1 && selected[0].x != null && selected[0].y != null) {\r\n    selected.sort((p1, p2) => {\r\n      const c = p1.y - p2.y;\r\n      if (c === 0) {\r\n        return p1.x - p2.x;\r\n      }\r\n      return c;\r\n    });\r\n  }\r\n\r\n  // We want one object to be treated as the target for the form\r\n  // Will prioritize hovered placeable for this purpose\r\n  let hover = getHover();\r\n  hover = hover ? hover[0] : hover;\r\n\r\n  if (!selected && hover) selected = [hover];\r\n  if (!hover && selected) hover = selected[0];\r\n\r\n  if (!hover && !selected) return [null, null];\r\n\r\n  if (hover && getDocumentName(hover) !== getDocumentName(selected[0])) {\r\n    hover = selected[0];\r\n  }\r\n\r\n  return [hover, selected];\r\n}\r\n\r\n// Show placeable search\r\nexport function showMassSelect(basePlaceable) {\r\n  let [target, selected] = getSelected(basePlaceable);\r\n\r\n  if (!target) {\r\n    showPlaceableTypeSelectDialog();\r\n    return;\r\n  }\r\n\r\n  const docName = getDocumentName(target);\r\n\r\n  const options = {\r\n    commonData: foundry.utils.flattenObject(getData(target).toObject()),\r\n    massSelect: true,\r\n    documentName: docName,\r\n  };\r\n\r\n  if (SUPPORT_SHEET_CONFIGS.includes(docName) && docName !== 'Actor') {\r\n    const MassConfig = WithMassConfig(docName);\r\n    new MassConfig(target, selected, options).render(true, {});\r\n  } else if (SUPPORTED_COLLECTIONS.includes(docName)) {\r\n    new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\n// show placeable edit\r\nexport async function showMassEdit(found = null, documentName, options = {}) {\r\n  let [target, selected] = getSelected(found);\r\n\r\n  // If there are no placeable in control or just one, then either exit or display the default config window\r\n  if (!selected || !selected.length) return;\r\n\r\n  if (!options.forceForm && game.settings.get(MODULE_ID, 'singleDocDefaultConfig')) {\r\n    if (selected.length === 1) {\r\n      if (selected[0].sheet) selected[0].sheet.render(true, {});\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Display modified config window\r\n  if (!documentName) documentName = getDocumentName(target);\r\n  options = { ...options, massEdit: true, documentName };\r\n  if (SUPPORT_SHEET_CONFIGS.includes(documentName)) {\r\n    if (documentName === 'Actor') {\r\n      target = target.prototypeToken;\r\n      selected = selected.map((s) => s.prototypeToken);\r\n      options.documentName = 'Token';\r\n    }\r\n    const MassConfig = WithMassConfig(options.documentName);\r\n    return new MassConfig(target, selected, options).render(true, {});\r\n  } else {\r\n    return new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\nexport function showMassActorForm(selectedTokens, options) {\r\n  const tokens = [];\r\n  const actors = [];\r\n  selectedTokens.forEach((s) => {\r\n    if (s.actor) {\r\n      tokens.push(s);\r\n      actors.push(s.actor);\r\n    }\r\n  });\r\n\r\n  if (actors.length) {\r\n    new MassEditGenericForm(actors, {\r\n      tokens,\r\n      documentName: 'Actor',\r\n      ...options,\r\n    }).render(true);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function pasteData() {\r\n  let selected;\r\n  if (!selected) selected = getSelectedDocuments();\r\n  if (!selected) selected = getControlled();\r\n  if (!selected) selected = getHover();\r\n\r\n  if (selected) return pasteDataUpdate(selected, null, false, true);\r\n  else {\r\n    let docName = canvas.activeLayer.constructor.documentName;\r\n    const preset = getClipboardData(docName);\r\n    if (preset) {\r\n      PresetAPI.spawnPreset({ preset });\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Displays a Generic Mass Edit form for the passed in data object/s\r\n * @param {Array|Object} data Object/s to be edited using the form\r\n * @param {String} name the name to be assigned internally to this data which will be used to manage presets and pins\r\n * @returns Promised resolved once the opened form is submitted\r\n */\r\nexport function showGenericForm(data, name = 'GenericData', options) {\r\n  return new Promise((resolve) => {\r\n    new MassEditGenericForm(Array.isArray(data) ? data : [data], {\r\n      documentName: name,\r\n      callback: () => resolve(),\r\n      ...options,\r\n    }).render(true);\r\n  });\r\n}\r\n","import { pasteDataUpdate } from '../applications/forms.js';\r\nimport { Picker } from './picker.js';\r\nimport { PresetAPI } from './presets/collection.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\nimport { MODULE_ID, TagInput } from './utils.js';\r\n\r\nexport class Brush {\r\n  static app;\r\n  static deactivateCallback;\r\n  static spawner;\r\n  static eraser;\r\n  static lastSpawnTime;\r\n  // @type {Preset}\r\n  static preset;\r\n  static brushOverlay;\r\n  static updatedPlaceables = new Map();\r\n  static hoveredPlaceables = new Set();\r\n  static spawnPoints = [];\r\n  static hoveredPlaceable;\r\n  static documentName;\r\n  static active = false;\r\n  static hitTest;\r\n\r\n  static registered3dListener = false;\r\n  // Trick to keep consistent signatures for bound 3d brush callbacks\r\n  // Required to be able to remove these function once the 3d brush is deactivated\r\n  static {\r\n    this._boundOn3DBrushClick = this._on3DBrushClick.bind(this);\r\n    this._boundOn3dMouseMove = this._on3dMouseMove.bind(this);\r\n  }\r\n\r\n  static _checkDensity(pos) {\r\n    const d = canvas.grid.size * this.spawnDensity;\r\n    return this.spawnPoints.every((p) => Math.sqrt((p.x - pos.x) ** 2 + (p.y - pos.y) ** 2) >= d);\r\n  }\r\n\r\n  static _performBrushDocumentUpdate(placeable) {\r\n    this.preset.callPostSpawnHooks({ objects: [placeable], documents: [placeable.document] });\r\n    if (!this.preset.isEmpty) pasteDataUpdate([placeable], this.preset, true, true, this.transform);\r\n    this.updatedPlaceables.set(placeable.id, placeable);\r\n    BrushMenu.iterate();\r\n  }\r\n\r\n  static _performBrushDocumentCreate(pos) {\r\n    const now = new Date().getTime();\r\n    if (!this.lastSpawnTime || now - this.lastSpawnTime > 100) {\r\n      this.lastSpawnTime = now;\r\n      if (pos.z == null) {\r\n        if (!this._checkDensity(pos)) return;\r\n        Picker.resolve(pos);\r\n        this.spawnPoints.push(pos);\r\n      } else {\r\n        PresetAPI.spawnPreset({\r\n          preset: this.preset,\r\n          ...pos,\r\n          center: true,\r\n          snapToGrid: this.snap,\r\n          scaleToGrid: this.scaleToGrid,\r\n        });\r\n      }\r\n      BrushMenu.iterate();\r\n    }\r\n  }\r\n\r\n  static _performBrushDocumentDelete(placeable) {\r\n    this.hoveredPlaceable = null;\r\n    if (!placeable._brushDelete) placeable.document?.delete();\r\n    placeable._brushDelete = true;\r\n  }\r\n\r\n  static _hitTestWall(point, wall) {\r\n    return wall.line.hitArea.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hitTestControlIcon(point, placeable) {\r\n    return (\r\n      Number.between(\r\n        point.x,\r\n        placeable.x - placeable.controlIcon.width / 2,\r\n        placeable.x + placeable.controlIcon.width / 2\r\n      ) &&\r\n      Number.between(\r\n        point.y,\r\n        placeable.y - placeable.controlIcon.height / 2,\r\n        placeable.y + placeable.controlIcon.height / 2\r\n      )\r\n    );\r\n  }\r\n\r\n  static _hitTestTile(point, placeable) {\r\n    const foreground = ui.controls.control.foreground ?? false;\r\n    if (placeable.document.overhead !== foreground) return false;\r\n    return this._hitTestArea(point, placeable);\r\n  }\r\n\r\n  static _hoverTestArea(placeable) {\r\n    return (\r\n      this.hoveredPlaceable &&\r\n      this.hoveredPlaceable.hitArea.width * this.hoveredPlaceable.hitArea.height >\r\n        placeable.hitArea.width * placeable.hitArea.height\r\n    );\r\n  }\r\n\r\n  static _hitTestArea(point, placeable) {\r\n    return (\r\n      Number.between(point.x, placeable.x, placeable.x + placeable.hitArea.width) &&\r\n      Number.between(point.y, placeable.y, placeable.y + placeable.hitArea.height)\r\n    );\r\n  }\r\n\r\n  static _onBrushMove(event) {\r\n    const pos = event.data.getLocalPosition(this.brushOverlay);\r\n    const layer = canvas.getLayerByEmbeddedName(this.documentName);\r\n    this._clearHover(event, pos);\r\n\r\n    for (const p of layer.placeables) {\r\n      if (p.visible && this.hitTest(pos, p) && !this.updatedPlaceables.has(p.id) && this.hoveredPlaceable !== p) {\r\n        if (this.hoverTest?.(p)) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoverTest && this.hoveredPlaceable && this.hoveredPlaceable !== p) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoveredPlaceable) {\r\n          this.hoveredPlaceable = p;\r\n        }\r\n\r\n        this.hoveredPlaceable._onHoverIn(event);\r\n      }\r\n    }\r\n  }\r\n\r\n  static _clearHover(event, pos, force = false) {\r\n    if (this.hoveredPlaceable) {\r\n      if (force || !this.hoveredPlaceable.visible || !this.hitTest(pos, this.hoveredPlaceable)) {\r\n        this.hoveredPlaceable._onHoverOut(event);\r\n        this.hoveredPlaceable = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  static _onBrushClickMove(event) {\r\n    if (this.spawner) {\r\n      this._performBrushDocumentCreate(event.data.getLocalPosition(this.brushOverlay));\r\n    } else if (\r\n      this.hoveredPlaceable &&\r\n      this.hoveredPlaceable.visible &&\r\n      !this.updatedPlaceables.has(this.hoveredPlaceable.id)\r\n    ) {\r\n      if (this.eraser) this._performBrushDocumentDelete(this.hoveredPlaceable);\r\n      else this._performBrushDocumentUpdate(this.hoveredPlaceable);\r\n    }\r\n  }\r\n\r\n  static _on3DBrushClick(event) {\r\n    if (this.brush3d) {\r\n      if (this.spawner) {\r\n        if (this.brush3d?.position) {\r\n          const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.brush3d.position);\r\n          this._performBrushDocumentCreate({ x: posVec.x, y: posVec.y, z: posVec.z });\r\n        }\r\n      } else {\r\n        const p = game.Levels3DPreview.interactionManager.currentHover?.placeable;\r\n        if (p && p.document.documentName === this.documentName) {\r\n          game.Levels3DPreview.interactionManager._downCameraPosition.set(0, 0, 0);\r\n          if (this.eraser) this._performBrushDocumentDelete(p);\r\n          else this._performBrushDocumentUpdate(p);\r\n        }\r\n        this.updatedPlaceables.clear();\r\n      }\r\n    }\r\n  }\r\n\r\n  static refreshPreset() {\r\n    if (this.active && this.app) {\r\n      this.preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: this.app.getSelectedFields(),\r\n        randomize: this.app.randomizeFields,\r\n        addSubtract: this.app.addSubtractFields,\r\n      });\r\n    }\r\n  }\r\n\r\n  static async genPreview() {\r\n    // TODO: 3D Preview\r\n    if (!game.Levels3DPreview?._active)\r\n      PresetAPI.spawnPreset({\r\n        preset: this.preset,\r\n        coordPicker: true,\r\n        previewOnly: true,\r\n        center: true,\r\n        taPreview: 'ALL',\r\n        transform: this.transform,\r\n        snapToGrid: this.snap,\r\n        scaleToGrid: this.scaleToGrid,\r\n      });\r\n  }\r\n\r\n  /**\r\n   * @param {Object} options\r\n   * @param {MassEditForm} options.app\r\n   * @param {Preset} options.preset\r\n   * @returns\r\n   */\r\n  static activate({\r\n    app = null,\r\n    preset = null,\r\n    deactivateCallback = null,\r\n    spawner = false,\r\n    spawnDensity = 0.01,\r\n    eraser = false,\r\n    refresh = false,\r\n    transform = {},\r\n    snap = true,\r\n    scaleToGrid = true,\r\n  } = {}) {\r\n    this.deactivate(refresh);\r\n    if (!canvas.ready) return false;\r\n    if (!app && !preset) return false;\r\n\r\n    if (this.brushOverlay) {\r\n      this.brushOverlay.destroy(true);\r\n    }\r\n\r\n    // Setup fields to be used for updates\r\n    this.app = app;\r\n    this.preset = preset;\r\n    this.transform = transform;\r\n    this.deactivateCallback = deactivateCallback;\r\n    this.spawner = spawner;\r\n    this.eraser = eraser;\r\n    this.snap = snap;\r\n    this.spawnDensity = spawnDensity;\r\n    this.scaleToGrid = scaleToGrid;\r\n    if (this.app) {\r\n      this.documentName = this.app.documentName;\r\n    } else {\r\n      this.documentName = this.preset.documentName;\r\n    }\r\n    if (!refresh) {\r\n      this.updatedPlaceables.clear();\r\n      this.spawnPoints = [];\r\n    }\r\n\r\n    const interaction = canvas.app.renderer.events;\r\n    if (!interaction.cursorStyles['brush']) {\r\n      interaction.cursorStyles['brush'] = `url('modules/${MODULE_ID}/images/brush_icon.png'), auto`;\r\n      interaction.cursorStyles['brush_spawn'] = `url('modules/${MODULE_ID}/images/brush_icon_spawn.png'), auto`;\r\n      interaction.cursorStyles['eraser'] = `url('modules/${MODULE_ID}/images/brush_icon_eraser.png'), auto`;\r\n    }\r\n\r\n    this.active = true;\r\n    this.refreshPreset();\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      return this._activate3d();\r\n    }\r\n\r\n    // Determine hit test test function to be used for pointer hover detection\r\n    if (this.spawner) {\r\n      this.hitTest = () => false;\r\n      this.genPreview();\r\n    } else {\r\n      switch (this.documentName) {\r\n        case 'Wall':\r\n          this.hitTest = this._hitTestWall;\r\n          break;\r\n        case 'AmbientLight':\r\n        case 'MeasuredTemplate':\r\n        case 'AmbientSound':\r\n        case 'Note':\r\n          this.hitTest = this._hitTestControlIcon;\r\n          break;\r\n        case 'Tile':\r\n          this.hitTest = this._hitTestTile;\r\n          this.hoverTest = this._hoverTestArea;\r\n          break;\r\n        default:\r\n          this.hitTest = this._hitTestArea;\r\n          this.hoverTest = this._hoverTestArea;\r\n      }\r\n    }\r\n\r\n    // Create the brush overlay\r\n    this.brushOverlay = new PIXI.Container();\r\n    this.brushOverlay.hitArea = canvas.dimensions.rect;\r\n\r\n    let cursor = 'brush';\r\n    if (spawner) cursor = 'brush_spawn';\r\n    else if (eraser) cursor = 'eraser';\r\n    this.brushOverlay.cursor = cursor;\r\n\r\n    this.brushOverlay.interactive = true;\r\n    this.brushOverlay.zIndex = Infinity;\r\n\r\n    this.brushOverlay.on('mousemove', (event) => {\r\n      Picker.feedPos(event.data.getLocalPosition(this.brushOverlay));\r\n      this._onBrushMove(event);\r\n      if (!this.mDownWithinCanvas) return; // Fix to prevent mouse interaction within apps\r\n      if (event.buttons === 1) this._onBrushClickMove(event);\r\n    });\r\n    this.brushOverlay.on('mouseup', (event) => {\r\n      this.mDownWithinCanvas = false; // Fix to prevent mouse interaction within apps\r\n      if (event.nativeEvent.which !== 2) {\r\n        this._onBrushClickMove(event);\r\n      }\r\n      this.updatedPlaceables.clear();\r\n      this.spawnPoints = [];\r\n    });\r\n\r\n    this.brushOverlay.on('mousedown', (event) => {\r\n      this.mDownWithinCanvas = true; // Fix to prevent mouse interaction within apps\r\n    });\r\n\r\n    this.brushOverlay.on('click', (event) => {\r\n      if (event.nativeEvent.which == 2) {\r\n        this.deactivate();\r\n      }\r\n    });\r\n\r\n    canvas.stage.addChild(this.brushOverlay);\r\n\r\n    // Disable canvas events to prevent selects and object placements on click\r\n    canvas.mouseInteractionManager.permissions.clickLeft = false;\r\n    // canvas.mouseInteractionManager.permissions.longPress = false;\r\n\r\n    return true;\r\n  }\r\n\r\n  static brush3dDelayMoveTimer;\r\n\r\n  static _on3dMouseMove() {\r\n    if (!this.brush3d || this.brush3dDelayMoveTimer) return;\r\n\r\n    const brush = this;\r\n    this.brush3dDelayMoveTimer = setTimeout(function () {\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      const cPos = game.Levels3DPreview.interactionManager.camera.position;\r\n\r\n      const intersects = game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(\r\n        cPos,\r\n        mPos,\r\n        'collision',\r\n        false,\r\n        false,\r\n        false,\r\n        true\r\n      );\r\n\r\n      if (intersects[0]) {\r\n        const intersect = intersects[0];\r\n        brush.brush3d.position.set(intersect.point.x, intersect.point.y, intersect.point.z);\r\n        // TODO: 3D Preview\r\n        // const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(brush.brush3d.position);\r\n        // Picker.feedPos({ x: posVec.x, y: posVec.y, z: posVec.z });\r\n      }\r\n      brush.brush3dDelayMoveTimer = null;\r\n    }, 100); // Will do the ajax stuff after 1000 ms, or 1 s\r\n  }\r\n\r\n  static deactivate3DListeners() {\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('click', this._boundOn3DBrushClick, false);\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n  }\r\n\r\n  static _activate3DListeners() {\r\n    // Remove listeners if they are already set\r\n    this.deactivate3DListeners();\r\n\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('click', this._boundOn3DBrushClick, false);\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n  }\r\n\r\n  static _activate3d() {\r\n    const THREE = game.Levels3DPreview.THREE;\r\n\r\n    if (!this.brush3d) {\r\n      this.brush3d = new THREE.Mesh(\r\n        new THREE.SphereGeometry(0.01, 8, 8),\r\n        new THREE.MeshBasicMaterial({\r\n          opacity: 0.5,\r\n          transparent: true,\r\n          color: 0x00ff00,\r\n          wireframe: true,\r\n        })\r\n      );\r\n\r\n      this.brush3d.userData.interactive = false;\r\n      this.brush3d.userData.ignoreHover = true;\r\n\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      this.brush3d.position.set(mPos.x, mPos.y, mPos.z);\r\n\r\n      game.Levels3DPreview.scene.add(this.brush3d);\r\n      if (this.spawner) this.genPreview();\r\n    }\r\n\r\n    // Activate listeners\r\n    this._activate3DListeners();\r\n\r\n    return true;\r\n  }\r\n\r\n  static deactivate(refresh = false) {\r\n    if (this.active) {\r\n      canvas.mouseInteractionManager.permissions.clickLeft = true;\r\n      //canvas.mouseInteractionManager.permissions.longPress = true;\r\n      if (this.brushOverlay) this.brushOverlay.parent?.removeChild(this.brushOverlay);\r\n      if (this.brush3d && game.Levels3DPreview?._active) {\r\n        game.Levels3DPreview.scene.remove(this.brush3d);\r\n        this.brush3d = null;\r\n        this.deactivate3DListeners();\r\n      }\r\n      this.active = false;\r\n\r\n      if (!refresh) {\r\n        this.updatedPlaceables.clear();\r\n        this.spawnPoints = [];\r\n        this._clearHover(null, null, true);\r\n      }\r\n      this.hoverTest = null;\r\n      if (!refresh) this.deactivateCallback?.();\r\n      if (this.spawner) Picker.destroy();\r\n      this.spawner = false;\r\n      this.eraser = false;\r\n      this.deactivateCallback = null;\r\n      this.app = null;\r\n      this.preset = null;\r\n      this.transform = null;\r\n      return true;\r\n    }\r\n  }\r\n}\r\n\r\n// =================================================\r\n\r\nexport class BrushMenu extends FormApplication {\r\n  static addPresets(presets = []) {\r\n    if (!this._instance) return this.render(presets);\r\n    else this._instance.addPresets(presets);\r\n  }\r\n\r\n  static isActive() {\r\n    return Boolean(this._instance);\r\n  }\r\n\r\n  static removePreset(id) {\r\n    if (!this._instance) return;\r\n    this._instance.removePreset(id);\r\n  }\r\n\r\n  static iterate(forward = true) {\r\n    if (!this._instance) return;\r\n    this._instance.iterate(forward);\r\n  }\r\n\r\n  static render(presets, settings = {}) {\r\n    if (this._instance) this.addPresets(presets);\r\n    else {\r\n      this._instance = new BrushMenu(presets, settings);\r\n      this._instance.render(true);\r\n    }\r\n  }\r\n\r\n  static async close() {\r\n    return this._instance?.close(true);\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-brush-menu',\r\n      template: `modules/${MODULE_ID}/templates/preset/brush/menu.html`,\r\n      classes: ['mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      resizable: false,\r\n      minimizable: false,\r\n      width: 200,\r\n      height: 'auto',\r\n      scrollY: ['.presets'],\r\n    });\r\n  }\r\n\r\n  constructor(presets, settings = {}) {\r\n    super({}, { left: 10, top: window.innerHeight / 2 });\r\n    this.presets = presets ?? [];\r\n    this.preset = this.presets[0].clone();\r\n    this.preset.data = this.preset.data[0];\r\n    this._settings = foundry.utils.mergeObject(game.settings.get(MODULE_ID, 'brush'), settings);\r\n    this._it = -1;\r\n    this._createIndex();\r\n    this.iterate();\r\n  }\r\n\r\n  _createIndex() {\r\n    const index = [];\r\n\r\n    if (this._settings.group) {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        index.push({ pI });\r\n      }\r\n    } else {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        const preset = this.presets[pI];\r\n        for (let dI = 0; dI < preset.data.length; dI++) {\r\n          index.push({ pI, dI });\r\n        }\r\n      }\r\n    }\r\n    this._index = index;\r\n    if (this._it >= this._index.length) this._it = this._index.length - 1;\r\n  }\r\n\r\n  async _activateBrush(refresh = true) {\r\n    const index = this._index[this._it];\r\n    const p = this.presets[index.pI];\r\n    this.preset = p.clone();\r\n    if (index.hasOwnProperty('dI')) this.preset.data = [this.preset.data[index.dI]];\r\n\r\n    // Place tiles above others on the scene\r\n    if (this.preset.documentName === 'Tile' && canvas.tiles.placeables.length) {\r\n      const maxZ = Math.max(...canvas.tiles.placeables.map((p) => p.document.z));\r\n      this.preset.data.forEach((d) => {\r\n        d.z = maxZ;\r\n      });\r\n    }\r\n\r\n    // Apply Color\r\n    await this._applyColor();\r\n\r\n    // Apply TMFX Filters\r\n    this._applyTmfxPresets(this.preset, this._settings.tmfxPreset);\r\n\r\n    // Apply Tagger tags\r\n    this._applyTaggerTags(this.preset, this._settings.tagger);\r\n\r\n    Brush.activate({\r\n      preset: this.preset,\r\n      deactivateCallback: this._deactivateCallback.bind(this),\r\n      spawner: this._settings.spawner,\r\n      eraser: this._settings.eraser,\r\n      transform: this._getTransform(),\r\n      refresh,\r\n      snap: this._settings.snap,\r\n      scaleToGrid: this._settings.scaleToGrid,\r\n      spawnDensity: this._settings.density,\r\n    });\r\n  }\r\n\r\n  async _applyColor() {\r\n    if (this._settings.randomColor || this._settings.color) {\r\n      let pPath;\r\n      const docName = this.preset.documentName;\r\n      if (docName === 'Token' || docName === 'Tile') pPath = 'texture.tint';\r\n      else if (docName === 'AmbientLight') pPath = 'config.color';\r\n\r\n      if (pPath) {\r\n        if (this._settings.randomColor) {\r\n          const updates = this.preset.data.map(() => {\r\n            return { color: '' };\r\n          });\r\n          await applyRandomization(updates, null, { color: { type: 'color', ...this._settings.randomColor } });\r\n\r\n          this.preset.data.forEach((d, i) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, updates[i].color);\r\n            else foundry.utils.setProperty(d, pPath, updates[i].color);\r\n          });\r\n        } else {\r\n          this.preset.data.forEach((d) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, this._settings.color);\r\n            else foundry.utils.setProperty(d, pPath, this._settings.color);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  _applyDDTint(data, color) {\r\n    let filters = foundry.utils.getProperty(data, 'flags.tokenmagic.filters');\r\n\r\n    if (!color) {\r\n      if (filters) {\r\n        foundry.utils.setProperty(\r\n          data,\r\n          'flags.tokenmagic.filters',\r\n          filters.filter((f) => f.tmFilters.filterId !== 'DDTint')\r\n        );\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      foundry.utils.setProperty(data, 'flags.tokenmagic.filters', filters);\r\n    }\r\n  }\r\n\r\n  _applyTaggerTags(preset, tags) {\r\n    if (!tags || !tags.length) return;\r\n    if (!game.modules.get('tagger')?.active) return;\r\n\r\n    preset.addPostSpawnHook(({ objects } = {}) => {\r\n      Tagger.addTags(objects, tags);\r\n    });\r\n  }\r\n\r\n  _applyTmfxPresets(preset, tmfxPreset) {\r\n    if (!tmfxPreset) return;\r\n    if (!game.modules.get('tokenmagic')?.active) return;\r\n    if (!['Token', 'Tile', 'Drawing', 'MeasuredTemplate'].includes(preset.documentName)) return;\r\n\r\n    if (!Array.isArray(tmfxPreset)) tmfxPreset = [tmfxPreset];\r\n\r\n    if (tmfxPreset.includes('DELETE ALL')) {\r\n      this.preset.addPostSpawnHook(({ objects } = {}) => objects.forEach((o) => TokenMagic.deleteFilters(o)));\r\n      return;\r\n    } else if (tmfxPreset.includes('DELETE')) {\r\n      this.preset.addPostSpawnHook(({ objects } = {}) =>\r\n        objects.forEach(async (o) => {\r\n          for (const p of tmfxPreset) await TokenMagic.deleteFilters(o, p);\r\n        })\r\n      );\r\n      return;\r\n    }\r\n\r\n    const filters = [];\r\n    tmfxPreset.forEach((presetName) => TokenMagic.getPreset(presetName)?.forEach((filter) => filters.push(filter)));\r\n\r\n    if (filters.length)\r\n      this.preset.addPostSpawnHook(({ objects } = {}) =>\r\n        objects.forEach((o) => TokenMagic.addUpdateFilters(o, filters))\r\n      );\r\n  }\r\n\r\n  get title() {\r\n    return 'Brush';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    return {\r\n      presets: this.presets,\r\n      activePreset: this.preset,\r\n      ...this._settings,\r\n      tmfxActive: game.modules.get('tokenmagic')?.active,\r\n      taggerActive: game.modules.get('tagger')?.active,\r\n    };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const settings = this._settings;\r\n    const app = this;\r\n\r\n    import('./jquery-ui/jquery-ui.js').then((module) => {\r\n      const rotationRangeLabel = html.find('.rotation-range-label');\r\n      html.find('.rotation-slider').slider({\r\n        range: true,\r\n        min: -180,\r\n        max: 180,\r\n        values: settings.rotation,\r\n        slide: function (event, ui) {\r\n          rotationRangeLabel.text(`${ui.values[0]}° - ${ui.values[1]}°`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ rotation: ui.values });\r\n        },\r\n      });\r\n\r\n      const scaleRangeLabel = html.find('.scale-range-label');\r\n      html.find('.scale-slider').slider({\r\n        range: true,\r\n        min: 0.1,\r\n        max: 4,\r\n        step: 0.01,\r\n        values: settings.scale,\r\n        slide: function (event, ui) {\r\n          scaleRangeLabel.text(`${ui.values[0]} - ${ui.values[1]}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ scale: ui.values });\r\n        },\r\n      });\r\n\r\n      const densityRangeLabel = html.find('.density-range-label');\r\n      html.find('.density-slider').slider({\r\n        range: false,\r\n        min: 0.01,\r\n        max: 4,\r\n        step: 0.01,\r\n        value: settings.density ?? 0.01,\r\n        slide: function (event, ui) {\r\n          densityRangeLabel.text(`${ui.value}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ density: ui.value });\r\n        },\r\n      });\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.on('click', '.toggle-button', this._toggleSetting.bind(this));\r\n    html.find('.reset').on('click', this._resetToDefaults.bind(this));\r\n    html.on('click', '.preset', this._onClickPreset.bind(this));\r\n    html.on('contextmenu', '.preset', this._onRightClickPreset.bind(this));\r\n\r\n    // Colorize\r\n    html.on('click', '.randomize-color', this._onRandomizeColor.bind(this));\r\n    html.on('change', 'input[type=\"color\"]', this._onColorChange.bind(this));\r\n    html.on('input paste', '.color', this._onColorChange.bind(this));\r\n    html.find('.colorizeControl').on('click', this._onColorMenu.bind(this));\r\n\r\n    html.find('.tmfxPresetControl').on('click', () => {\r\n      this._onEditTaglikeField({\r\n        label: 'TMFX',\r\n        name: 'tmfxPreset',\r\n        tags: this._settings.tmfxPreset,\r\n        simplifyTags: false,\r\n        listId: 'tmfxPresets',\r\n        listEntries: TokenMagic.getPresets().map((p) => p.name),\r\n      });\r\n    });\r\n    html.find('.taggerControl').on('click', () => {\r\n      this._onEditTaglikeField({\r\n        label: 'Tagger',\r\n        name: 'tagger',\r\n        tags: this._settings.tagger,\r\n        simplifyTags: false,\r\n      });\r\n    });\r\n  }\r\n\r\n  async _onEditTaglikeField({ label, name, tags, simplifyTags = true, listId, listEntries } = {}) {\r\n    const subMenu = this._toggleSubMenu(name);\r\n    if (!subMenu) return;\r\n\r\n    if (tags && !Array.isArray(tags)) tags = [tags];\r\n    const template = Handlebars.compile(\r\n      `{{tagInput name=name label=label tags=tags listId=listId listEntries=listEntries}}`\r\n    );\r\n    let content = template(\r\n      { name, label, tags, listId, listEntries },\r\n      {\r\n        allowProtoMethodsByDefault: true,\r\n        allowProtoPropertiesByDefault: true,\r\n      }\r\n    );\r\n\r\n    subMenu.html(content);\r\n    this.setPosition({ height: 'auto' });\r\n\r\n    TagInput.activateListeners(subMenu, {\r\n      change: (tags) => {\r\n        this.setPosition({ height: 'auto' });\r\n        this._updateBrushSettings({ [name]: tags.length ? tags : null });\r\n      },\r\n      simplifyTags,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Controls toggling of the sub-menu div container. The div is shared between many different controls, and behaviour\r\n   * depends on whether the same or different controls are being toggled\r\n   * @param {String} name a name of the control issuing a toggle\r\n   * @returns {Boolean} sub-menu element if sub-menu is to be rendered, null if sub-menu was emptied\r\n   */\r\n  _toggleSubMenu(name) {\r\n    const subMenu = this.element.find('.sub-menu');\r\n    if (subMenu.attr('data-control') === name) {\r\n      subMenu.html('').attr('data-control', null);\r\n      this.setPosition({ height: 'auto' });\r\n      return null;\r\n    } else subMenu.attr('data-control', name);\r\n    return subMenu;\r\n  }\r\n\r\n  async _onColorMenu(event) {\r\n    const subMenu = this._toggleSubMenu('colorize');\r\n    if (!subMenu) return;\r\n\r\n    const template = await getTemplate(`modules/${MODULE_ID}/templates/preset/brush/colorize.html`);\r\n    let content = template(await this.getData({}), {\r\n      allowProtoMethodsByDefault: true,\r\n      allowProtoPropertiesByDefault: true,\r\n    });\r\n\r\n    subMenu.html(content);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  async _onColorChange(event) {\r\n    let cString = $(event.currentTarget).val();\r\n    if (!cString) this._updateBrushSettings({ color: '' });\r\n    else {\r\n      let color = Color.fromString(cString);\r\n      if (!Number.isNaN(color.valueOf())) this._updateBrushSettings({ color: cString });\r\n    }\r\n  }\r\n\r\n  async _onClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    if (presetIndex != null) {\r\n      this._it = this._index.findIndex((i) => i.pI === presetIndex);\r\n      await this._activateBrush();\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRandomizeColor() {\r\n    const randomColor = this._settings.randomColor ?? {};\r\n    const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n      method: 'random',\r\n      lockMethod: true,\r\n      space: randomColor.space,\r\n      hue: randomColor.hue,\r\n    });\r\n\r\n    let colorSlider;\r\n    let dialog = new Dialog({\r\n      title: `Pick Range`,\r\n      content: `<form>${colorTemp}</form>`,\r\n      buttons: {\r\n        save: {\r\n          label: 'Apply',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: {\r\n                method: 'random',\r\n                space: html.find('[name=\"space\"]').val(),\r\n                hue: html.find('[name=\"hue\"]').val(),\r\n                colors: colorSlider.getColors(),\r\n              },\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n        remove: {\r\n          label: 'Remove',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: null,\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n      },\r\n      render: (html) => {\r\n        import('./randomizer/slider.js').then((module) => {\r\n          colorSlider = new module.ColorSlider(\r\n            html,\r\n            randomColor.colors ?? [\r\n              { hex: '#ff0000', offset: 0 },\r\n              { hex: '#ff0000', offset: 100 },\r\n            ]\r\n          );\r\n          setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n        });\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async _onRightClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    const preset = this.presets[presetIndex];\r\n    if (preset) this.removePreset(preset.id);\r\n  }\r\n\r\n  async _resetToDefaults() {\r\n    await this._updateBrushSettings({\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      density: 1,\r\n      color: null,\r\n      randomColor: null,\r\n      tmfxPreset: null,\r\n      tagger: null,\r\n    });\r\n    this.render(true);\r\n  }\r\n\r\n  async _toggleSetting(event) {\r\n    const control = $(event.target).closest('.toggle-button');\r\n    const update = { [control.data('name')]: !control.hasClass('active') };\r\n\r\n    if (update.spawner) update.eraser = false;\r\n    if (update.eraser) update.spawner = false;\r\n\r\n    await this._updateBrushSettings(update);\r\n\r\n    if (update.random) await this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async _updateBrushSettings(update) {\r\n    foundry.utils.mergeObject(this._settings, update);\r\n    await game.settings.set(MODULE_ID, 'brush', this._settings);\r\n\r\n    if (update.hasOwnProperty('group')) this._createIndex();\r\n    await this._activateBrush();\r\n  }\r\n\r\n  addPresets(presets = []) {\r\n    for (const preset of presets) {\r\n      if (!this.presets.find((p) => p.uuid === preset.uuid)) this.presets.push(preset);\r\n    }\r\n    this._createIndex();\r\n    this.render(true);\r\n  }\r\n\r\n  removePreset(id) {\r\n    const presetIndex = this.presets.findIndex((p) => p.id === id);\r\n    if (presetIndex === -1) return;\r\n\r\n    const wasActivePreset = this._index[this._it]?.pI === presetIndex;\r\n\r\n    this.presets = this.presets.filter((p) => p.id !== id);\r\n    if (this.presets.length === 0) return this.close(true);\r\n\r\n    this._createIndex();\r\n\r\n    if (wasActivePreset) this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async iterate(forward = true) {\r\n    if (!this._settings.lock) {\r\n      if (this._settings.random) this._it = Math.floor(Math.random() * this._index.length);\r\n      else {\r\n        this._it += forward ? 1 : -1;\r\n        if (this._it < 0) this._it = this._index.length - 1;\r\n        else this._it %= this._index.length;\r\n      }\r\n    } else {\r\n      if (this._it === -1) this._it = 0;\r\n    }\r\n\r\n    await this._activateBrush();\r\n    this.render(true);\r\n  }\r\n\r\n  _getTransform() {\r\n    const settings = this._settings;\r\n    const transform = {};\r\n    if (settings.scale[0] === settings.scale[1]) transform.scale = settings.scale[0];\r\n    else {\r\n      const stepsInRange = (settings.scale[1] - settings.scale[0]) / 0.01;\r\n      transform.scale = Math.floor(Math.random() * stepsInRange) * 0.01 + settings.scale[0];\r\n    }\r\n\r\n    if (settings.rotation[0] === settings.rotation[1]) transform.rotation = settings.rotation[0];\r\n    else {\r\n      const stepsInRange = (settings.rotation[1] - settings.rotation[0] + 1) / 1;\r\n      transform.rotation = Math.floor(Math.random() * stepsInRange) * 1 + settings.rotation[0];\r\n    }\r\n    return transform;\r\n  }\r\n\r\n  _deactivateCallback() {\r\n    this.close(true);\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-brush-macro',\r\n      icon: 'fa-solid fa-code',\r\n      onclick: this._generateBrushMacro.bind(this),\r\n    });\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _generateBrushMacro() {\r\n    const genMacro = async function (command) {\r\n      const macro = await Macro.create({\r\n        name: 'Brush Macro',\r\n        type: 'script',\r\n        scope: 'global',\r\n        command,\r\n        img: `modules/${MODULE_ID}/images/brush_icon.png`,\r\n      });\r\n      macro.sheet.render(true);\r\n    };\r\n\r\n    const genUUIDS = function () {\r\n      const uuids = this.presets.map((p) => p.uuid).filter(Boolean);\r\n      if (!uuids.length) return;\r\n\r\n      const command = `MassEdit.openBrushMenu({ \r\n    uuid: ${JSON.stringify(uuids, null, 4)}\r\n  },\r\n  ${JSON.stringify(this._settings, null, 2)}\r\n  );`;\r\n      genMacro(command);\r\n    };\r\n\r\n    const genNames = function () {\r\n      const opts = this.presets.map((p) => {\r\n        return { name: p.name, type: p.documentName };\r\n      });\r\n\r\n      const command = `MassEdit.openBrushMenu(\r\n    ${JSON.stringify(opts, null, 4)}\r\n  ,\r\n  ${JSON.stringify(this._settings, null, 2)}\r\n  );`;\r\n      genMacro(command);\r\n    };\r\n\r\n    let dialog = new Dialog({\r\n      title: `Generate Macro`,\r\n      content: ``,\r\n      buttons: {\r\n        uuids: {\r\n          label: 'UUIDs',\r\n          callback: genUUIDS.bind(this),\r\n        },\r\n        name: {\r\n          label: 'Names',\r\n          callback: genNames.bind(this),\r\n        },\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    Brush.deactivate();\r\n    BrushMenu._instance = null;\r\n    Picker.destroy();\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\n/**\r\n * API method to activate the brush.\r\n * @param {Object} options See MassEdit.getPreset(...)\r\n * @param {String} mode update|spawn\r\n */\r\nexport async function activateBrush(options, mode = 'spawner') {\r\n  const preset = await PresetAPI.getPreset(options);\r\n  if (preset) {\r\n    Brush.activate({ preset, spawner: mode === 'spawner' });\r\n  }\r\n}\r\n\r\n/**\r\n * API method to de-activate the brush.\r\n */\r\nexport function deactivateBush() {\r\n  Brush.deactivate();\r\n}\r\n\r\n/**\r\n * Open Brush Menu using the provided presets\r\n * @param {Object} options See MassEdit.getPresets(...)\r\n * @param {Object} settings Brush Menu control settings\r\n */\r\nexport async function openBrushMenu(options, settings = {}) {\r\n  if (BrushMenu.isActive()) return BrushMenu.close();\r\n\r\n  let presets = [];\r\n\r\n  if (Array.isArray(options)) {\r\n    for (const opts of options) {\r\n      let preset = await PresetAPI.getPreset(opts);\r\n      if (preset) presets.push(preset);\r\n    }\r\n  } else {\r\n    presets = await PresetAPI.getPresets(options);\r\n  }\r\n\r\n  if (!presets?.length) return;\r\n  for (const preset of presets) await preset.load();\r\n  BrushMenu.render(presets, settings);\r\n}\r\n","import { LAYER_MAPPINGS, showMassSelect } from '../applications/multiConfig.js';\r\nimport { SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES, localFormat, localize } from './utils.js';\r\n\r\nexport function showPlaceableTypeSelectDialog() {\r\n  let content = '';\r\n  for (const config of SUPPORTED_PLACEABLES.concat(SUPPORTED_COLLECTIONS)) {\r\n    content += `<option value=\"${config}\">${config}</option>`;\r\n  }\r\n  content = `<label>${localize('dialog.search-document')}</label>\r\n    <select style=\"width: 100%;\" name=\"documentName\">${content}</select>`;\r\n\r\n  new Dialog({\r\n    title: 'Document SEARCH',\r\n    content: content,\r\n    buttons: {\r\n      select: {\r\n        icon: '<i class=\"fas fa-check\"></i>',\r\n        label: 'Select',\r\n        callback: (html) => {\r\n          const documentName = html.find(\"select[name='documentName']\").val();\r\n\r\n          let docs = [];\r\n          if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n            const layer = LAYER_MAPPINGS[documentName];\r\n            if (layer && canvas[layer].placeables.length) {\r\n              docs = canvas[layer].placeables;\r\n            }\r\n          } else {\r\n            docs = Array.from(game.collections.get(documentName));\r\n          }\r\n\r\n          if (docs.length) {\r\n            showMassSelect(docs[0]);\r\n          } else {\r\n            ui.notifications.warn(localFormat('dialog.document-not-found', { document: documentName }));\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport async function importPresetFromJSONDialog() {\r\n  const content = `\r\n  <div class=\"form-group\">\r\n      <label for=\"data\">${localize('FILES.SelectFile', false)} </label>\r\n      <input type=\"file\" name=\"data\">\r\n  </div>\r\n  `;\r\n\r\n  let dialog = new Promise((resolve, reject) => {\r\n    new Dialog(\r\n      {\r\n        title: localize('presets.import'),\r\n        content: content,\r\n        buttons: {\r\n          import: {\r\n            icon: '<i class=\"fas fa-file-import\"></i>',\r\n            label: localize('common.import'),\r\n            callback: async (html) => {\r\n              let presets;\r\n              readTextFromFile(html.find('[name=\"data\"]')[0].files[0]).then((json) => {\r\n                try {\r\n                  presets = JSON.parse(json);\r\n                } catch (e) {}\r\n                resolve(presets);\r\n              });\r\n            },\r\n          },\r\n          no: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: localize('Cancel', false),\r\n            callback: () => resolve(false),\r\n          },\r\n        },\r\n        default: 'no',\r\n      },\r\n      {\r\n        width: 400,\r\n      }\r\n    ).render(true);\r\n  });\r\n  return await dialog;\r\n}\r\n","import { getPresetDataCenterOffset } from './presets/utils.js';\r\nimport { SUPPORTED_PLACEABLES } from './utils.js';\r\n\r\n/**\r\n * Cross-hair and optional preview image/label that can be activated to allow the user to select\r\n * an area on the screen.\r\n */\r\nexport class Picker {\r\n  static pickerOverlay;\r\n  static boundStart;\r\n  static boundEnd;\r\n  static callback;\r\n\r\n  static isActive() {\r\n    return Boolean(this.pickerOverlay);\r\n  }\r\n\r\n  static addRotation(rotation) {\r\n    this._rotation += rotation;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static addScaling(scale) {\r\n    this._scale += scale;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  /**\r\n   * Activates the picker overlay.\r\n   * @param {Function} callback callback function with coordinates returned as starting and ending bounds of a rectangles\r\n   *                            { start: {x1, y1}, end: {x2, y2} }\r\n   * @param {Object}  preview\r\n   * @param {String}  preview.documentName (optional) preview placeables document name\r\n   * @param {Map[String,Array]}  preview.previewData    (req) preview placeables data\r\n   * @param {String}  preview.taPreview            (optional) Designates the preview placeable when spawning a `Token Attacher` prefab.\r\n   *                                                e.g. \"Tile\", \"Tile.1\", \"MeasuredTemplate.3\"\r\n   * @param {Boolean} preview.snap                  (optional) if true returned coordinates will be snapped to grid\r\n   * @param {String}  preview.label                  (optional) preview placeables document name\r\n   */\r\n  static async activate(callback, preview) {\r\n    this.destroy();\r\n\r\n    const pickerOverlay = new PIXI.Container();\r\n    this.callback = callback;\r\n\r\n    if (preview) {\r\n      let label;\r\n      if (preview.label) {\r\n        label = new PreciseText(preview.label, { ...CONFIG.canvasTextStyle, _fontSize: 24 });\r\n        label.anchor.set(0.5, 1);\r\n        pickerOverlay.addChild(label);\r\n      }\r\n\r\n      let { previews, layer, previewDocuments } = await this._genPreviews(preview);\r\n      this._rotation = preview.rotation ?? 0;\r\n      this._scale = preview.scale ?? 1;\r\n\r\n      // Position offset to center preview over the mouse\r\n      let offset;\r\n      if (preview.center) offset = getPresetDataCenterOffset(preview.previewData);\r\n      else offset = { x: 0, y: 0 };\r\n\r\n      const setPositions = function (pos) {\r\n        if (!pos) return;\r\n        if (preview.center) offset = getPresetDataCenterOffset(preview.previewData);\r\n        if (preview.snap && layer && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT))\r\n          pos = canvas.grid.getSnappedPosition(pos.x, pos.y, layer.gridPrecision);\r\n\r\n        // calculate transform\r\n        const fpX = previews[0].document.documentName === 'Wall' ? previews[0].document.c[0] : previews[0].document.x;\r\n        const fpY = previews[0].document.documentName === 'Wall' ? previews[0].document.c[1] : previews[0].document.y;\r\n        let transform = { x: pos.x - fpX - offset.x, y: pos.y - fpY - offset.y };\r\n        if (Picker._rotation != 0) {\r\n          transform.rotation = Picker._rotation;\r\n          Picker._rotation = 0;\r\n        }\r\n        if (Picker._scale != 1) {\r\n          transform.scale = Picker._scale;\r\n          Picker._scale = 1;\r\n        }\r\n\r\n        for (const preview of previews) {\r\n          const doc = preview.document;\r\n          DataTransform.apply(doc.documentName, preview._pData ?? doc, pos, transform, preview);\r\n\r\n          // TODO: 3D Preview\r\n          // if (preview._l3dPreview) {\r\n          //   try {\r\n          //     preview._l3dPreview.collision = false;\r\n          //     const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n          //     const cPos = game.Levels3DPreview.interactionManager.camera.position;\r\n\r\n          //     const intersects = game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(\r\n          //       cPos,\r\n          //       mPos,\r\n          //       'collision',\r\n          //       false,\r\n          //       false,\r\n          //       false,\r\n          //       true\r\n          //     );\r\n\r\n          //     if (intersects[0]) {\r\n          //       const mesh = preview._l3dPreview.mesh;\r\n          //       mesh.position.x = intersects[0].point.x;\r\n          //       mesh.position.y = intersects[0].point.y;\r\n          //       mesh.position.z = intersects[0].point.z;\r\n          //     }\r\n          //   } catch (e) {\r\n          //     console.log(e);\r\n          //   }\r\n          // }\r\n\r\n          // =====\r\n          // Hacks\r\n          // =====\r\n          preview.document.alpha = 0.4;\r\n          preview.renderFlags.set({ refresh: true });\r\n          preview.visible = true;\r\n\r\n          // Tile z order, to make sure previews are rendered on-top\r\n          if (!preview.z) preview.z = preview.document.z;\r\n          if (preview.z) preview.document.z = preview.z + 9999999;\r\n\r\n          if (preview.source) preview.updateSource();\r\n\r\n          if (preview.controlIcon && !preview.controlIcon._meVInsert) {\r\n            preview.controlIcon.alpha = 0.4;\r\n\r\n            // ControlIcon visibility is difficult to set and keep as true\r\n            // Lets hack it by defining a getter that always returns true\r\n            Object.defineProperty(preview.controlIcon, 'visible', {\r\n              get: function () {\r\n                return true;\r\n              },\r\n              set: function () {},\r\n            });\r\n            preview.controlIcon._meVInsert = true;\r\n          }\r\n          // End of Hacks\r\n        }\r\n\r\n        if (label) {\r\n          label.x = pos.x;\r\n          label.y = pos.y - 38;\r\n        }\r\n\r\n        pickerOverlay.previewDocuments = previewDocuments;\r\n\r\n        // Changing scaling offsets the center position\r\n        // Let's immediately reposition back to it\r\n        if (preview.center && transform.scale != null) {\r\n          setPositions(pos);\r\n        }\r\n      };\r\n\r\n      pickerOverlay.on('pointermove', (event) => {\r\n        setPositions(event.data.getLocalPosition(pickerOverlay));\r\n      });\r\n      setPositions(canvas.mousePosition);\r\n      setPositions(canvas.mousePosition);\r\n      pickerOverlay.setPositions = setPositions;\r\n    }\r\n\r\n    if (!preview?.previewOnly) {\r\n      pickerOverlay.hitArea = canvas.dimensions.rect;\r\n      pickerOverlay.cursor = 'crosshair';\r\n      pickerOverlay.interactive = true;\r\n      pickerOverlay.zIndex = 5;\r\n      pickerOverlay.on('remove', () => pickerOverlay.off('pick'));\r\n      pickerOverlay.on('mousedown', (event) => {\r\n        Picker.boundStart = event.data.getLocalPosition(pickerOverlay);\r\n      });\r\n      pickerOverlay.on('mouseup', (event) => {\r\n        Picker.boundEnd = event.data.getLocalPosition(pickerOverlay);\r\n      });\r\n      pickerOverlay.on('click', (event) => {\r\n        if (event.nativeEvent.which == 2) {\r\n          this.callback?.(null);\r\n        } else {\r\n          const minX = Math.min(this.boundStart.x, this.boundEnd.x);\r\n          const maxX = Math.max(this.boundStart.x, this.boundEnd.x);\r\n          const minY = Math.min(this.boundStart.y, this.boundEnd.y);\r\n          const maxY = Math.max(this.boundStart.y, this.boundEnd.y);\r\n          this.callback?.({ start: { x: minX, y: minY }, end: { x: maxX, y: maxY } });\r\n        }\r\n        this.destroy();\r\n      });\r\n\r\n      canvas.stage.addChild(pickerOverlay);\r\n    }\r\n    this.pickerOverlay = pickerOverlay;\r\n  }\r\n\r\n  static feedPos(pos) {\r\n    this.pickerOverlay?.setPositions?.(pos);\r\n  }\r\n\r\n  static resolve(pos) {\r\n    if (this.callback) {\r\n      if (pos == null) this.callback(null);\r\n      else this.callback?.({ start: { x: pos.x, y: pos.y, z: pos.z }, end: { x: pos.x, y: pos.y, z: pos.z } });\r\n    }\r\n    this.destroy();\r\n  }\r\n\r\n  static destroy() {\r\n    if (this.pickerOverlay) {\r\n      this.pickerOverlay.parent?.removeChild(this.pickerOverlay);\r\n      if (this.pickerOverlay.previewDocuments) {\r\n        this.pickerOverlay.previewDocuments.forEach((name) => {\r\n          const layer = canvas.getLayerByEmbeddedName(name);\r\n          if (layer) {\r\n            // TODO: 3D Preview\r\n            // if (game.Levels3DPreview?._active) {\r\n            //   layer.preview.children.forEach((c) => {\r\n            //     c._l3dPreview?.destroy();\r\n            //   });\r\n            // }\r\n            layer.clearPreviewContainer();\r\n          }\r\n        });\r\n      }\r\n\r\n      this.pickerOverlay.destroy(true);\r\n      this.pickerOverlay.children?.forEach((c) => c.destroy(true));\r\n      this.callback?.(null);\r\n      this.pickerOverlay = null;\r\n    }\r\n    this.callback = null;\r\n  }\r\n\r\n  // Modified Foundry _createPreview\r\n  // Does not throw warning if user lacks document create permissions\r\n  static async _createPreview(createData) {\r\n    const documentName = this.constructor.documentName;\r\n    const cls = getDocumentClass(documentName);\r\n    createData._id = foundry.utils.randomID(); // Needed to allow rendering of multiple previews at the same time\r\n    const document = new cls(createData, { parent: canvas.scene });\r\n\r\n    const object = new CONFIG[documentName].objectClass(document);\r\n    this.preview.addChild(object);\r\n    await object.draw();\r\n\r\n    // TODO: 3D Preview\r\n    // if (game.Levels3DPreview._active) {\r\n    //   if (documentName === 'Tile') {\r\n    //     game.Levels3DPreview.createTile(object);\r\n    //     object._l3dPreview = game.Levels3DPreview.tiles[object.id];\r\n    //     console.log(object._l3dPreview);\r\n    //   }\r\n    // }\r\n\r\n    return object;\r\n  }\r\n\r\n  static async _genPreviews(preview) {\r\n    if (!preview.previewData) return { previews: [] };\r\n\r\n    const previewDocuments = new Set();\r\n    const previews = [];\r\n    const transform = {};\r\n\r\n    for (const [documentName, dataArr] of preview.previewData.entries()) {\r\n      const layer = canvas.getLayerByEmbeddedName(documentName);\r\n      for (const data of dataArr) {\r\n        // Create Preview\r\n        const previewObject = await this._createPreview.call(layer, deepClone(data));\r\n        previewObject._pData = data;\r\n        previews.push(previewObject);\r\n        previewDocuments.add(documentName);\r\n\r\n        // Set initial transform which will set first preview to (0, 0) and all others relative to it\r\n        if (transform.x == null) {\r\n          if (documentName === 'Wall') {\r\n            transform.x = -previewObject.document.c[0];\r\n            transform.y = -previewObject.document.c[1];\r\n          } else {\r\n            transform.x = -previewObject.document.x;\r\n            transform.y = -previewObject.document.y;\r\n          }\r\n        }\r\n\r\n        if (preview.taPreview && documentName === 'Token') {\r\n          const documentNames = await this._genTAPreviews(data, preview.taPreview, previewObject, previews);\r\n          documentNames.forEach((dName) => previewDocuments.add(dName));\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const preview of previews) {\r\n      const doc = preview.document;\r\n      DataTransform.apply(doc.documentName, preview._pData ?? doc, { x: 0, y: 0 }, transform, preview);\r\n    }\r\n    return { previews, layer: canvas.getLayerByEmbeddedName(preview.documentName), previewDocuments };\r\n  }\r\n\r\n  static _parseTAPreview(taPreview, attached) {\r\n    if (taPreview === 'ALL') return attached;\r\n\r\n    const attachedData = {};\r\n    taPreview = taPreview.split(',');\r\n\r\n    for (const taIndex of taPreview) {\r\n      let [name, index] = taIndex.trim().split('.');\r\n      if (!attached[name]) continue;\r\n\r\n      if (index == null) {\r\n        attachedData[name] = attached[name];\r\n      } else {\r\n        if (attached[name][index]) {\r\n          if (!attachedData[name]) attachedData[name] = [];\r\n          attachedData[name].push(attached[name][index]);\r\n        }\r\n      }\r\n    }\r\n\r\n    return attachedData;\r\n  }\r\n\r\n  static async _genTAPreviews(data, taPreview, parent, previews) {\r\n    if (!game.modules.get('token-attacher')?.active) return [];\r\n\r\n    const attached = getProperty(data, 'flags.token-attacher.prototypeAttached');\r\n    const pos = getProperty(data, 'flags.token-attacher.pos');\r\n    const grid = getProperty(data, 'flags.token-attacher.grid');\r\n\r\n    if (!(attached && pos && grid)) return [];\r\n\r\n    const documentNames = new Set();\r\n\r\n    const ratio = canvas.grid.size / grid.size;\r\n    const attachedData = this._parseTAPreview(taPreview, attached);\r\n\r\n    for (const [name, dataList] of Object.entries(attachedData)) {\r\n      for (let data of dataList) {\r\n        if (['Token', 'Tile', 'Drawing'].includes(name)) {\r\n          data.width *= ratio;\r\n          data.height *= ratio;\r\n        }\r\n\r\n        const taPreviewObject = await this._createPreview.call(canvas.getLayerByEmbeddedName(name), data);\r\n        documentNames.add(name);\r\n        previews.push(taPreviewObject);\r\n\r\n        const doc = taPreviewObject.document;\r\n        if (name === 'Wall') {\r\n          doc.c[0] = parent.document.x + (data.c[0] - pos.xy.x) * ratio;\r\n          doc.c[1] = parent.document.y + (data.c[1] - pos.xy.y) * ratio;\r\n          doc.c[2] = parent.document.x + (data.c[2] - pos.xy.x) * ratio;\r\n          doc.c[3] = parent.document.y + (data.c[3] - pos.xy.y) * ratio;\r\n        } else {\r\n          doc.x = parent.document.x + (data.x - pos.xy.x) * ratio;\r\n          doc.y = parent.document.y + (data.y - pos.xy.y) * ratio;\r\n        }\r\n      }\r\n    }\r\n\r\n    return documentNames;\r\n  }\r\n}\r\n\r\nexport class DataTransform {\r\n  /**\r\n   * Transform placeable data and optionally an accompanying preview with the provided delta transform\r\n   * @param {String} docName\r\n   * @param {Object} data\r\n   * @param {Object} origin\r\n   * @param {Object} transform\r\n   * @param {PlaceableObject} preview\r\n   */\r\n  static apply(docName, data, origin, transform, preview) {\r\n    if (transform.x == null) transform.x = 0;\r\n    if (transform.y == null) transform.y = 0;\r\n\r\n    // TODO: Add checks for data with missing fields\r\n\r\n    if (docName === 'Wall') {\r\n      this.transformWall(data, origin, transform, preview);\r\n    } else if (docName === 'Tile') {\r\n      this.transformTile(data, origin, transform, preview);\r\n    } else if (docName == 'Note') {\r\n      this.transformNote(data, origin, transform, preview);\r\n    } else if (docName === 'Token') {\r\n      this.transformToken(data, origin, transform, preview);\r\n    } else if (docName === 'MeasuredTemplate') {\r\n      this.transformMeasuredTemplate(data, origin, transform, preview);\r\n    } else if (docName === 'AmbientLight') {\r\n      this.transformAmbientLight(data, origin, transform, preview);\r\n    } else if (docName === 'AmbientSound') {\r\n      this.transformAmbientSound(data, origin, transform, preview);\r\n    } else if (docName === 'Drawing') {\r\n      this.transformDrawing(data, origin, transform, preview);\r\n    } else {\r\n      data.x += transform.x;\r\n      data.y += transform.y;\r\n      if (preview) {\r\n        preview.document.x = data.x;\r\n        preview.document.y = data.y;\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformNote(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (preview) {\r\n      preview.document.x = data.x;\r\n      preview.document.y = data.y;\r\n    }\r\n  }\r\n\r\n  static transformAmbientSound(data, origin, transform, preview) {\r\n    // 3D support\r\n    const bottom = data.flags?.levels?.rangeBottom;\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.radius *= scale;\r\n      }\r\n      // 3D Support\r\n      if (bottom != null && bottom != '') {\r\n        data.flags.levels.rangeBottom *= scale;\r\n        data.flags.levels.rangeTop *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      setProperty(data, 'flags.levels.rangeBottom', (bottom ?? 0) + transform.z);\r\n      setProperty(data, 'flags.levels.rangeTop', (bottom ?? 0) + transform.z);\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.radius = data.radius;\r\n    }\r\n  }\r\n\r\n  static transformWall(data, origin, transform, preview) {\r\n    const c = deepClone(data.c);\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      c[0] *= scale;\r\n      c[1] *= scale;\r\n      c[2] *= scale;\r\n      c[3] *= scale;\r\n    }\r\n\r\n    c[0] += transform.x;\r\n    c[1] += transform.y;\r\n    c[2] += transform.x;\r\n    c[3] += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [c[0], c[1]] = this.rotatePoint(origin.x, origin.y, c[0], c[1], dr);\r\n      [c[2], c[3]] = this.rotatePoint(origin.x, origin.y, c[2], c[3], dr);\r\n    }\r\n\r\n    data.c = c;\r\n    if (preview) preview.document.c = c;\r\n  }\r\n\r\n  static transformMeasuredTemplate(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.distance *= scale;\r\n        if (data.width) data.width *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.direction += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.direction = data.direction;\r\n      doc.distance = data.distance;\r\n      doc.width = data.width;\r\n    }\r\n  }\r\n\r\n  static transformAmbientLight(data, origin, transform, preview) {\r\n    // 3D support\r\n    const bottom = data.flags?.levels?.rangeBottom;\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.config.dim *= scale;\r\n        data.config.bright *= scale;\r\n      }\r\n      // 3D Support\r\n      if (bottom != null && bottom != '') {\r\n        data.flags.levels.rangeBottom *= scale;\r\n        data.flags.levels.rangeTop *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      setProperty(data, 'flags.levels.rangeBottom', (bottom ?? 0) + transform.z);\r\n      setProperty(data, 'flags.levels.rangeTop', (bottom ?? 0) + transform.z);\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.rotation = data.rotation;\r\n      doc.config.dim = data.config.dim;\r\n      doc.config.bright = data.config.bright;\r\n    }\r\n  }\r\n\r\n  static transformTile(data, origin, transform, preview) {\r\n    // 3D support\r\n    const depth = data.flags?.['levels-3d-preview']?.depth;\r\n    const bottom = data.flags?.levels?.rangeBottom;\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.width *= scale;\r\n      data.height *= scale;\r\n\r\n      // 3D Support\r\n      if (depth != null && depth != '') data.flags['levels-3d-preview'].depth *= scale;\r\n      if (bottom != null && bottom != '') {\r\n        data.flags.levels.rangeBottom *= scale;\r\n        data.flags.levels.rangeTop *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      setProperty(data, 'flags.levels.rangeBottom', (bottom ?? 0) + transform.z);\r\n      setProperty(data, 'flags.levels.rangeTop', (bottom ?? 0) + transform.z);\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.width / 2, y: data.y + data.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.width / 2;\r\n      data.y = rectCenter.y - data.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n      doc.rotation = data.rotation;\r\n    }\r\n  }\r\n\r\n  static transformDrawing(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.shape.width *= scale;\r\n      data.shape.height *= scale;\r\n      if (data.shape.points) {\r\n        const points = data.shape.points;\r\n        for (let i = 0; i < points.length; i++) {\r\n          points[i] *= scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.shape.width / 2, y: data.y + data.shape.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.shape.width / 2;\r\n      data.y = rectCenter.y - data.shape.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.shape.width = data.shape.width;\r\n      doc.shape.height = data.shape.height;\r\n      doc.shape.points = data.shape.points;\r\n      doc.rotation = data.rotation;\r\n    }\r\n  }\r\n\r\n  static transformToken(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.width *= scale;\r\n        data.height *= scale;\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    data.elevation += transform.z ?? 0;\r\n\r\n    const grid = canvas.grid;\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + (data.width * grid.w) / 2, y: data.y + (data.height * grid.h) / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - (data.width * grid.w) / 2;\r\n      data.y = rectCenter.y - (data.height * grid.h) / 2;\r\n      data.rotation = (data.rotation + Math.toDegrees(dr)) % 360;\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.elevation = data.elevation;\r\n      doc.rotation = data.rotation;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rotates one point around the other\r\n   * @param {Number} x pivot point\r\n   * @param {Number} y pivot point\r\n   * @param {Number} x2 point to be rotated\r\n   * @param {Number} y2 point to be rotated\r\n   * @param {Number} rot rotation in radians\r\n   * @returns\r\n   */\r\n  static rotatePoint(x, y, x2, y2, rot) {\r\n    const dx = x2 - x,\r\n      dy = y2 - y;\r\n    return [x + Math.cos(rot) * dx - Math.sin(rot) * dy, y + Math.sin(rot) * dx + Math.cos(rot) * dy];\r\n  }\r\n}\r\n\r\nexport async function editPreviewPlaceables() {\r\n  const docToPlaceables = new Map();\r\n\r\n  SUPPORTED_PLACEABLES.forEach((docName) => {\r\n    const controlled = canvas.getLayerByEmbeddedName(docName).controlled;\r\n    if (controlled.length) {\r\n      docToPlaceables.set(\r\n        docName,\r\n        controlled.map((p) => p)\r\n      );\r\n    }\r\n  });\r\n\r\n  if (!docToPlaceables.size) {\r\n    // Activate picker to define select box\r\n    const coords = await new Promise(async (resolve) => {\r\n      Picker.activate(resolve);\r\n    });\r\n    if (!coords) return;\r\n\r\n    // Selects placeables within the bounding box\r\n    const selectionRect = new PIXI.Rectangle(\r\n      coords.start.x,\r\n      coords.start.y,\r\n      coords.end.x - coords.start.x,\r\n      coords.end.y - coords.start.y\r\n    );\r\n\r\n    SUPPORTED_PLACEABLES.forEach((docName) => {\r\n      let insideRect = [];\r\n      canvas.getLayerByEmbeddedName(docName).placeables.forEach((p) => {\r\n        const c = p.center;\r\n        if (selectionRect.contains(c.x, c.y)) insideRect.push(p);\r\n      });\r\n      if (insideRect.length) docToPlaceables.set(docName, insideRect);\r\n    });\r\n  }\r\n\r\n  if (!docToPlaceables.size) return;\r\n\r\n  // Generate data from the selected placeables and pass them to Picker to create previews\r\n  const docToData = new Map();\r\n  const originalDocTolData = new Map();\r\n\r\n  let mainDocName;\r\n  docToPlaceables.forEach((placeables, documentName) => {\r\n    if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n      let data = placeables.map((p) => p.document.toCompendium(null, { keepId: true }));\r\n\r\n      if (\r\n        documentName === 'Token' &&\r\n        game.modules.get('token-attacher')?.active &&\r\n        tokenAttacher?.generatePrototypeAttached\r\n      ) {\r\n        for (const d of data) {\r\n          const attached = d.flags?.['token-attacher']?.attached || {};\r\n          if (!foundry.utils.isEmpty(attached)) {\r\n            const prototypeAttached = tokenAttacher.generatePrototypeAttached(d, attached);\r\n            setProperty(d, 'flags.token-attacher.attached', null);\r\n            setProperty(d, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n            setProperty(d, 'flags.token-attacher.grid', {\r\n              size: canvas.grid.size,\r\n              w: canvas.grid.w,\r\n              h: canvas.grid.h,\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      docToData.set(documentName, data);\r\n      originalDocTolData.set(documentName, deepClone(data));\r\n      if (!mainDocName) mainDocName = documentName;\r\n    }\r\n  });\r\n\r\n  if (!docToData.size) return;\r\n\r\n  Picker.activate(\r\n    async (coords) => {\r\n      if (coords == null) return;\r\n\r\n      docToData.forEach((data, documentName) => {\r\n        let updates = [];\r\n\r\n        const originalData = originalDocTolData.get(documentName);\r\n        for (let i = 0; i < originalData.length; i++) {\r\n          const diff = foundry.utils.diffObject(originalData[i], data[i]);\r\n          if (!foundry.utils.isEmpty(diff)) {\r\n            diff._id = originalData[i]._id;\r\n            delete diff.flags;\r\n            updates.push(diff);\r\n          }\r\n        }\r\n        if (updates.length) canvas.scene.updateEmbeddedDocuments(documentName, updates);\r\n      });\r\n    },\r\n    {\r\n      documentName: mainDocName,\r\n      previewData: docToData,\r\n      snap: true,\r\n      taPreview: 'ALL',\r\n      center: true,\r\n    }\r\n  );\r\n}\r\n","import { checkApplySpecialFields } from '../../applications/forms.js';\r\nimport { Brush } from '../brush.js';\r\nimport { DataTransform, Picker } from '../picker.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport {\r\n  MODULE_ID,\r\n  SUPPORTED_PLACEABLES,\r\n  SeededRandom,\r\n  UI_DOCS,\r\n  applyPresetToScene,\r\n  createDocuments,\r\n  executeScript,\r\n  localize,\r\n} from '../utils.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\nimport { Preset, VirtualFilePreset } from './preset.js';\r\nimport {\r\n  FolderState,\r\n  decodeURIComponentSafely,\r\n  getPresetDataCenterOffset,\r\n  getTransformToOrigin,\r\n  mergePresetDataToDefaultDoc,\r\n  modifySpawnData,\r\n  placeableToData,\r\n} from './utils.js';\r\n\r\nexport const DEFAULT_PACK = 'world.mass-edit-presets-main';\r\nexport const META_INDEX_ID = 'MassEditMetaData';\r\nexport const META_INDEX_FIELDS = ['id', 'img', 'documentName', 'tags'];\r\n\r\nexport class PresetCollection {\r\n  static presets;\r\n\r\n  static workingPack;\r\n\r\n  static async getTree(type, { externalCompendiums = true, virtualDirectory = true, setFormVisibility = false } = {}) {\r\n    if (CONFIG.debug.MassEdit) console.time('getTree');\r\n\r\n    let pack;\r\n    let mainTree;\r\n    try {\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await PresetTree.init(pack, type, { forceLoad: true, setFormVisibility });\r\n    } catch (e) {\r\n      // Fail-safe. Return back to DEFAULT_PACK\r\n      console.log(e);\r\n      console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`);\r\n      console.log('RETURNING TO DEFAULT');\r\n      await game.settings.set(MODULE_ID, 'workingPack', DEFAULT_PACK);\r\n      this.workingPack = DEFAULT_PACK;\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await PresetTree.init(pack, type, { forceLoad: true, setFormVisibility });\r\n    }\r\n\r\n    const extFolders = [];\r\n\r\n    if (externalCompendiums) {\r\n      for (const p of game.packs) {\r\n        if (p.collection !== this.workingPack && p.index.get(META_INDEX_ID)) {\r\n          const tree = await PresetTree.init(p, type, { setFormVisibility });\r\n          if (!tree.hasVisible) continue;\r\n\r\n          const topFolder = new PresetPackFolder({ pack: p, tree });\r\n          extFolders.push(topFolder);\r\n\r\n          // Collate all folders with the main tree\r\n          mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n          for (const [uuid, folder] of tree.allFolders) {\r\n            mainTree.allFolders.set(uuid, folder);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Read File Index\r\n    if (virtualDirectory) {\r\n      const vTree = await FileIndexer.getVirtualDirectoryTree(type, { setFormVisibility });\r\n      if (vTree?.hasVisible) {\r\n        const topFolder = new VirtualFileFolder({\r\n          name: 'VIRTUAL DIRECTORY',\r\n          children: vTree.folders,\r\n          uuid: 'virtual_directory',\r\n          color: '#1c5fa385',\r\n        });\r\n        extFolders.push(topFolder);\r\n\r\n        // Collate all folders with the main tree\r\n        mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n        for (const [uuid, folder] of vTree.allFolders) {\r\n          mainTree.allFolders.set(uuid, folder);\r\n        }\r\n      }\r\n    }\r\n\r\n    mainTree.extFolders = this._groupExtFolders(extFolders, mainTree.allFolders);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd('getTree');\r\n    return mainTree;\r\n  }\r\n\r\n  static _groupExtFolders(folders, allFolders) {\r\n    folders = folders.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n\r\n    const groups = {};\r\n    const groupless = [];\r\n    folders.forEach((f) => {\r\n      if (f.group) {\r\n        if (!(f.group in groups)) groups[f.group] = [];\r\n        groups[f.group].push(f);\r\n      } else {\r\n        groupless.push(f);\r\n      }\r\n    });\r\n\r\n    const newExtFolders = [];\r\n    for (const [group, folders] of Object.entries(groups)) {\r\n      const id = SeededRandom.randomID(group); // For export operation a real ID is needed. Lets keep it consistent by seeding\r\n      const uuid = 'virtual@' + group; // faux uuid\r\n\r\n      const groupFolder = new PresetVirtualFolder({\r\n        id,\r\n        uuid,\r\n        name: group,\r\n        children: folders,\r\n        draggable: false,\r\n      });\r\n\r\n      allFolders.set(uuid, groupFolder);\r\n      newExtFolders.push(groupFolder);\r\n    }\r\n\r\n    return newExtFolders.concat(groupless).sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n  }\r\n\r\n  // Fixing meta index by removing loose indexes\r\n  // 06/03/2024\r\n  static async _cleanIndex(pack, metaDoc, metaIndex) {\r\n    if (pack.locked || !metaDoc || foundry.utils.isEmpty(metaIndex)) return;\r\n    const index = pack.index;\r\n\r\n    const update = {};\r\n    for (const idx of Object.keys(metaIndex)) {\r\n      if (!index.has(idx)) update['-=' + idx] = null;\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      metaDoc.setFlag(MODULE_ID, 'index', update);\r\n      delete PresetTree._packTrees[pack.metadata.name];\r\n    }\r\n  }\r\n\r\n  static _sortFolders(folders, sorting = 'a') {\r\n    for (const folder of folders) {\r\n      folder.children = this._sortFolders(folder.children, folder.sorting);\r\n      folder.presets = this._sortPresets(folder.presets, folder.sorting);\r\n    }\r\n\r\n    if (sorting === 'a') return folders.sort((f1, f2) => f1.name.localeCompare(f2.name, 'en', { numeric: true }));\r\n    else return folders.sort((f1, f2) => f1.sort - f2.sort);\r\n  }\r\n\r\n  static _sortPresets(presets, sorting = 'a') {\r\n    if (sorting === 'a') return presets.sort((p1, p2) => p1.name.localeCompare(p2.name, 'en', { numeric: true }));\r\n    else return presets.sort((p1, p2) => p1.sort - p2.sort);\r\n  }\r\n\r\n  static async packToPresets(pack) {\r\n    if (!pack) return [];\r\n\r\n    const presets = [];\r\n\r\n    let metaIndex = (await pack.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  static async update(preset) {\r\n    const compendium = await this._initCompendium(this.workingPack);\r\n    const doc = await compendium.getDocument(preset.id);\r\n    const updateDoc = {\r\n      name: preset.name,\r\n      flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n    };\r\n    const pages = preset.pages;\r\n    if (pages) updateDoc.pages = pages;\r\n    await doc.update(updateDoc);\r\n\r\n    const metaDoc = await this._initMetaDocument(this.workingPack);\r\n    const update = {};\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n    delete PresetTree._packTrees[compendium.metadata.name];\r\n  }\r\n\r\n  /**\r\n   * Update multiple presets at the same time\r\n   * @param {*} updates\r\n   */\r\n  static async updatePresets(updates) {\r\n    // TODO update meta and preset itself\r\n    await JournalEntry.updateDocuments(updates, { pack: this.workingPack });\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async set(preset, pack) {\r\n    if (!pack) pack = this.workingPack;\r\n\r\n    if (preset instanceof Array) {\r\n      for (const p of preset) {\r\n        await PresetCollection.set(p, pack);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const compendium = await this._initCompendium(pack);\r\n    if (compendium.index.get(preset.id)) {\r\n      await this.update(preset);\r\n      return;\r\n    }\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: preset.id,\r\n          name: preset.name,\r\n          pages: preset.pages ?? [],\r\n          folder: preset.folder,\r\n          flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n\r\n    preset.uuid = documents[0].uuid;\r\n    preset.document = documents[0];\r\n\r\n    const metaDoc = await this._initMetaDocument(pack);\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n    delete PresetTree._packTrees[pack];\r\n  }\r\n\r\n  static async get(uuid, { full = true } = {}) {\r\n    if (uuid.startsWith('virtual@')) return this._constructVirtualFilePreset(uuid, { full });\r\n\r\n    let { collection, documentId, documentType, embedded, doc } = foundry.utils.parseUuid(uuid);\r\n    const index = collection.index.get(documentId);\r\n\r\n    if (index) {\r\n      const metaIndex = (await collection.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n      const mIndex = metaIndex[index._id];\r\n\r\n      const preset = new Preset({ ...index, ...mIndex, pack: collection.collection });\r\n      if (full) await preset.load();\r\n      return preset;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  static async _constructVirtualFilePreset(uuid, { full = true } = {}) {\r\n    const src = uuid.substring(8);\r\n    const preset = new VirtualFilePreset({ src });\r\n    if (full) await preset.load();\r\n    return preset;\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async delete(presets) {\r\n    if (!presets) return;\r\n    if (!(presets instanceof Array)) presets = [presets];\r\n\r\n    // Sort by compendium\r\n    const sorted = {};\r\n    for (const preset of presets) {\r\n      let { collection } = foundry.utils.parseUuid(preset.uuid);\r\n      if (!collection) continue;\r\n      collection = collection.collection;\r\n      if (!sorted[collection]) sorted[collection] = [preset];\r\n      else sorted[collection].push(preset);\r\n    }\r\n\r\n    for (const pack of Object.keys(sorted)) {\r\n      const compendium = await game.packs.get(pack);\r\n      if (!compendium) continue;\r\n\r\n      const metaDoc = await this._initMetaDocument(pack);\r\n      const metaUpdate = {};\r\n\r\n      const deleteIds = [];\r\n      for (const preset of sorted[pack]) {\r\n        deleteIds.push(preset.id);\r\n        metaUpdate['-=' + preset.id] = null;\r\n      }\r\n\r\n      await JournalEntry.deleteDocuments(deleteIds, { pack });\r\n      metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n      delete PresetTree._packTrees[compendium.metadata.name];\r\n    }\r\n  }\r\n\r\n  static async _initCompendium(pack) {\r\n    let compendium = game.packs.get(pack);\r\n    if (!compendium && pack === DEFAULT_PACK) {\r\n      compendium = await CompendiumCollection.createCompendium({\r\n        label: 'Mass Edit: Presets (MAIN)',\r\n        type: 'JournalEntry',\r\n        ownership: {\r\n          GAMEMASTER: 'NONE',\r\n          PLAYER: 'NONE',\r\n          ASSISTANT: 'NONE',\r\n        },\r\n        packageType: 'world',\r\n      });\r\n\r\n      await this._initMetaDocument(pack);\r\n    }\r\n\r\n    return compendium;\r\n  }\r\n\r\n  static async _initMetaDocument(pack) {\r\n    const compendium = game.packs.get(pack);\r\n    const metaDoc = await compendium.getDocument(META_INDEX_ID);\r\n    if (metaDoc) return metaDoc;\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: META_INDEX_ID,\r\n          name: '!!! METADATA: DO NOT DELETE !!!',\r\n          flags: { [MODULE_ID]: { index: {} } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n    return documents[0];\r\n  }\r\n\r\n  static async deleteFolder(uuid, deleteAll = false) {\r\n    const folderDoc = await fromUuid(uuid);\r\n    if (folderDoc.compendium.locked) return;\r\n\r\n    if (deleteAll) {\r\n      const metaDoc = folderDoc.compendium.get(META_INDEX_ID);\r\n      if (!metaDoc) return;\r\n\r\n      const metaUpdate = {};\r\n      const traverseFolder = function (folder) {\r\n        folder.contents.forEach((j) => (metaUpdate['-=' + j._id] = null));\r\n        folder.children.forEach((c) => traverseFolder(c.folder));\r\n      };\r\n      traverseFolder(folderDoc);\r\n\r\n      metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n    }\r\n\r\n    delete PresetTree._packTrees[folderDoc.compendium.metadata.name];\r\n    return await folderDoc.delete({ deleteSubfolders: deleteAll, deleteContents: deleteAll });\r\n  }\r\n\r\n  static _searchPresetTree(tree, options) {\r\n    const presets = [];\r\n\r\n    if (!options.folder) this._searchPresetList(tree.allPresets, presets, options);\r\n    tree.allFolders.forEach((folder) => this._searchPresetFolder(folder, presets, options));\r\n\r\n    return presets;\r\n  }\r\n\r\n  static _searchPresetFolder(folder, presets, options) {\r\n    if (options.folder && folder.name !== options.folder) return;\r\n    this._searchPresetList(folder.presets, presets, options, folder.name);\r\n  }\r\n\r\n  static _searchPresetList(toSearch, presets, { name, type, tags } = {}, folderName) {\r\n    for (const preset of toSearch) {\r\n      let match = true;\r\n      if (name && name !== preset.name) match = false;\r\n      if (type && type !== preset.documentName) match = false;\r\n      if (match && tags) {\r\n        if (tags.matchAny) match = tags.tags.some((t) => preset.tags.includes(t));\r\n        else match = tags.tags.every((t) => preset.tags.includes(t));\r\n      }\r\n\r\n      if (match) presets.push(preset);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build preset index for 'Spotlight Omnisearch' module\r\n   * @param {Array[CONFIG.SpotlightOmnisearch.SearchTerm]} soIndex\r\n   */\r\n  static async buildSpotlightOmnisearchIndex(soIndex) {\r\n    const tree = await PresetCollection.getTree(null, { externalCompendiums: true });\r\n\r\n    const SearchTerm = CONFIG.SpotlightOmnisearch.SearchTerm;\r\n\r\n    const onClick = async function () {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        ui.spotlightOmnisearch?.setDraggingState(true);\r\n        await PresetAPI.spawnPreset({\r\n          preset: this.data,\r\n          coordPicker: true,\r\n          taPreview: 'ALL',\r\n          scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n        });\r\n        ui.spotlightOmnisearch?.setDraggingState(false);\r\n      }\r\n    };\r\n\r\n    const onDragEnd = function (event) {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        const { x, y } = canvas.canvasCoordinatesFromClient({ x: event.clientX, y: event.clientY });\r\n        PresetAPI.spawnPreset({\r\n          preset: this.data,\r\n          x,\r\n          y,\r\n          scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n        });\r\n      } else if (this.data.documentName === 'Scene') {\r\n        applyPresetToScene(this.data);\r\n      }\r\n    };\r\n\r\n    const deactivateCallback = function () {\r\n      ui.spotlightOmnisearch?.setDraggingState(false);\r\n    };\r\n\r\n    const getActions = function () {\r\n      const actions = [\r\n        {\r\n          name: 'MassEdit.presets.open-journal',\r\n          icon: '<i class=\"fas fa-book-open fa-fw\"></i>',\r\n          callback: () => {\r\n            this.data.openJournal();\r\n          },\r\n        },\r\n      ];\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        actions.push({\r\n          name: `MassEdit.presets.controls.activate-brush`,\r\n          icon: '<i class=\"fas fa-paint-brush\"></i>',\r\n          callback: async () => {\r\n            canvas.getLayerByEmbeddedName(this.data.documentName)?.activate();\r\n            if (Brush.activate({ preset: await this.data.load(), deactivateCallback })) {\r\n              ui.spotlightOmnisearch.setDraggingState(true);\r\n            }\r\n          },\r\n        });\r\n      }\r\n      return actions;\r\n    };\r\n\r\n    const buildTerm = function (preset) {\r\n      soIndex.push(\r\n        new SearchTerm({\r\n          name: preset.name,\r\n          description: 'Mass Edit: Preset',\r\n          type: preset.documentName + ' preset',\r\n          img: preset.img,\r\n          icon: ['fa-solid fa-books', preset.icon],\r\n          keywords: preset.tags,\r\n          onClick,\r\n          onDragEnd,\r\n          data: preset,\r\n          actions: getActions,\r\n        })\r\n      );\r\n    };\r\n\r\n    tree.presets.forEach(buildTerm);\r\n    tree.allFolders.forEach((f) => f.presets.forEach(buildTerm));\r\n  }\r\n}\r\n\r\nexport class PresetAPI {\r\n  static name = 'PresetAPI';\r\n\r\n  /**\r\n   * Retrieve preset\r\n   * @param {object} [options={}]\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Tags to match a preset against. Can be provided as an object containing 'tags' array and 'match' any flag.\r\n   *                                                     Comma separated string, or a list of strings. In the latter 2 case 'matchAny' is assumed true\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {Boolean} [options.random]                   If multiple presets are found a random one will be chosen\r\n   * @returns {Preset}\r\n   */\r\n  static async getPreset({ uuid, name, type, folder, tags, random = false } = {}) {\r\n    if (uuid) return await PresetCollection.get(uuid);\r\n    else if (!name && !type && !folder && !tags)\r\n      throw Error('UUID, Name, Type, and/or Folder required to retrieve a Preset.');\r\n\r\n    if (tags) {\r\n      if (Array.isArray(tags)) tags = { tags, matchAny: true };\r\n      else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny: true };\r\n    }\r\n\r\n    const presets = PresetCollection._searchPresetTree(\r\n      await PresetCollection.getTree(type, { externalCompendiums: true, virtualDirectory: true }),\r\n      {\r\n        name,\r\n        type,\r\n        folder,\r\n        tags,\r\n      }\r\n    );\r\n\r\n    const preset = random ? presets[Math.floor(Math.random() * presets.length)] : presets[0];\r\n    return preset?.clone().load();\r\n  }\r\n\r\n  /**\r\n   * Retrieve presets\r\n   * @param {object} [options={}]\r\n   * @param {String|Array[String]} [options.uuid]        Preset UUID/s\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {String|Array[String]|Object} [options.tags] See PresetAPI.getPreset\r\n   * @param {String} [options.format]                    The form to return placeables in ('preset', 'name', 'nameAndFolder')\r\n   * @returns {Array[Preset]|Array[String]|Array[Object]}\r\n   */\r\n  static async getPresets({ uuid, name, type, folder, format = 'preset', tags } = {}) {\r\n    let presets;\r\n    if (uuid) {\r\n      presets = [];\r\n      const uuids = Array.isArray(uuid) ? uuid : [uuid];\r\n      for (const uuid of uuids) {\r\n        const preset = await PresetCollection.get(uuid);\r\n        if (preset) presets.push(preset);\r\n      }\r\n    } else if (!name && !type && !folder && !tags) {\r\n      throw Error('UUID, Name, Type, Folder and/or Tags required to retrieve a Preset.');\r\n    } else {\r\n      if (tags) {\r\n        if (Array.isArray(tags)) tags = { tags, matchAny: true };\r\n        else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny: true };\r\n      }\r\n\r\n      presets = PresetCollection._searchPresetTree(\r\n        await PresetCollection.getTree(type, { externalCompendiums: true, virtualDirectory: true }),\r\n        {\r\n          name,\r\n          type,\r\n          folder,\r\n          tags,\r\n        }\r\n      );\r\n    }\r\n\r\n    if (format === 'name') return presets.map((p) => p.name);\r\n    else if (format === 'nameAndFolder')\r\n      return presets.map((p) => {\r\n        return { name: p.name, folder: p._folderName };\r\n      });\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Create a Token preset from the provided Actor\r\n   */\r\n  static async createPresetFromActor(actor, { keepId = false, folder } = {}) {\r\n    if (!actor || actor.documentName !== 'Actor') return;\r\n\r\n    const presetData = {\r\n      id: keepId ? actor.id : null,\r\n      name: actor.name,\r\n      documentName: 'Token',\r\n      img: actor.img,\r\n      data: [actor.prototypeToken.toJSON()],\r\n      folder: folder,\r\n    };\r\n\r\n    presetData.gridSize = canvas.scene.grid.size;\r\n\r\n    const preset = new Preset(presetData);\r\n    await PresetCollection.set(preset);\r\n    return preset;\r\n  }\r\n\r\n  static async createPresetFromActorUuid(uuid, options = {}) {\r\n    const actor = await fromUuid(uuid);\r\n    if (!actor.documentName === 'Actor') return;\r\n\r\n    return await this.createPresetFromActor(actor, options);\r\n  }\r\n\r\n  /**\r\n   * Create Presets from passed in placeables\r\n   * @param {PlaceableObject|Array[PlaceableObject]} placeables Placeable/s to create the presets from.\r\n   * @param {object} [options={}]                               Optional Preset information\r\n   * @param {String} [options.name]                             Preset name\r\n   * @param {String} [options.img]                              Preset thumbnail image\r\n   * @returns {Preset|Array[Preset]}\r\n   */\r\n  static async createPreset(placeables, options = {}) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    // Alike placeables will be made into single presets. Lets batch them up together.\r\n\r\n    const groups = {};\r\n    for (const placeable of placeables) {\r\n      const docName = placeable.document.documentName;\r\n      if (!groups.hasOwnProperty(docName)) groups[docName] = [];\r\n      groups[docName].push(placeable);\r\n    }\r\n\r\n    const presets = [];\r\n    for (const [docName, placeables] of Object.entries(groups)) {\r\n      const data = [];\r\n      for (const placeable of placeables) {\r\n        data.push(placeableToData(placeable));\r\n      }\r\n\r\n      // Preset data before merging with user provided\r\n      const defPreset = {\r\n        name: localize('presets.default-name'),\r\n        documentName: docName,\r\n        data: data,\r\n      };\r\n\r\n      // Assign preset image\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n        case 'Tile':\r\n        case 'Note':\r\n          defPreset.img = data[0].texture.src;\r\n          break;\r\n        case 'AmbientSound':\r\n          defPreset.img = 'icons/svg/sound.svg';\r\n          break;\r\n        case 'AmbientLight':\r\n          defPreset.img = 'icons/svg/light.svg';\r\n          break;\r\n        case 'Drawing':\r\n          defPreset.img = 'icons/svg/acid.svg';\r\n          break;\r\n        case 'MeasuredTemplate':\r\n          defPreset.img = 'icons/svg/circle.svg';\r\n          break;\r\n      }\r\n\r\n      //  Assign preset name\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n          defPreset.name = data[0].name;\r\n          break;\r\n        default:\r\n          const taggerTag = data[0].flags?.tagger?.tags?.[0];\r\n          if (taggerTag) defPreset.name = taggerTag;\r\n          break;\r\n      }\r\n\r\n      defPreset.gridSize = placeables[0].document.parent.grid.size;\r\n\r\n      foundry.utils.mergeObject(defPreset, options, { inplace: true });\r\n\r\n      const preset = new Preset(defPreset);\r\n      await PresetCollection.set(preset);\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Spawn a preset on the scene (uuid, name or preset itself are required).\r\n   * By default the current mouse position is used.\r\n   * @param {object} [options={}]\r\n   * @param {Preset} [options.preset]                    Preset\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Preset tags, See PresetAPI.getPreset\r\n   * @param {Boolean} [options.random]                   If a unique preset could not be found, a random one will be chosen from the matched list\r\n   * @param {Number} [options.x]                         Spawn canvas x coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.y]                         Spawn canvas y coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.z]                         Spawn canvas z coordinate (3D Canvas)\r\n   * @param {Boolean} [options.snapToGrid]               If 'true' snaps spawn position to the grid.\r\n   * @param {Boolean} [options.hidden]                   If 'true' preset will be spawned hidden.\r\n   * @param {Boolean} [options.layerSwitch]              If 'true' the layer of the spawned preset will be activated.\r\n   * @param {Boolean} [options.scaleToGrid]              If 'true' Tiles, Drawings, and Walls will be scaled relative to grid size.\r\n   * @param {Boolean} [options.modifyPrompt]             If 'true' a field modification prompt will be shown if configured via `Preset Edit > Modify` form\r\n   * @param {Boolean} [options.coordPicker]              If 'true' a crosshair and preview will be enabled allowing spawn position to be picked\r\n   * @param {String} [options.pickerLabel]               Label displayed above crosshair when `coordPicker` is enabled\r\n   * @param {String} [options.taPreview]                 Designates the preview placeable when spawning a `Token Attacher` prefab.\r\n   *                                                      Accepted values are \"ALL\" (for all elements) and document name optionally followed by an index number\r\n   *                                                      e.g. \"ALL\", \"Tile\", \"AmbientLight.1\"\r\n   * @returns {Array[Document]}\r\n   */\r\n  static async spawnPreset({\r\n    uuid,\r\n    preset,\r\n    name,\r\n    type,\r\n    folder,\r\n    tags,\r\n    random = false,\r\n    x,\r\n    y,\r\n    z,\r\n    coordPicker = false,\r\n    pickerLabel,\r\n    taPreview,\r\n    snapToGrid = true,\r\n    hidden = false,\r\n    layerSwitch = false,\r\n    scaleToGrid = false,\r\n    modifyPrompt = true,\r\n    center = false,\r\n    transform = {},\r\n    previewOnly = false,\r\n    sceneId,\r\n  } = {}) {\r\n    if (!canvas.ready) throw Error(\"Canvas need to be 'ready' for a preset to be spawned.\");\r\n    if (!(uuid || preset || name || type || folder || tags))\r\n      throw Error('ID, Name, Folder, Tags, or Preset is needed to spawn it.');\r\n    if (!coordPicker && ((x == null && y != null) || (x != null && y == null)))\r\n      throw Error('Need both X and Y coordinates to spawn a preset.');\r\n\r\n    if (preset) await preset.load();\r\n    preset = preset ?? (await PresetAPI.getPreset({ uuid, name, type, folder, tags, random }));\r\n    if (!preset) throw Error(`No preset could be found matching: { uuid: \"${uuid}\", name: \"${name}\", type: \"${type}\"}`);\r\n\r\n    let presetData = foundry.utils.deepClone(preset.data);\r\n\r\n    // Instead of using the entire data group use only one random one\r\n    if (preset.spawnRandom && presetData.length)\r\n      presetData = [presetData[Math.floor(Math.random() * presetData.length)]];\r\n\r\n    // Display prompt to modify data if needed\r\n    if (modifyPrompt && preset.modifyOnSpawn?.length) {\r\n      presetData = await modifySpawnData(presetData, preset.modifyOnSpawn);\r\n      // presetData being returned as null means that the modify field form has been canceled\r\n      // in which case we should cancel spawning as well\r\n      if (presetData == null) return;\r\n    }\r\n\r\n    // Populate preset data with default placeable data\r\n    presetData = presetData.map((data) => {\r\n      return mergePresetDataToDefaultDoc(preset, data);\r\n    });\r\n    presetData = presetData.map((d) => foundry.utils.flattenObject(d));\r\n    if (!foundry.utils.isEmpty(preset.randomize)) await applyRandomization(presetData, null, preset.randomize); // Randomize data if needed\r\n    await checkApplySpecialFields(preset.documentName, presetData, presetData); // Apply Special fields (TMFX)\r\n    presetData = presetData.map((d) => foundry.utils.expandObject(d));\r\n\r\n    if (preset.preSpawnScript) {\r\n      await executeScript(preset.preSpawnScript, { data: presetData });\r\n    }\r\n\r\n    // Lets sort the preset data as well as any attached placeable data into document groups\r\n    // documentName -> data array\r\n    const docToData = new Map();\r\n    docToData.set(preset.documentName, presetData);\r\n    if (preset.attached) {\r\n      for (const attached of preset.attached) {\r\n        if (!docToData.get(attached.documentName)) docToData.set(attached.documentName, []);\r\n        const data = foundry.utils.deepClone(attached.data);\r\n        docToData.get(attached.documentName).push(data);\r\n      }\r\n    }\r\n\r\n    // Scale data relative to grid size\r\n    if (scaleToGrid) {\r\n      const scale = canvas.grid.size / (preset.gridSize || 100);\r\n      docToData.forEach((dataArr, documentName) => {\r\n        dataArr.forEach((data) => DataTransform.apply(documentName, data, { x: 0, y: 0 }, { scale, gridScale: true }));\r\n      });\r\n    }\r\n\r\n    // ==================\r\n    // Determine spawn position\r\n    if (coordPicker) {\r\n      const coords = await new Promise(async (resolve) => {\r\n        Picker.activate(resolve, {\r\n          documentName: preset.documentName,\r\n          previewData: docToData,\r\n          snap: snapToGrid,\r\n          label: pickerLabel,\r\n          taPreview: taPreview,\r\n          center,\r\n          previewOnly,\r\n          ...transform,\r\n        });\r\n      });\r\n      if (coords == null) return [];\r\n      x = coords.end.x;\r\n      y = coords.end.y;\r\n      if (coords.end.z != null) z = coords.end.z;\r\n    } else if (x == null || y == null) {\r\n      if (game.Levels3DPreview?._active) {\r\n        const pos3d = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n        x = pos3d.x;\r\n        y = pos3d.y;\r\n        z = pos3d.z;\r\n      } else {\r\n        x = canvas.mousePosition.x;\r\n        y = canvas.mousePosition.y;\r\n\r\n        if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n          x -= canvas.dimensions.size / 2;\r\n          y -= canvas.dimensions.size / 2;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (center) {\r\n      const offset = getPresetDataCenterOffset(docToData);\r\n      x -= offset.x;\r\n      y -= offset.y;\r\n    }\r\n\r\n    let pos = { x, y };\r\n\r\n    if (snapToGrid && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)) {\r\n      pos = canvas.grid.getSnappedPosition(\r\n        pos.x,\r\n        pos.y,\r\n        canvas.getLayerByEmbeddedName(preset.documentName).gridPrecision\r\n      );\r\n    }\r\n    pos.z = z;\r\n    // ==================\r\n\r\n    // ==================\r\n    // Set positions taking into account relative distances between each object\r\n\r\n    const posTransform = getTransformToOrigin(docToData);\r\n    posTransform.x += pos.x;\r\n    posTransform.y += pos.y;\r\n\r\n    // 3D Support\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      if (pos.z == null) posTransform.z = 0;\r\n      else posTransform.z += pos.z;\r\n    }\r\n\r\n    docToData.forEach((dataArr, documentName) => {\r\n      dataArr.forEach((data) => {\r\n        DataTransform.apply(documentName, data, { x: 0, y: 0 }, posTransform);\r\n\r\n        // Assign ownership for Drawings and MeasuredTemplates\r\n        if (['Drawing', 'MeasuredTemplate'].includes(documentName)) {\r\n          if (documentName === 'Drawing') data.author = game.user.id;\r\n          else if (documentName === 'MeasuredTemplate') data.user = game.user.id;\r\n        }\r\n\r\n        // Hide\r\n        if (hidden || game.keyboard.downKeys.has('AltLeft')) data.hidden = true;\r\n      });\r\n    });\r\n\r\n    // ==================\r\n\r\n    if (layerSwitch) {\r\n      if (game.user.isGM || ['Token', 'MeasuredTemplate', 'Note'].includes(preset.documentName))\r\n        canvas.getLayerByEmbeddedName(preset.documentName)?.activate();\r\n    }\r\n\r\n    // Create Documents\r\n    const allDocuments = [];\r\n\r\n    for (const [documentName, dataArr] of docToData.entries()) {\r\n      const documents = await createDocuments(documentName, dataArr, sceneId ?? canvas.scene.id);\r\n      documents.forEach((d) => allDocuments.push(d));\r\n    }\r\n\r\n    // Execute post spawn script/function\r\n    if (preset.postSpawnScript) {\r\n      await executeScript(preset.postSpawnScript, {\r\n        documents: allDocuments,\r\n        objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n      });\r\n    }\r\n    await preset.callPostSpawnHooks({\r\n      documents: allDocuments,\r\n      objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n    });\r\n\r\n    return allDocuments;\r\n  }\r\n}\r\n\r\nexport class PresetFolder {\r\n  static isEditable(uuid) {\r\n    const { collection } = foundry.utils.parseUuid(uuid);\r\n    return collection && !collection.locked;\r\n  }\r\n\r\n  constructor({\r\n    id,\r\n    uuid,\r\n    name,\r\n    sorting = 'm',\r\n    color = '#000000',\r\n    sort = 0,\r\n    children = [],\r\n    presets = [],\r\n    draggable = true,\r\n    folder = null,\r\n    visible = true,\r\n    render = true,\r\n    types = [],\r\n  } = {}) {\r\n    this.id = id;\r\n    this.uuid = uuid;\r\n    this.name = name;\r\n    this.sorting = sorting;\r\n    this.color = color;\r\n    this.sort = sort;\r\n    this.children = children;\r\n    this.children.forEach((c) => {\r\n      c.folder = this.id;\r\n    });\r\n    this.presets = presets;\r\n    this.draggable = draggable;\r\n    this.folder = folder;\r\n    this.visible = visible;\r\n    this.render = render;\r\n    this.expanded = FolderState.expanded(this.uuid);\r\n    this.types = types;\r\n  }\r\n\r\n  async update(data) {\r\n    const doc = await fromUuid(this.uuid);\r\n    if (doc) {\r\n      foundry.utils.mergeObject(this, data);\r\n      await doc.update(data);\r\n    }\r\n  }\r\n}\r\n\r\nexport class PresetVirtualFolder extends PresetFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.virtual = true;\r\n    this.draggable = false;\r\n  }\r\n\r\n  async update(data) {}\r\n}\r\n\r\nexport class VirtualFileFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.id = randomID();\r\n    if (!options.types) this.types = ['ALL'];\r\n    this.bucket = options.bucket;\r\n    this.source = options.source;\r\n    this.name = decodeURIComponentSafely(this.name);\r\n    this.icon = options.icon;\r\n    this.subtext = options.subtext;\r\n    if (options.source && ['data', 'forgevtt'].includes(options.source)) this.indexable = true;\r\n  }\r\n}\r\n\r\nexport class PresetPackFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    const tree = options.tree;\r\n    const pack = options.pack;\r\n    const packFolderData = tree.metaDoc.getFlag(MODULE_ID, 'folder') ?? {};\r\n    const uuid = pack.collection;\r\n    super({\r\n      uuid,\r\n      id: SeededRandom.randomID(uuid),\r\n      name: packFolderData.name ?? pack.title,\r\n      children: tree.folders,\r\n      presets: tree.presets,\r\n      draggable: false,\r\n      color: packFolderData.color ?? '#000000',\r\n    });\r\n    this.group = packFolderData.group;\r\n  }\r\n\r\n  get pack() {\r\n    return this.uuid;\r\n  }\r\n\r\n  async update(data = {}) {\r\n    const pack = game.packs.get(this.pack);\r\n    if (pack.locked) return;\r\n    if (data.hasOwnProperty('name') && data.name === pack.title) delete data.name;\r\n    if (foundry.utils.isEmpty(data)) return;\r\n\r\n    const metaDoc = await PresetCollection._initMetaDocument(this.pack);\r\n    await metaDoc.setFlag(MODULE_ID, 'folder', data);\r\n\r\n    foundry.utils.mergeObject(this, data);\r\n  }\r\n}\r\n\r\nexport class PresetTree {\r\n  static _packTrees = {};\r\n\r\n  static async init(pack, type, { forceLoad = false, setFormVisibility = false } = {}) {\r\n    if (!pack) return null;\r\n\r\n    if (CONFIG.debug.MassEdit) console.time(pack.title);\r\n\r\n    // Re-use tree if already parsed\r\n    if (!forceLoad && PresetTree._packTrees[pack.metadata.name]) {\r\n      const tree = PresetTree._packTrees[pack.metadata.name];\r\n      if (setFormVisibility) tree.setVisibility(type);\r\n      if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n      return tree;\r\n    }\r\n\r\n    // Setup folders ready for parent/children processing\r\n    const folders = new Map();\r\n    const topLevelFolders = new Map();\r\n    const folderContents = pack.folders.contents;\r\n    for (const f of folderContents) {\r\n      const folder = new PresetFolder({\r\n        id: f._id,\r\n        uuid: f.uuid,\r\n        name: f.name,\r\n        sorting: f.sorting,\r\n        color: f.color,\r\n        sort: f.sort,\r\n        draggable: f.pack === PresetCollection.workingPack,\r\n        folder: f.folder?.uuid,\r\n        types: f.flags[MODULE_ID]?.types || ['ALL'],\r\n      });\r\n\r\n      folders.set(folder.uuid, folder);\r\n      topLevelFolders.set(f.uuid, folder);\r\n    }\r\n\r\n    // If folders have parent folders add them as children and remove them as a top level folder\r\n    for (const f of folderContents) {\r\n      if (f.folder) {\r\n        const parent = folders.get(f.folder.uuid);\r\n        parent.children.push(folders.get(f.uuid));\r\n        topLevelFolders.delete(f.uuid);\r\n      }\r\n    }\r\n\r\n    // Process presets\r\n    const allPresets = [];\r\n    const topLevelPresets = [];\r\n    let hasVisible = false; // tracks whether there exists at least one visible preset within this tree\r\n    const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n    let metaIndex = metaDoc?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n\r\n    // TEMP - 06/03/2024\r\n    // Due to poor implementation of Folder+Folder Content delete, there are likely to be some indexes which were not removed\r\n    // Lets clean them up here for now\r\n    PresetCollection._cleanIndex(pack, metaDoc, metaIndex);\r\n    // Remove after sufficient enough time has passed to have reasonable confidence that All/Most users have executed this ^\r\n\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n\r\n      // If no document name is available (missing metadata) attempt to load the preset to retrieve it\r\n      // If still no name is found, skip it\r\n      if (!preset.documentName) {\r\n        console.log(`Missing MetaData. Attempting document load: ${preset.id} | ${preset.name}`);\r\n        await preset.load(true);\r\n        if (!preset.documentName) continue;\r\n        console.log(`MetaData. Found for: ${preset.id} | ${preset.name}`);\r\n        if (!pack.locked) await preset._updateIndex(preset); // Insert missing preset into metadata index\r\n      }\r\n\r\n      if (preset.folder) {\r\n        let matched = false;\r\n        for (const [uuid, folder] of folders) {\r\n          if (folder.id === preset.folder) {\r\n            folder.presets.push(preset);\r\n            matched = true;\r\n            break;\r\n          }\r\n        }\r\n        if (!matched) topLevelPresets.push(preset);\r\n      } else topLevelPresets.push(preset);\r\n\r\n      allPresets.push(preset);\r\n      hasVisible |= preset._visible;\r\n    }\r\n\r\n    // Sort folders\r\n    const sorting = game.settings.get(MODULE_ID, 'presetSortMode') === 'manual' ? 'm' : 'a';\r\n    const sortedFolders = PresetCollection._sortFolders(Array.from(topLevelFolders.values()), sorting);\r\n    const sortedPresets = PresetCollection._sortPresets(topLevelPresets, sorting);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n\r\n    const tree = new PresetTree({\r\n      folders: sortedFolders,\r\n      presets: sortedPresets,\r\n      allPresets,\r\n      allFolders: folders,\r\n      hasVisible,\r\n      metaDoc,\r\n      pack,\r\n    });\r\n\r\n    if (setFormVisibility) tree.setVisibility(type);\r\n    PresetTree._packTrees[pack.metadata.name] = tree;\r\n\r\n    return tree;\r\n  }\r\n\r\n  constructor({ folders, presets, allPresets, allFolders, hasVisible, metaDoc, pack } = {}) {\r\n    this.folders = folders;\r\n    this.presets = presets;\r\n    this.allPresets = allPresets;\r\n    this.allFolders = allFolders;\r\n    this.hasVisible = hasVisible;\r\n    this.metaDoc = metaDoc;\r\n    this.pack = pack;\r\n  }\r\n\r\n  setVisibility(type) {\r\n    this.allFolders.forEach((f) => {\r\n      f.render = true;\r\n      f.visible = type ? f.types.includes(type) : true;\r\n    });\r\n\r\n    this.hasVisible = false;\r\n\r\n    for (const preset of this.allPresets) {\r\n      preset._visible = true;\r\n      preset._render = true;\r\n      if (type) {\r\n        if (type === 'ALL') {\r\n          if (!UI_DOCS.includes(preset.documentName)) preset._visible = false;\r\n        } else if (type === 'FAVORITES') {\r\n          if (!preset.isFavorite) preset._visible = false;\r\n        } else if (preset.documentName !== type) preset._visible = false;\r\n      }\r\n\r\n      if (type === 'FAVORITES' && preset.folder && preset.isFavorite) {\r\n        for (const [uuid, folder] of this.allFolders) {\r\n          if (folder.id === preset.folder) {\r\n            this._setChildAndParentFoldersVisible(folder);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      this.hasVisible = this.hasVisible || preset._visible;\r\n    }\r\n  }\r\n\r\n  _setChildAndParentFoldersVisible(folder) {\r\n    folder.visible = true;\r\n    if (folder.folder) {\r\n      for (const [uuid, f] of this.allFolders.entries()) {\r\n        if (f.id === folder.folder) return this._setChildAndParentFoldersVisible(f);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { FILE_EXTENSIONS, MODULE_ID, TagInput } from '../utils.js';\r\nimport { PresetTree, VirtualFileFolder } from './collection.js';\r\nimport { VirtualFilePreset } from './preset.js';\r\nimport { encodeURIComponentSafely, readJSONFile } from './utils.js';\r\n\r\nconst CACHE_PATH = '';\r\nconst CACHE_NAME = 'mass_edit_cache.json';\r\n\r\nexport class FileIndexer {\r\n  static _loadedTree;\r\n  static _buildingIndex = false;\r\n\r\n  static async getVirtualDirectoryTree(type, { setFormVisibility = false } = {}) {\r\n    if (CONFIG.debug.MassEdit) console.time('Virtual File Directory');\r\n\r\n    // If we already have a loaded index, re-use it\r\n    if (this._loadedTree) {\r\n      if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n      if (setFormVisibility) this._loadedTree.setVisibility(type);\r\n      return this._loadedTree;\r\n    }\r\n\r\n    // Load and convert an index cache to a virtual folder\r\n    const allFolders = new Map();\r\n    const allPresets = [];\r\n    const topLevelFolders = [];\r\n\r\n    const cache = await this.loadMainIndexCache();\r\n    if (!cache) {\r\n      if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n      return null;\r\n    }\r\n\r\n    for (const source of cache) {\r\n      let prePend = '';\r\n      if (source.source === 'forge-bazaar') {\r\n        prePend = `https://assets.forge-vtt.com/bazaar/`;\r\n      } else if (source.source === 'forgevtt') {\r\n        if (typeof ForgeVTT === 'undefined' || !ForgeVTT.usingTheForge) continue;\r\n        const userId = await ForgeAPI.getUserId();\r\n        if (!userId) continue;\r\n        prePend = `https://assets.forge-vtt.com/${userId}/`;\r\n      } else if (source.source === 's3') {\r\n        const s3 = game.data.files.s3;\r\n        if (!s3 || !s3.buckets.includes(source.bucket)) continue;\r\n        prePend = `https://${source.bucket}.${s3.endpoint.host}`;\r\n      }\r\n      const folders = source.index.map((f) =>\r\n        this._indexToVirtualFolder(f, '', allFolders, allPresets, {\r\n          prePend,\r\n          source: source.source,\r\n          bucket: source.bucket,\r\n        })\r\n      );\r\n\r\n      if (folders?.length) {\r\n        const sFolder = new VirtualFileFolder({\r\n          uuid: 'virtual@source@' + source.source,\r\n          name: source.source,\r\n          children: folders,\r\n          types: ['ALL'],\r\n          bucket: source.bucket,\r\n        });\r\n        if (folders.some((f) => f.types.includes('Tile'))) sFolder.types.push('Tile');\r\n        if (folders.some((f) => f.types.includes('AmbientSound'))) sFolder.types.push('AmbientSound');\r\n        folders.forEach((f) => {\r\n          f.folder = sFolder.id;\r\n        });\r\n        allFolders.set(sFolder.uuid, sFolder);\r\n        topLevelFolders.push(sFolder);\r\n      }\r\n    }\r\n\r\n    let tree;\r\n    if (topLevelFolders.length) {\r\n      tree = new PresetTree({\r\n        folders: topLevelFolders,\r\n        presets: [],\r\n        allPresets,\r\n        allFolders,\r\n        hasVisible: allPresets.some((p) => p._visible),\r\n        metaDoc: null,\r\n        pack: null,\r\n      });\r\n\r\n      if (setFormVisibility) tree.setVisibility(type);\r\n    }\r\n\r\n    this._loadedTree = tree;\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n    return tree;\r\n  }\r\n\r\n  /**\r\n   * Build the directory index using the user defined paths to be scanned.\r\n   * Index structure: [{ dir: 'modules', files: [{ name: 'box.webp', tags: [] }], dirs: [] }];\r\n   */\r\n  static async buildIndex() {\r\n    if (this._buildingIndex) {\r\n      ui.notifications.warn('Index Build In-Progress. Wait for it to finish before attempting it again.');\r\n      return;\r\n    }\r\n\r\n    this._buildingIndex = true;\r\n\r\n    ui.notifications.info('Building Mass Edit directory index.');\r\n\r\n    const settings = game.settings.get(MODULE_ID, 'indexer');\r\n\r\n    try {\r\n      const scannedSources = [];\r\n      const foundCaches = [];\r\n\r\n      // Traverse directories specified in settings.indexDirs\r\n      for (const dir of settings.indexDirs) {\r\n        if (dir.source === 'forge-bazaar' || dir.source === 'forgevtt') {\r\n          await this._buildFauxForgeBrowser(dir.source, dir.target);\r\n        }\r\n        let iDir = await this.generateIndex(dir.target, foundCaches, dir.source, dir.bucket, settings);\r\n\r\n        if (iDir) {\r\n          const sPath = dir.target.split('/').filter(Boolean);\r\n          for (let i = sPath.length - 2; i >= 0; i--) {\r\n            iDir = { dir: sPath[i], dirs: [iDir] };\r\n          }\r\n\r\n          let index = scannedSources.find((i) => i.source === dir.source && i.bucket == dir.bucket);\r\n          if (index) this.mergeIndex(index.index, [iDir]);\r\n          else {\r\n            index = { source: dir.source, index: [iDir] };\r\n            if (dir.bucket) index.bucket = dir.bucket;\r\n            scannedSources.push(index);\r\n          }\r\n        }\r\n      }\r\n\r\n      // If pre-generated caches have been found we want to load and merge them here\r\n      for (const cacheFile of foundCaches) {\r\n        const cache = await this.loadIndexCache(cacheFile);\r\n        if (cache) this.mergeCaches(scannedSources, cache);\r\n      }\r\n\r\n      // User can specify if he wants the tags associated with images/video to be retained or not.\r\n      // overrideNullTagsOnly - true - will essentially override user changes to pre-cached directories\r\n      // overrideNullTagsOnly - false - pre-cached directory tags will be ignored, favoring user tags\r\n      const currentCache = await this.loadIndexCache(CACHE_PATH + '/' + CACHE_NAME);\r\n      if (currentCache) {\r\n        this.mergeCaches(scannedSources, currentCache, {\r\n          tagsOnly: true,\r\n          overrideNullTagsOnly: settings.overrideTags,\r\n        });\r\n      }\r\n\r\n      if (scannedSources.length) await this._writeIndexToCache(scannedSources);\r\n      this._loadedTree = null;\r\n\r\n      ui.notifications.info(`MassEdit Index build finished.`);\r\n    } catch (e) {\r\n      console.log(e);\r\n    }\r\n\r\n    this._buildingIndex = false;\r\n  }\r\n\r\n  static mergeCaches(cacheTo, cacheFrom, { tagsOnly = false, overrideNullTagsOnly = false } = {}) {\r\n    for (const indexSourceFrom of cacheFrom) {\r\n      const indexSourceTo = cacheTo.find(\r\n        (i) => i.source === indexSourceFrom.source && i.bucket == indexSourceFrom.bucket\r\n      );\r\n      if (indexSourceTo) {\r\n        this.mergeIndex(indexSourceTo.index, indexSourceFrom.index, {\r\n          tagsOnly,\r\n          overrideNullTagsOnly,\r\n        });\r\n      } else if (!tagsOnly) cacheTo.push(indexSourceFrom);\r\n    }\r\n  }\r\n\r\n  // options to only merge tags if they didn't have any\r\n  static mergeIndex(indexTo, indexFrom, { tagsOnly = false, overrideNullTagsOnly = false } = {}) {\r\n    for (const dirFrom of indexFrom) {\r\n      const dirTo = indexTo.find((dir) => dir.dir === dirFrom.dir);\r\n      if (dirTo) {\r\n        // TODO: We may want to merge customizable fields here\r\n        if (!tagsOnly) {\r\n          dirTo.icon = dirFrom.icon;\r\n          dirTo.subtext = dirFrom.subtext;\r\n        }\r\n\r\n        // Merge directories\r\n        if (dirFrom.dirs) {\r\n          if (dirTo.dirs) {\r\n            this.mergeIndex(dirTo.dirs, dirFrom.dirs, { tagsOnly, overrideNullTagsOnly });\r\n          } else if (!tagsOnly) {\r\n            dirTo.dirs = dirFrom.dirs;\r\n          }\r\n        }\r\n\r\n        // Merge files\r\n        if (dirFrom.files) {\r\n          if (dirTo.files) {\r\n            for (const fileFrom of dirFrom.files) {\r\n              const fileTo = dirTo.files?.find((f) => f.name === fileFrom.name);\r\n\r\n              if (fileTo) {\r\n                // TODO: We may want to merge customizable fields here\r\n                if (!overrideNullTagsOnly || fileTo.tags == null) fileTo.tags = fileFrom.tags;\r\n              } else if (!tagsOnly) {\r\n                if (!dirTo.files) dirTo.files = [];\r\n                dirTo.files.push(fileFrom);\r\n              }\r\n            }\r\n          } else if (!tagsOnly) dirTo.files = dirFrom.files;\r\n        }\r\n      } else if (!tagsOnly) indexTo.push(dirFrom);\r\n    }\r\n  }\r\n\r\n  static async getPreset(uuid) {\r\n    if (!this._loadedTree) await FileIndexer.getVirtualDirectoryTree();\r\n    if (!this._loadedTree) return null;\r\n    return this._loadedTree.allPresets.find((p) => p.uuid === uuid);\r\n  }\r\n\r\n  static async saveIndexToCache(\r\n    folders = this._loadedTree?.folders,\r\n    { path = CACHE_PATH, notify = true, source = 'data' } = {}\r\n  ) {\r\n    if (folders) {\r\n      const cache = [];\r\n      for (const sourceFolder of folders) {\r\n        const sourceCache = {\r\n          source: sourceFolder.name,\r\n          index: sourceFolder.children.map((f) => this._cacheFolder(f)),\r\n        };\r\n        if (sourceFolder.bucket) sourceCache.bucket = sourceFolder.bucket;\r\n        cache.push(sourceCache);\r\n      }\r\n\r\n      this._writeIndexToCache(cache, { path, notify, source });\r\n    }\r\n  }\r\n\r\n  static async _writeIndexToCache(index, { path = CACHE_PATH, notify = true, source = 'data' } = {}) {\r\n    const str = JSON.stringify(index);\r\n\r\n    const tFile = await StringCompress.compress(str);\r\n    await FilePicker.upload(source, path, tFile, {}, { notify });\r\n  }\r\n\r\n  static async saveFolderToCache(folder) {\r\n    if (!(this._loadedTree || folder.indexable || folder.source)) return;\r\n    const allFolders = this._loadedTree.allFolders;\r\n\r\n    let wFolder = folder;\r\n    while (wFolder.folder) {\r\n      let pFolder;\r\n      for (const [uuid, folder] of allFolders) {\r\n        if (folder.id === wFolder.folder) {\r\n          pFolder = folder;\r\n          break;\r\n        }\r\n      }\r\n      if (!pFolder) return;\r\n\r\n      pFolder = new VirtualFileFolder({\r\n        name: pFolder.name,\r\n        folder: pFolder.folder,\r\n      });\r\n      if (wFolder) pFolder.children = [wFolder];\r\n      wFolder = pFolder;\r\n    }\r\n\r\n    this.saveIndexToCache([wFolder], { path: folder.uuid.replace('virtual@', ''), source: folder.source });\r\n  }\r\n\r\n  static _cacheFolder(folder) {\r\n    const fDic = { dir: encodeURIComponentSafely(folder.name) };\r\n    if (folder.presets.length) fDic.files = folder.presets.map((p) => this._cachePreset(p));\r\n    if (folder.children.length) fDic.dirs = folder.children.map((c) => this._cacheFolder(c));\r\n    return fDic;\r\n  }\r\n\r\n  static _cachePreset(preset) {\r\n    const pDic = { name: encodeURIComponentSafely(preset.name) };\r\n    if (preset.tags?.length) pDic.tags = preset.tags;\r\n    return pDic;\r\n  }\r\n\r\n  static async loadIndexCache(cacheFile) {\r\n    let cache;\r\n    try {\r\n      cache = await StringCompress.decompressCache(cacheFile);\r\n    } catch (error) {\r\n      ui.notifications.warn(`Failed to load cache: ` + cacheFile);\r\n    }\r\n    return cache;\r\n  }\r\n\r\n  static async loadMainIndexCache() {\r\n    let path;\r\n    if (typeof ForgeVTT !== 'undefined' && ForgeVTT.usingTheForge) {\r\n      const userId = await ForgeAPI.getUserId();\r\n      path = `https://assets.forge-vtt.com/${userId}/${CACHE_NAME}`;\r\n    } else {\r\n      path = CACHE_PATH + '/' + CACHE_NAME;\r\n    }\r\n    return await this.loadIndexCache(path);\r\n  }\r\n\r\n  static _indexToVirtualFolder(cache, parentDirPath, allFolders, allPresets, options) {\r\n    const fullPath = parentDirPath + '/' + cache.dir;\r\n    const uuid = 'virtual@' + options.prePend + fullPath;\r\n    const fileFolder = new VirtualFileFolder({\r\n      uuid,\r\n      name: cache.dir,\r\n      subtext: cache.subtext,\r\n      icon: cache.icon,\r\n      color: cache.color,\r\n      source: options.source,\r\n      bucket: options.bucket,\r\n    });\r\n\r\n    if (cache.dirs) {\r\n      for (const dir of cache.dirs) {\r\n        const childFolder = this._indexToVirtualFolder(dir, fullPath, allFolders, allPresets, options);\r\n        if (childFolder) {\r\n          childFolder.folder = fileFolder.id;\r\n          fileFolder.children.push(childFolder);\r\n        }\r\n      }\r\n      fileFolder.children.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n    }\r\n\r\n    if (cache.files) {\r\n      for (const file of cache.files) {\r\n        const preset = new VirtualFilePreset({\r\n          name: file.name,\r\n          src: options.prePend + fullPath + '/' + file.name,\r\n          tags: file.tags,\r\n          folder: fileFolder.id,\r\n        });\r\n        allPresets.push(preset);\r\n        fileFolder.presets.push(preset);\r\n      }\r\n    }\r\n\r\n    // Assign folder to categories based on whether the folder itself or\r\n    // it's child folders contain presets of those types\r\n    ['Tile', 'AmbientSound'].forEach((type) => {\r\n      if (\r\n        fileFolder.presets.some((p) => p.documentName === type) ||\r\n        fileFolder.children.some((c) => c.types.includes(type))\r\n      ) {\r\n        fileFolder.types.push(type);\r\n      }\r\n    });\r\n\r\n    allFolders.set(uuid, fileFolder);\r\n    return fileFolder;\r\n  }\r\n\r\n  static async generateIndex(dir, foundCaches = [], source = 'data', bucket = null, settings, options = {}, tags = []) {\r\n    // Get options associated to this specific directory\r\n    let opts = options[dir] ?? {};\r\n    if (opts.noscan) return null;\r\n\r\n    // Get directory contents\r\n    // contents.dirs -> array of children directories\r\n    // contents.files -> array of contained files\r\n    let content;\r\n    try {\r\n      content = await this._browse(source, dir, { bucket });\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n\r\n    const indexerFile = content.files.find((f) => f.endsWith('indexer.json'));\r\n    if (indexerFile) {\r\n      options = (await readJSONFile(indexerFile)) ?? {};\r\n      opts = options[dir] ?? {};\r\n      if (opts.noscan) return null;\r\n    }\r\n\r\n    if (opts.tags) {\r\n      tags = opts.tags\r\n        .map((t) => TagInput.simplifyString(t))\r\n        .filter(Boolean)\r\n        .concat(tags);\r\n    }\r\n\r\n    const folder = {\r\n      dir: dir.split('/').filter(Boolean).pop(),\r\n      dirs: [],\r\n      files: [],\r\n    };\r\n    if (settings.folderFilters.some((k) => folder.dir.includes(k))) return null;\r\n    if (!foundry.utils.isEmpty(opts)) {\r\n      ['color', 'icon', 'subtext'].forEach((k) => {\r\n        if (opts[k]) folder[k] = opts[k];\r\n      });\r\n    }\r\n\r\n    for (let path of content.files) {\r\n      const fileName = path.split('\\\\').pop().split('/').pop();\r\n      if (settings.fileFilters.some((k) => fileName.includes(k))) continue;\r\n\r\n      // Special file processing\r\n\r\n      // Cancel indexing if noscan.txt or cache file is present within the directory\r\n      if (fileName === 'noscan.txt') return null;\r\n      else if (fileName === CACHE_NAME && !settings.ignoreExternal) {\r\n        const cacheDir = settings.cacheDir;\r\n        if (!(cacheDir.target === dir.target && cacheDir.source === source && cacheDir.bucket === bucket)) {\r\n          foundCaches.push(path);\r\n          return null;\r\n        }\r\n      } else if (fileName === 'module.json') {\r\n        // Read metadata from module's json file applying subtext to current folder\r\n        // and tags to all files\r\n        const author = await this._getAuthorFromModule(path);\r\n        if (author) {\r\n          folder.subtext = opts.subtext ?? author;\r\n          const tag = TagInput.simplifyString(author.split(/[ ,\\-_@]+/)[0] ?? '');\r\n          if (tag && tag.length >= 3) {\r\n            tags = [...tags, tag];\r\n            folder.files.forEach((f) => {\r\n              f.tags = tags;\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      // Otherwise process the file\r\n      let ext = fileName.split('.');\r\n      ext = ext[ext.length - 1].toLowerCase();\r\n\r\n      if (FILE_EXTENSIONS.includes(ext)) {\r\n        const f = { name: fileName };\r\n        if (tags.length) f.tags = tags;\r\n        folder.files.push(f);\r\n      }\r\n    }\r\n\r\n    for (let dir of content.dirs) {\r\n      dir = await this.generateIndex(dir, foundCaches, source, bucket, settings, options, tags);\r\n      if (dir) folder.dirs.push(dir);\r\n    }\r\n\r\n    if (!folder.dirs.length) delete folder.dirs;\r\n    if (!folder.files.length) delete folder.files;\r\n\r\n    if (!(folder.dirs || folder.files)) return null;\r\n    return folder;\r\n  }\r\n\r\n  static async _browse(source, dir, options) {\r\n    if (source === 'forge-bazaar' || source === 'forgevtt') {\r\n      return this._fauxForgeBrowser?.get(dir) ?? { dirs: [], files: [] };\r\n    } else {\r\n      return await FilePicker.browse(source, dir, options);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ForgeVTT forge-bazaar can be browsed recursively returning all the found dirs and files at a given path.\r\n   * To keep the processing consistent between different sources however we will simulate FilePicker.browse results\r\n   * by rebuilding the directory structure using the recursively retrieved results.\r\n   * This faux structure will be used by FileIndexer._browse(...)\r\n   * @param {String} source forge-bazaar or forgevtt\r\n   * @param {String} dir\r\n   */\r\n  static async _buildFauxForgeBrowser(source, dir) {\r\n    this._fauxForgeBrowser = new Map();\r\n\r\n    if (typeof ForgeVTT === 'undefined' || !ForgeVTT.usingTheForge) {\r\n      return;\r\n    }\r\n\r\n    // Recursion doesn't work for forge-bazaar paths at one level above root. Perform non-recursive browse\r\n    // and then recursive one on all of the retrieved dirs\r\n    let paths;\r\n    if (source === 'forgevtt' || !['modules', 'systems', 'worlds', 'assets'].includes(dir.replaceAll(/[\\/\\\\]/g, ''))) {\r\n      paths = [dir];\r\n    } else {\r\n      const contents = await FilePicker.browse(source, dir, { recursive: false });\r\n      paths = contents.dirs;\r\n    }\r\n\r\n    const insertFile = (dirs, file) => {\r\n      for (let i = 1; i < dirs.length + 1; i++) {\r\n        const pDirPath = dirs.slice(0, i).join('/');\r\n        const chDirPath = dirs.slice(0, i + 1).join('/');\r\n\r\n        let pDir = this._fauxForgeBrowser.get(pDirPath);\r\n        if (!pDir) {\r\n          pDir = { dirs: [], files: [] };\r\n          this._fauxForgeBrowser.set(pDirPath, pDir);\r\n        }\r\n        if (pDirPath === chDirPath) pDir.files.push(file);\r\n        else if (!pDir.dirs.includes(chDirPath)) pDir.dirs.push(chDirPath);\r\n      }\r\n    };\r\n\r\n    for (const path of paths) {\r\n      const contents = await FilePicker.browse(source, path, { recursive: true });\r\n      for (const file of contents.files) {\r\n        const pathname = new URL(file).pathname;\r\n        const components = pathname.split('/');\r\n        insertFile(components.slice(2, components.length - 1), components.slice(2).join('/'));\r\n      }\r\n    }\r\n  }\r\n\r\n  static async _getAuthorFromModule(moduleFile) {\r\n    const module = await readJSONFile(moduleFile);\r\n    if (module) {\r\n      const author = module.author ?? module.authors?.[0]?.name;\r\n      if (typeof author === 'string') return author;\r\n    }\r\n    return null;\r\n  }\r\n}\r\n\r\nclass StringCompress {\r\n  /**\r\n   * Compresses the provided string using native gzip implementation and return it as a File ready to be uploaded.\r\n   * @param {String} str string to be compressed\r\n   * @returns {File} compressed string file\r\n   */\r\n  static async compress(str) {\r\n    const stream = new Blob([str]).stream();\r\n    const compressedStream = stream.pipeThrough(new CompressionStream('gzip'));\r\n    const chunks = [];\r\n    for await (const chunk of this.streamAsyncIterator(compressedStream)) {\r\n      chunks.push(chunk);\r\n    }\r\n    const blob = new Blob(chunks);\r\n    const file = new File([blob], CACHE_NAME);\r\n    return file;\r\n  }\r\n\r\n  /**\r\n   * Decompressed provided compressed json file\r\n   * @param {String} filePath path to the compressed json file\r\n   * @returns {Object} decompressed and parsed json object\r\n   */\r\n  static async decompressCache(filePath) {\r\n    let cache;\r\n    try {\r\n      const response = await fetch(filePath);\r\n      if (response.ok) {\r\n        const str = await this.decompress(response.body);\r\n        cache = JSON.parse(str);\r\n      }\r\n    } catch (e) {}\r\n    return cache;\r\n  }\r\n\r\n  static async decompress(stream) {\r\n    const decompressedStream = stream.pipeThrough(new DecompressionStream('gzip'));\r\n    const chunks = [];\r\n    for await (const chunk of this.streamAsyncIterator(decompressedStream)) {\r\n      chunks.push(chunk);\r\n    }\r\n    const stringBytes = await this.concatUint8Arrays(chunks);\r\n    return new TextDecoder().decode(stringBytes);\r\n  }\r\n\r\n  static async concatUint8Arrays(uint8arrays) {\r\n    const blob = new Blob(uint8arrays);\r\n    const buffer = await blob.arrayBuffer();\r\n    return new Uint8Array(buffer);\r\n  }\r\n\r\n  static async *streamAsyncIterator(stream) {\r\n    const reader = stream.getReader();\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) return;\r\n        yield value;\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Form to help configure and execute index build.\r\n */\r\nexport class IndexerForm extends FormApplication {\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/indexer.html`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return 'Directory Indexer';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    const data = foundry.utils.deepClone(game.settings.get(MODULE_ID, 'indexer'));\r\n    data.fileFilters = data.fileFilters.join(', ');\r\n    data.folderFilters = data.folderFilters.join(', ');\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.on('click', '.addDirectory', this._onAddDirectory.bind(this));\r\n    html.on('click', '.deleteDirectory', this._onDeleteDirectory.bind(this));\r\n    html.on('input', '[name=\"fileFilters\"]', this._onFileFiltersChange.bind(this));\r\n    html.on('input', '[name=\"folderFilters\"]', this._onFolderFiltersChange.bind(this));\r\n    html.find('input[type=\"checkbox\"]').on('change', this._onToggleCheckbox.bind(this));\r\n  }\r\n\r\n  _onToggleCheckbox(event) {\r\n    const chkBox = $(event.currentTarget);\r\n    const name = chkBox.attr('name');\r\n    this._updateIndexerSettings({ [name]: chkBox.is(':checked') }, false);\r\n  }\r\n\r\n  _onFileFiltersChange(event) {\r\n    clearTimeout(this._onInputTimeOut);\r\n    this._onInputTimeOut = setTimeout(() => {\r\n      const fileFilters = $(event.currentTarget)\r\n        .val()\r\n        .split(',')\r\n        .map((f) => f.trim())\r\n        .filter(Boolean);\r\n      this._updateIndexerSettings({ fileFilters }, false);\r\n    }, 500);\r\n  }\r\n\r\n  _onFolderFiltersChange(event) {\r\n    clearTimeout(this._onInputTimeOut);\r\n    this._onInputTimeOut = setTimeout(() => {\r\n      const folderFilters = $(event.currentTarget)\r\n        .val()\r\n        .split(',')\r\n        .map((f) => f.trim())\r\n        .filter(Boolean);\r\n      this._updateIndexerSettings({ folderFilters }, false);\r\n    }, 500);\r\n  }\r\n\r\n  async _onAddDirectory() {\r\n    this.selectFolder(async (selection) => {\r\n      if (!selection) return;\r\n      if (!selection.bucket) delete selection.bucket;\r\n\r\n      // TODO add support for s3\r\n      if (!['data', 'public', 'forge-bazaar', 'forgevtt', 's3'].includes(selection.source)) {\r\n        ui.notifications.warn(`${selection.source} is not a supported source.`);\r\n        return;\r\n      }\r\n\r\n      const indexDirs = game.settings.get(MODULE_ID, 'indexer').indexDirs;\r\n      // Make sure the selection is unique\r\n      if (\r\n        indexDirs.find(\r\n          (id) => id.source === selection.source && id.target === selection.target && id.bucket == selection.bucket\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      indexDirs.push(selection);\r\n      this._updateIndexerSettings({ indexDirs });\r\n    });\r\n  }\r\n\r\n  async _onDeleteDirectory(event) {\r\n    const directory = $(event.target).closest('.directory');\r\n    const source = directory.find('.source').val();\r\n    const target = directory.find('.target').val();\r\n    const bucket = directory.find('.bucket').val() || null;\r\n\r\n    const indexDirs = game.settings\r\n      .get(MODULE_ID, 'indexer')\r\n      .indexDirs.filter((id) => !(id.source === source && id.target === target && id.bucket == bucket));\r\n\r\n    this._updateIndexerSettings({ indexDirs });\r\n  }\r\n\r\n  async _updateIndexerSettings(update = {}, render = true) {\r\n    const settings = game.settings.get(MODULE_ID, 'indexer');\r\n    foundry.utils.mergeObject(settings, update);\r\n    await game.settings.set(MODULE_ID, 'indexer', settings);\r\n    if (render) await this.render();\r\n  }\r\n\r\n  async selectFolder(callback) {\r\n    new FilePicker({\r\n      type: 'folder',\r\n      activeSource: 'data',\r\n      current: '',\r\n      callback: (path, fp) => {\r\n        const selection = { target: fp.result.target, source: fp.activeSource, bucket: fp.result.bucket };\r\n        if (!selection.bucket) delete selection.bucket;\r\n        callback(selection);\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    FileIndexer.buildIndex();\r\n  }\r\n}\r\n\r\nexport class FileIndexerAPI {\r\n  static async readCacheFile(cacheFile) {\r\n    return FileIndexer.loadIndexCache(cacheFile);\r\n  }\r\n}\r\n","class TrackerDialog extends Dialog {\r\n  constructor(options, { total, cancelCallback, left, top }) {\r\n    super(options, { left, top });\r\n    this.count = 0;\r\n    this.total = total;\r\n    this.cancelCallback = cancelCallback;\r\n  }\r\n\r\n  incrementCount() {\r\n    this.count++;\r\n    this.element?.find('.count').html(this.count);\r\n  }\r\n\r\n  stop() {\r\n    this.close(true);\r\n  }\r\n\r\n  get active() {\r\n    return this._state === Application.RENDER_STATES.RENDERED || this._state === Application.RENDER_STATES.RENDERING;\r\n  }\r\n}\r\n\r\nexport async function trackProgress({ title = 'Progress', cancelCallback, total } = {}) {\r\n  if (!total) return;\r\n\r\n  let content = `\r\n<div>\r\n<div  style=\"display: block; text-align: center; padding: 5px;\"><i class=\"fas fa-circle-notch fa-spin fa-3x\"></i></div>\r\n    <p style=\"text-align: center;\"><span class=\"count\">count</span>/${total}</p>\r\n</div>`;\r\n\r\n  const dialog = new TrackerDialog(\r\n    {\r\n      title,\r\n      content,\r\n      buttons: {\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-stop\"></i>',\r\n          label: 'Stop/Cancel',\r\n          callback: () => {\r\n            cancelCallback?.();\r\n          },\r\n        },\r\n      },\r\n      default: 'cancel',\r\n    },\r\n    { total, cancelCallback, left: 50, top: 50 }\r\n  );\r\n\r\n  await dialog._render(true);\r\n\r\n  return dialog;\r\n}\r\n\r\nexport function countFolderItems(folder) {\r\n  if (folder.presets) {\r\n    return (\r\n      folder.presets.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c);\r\n      }, 0)\r\n    );\r\n  } else {\r\n    return (\r\n      folder.contents.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c.folder);\r\n      }, 0)\r\n    );\r\n  }\r\n}\r\n","/**\r\n * A collection of functions related to sorting objects within a parent container.\r\n */\r\nexport class SortingHelpersFixed {\r\n  /**\r\n   * Given a source object to sort, a target to sort relative to, and an Array of siblings in the container:\r\n   * Determine the updated sort keys for the source object, or all siblings if a reindex is required.\r\n   * Return an Array of updates to perform, it is up to the caller to dispatch these updates.\r\n   * Each update is structured as:\r\n   * {\r\n   *   target: object,\r\n   *   update: {sortKey: sortValue}\r\n   * }\r\n   *\r\n   * @param {object} source       The source object being sorted\r\n   * @param {object} [options]    Options which modify the sort behavior\r\n   * @param {object|null} [options.target]  The target object relative which to sort\r\n   * @param {object[]} [options.siblings]   The Array of siblings which the source should be sorted within\r\n   * @param {string} [options.sortKey=sort] The property name within the source object which defines the sort key\r\n   * @param {boolean} [options.sortBefore]  Explicitly sort before (true) or sort after( false).\r\n   *                                        If undefined the sort order will be automatically determined.\r\n   * @returns {object[]}          An Array of updates for the caller of the helper function to perform\r\n   */\r\n  static performIntegerSort(\r\n    source,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > 1) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: Math.round(0.5 * (min + max)) },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Reindex all siblings\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, source);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  static performIntegerSortMulti(\r\n    sources,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    let source = sources[0];\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY * (sources.length - i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > sources.length) {\r\n      let increment = Math.floor((1 / (sources.length + 1)) * Math.abs(max - min));\r\n      if (increment === 0) increment = 1;\r\n      min = Math.min(max, min);\r\n\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + increment * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Reindex all\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, ...sources);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort before the target\r\n   * @private\r\n   */\r\n  static _sortBefore(siblings, idx, sortKey) {\r\n    let max = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let min = siblings[idx - 1] ? siblings[idx - 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort after the target\r\n   * @private\r\n   */\r\n  static _sortAfter(siblings, idx, sortKey) {\r\n    let min = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let max = siblings[idx + 1] ? siblings[idx + 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n}\r\n","import { TokenDataAdapter } from '../../applications/dataAdapters.js';\r\nimport { copyToClipboard, pasteDataUpdate } from '../../applications/forms.js';\r\nimport { showMassEdit } from '../../applications/multiConfig.js';\r\nimport { countFolderItems, trackProgress } from '../../applications/progressDialog.js';\r\nimport { BrushMenu } from '../brush.js';\r\nimport { importPresetFromJSONDialog } from '../dialogs.js';\r\nimport { SortingHelpersFixed } from '../fixedSort.js';\r\nimport {\r\n  MODULE_ID,\r\n  SUPPORTED_PLACEABLES,\r\n  TagInput,\r\n  UI_DOCS,\r\n  applyPresetToScene,\r\n  localFormat,\r\n  localize,\r\n} from '../utils.js';\r\nimport {\r\n  VirtualFileFolder,\r\n  META_INDEX_ID,\r\n  PresetAPI,\r\n  PresetCollection,\r\n  PresetPackFolder,\r\n  PresetFolder,\r\n} from './collection.js';\r\nimport { FileIndexer, IndexerForm } from './fileIndexer.js';\r\nimport { DOC_ICONS, Preset, VirtualFilePreset } from './preset.js';\r\nimport { FolderState, mergePresetDataToDefaultDoc, placeableToData, randomizeChildrenFolderColors } from './utils.js';\r\n\r\nconst SEARCH_MIN_CHAR = 2;\r\nconst SEARCH_FOUND_MAX_COUNT = 1001;\r\n\r\n// const FLAG_DATA = {\r\n//   documentName: null,\r\n//   data: null,\r\n//   addSubtract: null,\r\n//   randomize: null,\r\n// };\r\n\r\nconst SORT_MODES = {\r\n  manual: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeManual', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-short-wide\"></i>',\r\n  },\r\n  alphabetical: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeAlpha', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-a-z\"></i>',\r\n  },\r\n};\r\n\r\nconst SEARCH_MODES = {\r\n  p: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets');\r\n    },\r\n    icon: '<i class=\"fas fa-search\"></i>',\r\n  },\r\n  pf: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets-folders');\r\n    },\r\n    icon: '<i class=\"fa-solid fa-folder-magnifying-glass\"></i>',\r\n  },\r\n};\r\n\r\nexport class MassEditPresets extends FormApplication {\r\n  static objectHover = false;\r\n  static lastSearch;\r\n\r\n  constructor(configApp, callback, docName, options = {}) {\r\n    // Restore position and dimensions the previously closed window\r\n    if (!options.preventPositionOverride && MassEditPresets.previousPosition) {\r\n      options = { ...options, ...MassEditPresets.previousPosition };\r\n    }\r\n\r\n    super({}, options);\r\n    this.callback = callback;\r\n\r\n    // Drag/Drop tracking\r\n    this.dragType = null;\r\n    this.dragData = null;\r\n    this.draggedElements = null;\r\n\r\n    if (!configApp && UI_DOCS.includes(docName)) {\r\n      const docLock = game.settings.get(MODULE_ID, 'presetDocLock');\r\n      this.docName = docLock || docName;\r\n    } else {\r\n      this.configApp = configApp;\r\n      this.docName = docName || this.configApp.documentName;\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-presets',\r\n      classes: ['sheet', 'mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presets.html`,\r\n      resizable: true,\r\n      minimizable: true,\r\n      width: 360,\r\n      height: 900,\r\n      scrollY: ['.item-list'],\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    let title = localize('common.presets');\r\n    if (!UI_DOCS.includes(this.docName)) title += ` [${this.docName}]`;\r\n    else title += ` [${localize('common.placeable')}]`;\r\n    return title;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/preset.html`, 'me-preset');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/presetFolder.html`, 'me-preset-folder');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/preset/presetsContent.html`, 'me-presets-content');\r\n\r\n    const displayExtCompendiums = game.settings.get(MODULE_ID, 'presetExtComp');\r\n    const displayVirtualDirectory = game.settings.get(MODULE_ID, 'presetVirtualDir');\r\n\r\n    this.tree = await PresetCollection.getTree(this.docName, {\r\n      externalCompendiums: displayExtCompendiums,\r\n      virtualDirectory: displayVirtualDirectory,\r\n      setFormVisibility: true,\r\n    });\r\n    data.presets = this.tree.presets;\r\n    data.folders = this.tree.folders;\r\n    data.extFolders = this.tree.extFolders.length ? this.tree.extFolders : null;\r\n\r\n    data.createEnabled = Boolean(this.configApp);\r\n    data.isPlaceable =\r\n      SUPPORTED_PLACEABLES.includes(this.docName) || this.docName === 'ALL' || this.docName === 'FAVORITES';\r\n    data.allowDocumentSwap = UI_DOCS.includes(this.docName) && !this.configApp;\r\n    data.docLockActive = game.settings.get(MODULE_ID, 'presetDocLock') === this.docName;\r\n    data.layerSwitchActive = game.settings.get(MODULE_ID, 'presetLayerSwitch');\r\n    data.scaling = game.settings.get(MODULE_ID, 'presetScaling');\r\n    data.extCompActive = displayExtCompendiums;\r\n    data.virtDirActive = displayVirtualDirectory;\r\n    data.sortMode = SORT_MODES[game.settings.get(MODULE_ID, 'presetSortMode')];\r\n    data.searchMode = SEARCH_MODES[game.settings.get(MODULE_ID, 'presetSearchMode')];\r\n    data.displayDragDropMessage =\r\n      data.allowDocumentSwap && !(this.tree.presets.length || this.tree.folders.length || data.extFolders);\r\n    data.canvas3dActive = Boolean(game.Levels3DPreview?._active);\r\n\r\n    data.lastSearch = MassEditPresets.lastSearch;\r\n\r\n    data.docs = UI_DOCS.reduce((obj, key) => {\r\n      return {\r\n        ...obj,\r\n        [key]: DOC_ICONS[key],\r\n      };\r\n    }, {});\r\n\r\n    data.documents = UI_DOCS;\r\n    data.currentDocument = this.docName;\r\n\r\n    data.callback = Boolean(this.callback);\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          MassEditPresets.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          MassEditPresets.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        hoverOverlay.hide();\r\n        MassEditPresets.objectHover = false;\r\n      });\r\n\r\n    // Create Preset from Selected\r\n    html.find('.create-preset').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // =====================\r\n    // Preset multi-select & drag Listeners\r\n    const itemList = html.find('.item-list');\r\n\r\n    // Multi-select\r\n    html.on('click', '.item', (event) => {\r\n      itemSelect(event, itemList);\r\n      if (this._activeBrush) this._toggleBrush(event);\r\n    });\r\n\r\n    // Hide/Show preset tags and favorite control\r\n    html.on('mouseenter', '.item', (event) => {\r\n      $(event.currentTarget).find('.tags, .display-hover').addClass('show');\r\n    });\r\n\r\n    html.on('mouseleave', '.item', (event) => {\r\n      $(event.currentTarget).find('.tags, .display-hover').removeClass('show');\r\n    });\r\n\r\n    html.on('dragstart', '.item', (event) => {\r\n      this.dragType = 'item';\r\n\r\n      const item = $(event.target).closest('.item');\r\n\r\n      // Drag has been started on an item that hasn't been selected\r\n      // Assume that this is the only item to be dragged and select it\r\n      if (!item.hasClass('selected')) {\r\n        itemList.find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n        item.addClass('selected').addClass('last-selected');\r\n      }\r\n\r\n      const uuids = [];\r\n      itemList.find('.item.selected').each(function () {\r\n        uuids.push($(this).data('uuid'));\r\n      });\r\n      this.dragData = uuids;\r\n      this.draggedElements = itemList.find('.item.selected');\r\n    });\r\n    html.on('dragleave', '.item.sortable', (event) => {\r\n      $(event.target).closest('.item').removeClass('drag-bot').removeClass('drag-top');\r\n    });\r\n\r\n    html.on('dragover', '.item.sortable', (event) => {\r\n      if (this.dragType !== 'item') return;\r\n      if (!this.draggedElements.hasClass('sortable')) return;\r\n\r\n      const targetItem = $(event.target).closest('.item');\r\n\r\n      // Check that we're not above a selected item  (i.e. item being dragged)\r\n      if (targetItem.hasClass('selected')) return;\r\n\r\n      // Determine if mouse is hovered over top, middle, or bottom\r\n      var domRect = event.currentTarget.getBoundingClientRect();\r\n      let prc = event.offsetY / domRect.height;\r\n\r\n      if (prc < 0.2) {\r\n        targetItem.removeClass('drag-bot').addClass('drag-top');\r\n      } else if (prc > 0.8) {\r\n        targetItem.removeClass('drag-top').addClass('drag-bot');\r\n      }\r\n    });\r\n\r\n    html.on('drop', '.item.sortable', (event) => {\r\n      if (MassEditPresets.lastSearch?.length) return; // Prevent drops while searching\r\n      if (this.dragType !== 'item') return;\r\n      if (!this.draggedElements.hasClass('sortable')) return;\r\n\r\n      const targetItem = $(event.target).closest('.item');\r\n\r\n      const top = targetItem.hasClass('drag-top');\r\n      targetItem.removeClass('drag-bot').removeClass('drag-top');\r\n\r\n      const uuids = this.dragData;\r\n      if (uuids) {\r\n        if (!targetItem.hasClass('selected')) {\r\n          // Move HTML Elements\r\n          (top ? uuids : uuids.reverse()).forEach((uuid) => {\r\n            const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n            if (item) {\r\n              if (top) item.insertBefore(targetItem);\r\n              else item.insertAfter(targetItem);\r\n            }\r\n          });\r\n\r\n          this._onItemSort(uuids, targetItem.data('uuid'), {\r\n            before: top,\r\n            folderUuid: targetItem.closest('.folder').data('uuid'),\r\n          });\r\n        }\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n\r\n    html.on('dragend', '.item', (event) => {\r\n      if (!checkMouseInWindow(event)) {\r\n        this._onPresetDragOut(event);\r\n      }\r\n    });\r\n\r\n    // ================\r\n    // Folder Listeners\r\n    html.on('click', '.folder > header', (event) => this._folderToggle($(event.target).closest('.folder')));\r\n\r\n    html.on('dragstart', '.folder.sortable', (event) => {\r\n      if (this.dragType == 'item') return;\r\n      this.dragType = 'folder';\r\n\r\n      const folder = $(event.target).closest('.folder');\r\n      const uuids = [folder.data('uuid')];\r\n\r\n      $(event.target)\r\n        .find('.folder')\r\n        .each(function () {\r\n          uuids.push($(this).data('uuid'));\r\n        });\r\n\r\n      this.dragData = uuids;\r\n    });\r\n\r\n    html.on('dragleave', '.folder.sortable header', (event) => {\r\n      $(event.target).closest('.folder').removeClass('drag-mid').removeClass('drag-top');\r\n    });\r\n\r\n    html.on('dragover', '.folder.sortable header', (event) => {\r\n      const targetFolder = $(event.target).closest('.folder');\r\n\r\n      if (this.dragType === 'folder') {\r\n        // Check that we're not above folders being dragged\r\n        if (this.dragData.includes(targetFolder.data('uuid'))) return;\r\n\r\n        // Determine if mouse is hovered over top, middle, or bottom\r\n        var domRect = event.currentTarget.getBoundingClientRect();\r\n        let prc = event.offsetY / domRect.height;\r\n\r\n        if (prc < 0.2) {\r\n          targetFolder.removeClass('drag-mid').addClass('drag-top');\r\n        } else {\r\n          targetFolder.removeClass('drag-top').addClass('drag-mid');\r\n        }\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n        targetFolder.addClass('drag-mid');\r\n      }\r\n    });\r\n\r\n    html.on('drop', '.folder.sortable header', (event) => {\r\n      if (this._foundryDrop(event)) return;\r\n      if (MassEditPresets.lastSearch?.length) return; // Prevent drops while searching\r\n\r\n      const targetFolder = $(event.target).closest('.folder');\r\n\r\n      if (this.dragType === 'folder') {\r\n        const top = targetFolder.hasClass('drag-top');\r\n        targetFolder.removeClass('drag-mid').removeClass('drag-top');\r\n\r\n        const uuids = this.dragData;\r\n        if (uuids) {\r\n          if (uuids.includes(targetFolder.data('uuid'))) return;\r\n\r\n          const uuid = uuids[0];\r\n          const folder = html.find(`.folder[data-uuid=\"${uuid}\"]`);\r\n          if (folder) {\r\n            // Move HTML Elements\r\n            if (top) folder.insertBefore(targetFolder);\r\n            else targetFolder.find('.folder-items').first().append(folder);\r\n\r\n            if (top) {\r\n              this._onFolderSort(uuid, targetFolder.data('uuid'), {\r\n                inside: false,\r\n                folderUuid: targetFolder.parent().closest('.folder').data('uuid') ?? null,\r\n              });\r\n            } else {\r\n              this._onFolderSort(uuid, null, {\r\n                inside: true,\r\n                folderUuid: targetFolder.data('uuid'),\r\n              });\r\n            }\r\n          }\r\n        }\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n        targetFolder.removeClass('drag-mid');\r\n        const uuids = this.dragData;\r\n\r\n        // Move HTML Elements\r\n        const presetItems = targetFolder.children('.preset-items');\r\n        uuids?.forEach((uuid) => {\r\n          const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n          if (item.length) presetItems.append(item);\r\n        });\r\n\r\n        this._onItemSort(uuids, null, {\r\n          folderUuid: targetFolder.data('uuid'),\r\n        });\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n\r\n    html.on('drop', '.top-level-preset-items', (event) => {\r\n      if (this._foundryDrop(event)) return;\r\n      if (MassEditPresets.lastSearch?.length) return; // Prevent drops while searching\r\n      if (this.dragType === 'folder') {\r\n        // Move HTML Elements\r\n        const target = html.find('.top-level-folder-items');\r\n        const folder = html.find(`.folder[data-uuid=\"${this.dragData[0]}\"]`);\r\n        target.append(folder);\r\n\r\n        this._onFolderSort(this.dragData[0], null);\r\n      } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n        const uuids = this.dragData;\r\n\r\n        // Move HTML Elements\r\n        const target = html.find('.top-level-preset-items');\r\n        uuids?.forEach((uuid) => {\r\n          const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n          if (item.length) target.append(item);\r\n        });\r\n\r\n        this._onItemSort(uuids, null);\r\n      }\r\n\r\n      this.dragType = null;\r\n      this.dragData = null;\r\n      this.draggedElements = null;\r\n    });\r\n    // End of Folder Listeners\r\n    // ================\r\n\r\n    html.on('click', '.toggle-sort', this._onToggleSort.bind(this));\r\n    html.on('click', '.toggle-doc-lock', this._onToggleLock.bind(this));\r\n    html.on('click', '.toggle-ext-comp', this._onToggleExtComp.bind(this));\r\n    html.on('click', '.toggle-virtual-dir', this._onToggleVirtDir.bind(this));\r\n    html.on('click', '.toggle-scaling', this._onToggleScaling.bind(this));\r\n    html.on('click', '.toggle-layer-switch', this._onToggleLayerSwitch.bind(this));\r\n    html.on('click', '.document-select', this._onDocumentChange.bind(this));\r\n    html.on('dblclick', '.item', this._onDoubleClickPreset.bind(this));\r\n    html.on('click', '.create-folder', this._onCreateFolder.bind(this));\r\n    html.on('click', '.preset-create', this._onPresetCreate.bind(this));\r\n    html.on('click', '.preset-update a', this._onPresetUpdate.bind(this));\r\n    html.on('click', '.preset-favorite', this._onToggleFavorite.bind(this));\r\n    html.on('click', '.preset-callback', this._onApplyPreset.bind(this));\r\n\r\n    const headerSearch = html.find('.header-search input');\r\n    headerSearch.on('input', (event) => this._onSearchInput(event));\r\n    if ((MassEditPresets.lastSearch?.length ?? 0) >= SEARCH_MIN_CHAR) headerSearch.trigger('input');\r\n\r\n    html.on('click', '.toggle-search-mode', (event) => {\r\n      this._onToggleSearch(event, headerSearch);\r\n    });\r\n\r\n    // Activate context menu\r\n    this._contextMenu(html.find('.item-list'));\r\n  }\r\n\r\n  _folderToggle(folderElement) {\r\n    const uuid = folderElement.data('uuid');\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder.expanded) this._folderCollapse(folderElement, folder);\r\n    else this._folderExpand(folderElement, folder);\r\n  }\r\n\r\n  async _folderExpand(folderElement, folder) {\r\n    FolderState.setExpanded(folder.uuid, true);\r\n    folder.expanded = true;\r\n\r\n    if (folderElement.find('.folder-items').length) {\r\n      folderElement.removeClass('collapsed');\r\n      folderElement.find('header .folder-icon').first().removeClass('fa-folder-closed').addClass('fa-folder-open');\r\n    } else {\r\n      let content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/presetFolder.html`, {\r\n        folder,\r\n        createEnabled: Boolean(this.configApp),\r\n        callback: Boolean(this.callback),\r\n        sortable: fromUuidSync(folder.uuid)?.pack === PresetCollection.workingPack,\r\n      });\r\n      folderElement.replaceWith(content);\r\n    }\r\n  }\r\n\r\n  _folderCollapse(folderElement, folder) {\r\n    folderElement.addClass('collapsed');\r\n    folderElement.find('header .folder-icon').first().removeClass('fa-folder-open').addClass('fa-folder-closed');\r\n\r\n    FolderState.setExpanded(folder.uuid, false);\r\n    folder.expanded = false;\r\n  }\r\n\r\n  /**\r\n   * Process drag and drop of an Actor or Folder of actors\r\n   * @param {*} event\r\n   * @returns\r\n   */\r\n  _foundryDrop(event) {\r\n    const data = TextEditor.getDragEventData(event.originalEvent);\r\n    if (!isEmpty(data)) {\r\n      if (data.type === 'Folder') {\r\n        const folder = fromUuidSync(data.uuid);\r\n        if (folder.type !== 'Actor') return false;\r\n        if (this._importTracker?.active) return false;\r\n\r\n        trackProgress({\r\n          title: 'Converting Actors',\r\n          total: countFolderItems(folder),\r\n        }).then(async (tracker) => {\r\n          this._importTracker = tracker;\r\n          await this._importActorFolder(folder, null, { keepId: true });\r\n          this._importTracker?.stop();\r\n        });\r\n        return true;\r\n      } else if (data.type === 'Actor') {\r\n        PresetAPI.createPresetFromActorUuid(data.uuid, { keepId: true }).then((preset) => {\r\n          if (preset) this.render(true);\r\n        });\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  async _importActorFolder(folder, parentFolder = null, options = {}) {\r\n    let nFolder = new Folder.implementation(\r\n      {\r\n        _id: options.keepId ? folder.id : null,\r\n        name: folder.name,\r\n        type: 'JournalEntry',\r\n        sorting: folder.sorting,\r\n        folder: parentFolder,\r\n        color: folder.color ?? '#000000',\r\n        flags: { [MODULE_ID]: { types: ['ALL', 'Token'] } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    nFolder = await Folder.create(nFolder, { pack: nFolder.pack, keepId: options.keepId });\r\n\r\n    for (const child of folder.children) {\r\n      if (!this._importTracker?.active) break;\r\n      await this._importActorFolder(child.folder, nFolder.id, options);\r\n    }\r\n\r\n    for (const actor of folder.contents) {\r\n      if (!this._importTracker?.active) break;\r\n      await PresetAPI.createPresetFromActorUuid(actor.uuid, { folder: nFolder.id, keepId: options.keepId });\r\n      this._importTracker.incrementCount();\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onDoubleClickPreset(event) {\r\n    BrushMenu.close();\r\n    // TODO: 3D Preview\r\n    if (game.Levels3DPreview?._active) return;\r\n    const item = $(event.target).closest('.item');\r\n    const uuid = item.data('uuid');\r\n    if (!uuid) return;\r\n\r\n    let preset = await PresetAPI.getPreset({ uuid });\r\n\r\n    if (!preset) return;\r\n\r\n    if (preset.documentName === 'Scene') {\r\n      ui.notifications.info(`Mass Edit: ${localize('common.apply')} [${preset.name}]`);\r\n      applyPresetToScene(preset);\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    ui.notifications.info(`Mass Edit: ${localize('presets.spawning')} [${preset.name}]`);\r\n\r\n    this._setInteractivityState(false);\r\n    await PresetAPI.spawnPreset({\r\n      preset,\r\n      coordPicker: true,\r\n      taPreview: 'ALL',\r\n      layerSwitch: game.settings.get(MODULE_ID, 'presetLayerSwitch'),\r\n      scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n      center: true,\r\n    });\r\n    this._setInteractivityState(true);\r\n  }\r\n\r\n  /**\r\n   * Sets the window app as translucent and inactive to mouse pointer events\r\n   * @param {Boolean} state true = active, false = inactive\r\n   */\r\n  _setInteractivityState(state) {\r\n    if (state) this.element.removeClass('inactive');\r\n    else this.element.addClass('inactive');\r\n  }\r\n\r\n  _contextMenu(html) {\r\n    ContextMenu.create(this, html, '.item', this._getItemContextOptions(), {\r\n      hookName: 'MassEditPresetContext',\r\n      onOpen: this._onRightClickPreset.bind(this),\r\n    });\r\n    ContextMenu.create(this, html, '.folder header', this._getFolderContextOptions(), {\r\n      hookName: 'MassEditFolderContext',\r\n    });\r\n  }\r\n\r\n  _getItemContextOptions() {\r\n    return [\r\n      {\r\n        name: localize('CONTROLS.CommonEdit', false),\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (item) => Preset.isEditable(item.data('uuid')),\r\n        callback: (item) => this._onEditSelectedPresets(item),\r\n      },\r\n      {\r\n        name: 'Brush',\r\n        icon: '<i class=\"fa-solid fa-paintbrush\"></i>',\r\n        condition: (item) => SUPPORTED_PLACEABLES.includes(item.data('doc-name')),\r\n        callback: (item) => this._onActivateBrush(item),\r\n      },\r\n      {\r\n        name: localize('presets.open-journal'),\r\n        icon: '<i class=\"fas fa-book-open\"></i>',\r\n        condition: (item) => !item.hasClass('virtual'),\r\n        callback: (item) => this._onOpenJournal(item),\r\n      },\r\n      {\r\n        name: localize('presets.apply-to-selected'),\r\n        icon: '<i class=\"fas fa-arrow-circle-right\"></i>',\r\n        condition: (item) =>\r\n          SUPPORTED_PLACEABLES.includes(item.data('doc-name')) &&\r\n          canvas.getLayerByEmbeddedName(item.data('doc-name')).controlled.length,\r\n        callback: (item) => this._onApplyToSelected(item),\r\n      },\r\n      {\r\n        name: localize('Duplicate', false),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => Preset.isEditable(item.data('uuid')) && !item.hasClass('virtual'),\r\n        callback: (item) => this._onCopySelectedPresets(null, { keepFolder: true, keepId: false }),\r\n      },\r\n      {\r\n        name: localize('presets.copy-source-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => item.data('uuid').startsWith('virtual@'),\r\n        callback: (item) => game.clipboard.copyPlainText(item.data('uuid').substring(8)),\r\n      },\r\n      {\r\n        name: localize('presets.copy-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => $(this.form).find('.item-list').find('.item.selected').length === 1,\r\n        callback: (item) => this._onCopyPresetToClipboard(),\r\n      },\r\n      {\r\n        name: localize('presets.export-as-json'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (item) => this._onExportSelectedPresets(),\r\n      },\r\n      {\r\n        name: localize('presets.export-to-compendium'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        callback: (item) => this._onExportSelectedPresetsToComp(),\r\n      },\r\n      {\r\n        name: localize('CONTROLS.CommonDelete', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (item) => Preset.isEditable(item.data('uuid')) && !item.hasClass('virtual'),\r\n        callback: (item) => this._onDeleteSelectedPresets(item),\r\n      },\r\n    ];\r\n  }\r\n\r\n  _getFolderContextOptions() {\r\n    return [\r\n      {\r\n        name: 'Edit',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !folder.virtual || folder instanceof PresetPackFolder;\r\n        },\r\n        callback: (header) => this._onFolderEdit(header),\r\n      },\r\n      {\r\n        name: 'Save Index',\r\n        icon: '<i class=\"fas fa-file-search\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return folder.indexable;\r\n        },\r\n        callback: (header) => {\r\n          FileIndexer.saveFolderToCache(this.tree.allFolders.get(header.closest('.folder').data('uuid')));\r\n        },\r\n      },\r\n      {\r\n        name: 'Export to Compendium',\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !(folder instanceof VirtualFileFolder);\r\n        },\r\n        callback: (header) => {\r\n          this._onExportFolder(header.closest('.folder').data('uuid'));\r\n        },\r\n      },\r\n      {\r\n        name: localize('FOLDER.Remove', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (header) => PresetFolder.isEditable(header.closest('.folder').data('uuid')),\r\n        callback: (header) => this._onFolderDelete(header.closest('.folder').data('uuid')),\r\n      },\r\n      {\r\n        name: localize('FOLDER.Delete', false),\r\n        icon: '<i class=\"fas fa-dumpster\"></i>',\r\n        condition: (header) => PresetFolder.isEditable(header.closest('.folder').data('uuid')),\r\n        callback: (header) =>\r\n          this._onFolderDelete(header.closest('.folder').data('uuid'), {\r\n            deleteAll: true,\r\n          }),\r\n      },\r\n      {\r\n        name: 'Randomize Child Folder Colors',\r\n        icon: '<i class=\"fas fa-dice\"></i>',\r\n        condition: () => CONFIG.debug.MassEdit,\r\n        callback: (header) =>\r\n          randomizeChildrenFolderColors(header.closest('.folder').data('uuid'), this.tree, () => this.render(true)),\r\n      },\r\n    ];\r\n  }\r\n\r\n  async _onExportFolder(uuid) {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack && !this._importTracker?.active) {\r\n      const folder = this.tree.allFolders.get(uuid);\r\n      if (folder) {\r\n        this._importTracker = await trackProgress({\r\n          title: 'Exporting Folder',\r\n          total: countFolderItems(this.tree.allFolders.get(uuid)),\r\n        });\r\n        await this._onCopyFolder(uuid, null, pack, true, keepId);\r\n        this._importTracker?.stop();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onCopyFolder(uuid, parentId = null, pack, render = true, keepId = true) {\r\n    if (!pack) pack = PresetCollection.workingPack;\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    const folderDoc = await fromUuid(uuid);\r\n\r\n    if (folder) {\r\n      let types;\r\n      if (folderDoc) types = folderDoc.flags[MODULE_ID]?.types ?? ['ALL'];\r\n      else types = ['ALL'];\r\n\r\n      const data = {\r\n        _id: keepId ? folder.id : null,\r\n        name: folder.name,\r\n        color: folder.color,\r\n        sorting: folder.sorting,\r\n        folder: parentId,\r\n        flags: { [MODULE_ID]: { types } },\r\n        type: 'JournalEntry',\r\n      };\r\n      const nFolder = await Folder.create(data, { pack, keepId });\r\n\r\n      for (const preset of folder.presets) {\r\n        if (!this._importTracker?.active) break;\r\n        const p = (await preset.load()).clone();\r\n        p.folder = nFolder.id;\r\n        if (!keepId) p.id = foundry.utils.randomID();\r\n        await PresetCollection.set(p, pack);\r\n        this._importTracker?.incrementCount();\r\n      }\r\n\r\n      for (const child of folder.children) {\r\n        if (!this._importTracker?.active) break;\r\n        await this._onCopyFolder(child.uuid, nFolder.id, pack, false, keepId);\r\n      }\r\n\r\n      if (render) this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onExportSelectedPresetsToComp() {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack) this._onCopySelectedPresets(pack, { keepId });\r\n  }\r\n\r\n  async _onCopySelectedPresets(pack, { keepFolder = false, keepId = true } = {}) {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    for (const preset of selected) {\r\n      const p = preset.clone();\r\n      if (!keepFolder) p.folder = null;\r\n      if (!keepId) p.id = foundry.utils.randomID();\r\n      await PresetCollection.set(p, pack);\r\n    }\r\n    if (selected.length) this.render(true);\r\n  }\r\n\r\n  async _onCopyPresetToClipboard() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    if (selected.length) copyToClipboard(selected[0]);\r\n  }\r\n\r\n  async _getSelectedPresets({ editableOnly = false, virtualOnly = false, full = true } = {}) {\r\n    const uuids = [];\r\n    let selector = '.item.selected';\r\n    if (virtualOnly) selector += '.virtual';\r\n\r\n    let items = this.element.find('.item-list').find(selector);\r\n    if (editableOnly)\r\n      items = items.filter(function () {\r\n        return Preset.isEditable($(this).data('uuid'));\r\n      });\r\n\r\n    items.each(function () {\r\n      const uuid = $(this).data('uuid');\r\n      uuids.push(uuid);\r\n    });\r\n\r\n    const selected = [];\r\n    for (const uuid of uuids) {\r\n      const preset = await PresetCollection.get(uuid, { full });\r\n      if (preset) selected.push(preset);\r\n    }\r\n    return [selected, items];\r\n  }\r\n\r\n  async _onExportSelectedPresets() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    exportPresets(selected);\r\n  }\r\n\r\n  async _onEditSelectedPresets(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ virtualOnly: item.hasClass('virtual'), editableOnly: true });\r\n    if (selected.length) {\r\n      // Position edit window just bellow the item\r\n      const options = item.offset();\r\n      options.top += item.height();\r\n\r\n      this._editPresets(selected, options);\r\n    }\r\n  }\r\n\r\n  async _onDeleteSelectedPresets(item) {\r\n    const [selected, items] = await this._getSelectedPresets({ editableOnly: true, full: false });\r\n    if (selected.length) {\r\n      const confirm =\r\n        selected.length === 0\r\n          ? true\r\n          : await Dialog.confirm({\r\n              title: `${localize('common.delete')} [ ${selected.length} ]`,\r\n              content: `<p>${localize('AreYouSure', false)}</p><p>${localFormat('presets.delete-presets-warn', {\r\n                count: selected.length,\r\n              })}</p>`,\r\n            });\r\n\r\n      if (confirm) {\r\n        await PresetCollection.delete(selected);\r\n        items.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onOpenJournal(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: false });\r\n    selected.forEach((p) => p.openJournal());\r\n  }\r\n\r\n  async _onApplyToSelected(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: false });\r\n    if (!selected.length) return;\r\n\r\n    // Confirm that all presets are of the same document type\r\n    const types = new Set();\r\n    for (const s of selected) {\r\n      types.add(s.documentName);\r\n      if (types.size > 1) {\r\n        ui.notifications.warn(localize('presets.apply-to-selected-warn'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    const controlled = canvas.getLayerByEmbeddedName(selected[0].documentName).controlled;\r\n    if (!controlled.length) return;\r\n\r\n    for (const s of selected) {\r\n      pasteDataUpdate(controlled, s, false, true);\r\n    }\r\n  }\r\n\r\n  async _onCreateFolder(event) {\r\n    const types = [];\r\n    if (this.docName === 'ALL') {\r\n      types.push('ALL');\r\n    } else if (UI_DOCS.includes(this.docName)) {\r\n      types.push('ALL', this.docName);\r\n    } else {\r\n      types.push(this.docName);\r\n    }\r\n\r\n    const folder = new Folder.implementation(\r\n      {\r\n        name: Folder.defaultName(),\r\n        type: 'JournalEntry',\r\n        sorting: 'm',\r\n        flags: { [MODULE_ID]: { types } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    await new Promise((resolve) => {\r\n      new PresetFolderConfig(folder, { resolve }).render(true);\r\n    });\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onFolderEdit(header) {\r\n    const uuid = $(header).closest('.folder').data('uuid');\r\n    const pFolder = this.tree.allFolders.get(uuid);\r\n\r\n    let folder;\r\n    if (pFolder instanceof PresetPackFolder) {\r\n      // This is a virtual pack folder\r\n      folder = new Folder.implementation(\r\n        {\r\n          _id: pFolder.id,\r\n          name: pFolder.name,\r\n          type: 'JournalEntry',\r\n          color: pFolder.color,\r\n          sorting: pFolder.sorting,\r\n        },\r\n        { pack: pFolder.uuid }\r\n      );\r\n    } else {\r\n      folder = await fromUuid($(header).closest('.folder').data('uuid'));\r\n    }\r\n\r\n    new Promise((resolve) => {\r\n      const options = { resolve, ...header.offset(), folder: pFolder };\r\n      options.top += header.height();\r\n\r\n      new PresetFolderConfig(folder, options).render(true);\r\n    }).then(() => this.render(true));\r\n  }\r\n\r\n  async _onFolderDelete(uuid, { render = true, deleteAll = false } = {}) {\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder) {\r\n      let confirm;\r\n\r\n      if (deleteAll) {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Delete', false)}: ${folder.name}`,\r\n          content: `<div style=\"color:red;\"><h4>${localize('AreYouSure', false)}</h4><p>${localize(\r\n            'FOLDER.DeleteWarning',\r\n            false\r\n          )}</p></div>`,\r\n        });\r\n      } else {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Remove', false)}: ${folder.name}`,\r\n          content: `<h4>${localize('AreYouSure', false)}</h4><p>${localize('FOLDER.RemoveWarning', false)}</p>`,\r\n        });\r\n      }\r\n\r\n      if (confirm) {\r\n        await PresetCollection.deleteFolder(uuid, deleteAll);\r\n        if (render) this.render(true);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Throttle input and perform preset search\r\n  _onSearchInput(event) {\r\n    clearTimeout(this._searchTimer);\r\n    this._searchTimer = setTimeout(() => this._onSearch(event), 250);\r\n  }\r\n\r\n  async _onSearch(event) {\r\n    let newSearch = event.target.value;\r\n    let previousSearch = MassEditPresets.lastSearch || '';\r\n    MassEditPresets.lastSearch = newSearch;\r\n\r\n    if (previousSearch.length >= SEARCH_MIN_CHAR && newSearch.length < SEARCH_MIN_CHAR) {\r\n      $(event.target).removeClass('active');\r\n      this._resetSearchState();\r\n      this._renderContent();\r\n      return;\r\n    }\r\n\r\n    if (newSearch.length < SEARCH_MIN_CHAR) return;\r\n\r\n    let filter = event.target.value\r\n      .trim()\r\n      .toLowerCase()\r\n      .split(' ')\r\n      .filter((w) => w.length >= SEARCH_MIN_CHAR);\r\n    if (!filter.length) return;\r\n    $(event.target).addClass('active');\r\n\r\n    const tags = filter.filter((f) => f.startsWith('#')).map((f) => f.substring(1));\r\n    filter = filter.filter((f) => !f.startsWith('#'));\r\n\r\n    this._searchFoundCount = 0;\r\n    this._searchFoundPresets = game.settings.get(MODULE_ID, 'presetSearchMode') === 'p' ? [] : null;\r\n\r\n    this.tree.folders.forEach((f) => this._searchFolder(filter, tags, f));\r\n    this.tree.extFolders.forEach((f) => this._searchFolder(filter, tags, f));\r\n    this.tree.presets.forEach((p) => this._searchPreset(filter, tags, p));\r\n\r\n    this._renderContent();\r\n  }\r\n\r\n  _searchFolder(filter, tags, folder, forceRender = false) {\r\n    const folderName = folder.name.toLowerCase();\r\n    let match = !tags.length && filter.every((k) => folderName.includes(k));\r\n\r\n    let childFolderMatch = false;\r\n    for (const f of folder.children) {\r\n      if (this._searchFolder(filter, tags, f, match || forceRender)) childFolderMatch = true;\r\n    }\r\n\r\n    let presetMatch = false;\r\n    for (const p of folder.presets) {\r\n      if (this._searchPreset(filter, tags, p, match || forceRender)) presetMatch = true;\r\n    }\r\n\r\n    const containsMatch = match || childFolderMatch || presetMatch;\r\n    folder.expanded = childFolderMatch || presetMatch;\r\n    folder.render = containsMatch || forceRender;\r\n\r\n    return containsMatch;\r\n  }\r\n\r\n  _searchPreset(filter, tags, preset, forceRender = false) {\r\n    if (!preset._visible) return false;\r\n\r\n    const presetName = preset.name.toLowerCase();\r\n    if (\r\n      this._searchFoundCount < SEARCH_FOUND_MAX_COUNT &&\r\n      filter.every((k) => presetName.includes(k) || preset.tags.includes(k)) &&\r\n      tags.every((k) => preset.tags.includes(k))\r\n    ) {\r\n      this._searchFoundCount++;\r\n      preset._render = true;\r\n      this._searchFoundPresets?.push(preset);\r\n      return preset._render;\r\n    } else {\r\n      preset._render = false || forceRender;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _resetSearchState() {\r\n    this._searchFoundPresets = null;\r\n    this.tree.folders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.extFolders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStateFolder(folder) {\r\n    folder.expanded = FolderState.expanded(folder.uuid);\r\n    folder.render = true;\r\n    folder.children.forEach((f) => this._resetSearchStateFolder(f));\r\n    folder.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStatePreset(preset) {\r\n    preset._render = true;\r\n  }\r\n\r\n  async _renderContent() {\r\n    let data;\r\n    if (this._searchFoundPresets) {\r\n      data = {\r\n        callback: Boolean(this.callback),\r\n        presets: this._searchFoundPresets,\r\n        folders: [],\r\n        createEnabled: Boolean(this.configApp),\r\n        extFolders: null,\r\n      };\r\n    } else {\r\n      data = {\r\n        callback: Boolean(this.callback),\r\n        presets: this.tree.presets,\r\n        folders: this.tree.folders,\r\n        createEnabled: Boolean(this.configApp),\r\n        extFolders: this.tree.extFolders.length ? this.tree.extFolders : null,\r\n      };\r\n    }\r\n\r\n    const content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/presetsContent.html`, data);\r\n    this.element.find('.item-list').html(content);\r\n  }\r\n\r\n  async _onFolderSort(sourceUuid, targetUuid, { inside = true, folderUuid = null } = {}) {\r\n    let source = this.tree.allFolders.get(sourceUuid);\r\n    let target = this.tree.allFolders.get(targetUuid);\r\n\r\n    let folders;\r\n    if (folderUuid) folders = this.tree.allFolders.get(folderUuid).children;\r\n    else folders = this.tree.folders;\r\n\r\n    const siblings = [];\r\n    for (const folder of folders) {\r\n      if (folder.uuid !== sourceUuid) siblings.push(folder);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSort(source, {\r\n      target,\r\n      siblings,\r\n      sortBefore: true,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await Folder.updateDocuments(updates, { pack: PresetCollection.workingPack });\r\n    }\r\n    this.render(true);\r\n  }\r\n\r\n  async _onItemSort(sourceUuids, targetUuid, { before = true, folderUuid = null } = {}) {\r\n    const sourceUuidsSet = new Set(sourceUuids);\r\n    const sources = this.tree.allPresets.filter((p) => sourceUuidsSet.has(p.uuid));\r\n\r\n    let target = this.tree.allPresets.find((p) => p.uuid === targetUuid);\r\n\r\n    // Determine siblings based on folder\r\n    let presets;\r\n    if (folderUuid) presets = this.tree.allFolders.get(folderUuid).presets;\r\n    else presets = this.tree.presets;\r\n\r\n    const siblings = [];\r\n    for (const preset of presets) {\r\n      if (!sourceUuidsSet.has(preset.uuid)) siblings.push(preset);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSortMulti(sources, {\r\n      target,\r\n      siblings,\r\n      sortBefore: before,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        // update preset object itself\r\n        // TODO: improve, this is done so that preset/pack does not need to get reloaded\r\n        const p = presets.find((p) => p.id === update._id);\r\n        if (p) {\r\n          p.folder = update.folder;\r\n          p.sort = update.sort;\r\n        }\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await PresetCollection.updatePresets(updates);\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSort(event) {\r\n    const currentSort = game.settings.get(MODULE_ID, 'presetSortMode');\r\n    const newSort = currentSort === 'manual' ? 'alphabetical' : 'manual';\r\n    await game.settings.set(MODULE_ID, 'presetSortMode', newSort);\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSearch(event, headerSearch) {\r\n    const searchControl = $(event.target).closest('.toggle-search-mode');\r\n\r\n    const currentMode = game.settings.get(MODULE_ID, 'presetSearchMode');\r\n    const newMode = currentMode === 'p' ? 'pf' : 'p';\r\n    await game.settings.set(MODULE_ID, 'presetSearchMode', newMode);\r\n\r\n    const mode = SEARCH_MODES[newMode];\r\n    searchControl.attr('data-tooltip', mode.tooltip).html(mode.icon);\r\n\r\n    if (MassEditPresets.lastSearch) headerSearch.trigger('input');\r\n  }\r\n\r\n  _onToggleLock(event) {\r\n    const lockControl = $(event.target).closest('.toggle-doc-lock');\r\n\r\n    let currentLock = game.settings.get(MODULE_ID, 'presetDocLock');\r\n    let newLock = this.docName;\r\n\r\n    if (newLock !== currentLock) lockControl.addClass('active');\r\n    else {\r\n      lockControl.removeClass('active');\r\n      newLock = '';\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'presetDocLock', newLock);\r\n  }\r\n\r\n  _onToggleLayerSwitch(event) {\r\n    const switchControl = $(event.currentTarget);\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetLayerSwitch');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    game.settings.set(MODULE_ID, 'presetLayerSwitch', value);\r\n  }\r\n\r\n  async _onToggleVirtDir(event) {\r\n    const switchControl = $(event.currentTarget);\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetVirtualDir');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    await game.settings.set(MODULE_ID, 'presetVirtualDir', value);\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleExtComp(event) {\r\n    const switchControl = $(event.currentTarget);\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetExtComp');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    await game.settings.set(MODULE_ID, 'presetExtComp', value);\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleScaling(event) {\r\n    const switchControl = $(event.target).closest('.toggle-scaling');\r\n\r\n    const value = !game.settings.get(MODULE_ID, 'presetScaling');\r\n    if (value) switchControl.addClass('active');\r\n    else switchControl.removeClass('active');\r\n\r\n    game.settings.set(MODULE_ID, 'presetScaling', value);\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    const newDocName = $(event.target).closest('.document-select').data('name');\r\n    if (newDocName != this.docName) {\r\n      this.docName = newDocName;\r\n\r\n      if (game.settings.get(MODULE_ID, 'presetLayerSwitch'))\r\n        canvas.getLayerByEmbeddedName(this.docName === 'Actor' ? 'Token' : this.docName)?.activate();\r\n\r\n      if (MassEditPresets.lastSearch) {\r\n        MassEditPresets.lastSearch = '';\r\n        this._resetSearchState();\r\n      }\r\n\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRightClickPreset(eventTarget) {\r\n    const item = $(eventTarget).closest('.item');\r\n\r\n    // If right-clicked item is not selected, de-select the others and select it\r\n    if (!item.hasClass('selected')) {\r\n      item.closest('.item-list').find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n      item.addClass('selected').addClass('last-selected');\r\n    }\r\n  }\r\n\r\n  _editPresets(presets, options = {}, event) {\r\n    options.callback = () => this.render(true);\r\n    if (!('left' in options) && event) {\r\n      options.left = event.originalEvent.x - PresetConfig.defaultOptions.width / 2;\r\n      options.top = event.originalEvent.y;\r\n    }\r\n    new PresetConfig(presets, options).render(true);\r\n  }\r\n\r\n  async _onApplyPreset(event) {\r\n    if (this.callback) {\r\n      const uuid = $(event.target).closest('.item').data('uuid');\r\n      this.callback(await PresetCollection.get(uuid));\r\n    }\r\n  }\r\n\r\n  async _onPresetDragOut(event) {\r\n    const uuid = $(event.originalEvent.target).closest('.item').data('uuid');\r\n    const preset = await PresetCollection.get(uuid);\r\n    if (!preset) return;\r\n\r\n    // If released on top of a Mass Edit form, apply the preset to it instead of spawning it\r\n    const form = hoverMassEditForm(event.pageX, event.pageY, preset.documentName);\r\n    if (form) {\r\n      form._applyPreset(preset);\r\n      return;\r\n    }\r\n\r\n    // If it's a scene preset apply it to the currently active scene\r\n    if (preset.documentName === 'Scene') {\r\n      applyPresetToScene(preset);\r\n      return;\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    // For some reason canvas.mousePosition does not get updated during drag and drop\r\n    // Acquire the cursor position transformed to Canvas coordinates\r\n    let mouseX;\r\n    let mouseY;\r\n    let mouseZ;\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      game.Levels3DPreview.interactionManager._onMouseMove(event, true);\r\n      const { x, y, z } = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n      mouseX = x;\r\n      mouseY = y;\r\n      mouseZ = z;\r\n    } else {\r\n      const [x, y] = [event.clientX, event.clientY];\r\n      const t = canvas.stage.worldTransform;\r\n\r\n      mouseX = (x - t.tx) / canvas.stage.scale.x;\r\n      mouseY = (y - t.ty) / canvas.stage.scale.y;\r\n\r\n      if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n        mouseX -= canvas.dimensions.size / 2;\r\n        mouseY -= canvas.dimensions.size / 2;\r\n      }\r\n    }\r\n\r\n    PresetAPI.spawnPreset({\r\n      preset,\r\n      x: mouseX,\r\n      y: mouseY,\r\n      z: mouseZ,\r\n      mousePosition: false,\r\n      layerSwitch: game.settings.get(MODULE_ID, 'presetLayerSwitch'),\r\n      scaleToGrid: game.settings.get(MODULE_ID, 'presetScaling'),\r\n    });\r\n  }\r\n\r\n  async _onToggleFavorite(event) {\r\n    const item = $(event.target).closest('.item');\r\n    const uuid = item.data('uuid');\r\n    const starControl = item.find('.preset-favorite i');\r\n\r\n    if (uuid) {\r\n      const favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n      if (starControl.hasClass('fa-regular')) {\r\n        starControl.removeClass('fa-regular').addClass('fa-solid');\r\n        favorites[uuid] = true;\r\n      } else {\r\n        starControl.removeClass('fa-solid').addClass('fa-regular');\r\n        delete favorites[uuid];\r\n      }\r\n      game.settings.set(MODULE_ID, 'presetFavorites', favorites);\r\n      Preset.favorites = favorites;\r\n    }\r\n  }\r\n\r\n  async _onActivateBrush(item) {\r\n    const [selected, _] = await this._getSelectedPresets({ editableOnly: false });\r\n    BrushMenu.addPresets(selected);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * Application.setPosition(...) has been modified to use css transform for window translation across the screen\r\n   * instead of top/left css properties which force full-window style recomputation\r\n   */\r\n  setPosition({ left, top, width, height, scale } = {}) {\r\n    if (!this.popOut && !this.options.resizable) return; // Only configure position for popout or resizable apps.\r\n    const el = this.element[0];\r\n    const currentPosition = this.position;\r\n    const pop = this.popOut;\r\n    const styles = window.getComputedStyle(el);\r\n    if (scale === null) scale = 1;\r\n    scale = scale ?? currentPosition.scale ?? 1;\r\n\r\n    // If Height is \"auto\" unset current preference\r\n    if (height === 'auto' || this.options.height === 'auto') {\r\n      el.style.height = '';\r\n      height = null;\r\n    }\r\n\r\n    // Update width if an explicit value is passed, or if no width value is set on the element\r\n    if (!el.style.width || width) {\r\n      const tarW = width || el.offsetWidth;\r\n      const minW = parseInt(styles.minWidth) || (pop ? MIN_WINDOW_WIDTH : 0);\r\n      const maxW = el.style.maxWidth || window.innerWidth / scale;\r\n      currentPosition.width = width = Math.clamped(tarW, minW, maxW);\r\n      el.style.width = `${width}px`;\r\n      if (width * scale + currentPosition.left > window.innerWidth) left = currentPosition.left;\r\n    }\r\n    width = el.offsetWidth;\r\n\r\n    // Update height if an explicit value is passed, or if no height value is set on the element\r\n    if (!el.style.height || height) {\r\n      const tarH = height || el.offsetHeight + 1;\r\n      const minH = parseInt(styles.minHeight) || (pop ? MIN_WINDOW_HEIGHT : 0);\r\n      const maxH = el.style.maxHeight || window.innerHeight / scale;\r\n      currentPosition.height = height = Math.clamped(tarH, minH, maxH);\r\n      el.style.height = `${height}px`;\r\n      if (height * scale + currentPosition.top > window.innerHeight + 1) top = currentPosition.top - 1;\r\n    }\r\n    height = el.offsetHeight;\r\n\r\n    let leftT, topT;\r\n    // Update Left\r\n    if ((pop && !this.posSet) || Number.isFinite(left)) {\r\n      const scaledWidth = width * scale;\r\n      const tarL = Number.isFinite(left) ? left : (window.innerWidth - scaledWidth) / 2;\r\n      const maxL = Math.max(window.innerWidth - scaledWidth, 0);\r\n      currentPosition.left = left = Math.clamped(tarL, 0, maxL);\r\n      leftT = left;\r\n    }\r\n\r\n    // Update Top\r\n    if ((pop && !this.posSet) || Number.isFinite(top)) {\r\n      const scaledHeight = height * scale;\r\n      const tarT = Number.isFinite(top) ? top : (window.innerHeight - scaledHeight) / 2;\r\n      const maxT = Math.max(window.innerHeight - scaledHeight, 0);\r\n      currentPosition.top = Math.clamped(tarT, 0, maxT);\r\n\r\n      topT = currentPosition.top;\r\n    }\r\n\r\n    let transform = '';\r\n\r\n    // Update Scale\r\n    if (scale) {\r\n      currentPosition.scale = Math.max(scale, 0);\r\n\r\n      if (scale === 1) transform += ``;\r\n      else transform += `scale(${scale})`;\r\n    }\r\n\r\n    if (leftT || topT) {\r\n      this.posSet = true;\r\n      transform += 'translate(' + leftT + 'px,' + topT + 'px)';\r\n    }\r\n\r\n    if (transform) {\r\n      el.style.transform = transform;\r\n    }\r\n\r\n    // Track position post window close\r\n    if (!this.options.preventPositionOverride) {\r\n      const { left, top, width, height } = this.position;\r\n      MassEditPresets.previousPosition = { left, top, width, height };\r\n    }\r\n\r\n    // Return the updated position object\r\n    return currentPosition;\r\n  }\r\n\r\n  async close(options = {}) {\r\n    MassEditPresets.objectHover = false;\r\n    return super.close(options);\r\n  }\r\n\r\n  async _onPresetUpdate(event) {\r\n    const preset = await PresetCollection.get($(event.target).closest('.item').data('uuid'));\r\n    if (!preset) return;\r\n\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const randomize = foundry.utils.deepClone(this.configApp.randomizeFields || {});\r\n    const addSubtract = foundry.utils.deepClone(this.configApp.addSubtractFields || {});\r\n\r\n    // Detection modes may have been selected out of order\r\n    // Fix that here\r\n    if (this.docName === 'Token') {\r\n      TokenDataAdapter.correctDetectionModeOrder(selectedFields, randomize);\r\n    }\r\n\r\n    preset.update({ data: selectedFields, randomize, addSubtract });\r\n\r\n    ui.notifications.info(`Preset \"${preset.name}\" updated`);\r\n  }\r\n\r\n  async _onPresetCreate(event) {\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const preset = new Preset({\r\n      name: localize('presets.default-name'),\r\n      documentName: this.docName,\r\n      data: selectedFields,\r\n      addSubtract: this.configApp.addSubtractFields,\r\n      randomize: this.configApp.randomizeFields,\r\n    });\r\n\r\n    await PresetCollection.set(preset);\r\n    this.render(true);\r\n\r\n    this._editPresets([preset], { isCreate: true }, event);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped on the form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n\r\n    // Switch to just created preset's category before rendering if not set to 'ALL'\r\n    const documentName = placeables[0].document.documentName;\r\n    if (this.docName !== 'ALL' && this.docName !== documentName) this.docName = documentName;\r\n\r\n    const options = { isCreate: true };\r\n    options.left = this.position.left + this.position.width + 20;\r\n    options.top = this.position.top;\r\n\r\n    this._editPresets(presets, options, event);\r\n    this.render(true);\r\n  }\r\n\r\n  async actorToPreset(actor) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n  }\r\n\r\n  _getActiveEffectFields() {\r\n    return { changes: foundry.utils.deepClone(this.configApp.object.changes ?? []) };\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-change-compendium',\r\n      icon: 'fa-solid fa-gear',\r\n      onclick: (ev) => this._onWorkingPackChange(),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-indexer',\r\n      icon: 'fas fa-archive',\r\n      onclick: (ev) => this._onOpenIndexer(),\r\n    });\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-import',\r\n      icon: 'fas fa-file-import',\r\n      onclick: (ev) => this._onImport(ev),\r\n    });\r\n\r\n    if (CONFIG.debug.MassEdit) {\r\n      buttons.unshift({\r\n        label: 'Debug',\r\n        class: 'mass-edit-debug',\r\n        icon: 'fas fa-bug',\r\n        onclick: (ev) => {\r\n          console.log({\r\n            index: game.packs.get(PresetCollection.workingPack).get(META_INDEX_ID)?.flags[MODULE_ID]?.index,\r\n            tree: this.tree,\r\n          });\r\n        },\r\n      });\r\n    }\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _onWorkingPackChange() {\r\n    let pack = await new Promise((resolve) => getCompendiumDialog(resolve, {}));\r\n    if (pack && pack !== PresetCollection.workingPack) {\r\n      await game.settings.set(MODULE_ID, 'workingPack', pack);\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onOpenIndexer() {\r\n    if (FileIndexer._buildingIndex) {\r\n      ui.notifications.warn('Index Build In-Progress. Wait for it to finish before attempting it again.');\r\n      return;\r\n    }\r\n    new IndexerForm().render(true);\r\n  }\r\n\r\n  async _onExport() {\r\n    const tree = await PresetCollection.getTree();\r\n    exportPresets(tree.allPresets);\r\n  }\r\n\r\n  async _onImport() {\r\n    const json = await importPresetFromJSONDialog();\r\n    if (!json) return;\r\n\r\n    let importCount = 0;\r\n\r\n    if (foundry.utils.getType(json) === 'Array') {\r\n      for (const p of json) {\r\n        if (!('documentName' in p)) continue;\r\n        if (!('data' in p) || foundry.utils.isEmpty(p.data)) continue;\r\n\r\n        const preset = new Preset(p);\r\n        preset._pages = p.pages;\r\n\r\n        await PresetCollection.set(preset);\r\n        importCount++;\r\n      }\r\n    }\r\n\r\n    ui.notifications.info(`Mass Edit: ${localFormat('presets.imported', { count: importCount })}`);\r\n\r\n    if (importCount) this.render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (this.callback) {\r\n      this.callback(await PresetCollection.get(event.submitter.data.id));\r\n    }\r\n  }\r\n}\r\n\r\nasync function exportPresets(presets, fileName) {\r\n  if (!presets.length) return;\r\n\r\n  for (const preset of presets) {\r\n    await preset.load();\r\n  }\r\n\r\n  presets = presets.map((p) => {\r\n    const preset = p.clone();\r\n    preset.folder = null;\r\n    preset.uuid = null;\r\n    return preset;\r\n  });\r\n\r\n  saveDataToFile(JSON.stringify(presets, null, 2), 'text/json', (fileName ?? 'mass-edit-presets') + '.json');\r\n}\r\n\r\nexport class PresetConfig extends FormApplication {\r\n  static name = 'PresetConfig';\r\n\r\n  /**\r\n   * @param {Array[Preset]} presets\r\n   */\r\n  constructor(presets, options = {}) {\r\n    super({}, options);\r\n    this.presets = presets;\r\n    this.callback = options.callback;\r\n    this.isCreate = options.isCreate;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetEdit.html`,\r\n      width: 360,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return 'mass-edit-preset-edit';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    const prefix = this.presets[0] instanceof VirtualFilePreset ? 'File' : 'Preset';\r\n    if (this.presets.length > 1) return `${prefix}s [${this.presets.length}]`;\r\n    else return `${prefix}: ${this.presets[0].name.substring(0, 20)}${this.presets[0].name.length > 20 ? '...' : ''}`;\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    return buttons;\r\n  }\r\n\r\n  _onExport() {\r\n    let fileName;\r\n    if (this.presets.length === 1) {\r\n      fileName = 'mass-edit-preset-' + this.presets[0].name.replace(' ', '_').replace(/\\W/g, '');\r\n    }\r\n    exportPresets(this.presets, fileName);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = {};\r\n    data.advancedOpen = this.advancedOpen;\r\n\r\n    data.virtual = this.presets[0] instanceof VirtualFilePreset;\r\n\r\n    data.preset = {};\r\n    if (this.presets.length === 1) {\r\n      data.preset = deepClone(this.presets[0].toJSON());\r\n      data.displayFieldDelete = true;\r\n      data.displayFieldModify = true;\r\n\r\n      data.attached = this.attached || data.preset.attached;\r\n      if (data.attached) {\r\n        data.attached = data.attached.map((at) => {\r\n          let tooltip = at.documentName;\r\n          if (at.documentName === 'Token' && at.data.name) tooltip += ': ' + at.data.name;\r\n          return {\r\n            icon: DOC_ICONS[at.documentName] ?? DOC_ICONS.DEFAULT,\r\n            tooltip,\r\n          };\r\n        });\r\n      }\r\n    } else {\r\n      data.multiEdit = true;\r\n      data.preset = {};\r\n    }\r\n\r\n    // Form data stored if re-render was required\r\n    if (this._submitData) {\r\n      foundry.utils.mergeObject(data.preset, this._submitData);\r\n    }\r\n\r\n    data.minlength = this.presets.length > 1 ? 0 : 1;\r\n    data.tva = game.modules.get('token-variants')?.active;\r\n\r\n    if ((this.data && !(this.data instanceof Array)) || (!this.data && this.presets[0].isEmpty)) {\r\n      data.modifyDisabled = true;\r\n      data.deleteDisabled = true;\r\n    }\r\n\r\n    // Check if all presets are for the same document type and thus can be edited using a Mass Edit form\r\n    const docName = this.presets[0].documentName;\r\n    if (docName !== 'Actor' && this.presets.every((p) => p.documentName === docName)) {\r\n      data.documentEdit = docName;\r\n      data.isPlaceable = SUPPORTED_PLACEABLES.includes(docName);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    // Auto-select so that the pre-defined names can be conveniently erased\r\n    html.find('[name=\"name\"]').select();\r\n\r\n    html.find('.edit-document').on('click', this._onEditDocument.bind(this));\r\n    html.find('.assign-document').on('click', this._onAssignDocument.bind(this));\r\n    html.find('.delete-fields').on('click', this._onDeleteFields.bind(this));\r\n    html.find('.spawn-fields').on('click', this._onSpawnFields.bind(this));\r\n    html.find('summary').on('click', () => setTimeout(() => this.setPosition({ height: 'auto' }), 30));\r\n    html.find('.attached').on('click', this.onAttachedRemove.bind(this));\r\n    html.find('.attach-selected').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // TVA Support\r\n    const tvaButton = html.find('.token-variants-image-select-button');\r\n    tvaButton.on('click', (event) => {\r\n      game.modules.get('token-variants').api.showArtSelect('Preset', {\r\n        callback: (imgSrc, name) => {\r\n          tvaButton.siblings(`[name=\"${tvaButton.data('target')}\"]`).val(imgSrc);\r\n        },\r\n        searchType: 'Item',\r\n      });\r\n    });\r\n\r\n    // Advanced Options tracking between renders\r\n    html.find('details').on('toggle', (event) => {\r\n      this.advancedOpen = Boolean($(event.target).attr('open'));\r\n    });\r\n\r\n    //Hover\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (this.presets.length !== 1) return;\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          PresetConfig.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          PresetConfig.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        if (this.presets.length !== 1) return;\r\n        hoverOverlay.hide();\r\n        PresetConfig.objectHover = false;\r\n      });\r\n\r\n    //Tags\r\n    TagInput.activateListeners(html, { change: () => this.setPosition({ height: 'auto' }) });\r\n  }\r\n\r\n  _getSubmitData(updateData = {}) {\r\n    const data = super._getSubmitData(updateData);\r\n\r\n    data.name = data.name?.trim();\r\n    data.img = data.img?.trim() || null;\r\n    data.preSpawnScript = data.preSpawnScript?.trim();\r\n    data.postSpawnScript = data.postSpawnScript?.trim();\r\n    data.tags = data.tags ? data.tags.split(',') : [];\r\n    data.addTags = data.addTags ? data.addTags.split(',') : [];\r\n    data.removeTags = data.removeTags ? data.removeTags.split(',') : [];\r\n\r\n    return data;\r\n  }\r\n\r\n  async render(force = false) {\r\n    if (this.form) this._submitData = this._getSubmitData();\r\n    return await super.render(force);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped ont he form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    this.advancedOpen = true;\r\n\r\n    if (!this.attached) this.attached = deepClone(this.presets[0].attached ?? []);\r\n    placeables.forEach((p) => this.attached.push({ documentName: p.document.documentName, data: placeableToData(p) }));\r\n\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async onAttachedRemove(event) {\r\n    const index = $(event.target).closest('.attached').data('index');\r\n    this.attached = this.attached || deepClone(this.presets[0].attached);\r\n    this.attached.splice(index, 1);\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async _onSpawnFields() {\r\n    new PresetFieldModify(\r\n      this.data ?? this.presets[0].data,\r\n      (modifyOnSpawn) => {\r\n        this.modifyOnSpawn = modifyOnSpawn;\r\n      },\r\n      this.modifyOnSpawn ?? this.presets[0].modifyOnSpawn\r\n    ).render(true);\r\n  }\r\n\r\n  async _onDeleteFields() {\r\n    new PresetFieldDelete(this.data ?? this.presets[0].data, (data) => {\r\n      this.data = data;\r\n    }).render(true);\r\n  }\r\n\r\n  async _onAssignDocument() {\r\n    const layer = canvas.getLayerByEmbeddedName(this.presets[0].documentName);\r\n    if (!layer) return;\r\n\r\n    const data = layer.controlled.map((p) => placeableToData(p));\r\n    if (data.length) {\r\n      this.data = data;\r\n      ui.notifications.info(\r\n        localFormat('presets.assign', {\r\n          count: data.length,\r\n          document: this.presets[0].documentName,\r\n        })\r\n      );\r\n      this.gridSize = canvas.grid.size;\r\n      this.modifyOnSpawn = [];\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onEditDocument() {\r\n    const documents = [];\r\n    const cls = CONFIG[this.presets[0].documentName].documentClass;\r\n\r\n    for (const p of this.presets) {\r\n      p.data.forEach((d) => documents.push(new cls(mergePresetDataToDefaultDoc(p, d))));\r\n    }\r\n\r\n    const app = await showMassEdit(documents, null, {\r\n      presetEdit: true,\r\n      callback: (obj) => {\r\n        this.addSubtract = {};\r\n        this.randomize = {};\r\n        for (const k of Object.keys(obj.data)) {\r\n          if (k in obj.randomize) this.randomize[k] = obj.randomize[k];\r\n          if (k in obj.addSubtract) this.addSubtract[k] = obj.addSubtract[k];\r\n        }\r\n        this.data = obj.data;\r\n        this.render(true);\r\n      },\r\n      forceForm: true,\r\n    });\r\n\r\n    // For randomize and addSubtract only take into account the first preset\r\n    // and apply them to the form\r\n    const preset = new Preset({\r\n      data: {},\r\n      randomize: this.presets[0].randomize,\r\n      addSubtract: this.presets[0].addSubtract,\r\n    });\r\n    setTimeout(() => {\r\n      app._applyPreset(preset);\r\n    }, 400);\r\n  }\r\n\r\n  async _updatePresets(formData) {\r\n    for (const preset of this.presets) {\r\n      let update;\r\n      if (this.isCreate) {\r\n        update = {\r\n          name: formData.name || preset.name || localize('presets.default-name'),\r\n          img: formData.img ?? preset.img,\r\n        };\r\n      } else {\r\n        update = {\r\n          name: formData.name || preset.name,\r\n          img: formData.img || preset.img,\r\n        };\r\n      }\r\n\r\n      if (this.data) update.data = this.data;\r\n      if (this.addSubtract) update.addSubtract = this.addSubtract;\r\n      if (this.randomize) update.randomize = this.randomize;\r\n      if (this.modifyOnSpawn) update.modifyOnSpawn = this.modifyOnSpawn;\r\n      if (this.gridSize) update.gridSize = this.gridSize;\r\n      if (this.attached) update.attached = this.attached;\r\n      if (formData.preSpawnScript != null) update.preSpawnScript = formData.preSpawnScript;\r\n      if (formData.postSpawnScript != null) update.postSpawnScript = formData.postSpawnScript;\r\n      if (formData.spawnRandom != null) update.spawnRandom = formData.spawnRandom;\r\n\r\n      // If this is a single preset config, we override all tags\r\n      // If not we merge\r\n      if (this.presets.length === 1) {\r\n        update.tags = formData.tags;\r\n      } else if (formData.addTags.length || formData.removeTags.length) {\r\n        let tags = preset.tags ?? [];\r\n        if (formData.addTags.length) tags = Array.from(new Set(tags.concat(formData.addTags)));\r\n        if (formData.removeTags.length) tags = tags.filter((t) => !formData.removeTags.includes(t));\r\n        update.tags = tags;\r\n      }\r\n\r\n      await preset.update(update);\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    await this._updatePresets(formData);\r\n\r\n    if (this.callback) this.callback(this.presets);\r\n    return this.presets;\r\n  }\r\n\r\n  /** @inheritDoc */\r\n  async _renderOuter() {\r\n    const html = await super._renderOuter();\r\n    this._createDocumentIdLink(html);\r\n    return html;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Create an ID link button in the header which displays the JournalEntry ID and copies it to clipboard\r\n   * @param {jQuery} html\r\n   * @protected\r\n   */\r\n  _createDocumentIdLink(html) {\r\n    const title = html.find('.window-title');\r\n    const label = localize('DOCUMENT.JournalEntry', false);\r\n    const idLink = document.createElement('a');\r\n    idLink.classList.add('document-id-link');\r\n    idLink.setAttribute('alt', 'Copy document id');\r\n    idLink.dataset.tooltip = `${label}: ${this.presets.map((p) => p.id).join(', ')}`;\r\n    idLink.dataset.tooltipDirection = 'UP';\r\n    idLink.innerHTML = '<i class=\"fa-solid fa-passport\"></i>';\r\n    idLink.addEventListener('click', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.id).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'id',\r\n          id: this.presets.map((p) => p.id).join(', '),\r\n        })\r\n      );\r\n    });\r\n    idLink.addEventListener('contextmenu', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.uuid).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'uuid',\r\n          id: this.presets.map((p) => p.uuid).join(', '),\r\n        })\r\n      );\r\n    });\r\n    title.append(idLink);\r\n  }\r\n}\r\n\r\nclass PresetFieldSelect extends FormApplication {\r\n  static name = 'PresetFieldSelect';\r\n\r\n  constructor(data, callback) {\r\n    super();\r\n    this.presetData = data;\r\n    this.isObject = !(data instanceof Array);\r\n    this.callback = callback;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'preset-field-select', 'mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFieldSelect.html`,\r\n      width: 600,\r\n      resizable: false,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.item').on('click', this._onFieldClick);\r\n  }\r\n\r\n  _onFieldClick(e) {\r\n    itemSelect(e, $(e.target).closest('.preset-field-list'));\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const singleData = !this.isObject && this.presetData.length === 1;\r\n\r\n    let index;\r\n    let fields = [];\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (!singleData) {\r\n        const i = k.split('.')[0];\r\n        if (!index) {\r\n          fields.push({ header: true, index: 0 });\r\n        } else if (i !== index) {\r\n          fields.push({ header: true, index: i });\r\n        }\r\n        index = i;\r\n      }\r\n\r\n      let label = k;\r\n      if (singleData) label = label.substring(label.indexOf('.') + 1);\r\n\r\n      let value;\r\n      const t = foundry.utils.getType(v);\r\n      if (t === 'Object' || t === 'Array' || t === 'null') value = JSON.stringify(v);\r\n      else value = v;\r\n\r\n      fields.push({ name: k, label, value, selected: false });\r\n    }\r\n\r\n    return { fields };\r\n  }\r\n}\r\n\r\nclass PresetFieldDelete extends PresetFieldSelect {\r\n  static name = 'PresetFieldDelete';\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-delete');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = { icon: '<i class=\"fas fa-trash\"></i>', text: localize('common.delete') };\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const form = $(event.target).closest('form');\r\n    form.find('.item.selected').each(function () {\r\n      const name = $(this).attr('name');\r\n      delete data[name];\r\n    });\r\n    data = expandObject(data);\r\n\r\n    if (!this.isObject) {\r\n      let reorganizedData = [];\r\n      for (let i = 0; i < this.presetData.length; i++) {\r\n        if (!data[i]) continue;\r\n        reorganizedData.push(data[i]);\r\n      }\r\n      data = reorganizedData;\r\n    }\r\n\r\n    this.callback(data);\r\n  }\r\n}\r\n\r\nclass PresetFieldModify extends PresetFieldSelect {\r\n  static name = 'PresetFieldModify';\r\n\r\n  constructor(data, callback, modifyOnSpawn) {\r\n    super(data, callback);\r\n    this.modifyOnSpawn = modifyOnSpawn ?? [];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-modify');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = { icon: '<i class=\"fas fa-check\"></i>', text: localize('CONTROLS.CommonSelect', false) };\r\n    for (const field of data.fields) {\r\n      if (this.modifyOnSpawn.includes(field.name)) field.selected = true;\r\n    }\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    const form = $(event.target).closest('form');\r\n    const modifyOnSpawn = [];\r\n    form.find('.item.selected').each(function () {\r\n      let name = $(this).attr('name');\r\n      modifyOnSpawn.push(name);\r\n    });\r\n\r\n    this.callback(modifyOnSpawn);\r\n  }\r\n}\r\n\r\nclass PresetFolderConfig extends FolderConfig {\r\n  static name = 'PresetFolderConfig';\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'folder-edit'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFolderEdit.html`,\r\n      width: 360,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return this.object.id ? super.id : 'folder-create';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    if (this.object.id) return `${localize('FOLDER.Update', false)}: ${this.object.name}`;\r\n    return localize('FOLDER.Create', false);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.document-select').on('click', this._onDocumentChange.bind(this));\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    $(event.target).closest('.document-select').toggleClass('active');\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const folder = this.document.toObject();\r\n    const label = localize(Folder.implementation.metadata.label, false);\r\n\r\n    let folderDocs = folder.flags[MODULE_ID]?.types ?? ['ALL'];\r\n\r\n    let docs;\r\n\r\n    // This is a non-placeable folder type, so we will not display controls to change types\r\n    if (\r\n      this.options?.folder instanceof PresetPackFolder ||\r\n      (folderDocs.length === 1 && !UI_DOCS.includes(folderDocs[0]))\r\n    ) {\r\n      this.displayTypes = false;\r\n    } else {\r\n      this.displayTypes = true;\r\n      docs = [];\r\n      UI_DOCS.forEach((type) => {\r\n        if (type != 'FAVORITES') docs.push({ name: type, icon: DOC_ICONS[type], active: folderDocs.includes(type) });\r\n      });\r\n    }\r\n\r\n    return {\r\n      folder: folder,\r\n      name: folder._id ? folder.name : '',\r\n      newName: localFormat('DOCUMENT.New', { type: label }, false),\r\n      safeColor: folder.color ?? '#000000',\r\n      sortingModes: { a: 'FOLDER.SortAlphabetical', m: 'FOLDER.SortManual' },\r\n      submitText: localize(folder._id ? 'FOLDER.Update' : 'FOLDER.Create', false),\r\n      docs,\r\n      virtualPackFolder: this.options.folder instanceof PresetPackFolder,\r\n      group: this.options.folder?.group,\r\n    };\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    if (this.displayTypes) {\r\n      let visibleTypes = [];\r\n      $(this.form)\r\n        .find('.document-select.active')\r\n        .each(function () {\r\n          visibleTypes.push($(this).data('name'));\r\n        });\r\n      if (!visibleTypes.length) visibleTypes.push('ALL');\r\n\r\n      formData[`flags.${MODULE_ID}.types`] = visibleTypes;\r\n    }\r\n\r\n    let document = this.object;\r\n    if (this.options.folder instanceof PresetPackFolder) {\r\n      // This is a virtual folder used to store Compendium contents within\r\n      // Update using the provided interface\r\n      let update = {};\r\n      ['name', 'color', 'group'].forEach((k) => {\r\n        if (!formData[k]?.trim()) update['-=' + k] = null;\r\n        else update[k] = formData[k].trim();\r\n      });\r\n\r\n      await this.options.folder.update(update);\r\n    } else {\r\n      // This is a real folder, update/create it\r\n      if (!formData.name?.trim()) formData.name = Folder.implementation.defaultName();\r\n      if (this.object.id) await this.object.update(formData);\r\n      else {\r\n        this.object.updateSource(formData);\r\n        document = await Folder.create(this.object, { pack: this.object.pack });\r\n      }\r\n    }\r\n\r\n    this.options.resolve?.(document);\r\n    return document;\r\n  }\r\n}\r\n\r\nfunction checkMouseInWindow(event) {\r\n  let app = $(event.target).closest('.window-app');\r\n  var offset = app.offset();\r\n  let appX = offset.left;\r\n  let appY = offset.top;\r\n  let appW = app.width();\r\n  let appH = app.height();\r\n\r\n  var mouseX = event.pageX;\r\n  var mouseY = event.pageY;\r\n\r\n  if (mouseX > appX && mouseX < appX + appW && mouseY > appY && mouseY < appY + appH) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction getCompendiumDialog(resolve, { excludePack, exportTo = false, keepIdSelect = false } = {}) {\r\n  let config;\r\n  if (exportTo) {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.export-directory-message'),\r\n      buttonLabel: localize('FOLDER.Export', false),\r\n    };\r\n  } else {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.working-directory-message'),\r\n      buttonLabel: localize('common.swap'),\r\n    };\r\n  }\r\n\r\n  let options = '';\r\n  for (const p of game.packs) {\r\n    if (!p.locked && p.documentName === 'JournalEntry') {\r\n      if (p.collection === excludePack) continue;\r\n      const workingPack = p.collection === PresetCollection.workingPack;\r\n      options += `<option value=\"${p.collection}\" ${workingPack ? 'selected=\"selected\"' : ''}>${p.title}</option>`;\r\n    }\r\n  }\r\n\r\n  let content = `\r\n  <p style=\"color: orangered;\">${config.message}</p>\r\n  <div class=\"form-group\">\r\n    <label>${localize('PACKAGE.TagCompendium', false)}</label>\r\n    <div class=\"form-fields\">\r\n      <select style=\"width: 100%; margin-bottom: 10px;\">${options}</select>\r\n    </div>\r\n  </div>`;\r\n\r\n  if (keepIdSelect) {\r\n    content += `\r\n<div class=\"form-group\">\r\n    <label>${localize('presets.keep-ids')}</label>\r\n    <input type=\"checkbox\" name=\"keepId\" checked>\r\n    <p style=\"font-size: smaller;\">${localize('presets.keep-ids-hint')}</p>\r\n</div>`;\r\n  }\r\n\r\n  new Dialog({\r\n    title: config.title,\r\n    content: content,\r\n    buttons: {\r\n      export: {\r\n        label: config.buttonLabel,\r\n        callback: (html) => {\r\n          const pack = $(html).find('select').val();\r\n          if (keepIdSelect) resolve({ pack, keepId: $(html).find('[name=\"keepId\"]').is(':checked') });\r\n          else resolve(pack);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: localize('Cancel', false),\r\n        callback: () => resolve(keepIdSelect ? {} : null),\r\n      },\r\n    },\r\n    close: () => resolve(keepIdSelect ? {} : null),\r\n    default: 'cancel',\r\n  }).render(true);\r\n}\r\n\r\n/**\r\n * Controls select/multi-select flow for item lists\r\n * @param {*} e item click event\r\n * @param {*} itemList list of items that this item exists within\r\n */\r\nfunction itemSelect(e, itemList) {\r\n  const item = $(e.target).closest('.item');\r\n  const items = itemList.find('.item');\r\n  const lastSelected = items.filter('.last-selected');\r\n\r\n  if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {\r\n    lastSelected.removeClass('last-selected');\r\n    items.removeClass('selected');\r\n    item.addClass('selected').addClass('last-selected');\r\n  } else if (e.ctrlKey || e.metaKey) {\r\n    item.toggleClass('selected');\r\n    if (item.hasClass('selected')) {\r\n      lastSelected.removeClass('last-selected');\r\n      item.addClass('last-selected');\r\n    } else item.removeClass('last-index');\r\n  } else if (e.shiftKey) {\r\n    if (lastSelected.length) {\r\n      let itemIndex = items.index(item);\r\n      let lastSelectedIndex = items.index(lastSelected);\r\n\r\n      if (itemIndex === lastSelectedIndex) {\r\n        item.toggleClass('selected');\r\n        if (item.hasClass('selected')) item.addClass('last-selected');\r\n        else lastSelected.removeClass('last-selected');\r\n      } else {\r\n        let itemArr = items.toArray();\r\n        if (itemIndex > lastSelectedIndex) {\r\n          for (let i = lastSelectedIndex; i <= itemIndex; i++) $(itemArr[i]).addClass('selected');\r\n        } else {\r\n          for (let i = lastSelectedIndex; i >= itemIndex; i--) $(itemArr[i]).addClass('selected');\r\n        }\r\n      }\r\n    } else {\r\n      lastSelected.removeClass('last-selected');\r\n      item.toggleClass('selected');\r\n      if (item.hasClass('selected')) item.addClass('last-selected');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Return Mass Edit form that the mouse is over if any\r\n * @param {Number} mouseX\r\n * @param {Number} mouseY\r\n * @param {String} documentName\r\n * @returns {Application|null} MassEdit form\r\n */\r\nfunction hoverMassEditForm(mouseX, mouseY, documentName) {\r\n  const hitTest = function (app) {\r\n    const position = app.position;\r\n    const appX = position.left;\r\n    const appY = position.top;\r\n\r\n    if (mouseX > appX && mouseX < appX + position.width && mouseY > appY && mouseY < appY + position.height)\r\n      return true;\r\n    return false;\r\n  };\r\n\r\n  return Object.values(ui.windows).find((app) => app.meForm && app.documentName === documentName && hitTest(app));\r\n}\r\n","import { MODULE_ID, SUPPORTED_PLACEABLES, isImage, isAudio } from '../utils.js';\r\nimport { META_INDEX_FIELDS, META_INDEX_ID, PresetTree } from './collection.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\nimport { decodeURIComponentSafely, isVideo, placeableToData } from './utils.js';\r\n\r\nconst DOCUMENT_FIELDS = ['id', 'name', 'sort', 'folder'];\r\n\r\nconst PRESET_FIELDS = [\r\n  'id',\r\n  'name',\r\n  'data',\r\n  'sort',\r\n  'folder',\r\n  'uuid',\r\n  'documentName',\r\n  'addSubtract',\r\n  'randomize',\r\n  'img',\r\n  'gridSize',\r\n  'modifyOnSpawn',\r\n  'preSpawnScript',\r\n  'postSpawnScript',\r\n  'spawnRandom',\r\n  'attached',\r\n  'tags',\r\n];\r\n\r\nexport const DOC_ICONS = {\r\n  ALL: 'fas fa-globe',\r\n  FAVORITES: 'fas fa-star',\r\n  Token: 'fas fa-user-circle',\r\n  MeasuredTemplate: 'fas fa-ruler-combined',\r\n  Tile: 'fa-solid fa-cubes',\r\n  Drawing: 'fa-solid fa-pencil-alt',\r\n  Wall: 'fa-solid fa-block-brick',\r\n  AmbientLight: 'fa-regular fa-lightbulb',\r\n  AmbientSound: 'fa-solid fa-music',\r\n  Note: 'fa-solid fa-bookmark',\r\n  Actor: 'fas fa-user-alt',\r\n  Scene: 'fas fa-map',\r\n  DEFAULT: 'fa-solid fa-question',\r\n};\r\n\r\nexport class Preset {\r\n  static isEditable(uuid) {\r\n    if (uuid.startsWith('virtual@')) return true;\r\n    let { collection } = foundry.utils.parseUuid(uuid);\r\n    if (!collection) return false;\r\n    return !collection.locked;\r\n  }\r\n\r\n  constructor(data) {\r\n    this.id = data.id ?? data._id ?? foundry.utils.randomID();\r\n    this.name = data.name ?? 'Mass Edit Preset';\r\n    this.documentName = data.documentName;\r\n    this.sort = data.sort ?? 0;\r\n    this.tags = data.tags ?? [];\r\n    this.addSubtract =\r\n      data.addSubtract instanceof Array\r\n        ? Object.fromEntries(data.addSubtract)\r\n        : foundry.utils.deepClone(data.addSubtract ?? {});\r\n    this.randomize =\r\n      data.randomize instanceof Array\r\n        ? Object.fromEntries(data.randomize)\r\n        : foundry.utils.deepClone(data.randomize ?? {});\r\n    this.data = foundry.utils.deepClone(data.data);\r\n    this.img = data.img;\r\n    this.folder = data.folder;\r\n    this.uuid = data.uuid;\r\n    this.gridSize = data.gridSize;\r\n    this.modifyOnSpawn = data.modifyOnSpawn;\r\n    this.preSpawnScript = data.preSpawnScript;\r\n    this.postSpawnScript = data.postSpawnScript;\r\n    this.attached = data.attached;\r\n    this.spawnRandom = data.spawnRandom;\r\n    this._visible = true;\r\n    this._render = true;\r\n  }\r\n\r\n  get visible() {\r\n    return this._visible && this._render;\r\n  }\r\n\r\n  get icon() {\r\n    return DOC_ICONS[this.documentName] ?? DOC_ICONS.DEFAULT;\r\n  }\r\n\r\n  get thumbnail() {\r\n    return this.img || CONST.DEFAULT_TOKEN;\r\n  }\r\n\r\n  get pages() {\r\n    if (this.document?.pages.size) return this.document.toJSON().pages;\r\n    else if (this._pages) return this._pages;\r\n    return null;\r\n  }\r\n\r\n  set data(data) {\r\n    if (data instanceof Array) this._data = data.length ? data : [{}];\r\n    else if (data == null) this._data = [{}];\r\n    else this._data = [data];\r\n  }\r\n\r\n  get data() {\r\n    return this._data;\r\n  }\r\n\r\n  get isPlaceable() {\r\n    return SUPPORTED_PLACEABLES.includes(this.documentName);\r\n  }\r\n\r\n  get isFavorite() {\r\n    if (!Preset.favorites) Preset.favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n\r\n    return Boolean(Preset.favorites[this.uuid]);\r\n  }\r\n\r\n  get isEmpty() {\r\n    return foundry.utils.isEmpty(this.data[0]);\r\n  }\r\n\r\n  addPostSpawnHook(hook) {\r\n    if (!this._postSpawnHooks) this._postSpawnHooks = [];\r\n    this._postSpawnHooks.push(hook);\r\n  }\r\n\r\n  async callPostSpawnHooks(options) {\r\n    if (this._postSpawnHooks) {\r\n      for (const hook of this._postSpawnHooks) {\r\n        await hook(options);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads underlying JournalEntry document from the compendium\r\n   * @returns this\r\n   */\r\n  async load(force = false) {\r\n    if (this.document && !force) return this;\r\n    if (!this.document && this.uuid) {\r\n      this.document = await fromUuid(this.uuid);\r\n    }\r\n\r\n    if (this.document) {\r\n      const preset = this.document.getFlag(MODULE_ID, 'preset') ?? {};\r\n      this.documentName = preset.documentName;\r\n      this.img = preset.img;\r\n      this.data = preset.data;\r\n      this.randomize =\r\n        foundry.utils.getType(preset.randomize) === 'Object'\r\n          ? preset.randomize\r\n          : Object.fromEntries(preset.randomize ?? []);\r\n      this.addSubtract =\r\n        foundry.utils.getType(preset.addSubtract) === 'Object'\r\n          ? preset.addSubtract\r\n          : Object.fromEntries(preset.addSubtract ?? []);\r\n      this.gridSize = preset.gridSize;\r\n      this.modifyOnSpawn = preset.modifyOnSpawn;\r\n      this.preSpawnScript = preset.preSpawnScript;\r\n      this.postSpawnScript = preset.postSpawnScript;\r\n      this.attached = preset.attached;\r\n      this.spawnRandom = preset.spawnRandom;\r\n      this.tags = preset.tags ?? [];\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  async openJournal() {\r\n    if (!this.document) await this.load();\r\n    if (this.document) this.document.sheet.render(true);\r\n  }\r\n\r\n  /**\r\n   * Attach placeables\r\n   * @param {Placeable|Array[Placeable]} placeables\r\n   * @returns\r\n   */\r\n  async attach(placeables) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    if (!this.attached) this.attached = [];\r\n    for (const placeable of placeables) {\r\n      this.attached.push({ documentName: placeable.document.documentName, data: placeableToData(placeable) });\r\n    }\r\n\r\n    await this.update({ attached: this.attached });\r\n  }\r\n\r\n  /**\r\n   * Update preset with the provided data\r\n   * @param {Object} update\r\n   */\r\n  async update(update) {\r\n    if (this.document) {\r\n      const flagUpdate = {};\r\n      Object.keys(update).forEach((k) => {\r\n        if (k === 'randomize' || k === 'addSubtract') {\r\n          flagUpdate[k] = Object.entries(update[k]);\r\n          this[k] = update[k];\r\n        } else if (k === 'data' && !(update.data instanceof Array)) {\r\n          flagUpdate.data = this.data.map((d) => {\r\n            return foundry.utils.mergeObject(d, update.data);\r\n          });\r\n          this.data = flagUpdate.data;\r\n        } else if (PRESET_FIELDS.includes(k) && update[k] !== this[k]) {\r\n          flagUpdate[k] = update[k];\r\n          this[k] = update[k];\r\n        }\r\n      });\r\n\r\n      if (!foundry.utils.isEmpty(flagUpdate)) {\r\n        const docUpdate = { flags: { [MODULE_ID]: { preset: flagUpdate } } };\r\n        DOCUMENT_FIELDS.forEach((field) => {\r\n          if (field in flagUpdate && this.document[field] !== flagUpdate[field]) {\r\n            docUpdate[field] = flagUpdate[field];\r\n          }\r\n        });\r\n\r\n        await this.document.update(docUpdate);\r\n      }\r\n      await this._updateIndex(flagUpdate);\r\n    } else {\r\n      console.warn('Updating preset without document', this.id, this.uuid, this.name);\r\n    }\r\n  }\r\n\r\n  async _updateIndex(data) {\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((field) => {\r\n      if (field in data) update[field] = data[field];\r\n    });\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      const pack = game.packs.get(this.document.pack);\r\n      const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n      if (metaDoc) {\r\n        let tmp = {};\r\n        tmp[this.id] = update;\r\n        await metaDoc.setFlag(MODULE_ID, 'index', tmp);\r\n        delete PresetTree._packTrees[pack.metadata.name];\r\n      } else {\r\n        console.warn(`META INDEX missing in ${this.document.pack}`);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  toJSON() {\r\n    let json = {};\r\n    PRESET_FIELDS.forEach((field) => {\r\n      json[field] = this[field];\r\n    });\r\n\r\n    json.randomize = Object.entries(json.randomize ?? {});\r\n    json.addSubtract = Object.entries(json.addSubtract ?? {});\r\n    const pages = this.pages;\r\n    if (pages) json.pages = pages;\r\n\r\n    return json;\r\n  }\r\n\r\n  clone() {\r\n    const clone = new Preset(this.toJSON());\r\n    clone.document = this.document;\r\n    return clone;\r\n  }\r\n}\r\n\r\nexport class VirtualFilePreset extends Preset {\r\n  constructor(data) {\r\n    if (!data.name) data.name = data.src.split('/').pop();\r\n    data.name = decodeURIComponentSafely(data.name);\r\n\r\n    data.uuid = 'virtual@' + data.src;\r\n    data.documentName = isAudio(data.src) ? 'AmbientSound' : 'Tile';\r\n\r\n    if (data.documentName === 'Tile') {\r\n      data.data = [{ texture: { src: data.src }, x: 0, y: 0, rotation: 0 }];\r\n      if (isVideo(data.src)) data.img = 'icons/svg/video.svg';\r\n      else data.img = data.src;\r\n    } else {\r\n      data.data = [{ path: data.src, radius: 20, x: 0, y: 0 }];\r\n      data.img = 'icons/svg/sound.svg';\r\n    }\r\n\r\n    data.gridSize = 150;\r\n    super(data);\r\n    this.src = data.src;\r\n  }\r\n\r\n  get virtual() {\r\n    return true;\r\n  }\r\n\r\n  async load(force = false) {\r\n    if (this._storedReference) return this;\r\n\r\n    const p = await FileIndexer.getPreset(this.uuid);\r\n    if (p) this.tags = p.tags;\r\n    this._storedReference = p;\r\n\r\n    // Ambient Sound, no further processing required\r\n    if (this.data[0].path) return this;\r\n\r\n    // Load image/video metadata to retrieve the width/height\r\n    const src = this.data[0].texture?.src;\r\n\r\n    let width, height;\r\n    let prom;\r\n    if (isImage(src)) {\r\n      const img = new Image();\r\n      prom = new Promise((resolve) => {\r\n        img.onload = resolve;\r\n        img.src = src;\r\n      });\r\n\r\n      await Promise.race([\r\n        prom,\r\n        (async () => {\r\n          await new Promise((res) => setTimeout(res, 1000));\r\n        })(),\r\n      ]);\r\n\r\n      if (!img.complete || img.naturalWidth === 0) {\r\n        console.log('Image Load failed', src);\r\n        return null;\r\n      }\r\n\r\n      width = img.naturalWidth;\r\n      height = img.naturalHeight;\r\n    } else {\r\n      const video = document.createElement('video');\r\n      prom = new Promise((resolve) => {\r\n        video.onloadedmetadata = resolve;\r\n        video.src = src;\r\n        video.load();\r\n      });\r\n\r\n      await Promise.race([\r\n        prom,\r\n        (async () => {\r\n          await new Promise((res) => setTimeout(res, 1000));\r\n        })(),\r\n      ]);\r\n\r\n      width = video.videoWidth;\r\n      height = video.videoHeight;\r\n    }\r\n\r\n    this.data[0].width = width;\r\n    this.data[0].height = height;\r\n\r\n    return this;\r\n  }\r\n\r\n  async update(update) {\r\n    if (!update.hasOwnProperty('tags')) return;\r\n\r\n    if (this._storedReference) {\r\n      this._storedReference.tags = update.tags;\r\n      clearTimeout(VirtualFilePreset._updateTimeout);\r\n      VirtualFilePreset._updateTimeout = setTimeout(() => FileIndexer.saveIndexToCache(), 3000);\r\n    }\r\n  }\r\n\r\n  toJSON() {\r\n    const json = super.toJSON();\r\n    json.src = this.src;\r\n    return json;\r\n  }\r\n\r\n  clone() {\r\n    const clone = new VirtualFilePreset(this.toJSON());\r\n    return clone;\r\n  }\r\n}\r\n","import { showGenericForm } from '../../applications/multiConfig.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES } from '../utils.js';\r\nimport { Preset } from './preset.js';\r\n\r\n/**\r\n * Tracking of folder open/close state\r\n */\r\nexport class FolderState {\r\n  static expanded(uuid) {\r\n    return game.folders._expanded[uuid];\r\n  }\r\n\r\n  static setExpanded(uuid, state) {\r\n    game.folders._expanded[uuid] = state;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert provided placeable into an object usable as Preset data\r\n * @param {Placeable} placeable\r\n * @returns\r\n */\r\nexport function placeableToData(placeable) {\r\n  const data = placeable.document.toCompendium();\r\n\r\n  // Check if `Token Attacher` has attached elements to this token\r\n  if (\r\n    placeable.document.documentName === 'Token' &&\r\n    game.modules.get('token-attacher')?.active &&\r\n    tokenAttacher?.generatePrototypeAttached\r\n  ) {\r\n    const attached = data.flags?.['token-attacher']?.attached || {};\r\n    if (!foundry.utils.isEmpty(attached)) {\r\n      const prototypeAttached = tokenAttacher.generatePrototypeAttached(data, attached);\r\n      setProperty(data, 'flags.token-attacher.attached', null);\r\n      setProperty(data, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n      setProperty(data, 'flags.token-attacher.grid', {\r\n        size: canvas.grid.size,\r\n        w: canvas.grid.w,\r\n        h: canvas.grid.h,\r\n      });\r\n    }\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * Opens a GenericMassEdit form to modify specific fields within the provided data\r\n * @param {Object} data            data to be modified\r\n * @param {Array[String]} toModify fields within data to be modified\r\n * @returns modified data or null if form was canceled\r\n */\r\nexport async function modifySpawnData(data, toModify) {\r\n  const fields = {};\r\n  const flatData = foundry.utils.flattenObject(data);\r\n  for (const field of toModify) {\r\n    if (field in flatData) {\r\n      if (flatData[field] == null) fields[field] = '';\r\n      else fields[field] = flatData[field];\r\n    }\r\n  }\r\n\r\n  if (!foundry.utils.isEmpty(fields)) {\r\n    await new Promise((resolve) => {\r\n      showGenericForm(fields, 'PresetFieldModify', {\r\n        callback: (modified) => {\r\n          if (foundry.utils.isEmpty(modified)) {\r\n            if (modified == null) data = null;\r\n            resolve();\r\n            return;\r\n          }\r\n\r\n          for (const [k, v] of Object.entries(modified)) {\r\n            flatData[k] = v;\r\n          }\r\n\r\n          const tmpData = foundry.utils.expandObject(flatData);\r\n\r\n          const reorganizedData = [];\r\n          for (let i = 0; i < data.length; i++) {\r\n            reorganizedData.push(tmpData[i]);\r\n          }\r\n          data = reorganizedData;\r\n          resolve();\r\n        },\r\n        simplified: true,\r\n        noTabs: true,\r\n      });\r\n    });\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * A Preset may not contain enough information within its data to spawn a placeable. This method populates\r\n * the data with some defaults so that a minimum viable placeable can be spawned.\r\n * @param {Preset} preset\r\n * @param {Object} presetData\r\n * @returns\r\n */\r\nexport function mergePresetDataToDefaultDoc(preset, presetData) {\r\n  let data;\r\n\r\n  // Set default values if needed\r\n  switch (preset.documentName) {\r\n    case 'Token':\r\n      data = { name: preset.name, elevation: 0, x: 0, y: 0, rotation: 0, width: 1, height: 1 };\r\n      break;\r\n    case 'Tile':\r\n      data = { width: canvas.grid.w, height: canvas.grid.h, x: 0, y: 0, rotation: 0 };\r\n      break;\r\n    case 'AmbientSound':\r\n      data = { radius: 20, x: 0, y: 0 };\r\n      break;\r\n    case 'Drawing':\r\n      data = {\r\n        shape: {\r\n          width: canvas.grid.w * 2,\r\n          height: canvas.grid.h * 2,\r\n          strokeWidth: 8,\r\n          strokeAlpha: 1.0,\r\n        },\r\n        x: 0,\r\n        y: 0,\r\n        rotation: 0,\r\n      };\r\n      break;\r\n    case 'MeasuredTemplate':\r\n      data = { distance: 10, x: 0, y: 0 };\r\n      break;\r\n    case 'AmbientLight':\r\n      data = { config: { dim: 20, bright: 20 }, x: 0, y: 0 };\r\n      break;\r\n    case 'Scene':\r\n      data = { name: preset.name };\r\n      break;\r\n    case 'Wall':\r\n      data = { c: [0, 0, canvas.grid.size, 0] };\r\n      break;\r\n    default:\r\n      data = { x: 0, y: 0 };\r\n  }\r\n\r\n  return foundry.utils.mergeObject(data, presetData);\r\n}\r\n\r\nexport async function randomizeChildrenFolderColors(uuid, tree, callback) {\r\n  const folder = tree.allFolders.get(uuid);\r\n\r\n  const children = folder.children;\r\n  if (!children.length) return;\r\n\r\n  const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n    method: 'interpolateReverse',\r\n    space: 'srgb',\r\n    hue: 'longer',\r\n  });\r\n\r\n  let colorSlider;\r\n\r\n  const applyColors = async function (method, space, hue) {\r\n    const updates = children.map((c) => {\r\n      return {\r\n        color: '#000000',\r\n      };\r\n    });\r\n    const randObj = { color: { type: 'color', method, space, hue, colors: colorSlider.getColors() } };\r\n\r\n    await applyRandomization(updates, children, randObj);\r\n\r\n    for (let i = 0; i < children.length; i++) {\r\n      await children[i].update(updates[i]);\r\n    }\r\n\r\n    callback?.();\r\n  };\r\n\r\n  let dialog = new Dialog({\r\n    title: `Pick Range`,\r\n    content: `<form>${colorTemp}</form>`,\r\n    buttons: {\r\n      save: {\r\n        label: 'Apply',\r\n        callback: async (html) => {\r\n          applyColors(\r\n            html.find('[name=\"method\"]').val(),\r\n            html.find('[name=\"space\"]').val(),\r\n            html.find('[name=\"hue\"]').val()\r\n          );\r\n        },\r\n      },\r\n    },\r\n    render: (html) => {\r\n      import('../randomizer/slider.js').then((module) => {\r\n        colorSlider = new module.ColorSlider(html, [\r\n          { hex: '#663600', offset: 0 },\r\n          { hex: '#944f00', offset: 100 },\r\n        ]);\r\n        setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n      });\r\n    },\r\n  });\r\n\r\n  dialog.render(true);\r\n}\r\n\r\n/**\r\n * Calculates the necessary x and y offsets to place the mouse within the center of the preset data\r\n * assuming the mouse is on the top-left corner of the first element\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataCenterOffset(docToData) {\r\n  const b = getPresetDataBounds(docToData);\r\n  const center = { x: b.x + b.width / 2, y: b.y + b.height / 2 };\r\n  const transform = getTransformToOrigin(docToData);\r\n  return { x: center.x + transform.x, y: center.y + transform.y };\r\n}\r\n\r\n/**\r\n * Returns a transform that return first element to x:0, y:0 (z: 0)\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getTransformToOrigin(docToData) {\r\n  const [name, data] = docToData.entries().next().value;\r\n  const transform = {};\r\n  if (name === 'Wall') {\r\n    const c = data[0].c;\r\n    transform.x = -c[0];\r\n    transform.y = -c[1];\r\n  } else {\r\n    transform.x = -data[0].x;\r\n    transform.y = -data[0].y;\r\n    if (game.Levels3DPreview?._active) {\r\n      const height = data[0].elevation ?? data[0].flags?.levels?.rangeBottom ?? 0;\r\n      transform.z = -height;\r\n    }\r\n  }\r\n  return transform;\r\n}\r\n\r\n/**\r\n * Calculates and returns the overall bounds of the preset data\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataBounds(docToData) {\r\n  let x1 = Number.MAX_SAFE_INTEGER;\r\n  let y1 = Number.MAX_SAFE_INTEGER;\r\n  let x2 = Number.MIN_SAFE_INTEGER;\r\n  let y2 = Number.MIN_SAFE_INTEGER;\r\n  docToData.forEach((dataArr, docName) => {\r\n    for (const data of dataArr) {\r\n      const b = getDataBounds(docName, data);\r\n      if (b.x1 < x1) x1 = b.x1;\r\n      if (b.y1 < y1) y1 = b.y1;\r\n      if (b.x2 > x2) x2 = b.x2;\r\n      if (b.y2 > y2) y2 = b.y2;\r\n    }\r\n  });\r\n  return { x: x1, y: y1, width: x2 - x1, height: y2 - y1 };\r\n}\r\n\r\n/**\r\n * Calculates and returns bounds of placeable's data\r\n * @param {String} docName\r\n * @param {Object} data\r\n * @returns\r\n */\r\nfunction getDataBounds(docName, data) {\r\n  let x1, y1, x2, y2;\r\n\r\n  if (docName === 'Wall') {\r\n    x1 = Math.min(data.c[0], data.c[2]);\r\n    y1 = Math.min(data.c[1], data.c[3]);\r\n    x2 = Math.max(data.c[0], data.c[2]);\r\n    y2 = Math.max(data.c[1], data.c[3]);\r\n  } else {\r\n    x1 = data.x || 0;\r\n    y1 = data.y || 0;\r\n\r\n    let width, height;\r\n    if (docName === 'Tile') {\r\n      width = data.width;\r\n      height = data.height;\r\n    } else if (docName === 'Drawing') {\r\n      width = data.shape.width;\r\n      height = data.shape.height;\r\n    } else if (docName === 'Token') {\r\n      width = data.width * canvas.dimensions.size;\r\n      height = data.height * canvas.dimensions.size;\r\n    } else {\r\n      width = 0;\r\n      height = 0;\r\n    }\r\n\r\n    x2 = x1 + (width || 0);\r\n    y2 = y1 + (height || 0);\r\n  }\r\n  return { x1, y1, x2, y2 };\r\n}\r\n\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['jpg', 'jpeg', 'png', 'svg', 'webp', 'gif'].includes(extension);\r\n}\r\n\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['mp4', 'ogg', 'webm', 'm4v'].includes(extension);\r\n}\r\n\r\nexport function decodeURIComponentSafely(uri) {\r\n  try {\r\n    return decodeURIComponent(uri);\r\n  } catch (e) {\r\n    console.warn('URI Component not decodable: ' + uri);\r\n    return uri;\r\n  }\r\n}\r\n\r\nexport function encodeURIComponentSafely(uri) {\r\n  try {\r\n    return encodeURIComponent(uri);\r\n  } catch (e) {\r\n    console.warn('URI Component not encodable: ' + uri);\r\n    return uri;\r\n  }\r\n}\r\n\r\nexport async function readJSONFile(url) {\r\n  try {\r\n    return await jQuery.getJSON(url);\r\n  } catch (e) {}\r\n  return null;\r\n}\r\n","import { getData, regexStringReplace, wildcardStringReplace } from '../utils.js';\r\n\r\nexport function selectField(control) {\r\n  const formGroup = control.closest('.form-group');\r\n  formGroup.find('.mass-edit-checkbox input').prop('checked', true).trigger('change');\r\n  formGroup.find('.mass-edit-randomize').addClass('active');\r\n}\r\n\r\nexport function deselectField(control, configApp) {\r\n  const formGroup = control.closest('.form-group');\r\n\r\n  let allRandomizedRemoved = true;\r\n  if (configApp) {\r\n    formGroup.find('[name]').each(function () {\r\n      if (allRandomizedRemoved) allRandomizedRemoved = !Boolean(configApp.randomizeFields[this.name]);\r\n    });\r\n  }\r\n\r\n  if (allRandomizedRemoved) {\r\n    formGroup.find('.mass-edit-checkbox input').prop('checked', false).trigger('change');\r\n    formGroup.find('.mass-edit-randomize').removeClass('active');\r\n  }\r\n}\r\n\r\nexport function selectRandomizerFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    selectField(form.find(`[name=\"${key}\"]`));\r\n  }\r\n}\r\n\r\nexport async function applyRandomization(updates, objects, randomizeFields) {\r\n  // See if any field is to be randomized\r\n  if (!randomizeFields || foundry.utils.isEmpty(randomizeFields)) return;\r\n\r\n  let requiresCoordRandomization = false;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    for (const field of Object.keys(update)) {\r\n      if (field in randomizeFields) {\r\n        const obj = randomizeFields[field];\r\n\r\n        if (obj.type === 'select') {\r\n          update[field] = obj.selection[Math.floor(Math.random() * obj.selection.length)];\r\n        } else if (obj.type === 'number') {\r\n          obj.step = obj.step === 'any' ? 1 : Number(obj.step);\r\n          if (Number.isNaN(obj.step)) obj.step = 1;\r\n\r\n          if (obj.method === 'interpolate') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step + 1;\r\n            update[field] = (i % stepsInRange) * obj.step + obj.min;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step;\r\n            update[field] = (stepsInRange - (i % (stepsInRange + 1))) * obj.step + obj.min;\r\n          } else {\r\n            const stepsInRange = (obj.max - obj.min + (Number.isInteger(obj.step) ? 1 : 0)) / obj.step;\r\n            update[field] = Math.floor(Math.random() * stepsInRange) * obj.step + obj.min;\r\n          }\r\n        } else if (obj.type === 'boolean') {\r\n          update[field] = Math.random() < 0.5;\r\n        } else if (obj.type === 'color') {\r\n          // Convert to new format if needed\r\n          if (obj.color1) {\r\n            obj.colors = [\r\n              { hex: obj.color1, offset: 0 },\r\n              { hex: obj.color2, offset: 100 },\r\n            ];\r\n          }\r\n\r\n          // If space is discrete we simple choose a color, no blending required\r\n          if (obj.space === 'discrete') {\r\n            if (obj.method === 'interpolate') {\r\n              update[field] = obj.colors[i % obj.colors.length].hex;\r\n            } else if (obj.method === 'interpolateReverse') {\r\n              update[field] = obj.colors[obj.colors.length - 1 - (i % obj.colors.length)].hex;\r\n            } else {\r\n              update[field] = obj.colors[Math.floor(Math.random() * obj.colors.length)].hex;\r\n            }\r\n            continue;\r\n          }\r\n\r\n          let colors = obj.colors.map((c) => c);\r\n          if (colors[0].offset > 0) {\r\n            colors.unshift({ hex: colors[0].hex, offset: 0 });\r\n          }\r\n          if (colors[colors.length - 1].offset < 100) {\r\n            colors.push({ hex: colors[colors.length - 1].hex, offset: 100 });\r\n          }\r\n\r\n          // Calculate random offset\r\n          let rOffset;\r\n          if (obj.method === 'interpolate') {\r\n            rOffset = 1 - (i + 1) / updates.length;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            rOffset = (i + 1) / updates.length;\r\n          } else {\r\n            rOffset = Math.random();\r\n          }\r\n          rOffset *= 100;\r\n\r\n          // Find the two colors the random offset falls between\r\n          let j = 0;\r\n          while (j < colors.length - 1 && colors[j + 1].offset < rOffset) j++;\r\n          let color1, color2;\r\n          if (j === colors.length - 1) {\r\n            color1 = colors[j - 1];\r\n            color2 = colors[j];\r\n          } else {\r\n            color1 = colors[j];\r\n            color2 = colors[j + 1];\r\n          }\r\n\r\n          // Normalize the random offset\r\n          let rnOffset = rOffset - color1.offset;\r\n          rnOffset = rnOffset / (color2.offset - color1.offset);\r\n\r\n          // Create a Color.js range\r\n          const Color = (await import('../color/color.js')).default;\r\n          color1 = new Color(color1.hex);\r\n          color2 = new Color(color2.hex);\r\n          const space = obj.space || 'srgb';\r\n          const hue = obj.hue || 'shorter';\r\n          let range = color1.range(color2, {\r\n            space: space, // interpolation space\r\n            hue: hue,\r\n            outputSpace: 'srgb',\r\n          });\r\n\r\n          // Pick a color from range using normalized random offset\r\n          let rgb3 = range(rnOffset);\r\n          let hexColor = rgb3.toString({ format: 'hex' });\r\n          if (hexColor.length < 7) {\r\n            // 3 char hex, duplicate chars\r\n            hexColor = '#' + hexColor[1] + hexColor[1] + hexColor[2] + hexColor[2] + hexColor[3] + hexColor[3];\r\n          }\r\n          update[field] = hexColor;\r\n        } else if (obj.type === 'image') {\r\n          if (obj.method === 'sequential') {\r\n            update[field] = obj.images[i % obj.images.length];\r\n          } else {\r\n            update[field] = obj.images[Math.floor(Math.random() * obj.images.length)];\r\n          }\r\n\r\n          if (obj.maintainAspect) {\r\n            const width = objects?.[i]?.width ?? update.width;\r\n            const height = objects?.[i]?.height ?? update.height;\r\n            if (height != null && width != null) {\r\n              try {\r\n                const tex = await loadTexture(update[field]);\r\n                if (tex) {\r\n                  const tileRatio = width / height;\r\n                  const texRatio = tex.width / tex.height;\r\n                  if (texRatio !== tileRatio) {\r\n                    if (texRatio > tileRatio) {\r\n                      update['texture.scaleX'] = 1;\r\n                      update['texture.scaleY'] = tileRatio;\r\n                    } else {\r\n                      update['texture.scaleX'] = height / width;\r\n                      update['texture.scaleY'] = 1;\r\n                    }\r\n                  }\r\n                }\r\n              } catch (e) {}\r\n            }\r\n          }\r\n        } else if (obj.type === 'text') {\r\n          if (obj.method === 'findAndReplace' || obj.method === 'findAndReplaceRegex') {\r\n            if (objects) {\r\n              const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n              if (!data[field] && !obj.find) {\r\n                update[field] = obj.replace;\r\n              } else if (data[field]) {\r\n                // special handling for Tagger tags\r\n                if (field === 'flags.tagger.tags') {\r\n                  data[field] = data[field].join(',');\r\n                }\r\n\r\n                if (obj.method === 'findAndReplaceRegex') {\r\n                  update[field] = regexStringReplace(obj.find, obj.replace, data[field]);\r\n                } else {\r\n                  update[field] = wildcardStringReplace(obj.find, obj.replace, data[field]);\r\n                }\r\n              }\r\n            }\r\n          } else {\r\n            if (obj.method === 'unique') {\r\n              if (!obj.shuffled) {\r\n                shuffleArray(obj.strings);\r\n                obj.shuffled = true;\r\n                obj.i = -1;\r\n              }\r\n              obj.i++;\r\n              update[field] = obj.strings[obj.i % obj.strings.length];\r\n            } else {\r\n              update[field] = obj.strings[Math.floor(Math.random() * obj.strings.length)];\r\n            }\r\n          }\r\n        } else if (obj.type === 'coordinate') {\r\n          requiresCoordRandomization = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (requiresCoordRandomization) {\r\n    let coordCtrl;\r\n\r\n    // Sort placeables based on size\r\n    let pUpdates = [];\r\n    for (let i = 0; i < objects.length; i++) {\r\n      pUpdates.push({ p: objects[i], update: updates[i] });\r\n    }\r\n    pUpdates.sort(\r\n      (a, b) =>\r\n        (b.p.w ?? b.p.width ?? 0) + (b.p.h ?? b.p.height ?? 0) - (a.p.w ?? a.p.width ?? 0) - (a.p.h ?? a.p.height ?? 0)\r\n    );\r\n\r\n    for (const pUpdate of pUpdates) {\r\n      const obj = randomizeFields.x ?? randomizeFields.y;\r\n      if (obj.method === 'noOverlap') {\r\n        if (!coordCtrl) {\r\n          coordCtrl = {\r\n            freeId: 0,\r\n            boundingBox: obj.boundingBox,\r\n            freeRectangles: { 0: obj.boundingBox },\r\n            stepX: obj.stepX,\r\n            stepY: obj.stepY,\r\n          };\r\n        }\r\n        const [x, y] = randomPlace(pUpdate.p, coordCtrl);\r\n        pUpdate.update.x = x;\r\n        pUpdate.update.y = y;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the closest step increment to the provided number\r\n * @param {*} num\r\n * @param {*} step\r\n * @returns\r\n */\r\nexport function nearestStep(num, step) {\r\n  if (num % step <= step / 2) {\r\n    return num - (num % step);\r\n  }\r\n  return num - (num % step) + step;\r\n}\r\n\r\n/**\r\n * Generates a random number within the given range and step increment\r\n * @param {*} min\r\n * @param {*} max\r\n * @param {*} step\r\n * @returns\r\n */\r\nfunction randomNum(min, max, step) {\r\n  if (step === 'any') step = 1; // default to integer 1 just to avoid very large decimals\r\n  else step = Number(step);\r\n  const stepsInRange = (max - min) / step;\r\n  return Math.floor(Math.random() * (stepsInRange + (Number.isInteger(step) ? 1 : 0))) * step + min;\r\n}\r\n\r\n/**\r\n * In-place random shuffle of an array\r\n * @param {*} array\r\n * @returns\r\n */\r\nfunction shuffleArray(array) {\r\n  var i = array.length,\r\n    j = 0,\r\n    temp;\r\n\r\n  while (i--) {\r\n    j = Math.floor(Math.random() * (i + 1));\r\n\r\n    // swap randomly chosen element with current element\r\n    temp = array[i];\r\n    array[i] = array[j];\r\n    array[j] = temp;\r\n  }\r\n\r\n  return array;\r\n}\r\n\r\n/* ================================\r\n * === Coordinate Randomization ==\r\n * =============================== */\r\n\r\nfunction randomPlace(placeable, ctrl) {\r\n  const width = nearestStep(placeable.w ?? placeable.width, ctrl.stepX);\r\n  const height = nearestStep(placeable.h ?? placeable.height, ctrl.stepY);\r\n\r\n  const rec = { x: 0, y: 0, width: width, height: height };\r\n  const freeRectangles = ctrl.freeRectangles;\r\n\r\n  // get all free rectangles that can contain rec\r\n  let fittingRecs = Object.keys(freeRectangles).filter((id) => _canFit(freeRectangles[id], rec));\r\n\r\n  // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n\r\n  if (fittingRecs.length) {\r\n    // Pick a random free rectangle and choose a random location within so that it fits rec\r\n    const i = fittingRecs[Math.floor(Math.random() * fittingRecs.length)];\r\n    rec.x = randomNum(\r\n      freeRectangles[i].x,\r\n      Math.max(freeRectangles[i].x + freeRectangles[i].width - rec.width, 0),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      freeRectangles[i].y,\r\n      Math.max(freeRectangles[i].y + freeRectangles[i].height - rec.height, 0),\r\n      ctrl.stepY\r\n    );\r\n  } else {\r\n    // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n    rec.x = randomNum(\r\n      ctrl.boundingBox.x,\r\n      Math.max(ctrl.boundingBox.x + ctrl.boundingBox.width - rec.width, ctrl.boundingBox.x),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      ctrl.boundingBox.y,\r\n      Math.max(ctrl.boundingBox.y + ctrl.boundingBox.height - rec.height, ctrl.boundingBox.y),\r\n      ctrl.stepY\r\n    );\r\n  }\r\n\r\n  // Find all free rectangles that this spot overlaps\r\n  let overlaps = Object.keys(freeRectangles).filter((id) => _intersectRec(freeRectangles[id], rec));\r\n\r\n  for (const id of overlaps) {\r\n    const overlap = freeRectangles[id];\r\n    // remove original rectangle\r\n    delete freeRectangles[id];\r\n\r\n    // left split\r\n    if (overlap.x < rec.x) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: rec.x - overlap.x,\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // right split\r\n    if (overlap.x + overlap.width > rec.x + rec.width) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: rec.x + rec.width,\r\n          y: overlap.y,\r\n          width: overlap.x + overlap.width - (rec.x + rec.width),\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // top split\r\n    if (overlap.y < rec.y) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: overlap.width,\r\n          height: rec.y - overlap.y,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // bottom split\r\n    if (overlap.y + overlap.height > rec.y + rec.height) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: rec.y + rec.height,\r\n          width: overlap.width,\r\n          height: overlap.y + overlap.height - (rec.y + rec.height),\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n  }\r\n\r\n  return [rec.x, rec.y];\r\n}\r\n\r\n/**\r\n * Checks if rectangle rec2 can fit within rectangle rec1\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _canFit(rec1, rec2) {\r\n  return rec2.width <= rec1.width && rec2.height <= rec1.height;\r\n}\r\n\r\n/**\r\n * Checks whether rectangle rec1 and rectangle rec2 intersect\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _intersectRec(rec1, rec2) {\r\n  if (rec1.x < rec2.x + rec2.width && rec2.x < rec1.x + rec1.width && rec1.y < rec2.y + rec2.height)\r\n    return rec2.y < rec1.y + rec1.height;\r\n  else return false;\r\n}\r\n\r\n/**\r\n * Check if rectangle rec1 fully contains rectangle rec2\r\n * @param {*} rec1\r\n * @param {*} rec\r\n * @returns\r\n */\r\nfunction _fullyContains(rec1, rec2) {\r\n  return (\r\n    rec1.x <= rec2.x &&\r\n    rec1.x + rec1.width >= rec2.x + rec2.width &&\r\n    rec1.y <= rec2.y &&\r\n    rec1.y + rec1.height >= rec2.y + rec2.height\r\n  );\r\n}\r\n\r\n/**\r\n *\r\n * @param {*} freeRectangles\r\n * @param {*} rec\r\n * @param {*} ctrl\r\n * @returns\r\n */\r\nfunction _addAndMergeFreeRectangle(freeRectangles, rec, ctrl) {\r\n  const keys = Object.keys(freeRectangles);\r\n  for (const key of keys) {\r\n    if (_fullyContains(freeRectangles[key], rec)) {\r\n      return;\r\n    }\r\n  }\r\n  ctrl.freeId++;\r\n  freeRectangles[ctrl.freeId] = rec;\r\n}\r\n","import { GeneralDataAdapter } from '../applications/dataAdapters.js';\r\nimport { MassEditPresets } from './presets/forms.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\n\r\nexport const MODULE_ID = 'multi-token-edit';\r\nexport const SUPPORTED_PLACEABLES = [\r\n  'Token',\r\n  'MeasuredTemplate',\r\n  'Tile',\r\n  'Drawing',\r\n  'Wall',\r\n  'AmbientLight',\r\n  'AmbientSound',\r\n  'Note',\r\n];\r\nexport const UI_DOCS = ['FAVORITES', 'ALL', ...SUPPORTED_PLACEABLES];\r\nexport const SUPPORT_SHEET_CONFIGS = [...SUPPORTED_PLACEABLES, 'Actor', 'PlaylistSound', 'Scene'];\r\nexport const SUPPORTED_COLLECTIONS = ['Item', 'Cards', 'RollTable', 'Actor', 'JournalEntry', 'Scene'];\r\nconst IMAGE_EXTENSIONS = ['webp', 'jpg', 'jpeg', 'png', 'svg', 'apng', 'avif', 'bmp', 'gif', 'tif'];\r\nconst VIDEO_EXTENSIONS = ['mp4', 'ogv', 'webm', 'm4v'];\r\nconst AUDIO_EXTENSIONS = ['aac', 'flac', 'm4a', 'mid', 'mp3', 'ogg', 'opus', 'wav'];\r\nexport const FILE_EXTENSIONS = [...IMAGE_EXTENSIONS, ...VIDEO_EXTENSIONS, ...AUDIO_EXTENSIONS];\r\n\r\nexport function interpolateColor(u, c1, c2) {\r\n  return c1.map((a, i) => Math.floor((1 - u) * a + u * c2[i]));\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to an image\r\n */\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return IMAGE_EXTENSIONS.includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to a video\r\n */\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return VIDEO_EXTENSIONS.includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to an audio file\r\n */\r\nexport function isAudio(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return AUDIO_EXTENSIONS.includes(extension);\r\n}\r\n\r\nexport async function recursiveTraverse(path, source, bucket, files = []) {\r\n  const result = await FilePicker.browse(source, path, {\r\n    bucket: bucket,\r\n  });\r\n\r\n  if (result) {\r\n    for (const file of result.files) {\r\n      files.push(file);\r\n    }\r\n\r\n    for (const dir of result.dirs) {\r\n      await recursiveTraverse(dir, source, bucket, files);\r\n    }\r\n  }\r\n\r\n  return files;\r\n}\r\n\r\n// To get rid of v10 warnings\r\nexport function getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n\r\n// Flags are stored inconsistently. Absence of a flag, being set to null, undefined, empty object or empty string\r\n// should all be considered equal\r\nexport function flagCompare(data, flag, flagVal) {\r\n  if (data[flag] == flagVal) return true;\r\n\r\n  const falseyFlagVal =\r\n    flagVal == null ||\r\n    flagVal === false ||\r\n    flagVal === '' ||\r\n    (foundry.utils.getType(flagVal) === 'Object' && foundry.utils.isEmpty(flagVal));\r\n\r\n  const falseyDataVal =\r\n    data[flag] == null ||\r\n    data[flag] === false ||\r\n    data[flag] === '' ||\r\n    (foundry.utils.getType(data[flag]) === 'Object' && foundry.utils.isEmpty(data[flag]));\r\n\r\n  if (falseyFlagVal && falseyDataVal) return true;\r\n\r\n  // Special treatment for Tagger module's tags\r\n  // Instead of directly comparing string we check if it contains the string\r\n  if (flag === 'flags.tagger.tags') {\r\n    const tags = data[flag] || [];\r\n    let compTags = flagVal;\r\n    if (!Array.isArray(compTags)) {\r\n      compTags = flagVal ? flagVal.split(',').map((s) => s.trim()) : [];\r\n    }\r\n    for (const t of compTags) {\r\n      if (!tags.includes(t)) return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  if (flagVal && typeof flagVal === 'string' && flagVal.includes('*')) {\r\n    return wildcardStringMatch(flagVal, data[flag]);\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function hasFlagRemove(flag, formData) {\r\n  const comp = flag.split('.');\r\n  for (let i = comp.length - 1; i >= 1; i--) {\r\n    const tempFlag = comp.slice(0, i).join('.') + '.-=' + comp[i];\r\n    if (tempFlag in formData) {\r\n      return tempFlag;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function selectAddSubtractFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    form\r\n      .find(`[name=\"${key}\"]`)\r\n      .removeClass('me-add')\r\n      .removeClass('me-subtract')\r\n      .addClass(fields[key].method === 'add' ? 'me-add' : 'me-subtract')\r\n      .attr(\r\n        'title',\r\n        fields[key].method === 'add' ? `+ ${localize('form.adding')}` : `- ${localize('form.subtracting')}`\r\n      );\r\n  }\r\n}\r\n\r\nexport function applyAddSubtract(updates, objects, docName, addSubtractFields) {\r\n  // See if any field need to be added or subtracted\r\n  if (!addSubtractFields || foundry.utils.isEmpty(addSubtractFields)) return;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n\r\n    GeneralDataAdapter.dataToForm(docName, objects[i], data);\r\n\r\n    for (const field of Object.keys(update)) {\r\n      if (field in addSubtractFields && field in data) {\r\n        const ctrl = addSubtractFields[field];\r\n        let val = data[field];\r\n\r\n        // Special processing for Tagger module fields\r\n        if (field === 'flags.tagger.tags') {\r\n          const currentTags = Array.isArray(val) ? val : (val ?? '').split(',').map((s) => s.trim());\r\n          const modTags = (update[field] ?? '').split(',').map((s) => s.trim());\r\n          for (const tag of modTags) {\r\n            if (ctrl.method === 'add') {\r\n              if (!currentTags.includes(tag)) currentTags.push(tag);\r\n            } else if (ctrl.method === 'subtract') {\r\n              const index = currentTags.indexOf(tag);\r\n              if (index > -1) currentTags.splice(index, 1);\r\n            }\r\n          }\r\n          update[field] = currentTags.filter((t) => t).join(',');\r\n          continue;\r\n        } else if (ctrl.type === 'text') {\r\n          if (ctrl.method === 'add') {\r\n            const toAdd = 'value' in ctrl ? ctrl.value : update[field];\r\n            if (toAdd.startsWith('>>')) {\r\n              val = toAdd.replace('>>', '') + val;\r\n            } else {\r\n              val += toAdd;\r\n            }\r\n          } else {\r\n            val = val.replace('value' in ctrl ? ctrl.value : update[field], '');\r\n          }\r\n          update[field] = val;\r\n          continue;\r\n        }\r\n\r\n        if (ctrl.method === 'add') {\r\n          val += 'value' in ctrl ? ctrl.value : update[field];\r\n        } else {\r\n          val -= 'value' in ctrl ? ctrl.value : update[field];\r\n        }\r\n        if ('min' in ctrl && val < ctrl.min) {\r\n          val = ctrl.min;\r\n        } else if ('max' in ctrl && val > ctrl.max) {\r\n          val = ctrl.max;\r\n        }\r\n        update[field] = val;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function getCommonData(objects) {\r\n  if (!objects || !objects.length) return {};\r\n  const commonData = foundry.utils.flattenObject(objects[0]);\r\n  for (let i = 1; i < objects.length; i++) {\r\n    const diff = foundry.utils.flattenObject(\r\n      foundry.utils.diffObject(commonData, foundry.utils.flattenObject(objects[i]))\r\n    );\r\n    for (const k of Object.keys(diff)) {\r\n      // Special handling for empty/undefined data\r\n      if ((diff[k] === '' || diff[k] == null) && (commonData[k] === '' || commonData[k] == null)) {\r\n        // matches, do not remove\r\n      } else {\r\n        delete commonData[k];\r\n      }\r\n    }\r\n  }\r\n  return commonData;\r\n}\r\n\r\n/**\r\n * Merges 'other' into 'original' without expanding and duplicating the 'original' if it contains dot notation using keys\r\n */\r\nexport function mergeObjectPreserveDot(original, other = {}, nestedKey = '') {\r\n  if (!other) return;\r\n  for (const [key, val] of Object.entries(original)) {\r\n    const fullKey = nestedKey ? nestedKey + '.' + key : key;\r\n    const t = foundry.utils.getType(val);\r\n    if (t === 'Object') mergeObjectPreserveDot(val, other, fullKey);\r\n    else {\r\n      const prop = getProperty(other, fullKey);\r\n      if (prop !== undefined) {\r\n        original[key] = prop;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function panToFitPlaceables(placeables) {\r\n  placeables = placeables.map((p) => p.object ?? p).filter((p) => p.center);\r\n  if (placeables.length) {\r\n    if (placeables.length === 1) {\r\n      if (placeables[0].center?.x) {\r\n        canvas.animatePan({ x: placeables[0].center.x, y: placeables[0].center.y, duration: 250 });\r\n      }\r\n    } else {\r\n      // Determine top left and bottom right corners to later determine the view's center position and scale\r\n      const topLeft = { x: 999999999, y: 999999999 };\r\n      const bottomRight = { x: -999999999, y: -999999999 };\r\n\r\n      for (let p of placeables) {\r\n        let tlc = p;\r\n        if (p instanceof Wall) {\r\n          tlc = { x: p.center.x - p.width / 2, y: p.center.y - p.height / 2 };\r\n        }\r\n\r\n        if (tlc.x < topLeft.x) topLeft.x = tlc.x;\r\n        if (tlc.y < topLeft.y) topLeft.y = tlc.y;\r\n        if (tlc.x + p.width > bottomRight.x) bottomRight.x = tlc.x + p.width;\r\n        if (tlc.y + p.height > bottomRight.y) bottomRight.y = tlc.y + p.height;\r\n      }\r\n\r\n      // Checking if screen at current scale fits placeables along x and y axis\r\n      let scale = canvas.scene._viewPosition.scale;\r\n      // Adjust the size of the rectangle that placeable occupy in our scale calculations\r\n      // to account for UI elements\r\n      const padding = 100;\r\n      if (bottomRight.x - topLeft.x + padding > canvas.screenDimensions[0] / scale) {\r\n        scale = canvas.screenDimensions[0] / (bottomRight.x - topLeft.x + padding);\r\n      }\r\n      if (bottomRight.y - topLeft.y + padding > canvas.screenDimensions[1] / scale) {\r\n        scale = canvas.screenDimensions[1] / (bottomRight.y - topLeft.y + padding);\r\n      }\r\n\r\n      canvas.animatePan({\r\n        duration: 250,\r\n        scale,\r\n        x: (bottomRight.x - topLeft.x) / 2 + topLeft.x,\r\n        y: (bottomRight.y - topLeft.y) / 2 + topLeft.y,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns a hash code from a string\r\n * @param  {String} str The string to hash.\r\n * @return {Number}    A 32bit integer\r\n * @see http://werxltd.com/wp/2010/05/13/javascript-implementation-of-javas-string-hashcode-method/\r\n */\r\nexport function hashCode(str) {\r\n  let hash = 0;\r\n  for (let i = 0, len = str.length; i < len; i++) {\r\n    let chr = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + chr;\r\n    hash |= 0; // Convert to 32bit integer\r\n  }\r\n  return hash;\r\n}\r\n\r\nfunction escapeRegex(string) {\r\n  return string.replace(/[/\\-\\\\^$+?.()|[\\]{}]/g, '\\\\$&');\r\n}\r\n\r\nexport function wildcardStringMatch(sw, s2) {\r\n  return new RegExp('^' + escapeRegex(sw).replaceAll('*', '.*') + '$').test(s2);\r\n}\r\n\r\nexport function wildcardStringReplace(sw, replaceWith, s2) {\r\n  let re = new RegExp(escapeRegex(sw).replaceAll('*', '.*'), 'g');\r\n  return s2.replaceAll(re, replaceWith);\r\n}\r\n\r\nexport function regexStringReplace(sw, replaceWith, s2) {\r\n  try {\r\n    let re = new RegExp(sw, 'g');\r\n    return s2.replaceAll(re, replaceWith);\r\n  } catch (e) {}\r\n  return s2;\r\n}\r\n\r\nexport function flattenToDepth(obj, d = 0) {\r\n  if (d === 0) return obj;\r\n\r\n  const flat = {};\r\n  for (let [k, v] of Object.entries(obj)) {\r\n    let t = foundry.utils.getType(v);\r\n    if (t === 'Object') {\r\n      if (foundry.utils.isEmpty(v)) flat[k] = v;\r\n      let inner = flattenToDepth(v, d - 1);\r\n      for (let [ik, iv] of Object.entries(inner)) {\r\n        flat[`${k}.${ik}`] = iv;\r\n      }\r\n    } else flat[k] = v;\r\n  }\r\n  return flat;\r\n}\r\n\r\n// TODO\r\nexport function activeEffectPresetSelect(aeConfig) {\r\n  const showPresetGeneric = function (docName) {\r\n    new MassEditPresets(\r\n      aeConfig,\r\n      async (preset) => {\r\n        if (!foundry.utils.isEmpty(preset.randomize)) {\r\n          await applyRandomization(preset.data, null, preset.randomize);\r\n        }\r\n\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        Object.keys(preset.data[0]).forEach((k) => {\r\n          let value;\r\n          if (foundry.utils.getType(preset.data[0][k]) === 'string') value = preset.data[0][k];\r\n          else value = JSON.stringify(preset.data[0][k]);\r\n\r\n          nChanges.push({\r\n            key: docName === 'Token' ? 'ATL.' + k : k,\r\n            mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE,\r\n            priority: 20,\r\n            value,\r\n          });\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      docName\r\n    ).render(true);\r\n  };\r\n\r\n  const showPresetActiveEffect = function () {\r\n    new MassEditPresets(\r\n      aeConfig,\r\n      (preset) => {\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        preset.data[0].changes?.forEach((change) => {\r\n          if (change.key) {\r\n            nChanges.push(\r\n              foundry.utils.mergeObject({ mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE, priority: 20 }, change)\r\n            );\r\n          }\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      'ActiveEffect'\r\n    ).render(true);\r\n  };\r\n\r\n  new Dialog({\r\n    title: localize('common.presets'),\r\n    content: ``,\r\n    buttons: {\r\n      activeEffect: {\r\n        label: 'ActiveEffect',\r\n        callback: () => showPresetActiveEffect(),\r\n      },\r\n      token: {\r\n        label: 'Token',\r\n        callback: () => showPresetGeneric('Token'),\r\n      },\r\n      actor: {\r\n        label: 'Actor',\r\n        callback: () => showPresetGeneric('Actor'),\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport function getDocumentName(doc) {\r\n  const docName = doc.document ? doc.document.documentName : doc.documentName;\r\n  return docName ?? 'NONE';\r\n}\r\n\r\nexport const DOCUMENT_CREATE_REQUESTS = {};\r\n\r\n/**\r\n * Creates documents either directly or by delegating the task to a GM\r\n * @param {String} documentName  document type to be created\r\n * @param {Array[Object]} data   data defining the documents\r\n * @param {String} sceneID       scene the documents should be created on\r\n * @returns placeable documents that have been created\r\n */\r\nexport async function createDocuments(documentName, data, sceneID) {\r\n  if (game.user.isGM) {\r\n    return game.scenes.get(sceneID).createEmbeddedDocuments(documentName, data);\r\n  }\r\n\r\n  const requestID = foundry.utils.randomID();\r\n\r\n  const message = {\r\n    handlerName: 'document',\r\n    args: { sceneID, documentName, data, requestID },\r\n    type: 'CREATE',\r\n  };\r\n  game.socket.emit(`module.${MODULE_ID}`, message);\r\n\r\n  // Self resolve in 4s if no response from a GM is received\r\n  setTimeout(() => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID]?.([]);\r\n  }, 4000);\r\n\r\n  return new Promise((resolve) => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID] = resolve;\r\n  });\r\n}\r\n\r\n/**\r\n * Resolves the delegated create documents request\r\n * @param {object} options\r\n * @param {String} options.requestID          request to be resolved\r\n * @param {String} options.sceneID            scene the documents have been created on\r\n * @param {String} options.documentName       type of document that has been created\r\n * @param {Array[String]} options.documentIDs array of document ids that have been created\r\n */\r\nexport function resolveCreateDocumentRequest({ requestID, sceneID, documentName, documentIDs } = {}) {\r\n  if (!DOCUMENT_CREATE_REQUESTS.hasOwnProperty(requestID)) return;\r\n\r\n  const scene = game.scenes.get(sceneID);\r\n  const documents = [];\r\n  for (const docID of documentIDs) {\r\n    documents.push(scene.getEmbeddedDocument(documentName, docID));\r\n  }\r\n\r\n  DOCUMENT_CREATE_REQUESTS[requestID](documents);\r\n  delete DOCUMENT_CREATE_REQUESTS[requestID];\r\n}\r\n\r\nexport function localize(path, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.localize(`MassEdit.${path}`);\r\n  return game.i18n.localize(path);\r\n}\r\n\r\nexport function localFormat(path, insert, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.format(`MassEdit.${path}`, insert);\r\n  return game.i18n.format(path, insert);\r\n}\r\n\r\nexport async function applyPresetToScene(preset) {\r\n  if (preset && canvas.scene) {\r\n    await preset.load();\r\n    const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n    const randomizer = preset.randomize;\r\n    if (!foundry.utils.isEmpty(randomizer)) {\r\n      await applyRandomization([data], null, randomizer);\r\n    }\r\n\r\n    await canvas.scene.update(data);\r\n\r\n    // Grid doesn't redraw on scene update, do it manually here\r\n    if ('grid.color' in data || 'grid.alpha' in data) {\r\n      canvas.grid.grid.draw({\r\n        color: (data['grid.color'] ?? canvas.scene.grid.color).replace('#', '0x'),\r\n        alpha: Number(data['grid.alpha'] ?? canvas.scene.grid.alpha),\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport async function executeScript(command, { actor, token, ...scope } = {}) {\r\n  // Add variables to the evaluation scope\r\n  const speaker = ChatMessage.implementation.getSpeaker({ actor, token });\r\n  const character = game.user.character;\r\n  token = token || (canvas.ready ? canvas.tokens.get(speaker.token) : null);\r\n  actor = actor || token?.actor || game.actors.get(speaker.actor);\r\n\r\n  // Unpack argument names and values\r\n  const argNames = Object.keys(scope);\r\n  if (argNames.some((k) => Number.isNumeric(k))) {\r\n    throw new Error('Illegal numeric Macro parameter passed to execution scope.');\r\n  }\r\n  const argValues = Object.values(scope);\r\n\r\n  // Define an AsyncFunction that wraps the macro content\r\n  const AsyncFunction = async function () {}.constructor;\r\n  // eslint-disable-next-line no-new-func\r\n  const fn = new AsyncFunction('speaker', 'actor', 'token', 'character', 'scope', ...argNames, `{${command}\\n}`);\r\n\r\n  // Attempt macro execution\r\n  try {\r\n    return await fn.call(this, speaker, actor, token, character, scope, ...argValues);\r\n  } catch (err) {\r\n    ui.notifications.error('MACRO.Error', { localize: true });\r\n  }\r\n}\r\n\r\nexport class SeededRandom {\r\n  /**\r\n   * Seeded variation of the Foundry's randomID(...) function.\r\n   * Generate a random string ID of a given requested length.\r\n   * @param {String} seed      Seed to be fed into random number generator\r\n   * @param {number} length    The length of the random ID to generate\r\n   * @return {string}          Return a string containing random letters and numbers\r\n   */\r\n  static randomID(seed, length = 16) {\r\n    seed = this.cyrb128(seed);\r\n    const random = this.sfc32(seed[0], seed[1], seed[2], seed[3]);\r\n\r\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    const r = Array.from({ length }, () => (random() * chars.length) >> 0);\r\n    return r.map((i) => chars[i]).join('');\r\n  }\r\n\r\n  // Courtesy of bryc\r\n  // github.com/bryc\r\n  static cyrb128(str) {\r\n    let h1 = 1779033703,\r\n      h2 = 3144134277,\r\n      h3 = 1013904242,\r\n      h4 = 2773480762;\r\n    for (let i = 0, k; i < str.length; i++) {\r\n      k = str.charCodeAt(i);\r\n      h1 = h2 ^ Math.imul(h1 ^ k, 597399067);\r\n      h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);\r\n      h3 = h4 ^ Math.imul(h3 ^ k, 951274213);\r\n      h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);\r\n    }\r\n    h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);\r\n    h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);\r\n    h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);\r\n    h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);\r\n    (h1 ^= h2 ^ h3 ^ h4), (h2 ^= h1), (h3 ^= h1), (h4 ^= h1);\r\n    return [h1 >>> 0, h2 >>> 0, h3 >>> 0, h4 >>> 0];\r\n  }\r\n\r\n  // Courtesy of Chris Doty-Humphrey\r\n  // https://pracrand.sourceforge.net/\r\n  static sfc32(a, b, c, d) {\r\n    return function () {\r\n      a |= 0;\r\n      b |= 0;\r\n      c |= 0;\r\n      d |= 0;\r\n      var t = (((a + b) | 0) + d) | 0;\r\n      d = (d + 1) | 0;\r\n      a = b ^ (b >>> 9);\r\n      b = (c + (c << 3)) | 0;\r\n      c = (c << 21) | (c >>> 11);\r\n      c = (c + t) | 0;\r\n      return (t >>> 0) / 4294967296;\r\n    };\r\n  }\r\n}\r\n\r\nexport class TagInput {\r\n  static simplifyString(str) {\r\n    return str.replace(/[^0-9a-zA-Z_\\- ]/gi, '').toLowerCase();\r\n  }\r\n\r\n  static registerHandlebarsHelper() {\r\n    Handlebars.registerHelper('tagInput', (options) => {\r\n      const name = options.hash.name;\r\n      const label = options.hash.label ?? 'Tags';\r\n      const listId = options.hash.listId;\r\n      const listEntries = options.hash.listEntries;\r\n\r\n      let tags = options.hash.tags;\r\n      if (!Handlebars.Utils.isArray(tags)) tags = [];\r\n\r\n      // Construct the HTML\r\n      let tagHtml = '';\r\n      tags.forEach((tag) => {\r\n        tagHtml += this._tagField(tag);\r\n      });\r\n\r\n      // DataList\r\n      let listAttr = '';\r\n      let dataList = '';\r\n      if (listId && listEntries) {\r\n        listAttr = `list=\"${listId}\"`;\r\n\r\n        dataList = `<datalist id=\"${listId}\"><option value=\"DELETE\"><option value=\"DELETE ALL\">`;\r\n        listEntries.forEach((le) => {\r\n          dataList += `<option value=\"${le}\">`;\r\n        });\r\n        dataList += `</datalist>`;\r\n      }\r\n\r\n      return new Handlebars.SafeString(`\r\n      ${dataList}\r\n      <fieldset>\r\n        <legend>${label}</legend>\r\n        <div class=\"form-group me-tags\">\r\n            <input type=\"text\" ${listAttr} class=\"tag-input\">  \r\n            <input type=\"text\" class=\"tag-hidden-input\" name=\"${name}\" value=\"${tags.join(',')}\" hidden>\r\n            <button type=\"button\" class=\"add-tag\"><i class=\"fas fa-save\" style=\"margin: auto;\"></i></button>\r\n            <div class=\"tag-container\">${tagHtml}</div>\r\n        </div>\r\n      </fieldset>\r\n    `);\r\n    });\r\n  }\r\n\r\n  static _tagField(tag) {\r\n    return `<div class=\"tag\"><span>${tag}</span> <a class=\"delete-tag\"><i class=\"fa-solid fa-x fa-xs\"></i></a></div>`;\r\n  }\r\n\r\n  static activateListeners(html, { change, simplifyTags = true } = {}) {\r\n    html.find('.me-tags .add-tag').on('click', (event) => {\r\n      const meTags = $(event.target).closest('.me-tags');\r\n      const input = meTags.find('.tag-input');\r\n\r\n      const newTags = input\r\n        .val()\r\n        .split(',')\r\n        .map((t) => {\r\n          t = t.trim();\r\n          if (simplifyTags) t = this.simplifyString(t);\r\n          return t;\r\n        })\r\n        .filter(Boolean);\r\n\r\n      if (newTags.length) {\r\n        input.val('');\r\n        const hiddenInput = meTags.find('.tag-hidden-input');\r\n        const currentTags = hiddenInput.val().split(',').filter(Boolean);\r\n        for (const tag of newTags) {\r\n          if (!currentTags.includes(tag)) {\r\n            currentTags.push(tag);\r\n            meTags.find('.tag-container').append(this._tagField(tag));\r\n          }\r\n        }\r\n        hiddenInput.attr('value', currentTags.join(','));\r\n        change?.(currentTags);\r\n      }\r\n    });\r\n\r\n    html.find('.me-tags').on('click', '.delete-tag', (event) => {\r\n      const tag = $(event.target).closest('.tag');\r\n\r\n      // Remove tag from hidden input\r\n      const tagValue = tag.find('span').text();\r\n      const hiddenInput = tag.closest('.me-tags').find('.tag-hidden-input');\r\n      const newTags = hiddenInput\r\n        .val()\r\n        .split(',')\r\n        .filter((t) => t !== tagValue);\r\n      hiddenInput.attr('value', newTags.join(','));\r\n\r\n      // Remove the tag element itself\r\n      tag.remove();\r\n\r\n      change?.(newTags);\r\n    });\r\n  }\r\n}\r\n","module.exports = jQuery;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.f = {};\n// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = (chunkId) => {\n\treturn Promise.all(Object.keys(__webpack_require__.f).reduce((promises, key) => {\n\t\t__webpack_require__.f[key](chunkId, promises);\n\t\treturn promises;\n\t}, []));\n};","// This function allow to reference async chunks\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".bundle.js\";\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.p = \"modules/multi-token-edit/\";","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t792: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {\n\t\t// JSONP chunk loading for javascript\n\t\tvar installedChunkData = __webpack_require__.o(installedChunks, chunkId) ? installedChunks[chunkId] : undefined;\n\t\tif(installedChunkData !== 0) { // 0 means \"already installed\".\n\n\t\t\t// a Promise means \"currently loading\".\n\t\t\tif(installedChunkData) {\n\t\t\t\tpromises.push(installedChunkData[2]);\n\t\t\t} else {\n\t\t\t\tif(true) { // all chunks have JS\n\t\t\t\t\t// setup Promise in chunk cache\n\t\t\t\t\tvar promise = new Promise((resolve, reject) => (installedChunkData = installedChunks[chunkId] = [resolve, reject]));\n\t\t\t\t\tpromises.push(installedChunkData[2] = promise);\n\n\t\t\t\t\t// start chunk loading\n\t\t\t\t\tvar url = __webpack_require__.p + __webpack_require__.u(chunkId);\n\t\t\t\t\t// create error before stack unwound to get useful stacktrace later\n\t\t\t\t\tvar error = new Error();\n\t\t\t\t\tvar loadingEnded = (event) => {\n\t\t\t\t\t\tif(__webpack_require__.o(installedChunks, chunkId)) {\n\t\t\t\t\t\t\tinstalledChunkData = installedChunks[chunkId];\n\t\t\t\t\t\t\tif(installedChunkData !== 0) installedChunks[chunkId] = undefined;\n\t\t\t\t\t\t\tif(installedChunkData) {\n\t\t\t\t\t\t\t\tvar errorType = event && (event.type === 'load' ? 'missing' : event.type);\n\t\t\t\t\t\t\t\tvar realSrc = event && event.target && event.target.src;\n\t\t\t\t\t\t\t\terror.message = 'Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')';\n\t\t\t\t\t\t\t\terror.name = 'ChunkLoadError';\n\t\t\t\t\t\t\t\terror.type = errorType;\n\t\t\t\t\t\t\t\terror.request = realSrc;\n\t\t\t\t\t\t\t\tinstalledChunkData[1](error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t__webpack_require__.l(url, loadingEnded, \"chunk-\" + chunkId, chunkId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n};\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n// no on chunks loaded\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunk\"] = self[\"webpackChunk\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","// SPDX-License-Identifier: MIT\r\n// Copyright © 2021 fvtt-lib-wrapper Rui Pinheiro\r\n\r\n'use strict';\r\n\r\n// A shim for the libWrapper library\r\nexport let libWrapper = undefined;\r\n\r\nexport const VERSIONS = [1, 12, 2];\r\nexport const TGT_SPLIT_RE = new RegExp(\r\n  '([^.[]+|\\\\[(\\'([^\\'\\\\\\\\]|\\\\\\\\.)+?\\'|\"([^\"\\\\\\\\]|\\\\\\\\.)+?\")\\\\])',\r\n  'g'\r\n);\r\nexport const TGT_CLEANUP_RE = new RegExp('(^\\\\[\\'|\\'\\\\]$|^\\\\[\"|\"\\\\]$)', 'g');\r\n\r\n// Main shim code\r\nHooks.once('init', () => {\r\n  // Check if the real module is already loaded - if so, use it\r\n  if (globalThis.libWrapper && !(globalThis.libWrapper.is_fallback ?? true)) {\r\n    libWrapper = globalThis.libWrapper;\r\n    return;\r\n  }\r\n\r\n  // Fallback implementation\r\n  libWrapper = class {\r\n    static get is_fallback() {\r\n      return true;\r\n    }\r\n\r\n    static get WRAPPER() {\r\n      return 'WRAPPER';\r\n    }\r\n    static get MIXED() {\r\n      return 'MIXED';\r\n    }\r\n    static get OVERRIDE() {\r\n      return 'OVERRIDE';\r\n    }\r\n\r\n    static register(package_id, target, fn, type = 'MIXED', { chain = undefined, bind = [] } = {}) {\r\n      const is_setter = target.endsWith('#set');\r\n      target = !is_setter ? target : target.slice(0, -4);\r\n      const split = target\r\n        .match(TGT_SPLIT_RE)\r\n        .map((x) => x.replace(/\\\\(.)/g, '$1').replace(TGT_CLEANUP_RE, ''));\r\n      const root_nm = split.splice(0, 1)[0];\r\n\r\n      let obj, fn_name;\r\n      if (split.length == 0) {\r\n        obj = globalThis;\r\n        fn_name = root_nm;\r\n      } else {\r\n        const _eval = eval;\r\n        fn_name = split.pop();\r\n        obj = split.reduce((x, y) => x[y], globalThis[root_nm] ?? _eval(root_nm));\r\n      }\r\n\r\n      let iObj = obj;\r\n      let descriptor = null;\r\n      while (iObj) {\r\n        descriptor = Object.getOwnPropertyDescriptor(iObj, fn_name);\r\n        if (descriptor) break;\r\n        iObj = Object.getPrototypeOf(iObj);\r\n      }\r\n      if (!descriptor || descriptor?.configurable === false)\r\n        throw new Error(\r\n          `libWrapper Shim: '${target}' does not exist, could not be found, or has a non-configurable descriptor.`\r\n        );\r\n\r\n      let original = null;\r\n      const wrapper =\r\n        chain ?? (type.toUpperCase?.() != 'OVERRIDE' && type != 3)\r\n          ? function (...args) {\r\n              return fn.call(this, original.bind(this), ...bind, ...args);\r\n            }\r\n          : function (...args) {\r\n              return fn.call(this, ...bind, ...args);\r\n            };\r\n      if (!is_setter) {\r\n        if (descriptor.value) {\r\n          original = descriptor.value;\r\n          descriptor.value = wrapper;\r\n        } else {\r\n          original = descriptor.get;\r\n          descriptor.get = wrapper;\r\n        }\r\n      } else {\r\n        if (!descriptor.set) throw new Error(`libWrapper Shim: '${target}' does not have a setter`);\r\n        original = descriptor.set;\r\n        descriptor.set = wrapper;\r\n      }\r\n\r\n      descriptor.configurable = true;\r\n      Object.defineProperty(obj, fn_name, descriptor);\r\n    }\r\n  };\r\n});\r\n","import { MODULE_ID } from './utils.js';\r\n\r\n/**\r\n * Enable 'Select' tool for layers that do not have it. (AmbientLight, AmbientSound, MeasuredTemplate, and Note)\r\n */\r\nexport function enableUniversalSelectTool() {\r\n  if (game.modules.get('select-tool-everywhere')?.active) return;\r\n\r\n  const missingLayers = ['AmbientLight', 'AmbientSound', 'MeasuredTemplate', 'Note'];\r\n\r\n  missingLayers.forEach((layer) => {\r\n    Hooks.on(`refresh${layer}`, _placeableRefresh);\r\n  });\r\n\r\n  Hooks.on('canvasReady', () =>\r\n    missingLayers.forEach((layer) => (canvas.getLayerByEmbeddedName(layer).options.controllableObjects = true))\r\n  );\r\n\r\n  Hooks.on('getSceneControlButtons', (controls) => _getControlButtons(controls));\r\n\r\n  // :: Fixes ::\r\n\r\n  // For notes the refresh hook is called while ControlIcon is still loading its texture (see ControlIcon.draw())\r\n  // Once the texture is loaded border visibility will be reset to false undoing our change in _placeableRefresh\r\n  // Instead delay and set visibility after draw to account for this\r\n  Hooks.on('drawNote', (note) => {\r\n    setTimeout(() => _placeableRefresh(note), 10);\r\n  });\r\n\r\n  // To avoid race conditions between multiple AmbientLight _onDragLeftCancel calls we'll defer the\r\n  // canvas.perception update within 'updateSource' via a 'defer' argument\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'AmbientLight.prototype._onDragLeftCancel',\r\n    function (...args) {\r\n      Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this, args);\r\n      this.updateSource({ defer: true });\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n}\r\n\r\n/**\r\n * Insert select tool if missing\r\n */\r\nfunction _getControlButtons(controls) {\r\n  for (const control of controls) {\r\n    if (['lighting', 'sounds', 'measure'].includes(control.name)) {\r\n      if (!control.tools.find((t) => t.name === 'select')) {\r\n        control.tools.unshift({\r\n          name: 'select',\r\n          title: 'CONTROLS.CommonSelect',\r\n          icon: 'fas fa-expand',\r\n        });\r\n        control.activeTool = 'select';\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction _placeableRefresh(placeable) {\r\n  if (placeable.controlled) placeable.controlIcon.border.visible = true;\r\n}\r\n","import { pasteData, showMassEdit, showGenericForm } from './applications/multiConfig.js';\r\n\r\nimport {\r\n  checkApplySpecialFields,\r\n  deleteFromClipboard,\r\n  getObjFormData,\r\n  performMassSearch,\r\n  performMassUpdate,\r\n} from './applications/forms.js';\r\nimport { MassEditGenericForm } from './applications/generic/genericForm.js';\r\nimport {\r\n  activeEffectPresetSelect,\r\n  applyAddSubtract,\r\n  createDocuments,\r\n  flagCompare,\r\n  MODULE_ID,\r\n  resolveCreateDocumentRequest,\r\n  SUPPORTED_PLACEABLES,\r\n  TagInput,\r\n} from './scripts/utils.js';\r\nimport { GeneralDataAdapter } from './applications/dataAdapters.js';\r\nimport { applyRandomization } from './scripts/randomizer/randomizerUtils.js';\r\nimport { libWrapper } from './scripts/shim/shim.js';\r\nimport { enableUniversalSelectTool } from './scripts/selectTool.js';\r\nimport { META_INDEX_ID, PresetAPI, PresetCollection } from './scripts/presets/collection.js';\r\nimport { MassEditPresets, PresetConfig } from './scripts/presets/forms.js';\r\nimport { registerKeybinds, registerSettings } from './scripts/settings.js';\r\nimport { Picker } from './scripts/picker.js';\r\nimport { BrushMenu, activateBrush, deactivateBush, openBrushMenu } from './scripts/brush.js';\r\nimport { FileIndexer, FileIndexerAPI } from './scripts/presets/fileIndexer.js';\r\n\r\n// Initialize module\r\nHooks.once('init', () => {\r\n  TagInput.registerHandlebarsHelper();\r\n\r\n  registerSettings();\r\n  registerKeybinds();\r\n  enableUniversalSelectTool(); // Enable select tool for all layers\r\n\r\n  // Register copy-paste wrappers\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onCopy',\r\n    function (wrapped, ...args) {\r\n      if (window.getSelection().toString() === '') {\r\n        // Check if a Mass Config form is open and if so copy data from there\r\n        const meForm = Object.values(ui.windows).find((app) => app.meObjects != null);\r\n        if (meForm?.performMassCopy()) return true;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      // Clear Mass Edit clipboard to allows core pasting again\r\n      if (result) deleteFromClipboard(canvas.activeLayer.constructor.documentName);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onPaste',\r\n    function (wrapped, ...args) {\r\n      if (pasteData()) return true;\r\n      return wrapped(...args);\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Register mouse wheel wrapper to scale/rotate preset previews\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'MouseManager.prototype._onWheel',\r\n    function (wrapped, ...args) {\r\n      const event = args[0];\r\n\r\n      if (\r\n        (Picker.isActive() || BrushMenu.isActive()) &&\r\n        (event.ctrlKey || event.shiftKey || event.metaKey || event.altKey)\r\n      ) {\r\n        // Prevent zooming the entire browser window\r\n        if (event.ctrlKey) event.preventDefault();\r\n\r\n        let dy = (event.delta = event.deltaY);\r\n        if (event.shiftKey && dy === 0) {\r\n          dy = event.delta = event.deltaX;\r\n        }\r\n        if (dy === 0) return;\r\n\r\n        if (event.altKey) Picker.addScaling(event.delta < 0 ? 0.05 : -0.05);\r\n        else if ((event.ctrlKey || event.metaKey) && event.shiftKey) BrushMenu.iterate(event.delta >= 0);\r\n        else if (event.ctrlKey || event.metaKey) Picker.addRotation(event.delta < 0 ? 2.5 : -2.5);\r\n        else if (event.shiftKey) Picker.addRotation(event.delta < 0 ? 15 : -15);\r\n        return;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Add SceneControl option to open Mass Edit form\r\n  if (game.settings.get(MODULE_ID, 'presetSceneControl')) {\r\n    libWrapper.register(\r\n      MODULE_ID,\r\n      'SceneNavigation.prototype._getContextMenuOptions',\r\n      function (wrapped, ...args) {\r\n        const options = wrapped(...args);\r\n        options.push({\r\n          name: 'Mass Edit',\r\n          icon: '<i class=\"fa-solid fa-pen-to-square\"></i>',\r\n          condition: game.user.isGM,\r\n          callback: (li) => {\r\n            const sceneId = li.attr('data-scene-id');\r\n            showMassEdit(game.scenes.get(sceneId));\r\n          },\r\n        });\r\n        return options;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n  }\r\n\r\n  // Intercept and prevent certain placeable drag and drop if they are hovering over the MassEditPresets form\r\n  // passing on the placeable to it to perform preset creation.\r\n  const dragDropHandler = function (wrapped, ...args) {\r\n    if (MassEditPresets.objectHover || PresetConfig.objectHover) {\r\n      this.mouseInteractionManager.cancel(...args);\r\n      const app = Object.values(ui.windows).find(\r\n        (x) =>\r\n          (MassEditPresets.objectHover && x instanceof MassEditPresets) ||\r\n          (PresetConfig.objectHover && x instanceof PresetConfig)\r\n      );\r\n      if (app) {\r\n        const placeables = canvas.activeLayer.controlled.length ? [...canvas.activeLayer.controlled] : [this];\r\n        app.dropPlaceable(placeables, ...args);\r\n      }\r\n      // Pass in a fake event that hopefully is enough to allow other modules to function\r\n      this._onDragLeftCancel(...args);\r\n    } else {\r\n      return wrapped(...args);\r\n    }\r\n  };\r\n\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    libWrapper.register(MODULE_ID, `${name}.prototype._onDragLeftDrop`, dragDropHandler, 'MIXED');\r\n  });\r\n\r\n  // Handle broadcasts\r\n  // Needed to allow players to spawn Presets by delegating create document request to GMs\r\n  game.socket?.on(`module.${MODULE_ID}`, async (message) => {\r\n    const args = message.args;\r\n\r\n    if (message.handlerName === 'document' && message.type === 'CREATE') {\r\n      const isResponsibleGM = !game.users\r\n        .filter((user) => user.isGM && (user.active || user.isActive))\r\n        .some((other) => other.id < game.user.id);\r\n      if (!isResponsibleGM) return;\r\n\r\n      const documents = await createDocuments(args.documentName, args.data, args.sceneID);\r\n      const documentIDs = documents.map((d) => d.id);\r\n\r\n      const message = {\r\n        handlerName: 'document',\r\n        args: {\r\n          requestID: args.requestID,\r\n          sceneID: args.sceneID,\r\n          documentName: args.documentName,\r\n          documentIDs,\r\n        },\r\n        type: 'RESOLVE',\r\n      };\r\n      game.socket.emit(`module.${MODULE_ID}`, message);\r\n    } else if (message.handlerName === 'document' && message.type === 'RESOLVE') {\r\n      resolveCreateDocumentRequest(args);\r\n    }\r\n  });\r\n\r\n  // 'Spotlight Omnisearch' support\r\n  Hooks.on('spotlightOmnisearch.indexBuilt', (INDEX, promises) => {\r\n    if (!game.user.isGM) return;\r\n    // First turn-off preset compendium from being included in omnisearch indexing\r\n    const old = game.settings.get('spotlight-omnisearch', 'compendiumConfig');\r\n    game.packs\r\n      .filter((p) => p.documentName === 'JournalEntry' && p.index.get(META_INDEX_ID))\r\n      .forEach((p) => (old[p.collection] = false));\r\n    game.settings.set('spotlight-omnisearch', 'compendiumConfig', old);\r\n\r\n    // Insert preset index\r\n    const promise = PresetCollection.buildSpotlightOmnisearchIndex(INDEX);\r\n    promises.push(promise);\r\n  });\r\n\r\n  globalThis.MassEdit = {\r\n    GeneralDataAdapter,\r\n    MassEditGenericForm,\r\n    showGenericForm,\r\n    performMassUpdate,\r\n    performMassSearch,\r\n    showMassEdit,\r\n    getPreset: PresetAPI.getPreset,\r\n    getPresets: PresetAPI.getPresets,\r\n    createPreset: PresetAPI.createPreset,\r\n    spawnPreset: PresetAPI.spawnPreset,\r\n    activateBrush: activateBrush,\r\n    deactivateBrush: deactivateBush,\r\n    openBrushMenu: openBrushMenu,\r\n    buildDirectoryIndex: (options) => FileIndexer.buildIndex(options),\r\n    readCacheFile: FileIndexerAPI.readCacheFile,\r\n  };\r\n\r\n  game.modules.get(MODULE_ID).api = {\r\n    ...globalThis.MassEdit,\r\n    applyRandomization, // Deprecated\r\n    applyAddSubtract, // Deprecated\r\n    checkApplySpecialFields, // Deprecated\r\n  };\r\n});\r\n\r\n// Deactivate brush/picker on scene change\r\n\r\nHooks.on('canvasReady', () => {\r\n  if (BrushMenu.isActive()) BrushMenu.close();\r\n  else if (Picker.isActive()) Picker.destroy();\r\n});\r\n\r\n// Preset Scene Control\r\nHooks.on('renderSceneControls', (sceneControls, html, options) => {\r\n  if (!game.user.isGM) return;\r\n  if (!game.settings.get(MODULE_ID, 'presetSceneControl')) return;\r\n\r\n  const presetControl = $(`\r\n<li class=\"scene-control mass-edit-scene-control\" data-control=\"me-presets\" aria-label=\"Mass Edit: Presets\" role=\"tab\" data-tooltip=\"Mass Edit: Presets\">\r\n  <i class=\"fa-solid fa-books\"></i>\r\n</li>\r\n  `);\r\n\r\n  presetControl.on('click', () => {\r\n    let docName = canvas.activeLayer.constructor.documentName;\r\n    if (!SUPPORTED_PLACEABLES.includes(docName)) docName = 'ALL';\r\n\r\n    const presetForm = Object.values(ui.windows).find((app) => app instanceof MassEditPresets);\r\n    if (presetForm) {\r\n      presetForm.close();\r\n      return;\r\n    }\r\n\r\n    new MassEditPresets(null, null, docName, {\r\n      left: presetControl.position().left + presetControl.width() + 40,\r\n    }).render(true);\r\n  });\r\n\r\n  html.find('.control-tools').find('.scene-control').last().after(presetControl);\r\n});\r\n\r\n// Attach Mass Config buttons to Token and Tile HUDs\r\nHooks.on('renderTokenHUD', (hud, html, tokenData) => {\r\n  if (canvas.tokens.controlled.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"config\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\nHooks.on('renderTileHUD', (hud, html, tileData) => {\r\n  const controlledTiles = canvas.background\r\n    ? canvas.background.controlled.concat(canvas.foreground.controlled)\r\n    : canvas.tiles.controlled;\r\n\r\n  if (controlledTiles.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"underfoot\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\n\r\nHooks.on('renderActiveEffectConfig', (app) => {\r\n  const el = $(app.form).find('.effects-header .key');\r\n  if (el.length) {\r\n    const me = $('<i title=\"Apply \\'Mass Edit\\' preset\" style=\"font-size:smaller;color:brown;\"> <a>[ME]</a></i>');\r\n    me.on('click', () => activeEffectPresetSelect(app));\r\n    el.append(me);\r\n  }\r\n});\r\n","import CSSEdit, { STYLES } from '../applications/cssEdit.js';\r\nimport { MassEditGenericForm } from '../applications/generic/genericForm.js';\r\nimport {\r\n  getSelected,\r\n  pasteData,\r\n  showMassActorForm,\r\n  showMassEdit,\r\n  showMassSelect,\r\n} from '../applications/multiConfig.js';\r\nimport { editPreviewPlaceables } from './picker.js';\r\nimport { PresetCollection } from './presets/collection.js';\r\nimport { MassEditPresets } from './presets/forms.js';\r\nimport {\r\n  MODULE_ID,\r\n  SUPPORTED_COLLECTIONS,\r\n  SUPPORTED_PLACEABLES,\r\n  activeEffectPresetSelect,\r\n  getDocumentName,\r\n  localize,\r\n} from './utils.js';\r\n\r\nexport function registerSettings() {\r\n  // Register Settings\r\n  game.settings.register(MODULE_ID, 'cssStyle', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'Solid Background',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'cssCustom', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: STYLES.Default,\r\n  });\r\n\r\n  game.settings.registerMenu(MODULE_ID, 'cssEdit', {\r\n    name: localize('settings.cssEdit.name'),\r\n    hint: localize('settings.cssEdit.hint'),\r\n    label: '',\r\n    scope: 'world',\r\n    icon: 'fas fa-cog',\r\n    type: CSSEdit,\r\n    restricted: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'singleDocDefaultConfig', {\r\n    name: localize('settings.singleDocDefaultConfig.name'),\r\n    hint: localize('settings.singleDocDefaultConfig.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'rangeToTextbox', {\r\n    name: localize('settings.rangeToTextbox.name'),\r\n    hint: localize('settings.rangeToTextbox.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'indexer', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      indexDirs: [\r\n        { target: 'modules', source: 'data' },\r\n        { target: 'sounds', source: 'public' },\r\n      ],\r\n      cacheDir: { target: '', source: 'data' },\r\n      overrideTags: false,\r\n      ignoreExternal: false,\r\n      fileFilters: ['Thumb', '-thumb', 'Thumbnail', 'thumbnail'],\r\n      folderFilters: ['Thumb', 'thumb'],\r\n    },\r\n  });\r\n\r\n  // ===============\r\n  // Preset Settings\r\n\r\n  game.settings.register(MODULE_ID, 'workingPack', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'world.mass-edit-presets-main',\r\n    onChange: (val) => {\r\n      PresetCollection.workingPack = val;\r\n    },\r\n  });\r\n  PresetCollection.workingPack = game.settings.get(MODULE_ID, 'workingPack');\r\n\r\n  game.settings.register(MODULE_ID, 'docPresets', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Array,\r\n    default: [],\r\n  });\r\n\r\n  // Temp setting needed for migration\r\n  game.settings.register(MODULE_ID, 'presetsMigrated', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  // Temp setting needed for migration\r\n  game.settings.register(MODULE_ID, 'presetsCompMigrated', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetDocLock', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: '',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetLayerSwitch', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetExtComp', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetVirtualDir', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetScaling', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetSortMode', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'manual',\r\n  });\r\n\r\n  // p = preset only\r\n  // pf = preset & folder\r\n  game.settings.register(MODULE_ID, 'presetSearchMode', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'pf',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetSceneControl', {\r\n    name: 'Scene Controls: Preset Button',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n    onChange: () => {\r\n      ui.controls.render();\r\n    },\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetFavorites', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // end of Preset Settings\r\n  // ======================\r\n\r\n  game.settings.register(MODULE_ID, 'pinnedFields', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'customControls', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // Disable until duplicate flag value bug is fixed\r\n  // game.settings.register(MODULE_ID, 'enableFlagsTab', {\r\n  //   name: localize('settings.enableFlagsTab.name'),\r\n  //   hint: localize('settings.enableFlagsTab.hint'),\r\n  //   scope: 'world',\r\n  //   config: true,\r\n  //   type: Boolean,\r\n  //   default: true,\r\n  // });\r\n\r\n  game.settings.register(MODULE_ID, 'autoSnap', {\r\n    name: localize('settings.autoSnap.name'),\r\n    hint: localize('settings.autoSnap.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'panToSearch', {\r\n    name: localize('settings.panToSearch.name'),\r\n    hint: localize('settings.panToSearch.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  if (game.modules.get('tokenmagic')?.active) {\r\n    game.settings.register(MODULE_ID, 'tmfxFieldsEnable', {\r\n      name: localize('settings.tmfxFieldsEnable.name'),\r\n      hint: localize('settings.tmfxFieldsEnable.hint'),\r\n      scope: 'world',\r\n      config: true,\r\n      type: Boolean,\r\n      default: true,\r\n    });\r\n  }\r\n\r\n  game.settings.register(MODULE_ID, 'brush', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      random: true,\r\n      group: false,\r\n      spawner: true,\r\n      eraser: false,\r\n      lock: false,\r\n      snap: false,\r\n      scaleToGrid: true,\r\n    },\r\n  });\r\n}\r\n\r\nexport function registerKeybinds() {\r\n  game.keybindings.register(MODULE_ID, 'placeablePreviewEdit', {\r\n    name: 'Select Edit Placeables',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyD',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: editPreviewPlaceables,\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'editKey', {\r\n    name: localize('keybindings.editKey.name'),\r\n    hint: localize('keybindings.editKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyE',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w.meObjects);\r\n      if (app) {\r\n        app.close();\r\n        return;\r\n      }\r\n      showMassEdit();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'copyKey', {\r\n    name: 'Copy',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyC',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      // Check if a Mass Config form is open and if so copy data from there\r\n      if (window.getSelection().toString() === '') {\r\n        Object.values(ui.windows)\r\n          .find((app) => app.meObjects != null)\r\n          ?.performMassCopy();\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'pasteKey', {\r\n    name: 'Paste',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyV',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      pasteData();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'selectKey', {\r\n    name: localize('keybindings.selectKey.name'),\r\n    hint: localize('keybindings.selectKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyF',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      showMassSelect();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApply', {\r\n    name: localize('keybindings.presetApply.name'),\r\n    hint: localize('keybindings.presetApply.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyX',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof MassEditPresets);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n\r\n      // Special logic for populating Active Effect\r\n      const aeConfig = Object.values(ui.windows).find((x) => x instanceof ActiveEffectConfig);\r\n      if (aeConfig) {\r\n        activeEffectPresetSelect(aeConfig);\r\n        return;\r\n      }\r\n\r\n      const docName = canvas.activeLayer.constructor.documentName;\r\n      if (!SUPPORTED_PLACEABLES.includes(docName)) return;\r\n      new MassEditPresets(null, null, docName).render(true);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApplyScene', {\r\n    name: localize('keybindings.presetApplyScene.name'),\r\n    hint: localize('keybindings.presetApplyScene.hint'),\r\n    editable: [],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof MassEditPresets);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n      new MassEditPresets(null, null, 'Scene').render(true);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'genericFormKey', {\r\n    name: localize('keybindings.genericForm.name'),\r\n    hint: localize('keybindings.genericForm.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyR',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      let [target, selected] = getSelected(null, false);\r\n      if (!target) return;\r\n      const docName = getDocumentName(target);\r\n      if (![...SUPPORTED_COLLECTIONS, 'Token'].includes(docName)) return;\r\n\r\n      if (docName === 'Token') {\r\n        showMassActorForm(selected, { massEdit: true });\r\n      } else {\r\n        new MassEditGenericForm(selected, { massEdit: true, documentName: docName }).render(true);\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n}\r\n"],"names":["leafPrototypes","getProto","inProgress","getInUseStyle","styleInUse","game","settings","get","STYLES","CSSEdit","FormApplication","constructor","super","defaultOptions","foundry","utils","mergeObject","id","classes","template","resizable","minimizable","title","width","height","getData","options","data","css","styles","Object","keys","push","disableCSS","activateListeners","html","$","on","event","target","value","find","val","prop","_updateObject","formData","selectedStyle","set","Default","TokenDataAdapter","updateToForm","update","mirrorX","scale","Math","abs","mirrorY","dataToForm","token","doc","document","texture","scaleX","scaleY","formToData","forEach","k","correctDetectionModes","correctDetectionModeOrder","randomizeFields","indexMap","i","v","entries","startsWith","comps","split","newKey","rVal","detectionModeMatch","searchModes","tokenModes","m1","m2","enabled","range","detectionModes","length","mergedModes","deepClone","filter","d","dm","found","tdm","modifyPresetData","app","pModes","values","expandObject","modes","_getSubmitData","dataClone","randomize","addSubtract","modCustomFields","fields","key","j","startingModeLength","_previewChanges","render","ADAPTERS","Token","PlaylistSound","PlaylistSoundDataAdapter","obj","AudioHelper","inputToVolume","note","volume","volumeToInput","Note","NoteDataAdapter","src","GeneralDataAdapter","docName","adapter","async","applyDDTint","placeable","color","object","PIXI","Color","toNumber","string2hex","_string2hex","PlaceableObject","isNaN","TokenMagic","deleteFilters","addUpdateFilters","filterType","filterId","tint","hex2rgb","filters","f","tmFilters","tmFilterId","tmFilterInternalId","randomID","tmFilterType","filterOwner","userId","tmParams","updateId","rank","getDDTint","_TMFXgetSprite","rgb2hex","uniforms","toHex","hex2string","_hex2string","applyTMFXPreset","presetName","remove","preset","getPreset","genAction","method","command","toggle","genToggleUtil","objToString","hasMassEditUpdateDependency","context","join","context2","genUpdateWithMassEditDep","isEmpty","macroTracking","macro","includes","genUpdate","scope","genDelete","genTargets","selected","map","p","genIDTargets","genSelected","genSearch","opts","matchAny","tagger","match","allScenes","tags","genTaggerTargets","genAllTargets","Error","modules","active","mdsClasses","Actor","Scene","JournalEntry","Playlist","Item","RollTable","Cards","JSON","stringify","generateMacro","placeables","dep","depWarning","module","hasSpecialField","hasMassEditDependency","genMacroDependencies","name","select","genRunMacro","Macro","create","type","sheet","specialFields","sf","MacroForm","addSubtractFields","this","mainObject","selectable","selectScopeEnabled","targetingOptions","label","hasAddSubtract","hasRandom","hasMEControls","hiddenControl","macros","collections","m","_onShowReturnJson","control","store","siblings","parse","content","Dialog","buttons","Ok","callback","hide","setPosition","e","ui","notifications","warn","_onRemoveJson","className","replace","click","parent","contextmenu","toggleFields","update2","hidden","change","show","attr","closest","flattenObject","toObject","WithMassEditForm","cls","MassEditForm","docs","meObjects","documentName","commonData","randomizerEnabled","massEdit","massFormButtons","icon","meForm","preview","clone","form","newHtml","tabs","first","append","last","after","injectVisibility","_injectGlobalDeleteButton","styleName","prepend","onInputChange","bind","rangeSpanToTextbox","insertRNGControl","processFormGroup","formGroup","typeOverride","fieldType","each","span","replaceWith","defaultValue","min","max","removeAttr","randomControl","checkbox","before","addClass","_","then","showRandomizeDialog","input","removeClass","ctrl","parseFloat","refreshPreset","htmlButtons","_meSubmitInserted","button","simplified","presetEdit","massSelect","footer","stopPropagation","isChecked","checked","not","modUpdate","modUpdateType","dataset","submit","inputChangeCallback","setTimeout","getSelectedFields","tab","group","meCheckboxes","selecting","selectTabs","deselectTabs","trigger","_createAction","chk","insertBefore","Levels3DPreview","getPresets","currentDDTint","scaleInput","_active","element","style","MutationObserver","mutations","mutation","addedNodes","node","hasClass","observe","characterData","attributes","childList","subtree","wrap","injectFlagTab","getFlag","selectedFields","me_checkbox","is","limits","flags","undefined","removeFlag","getType","trim","s","_onChangeInput","el","edit","_onChangeColorPicker","_onChangeRange","_getHeaderButtons","b","class","count","buttonA","delete","close","no","default","WithMassConfig","sheets","CONFIG","sheetClasses","pop","MEF","MassConfig","objects","getObjFormData","getCommonDocData","n","scene","canvas","massUpdateObject","_resetPreview","submitter","performMassSearch","performMassUpdate","call","_performOnInputChangeUpdate","performMassCopy","copyToClipboard","isPrototype","unshift","onclick","activate","ids","Set","actor","entry","has","add","WithMassPermissions","linkedPresetForm","left","position","top","preventPositionOverride","ev","selFields","apply","json","_processPreset","t","deactivate","force","action","_applyPreset","timeoutRequired","setFlag","customMerge","obj1","obj2","constructorName","defineProperty","prototype","pasteDataUpdate","suppressNotif","excludePosition","transform","applyType","getClipboardData","floor","random","DataTransform","x","y","c","info","pan","performDocSearch","Array","from","scenes","performMassSearchScene","activeLayer","controlled","release","releaseOthers","matches","callbackOnUpdate","updates","total","o","_id","checkApplySpecialFields","tokens","updateDocuments","splitUpdates","sceneUpdate","updateEmbeddedDocuments","sceneId","actorUpdates","prototypeToken","hasOwnProperty","depth","meChk","DocumentOwnershipConfig","MassPermissions","ownership","metaLevels","CONST","DOCUMENT_META_OWNERSHIP_LEVELS","addMissingPerms","perms","users","u","DEFAULT","flatData","diff","diffObject","massPermissions","user","level","recursive","noHook","CLIPBOARD","clipboard","copyPlainText","deleteFromClipboard","CUSTOM_CONTROLS","field","shieldType","step","blend","radius","intensity","lightAlpha","gridPadding","lightSize","animated","time","speed","fire","fireBlend","animType","val2","val1","loopDuration","amplitude","electric","xglow","auraType","auraIntensity","subAuraIntensity","threshold","thickness","glow","outerStrength","innerStrength","padding","alpha","zapshadow","alphaTolerance","sprite","blendMode","translationX","translationY","rotation","xfire","dispersion","ascii","size","dot","angle","godray","rgbSplit","redX","redY","greenX","greenY","blueX","blueY","polymorph","shadow","blur","flood","billowy","tintIntensity","glint","WMC","MassEditGenericForm","a","allData","noTabs","customControls","nav","tabSelectors","editableLabels","pinnedFields","getTemplate","star","editNumber","col","Number","fromString","allControls","docControls","setProperty","unsetCustomControl","save","defineRangeControl","defineSelectControl","pinned","constructNav","pins","dataGroup","items","navSelector","contentSelector","initial","_constructControls","pinned_groups","flatObject","genControl","dataTab","groups","containsNav","name2","_hasNonNullKeys","_genLabel","newNav","toUpperCase","charAt","slice","IMAGE_FIELDS","COLOR_FIELDS","isColorField","toLowerCase","editableLabel","allowedArrayElTypes","getProperty","number","colorPickerNumber","colorValue","toString","text","varName","filePicker","colorPicker","boolean","every","array","jsonArray","disabled","LAYER_MAPPINGS","Tile","Drawing","Wall","AmbientLight","AmbientSound","MeasuredTemplate","SCENE_DOC_MAPPINGS","getControlled","getHover","hover","getSelectedDocuments","placeableSelect","supportedDocs","playlistId","sounds","soundId","documentId","notes","eid","entryId","getSelected","base","isArray","sort","p1","p2","showMassSelect","basePlaceable","showMassEdit","forceForm","showMassActorForm","selectedTokens","actors","pasteData","spawnPreset","showGenericForm","Promise","resolve","Brush","static","Map","_boundOn3DBrushClick","_on3DBrushClick","_boundOn3dMouseMove","_on3dMouseMove","_checkDensity","pos","grid","spawnDensity","spawnPoints","sqrt","_performBrushDocumentUpdate","callPostSpawnHooks","documents","updatedPlaceables","BrushMenu","iterate","_performBrushDocumentCreate","now","Date","getTime","lastSpawnTime","z","Picker","center","snapToGrid","snap","scaleToGrid","_performBrushDocumentDelete","hoveredPlaceable","_brushDelete","_hitTestWall","point","wall","line","hitArea","contains","_hitTestControlIcon","between","controlIcon","_hitTestTile","foreground","controls","overhead","_hitTestArea","_hoverTestArea","_onBrushMove","getLocalPosition","brushOverlay","layer","getLayerByEmbeddedName","_clearHover","visible","hitTest","hoverTest","_onHoverOut","_onHoverIn","_onBrushClickMove","spawner","eraser","brush3d","posVec","ruler","pos3DToCanvas","interactionManager","currentHover","_downCameraPosition","clear","genPreview","coordPicker","previewOnly","taPreview","deactivateCallback","refresh","ready","destroy","interaction","renderer","events","cursorStyles","_activate3d","Container","dimensions","rect","cursor","interactive","zIndex","Infinity","feedPos","mDownWithinCanvas","nativeEvent","which","stage","addChild","mouseInteractionManager","permissions","clickLeft","brush3dDelayMoveTimer","brush","mPos","canvas3dMousePosition","cPos","camera","intersects","computeSightCollisionFrom3DPositions","intersect","deactivate3DListeners","domElement","removeEventListener","_activate3DListeners","addEventListener","THREE","Mesh","SphereGeometry","MeshBasicMaterial","opacity","transparent","wireframe","userData","ignoreHover","removeChild","addPresets","presets","_instance","isActive","Boolean","removePreset","forward","scrollY","window","innerHeight","_settings","_it","_createIndex","index","pI","dI","_index","_activateBrush","tiles","maxZ","_applyColor","_applyTmfxPresets","tmfxPreset","_applyTaggerTags","_deactivateCallback","_getTransform","density","randomColor","pPath","ddTint","_applyDDTint","addPostSpawnHook","Tagger","addTags","activePreset","tmfxActive","taggerActive","rotationRangeLabel","slider","slide","_updateBrushSettings","scaleRangeLabel","densityRangeLabel","_toggleSetting","_resetToDefaults","_onClickPreset","_onRightClickPreset","_onRandomizeColor","_onColorChange","_onColorMenu","_onEditTaglikeField","simplifyTags","listId","listEntries","subMenu","_toggleSubMenu","Handlebars","compile","allowProtoMethodsByDefault","allowProtoPropertiesByDefault","cString","currentTarget","valueOf","presetIndex","findIndex","colorTemp","renderTemplate","lockMethod","space","hue","colorSlider","dialog","colors","getColors","ColorSlider","hex","offset","uuid","wasActivePreset","lock","stepsInRange","_generateBrushMacro","genMacro","img","uuids","activateBrush","mode","deactivateBush","openBrushMenu","load","showPlaceableTypeSelectDialog","config","concat","importPresetFromJSONDialog","reject","import","readTextFromFile","files","pickerOverlay","addRotation","_rotation","setPositions","mousePosition","addScaling","_scale","PreciseText","canvasTextStyle","_fontSize","anchor","previews","previewDocuments","_genPreviews","previewData","keyboard","isModifierActive","KeyboardManager","MODIFIER_KEYS","SHIFT","getSnappedPosition","gridPrecision","fpX","fpY","_pData","renderFlags","source","updateSource","_meVInsert","off","boundStart","boundEnd","minX","maxX","minY","maxY","start","end","clearPreviewContainer","children","_createPreview","createData","getDocumentClass","objectClass","draw","dataArr","previewObject","_genTAPreviews","dName","_parseTAPreview","attached","attachedData","taIndex","documentNames","ratio","dataList","taPreviewObject","xy","origin","transformWall","transformTile","transformNote","transformToken","transformMeasuredTemplate","transformAmbientLight","transformAmbientSound","transformDrawing","dr","toRadians","rotatePoint","bottom","levels","rangeBottom","gridScale","rangeTop","distance","direction","toDegrees","dim","bright","rectCenter","shape","points","elevation","w","h","x2","y2","rot","dx","dy","cos","sin","editPreviewPlaceables","docToPlaceables","coords","selectionRect","Rectangle","insideRect","docToData","originalDocTolData","mainDocName","toCompendium","keepId","tokenAttacher","generatePrototypeAttached","prototypeAttached","originalData","DEFAULT_PACK","META_INDEX_ID","META_INDEX_FIELDS","PresetCollection","getTree","externalCompendiums","virtualDirectory","setFormVisibility","pack","mainTree","debug","MassEdit","console","_initCompendium","workingPack","PresetTree","init","forceLoad","log","extFolders","packs","collection","tree","hasVisible","topFolder","PresetPackFolder","allFolders","folder","vTree","getVirtualDirectoryTree","VirtualFileFolder","folders","_groupExtFolders","timeEnd","f1","f2","localeCompare","groupless","newExtFolders","groupFolder","PresetVirtualFolder","draggable","_cleanIndex","metaDoc","metaIndex","locked","idx","_packTrees","metadata","_sortFolders","sorting","_sortPresets","numeric","packToPresets","getDocument","contents","mIndex","compendium","updateDoc","toJSON","pages","_initMetaDocument","updatePresets","createDocuments","full","_constructVirtualFilePreset","documentType","embedded","parseUuid","substring","sorted","metaUpdate","deleteIds","deleteDocuments","CompendiumCollection","createCompendium","GAMEMASTER","PLAYER","ASSISTANT","packageType","deleteFolder","deleteAll","folderDoc","fromUuid","traverseFolder","deleteSubfolders","deleteContents","_searchPresetTree","_searchPresetList","allPresets","_searchPresetFolder","toSearch","folderName","some","buildSpotlightOmnisearchIndex","soIndex","SearchTerm","SpotlightOmnisearch","onClick","spotlightOmnisearch","setDraggingState","PresetAPI","onDragEnd","canvasCoordinatesFromClient","clientX","clientY","getActions","actions","openJournal","buildTerm","description","keywords","format","_folderName","createPresetFromActor","presetData","gridSize","createPresetFromActorUuid","createPreset","defPreset","taggerTag","inplace","pickerLabel","layerSwitch","modifyPrompt","spawnRandom","modifyOnSpawn","preSpawnScript","pos3d","canvas2dMousePosition","posTransform","author","downKeys","isGM","allDocuments","postSpawnScript","PresetFolder","isEditable","types","expanded","virtual","bucket","subtext","indexable","packFolderData","setVisibility","topLevelFolders","folderContents","topLevelPresets","_updateIndex","matched","_visible","sortedFolders","sortedPresets","_render","isFavorite","_setChildAndParentFoldersVisible","CACHE_NAME","FileIndexer","_loadedTree","cache","loadMainIndexCache","prePend","ForgeVTT","usingTheForge","ForgeAPI","getUserId","s3","buckets","endpoint","host","_indexToVirtualFolder","sFolder","buildIndex","_buildingIndex","scannedSources","foundCaches","dir","indexDirs","_buildFauxForgeBrowser","iDir","generateIndex","sPath","dirs","mergeIndex","cacheFile","loadIndexCache","mergeCaches","currentCache","tagsOnly","overrideNullTagsOnly","overrideTags","_writeIndexToCache","cacheTo","cacheFrom","indexSourceFrom","indexSourceTo","indexTo","indexFrom","dirFrom","dirTo","fileFrom","fileTo","saveIndexToCache","path","notify","sourceFolder","sourceCache","_cacheFolder","str","tFile","StringCompress","compress","FilePicker","upload","saveFolderToCache","wFolder","pFolder","fDic","_cachePreset","pDic","decompressCache","error","parentDirPath","fullPath","fileFolder","childFolder","file","noscan","_browse","indexerFile","endsWith","simplifyString","folderFilters","fileName","fileFilters","ignoreExternal","_getAuthorFromModule","tag","cacheDir","ext","_fauxForgeBrowser","browse","paths","replaceAll","insertFile","pDirPath","chDirPath","pDir","components","URL","pathname","moduleFile","authors","compressedStream","Blob","stream","pipeThrough","CompressionStream","chunks","chunk","streamAsyncIterator","blob","File","filePath","response","fetch","ok","decompress","body","decompressedStream","DecompressionStream","stringBytes","concatUint8Arrays","TextDecoder","decode","uint8arrays","buffer","arrayBuffer","Uint8Array","reader","getReader","done","read","releaseLock","IndexerForm","_onAddDirectory","_onDeleteDirectory","_onFileFiltersChange","_onFolderFiltersChange","_onToggleCheckbox","chkBox","_updateIndexerSettings","clearTimeout","_onInputTimeOut","selectFolder","selection","directory","activeSource","current","fp","result","FileIndexerAPI","readCacheFile","TrackerDialog","cancelCallback","incrementCount","stop","_state","Application","RENDER_STATES","RENDERED","RENDERING","trackProgress","cancel","countFolderItems","reduce","sum","SortingHelpersFixed","performIntegerSort","sortKey","sortBefore","defaultIdx","sib","_sortBefore","_sortAfter","SORT_INTEGER_DENSITY","isFinite","round","splice","performIntegerSortMulti","sources","increment","SORT_MODES","manual","tooltip","alphabetical","SEARCH_MODES","pf","MassEditPresets","configApp","previousPosition","dragType","dragData","draggedElements","docLock","displayExtCompendiums","displayVirtualDirectory","createEnabled","isPlaceable","allowDocumentSwap","docLockActive","layerSwitchActive","scaling","extCompActive","virtDirActive","sortMode","searchMode","displayDragDropMessage","canvas3dActive","lastSearch","currentDocument","hoverOverlay","_original","isDragging","objectHover","dropPlaceable","itemList","itemSelect","_activeBrush","_toggleBrush","item","targetItem","domRect","getBoundingClientRect","prc","offsetY","reverse","insertAfter","_onItemSort","folderUuid","appX","appY","appW","appH","mouseX","pageX","mouseY","pageY","checkMouseInWindow","_onPresetDragOut","_folderToggle","targetFolder","_foundryDrop","_onFolderSort","inside","presetItems","_onToggleSort","_onToggleLock","_onToggleExtComp","_onToggleVirtDir","_onToggleScaling","_onToggleLayerSwitch","_onDocumentChange","_onDoubleClickPreset","_onCreateFolder","_onPresetCreate","_onPresetUpdate","_onToggleFavorite","_onApplyPreset","headerSearch","_onSearchInput","_onToggleSearch","_contextMenu","folderElement","_folderCollapse","_folderExpand","setExpanded","sortable","fromUuidSync","TextEditor","getDragEventData","originalEvent","_importTracker","tracker","_importActorFolder","parentFolder","nFolder","Folder","implementation","child","_setInteractivityState","state","ContextMenu","_getItemContextOptions","hookName","onOpen","_getFolderContextOptions","condition","_onEditSelectedPresets","_onActivateBrush","_onOpenJournal","_onApplyToSelected","_onCopySelectedPresets","keepFolder","_onCopyPresetToClipboard","_onExportSelectedPresets","_onExportSelectedPresetsToComp","_onDeleteSelectedPresets","header","_onFolderEdit","_onExportFolder","_onFolderDelete","getCompendiumDialog","exportTo","keepIdSelect","_onCopyFolder","parentId","_getSelectedPresets","editableOnly","virtualOnly","selector","exportPresets","_editPresets","confirm","defaultName","PresetFolderConfig","_searchTimer","_onSearch","newSearch","previousSearch","_resetSearchState","_renderContent","_searchFoundCount","_searchFoundPresets","_searchFolder","_searchPreset","forceRender","childFolderMatch","presetMatch","containsMatch","_resetSearchStateFolder","_resetSearchStatePreset","sourceUuid","targetUuid","sourceUuids","sourceUuidsSet","newSort","searchControl","newMode","lockControl","currentLock","newLock","switchControl","newDocName","eventTarget","PresetConfig","windows","hoverMassEditForm","mouseZ","_onMouseMove","worldTransform","tx","ty","starControl","favorites","popOut","currentPosition","getComputedStyle","tarW","offsetWidth","minW","parseInt","minWidth","MIN_WINDOW_WIDTH","maxW","maxWidth","innerWidth","clamped","tarH","offsetHeight","minH","minHeight","MIN_WINDOW_HEIGHT","maxH","maxHeight","leftT","topT","posSet","scaledWidth","tarL","maxL","scaledHeight","tarT","maxT","ActiveEffectConfig","_getActiveEffectFields","isCreate","actorToPreset","changes","_onWorkingPackChange","_onOpenIndexer","_onExport","_onImport","importCount","_pages","saveDataToFile","prefix","submitOnClose","advancedOpen","displayFieldDelete","displayFieldModify","at","multiEdit","_submitData","minlength","tva","modifyDisabled","deleteDisabled","documentEdit","_onEditDocument","_onAssignDocument","_onDeleteFields","_onSpawnFields","onAttachedRemove","tvaButton","api","showArtSelect","imgSrc","searchType","updateData","removeTags","PresetFieldModify","PresetFieldDelete","documentClass","_updatePresets","_renderOuter","_createDocumentIdLink","idLink","createElement","classList","setAttribute","tooltipDirection","innerHTML","preventDefault","i18n","PresetFieldSelect","isObject","_onFieldClick","singleData","indexOf","reorganizedData","FolderConfig","toggleClass","folderDocs","displayTypes","newName","safeColor","sortingModes","submitText","virtualPackFolder","visibleTypes","excludePack","message","buttonLabel","export","lastSelected","ctrlKey","metaKey","shiftKey","itemIndex","lastSelectedIndex","itemArr","toArray","DOCUMENT_FIELDS","PRESET_FIELDS","DOC_ICONS","ALL","FAVORITES","Preset","fromEntries","thumbnail","DEFAULT_TOKEN","_data","hook","_postSpawnHooks","attach","flagUpdate","docUpdate","tmp","VirtualFilePreset","_storedReference","prom","Image","onload","race","res","complete","naturalWidth","naturalHeight","video","onloadedmetadata","videoWidth","videoHeight","_updateTimeout","FolderState","_expanded","placeableToData","modifySpawnData","toModify","modified","tmpData","mergePresetDataToDefaultDoc","strokeWidth","strokeAlpha","randomizeChildrenFolderColors","randObj","applyColors","getPresetDataCenterOffset","x1","MAX_SAFE_INTEGER","y1","MIN_SAFE_INTEGER","getDataBounds","getPresetDataBounds","getTransformToOrigin","next","isVideo","extension","decodeURIComponentSafely","uri","decodeURIComponent","encodeURIComponentSafely","encodeURIComponent","readJSONFile","url","jQuery","getJSON","selectField","deselectField","allRandomizedRemoved","selectRandomizerFields","applyRandomization","requiresCoordRandomization","isInteger","color1","color2","rOffset","rnOffset","hexColor","outputSpace","images","maintainAspect","tex","loadTexture","tileRatio","texRatio","shuffled","shuffleArray","strings","coordCtrl","pUpdates","pUpdate","freeId","boundingBox","freeRectangles","stepX","stepY","randomPlace","nearestStep","num","randomNum","temp","rec","fittingRecs","_canFit","rec1","rec2","overlaps","_intersectRec","overlap","_addAndMergeFreeRectangle","MODULE_ID","SUPPORTED_PLACEABLES","UI_DOCS","SUPPORT_SHEET_CONFIGS","SUPPORTED_COLLECTIONS","IMAGE_EXTENSIONS","VIDEO_EXTENSIONS","AUDIO_EXTENSIONS","FILE_EXTENSIONS","isImage","isAudio","recursiveTraverse","flagCompare","flag","flagVal","falseyFlagVal","falseyDataVal","compTags","wildcardStringMatch","hasFlagRemove","comp","tempFlag","selectAddSubtractFields","localize","applyAddSubtract","currentTags","modTags","toAdd","getCommonData","mergeObjectPreserveDot","original","other","nestedKey","fullKey","panToFitPlaceables","animatePan","duration","topLeft","bottomRight","tlc","_viewPosition","screenDimensions","escapeRegex","string","sw","s2","RegExp","test","wildcardStringReplace","re","regexStringReplace","activeEffectPresetSelect","aeConfig","showPresetGeneric","nChanges","ACTIVE_EFFECT_MODES","OVERRIDE","priority","nc","activeEffect","getDocumentName","DOCUMENT_CREATE_REQUESTS","sceneID","createEmbeddedDocuments","requestID","handlerName","args","socket","emit","resolveCreateDocumentRequest","documentIDs","docID","getEmbeddedDocument","moduleLocalization","localFormat","insert","applyPresetToScene","randomizer","executeScript","speaker","ChatMessage","getSpeaker","character","argNames","isNumeric","argValues","fn","AsyncFunction","err","SeededRandom","seed","cyrb128","sfc32","chars","h1","h2","h3","h4","charCodeAt","imul","TagInput","registerHandlebarsHelper","registerHelper","hash","Utils","tagHtml","_tagField","listAttr","le","SafeString","meTags","newTags","hiddenInput","tagValue","exports","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","__esModule","getPrototypeOf","ns","r","def","getOwnPropertyNames","definition","enumerable","chunkId","all","promises","l","script","needAttach","scripts","getElementsByTagName","getAttribute","charset","timeout","onScriptComplete","prev","onerror","doneFns","parentNode","head","appendChild","Symbol","toStringTag","installedChunks","installedChunkData","promise","errorType","realSrc","request","webpackJsonpCallback","parentChunkLoadingFunction","chunkIds","moreModules","runtime","chunkLoadingGlobal","self","TGT_SPLIT_RE","TGT_CLEANUP_RE","_placeableRefresh","border","Hooks","once","globalThis","libWrapper","is_fallback","WRAPPER","MIXED","register","package_id","chain","is_setter","root_nm","fn_name","_eval","eval","iObj","descriptor","getOwnPropertyDescriptor","configurable","wrapper","String","registerMenu","hint","restricted","onChange","keybindings","editable","modifiers","onDown","precedence","KEYBINDING_PRECEDENCE","NORMAL","getSelection","missingLayers","controllableObjects","tools","activeTool","_getControlButtons","_onDragLeftCancel","defer","enableUniversalSelectTool","wrapped","altKey","delta","deltaY","deltaX","li","dragDropHandler","INDEX","old","deactivateBrush","buildDirectoryIndex","sceneControls","presetControl","presetForm","hud","tokenData","tileData","background","me"],"sourceRoot":""}