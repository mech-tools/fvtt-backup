"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[180],{180:(e,t,n)=>{n.r(t),n.d(t,{registerBehaviors:()=>d});var i=n(596);class PresetField extends foundry.data.fields.SetField{constructor(...e){super(new foundry.data.fields.StringField({}),...e)}static get _defaults(){return Object.assign(super._defaults,{required:!1,blank:!0,nullable:!0,initial:null,type:null,embedded:void 0})}_toInput(e){return CustomStringElement.create(e)}}class CustomStringElement extends foundry.applications.elements.HTMLStringTagsElement{static tagName="preset-tags";static labels={add:"ELEMENTS.TAGS.Add",remove:"ELEMENTS.TAGS.Remove",placeholder:"Enter UUID"};static renderTag(e,t,n=!0){if(e.startsWith("virtual@"))t=e.split("\\").pop().split("/").pop();else{const n=fromUuidSync(e);n&&(t=n.name??e)}return super.renderTag(e,t,n)}}window.customElements.define(CustomStringElement.tagName,CustomStringElement);class DeSpawnPresetBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType{static defineSchema(){return{events:this._createEventsField({events:[CONST.REGION_EVENTS.TOKEN_ENTER,CONST.REGION_EVENTS.TOKEN_EXIT,CONST.REGION_EVENTS.TOKEN_MOVE_IN,CONST.REGION_EVENTS.TOKEN_MOVE_OUT,CONST.REGION_EVENTS.TOKEN_TURN_START,CONST.REGION_EVENTS.TOKEN_TURN_END]}),presetUuids:new PresetField({label:"Presets",hint:"Select specific presets to be removed."}),all:new foundry.data.fields.BooleanField({label:"All",hint:"If enabled all spawned presets will be removed.",initial:!1}),originRegionOnly:new foundry.data.fields.BooleanField({label:"This Region Only",hint:"If enabled only presets spawned by this region will be removed.",initial:!0})}}async _handleRegionEvent(e){if(!this.presetUuids&&!this.all)return;const t=e.data.token;if(t.object){const e=CanvasAnimation.getAnimation(t.object.animationName);e&&await e.promise}if(this.all)DeSpawnPresetBehaviorType.deSpawnAllPresets(this.parent.scene,this.originRegionOnly?this.region.id:null);else{if(!this.presetUuids?.size)return;const e=Array.from(this.presetUuids);DeSpawnPresetBehaviorType.deSpawnPresets(e,this.parent.scene,this.originRegionOnly?this.region.id:null)}}static deSpawnPresets(e,t,n){i.Me.forEach((s=>{const a=[];t.getEmbeddedCollection(s).forEach((t=>{const s=t.flags[i.Do]?.spawnPreset?.uuid;s&&e.some((e=>e===s))&&(n?t.flags[i.Do].spawnPreset.regionId===n&&a.push(t.id):a.push(t.id))})),a.length&&DeSpawnPresetBehaviorType.deleteEmbeddedDocuments(t,s,a)}))}static deSpawnAllPresets(e,t){i.Me.forEach((n=>{const s=[];e.getEmbeddedCollection(n).forEach((e=>{const n=e.flags[i.Do]?.spawnPreset?.regionId;!n||t&&n!==t||s.push(e.id)})),s.length&&DeSpawnPresetBehaviorType.deleteEmbeddedDocuments(e,n,s)}))}static deleteEmbeddedDocuments(e,t,n){if(game.user.isGM)e.deleteEmbeddedDocuments(t,n);else{const s={handlerName:"document",args:{sceneId:e.id,embedName:t,ids:n},type:"DELETE"};game.socket.emit(`module.${i.Do}`,s)}}}var s=n(638),a=n(120);class LinkTokenRegionBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType{static defineSchema(){return{linkId:new foundry.data.fields.StringField({label:(0,a.kg)("behavior.linkToken.linkId.label"),hint:(0,a.kg)("behavior.linkToken.linkId.hint"),initial:"LinkTokenBehavior - "+foundry.utils.randomID(8)})}}static events={[CONST.REGION_EVENTS.TOKEN_MOVE_IN]:this._onTokenMoveIn,[CONST.REGION_EVENTS.TOKEN_MOVE_OUT]:this._onTokenMoveOut};static async _onTokenMoveIn(e){(0,a.LM)()&&(s.sy.hasLink(this.region,this.linkId)||s.sy.addLink(this.region,this.linkId,s.rm.TWO_WAY,"LinkTokenBehavior"),s.sy.addLink(e.data.token,this.linkId,s.rm.RECEIVE,"LinkTokenBehavior"))}static async _onTokenMoveOut(e){(0,a.LM)()&&(e.data.forced||s.sy.removeLink(e.data.token,this.linkId))}}var o=n(652),r=n(575);class SpawnPresetBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType{static defineSchema(){const e={events:this._createEventsField({events:[CONST.REGION_EVENTS.TOKEN_ENTER,CONST.REGION_EVENTS.TOKEN_EXIT,CONST.REGION_EVENTS.TOKEN_MOVE_IN,CONST.REGION_EVENTS.TOKEN_MOVE_OUT,CONST.REGION_EVENTS.TOKEN_TURN_START,CONST.REGION_EVENTS.TOKEN_TURN_END]}),once:new foundry.data.fields.BooleanField({label:"Once",hint:"Disable the behavior after the first time it's triggered",initial:!1}),presetUuids:new PresetField({label:"Presets"}),destination:new foundry.data.fields.DocumentUUIDField({label:"Target Region UUID",type:"Region"})};return game.modules.get("tagger")?.active&&(e.destinationTags=new foundry.data.fields.SetField(new foundry.data.fields.StringField({}),{label:"Target Region Tags",hint:""})),e.destinationSpawnInAll=new foundry.data.fields.BooleanField({label:"All Regions",hint:"When enabled the preset will be spawned in all regions if multiple have been found as valid destinations.",initial:!0}),e.random=new foundry.data.fields.BooleanField({label:"Randomize Position",hint:"Randomized position will be chosen within the bounds of the target region.",initial:!1}),e}async _handleRegionEvent(e){if(!e.user.isSelf)return;if(this.once&&this.parent.update({disabled:!0}),e.data.forced)return;let t=[];const n=fromUuidSync(this.destination);if(n instanceof RegionDocument&&t.push(n),this.destinationTags?.size&&game.modules.get("tagger")?.active){const e=Tagger.getByTag(Array.from(this.destinationTags),{matchAny:!0,allScenes:!1}).filter((e=>e instanceof RegionDocument));e.length&&(t=t.concat(e))}if(!t.length)return;const i=new Map;if(t.forEach((e=>{i.get(e.parent.id)?i.get(e.parent.id).push(e):i.set(e.parent.id,[e])})),i.forEach(((e,t)=>{SpawnPresetBehaviorType.isSpawned(this.behavior.id,t)&&i.delete(t)})),!i.size)return;const s=e.data.token;if(s.object){const e=CanvasAnimation.getAnimation(s.object.animationName);e&&await e.promise}if(!this.presetUuids?.size)return;const a=Array.from(this.presetUuids),r=a[Math.floor(Math.random()*a.length)],d=await o.af.getPreset({uuid:r});if(d){t=[],i.forEach((e=>t=t.concat(e))),this.destinationSpawnInAll||(t=[t[Math.floor(Math.random()*t.length)]]);for(const e of t){const t=e.object??new CONFIG.Region.objectClass(e);SpawnPresetBehaviorType.spawnPreset(this.region.id,this.behavior.id,d,t,this.random).then((()=>{e.object||t.destroy({children:!0})}))}}else console.error(`UUID (${this.presetUuid}) Name (${this.presetName}) does not exist`)}static isSpawned(e,t){const n=game.scenes.get(t);return i.Me.some((t=>n.getEmbeddedCollection(t).some((t=>t.flags[i.Do]?.spawnPreset?.behaviorId===e))))}static async spawnPreset(e,t,n,s,a=!0){const r=a?function(e){let t={x:0,y:0};const{vertices:n,indices:i}=e.triangulation,s=[];let a,o=0;for(let e=0;e<i.length;e+=3){const t=2*i[e],a=2*i[e+1],r=2*i[e+2],d=n[t],l=n[t+1],h=n[a],c=n[a+1],g=n[r],E=n[r+1],T=Math.abs((h-d)*(E-l)-(g-d)*(c-l))/2;o+=T,s.push(T)}for(let r=0;r<10;r++){let r;a=void 0;let d=o*Math.random();for(r=0;r<s.length-1&&(d-=s[r],!(d<0));r++);const l=3*r,h=2*i[l],c=2*i[l+1],g=2*i[l+2],E=n[h],T=n[h+1],p=n[c],u=n[c+1],f=n[g],m=n[g+1],N=Math.sqrt(Math.random()),S=Math.random(),y=N*(1-S),O=N*S;a={x:Math.round(E+(p-E)*y+(f-E)*O-t.x),y:Math.round(T+(u-T)*y+(m-T)*O-t.y)},e.polygonTree.testPoint(a)}return a}(s):SpawnPresetBehaviorType.getCenterPosition(s);if(r){const a={[i.Do]:{spawnPreset:{uuid:n.uuid,behaviorId:t,regionId:e}}};o.af.spawnPreset({preset:n,x:r.x,y:r.y,scaleToGrid:!0,center:!0,flags:a,sceneId:s.parent.id})}}static getCenterPosition(e){const{x1:t,y1:n,x2:i,y2:s}=(0,r.GD)("Region",e.document??e);return{x:t+(i-t)/2,y:n+(s-n)/2}}}function d(){Object.assign(CONFIG.RegionBehavior.dataModels,{[`${i.Do}.linkToken`]:LinkTokenRegionBehaviorType,[`${i.Do}.spawnPreset`]:SpawnPresetBehaviorType,[`${i.Do}.deSpawnPreset`]:DeSpawnPresetBehaviorType}),Object.assign(CONFIG.RegionBehavior.typeIcons,{[`${i.Do}.linkToken`]:"fas fa-link",[`${i.Do}.spawnPreset`]:"fa-solid fa-books",[`${i.Do}.deSpawnPreset`]:"fa-duotone fa-books"})}}}]);
//# sourceMappingURL=180.bundle.js.map