{"version":3,"file":"mass-edit.js","mappings":"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","sources":["webpack://multi-token-edit/webpack/runtime/create fake namespace object","webpack://multi-token-edit/webpack/runtime/load script","webpack://multi-token-edit/./multi-token-edit/applications/cssEdit.js","webpack://multi-token-edit/./multi-token-edit/applications/formUtils.js","webpack://multi-token-edit/./multi-token-edit/scripts/fieldInjector.js","webpack://multi-token-edit/./multi-token-edit/scripts/macro/action.js","webpack://multi-token-edit/./multi-token-edit/scripts/macro/targets.js","webpack://multi-token-edit/./multi-token-edit/scripts/macro/generator.js","webpack://multi-token-edit/./multi-token-edit/applications/macro.js","webpack://multi-token-edit/./multi-token-edit/applications/meApplication.js","webpack://multi-token-edit/./multi-token-edit/applications/forms.js","webpack://multi-token-edit/./multi-token-edit/data/custom-controls.js","webpack://multi-token-edit/./multi-token-edit/applications/generic/navGenerator.js","webpack://multi-token-edit/./multi-token-edit/applications/generic/genericForm.js","webpack://multi-token-edit/./multi-token-edit/applications/multiConfig.js","webpack://multi-token-edit/./multi-token-edit/scripts/brush.js","webpack://multi-token-edit/./multi-token-edit/scripts/constants.js","webpack://multi-token-edit/./multi-token-edit/scripts/data/adapters.js","webpack://multi-token-edit/./multi-token-edit/scripts/data/transformer.js","webpack://multi-token-edit/./multi-token-edit/scripts/dialogs.js","webpack://multi-token-edit/./multi-token-edit/scripts/linker/linker.js","webpack://multi-token-edit/./multi-token-edit/scripts/mouse3d.js","webpack://multi-token-edit/./multi-token-edit/scripts/picker.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/bagApp.js","webpack://multi-token-edit/./multi-token-edit/applications/progressDialog.js","webpack://multi-token-edit/./multi-token-edit/scripts/fixedSort.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/tagSelector.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/browser/settingsApp.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/browser/browserApp.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/collection.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/containerApp.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/editApp.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/fileIndexer.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/preset.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/spawner.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/utils.js","webpack://multi-token-edit/./multi-token-edit/scripts/randomizer/randomizerUtils.js","webpack://multi-token-edit/./multi-token-edit/scripts/scenescape/controls.js","webpack://multi-token-edit/./multi-token-edit/scripts/scenescape/configuration.js","webpack://multi-token-edit/./multi-token-edit/scripts/scenescape/scenescape.js","webpack://multi-token-edit/./multi-token-edit/scripts/shim/shim.js","webpack://multi-token-edit/./multi-token-edit/scripts/tmfx.js","webpack://multi-token-edit/./multi-token-edit/scripts/tools/selectTool.js","webpack://multi-token-edit/./multi-token-edit/scripts/utils.js","webpack://multi-token-edit/external var \"jQuery\"","webpack://multi-token-edit/webpack/bootstrap","webpack://multi-token-edit/webpack/runtime/compat get default export","webpack://multi-token-edit/webpack/runtime/define property getters","webpack://multi-token-edit/webpack/runtime/ensure chunk","webpack://multi-token-edit/webpack/runtime/get javascript chunk filename","webpack://multi-token-edit/webpack/runtime/hasOwnProperty shorthand","webpack://multi-token-edit/webpack/runtime/make namespace object","webpack://multi-token-edit/webpack/runtime/publicPath","webpack://multi-token-edit/webpack/runtime/jsonp chunk loading","webpack://multi-token-edit/./multi-token-edit/scripts/presets/migration.js","webpack://multi-token-edit/./multi-token-edit/scripts/behaviors/fields.js","webpack://multi-token-edit/./multi-token-edit/scripts/behaviors/DeSpawnPresetRegionBehaviorType.js","webpack://multi-token-edit/./multi-token-edit/scripts/behaviors/LinkTokenRegionBehaviorType.js","webpack://multi-token-edit/./multi-token-edit/scripts/behaviors/SpawnPresetRegionBehaviorType.js","webpack://multi-token-edit/./multi-token-edit/scripts/presets/categoryBrowserApp.js","webpack://multi-token-edit/./multi-token-edit/multi-token-edit.mjs","webpack://multi-token-edit/./multi-token-edit/scripts/behaviors/behaviors.js","webpack://multi-token-edit/./multi-token-edit/scripts/settings.js"],"sourcesContent":["var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n\t__webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; typeof current == 'object' && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => (def[key] = () => (value[key])));\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","var inProgress = {};\nvar dataWebpackPrefix = \"multi-token-edit:\";\n// loadScript function to load a script via script tag\n__webpack_require__.l = (url, done, key, chunkId) => {\n\tif(inProgress[url]) { inProgress[url].push(done); return; }\n\tvar script, needAttach;\n\tif(key !== undefined) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tfor(var i = 0; i < scripts.length; i++) {\n\t\t\tvar s = scripts[i];\n\t\t\tif(s.getAttribute(\"src\") == url || s.getAttribute(\"data-webpack\") == dataWebpackPrefix + key) { script = s; break; }\n\t\t}\n\t}\n\tif(!script) {\n\t\tneedAttach = true;\n\t\tscript = document.createElement('script');\n\n\t\tscript.charset = 'utf-8';\n\t\tscript.timeout = 120;\n\t\tif (__webpack_require__.nc) {\n\t\t\tscript.setAttribute(\"nonce\", __webpack_require__.nc);\n\t\t}\n\t\tscript.setAttribute(\"data-webpack\", dataWebpackPrefix + key);\n\n\t\tscript.src = url;\n\t}\n\tinProgress[url] = [done];\n\tvar onScriptComplete = (prev, event) => {\n\t\t// avoid mem leaks in IE.\n\t\tscript.onerror = script.onload = null;\n\t\tclearTimeout(timeout);\n\t\tvar doneFns = inProgress[url];\n\t\tdelete inProgress[url];\n\t\tscript.parentNode && script.parentNode.removeChild(script);\n\t\tdoneFns && doneFns.forEach((fn) => (fn(event)));\n\t\tif(prev) return prev(event);\n\t}\n\tvar timeout = setTimeout(onScriptComplete.bind(null, undefined, { type: 'timeout', target: script }), 120000);\n\tscript.onerror = onScriptComplete.bind(null, script.onerror);\n\tscript.onload = onScriptComplete.bind(null, script.onload);\n\tneedAttach && document.head.appendChild(script);\n};","import { MODULE_ID } from '../scripts/constants.js';\r\n\r\nexport function getInUseStyle() {\r\n  const styleInUse = game.settings.get(MODULE_ID, 'cssStyle');\r\n  if (styleInUse in STYLES) {\r\n    return [styleInUse, STYLES[styleInUse]];\r\n  } else {\r\n    return ['CUSTOM', game.settings.get(MODULE_ID, 'cssCustom') || ''];\r\n  }\r\n}\r\n\r\nexport default class CSSEdit extends FormApplication {\r\n  constructor() {\r\n    super({}, {});\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-css',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/cssEdit.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: 'Edit CSS',\r\n      width: 490,\r\n      height: 730,\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    const [styleInUse, css] = getInUseStyle();\r\n    data.styleInUse = styleInUse;\r\n    data.css = css;\r\n\r\n    data.styles = Object.keys(STYLES);\r\n    data.styles.push('CUSTOM');\r\n    data.disableCSS = styleInUse !== 'CUSTOM';\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    $(html).on('change', '.selectStyle', (event) => {\r\n      let css;\r\n      if (event.target.value === 'CUSTOM') {\r\n        css = game.settings.get(MODULE_ID, 'cssCustom');\r\n      } else {\r\n        css = STYLES[event.target.value];\r\n      }\r\n      $(html)\r\n        .find('.cssTextArea')\r\n        .val(css)\r\n        .prop('disabled', event.target.value !== 'CUSTOM');\r\n      $(html).find('.previewStyle').html(css);\r\n    });\r\n    $(html).on('input', '.cssTextArea', (event) => {\r\n      $(html).find('.previewStyle').html(event.target.value);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (formData.selectedStyle === 'CUSTOM') {\r\n      game.settings.set(MODULE_ID, 'cssCustom', formData.css);\r\n    }\r\n    game.settings.set(MODULE_ID, 'cssStyle', formData.selectedStyle);\r\n  }\r\n}\r\n\r\n// Pre-made styles\r\nexport const STYLES = {\r\n  Default: `.form-group.meCommon {\r\n  outline: green dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  outline: rgb(255, 204, 110) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  outline: rgb(246, 175, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  outline: rgb(118, 242, 255) dotted 2px;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // No Outline\r\n  // ==================\r\n  'No Outline': `.form-group.meCommon {}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Striped Background\r\n  // ==================\r\n  'Striped Background': `.form-group.meCommon {\r\n  background: repeating-linear-gradient(\r\n  45deg,\r\n  rgba(155, 233, 155, 0.8),\r\n  rgba(155, 233, 155, 0.8) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\n  outline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: repeating-linear-gradient(\r\n  135deg,\r\n  rgba(255, 207, 118, 0.5),\r\n  rgba(255, 207, 118, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(237, 149, 255, 0.3),\r\n  rgba(237, 149, 255, 0.3) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: repeating-linear-gradient(\r\n  70deg,\r\n  rgba(118, 242, 255, 0.5),\r\n  rgba(118, 242, 255, 0.5) 10px,\r\n  rgba(0, 0, 0, 0) 10px,\r\n  rgba(0, 0, 0, 0) 20px\r\n  );\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n`,\r\n  // ==================\r\n  // Solid Background\r\n  // ==================\r\n  'Solid Background': `.form-group.meCommon {\r\n  background: rgba(155, 233, 155, 0.8)\r\n}\r\n\r\n.mass-edit-checkbox.meCommon {\r\noutline: green solid 2px;\r\n}\r\n\r\n.form-group.meDiff {\r\n  background: rgba(255, 207, 118, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meDiff {\r\n  outline: rgb(255, 204, 110) solid 2px;\r\n}\r\n\r\n.form-group.meFlag {\r\n  background: rgba(237, 149, 255, 0.3)\r\n}\r\n\r\n.mass-edit-checkbox.meFlag {\r\n  outline: rgb(246, 175, 255) solid 2px;\r\n}\r\n\r\n.form-group.meInsert {\r\n  background: rgba(118, 242, 255, 0.5)\r\n}\r\n\r\n.mass-edit-checkbox.meInsert {\r\n  outline: rgb(118, 242, 255) solid 2px;\r\n}`,\r\n};\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from '../scripts/constants.js';\r\nimport { applyRandomization } from '../scripts/randomizer/randomizerUtils.js';\r\nimport { applyDDTint, applyTMFXPreset } from '../scripts/tmfx.js';\r\nimport {\r\n  flagCompare,\r\n  getCommonData,\r\n  getData,\r\n  getDocumentName,\r\n  localFormat,\r\n  mergeObjectPreserveDot,\r\n  panToFitPlaceables,\r\n  wildcardStringMatch,\r\n} from '../scripts/utils.js';\r\nimport { GeneralDataAdapter, TokenDataAdapter } from '../scripts/data/adapters.js';\r\nimport { SCENE_DOC_MAPPINGS, showMassEdit } from './multiConfig.js';\r\nimport { DataTransformer } from '../scripts/data/transformer.js';\r\n\r\nexport function performMassSearch(\r\n  command,\r\n  documentName,\r\n  selectedFields,\r\n  { scope = null, selected = null, control = true, pan = true } = {}\r\n) {\r\n  const found = [];\r\n\r\n  if (scope === 'selected') {\r\n    performDocSearch(selected, documentName, selectedFields, found);\r\n  } else if (SUPPORTED_COLLECTIONS.includes(documentName)) {\r\n    performDocSearch(Array.from(game.collections.get(documentName)), documentName, selectedFields, found);\r\n  } else {\r\n    let scenes = [];\r\n    if (scope === 'world') scenes = Array.from(game.scenes);\r\n    else if (canvas.scene) scenes = [canvas.scene];\r\n\r\n    for (const scene of scenes) {\r\n      performMassSearchScene(scene, documentName, selectedFields, found);\r\n    }\r\n  }\r\n\r\n  // Select found placeables/documents\r\n  if (control) {\r\n    // First release/de-select the currently selected placeable on the current scene\r\n    canvas.activeLayer.controlled.map((c) => c).forEach((c) => c.release());\r\n\r\n    setTimeout(() => {\r\n      found.forEach((f) => {\r\n        let obj = f.object ?? f;\r\n        if (obj.control) obj.control({ releaseOthers: false });\r\n      });\r\n\r\n      if (pan && found.length && game.settings.get(MODULE_ID, 'panToSearch')) {\r\n        panToFitPlaceables(found);\r\n      }\r\n    }, 100);\r\n  }\r\n  if (command === 'meSearchAndEdit') {\r\n    setTimeout(() => {\r\n      showMassEdit(found, documentName);\r\n    }, 500);\r\n  }\r\n  return found;\r\n}\r\n\r\nfunction performMassSearchScene(scene, documentName, selectedFields, found) {\r\n  const docs = Array.from(scene[SCENE_DOC_MAPPINGS[documentName]]);\r\n  performDocSearch(docs, documentName, selectedFields, found);\r\n}\r\n\r\nfunction performDocSearch(docs, documentName, selectedFields, found) {\r\n  // Next select objects that match the selected fields\r\n  for (const c of docs) {\r\n    let matches = true;\r\n    const data = foundry.utils.flattenObject(getData(c).toObject());\r\n\r\n    // Special processing for some placeable types\r\n    // Necessary when form data is not directly mappable to placeable\r\n    GeneralDataAdapter.dataToForm(documentName, c, data);\r\n\r\n    for (const [k, v] of Object.entries(selectedFields)) {\r\n      // Special handling for flags\r\n      if (k.startsWith('flags.')) {\r\n        if (!flagCompare(data, k, v)) {\r\n          matches = false;\r\n          break;\r\n        }\r\n        // Special handling for empty strings and undefined\r\n      } else if ((v === '' || v == null) && (data[k] !== '' || data[k] != null)) {\r\n        // matches\r\n      } else if (typeof v === 'string' && v.includes('*') && wildcardStringMatch(v, data[k])) {\r\n        // Wildcard matched\r\n      } else if (data[k] != v) {\r\n        // Detection mode keys cannot be treated in isolation\r\n        // We skip them here and will check them later\r\n        if (documentName === 'Token') {\r\n          if (k.startsWith('detectionModes')) {\r\n            continue;\r\n          }\r\n        }\r\n\r\n        matches = false;\r\n        break;\r\n      }\r\n    }\r\n    if (matches) {\r\n      // We skipped detectionMode matching in the previous step and do it now instead\r\n      if (documentName === 'Token') {\r\n        const modes = Object.values(foundry.utils.expandObject(selectedFields)?.detectionModes || {});\r\n\r\n        if (!TokenDataAdapter.detectionModeMatch(modes, c.detectionModes)) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      found.push(c);\r\n    }\r\n  }\r\n}\r\n\r\nexport function applyAddSubtract(updates, objects, documentName, addSubtractFields) {\r\n  // See if any field need to be added or subtracted\r\n  if (!addSubtractFields || foundry.utils.isEmpty(addSubtractFields)) return;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n\r\n    GeneralDataAdapter.dataToForm(documentName, objects[i], data);\r\n\r\n    for (const field of Object.keys(update)) {\r\n      if (field in addSubtractFields && field in data) {\r\n        const ctrl = addSubtractFields[field];\r\n        let val = data[field];\r\n\r\n        // Special processing for Tagger module fields\r\n        if (field === 'flags.tagger.tags') {\r\n          const currentTags = Array.isArray(val) ? val : (val ?? '').split(',').map((s) => s.trim());\r\n          const modTags = (update[field] ?? '').split(',').map((s) => s.trim());\r\n          for (const tag of modTags) {\r\n            if (ctrl.method === 'add') {\r\n              if (!currentTags.includes(tag)) currentTags.push(tag);\r\n            } else if (ctrl.method === 'subtract') {\r\n              const index = currentTags.indexOf(tag);\r\n              if (index > -1) currentTags.splice(index, 1);\r\n            }\r\n          }\r\n          update[field] = currentTags.filter((t) => t).join(',');\r\n          continue;\r\n        } else if (ctrl.type === 'text') {\r\n          if (ctrl.method === 'add') {\r\n            const toAdd = 'value' in ctrl ? ctrl.value : update[field];\r\n            if (toAdd.startsWith('>>')) {\r\n              val = toAdd.replace('>>', '') + val;\r\n            } else {\r\n              val += toAdd;\r\n            }\r\n          } else {\r\n            val = val.replace('value' in ctrl ? ctrl.value : update[field], '');\r\n          }\r\n          update[field] = val;\r\n          continue;\r\n        }\r\n\r\n        if (ctrl.method === 'add') {\r\n          val += 'value' in ctrl ? ctrl.value : update[field];\r\n        } else {\r\n          val -= 'value' in ctrl ? ctrl.value : update[field];\r\n        }\r\n        if ('min' in ctrl && val < ctrl.min) {\r\n          val = ctrl.min;\r\n        } else if ('max' in ctrl && val > ctrl.max) {\r\n          val = ctrl.max;\r\n        }\r\n        update[field] = val;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport async function performMassUpdate(data, objects, documentName, applyType) {\r\n  // Used by GenericForms, we want just the data, and no updates\r\n  if (this.options?.simplified) {\r\n    if (this.options.callback) this.options.callback(data);\r\n    return;\r\n  }\r\n  if (foundry.utils.isEmpty(data)) {\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Make sure we're working with documents and not placeables\r\n  objects = objects.map((o) => o.document ?? o);\r\n\r\n  // Update docs\r\n  const updates = [];\r\n  const context = {};\r\n\r\n  const total = objects.length;\r\n  for (let i = 0; i < total; i++) {\r\n    const update = foundry.utils.deepClone(data);\r\n    update._id = objects[i].id;\r\n\r\n    // push update\r\n    updates.push(update);\r\n  }\r\n\r\n  // Applies randomization\r\n  if (this) await applyRandomization(updates, objects, this.randomizeFields);\r\n  if (this) applyAddSubtract(updates, objects, documentName, this.addSubtractFields);\r\n\r\n  // Necessary when form data is not directly mappable to placeable\r\n  for (let i = 0; i < total; i++) {\r\n    GeneralDataAdapter.formToData(documentName, objects[i], updates[i]);\r\n  }\r\n\r\n  await checkApplySpecialFields(documentName, updates, objects);\r\n\r\n  if (documentName === 'Actor') {\r\n    // Perform Updates\r\n    // There is a lot of wonkiness related to updating of real/synthetic actors. It's probably best\r\n    // to simply update the Actors directly\r\n\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      if (this.options?.tokens) this.options.tokens[i].actor.update(update);\r\n      else objects[i].update(update);\r\n    }\r\n  } else if (documentName === 'Scene') {\r\n    Scene.updateDocuments(updates, context);\r\n  } else if (documentName === 'PlaylistSound') {\r\n    for (let i = 0; i < objects.length; i++) {\r\n      delete updates[i]._id;\r\n      objects[i].update(updates[i]);\r\n    }\r\n  } else if (documentName === 'Note') {\r\n    // Notes can be updated across different scenes\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].scene ?? objects[i].parent;\r\n      if (applyType === 'meApplyCurrentScene' && scene.id !== canvas.scene.id) continue;\r\n      if (!(scene.id in splitUpdates)) {\r\n        splitUpdates[scene.id] = { scene: scene, updates: [] };\r\n      }\r\n      splitUpdates[scene.id].updates.push(updates[i]);\r\n    }\r\n    for (const sceneUpdate of Object.values(splitUpdates)) {\r\n      sceneUpdate.scene.updateEmbeddedDocuments(documentName, sceneUpdate.updates, context);\r\n    }\r\n  } else if (!this.isPrototype && SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    const splitUpdates = {};\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const scene = objects[i].parent;\r\n      if (!splitUpdates[scene.id]) splitUpdates[scene.id] = [];\r\n      splitUpdates[scene.id].push(updates[i]);\r\n    }\r\n\r\n    for (const sceneId of Object.keys(splitUpdates)) {\r\n      game.scenes.get(sceneId)?.updateEmbeddedDocuments(documentName, splitUpdates[sceneId], context);\r\n    }\r\n  } else if (SUPPORTED_COLLECTIONS.includes(documentName)) {\r\n    objects[0].constructor?.updateDocuments(updates, context);\r\n  } else {\r\n    // Not a placeable or otherwise specially handled doc type\r\n    // Simply merge the fields directly into the object\r\n    for (let i = 0; i < updates.length; i++) {\r\n      const update = updates[i];\r\n      delete update._id;\r\n      mergeObjectPreserveDot(objects[i], foundry.utils.mergeObject(objects[i], update));\r\n    }\r\n    if (this.callbackOnUpdate) {\r\n      this.callbackOnUpdate(objects);\r\n    }\r\n  }\r\n\r\n  // May need to also update Token prototypes\r\n  if ((applyType === 'meApplyToPrototype' || this.isPrototype) && documentName === 'Token') {\r\n    const actorUpdates = {};\r\n    for (let i = 0; i < objects.length; i++) {\r\n      const actor = objects[i].actor;\r\n      if (actor) actorUpdates[actor.id] = { _id: actor.id, prototypeToken: updates[i] };\r\n    }\r\n    if (!foundry.utils.isEmpty(actorUpdates)) {\r\n      const updates = [];\r\n      for (const id of Object.keys(actorUpdates)) {\r\n        updates.push(actorUpdates[id]);\r\n      }\r\n      Actor.updateDocuments(updates);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Processes Mass Edit inserted custom fields\r\n * @param {String} documentName\r\n * @param {*} updates\r\n * @param {*} objects\r\n */\r\nexport async function checkApplySpecialFields(documentName, updates, objects) {\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    const object = objects[i];\r\n\r\n    // Token Magic FX specific processing\r\n    if (update.hasOwnProperty('tokenmagic.ddTint') && typeof TokenMagic !== 'undefined') {\r\n      await applyDDTint(object, update['tokenmagic.ddTint']);\r\n    }\r\n    if (update.hasOwnProperty('tokenmagic.preset') && typeof TokenMagic !== 'undefined') {\r\n      await applyTMFXPreset(\r\n        object,\r\n        update['tokenmagic.preset'],\r\n        this?.addSubtractFields?.['tokenmagic.preset']?.method === 'subtract'\r\n      );\r\n    }\r\n\r\n    // Mass Edit inserted fields\r\n    if (documentName === 'Tile') {\r\n      if (update.hasOwnProperty('massedit.scale')) {\r\n        const scale = update['massedit.scale'];\r\n        update.width = object.width * scale;\r\n        update.height = object.height * scale;\r\n\r\n        // 3D Support\r\n        if (object.flags?.['levels-3d-preview']?.depth != null) {\r\n          update['flags.levels-3d-preview.depth'] = object.flags['levels-3d-preview'].depth *= scale;\r\n        } else if (object['flags.levels-3d-preview.depth'] != null) {\r\n          update['flags.levels-3d-preview.depth'] = object['flags.levels-3d-preview.depth'] * scale;\r\n        }\r\n      }\r\n\r\n      if (update.hasOwnProperty('massedit.texture.scale')) {\r\n        update['texture.scaleX'] = update['massedit.texture.scale'];\r\n        update['texture.scaleY'] = update['massedit.texture.scale'];\r\n        delete update['massedit.texture.scale'];\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Toggle checkbox if input has been detected inside it's form-group\r\nexport async function onInputChange(event) {\r\n  if (event.target.className === 'mass-edit-control') {\r\n    if (!event.target.checked) {\r\n      // If the checkbox has been unchecked we may need to remove highlighting from tabs\r\n      deselectTabs(event.target);\r\n      return;\r\n    }\r\n  }\r\n\r\n  const meChk = $(event.target).closest('.form-group').find('.mass-edit-checkbox input');\r\n  meChk.prop('checked', true);\r\n\r\n  // Highlight tabs if they exist\r\n  selectTabs(meChk[0]);\r\n\r\n  // Immediately update the placeables\r\n  if (this?.options.massEdit && this._performOnInputChangeUpdate && this.modUpdate) this._performOnInputChangeUpdate();\r\n}\r\n\r\nexport function selectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .addClass('mass-edit-tab-selected');\r\n    selectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nexport function deselectTabs(target) {\r\n  const tab = $(target).parent().closest('div.tab, div.matt-tab');\r\n  if (tab.length && tab.find('.mass-edit-checkbox input:checked').length === 0) {\r\n    tab\r\n      .siblings('nav.tabs')\r\n      .find(`[data-tab=\"${tab.attr('data-tab')}\"]`)\r\n      .removeClass('mass-edit-tab-selected');\r\n    deselectTabs(tab[0]);\r\n  }\r\n}\r\n\r\nfunction getObjFormData(obj, documentName) {\r\n  const data = foundry.utils.flattenObject(getData(obj).toObject());\r\n\r\n  // Special processing for some placeable types\r\n  // Necessary when form data is not directly mappable to placeable\r\n  GeneralDataAdapter.dataToForm(documentName, obj, data);\r\n\r\n  return data;\r\n}\r\n\r\n// Merge all data and determine what is common between the docs\r\nexport function getCommonDocData(docs, documentName) {\r\n  if (!documentName) getDocumentName(docs[0]);\r\n  const objects = docs.map((d) => getObjFormData(d, documentName));\r\n  return getCommonData(objects);\r\n}\r\n\r\n/**\r\n *\r\n * @param {Document} docs\r\n * @param {Preset} preset\r\n * @param {boolean} suppressNotif\r\n * @returns\r\n */\r\nexport function pasteDataUpdate(docs, preset, suppressNotif = false, excludePosition = false, transform = null) {\r\n  if (!docs || !docs.length) return false;\r\n\r\n  let documentName = docs[0].document ? docs[0].document.documentName : docs[0].documentName;\r\n\r\n  preset = preset ?? getClipboardData(documentName);\r\n  let applyType;\r\n\r\n  // Special handling for Tokens/Actors\r\n  if (!preset) {\r\n    if (documentName === 'Token') {\r\n      if (!preset) {\r\n        preset = getClipboardData('TokenProto');\r\n        applyType = 'meApplyToPrototype';\r\n      }\r\n\r\n      if (!preset) {\r\n        preset = getClipboardData('Actor');\r\n        documentName = 'Actor';\r\n        docs = docs.filter((d) => d.actor).map((d) => d.actor);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (preset) {\r\n    if (preset.documentName !== documentName) return;\r\n\r\n    const context = { meObjects: docs };\r\n    if (!foundry.utils.isEmpty(preset.randomize)) context.randomizeFields = preset.randomize;\r\n    if (!foundry.utils.isEmpty(preset.addSubtract)) context.addSubtractFields = preset.addSubtract;\r\n\r\n    const ogData = preset.data[Math.floor(Math.random() * preset.data.length)];\r\n    let data = foundry.utils.deepClone(ogData);\r\n    if (transform) {\r\n      DataTransformer.apply(documentName, data, { x: 0, y: 0 }, transform);\r\n      data = foundry.utils.mergeObject(ogData, data, { insertKeys: false, inplace: false });\r\n    }\r\n    if (excludePosition) {\r\n      delete data.x;\r\n      delete data.y;\r\n      delete data.c;\r\n      delete data.elevation;\r\n    }\r\n\r\n    performMassUpdate.call(context, foundry.utils.flattenObject(data), docs, preset.documentName, applyType);\r\n    if (!suppressNotif)\r\n      ui.notifications.info(\r\n        localFormat('clipboard.paste', {\r\n          document: preset.documentName,\r\n          count: docs.length,\r\n        })\r\n      );\r\n\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n// ==================================\r\n// ========== CLIPBOARD =============\r\n// ==================================\r\n\r\nconst CLIPBOARD = {};\r\n\r\nexport function copyToClipboard(preset, command, isPrototype) {\r\n  CLIPBOARD[preset.documentName] = preset;\r\n\r\n  // Special handling for Actors/Tokens\r\n  if (preset.documentName === 'Token' && isPrototype) {\r\n    CLIPBOARD['TokenProto'] = preset;\r\n  } else if (preset.documentName === 'Token') {\r\n    if (command === 'copyProto') {\r\n      delete CLIPBOARD['Token'];\r\n      CLIPBOARD['TokenProto'] = preset;\r\n    }\r\n  }\r\n\r\n  // Also copy the fields to the game clipboard as plain text\r\n  game.clipboard.copyPlainText(\r\n    JSON.stringify(foundry.utils.deepClone(preset.data.length === 1 ? preset.data[0] : preset.data), null, 2)\r\n  );\r\n\r\n  ui.notifications.info(\r\n    localFormat('clipboard.copy', {\r\n      document: preset.documentName,\r\n    })\r\n  );\r\n}\r\n\r\nexport function getClipboardData(documentName) {\r\n  return CLIPBOARD[documentName];\r\n}\r\n\r\nexport function deleteFromClipboard(documentName) {\r\n  delete CLIPBOARD[documentName];\r\n  if (documentName === 'Token') delete CLIPBOARD['TokenProto'];\r\n}\r\n","import { getDocumentName, localize } from './utils.js';\r\n\r\nexport function injectVisibility(app) {\r\n  const documentName = getDocumentName(app.meObjects[0]);\r\n\r\n  // Only the following docs necessitate hidden field\r\n  if (!['AmbientLight', 'AmbientSound'].includes(documentName)) return;\r\n\r\n  const form = $(app.form);\r\n\r\n  const isInjected = form.find('input[name=\"hidden\"]');\r\n  if (isInjected.length) return;\r\n\r\n  const hidden = app.meObjects[0].hidden;\r\n  const newHtml = `\r\n  <div class=\"form-group\">\r\n    <label>${localize(`Hidden`, false)}</label>\r\n    <div class=\"form-fields\">\r\n        <input type=\"checkbox\" name=\"hidden\" ${hidden ? 'checked' : ''}>\r\n    </div>\r\n  </div>\r\n`;\r\n\r\n  const tabs = form.find('div.tab');\r\n  if (tabs.length) {\r\n    tabs.first().append(newHtml);\r\n  } else {\r\n    form.find('.form-group').last().after(newHtml);\r\n  }\r\n\r\n  //app.setPosition({ height: 'auto' });\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { hasMassEditUpdateDependency, objToString } from './generator.js';\r\n\r\nexport function genAction(options, documentName) {\r\n  if (options.method === 'update' || options.method === 'toggle') {\r\n    let command = ``;\r\n\r\n    if (options.method === 'toggle') command += genToggleUtil(options);\r\n\r\n    // Insert 'update' objects\r\n\r\n    command += `\\n// Updates to be applied\r\nconst update = ${objToString(options.fields)};\\n`;\r\n    if (options.method === 'toggle') command += `const update2 = ${objToString(options.toggle.fields)};\\n\\n`;\r\n\r\n    // Insert Mass Edit control objects\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      command += `\\n// Mass Edit control objects\\n`;\r\n      if (options.randomize) command += `const randomizeFields = ${objToString(options.randomize)};\\n`;\r\n      if (options.addSubtract) command += `const addSubtractFields = ${objToString(options.addSubtract)};\\n`;\r\n      if (options.toggle) {\r\n        if (options.toggle.randomize)\r\n          command += `const randomizeFieldsToggleOff = ${objToString(options.toggle?.randomize)};\\n`;\r\n        if (options.toggle.addSubtract)\r\n          command += `const addSubtractFieldsToggleOff = ${objToString(options.toggle?.addSubtract)};\\n`;\r\n      }\r\n    }\r\n\r\n    if (hasMassEditUpdateDependency(options)) {\r\n      return command + genUpdateWithMassEditDep(options, documentName);\r\n    } else {\r\n      return command + genUpdate(options, documentName);\r\n    }\r\n  } else if (options.method === 'massEdit') {\r\n    return `\\n// Open Mass Edit Form\r\nawait MassEdit.api.showMassEdit(targets, '${documentName}');`;\r\n  } else if (options.method === 'delete') {\r\n    return genDelete(options, documentName);\r\n  }\r\n}\r\n\r\nfunction genDelete(options, documentName) {\r\n  let command = `\\n// Delete ${documentName}s`;\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    if (options.target.scope === 'selected' || options.target.scope === 'scene') {\r\n      command += `\\ncanvas.scene.deleteEmbeddedDocuments('${documentName}', targets.map(t => t.id));`;\r\n    } else {\r\n      command += `\\nconst toDelete = {};\r\ntargets.forEach( t => {\r\n  const sceneID = t.parent.id;\r\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\r\n  toDelete[sceneID].push(t.id);\r\n});\r\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${documentName}', toDelete[sceneID]));\r\n      `;\r\n    }\r\n  } else {\r\n    command += `\\n${documentName}.deleteDocuments(targets.map( t => t.id ));`;\r\n  }\r\n  return command;\r\n}\r\n\r\nfunction genUpdate(options, documentName) {\r\n  // Update related code\r\n  let command = '';\r\n\r\n  // Macro only execution, ignore update code\r\n  if (foundry.utils.isEmpty(options.fields) && !options.toggle) {\r\n    return '';\r\n  } else if (options.toggle && foundry.utils.isEmpty(options.toggle.fields) && foundry.utils.isEmpty(options.fields)) {\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n\r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n    `;\r\n  }\r\n\r\n  // We start generating update code here\r\n  // Are there macros to execute?\r\n  const macroTracking = (options.macro || options.toggle?.macro) && options.toggle;\r\n\r\n  if (macroTracking) {\r\n    command += `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  `;\r\n  }\r\n\r\n  // Setting up updates\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    command += '\\nconst updates = {};';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n\r\n  updates[sceneId].push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  const sceneId = t.parent.id;\r\n  if(!updates[sceneId]) updates[sceneId] = [];\r\n  \r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n    updates[sceneId].push(u);\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    command += '\\nconst updates = [];';\r\n    if (options.method === 'toggle') {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u;\r\n  if(toggleOn(t, update)) {\r\n    u = foundry.utils.deepClone(update2);${macroTracking ? '\\ntoggleOffTargets.push(t);' : ''}\r\n  } else {\r\n    u = foundry.utils.deepClone(update);${macroTracking ? '\\ntoggleOnTargets.push(t);' : ''}\r\n  }\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    } else {\r\n      command += `\r\ntargets.forEach((t) => {\r\n  let u = foundry.utils.deepClone(update);\r\n  u._id = t.id;\r\n  updates.push(u);\r\n});\r\n  `;\r\n    }\r\n  }\r\n\r\n  // Executing updates\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    command += `\r\nfor(const sceneId of Object.keys(updates)) {\r\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${documentName}', updates[sceneId]);\r\n}\r\n  `;\r\n  } else if (documentName === 'PlaylistSound') {\r\n    command += `\r\nfor (let i = 0; i < targets.length; i++) {\r\n  delete updates[i]._id;\r\n  targets[i].document.update(updates[i]);\r\n}\r\n  `;\r\n  } else {\r\n    command += `\\n${documentName}.updateDocuments(updates);\\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genUpdateWithMassEditDep(options, documentName) {\r\n  let context = [];\r\n  if (options.randomize) context.push('randomizeFields');\r\n  if (options.addSubtract) context.push('addSubtractFields');\r\n  context = context.join(', ');\r\n\r\n  if (options.method === 'toggle') {\r\n    let context2 = [];\r\n    if (options.toggle?.randomize) context2.push('randomizeFields: randomizeFieldsToggleOff');\r\n    if (options.toggle?.addSubtract) context2.push('addSubtractFields: addSubtractFieldsToggleOff');\r\n    context2 = context2.join(', ');\r\n    return `\r\nconst toggleOnTargets = [];\r\nconst toggleOffTargets = [];\r\n  \r\ntargets.forEach((t) => {\r\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\r\n  else toggleOnTargets.push(t);\r\n});\r\n  \r\nawait MassEdit.api.performMassUpdate.call({${context}}, update, toggleOnTargets, '${documentName}');\r\nawait MassEdit.api.performMassUpdate.call({${context2}}, update2, toggleOffTargets, '${documentName}');\r\n`;\r\n  } else {\r\n    return `await MassEdit.api.performMassUpdate.call({${context}}, update, targets, '${documentName}');\\n`;\r\n  }\r\n}\r\n\r\nfunction genToggleUtil(options) {\r\n  let command = `\\n// Toggle; Helper function`;\r\n  if (options.toggle.method === 'field') {\r\n    command += `\r\nconst toggleOn = function (obj, fields) {\r\n  const data = foundry.utils.flattenObject(obj.toObject());\r\n  fields = foundry.utils.flattenObject(fields);\r\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\r\n};\r\n  `;\r\n  } else {\r\n    command += `\r\nconst macro = this;\r\nconst toggleOn = function (obj) {\r\n  if (obj.getFlag('world', \\`macro-\\${macro.id}-toggleOn\\`)) {\r\n    obj.unsetFlag('world', \\`macro-\\${macro.id}-toggleOn\\`);\r\n    return true;\r\n  } else {\r\n    obj.setFlag('world', \\`macro-\\${macro.id}-toggleOn\\`, true);\r\n    return false;\r\n  }\r\n};\r\n`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { objToString } from './generator.js';\r\n\r\nexport function genTargets(options, documentName, selected) {\r\n  const target = options.target;\r\n  if (target.method === 'ids') {\r\n    return genIDTargets(target, documentName, selected);\r\n  } else if (target.method === 'search') {\r\n    return genSearch(target, documentName);\r\n  } else if (target.method === 'tagger') {\r\n    return genTaggerTargets(target, documentName);\r\n  } else if (target.method === 'all') {\r\n    return genAllTargets(target, documentName);\r\n  } else if (target.method === 'currentScene') {\r\n    return `const targets = [canvas.scene]`;\r\n  } else {\r\n    throw new Error('Invalid target method: ' + target.method);\r\n  }\r\n}\r\n\r\nfunction genSearch(target, documentName) {\r\n  let fields = objToString(target.fields);\r\n  if (target.scope === 'selected') {\r\n    let command = genSelected(documentName);\r\n    command += `\\ntargets = await MassEdit.api.performMassSearch('meSearch', '${documentName}' , ${fields}, { scope: 'selected', selected: targets, control: false, pan: false });`;\r\n    return command;\r\n  } else if (target.scope === 'scene') {\r\n    return `const targets = await MassEdit.api.performMassSearch('meSearch', '${documentName}' , ${fields}, { scope: 'scene', control: false, pan: false });`;\r\n  } else if (target.scope === 'world') {\r\n    return `const targets = await MassEdit.api.performMassSearch('meSearch', '${documentName}' , ${fields}, { scope: 'world', control: false, pan: false });`;\r\n  }\r\n}\r\n\r\n// Construct all selected document retriever\r\n// const selected = [...];\r\nfunction genSelected(documentName) {\r\n  let command = '';\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    return `let targets = canvas.getLayerByEmbeddedName('${documentName}').controlled.map(o => o.document);\\n\\n`;\r\n  } else if (game.modules.get('multiple-document-selection')?.active) {\r\n    const mdsClasses = {\r\n      Actor: 'actor',\r\n      Scene: 'scene',\r\n      JournalEntry: 'journalentry',\r\n      Playlist: 'sound',\r\n      Item: 'item',\r\n      RollTable: 'RollTable',\r\n      Cards: 'cards',\r\n    };\r\n\r\n    command += 'let targets = [];\\n';\r\n\r\n    if (documentName === 'Playlist') {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[documentName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n  if (d) targets.push(d);\r\n});\r\n`;\r\n    } else {\r\n      command += `\r\n$(\\`.directory-list .\\${'${mdsClasses[documentName]}'}.selected\\`).each(function (_) {\r\n  let d = game.collections.get('${documentName}').get(this.dataset.documentId);\r\n  if (d) targets.push(d);\r\n});\r\n  `;\r\n    }\r\n    return command;\r\n  } else {\r\n    throw new Error(`'Selected' is not a supported options for ${documentName}s`);\r\n  }\r\n}\r\n\r\nfunction genAllTargets(target, documentName) {\r\n  if (target.scope === 'selected') {\r\n    return genSelected(documentName);\r\n  } else if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    if (target.scope === 'scene') {\r\n      return `const targets = canvas.getLayerByEmbeddedName('${documentName}').placeables.map(o => o.document);\\n\\n`;\r\n    } else if (target.scope === 'world') {\r\n      return `const targets = [];\r\nArray.from(game.scenes).forEach( scene => {\r\n  Array.from( scene.getEmbeddedCollection('${documentName}') ).forEach(embed => targets.push(embed));\r\n});\r\n  `;\r\n    }\r\n  } else {\r\n    return `const targets = Array.from(game.collections.get('${documentName}'));`;\r\n  }\r\n}\r\n\r\nfunction genTaggerTargets(target, documentName) {\r\n  let command = '';\r\n  const opts = {\r\n    matchAny: target.tagger.match === 'any',\r\n    allScenes: target.scope === 'world',\r\n  };\r\n\r\n  if (target.scope === 'selected') {\r\n    command += genSelected(documentName);\r\n    command += `targets = Tagger.getByTag('${target.tagger.tags}', { matchAny: ${\r\n      target.tagger.match === 'any'\r\n    }, objects: targets }).filter(t => t.documentName === '${documentName}');\\n\\n`;\r\n  } else if (target.scope === 'scene') {\r\n    command += `const targets = Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )}).filter(t => t.documentName === '${documentName}');\\n\\n`;\r\n  } else if (target.scope === 'world') {\r\n    command += `const targets = [];`;\r\n    command += `Object.values(Tagger.getByTag('${target.tagger.tags}', ${objToString(\r\n      opts\r\n    )})).forEach(item => item.forEach(t => { if(t.documentName === '${documentName}') targets.push(t) }));`;\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nfunction genIDTargets(target, documentName, selected) {\r\n  let command = `const ids = [${selected.map((p) => `\"${p.id}\"`).join(',')}];\\n`;\r\n  command += `const targets = [];`;\r\n\r\n  if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n    command += `\r\nids.forEach( id => {\r\n  Array.from(game.scenes).forEach( scene => {\r\n    let embed = scene.getEmbeddedDocument('${documentName}', id);\r\n    if(embed) targets.push(embed)\r\n  });\r\n});\r\n`;\r\n  } else {\r\n    command += `\r\nids.forEach(id => { \r\n  const doc = ${documentName}.get(id);\r\n  if(doc) targets.push(doc);\r\n});`;\r\n  }\r\n\r\n  return command;\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS } from '../constants.js';\r\nimport { localFormat } from '../utils.js';\r\nimport { genAction } from './action.js';\r\nimport { genTargets } from './targets.js';\r\n\r\n// Util to stringify a json object\r\nexport function objToString(obj) {\r\n  if (!obj) return null;\r\n  return JSON.stringify(obj, null, 2);\r\n}\r\n\r\nexport async function generateMacro(documentName, placeables, options) {\r\n  let command = '';\r\n\r\n  // Dependencies get checked first\r\n  command += genMacroDependencies(options, documentName);\r\n  command += genTargets(options, documentName, placeables);\r\n  command += genAction(options, documentName);\r\n  if (options.macro || options.toggle?.macro) {\r\n    command += genRunMacro(options, documentName);\r\n  }\r\n\r\n  if (command) {\r\n    // Create Macro\r\n    const macro = await Macro.create({\r\n      name: options.name,\r\n      type: 'script',\r\n      scope: 'global',\r\n      command: command,\r\n    });\r\n    macro.sheet.render(true);\r\n  }\r\n}\r\n\r\nfunction genRunMacro(options, documentName) {\r\n  let command = `\\n\r\n// ===================\r\n// = Macro Execution =\r\n// ===================\r\n\r\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\r\n`;\r\n\r\n  if (options.macro?.select || options.toggle?.macro?.select) {\r\n    command += `const layer = canvas.getLayerByEmbeddedName('${documentName}');`;\r\n  }\r\n\r\n  // Run macros if applicable\r\n  if (options.macro) {\r\n    command += `\r\n// Apply macro\r\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${options.macro.name}')\r\nif (applyMacro && ${options.toggle ? 'toggleOnTargets' : 'targets'}.length) {\r\n  ${\r\n    options.macro.select\r\n      ? `layer.activate();\\n  layer.releaseAll();\\n  ${\r\n          options.toggle ? 'toggleOnTargets' : 'targets'\r\n        }.forEach(t => t.object?.control({ releaseOthers: false }));\\n`\r\n      : ''\r\n  }\r\n  if (advancedMacro) applyMacro.execute(${options.toggle ? 'toggleOnTargets' : 'targets'});\r\n  else applyMacro.execute({token, actor});\r\n  ${options.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  if (options.toggle?.macro) {\r\n    command += `\r\n// Apply macro on toggle off\r\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${options.toggle.macro.name}')\r\nif (offMacro && toggleOffTargets.length) {\r\n  ${\r\n    options.toggle.macro.select\r\n      ? 'layer.activate();\\n  layer.releaseAll();\\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\\n'\r\n      : ''\r\n  }\r\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\r\n  else offMacro.execute({token, actor});\r\n  ${options.toggle.macro.select ? '\\n  layer.releaseAll();' : ''}\r\n}\r\n`;\r\n  }\r\n  return command;\r\n}\r\n\r\nexport function hasMassEditDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    options.target.method === 'search' ||\r\n    options.method === 'massEdit' ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nexport function hasMassEditUpdateDependency(options) {\r\n  return (\r\n    options.randomize ||\r\n    options.addSubtract ||\r\n    options.toggle?.randomize ||\r\n    options.toggle?.addSubtract ||\r\n    hasSpecialField(options.fields)\r\n  );\r\n}\r\n\r\nfunction genMacroDependencies(options, documentName) {\r\n  let dep = '';\r\n\r\n  const depWarning = (module) => {\r\n    return `ui.notifications.warn('${localFormat('macro.dependency-warning', {\r\n      module,\r\n    })}');`;\r\n  };\r\n\r\n  if (options.target.method === 'tagger')\r\n    dep += `\r\nif (!game.modules.get('tagger')?.active) {\r\n  ${depWarning('Tagger')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (hasMassEditDependency(options))\r\n    dep += `\r\nconst MassEdit = game.modules.get('${MODULE_ID}');\r\nif(!MassEdit?.active){\r\n  ${depWarning('Mass Edit')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  if (SUPPORTED_COLLECTIONS.includes(documentName) && options.target.scope === 'select')\r\n    dep += `\r\nif (!game.modules.get('multiple-document-selection')?.active) {\r\n  ${depWarning('Multiple Document Selection')}\r\n  return;\r\n}\r\n\r\n`;\r\n\r\n  return dep;\r\n}\r\n\r\nexport function hasSpecialField(fields) {\r\n  const specialFields = ['tokenmagic.ddTint', 'tokenmagic.preset', 'massedit.scale', 'massedit.texture.scale'];\r\n  for (const sf of specialFields) {\r\n    if (sf in fields) return true;\r\n  }\r\n  return false;\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from '../scripts/constants.js';\r\nimport { generateMacro, hasSpecialField } from '../scripts/macro/generator.js';\r\nimport { localFormat, localize } from '../scripts/utils.js';\r\nimport { GeneralDataAdapter } from '../scripts/data/adapters.js';\r\n\r\nexport default class MacroForm extends FormApplication {\r\n  constructor(object, placeables, documentName, fields, randomizeFields, addSubtractFields) {\r\n    super({}, {});\r\n    this.mainObject = object;\r\n    this.placeables = placeables;\r\n    this.documentName = documentName;\r\n    this.fields = fields;\r\n    this.randomizeFields = randomizeFields;\r\n    this.addSubtractFields = addSubtractFields;\r\n\r\n    if (\r\n      (randomizeFields && !foundry.utils.isEmpty(randomizeFields)) ||\r\n      (addSubtractFields && !foundry.utils.isEmpty(addSubtractFields))\r\n    ) {\r\n      // keep selected fields in form format\r\n    } else {\r\n      GeneralDataAdapter.formToData(this.documentName, this.mainObject, this.fields);\r\n    }\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-macro',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/macro.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generate Macro`,\r\n      width: 400,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n\r\n    data.documentName = this.documentName;\r\n    data.fields = JSON.stringify(this.fields, null, 2);\r\n    data.selectable = SUPPORTED_PLACEABLES.includes(this.documentName);\r\n    data.selectScopeEnabled =\r\n      data.selectable ||\r\n      (SUPPORTED_COLLECTIONS.includes(this.documentName) && game.modules.get('multiple-document-selection')?.active);\r\n\r\n    // Define targeting options based on the document being updated\r\n    const targetingOptions = [\r\n      {\r\n        value: 'all',\r\n        title: localFormat('macro.target-all-title', { document: this.documentName }),\r\n        label: localize('common.all'),\r\n      },\r\n      {\r\n        value: 'search',\r\n        title: localFormat('macro.target-search-title', { document: this.documentName }),\r\n        label: localize('FILES.Search', false),\r\n      },\r\n    ];\r\n\r\n    if (data.selectScopeEnabled) {\r\n      targetingOptions.push({\r\n        value: 'ids',\r\n        title: localize('macro.target-ids-title'),\r\n        label: localize('macro.target-ids'),\r\n      });\r\n    }\r\n\r\n    if (this.documentName === 'Scene') {\r\n      targetingOptions.push({\r\n        value: 'currentScene',\r\n        title: localize('macro.target-current-scene-title'),\r\n        label: 'Current Scene',\r\n      });\r\n    }\r\n\r\n    if (SUPPORTED_PLACEABLES.includes(this.documentName) && game.modules.get('tagger')?.active) {\r\n      targetingOptions.push({\r\n        value: 'tagger',\r\n        title: localize('macro.target-tagger-title'),\r\n        label: 'Tagger',\r\n      });\r\n    }\r\n    data.targetingOptions = targetingOptions;\r\n\r\n    if (this.addSubtractFields && !foundry.utils.isEmpty(this.addSubtractFields)) {\r\n      data.hasAddSubtract = true;\r\n      data.addSubtract = JSON.stringify(this.addSubtractFields);\r\n    }\r\n\r\n    if (this.randomizeFields && !foundry.utils.isEmpty(this.randomizeFields)) {\r\n      data.hasRandom = true;\r\n      data.randomize = JSON.stringify(this.randomizeFields);\r\n    }\r\n\r\n    data.hasMEControls = data.hasAddSubtract || data.hasRandom || hasSpecialField(this.fields);\r\n\r\n    // Visibility Toggle\r\n    data.hiddenControl = ['Token', 'Tile', 'Drawing', 'AmbientLight', 'AmbientSound', 'MeasuredTemplate'].includes(\r\n      this.documentName\r\n    );\r\n\r\n    // Macros\r\n    data.macros = game.collections.get('Macro').map((m) => m.name);\r\n\r\n    return data;\r\n  }\r\n\r\n  _onShowReturnJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    const data = JSON.parse(store.val());\r\n\r\n    let content = `<textarea name=\"json\" style=\"width:100%; height: 300px;\">${JSON.stringify(\r\n      data,\r\n      null,\r\n      2\r\n    )}</textarea>`;\r\n    new Dialog({\r\n      title: `JSON`,\r\n      content: content,\r\n      buttons: {\r\n        Ok: {\r\n          label: localize('Save', false),\r\n          callback: (html) => {\r\n            try {\r\n              const val = JSON.parse(html.find('[name=\"json\"]').val() || '{}');\r\n              if (foundry.utils.isEmpty(val)) {\r\n                control.hide();\r\n                store.prop('disabled', true);\r\n                this.setPosition({ height: 'auto' });\r\n              } else {\r\n                store.val(JSON.stringify(val));\r\n              }\r\n            } catch (e) {\r\n              ui.notifications.warn('Invalid data. Failed to save.');\r\n            }\r\n          },\r\n        },\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  _onRemoveJson(control, name) {\r\n    const store = control.siblings(`[name=\"${name}\"]`);\r\n    control.hide();\r\n    store.prop('disabled', true);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    ['randomize', 'addSubtract', 'toggle.randomize', 'toggle.addSubtract'].forEach((name) => {\r\n      const className = name.replace('.', '');\r\n      html.find(`.${className}`).click((event) => {\r\n        this._onShowReturnJson($(event.target).parent(), name);\r\n      });\r\n      html.find(`.${className}`).contextmenu((event) => {\r\n        this._onRemoveJson($(event.target).parent(), name);\r\n      });\r\n    });\r\n\r\n    html.find('.toggleVisibility').click((event) => {\r\n      const fields = html.find('[name=\"fields\"]');\r\n      const toggleFields = html.find('[name=\"toggle.fields\"]');\r\n\r\n      let update,\r\n        update2 = {};\r\n\r\n      try {\r\n        update = JSON.parse(fields.val());\r\n        update.hidden = !update.hidden;\r\n        fields.val(JSON.stringify(update, null, 2));\r\n\r\n        update2 = JSON.parse(toggleFields.val());\r\n        update2.hidden = !update.hidden;\r\n        toggleFields.val(JSON.stringify(update2, null, 2));\r\n      } catch (e) {}\r\n    });\r\n\r\n    html.find('[name=\"target.method\"]').change((event) => {\r\n      // Hide/show tagger controls\r\n      if (event.target.value === 'tagger') {\r\n        html.find('.taggerControl').show();\r\n        html.find('[name=\"tags\"').attr('required', true);\r\n      } else {\r\n        html.find('.taggerControl').hide();\r\n        html.find('[name=\"tags\"').attr('required', false);\r\n      }\r\n\r\n      // Hide/show scope\r\n      if (event.target.value === 'ids' || event.target.value === 'currentScene')\r\n        html.find('[name=\"target.scope\"]').closest('.form-group').hide();\r\n      else html.find('[name=\"target.scope\"]').closest('.form-group').show();\r\n\r\n      if (event.target.value === 'search') html.find('[name=\"target.fields\"]').closest('div').show();\r\n      else html.find('[name=\"target.fields\"]').closest('div').hide();\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.find('[name=\"method\"]').on('change', (event) => {\r\n      if (event.target.value === 'toggle') {\r\n        let data = foundry.utils.flattenObject(getData(this.mainObject).toObject());\r\n\r\n        const toggleFields = {};\r\n        Object.keys(this.fields).forEach((k) => (toggleFields[k] = data[k]));\r\n        html.find('[name=\"toggle.fields\"]').val(JSON.stringify(toggleFields, null, 2));\r\n        html.find('.toggleControl').show();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.toggleControl').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n\r\n      if (event.target.value === 'massEdit' || event.target.value === 'delete') {\r\n        html.find('.fields').hide();\r\n        this.setPosition({ height: 'auto' });\r\n      } else {\r\n        html.find('.fields').show();\r\n        this.setPosition({ height: 'auto' });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    formData = expandObject(formData);\r\n\r\n    // Cleanup form data so that the macro generator only receives necessary information\r\n    formData.fields = JSON.parse(formData.fields);\r\n    if (formData.method !== 'toggle') delete formData.toggle;\r\n    else formData.toggle.fields = JSON.parse(formData.toggle.fields);\r\n\r\n    if (!formData.macro.name) delete formData.macro;\r\n    if (formData.toggle?.macro && !formData.toggle.macro.name) delete formData.toggle.macro;\r\n\r\n    if (formData.target.method !== 'tagger') delete formData.target.tagger;\r\n    if (formData.target.method !== 'search') delete formData.target.fields;\r\n    else formData.target.fields = JSON.parse(formData.target.fields);\r\n\r\n    if (formData.randomize) formData.randomize = JSON.parse(formData.randomize);\r\n    if (formData.toggle?.randomize) formData.toggle.randomize = JSON.parse(formData.toggle.randomize);\r\n    if (formData.addSubtract) formData.addSubtract = JSON.parse(formData.addSubtract);\r\n    if (formData.toggle?.addSubtract) formData.toggle.addSubtract = JSON.parse(formData.toggle.addSubtract);\r\n\r\n    generateMacro(this.documentName, this.placeables, formData);\r\n  }\r\n}\r\n\r\nfunction getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n","import { Brush } from '../scripts/brush.js';\r\nimport { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from '../scripts/constants.js';\r\nimport { injectVisibility } from '../scripts/fieldInjector.js';\r\nimport { PresetBrowser } from '../scripts/presets/browser/browserApp.js';\r\nimport { Preset } from '../scripts/presets/preset.js';\r\nimport { selectRandomizerFields } from '../scripts/randomizer/randomizerUtils.js';\r\nimport { getDDTint } from '../scripts/tmfx.js';\r\nimport { getDocumentName, hasFlagRemove, localFormat, localize, selectAddSubtractFields } from '../scripts/utils.js';\r\nimport { getInUseStyle } from './cssEdit.js';\r\nimport { GeneralDataAdapter, TokenDataAdapter } from '../scripts/data/adapters.js';\r\nimport {\r\n  copyToClipboard,\r\n  deselectTabs,\r\n  getCommonDocData,\r\n  onInputChange,\r\n  performMassSearch,\r\n  performMassUpdate,\r\n  selectTabs,\r\n} from './formUtils.js';\r\nimport { WithMassPermissions } from './forms.js';\r\nimport MacroForm from './macro.js';\r\nimport { showMassActorForm } from './multiConfig.js';\r\n\r\nexport const WithBaseMassEditForm = (cls) => {\r\n  class BaseMassEditForm extends cls {\r\n    constructor(doc, docs, options) {\r\n      if (options.massSelect) options.randomizerEnabled = false;\r\n      const documentName = options.documentName ?? getDocumentName(doc);\r\n      if (!options.commonData) options.commonData = getCommonDocData(docs, documentName);\r\n\r\n      BaseMassEditForm._setMEActions(options);\r\n\r\n      if (\r\n        foundry.utils.isNewerVersion(game.version, 12) &&\r\n        (documentName === 'AmbientSound' || documentName === 'AmbientLight' || documentName === 'Region')\r\n      ) {\r\n        options.document = doc;\r\n        super(options);\r\n      } else {\r\n        super(doc, options);\r\n      }\r\n\r\n      this.meObjects = docs;\r\n      this.documentName = documentName;\r\n      this.commonData = foundry.utils.flattenObject(options.commonData || {});\r\n      this.randomizerEnabled = options.massEdit;\r\n      this.randomizeFields = {};\r\n      this.addSubtractFields = {};\r\n      this.meForm = true;\r\n      this.rangeSpanToTextbox = game.settings.get(MODULE_ID, 'rangeToTextbox');\r\n    }\r\n\r\n    get baseDocument() {\r\n      throw Error('The getBaseDocument() method must be defined by a subclass.');\r\n    }\r\n\r\n    get title() {\r\n      if (this.options.massSelect) return localFormat('form.mass-search-title', { document: this.documentName });\r\n      return localFormat('form.mass-edit-title', { document: this.documentName, count: this.meObjects.length });\r\n    }\r\n\r\n    /**\r\n     * Form Submit\r\n     * @param {*} event\r\n     * @param {*} formData\r\n     * @returns\r\n     */\r\n    static async massUpdateObject(event, control) {\r\n      control = $(control);\r\n      if (!control.data('action')) return;\r\n\r\n      // Gather up all named fields that have mass-edit-checkbox checked\r\n      const selectedFields = this.getSelectedFields();\r\n\r\n      // Detection modes may have been selected out of order\r\n      // Fix that here\r\n      if (this.documentName === 'Token') {\r\n        TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n      }\r\n\r\n      // Preset editing\r\n      if (this.options.presetEdit) {\r\n        this.options.callback?.({\r\n          data: selectedFields,\r\n          addSubtract: this.addSubtractFields,\r\n          randomize: this.randomizeFields,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Search and Select mode\r\n      if (this.options.massSelect) {\r\n        return performMassSearch(control.data('action'), this.documentName, selectedFields, {\r\n          scope: this.modUpdate ? this.modUpdateType : null,\r\n        });\r\n      } else {\r\n        // Edit mode\r\n        return performMassUpdate.call(this, selectedFields, this.meObjects, this.documentName, control.data('action'));\r\n      }\r\n    }\r\n\r\n    getSelectedFields(formData) {\r\n      if (!formData) formData = this._getSubmitData();\r\n\r\n      // Some module flags get un-flattened\r\n      // Flatten them again before attempting to find selected\r\n      formData = foundry.utils.flattenObject(formData);\r\n\r\n      // Modules Specific Logic\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in formData) {\r\n        formData['flags.levels-3d-preview.shaders'] = this.baseDocument.getFlag('levels-3d-preview', 'shaders');\r\n      }\r\n      // == End of Module specific logic\r\n\r\n      // Token _getSubmitData() performs conversions related to scale, we need to undo them here\r\n      // so that named fields on the form match up and can be selected\r\n      if (this.documentName === 'Token') {\r\n        if (formData['texture.scaleX']) {\r\n          formData.scale = Math.abs(formData['texture.scaleX']);\r\n          formData.mirrorX = formData['texture.scaleX'] < 0;\r\n          formData.mirrorY = formData['texture.scaleY'] < 0;\r\n        }\r\n      } else if (this.documentName === 'Note') {\r\n        if (formData['texture.src']) {\r\n          formData['icon.selected'] = formData['texture.src'];\r\n          formData['icon.custom'] = formData['texture.src'];\r\n        }\r\n      }\r\n\r\n      const selectedFields = {};\r\n      const html = $(this.element);\r\n      const addSubtractFields = this.addSubtractFields;\r\n      const app = this;\r\n\r\n      html.find('.form-group').each(function (_) {\r\n        const me_checkbox = $(this).find('.mass-edit-checkbox > input');\r\n        if (me_checkbox.length && me_checkbox.is(':checked')) {\r\n          $(this)\r\n            .find('[name]')\r\n            .each(function (_) {\r\n              const name = $(this).attr('name');\r\n\r\n              // Module specific logic\r\n              if (name === 'flags.limits') {\r\n                const limits = foundry.utils.flattenObject(app.meObjects[0].toObject().flags['limits'] ?? {});\r\n                for (const [k, v] of Object.entries(limits)) {\r\n                  selectedFields['flags.limits.' + k] = v;\r\n                }\r\n              }\r\n              // == End of Module specific logic\r\n\r\n              // Some modules will process their flags to remove them using -= notation\r\n              // Need to account for this when selecting fields\r\n              if (formData[name] === undefined && name.startsWith('flags.')) {\r\n                const removeFlag = hasFlagRemove(name, formData);\r\n                if (removeFlag) {\r\n                  selectedFields[removeFlag] = null;\r\n                }\r\n              } else {\r\n                selectedFields[name] = formData[name];\r\n                if (name in addSubtractFields) {\r\n                  addSubtractFields[name].value = formData[name];\r\n                }\r\n              }\r\n\r\n              if (foundry.utils.getType(selectedFields[name]) === 'string') {\r\n                const input = $(this);\r\n                if (input.hasClass('tva-array')) {\r\n                  if (v.trim()) {\r\n                    selectedFields[name] = selectedFields[name]\r\n                      .trim()\r\n                      .split(',')\r\n                      .map((s) => s.trim());\r\n                  } else {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                } else if (input.hasClass('tva-jsonArray')) {\r\n                  try {\r\n                    selectedFields[name] = JSON.parse(selectedFields[name]);\r\n                  } catch (e) {\r\n                    selectedFields[name] = [];\r\n                  }\r\n                }\r\n              }\r\n            });\r\n        }\r\n      });\r\n\r\n      return selectedFields;\r\n    }\r\n\r\n    /**\r\n     * Copy currently selected field to the clipboard\r\n     */\r\n    performMassCopy({ command = '', selectedFields = null } = {}) {\r\n      if (!selectedFields) {\r\n        selectedFields = this.getSelectedFields();\r\n        if (this.documentName === 'Token') {\r\n          TokenDataAdapter.correctDetectionModeOrder(selectedFields, this.randomizeFields);\r\n        }\r\n      }\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return false;\r\n\r\n      const preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: selectedFields,\r\n        randomize: this.randomizeFields,\r\n        addSubtract: this.addSubtractFields,\r\n      });\r\n      copyToClipboard(preset, command, this.isPrototype);\r\n      return true;\r\n    }\r\n\r\n    /**\r\n     * Control button style\r\n     * @param {*} html\r\n     */\r\n    _setStyle(html) {\r\n      const [styleName, css] = getInUseStyle();\r\n      html.prepend(`<style>${css}</style>`);\r\n    }\r\n\r\n    _injectGlobalDeleteButton(html) {\r\n      if (!(SUPPORTED_PLACEABLES.includes(this.documentName) || SUPPORTED_COLLECTIONS.includes(this.documentName)))\r\n        return;\r\n\r\n      const control = $(\r\n        `<div class=\"me-global-delete\"><a title=\"${localize(\r\n          'form.global-delete-title'\r\n        )}\"><i class=\"far fa-times-octagon fa-2x\"></i></a></div>`\r\n      );\r\n      control.click((event) => {\r\n        new Dialog({\r\n          title: 'Confirm',\r\n          content: `\r\n                <h2 style=\"color: red; text-align: center;\">${localFormat('form.delete-warning', {\r\n                  count: this.meObjects.length,\r\n                  document: this.documentName,\r\n                })}</h2>\r\n                <p>${localize('form.proceed')}</p>`,\r\n          buttons: {\r\n            buttonA: {\r\n              label: localize('Yes', false),\r\n              callback: () => {\r\n                this.meObjects.forEach((obj) => {\r\n                  let doc = obj.document ?? obj;\r\n                  if (doc.delete) doc.delete();\r\n                });\r\n                this.close();\r\n              },\r\n            },\r\n            no: {\r\n              label: localize('No', false),\r\n            },\r\n          },\r\n          default: 'buttonA',\r\n        }).render(true);\r\n      });\r\n      html.closest('form').append(control);\r\n    }\r\n\r\n    _activateAutoSelectListeners(html) {\r\n      // On any field being changed we want to automatically select the form-group to be included in the update\r\n      html.on(\r\n        'input',\r\n        'textarea, input[type=\"text\"], input[type=\"number\"], range-picker, color-picker',\r\n        onInputChange.bind(this)\r\n      );\r\n      html.on('change', 'textarea, input, select', onInputChange.bind(this));\r\n      html.on('paste', 'input', onInputChange.bind(this));\r\n      html.on('click', 'button', onInputChange.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Add Mass Edit controls to a .form-group\r\n     * @param {*} formGroup\r\n     * @param {*} typeOverride\r\n     * @returns\r\n     */\r\n    _processFormGroup(formGroup, typeOverride = null) {\r\n      // We only want to attach extra controls if the form-group contains named fields\r\n      if (!$(formGroup).find('[name]').length) return;\r\n      // Return if a checkbox is already inserted\r\n      if ($(formGroup).find('.mass-edit-checkbox').length) return;\r\n      // if ($(formGroup).find('[name]:disabled').length) return;\r\n\r\n      const commonData = this.commonData;\r\n      const rangeSpanToTextbox = this.rangeSpanToTextbox;\r\n      const insertRNGControl = this.randomizerEnabled;\r\n\r\n      // Check if fields within this form-group are part of common data or control a flag\r\n      let fieldType = 'meCommon';\r\n      if (commonData) {\r\n        $(formGroup)\r\n          .find('[name]')\r\n          .each(function () {\r\n            const name = $(this).attr('name');\r\n\r\n            if (rangeSpanToTextbox && $(this).attr('type') === 'range') {\r\n              const span = $(formGroup).find('span.range-value');\r\n              if (span.length) {\r\n                span.replaceWith(\r\n                  $(\r\n                    `<input name=\"${name}\" class=\"range-value\" type=\"number\" step=\"any\" value=\"${this.defaultValue}\" min=\"${this.min}\" max=\"${this.max}\"></input>`\r\n                  )\r\n                );\r\n                $(this).removeAttr('name');\r\n              }\r\n            }\r\n\r\n            if (name.startsWith('flags.')) {\r\n              fieldType = 'meFlag';\r\n            } else if (!(name in commonData)) {\r\n              // We want to ignore certain fields from commonData checks e.g. light invert-radius\r\n\r\n              if (name === 'invert-radius') {\r\n              } else {\r\n                fieldType = 'meDiff';\r\n              }\r\n            }\r\n          });\r\n      }\r\n\r\n      // Add randomizer controls\r\n      let randomControl = '';\r\n      if (insertRNGControl) {\r\n        randomControl = '<div class=\"mass-edit-randomize\"></div>';\r\n      }\r\n\r\n      fieldType = typeOverride ?? fieldType;\r\n\r\n      // Insert the checkbox\r\n      const checkbox = $(\r\n        `<div class=\"mass-edit-checkbox ${fieldType}\">${randomControl}<input class=\"mass-edit-control\" type=\"checkbox\" data-dtype=\"Boolean\"}></div>`\r\n      );\r\n      if ($(formGroup).find('p.hint, p.notes').length) {\r\n        $(formGroup).find('p.hint, p.notes').first().before(checkbox);\r\n      } else {\r\n        $(formGroup).append(checkbox);\r\n      }\r\n\r\n      // Assign field type to the form group. Will be used to set appropriate visual look\r\n      $(formGroup).addClass(fieldType);\r\n    }\r\n\r\n    /**\r\n     * Add Mass Edit control for all .form-group's within the html\r\n     * @param {*} html\r\n     */\r\n    _processAllFormGroups(html) {\r\n      const processFormGroup = this._processFormGroup.bind(this);\r\n      // Add checkboxes to each form-group to control highlighting and which fields are to be saved\r\n      html.find('.form-group').each(function (_) {\r\n        processFormGroup(this);\r\n      });\r\n    }\r\n\r\n    async _processPreset(preset) {\r\n      // This will be called when a preset item is selected or JSON data is being directly applied\r\n      // The code bellow handles it being applied to the current form\r\n\r\n      // =====================\r\n      // Module specific logic\r\n      // =====================\r\n      let timeoutRequired = false;\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n      // Monk's Active Tiles\r\n      if ('flags.monks-active-tiles.actions' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.setFlag('monks-active-tiles', 'actions', data['flags.monks-active-tiles.actions']);\r\n      }\r\n\r\n      if ('flags.monks-active-tiles.files' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.setFlag('monks-active-tiles', 'files', data['flags.monks-active-tiles.files']);\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ('flags.levels-3d-preview.shaders' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.setFlag('levels-3d-preview', 'shaders', data['flags.levels-3d-preview.shaders']);\r\n      }\r\n\r\n      // Limits\r\n      if ('flags.limits.light.enabled' in data) {\r\n        timeoutRequired = true;\r\n        await this.baseDocument.update({ flags: { limits: foundry.utils.expandObject(data).flags.limits } });\r\n      }\r\n\r\n      if (this.documentName === 'Token') {\r\n        timeoutRequired = TokenDataAdapter.modifyPresetData(this, data);\r\n      }\r\n\r\n      if (timeoutRequired) {\r\n        setTimeout(() => {\r\n          this._applyPreset(preset);\r\n        }, 250);\r\n        return;\r\n      }\r\n\r\n      this._applyPreset(preset);\r\n    }\r\n\r\n    /**\r\n     * Apply preset to the form\r\n     * @param {Preset} preset\r\n     */\r\n    _applyPreset(preset) {\r\n      const form = $(this.form ?? this.element);\r\n\r\n      const customMerge = (obj1, obj2) => {\r\n        if (!obj2) return obj1;\r\n        for (const [k, v] of Object.entries(obj2)) {\r\n          obj1[k] = v;\r\n        }\r\n        return obj1;\r\n      };\r\n\r\n      this.randomizeFields = customMerge(this.randomizeFields, preset.randomize);\r\n      this.addSubtractFields = customMerge(this.addSubtractFields, preset.addSubtract);\r\n      selectRandomizerFields(form, this.randomizeFields);\r\n      selectAddSubtractFields(form, this.addSubtractFields);\r\n\r\n      const data = foundry.utils.flattenObject(preset.data[0]);\r\n      GeneralDataAdapter.dataToForm(this.documentName, preset.data[0], data);\r\n      for (const key of Object.keys(data)) {\r\n        const el = form.find(`[name=\"${key}\"]`);\r\n        if (el.is(':checkbox')) {\r\n          el.prop('checked', data[key]);\r\n        } else {\r\n          el.val(data[key]);\r\n          // Elements such as FilePicker contain the name, but the actual input is a child element\r\n          el.find('input').val(data[key]).trigger('change');\r\n        }\r\n        el.trigger('change');\r\n      }\r\n\r\n      // Make brush aware of randomized field changes\r\n      Brush.refreshPreset();\r\n    }\r\n\r\n    _registerRandomizerListeners(html) {\r\n      const context = this;\r\n      if (this.randomizerEnabled) {\r\n        html.on('contextmenu', '.mass-edit-checkbox', (event) => {\r\n          import('../scripts/randomizer/randomizerForm.js').then((module) => {\r\n            module.showRandomizeDialog($(event.target).closest('.form-group'), context);\r\n          });\r\n        });\r\n      }\r\n    }\r\n\r\n    // We want to update fields used by brush control every time a field changes on the form\r\n    _registerBrushRefreshListeners(html) {\r\n      html.on('input', 'textarea, input[type=\"text\"], input[type=\"number\"]', () => Brush.refreshPreset());\r\n      html.on('change', 'textarea, input, select', () => Brush.refreshPreset());\r\n      html.on('paste', 'input', () => Brush.refreshPreset());\r\n      html.on('click', 'button', () => Brush.refreshPreset());\r\n    }\r\n\r\n    _registerNumericalInputListeners(html) {\r\n      html.on(\r\n        'contextmenu',\r\n        'input[type=range], input[type=number], input[name=\"flags.tagger.tags\"], input[type=\"text\"], input[name=\"tokenmagic.preset\"]',\r\n        (event) => {\r\n          const name = event.target.name;\r\n          if (!name) return;\r\n\r\n          const input = $(event.target);\r\n          if (name in this.addSubtractFields) {\r\n            if (this.addSubtractFields[name].method === 'add') {\r\n              this.addSubtractFields[name].method = 'subtract';\r\n              input.removeClass('me-add').addClass('me-subtract');\r\n              input.attr('title', '- Subtracting');\r\n              const ctrl = { method: 'subtract' };\r\n              if (event.target.min) {\r\n                ctrl.min = parseFloat(event.target.min);\r\n              }\r\n              ctrl.type = input.attr('type');\r\n              this.addSubtractFields[name] = ctrl;\r\n            } else {\r\n              delete this.addSubtractFields[name];\r\n              input.removeClass('me-subtract');\r\n              input.attr('title', '');\r\n            }\r\n          } else {\r\n            input.addClass('me-add');\r\n            input.attr('title', '+ Adding');\r\n            const ctrl = { method: 'add' };\r\n            if (event.target.max) {\r\n              ctrl.max = parseFloat(event.target.max);\r\n            }\r\n            ctrl.type = input.attr('type');\r\n            this.addSubtractFields[name] = ctrl;\r\n          }\r\n\r\n          // Select nearest mass edit checkbox\r\n          onInputChange(event);\r\n\r\n          // Make brush aware of add/subtract changes\r\n          Brush.refreshPreset();\r\n        }\r\n      );\r\n    }\r\n\r\n    _registerInputChangeCallback(html) {\r\n      if (this.options.inputChangeCallback) {\r\n        html.on('change', 'input, select', async (event) => {\r\n          setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n        });\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Toggle all ME checkboxes on/off when right-clicking tabs\r\n     * @param {*} html\r\n     */\r\n    _registerNavigationTabMassSelect(html) {\r\n      // Select/Deselect all Mass Edit checkboxes when right-clicking the navigation tabs\r\n      html.on('contextmenu', 'nav > .item', (event) => {\r\n        const tab = event.target.dataset?.tab;\r\n        if (tab) {\r\n          const group = $(event.target).closest('nav').attr('data-group');\r\n          let meCheckboxes;\r\n          if (group) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(\r\n                `.tab[data-tab=\"${tab}\"][data-group=\"${group}\"], .matt-tab[data-tab=\"${tab}\"][data-group=\"${group}\"]`\r\n              )\r\n              .find('.mass-edit-control');\r\n          }\r\n          if (!meCheckboxes || meCheckboxes.length === 0) {\r\n            meCheckboxes = $(event.target)\r\n              .closest('form')\r\n              .find(`.tab[data-tab=\"${tab}\"], .matt-tab[data-tab=\"${tab}\"]`)\r\n              .find('.mass-edit-control');\r\n          }\r\n\r\n          let selecting = true;\r\n\r\n          if (meCheckboxes.not(':checked').length === 0) {\r\n            selecting = false;\r\n          }\r\n          meCheckboxes.prop('checked', selecting);\r\n\r\n          // Select/Deselect tabs\r\n          meCheckboxes.each(function () {\r\n            if (selecting) selectTabs(this);\r\n            else deselectTabs(this);\r\n          });\r\n\r\n          // Trigger change on one of the checkboxes to initiate processes that respond to them\r\n          // being toggled\r\n          meCheckboxes.first().trigger('change');\r\n        }\r\n      });\r\n    }\r\n\r\n    _insertModuleSpecificFields(html) {\r\n      // Monk's Active Tiles\r\n      if (this.documentName === 'Tile' && this._createAction) {\r\n        let chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>Mass Edit: ${localize(`form.actions`)}</label>\r\n                <div class=\"form-fields\">\r\n                    <input type=\"hidden\" name=\"flags.monks-active-tiles.actions\">\r\n                </div>\r\n              `);\r\n        $(html).find('.matt-tab[data-tab=\"trigger-actions\"]').prepend(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n\r\n        chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>Mass Edit: ${localize(`form.images`)}</label>\r\n                <div class=\"form-fields\">\r\n                    <input type=\"hidden\" name=\"flags.monks-active-tiles.files\">\r\n                </div>\r\n              `);\r\n        chk.insertBefore('.matt-tab[data-tab=\"trigger-images\"] .files-list');\r\n        this._processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      // 3D Canvas\r\n      if ((this.documentName === 'Tile' || this.documentName === 'Token') && game.Levels3DPreview) {\r\n        let chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>Mass Edit: ${localize(`form.shaders`)}</label>\r\n                <div class=\"form-fields\">\r\n                    <input type=\"hidden\" name=\"flags.levels-3d-preview.shaders\">\r\n                </div>\r\n              `);\r\n        $(html).find('#shader-config').after(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n      }\r\n    }\r\n\r\n    _insertSpecialFields(html) {\r\n      // // Token Magic FX\r\n      if (\r\n        (this.documentName === 'Tile' || this.documentName === 'Token') &&\r\n        !this.options?.simplified &&\r\n        game.modules.get('tokenmagic')?.active &&\r\n        game.settings.get(MODULE_ID, 'tmfxFieldsEnable')\r\n      ) {\r\n        let content = '<datalist id=\"tmfxPresets\"><option value=\"DELETE ALL\">';\r\n        TokenMagic.getPresets().forEach((p) => (content += `<option value=\"${p.name}\">`));\r\n        content += `</datalist><input list=\"tmfxPresets\" name=\"tokenmagic.preset\">`;\r\n\r\n        let chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>${localize('common.preset')} <span class=\"units\">(TMFX)</span></label>\r\n                <div class=\"form-fields\">\r\n                  ${content}\r\n                </div>\r\n              `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n\r\n        const currentDDTint = getDDTint(this.baseDocument.object ?? this.baseDocument);\r\n        chk = $(`\r\n              <div class=\"form-group\">\r\n                <label>DungeonDraft <span class=\"units\">(TMFX)</span></label>\r\n                <div class=\"form-fields\">\r\n                  <input class=\"color\" type=\"text\" name=\"tokenmagic.ddTint\" value=\"${currentDDTint}\">\r\n                  <input type=\"color\" value=\"${currentDDTint}\" data-edit=\"tokenmagic.ddTint\">\r\n                </div>\r\n              `);\r\n        $(html).find('[name=\"texture.tint\"]').closest('.form-group').after(chk);\r\n        this._processFormGroup(chk, 'meInsert');\r\n      }\r\n\r\n      // Tile scale\r\n      if (this.documentName === 'Tile') {\r\n        let scaleInput = $(`\r\n            <div class=\"form-group slim\">\r\n              <label>${localize('Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n              <div class=\"form-fields\">\r\n                <label>${localize('Width', false)} | ${localize('Height', false)} ${\r\n          game.Levels3DPreview?._active ? '| Depth' : ''\r\n        }</label>\r\n                <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.scale\" min=\"0\">\r\n              </div>\r\n            </div>`);\r\n        $(html).find('[name=\"width\"]').closest('.form-group').before(scaleInput);\r\n        this._processFormGroup(scaleInput, 'meInsert');\r\n\r\n        scaleInput = $(`\r\n              <div class=\"form-group slim\">\r\n                <label>${localize('TILE.Scale', false)} <span class=\"units\">(${localize('common.ratio')})</span></label>\r\n                <div class=\"form-fields\">\r\n                  <label>${localize('TILE.ScaleX', false)} | ${localize('TILE.ScaleY', false)}</label>\r\n                  <input type=\"number\" value=\"1\" step=\"any\" name=\"massedit.texture.scale\" min=\"0\">\r\n                </div>\r\n              </div>`);\r\n        $(html).find('[name=\"texture.scaleX\"]').closest('.form-group').before(scaleInput);\r\n        this._processFormGroup(scaleInput, 'meInsert');\r\n      }\r\n\r\n      if (this.documentName === 'AmbientLight') {\r\n        const hiddenInput = $(`\r\n          <div class=\"form-group\">\r\n            <label>Hidden</label>\r\n            <div class=\"form-fields\">\r\n              <input type=\"checkbox\" name=\"hidden\" >\r\n            </div>\r\n          </div>\r\n        `);\r\n        $(html).find('[name=\"config.shadows\"]').closest('.form-group').after(hiddenInput);\r\n        this._processFormGroup(hiddenInput, 'meInsert');\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Insert button to toggle auto-update on form changes\r\n     * @param {*} html\r\n     */\r\n    _insertModUpdateCheckboxes(html) {\r\n      if (this.options.massEdit && !this.options.simplified && !this.options.presetEdit) {\r\n        const app = this;\r\n        const preSelectAutoApply = game.settings.get(MODULE_ID, 'preSelectAutoApply');\r\n        html.find('button[type=\"submit\"]').each(function (index) {\r\n          const button = $(this);\r\n          const modButton = $(\r\n            `<div class=\"me-mod-update\" title=\"${localize(\r\n              `form.immediate-update-title`\r\n            )}\"><input type=\"checkbox\" data-submit=\"${button.data('action')}\"><i class=\"fas fa-cogs\"></i></div>`\r\n          );\r\n          modButton.on('change', (event) => {\r\n            event.stopPropagation();\r\n            const isChecked = event.target.checked;\r\n            html.find('.me-mod-update > input').not(this).prop('checked', false);\r\n            $(event.target).prop('checked', isChecked);\r\n            app.modUpdate = isChecked;\r\n            app.modUpdateType = $(event.target).data('submit');\r\n          });\r\n\r\n          if (index === 0 && preSelectAutoApply) {\r\n            modButton.find('input[type=\"checkbox\"]').prop('checked', true).trigger('change');\r\n          }\r\n\r\n          modButton.insertAfter(button);\r\n        });\r\n      }\r\n    }\r\n\r\n    _performOnInputChangeUpdate() {\r\n      const selectedFields = this.getSelectedFields();\r\n      performMassUpdate.call(this, selectedFields, this.meObjects, this.documentName, this.modUpdateType);\r\n    }\r\n\r\n    _registerMutateObserver(html) {\r\n      // TokenConfig might be changed by some modules after activateListeners is processed\r\n      // Look out for these updates and add checkboxes for any newly added form-groups\r\n      const processFormGroup = this._processFormGroup.bind(this);\r\n      const mutate = (mutations) => {\r\n        mutations.forEach((mutation) => {\r\n          mutation.addedNodes.forEach((node) => {\r\n            if ($(node).hasClass('form-group')) {\r\n              processFormGroup(node);\r\n            } else {\r\n              $(node)\r\n                .find('.form-group')\r\n                .each(function () {\r\n                  if (!$(this).find('.mass-edit-checkbox').length) {\r\n                    processFormGroup(this);\r\n                  }\r\n                });\r\n            }\r\n          });\r\n        });\r\n      };\r\n\r\n      const observer = new MutationObserver(mutate);\r\n      observer.observe(html[0], {\r\n        characterData: false,\r\n        attributes: false,\r\n        childList: true,\r\n        subtree: true,\r\n      });\r\n    }\r\n\r\n    _onClose(options = {}) {\r\n      options.force = true;\r\n      Brush.deactivate();\r\n      if (this.linkedPresetForm) this.linkedPresetForm.close();\r\n      return super._onClose?.(options);\r\n    }\r\n\r\n    /**\r\n     * ===== ACTIONS ======\r\n     */\r\n\r\n    /**\r\n     * Macro Generator\r\n     */\r\n    static _openMacroForm() {\r\n      const selectedFields = this.getSelectedFields();\r\n      new MacroForm(\r\n        this.baseDocument,\r\n        this.meObjects,\r\n        this.documentName,\r\n        selectedFields,\r\n        this.randomizeFields,\r\n        this.addSubtractFields\r\n      ).render(true);\r\n    }\r\n\r\n    /**\r\n     * Brush Tool\r\n     */\r\n    static _activateBrushTool() {\r\n      Brush.activate({ app: this });\r\n    }\r\n\r\n    /**\r\n     * Token, Note, and Actor permission editing\r\n     */\r\n    static _openEditPermissions() {\r\n      let docs = [];\r\n      const ids = new Set();\r\n      for (const p of this.meObjects) {\r\n        let d;\r\n        if (this.documentName === 'Actor' || this.documentName === 'JournalEntry') d = p;\r\n        else if (this.documentName === 'Token' && p.actor) d = p.actor;\r\n        else if (this.documentName === 'Note' && p.entry) d = p.entry;\r\n\r\n        // Only retain unique docs\r\n        if (d && !ids.has(d.id)) {\r\n          docs.push(d);\r\n          ids.add(d.id);\r\n        }\r\n      }\r\n\r\n      let MP = WithMassPermissions();\r\n      new MP(docs[0], docs).render(true);\r\n    }\r\n\r\n    /**\r\n     * Open Preset browser with a relationship to this app\r\n     */\r\n    static _openPresetBrowser() {\r\n      this.linkedPresetForm = new PresetBrowser(this, null, this.documentName, {\r\n        left: this.position.left - 370,\r\n        top: this.position.top,\r\n        preventPositionOverride: true,\r\n      });\r\n      this.linkedPresetForm.render(true);\r\n    }\r\n\r\n    /**\r\n     * View currently selected fields as JSON and/or apply JSON to the current form\r\n     */\r\n    static _openViewApplyJSON() {\r\n      let selFields = foundry.utils.expandObject(this.getSelectedFields());\r\n      if (foundry.utils.isEmpty(selFields)) selFields = '';\r\n      else selFields = JSON.stringify(selFields, null, 2);\r\n      let content = `<textarea class=\"json\" style=\"width:100%; height: 300px;\">${selFields}</textarea>`;\r\n      new Dialog({\r\n        title: localize('form.apply-json'),\r\n        content: content,\r\n        buttons: {\r\n          apply: {\r\n            label: localize('common.apply'),\r\n            callback: (html) => {\r\n              let json = {};\r\n              try {\r\n                json = JSON.parse(html.find('.json').val());\r\n              } catch (e) {\r\n                console.log(e);\r\n              }\r\n\r\n              if (!foundry.utils.isEmpty(json)) {\r\n                const preset = new Preset({\r\n                  documentName: this.documentName,\r\n                  data: [json],\r\n                });\r\n                this._processPreset(preset);\r\n              }\r\n            },\r\n          },\r\n        },\r\n      }).render(true);\r\n    }\r\n\r\n    static _showMassActorForm() {\r\n      if (\r\n        showMassActorForm(this.meObjects, {\r\n          massEdit: this.options.massEdit,\r\n        })\r\n      ) {\r\n        this.close();\r\n      }\r\n    }\r\n\r\n    static _setMEActions(options) {\r\n      const actions = options.action ?? {};\r\n      actions.meMacroGen = this._openMacroForm;\r\n      actions.meBrush = this._activateBrushTool;\r\n      actions.meEditPermissions = this._openEditPermissions;\r\n      actions.mePresetBrowser = this._openPresetBrowser;\r\n      actions.meJSON = this._openViewApplyJSON;\r\n      actions.meTokenActor = this._showMassActorForm;\r\n      [\r\n        'meSearch',\r\n        'meSearchAndEdit',\r\n        'meApplyCurrentScene',\r\n        'meApplyAllScenes',\r\n        'meApply',\r\n        'meApplyToPrototype',\r\n      ].forEach((action) => {\r\n        actions[action] = this.massUpdateObject;\r\n      });\r\n      options.actions = actions;\r\n      foundry.utils.setProperty(options, 'form.handler', () => {});\r\n    }\r\n\r\n    _meGetSubmitButtons() {\r\n      // Add submit buttons\r\n      const buttons = [];\r\n\r\n      if (this.options.massSelect) {\r\n        buttons.push({\r\n          type: 'submit',\r\n          icon: 'fas fa-search',\r\n          label: localize('FILES.Search', false),\r\n          action: 'meSearch',\r\n        });\r\n        buttons.push({\r\n          type: 'submit',\r\n          icon: 'fas fa-search',\r\n          label: localize('form.search-and-edit'),\r\n          action: 'meSearchAndEdit',\r\n        });\r\n      } else if (this.documentName === 'Note' && !this.options.presetEdit) {\r\n        // If we're editing notes and there are some on a different scene\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id === canvas.scene.id).length) {\r\n          buttons.push({\r\n            type: 'submit',\r\n            icon: 'far fa-save',\r\n            label: localize('form.apply-on-current-scene'),\r\n            action: 'meApplyCurrentScene',\r\n          });\r\n        }\r\n\r\n        if (this.meObjects.filter((n) => (n.scene ?? n.parent).id !== canvas.scene.id).length) {\r\n          buttons.push({\r\n            type: 'submit',\r\n            label: localize('form.apply-on-all-scenes'),\r\n            icon: 'fas fa-globe',\r\n            action: 'meApplyAllScenes',\r\n          });\r\n        }\r\n      } else {\r\n        buttons.push({\r\n          type: 'submit',\r\n          label: localize('common.apply'),\r\n          icon: 'far fa-save',\r\n          action: 'meApply',\r\n        });\r\n\r\n        // Extra control for Tokens to update their Actors Token prototype\r\n        if (\r\n          this.documentName === 'Token' &&\r\n          !this.options.simplified &&\r\n          !this.meObjects[0].constructor?.name?.startsWith('PrototypeToken') &&\r\n          !this.options.presetEdit\r\n        ) {\r\n          buttons.push({\r\n            type: 'submit',\r\n            label: localize('form.apply-update-proto'),\r\n            icon: 'far fa-save',\r\n            action: 'meApplyToPrototype',\r\n          });\r\n        }\r\n      }\r\n\r\n      return buttons;\r\n    }\r\n\r\n    _getMeControls() {\r\n      const controls = [\r\n        {\r\n          label: 'Generate Macro',\r\n          class: 'mass-edit-macro',\r\n          icon: 'fas fa-terminal',\r\n          action: 'meMacroGen',\r\n          visible:\r\n            SUPPORTED_PLACEABLES.includes(this.documentName) || SUPPORTED_COLLECTIONS.includes(this.documentName),\r\n        },\r\n        {\r\n          label: 'Brush',\r\n          class: 'mass-edit-brush',\r\n          icon: 'fas fa-paint-brush',\r\n          action: 'meBrush',\r\n          visible: SUPPORTED_PLACEABLES.includes(this.documentName),\r\n        },\r\n        {\r\n          label: 'Permissions',\r\n          class: 'mass-edit-permissions',\r\n          icon: 'fas fa-lock fa-fw',\r\n          action: 'meEditPermissions',\r\n          visible: ['Token', 'Note', 'Actor'].includes(this.documentName),\r\n        },\r\n        {\r\n          label: 'Presets',\r\n          class: 'mass-edit-presets',\r\n          icon: 'fas fa-box',\r\n          action: 'mePresetBrowser',\r\n          visible: !this.options.simplified,\r\n        },\r\n        {\r\n          label: 'JSON',\r\n          class: 'mass-edit-apply',\r\n          icon: 'far fa-money-check-edit',\r\n          action: 'meJSON',\r\n          visible: true,\r\n        },\r\n        {\r\n          label: 'Switch',\r\n          class: 'mass-edit-actors',\r\n          icon: 'fas fa-user',\r\n          action: 'meTokenActor',\r\n          visible: this.documentName === 'Token' && this.meObjects.filter((t) => t.actor).length,\r\n        },\r\n      ];\r\n      return controls;\r\n    }\r\n  }\r\n  return BaseMassEditForm;\r\n};\r\n\r\nexport const WithMassEditFormApplicationV2 = (cls) => {\r\n  class MassEditForm extends cls {\r\n    _attachFrameListeners() {\r\n      super._attachFrameListeners();\r\n    }\r\n\r\n    _onRender() {\r\n      super._onRender();\r\n      injectVisibility(this);\r\n\r\n      const html = $(this.element);\r\n      this._injectGlobalDeleteButton(html);\r\n      this._setStyle(html);\r\n      this._activateAutoSelectListeners(html);\r\n      this._processAllFormGroups(html);\r\n      this._registerRandomizerListeners(html);\r\n      this._registerBrushRefreshListeners(html);\r\n      this._registerNumericalInputListeners(html);\r\n      this._registerInputChangeCallback(html);\r\n      this._registerNavigationTabMassSelect(html);\r\n      this._insertModUpdateCheckboxes(html);\r\n      this._insertModuleSpecificFields(html);\r\n      this._insertSpecialFields(html);\r\n      this._registerMutateObserver(html);\r\n    }\r\n\r\n    get baseDocument() {\r\n      return this.document;\r\n    }\r\n\r\n    _getSubmitData() {\r\n      const form = this.element;\r\n      const formData = new FormDataExtended(form);\r\n      const submitData = this._prepareSubmitData(null, form, formData);\r\n      return submitData;\r\n    }\r\n\r\n    _getHeaderControls() {\r\n      return [].concat(super._getHeaderControls()).concat(this._getMeControls());\r\n    }\r\n\r\n    // Special handling for Regions to prevent insertion of submit buttons\r\n    async _preparePartContext(partId, context) {\r\n      if (partId !== 'footer') return super._preparePartContext(partId, context);\r\n      return context;\r\n    }\r\n\r\n    async _prepareContext(options) {\r\n      const context = await super._prepareContext(options);\r\n      context.buttons = (context.buttons ?? []).filter((b) => b.type !== 'submit');\r\n      context.buttons = context.buttons.concat(this._meGetSubmitButtons());\r\n      return context;\r\n    }\r\n\r\n    async render(options = {}, _options = {}) {\r\n      // Do not re-render the form if this is due to the document being updated\r\n      // This is to prevent ME checkboxes from being reset.\r\n      if (_options.renderContext?.startsWith('update')) return;\r\n      return super.render(options, _options);\r\n    }\r\n  }\r\n  return MassEditForm;\r\n};\r\n\r\nexport const WithMassEditFormApplication = (cls) => {\r\n  class MassEditForm extends cls {\r\n    async getData(options) {\r\n      // During Preset editing we will be editing AmbientLight document directly, which causes the preview to be set to null\r\n      // and Foundry complaining about being unable to read data from it. So we set the preview manually here\r\n      if (this.documentName === 'AmbientLight' && !this.preview) {\r\n        this.preview = this.baseDocument.clone();\r\n      }\r\n      const data = super.getData(options);\r\n      return data;\r\n    }\r\n\r\n    get baseDocument() {\r\n      return this.object;\r\n    }\r\n\r\n    // Add styles and controls to the sheet\r\n    async activateListeners(html) {\r\n      await super.activateListeners(html);\r\n      injectVisibility(this);\r\n      this._injectGlobalDeleteButton(html);\r\n      this._setStyle(html);\r\n      this._activateAutoSelectListeners(html);\r\n      this._processAllFormGroups(html);\r\n      this._registerRandomizerListeners(html);\r\n      this._registerBrushRefreshListeners(html);\r\n      this._registerNumericalInputListeners(html);\r\n      this._registerInputChangeCallback(html);\r\n      this._registerNavigationTabMassSelect(html);\r\n      this._removeFooterButtons(html);\r\n      this._insertSubmitButtons(html);\r\n      this._insertModUpdateCheckboxes(html);\r\n      this._insertModuleSpecificFields(html);\r\n      this._insertSpecialFields(html);\r\n      this._registerMutateObserver(html);\r\n\r\n      // Resizes the window\r\n      this.setPosition();\r\n      this.element[0].style.height = ''; // don't want a statically set height\r\n\r\n      if (this.documentName === 'Token') {\r\n        $(html)\r\n          .find('fieldset.detection-mode')\r\n          .each(function (_) {\r\n            $(this).wrap('<div class=\"form-group\"></div>');\r\n          });\r\n      }\r\n    }\r\n\r\n    _insertSubmitButtons(html) {\r\n      const buttons = this._meGetSubmitButtons();\r\n\r\n      // Add submit buttons\r\n      let htmlButtons = '';\r\n      if (!this._meSubmitInserted) {\r\n        this._meSubmitInserted = true;\r\n        for (const button of buttons) {\r\n          htmlButtons += `<button class=\"me-submit\" type=\"submit\" data-action=\"${button.action}\"><i class=\"${button.icon}\"></i> ${button.label}</button>`;\r\n        }\r\n        if (this.options.massSelect && SUPPORTED_PLACEABLES.includes(this.documentName)) {\r\n          htmlButtons += `<div class=\"me-mod-update\" title=\"${localize(\r\n            `form.global-search-title`\r\n          )}\"><input type=\"checkbox\" data-submit=\"world\"><i class=\"far fa-globe\"></i></div>`;\r\n        }\r\n\r\n        let footer = $(html).find('.sheet-footer').last();\r\n        if (footer.length) {\r\n          footer.append(htmlButtons);\r\n        } else {\r\n          footer = $(`<footer class=\"sheet-footer flexrow\">${htmlButtons}</footer>`);\r\n          $(html).closest('form').append(footer);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Overriding here to prevent the underlying object from being updated as inputs change on the form\r\n    // Relevant for AmbientLight, Tile, and Token sheets\r\n    async _onChangeInput(event) {\r\n      if (!['AmbientLight', 'Tile', 'Token'].includes(this.documentName)) {\r\n        super._onChangeInput(event);\r\n        return;\r\n      }\r\n\r\n      // // Handle form element updates\r\n      const el = event.target;\r\n      if (el.type === 'color' && el.dataset.edit) this._onChangeColorPicker(event);\r\n      else if (el.type === 'range') this._onChangeRange(event);\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      await this.options.actions.meApply.call(this, event, event.submitter);\r\n\r\n      // On v11 certain placeable will freeze the canvas layer if parent _updateObject is not called\r\n      if (['Token', 'AmbientLight'].includes(this.documentName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n    }\r\n\r\n    _getHeaderButtons() {\r\n      let buttons = super._getHeaderButtons().filter((b) => b.class !== 'configure-sheet');\r\n\r\n      const controls = foundry.utils.deepClone(this._getMeControls());\r\n      controls.forEach((ctrl) => {\r\n        ctrl.onclick = this.options.actions[ctrl.action].bind(this);\r\n        ctrl.label = '';\r\n      });\r\n\r\n      return controls.concat(buttons);\r\n    }\r\n\r\n    _removeFooterButtons(html) {\r\n      // Remove all buttons in the footer\r\n      html.find('.sheet-footer > button').remove();\r\n\r\n      // Special handling for Walls sheet\r\n      html.find('button[type=\"submit\"]').remove();\r\n    }\r\n\r\n    // Some forms will manipulate themselves via modifying internal objects and re-rendering\r\n    // In such cases we want to preserve the selected fields\r\n    render(force, options = {}) {\r\n      // If it's being re-rendered with an action \"update\" in means it's ClientDocumentMixin response to _onUpdate\r\n      // We can ignore these\r\n      if (options.action === 'update' || options.renderContext?.startsWith('update')) return;\r\n      // Form hasn't been rendered yet, aka first render pass, ignore it\r\n      if (!this.form) return super.render(force, options);\r\n\r\n      // Fetch the currently selected fields before re-rendering\r\n      const selectedFields = this.getSelectedFields();\r\n      const randomize = this.randomizeFields;\r\n      const addSubtract = this.addSubtractFields;\r\n\r\n      // Render, the selections will be wiped\r\n      super.render(force, options);\r\n\r\n      // Re-select fields, we're reusing preset functions here.\r\n      // Timeout require for this module including others to apply their\r\n      // modifications to the configuration window\r\n      setTimeout(() => {\r\n        if (this.form) {\r\n          this._applyPreset(\r\n            new Preset({\r\n              data: selectedFields,\r\n              randomize,\r\n              addSubtract,\r\n            })\r\n          );\r\n        }\r\n      }, 1000);\r\n    }\r\n\r\n    async close(options = {}) {\r\n      super._onClose(options);\r\n      if (['Token', 'AmbientLight'].includes(this.documentName) && this.preview?.object) {\r\n        this._resetPreview();\r\n      }\r\n      return super.close(options);\r\n    }\r\n  }\r\n\r\n  return MassEditForm;\r\n};\r\n","import { getData } from '../scripts/utils.js';\r\nimport { WithBaseMassEditForm, WithMassEditFormApplication, WithMassEditFormApplicationV2 } from './meApplication.js';\r\n\r\n// ==================================\r\n// ========= Applications ===========\r\n// ==================================\r\n\r\nexport const WithMassEditForm = (cls) => {\r\n  const base = WithBaseMassEditForm(cls);\r\n  if (foundry.applications?.api?.ApplicationV2 && cls.BASE_APPLICATION === foundry.applications.api.ApplicationV2) {\r\n    return WithMassEditFormApplicationV2(base);\r\n  } else {\r\n    return WithMassEditFormApplication(base);\r\n  }\r\n};\r\n\r\nexport const WithMassConfig = (documentName = 'NONE') => {\r\n  let cls;\r\n  const sheets = CONFIG[documentName]?.sheetClasses;\r\n  if (!sheets || documentName === 'Actor') {\r\n    cls = FormApplication;\r\n  } else {\r\n    cls = Object.values(Object.values(sheets).pop() ?? {}).pop()?.cls;\r\n  }\r\n\r\n  const MEF = WithMassEditForm(cls);\r\n\r\n  class MassConfig extends MEF {\r\n    constructor(target, docs, options) {\r\n      super(target.document ? target.document : target, docs, options);\r\n    }\r\n  }\r\n\r\n  const constructorName = `Mass${documentName}Config`;\r\n  Object.defineProperty(MassConfig.prototype.constructor, 'name', { value: constructorName });\r\n  return MassConfig;\r\n};\r\n\r\nexport const WithMassPermissions = () => {\r\n  let MEF = WithMassEditForm(DocumentOwnershipConfig);\r\n\r\n  class MassPermissions extends MEF {\r\n    constructor(target, docs, options = {}) {\r\n      // Generate common permissions\r\n      const data = getData(docs[0]);\r\n      const commonData = foundry.utils.flattenObject(data.ownership);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      // Permissions are only present if they differ from default, for simplicity simple add them before comparing\r\n      const addMissingPerms = function (perms) {\r\n        game.users.forEach((u) => {\r\n          if (!(u.id in perms)) perms[u.id] = metaLevels.DEFAULT;\r\n        });\r\n\r\n        if (!('default' in perms)) perms.default = metaLevels.DEFAULT;\r\n      };\r\n      addMissingPerms(commonData);\r\n\r\n      for (let i = 1; i < docs.length; i++) {\r\n        const data = getData(docs[i]);\r\n        const flatData = foundry.utils.flattenObject(data.ownership);\r\n        addMissingPerms(flatData);\r\n        const diff = foundry.utils.flattenObject(foundry.utils.diffObject(commonData, flatData));\r\n        for (const k of Object.keys(diff)) {\r\n          delete commonData[k];\r\n        }\r\n      }\r\n\r\n      options.commonData = commonData;\r\n      options.massPermissions = true;\r\n\r\n      super(target, docs, options);\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n      const selectedFields = this.getSelectedFields(formData);\r\n\r\n      const metaLevels = CONST.DOCUMENT_META_OWNERSHIP_LEVELS;\r\n\r\n      if (foundry.utils.isEmpty(selectedFields)) return;\r\n\r\n      const ids = new Set();\r\n      const updates = [];\r\n      for (const d of this.meObjects) {\r\n        if (!ids.has(d.id)) {\r\n          const data = getData(d);\r\n          const ownership = foundry.utils.deepClone(data.ownership);\r\n\r\n          for (let [user, level] of Object.entries(selectedFields)) {\r\n            if (level === metaLevels.DEFAULT) delete ownership[user];\r\n            else ownership[user] = level;\r\n          }\r\n\r\n          ids.add(d.id);\r\n          updates.push({ _id: d.id, ownership: ownership });\r\n        }\r\n      }\r\n\r\n      this.meObjects[0].constructor.updateDocuments(updates, {\r\n        diff: false,\r\n        recursive: false,\r\n        noHook: true,\r\n      });\r\n    }\r\n\r\n    get title() {\r\n      return `Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`;\r\n    }\r\n  }\r\n\r\n  return MassPermissions;\r\n};\r\n","export const CUSTOM_CONTROLS = {\r\n  field: {\r\n    shieldType: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '16',\r\n      step: '1',\r\n    },\r\n    scale: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    radius: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    intensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    lightAlpha: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    gridPadding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    lightSize: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    animated: {\r\n      time: {\r\n        speed: {\r\n          range: true,\r\n          min: '0',\r\n          max: '0.05',\r\n          step: '0.0001',\r\n        },\r\n      },\r\n    },\r\n  },\r\n  fire: {\r\n    fireBlend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n    animated: {\r\n      intensity: {\r\n        animType: {\r\n          select: true,\r\n          options: [\r\n            'syncChaoticOscillation',\r\n            'syncSinOscillation',\r\n            'syncCosOscillation',\r\n            'chaoticOscillation',\r\n            'halfSinOscillation',\r\n            'sinOscillation',\r\n            'halfCosOscillation',\r\n            'cosOscillation',\r\n            'syncColorOscillation',\r\n            'halfColorOscillation',\r\n            'colorOscillation',\r\n          ],\r\n        },\r\n        val2: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n        val1: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n        loopDuration: {\r\n          range: true,\r\n          min: '0',\r\n          max: '50000',\r\n          step: '100',\r\n        },\r\n      },\r\n      amplitude: {\r\n        animType: {\r\n          select: true,\r\n          options: [\r\n            'syncChaoticOscillation',\r\n            'syncSinOscillation',\r\n            'syncCosOscillation',\r\n            'chaoticOscillation',\r\n            'halfSinOscillation',\r\n            'sinOscillation',\r\n            'halfCosOscillation',\r\n            'cosOscillation',\r\n            'syncColorOscillation',\r\n            'halfColorOscillation',\r\n            'colorOscillation',\r\n          ],\r\n        },\r\n        loopDuration: {\r\n          range: true,\r\n          min: '0',\r\n          max: '50000',\r\n          step: '100',\r\n        },\r\n        val1: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n        val2: {\r\n          range: true,\r\n          min: '0',\r\n          max: '5',\r\n          step: '0.1',\r\n        },\r\n      },\r\n    },\r\n    intensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '100',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  electric: {\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '13',\r\n      step: '1',\r\n    },\r\n  },\r\n  xglow: {\r\n    auraType: {\r\n      range: true,\r\n      min: '0',\r\n      max: '2',\r\n      step: '1',\r\n    },\r\n    scale: {\r\n      range: true,\r\n      min: '0',\r\n      max: '30',\r\n      step: '0.1',\r\n    },\r\n    auraIntensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    subAuraIntensity: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    threshold: {\r\n      range: true,\r\n      min: '0',\r\n      max: '2',\r\n      step: '0.01',\r\n    },\r\n    thickness: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  glow: {\r\n    outerStrength: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    innerStrength: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    padding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '100',\r\n      step: '1',\r\n    },\r\n    alpha: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n  },\r\n  zapshadow: {\r\n    alphaTolerance: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n  },\r\n  sprite: {\r\n    blendMode: {\r\n      range: true,\r\n      min: '0',\r\n      max: '16',\r\n      step: '1',\r\n    },\r\n    gridPadding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.1',\r\n    },\r\n    scaleX: {\r\n      range: true,\r\n      min: '0',\r\n      max: '3',\r\n      step: '0.01',\r\n    },\r\n    scaleY: {\r\n      range: true,\r\n      min: '0',\r\n      max: '3',\r\n      step: '0.01',\r\n    },\r\n    translationX: {\r\n      range: true,\r\n      min: '-1',\r\n      max: '1',\r\n      step: '0.001',\r\n    },\r\n    translationY: {\r\n      range: true,\r\n      min: '-1',\r\n      max: '1',\r\n      step: '0.001',\r\n    },\r\n    rotation: {\r\n      range: true,\r\n      min: '0',\r\n      max: '360',\r\n      step: '1',\r\n    },\r\n    alpha: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n  },\r\n  xfire: {\r\n    blend: {\r\n      range: true,\r\n      min: '0',\r\n      max: '16',\r\n      step: '1',\r\n    },\r\n    amplitude: {\r\n      range: true,\r\n      min: '0',\r\n      max: '10',\r\n      step: '0.01',\r\n    },\r\n    dispersion: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '0.1',\r\n    },\r\n    scaleX: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    scaleY: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    animated: {\r\n      time: {\r\n        speed: {\r\n          range: true,\r\n          min: '-0.0050',\r\n          max: '0.0050',\r\n          step: '0.0001',\r\n        },\r\n      },\r\n    },\r\n  },\r\n  transform: {\r\n    gridPadding: {\r\n      range: true,\r\n      min: '0',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n    scaleX: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.1',\r\n    },\r\n    scaleY: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  ascii: {\r\n    animated: {\r\n      size: {\r\n        val1: {\r\n          range: true,\r\n          min: '-5',\r\n          max: '5',\r\n          step: '0.01',\r\n        },\r\n        val2: {\r\n          range: true,\r\n          min: '-5',\r\n          max: '5',\r\n          step: '0.01',\r\n        },\r\n      },\r\n    },\r\n    size: {\r\n      range: true,\r\n      min: '1',\r\n      max: '64',\r\n      step: '1',\r\n    },\r\n  },\r\n  dot: {\r\n    scale: {\r\n      range: true,\r\n      min: '0',\r\n      max: '10',\r\n      step: '0.1',\r\n    },\r\n    angle: {\r\n      range: true,\r\n      min: '0',\r\n      max: '360',\r\n      step: '1',\r\n    },\r\n  },\r\n  godray: {\r\n    blendMode: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '1',\r\n    },\r\n    padding: {\r\n      range: true,\r\n      min: '-5',\r\n      max: '50',\r\n      step: '0.1',\r\n    },\r\n  },\r\n  rgbSplit: {\r\n    redX: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    redY: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    greenX: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    greenY: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    blueX: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n    blueY: {\r\n      range: true,\r\n      min: '-50',\r\n      max: '50',\r\n      step: '1',\r\n    },\r\n  },\r\n  polymorph: {\r\n    type: {\r\n      range: true,\r\n      min: '0',\r\n      max: '9',\r\n      step: '1',\r\n    },\r\n  },\r\n  shadow: {\r\n    blur: {\r\n      range: true,\r\n      min: '0',\r\n      max: '20',\r\n      step: '1',\r\n    },\r\n  },\r\n  flood: {\r\n    billowy: {\r\n      range: true,\r\n      min: '0',\r\n      max: '5',\r\n      step: '0.01',\r\n    },\r\n    tintIntensity: {\r\n      range: true,\r\n      min: '0.0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n    glint: {\r\n      range: true,\r\n      min: '0',\r\n      max: '1',\r\n      step: '0.01',\r\n    },\r\n    scale: {\r\n      range: true,\r\n      min: '5',\r\n      max: '500',\r\n      step: '1',\r\n    },\r\n    animated: {\r\n      time: {\r\n        speed: {\r\n          range: true,\r\n          min: '0.00001',\r\n          max: '0.001',\r\n          step: '0.00001',\r\n        },\r\n      },\r\n    },\r\n  },\r\n};\r\n","import { MODULE_ID } from '../../scripts/constants.js';\r\nimport { localize } from '../../scripts/utils.js';\r\n\r\nexport function constructNav(allData, documentName, customControls, pins = true) {\r\n  const nav = {\r\n    dataGroup: 'main',\r\n    items: [],\r\n    tabs: [],\r\n  };\r\n  const tabSelectors = [{ navSelector: '.tabs[data-group=\"main\"]', contentSelector: 'form', initial: 'me-pinned' }];\r\n\r\n  // Limit the form to just the keys marked as editable\r\n  let editableKeys;\r\n  // if (documentName === 'Actor') {\r\n  //   editableKeys = ['name', 'img', 'system', 'data', 'folder', 'flags'];\r\n  // }\r\n\r\n  let object = {};\r\n  if (!editableKeys) object = allData;\r\n  else {\r\n    for (const k of editableKeys) {\r\n      if (k in allData) {\r\n        object[k] = allData[k];\r\n      }\r\n    }\r\n  }\r\n\r\n  const pinned = documentName ? game.settings.get(MODULE_ID, 'pinnedFields')[documentName] || {} : {};\r\n\r\n  _constructControls(nav, object, tabSelectors, '', pinned, customControls, pins);\r\n\r\n  const pinned_groups = [];\r\n  const flatObject = foundry.utils.flattenObject(object);\r\n  for (const [k, v] of Object.entries(pinned)) {\r\n    const value = k in flatObject ? flatObject[k] : v.value;\r\n\r\n    let control = genControl(foundry.utils.getType(value), v.label, value, k, {}, true, customControls, pins);\r\n    control.pinned = true;\r\n    pinned_groups.push(control);\r\n  }\r\n  if (pinned_groups.length) {\r\n    // No tabs constructed means this is not a nested object, however since we have pinned fields\r\n    // we need to separate main object fields from the pinned ones\r\n    if (!nav.items.length) {\r\n      nav.items.push({ dataTab: 'main-me-main', label: 'Main' });\r\n      nav.tabs.push({ dataTab: 'main-me-main', groups: nav.groups });\r\n      delete nav.groups;\r\n    }\r\n\r\n    nav.items.unshift({\r\n      dataTab: 'me-pinned',\r\n      dataTab: 'me-pinned',\r\n      label: localize('generic-form.pinned'),\r\n    });\r\n    nav.tabs.unshift({ dataTab: 'me-pinned', groups: pinned_groups });\r\n  }\r\n\r\n  return [nav, tabSelectors];\r\n}\r\n\r\nfunction _constructControls(nav, data, tabSelectors, name, pinned, customControls, pins) {\r\n  const groups = [];\r\n  let containsNav = false;\r\n  for (const [k, v] of Object.entries(data)) {\r\n    const name2 = name ? name + '.' + k : k;\r\n    if (v !== null) {\r\n      let t = foundry.utils.getType(v);\r\n      let control;\r\n      if (t === 'Object') {\r\n        if (_hasNonNullKeys(v)) {\r\n          nav.items.push({ dataTab: name2, label: _genLabel(k) });\r\n          const newNav = { dataGroup: name2, items: [], tabs: [] };\r\n          nav.tabs.push({ dataTab: name2, nav: newNav });\r\n          tabSelectors.push({\r\n            navSelector: `.tabs[data-group=\"${name2}\"]`,\r\n            contentSelector: `.tab[data-tab=\"${name2}\"]`,\r\n            initial: k + '-me-main',\r\n          });\r\n          _constructControls(newNav, v, tabSelectors, name2, pinned, customControls, pins);\r\n          containsNav = true;\r\n        }\r\n      } else {\r\n        control = genControl(t, _genLabel(k), v, name2, pinned, false, customControls, pins);\r\n      }\r\n      if (control) {\r\n        groups.push(control);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (groups.length) {\r\n    if (containsNav) {\r\n      nav.items.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        label: 'Main',\r\n      });\r\n      nav.tabs.unshift({\r\n        dataTab: nav.dataGroup + '-me-main',\r\n        groups,\r\n      });\r\n    } else {\r\n      nav.groups = groups;\r\n    }\r\n  }\r\n}\r\n\r\nfunction _hasNonNullKeys(obj) {\r\n  if (foundry.utils.isEmpty(obj)) return false;\r\n  for (const [k, v] of Object.entries(obj)) {\r\n    if (foundry.utils.getType(v) === 'Object') {\r\n      if (_hasNonNullKeys(v)) return true;\r\n    } else if (v != null) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction _genLabel(key) {\r\n  if (key.length <= 3) return key.toUpperCase();\r\n  return key.charAt(0).toUpperCase() + key.slice(1);\r\n}\r\n\r\nconst IMAGE_FIELDS = ['img', 'image', 'src', 'texture'];\r\nconst COLOR_FIELDS = ['tint'];\r\n\r\nexport function isColorField(name) {\r\n  name = name.split('.').pop();\r\n  return COLOR_FIELDS.includes(name) || name.toLowerCase().includes('color');\r\n}\r\n\r\nfunction genControl(type, label, value, name, pinned, editableLabel = false, customControls = {}, pins) {\r\n  const allowedArrayElTypes = ['number', 'string'];\r\n\r\n  let control = { label: label, value, name, editableLabel, pins };\r\n  if (foundry.utils.getProperty(customControls, name)) {\r\n    control = foundry.utils.mergeObject(control, foundry.utils.getProperty(customControls, name));\r\n  } else if (type === 'number') {\r\n    control.number = true;\r\n    const varName = name.split('.').pop();\r\n    if (isColorField(varName)) {\r\n      control.colorPickerNumber = true;\r\n      try {\r\n        control.colorValue = new Color(value).toString();\r\n      } catch (e) {}\r\n    }\r\n  } else if (type === 'string') {\r\n    control.text = true;\r\n    const varName = name.split('.').pop();\r\n    if (\r\n      IMAGE_FIELDS.includes(varName) ||\r\n      varName.toLowerCase().includes('image') ||\r\n      varName.toLowerCase().includes('path')\r\n    )\r\n      control.filePicker = true;\r\n    else if (isColorField(varName)) control.colorPicker = true;\r\n  } else if (type === 'boolean') {\r\n    control.boolean = true;\r\n  } else if (type === 'Array' && value.every((el) => allowedArrayElTypes.includes(foundry.utils.getType(el)))) {\r\n    control.value = value.join(', ');\r\n    control.array = true;\r\n  } else if (type === 'Array') {\r\n    control.jsonArray = true;\r\n    control.value = JSON.stringify(value, null, 2);\r\n  } else {\r\n    control.disabled = true;\r\n    control.text = true;\r\n    control.editableLabel = false;\r\n  }\r\n  if (control && name in pinned) {\r\n    control.pinned = true;\r\n    control.disabled = true;\r\n    control.name = null;\r\n  }\r\n  return control;\r\n}\r\n","import { CUSTOM_CONTROLS } from '../../data/custom-controls.js';\r\nimport { MODULE_ID } from '../../scripts/constants.js';\r\nimport { getCommonData, localize } from '../../scripts/utils.js';\r\nimport { WithMassConfig } from '../forms.js';\r\nimport { showMassEdit } from '../multiConfig.js';\r\nimport { constructNav, isColorField } from './navGenerator.js';\r\n\r\nconst WMC = WithMassConfig();\r\nexport class MassEditGenericForm extends WMC {\r\n  constructor(docs, options = {}) {\r\n    const objects = docs.map((a) => (a.toObject ? a.toObject() : a));\r\n    let allData = {};\r\n    for (let i = objects.length; i >= 0; i--) {\r\n      foundry.utils.mergeObject(allData, objects[i]);\r\n    }\r\n\r\n    if (options.noTabs) {\r\n      allData = foundry.utils.flattenObject(allData);\r\n    }\r\n\r\n    let documentName = options.documentName ?? 'NONE';\r\n\r\n    let customControls = foundry.utils.mergeObject(\r\n      CUSTOM_CONTROLS[documentName] ?? {},\r\n      game.settings.get(MODULE_ID, 'customControls')[documentName] ?? {}\r\n    );\r\n    customControls = foundry.utils.mergeObject(customControls, options.customControls?.[documentName] ?? {});\r\n\r\n    const [nav, tabSelectors] = constructNav(allData, documentName, customControls, !options.noTabs);\r\n    const commonData = getCommonData(objects);\r\n\r\n    super(docs[0], docs, {\r\n      tabs: tabSelectors,\r\n      commonData: commonData,\r\n      ...options,\r\n    });\r\n\r\n    this.allData = allData;\r\n    this.nav = nav;\r\n    this.editableLabels = {};\r\n\r\n    this.pinnedFields = game.settings.get(MODULE_ID, 'pinnedFields')[this.documentName] ?? {};\r\n    this.customControls = customControls;\r\n\r\n    if (options.callback) this.callbackOnUpdate = options.callback;\r\n    if (options.closeCallback) this.closeCallback = options.closeCallback;\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-generic-form',\r\n      classes: ['sheet'],\r\n      template: `modules/${MODULE_ID}/templates/generic/genericForm.html`,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: `Generic`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n    if (this.options.tokens) {\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-tokens',\r\n        icon: 'fas fa-user-circle',\r\n        onclick: () => {\r\n          showMassEdit(this.options.tokens, 'Token');\r\n          this.close();\r\n        },\r\n      });\r\n    }\r\n    return buttons;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = await super.getData(options);\r\n    // Cache partials\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/navHeaderPartial.html`, 'me-navHeaderPartial');\r\n    await getTemplate(`modules/${MODULE_ID}/templates/generic/form-group.html`, 'me-form-group');\r\n\r\n    data.nav = this.nav;\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.me-pinned').click((event) => {\r\n      const star = $(event.target).parent();\r\n      const control = star.closest('.form-group').find('[name]');\r\n      const name = control.attr('name');\r\n      if (star.hasClass('active')) {\r\n        star.removeClass('active');\r\n        delete this.pinnedFields[name];\r\n      } else {\r\n        star.addClass('active');\r\n        this.pinnedFields[name] = { label: name };\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label').on('input', (event) => {\r\n      const name = $(event.target).closest('.form-group').find('[name]').attr('name');\r\n      this.editableLabels[name] = event.target.value;\r\n    });\r\n\r\n    html.find('.color-number').on('change', (event) => {\r\n      if (event.target.dataset?.editNumber) {\r\n        let col = 0;\r\n        try {\r\n          col = Number(Color.fromString(event.target.value));\r\n        } catch (e) {}\r\n\r\n        $(event.target).siblings(`[name=\"${event.target.dataset.editNumber}\"]`).val(col).trigger('input');\r\n      }\r\n    });\r\n\r\n    html.find('.me-editable-label, label').on('contextmenu', (event) => {\r\n      const formGroup = $(event.target).closest('.form-group');\r\n      if (!formGroup.length) return;\r\n      const input = formGroup.find('[name]');\r\n      const name = input.attr('name');\r\n      if (name) {\r\n        if (isColorField(name)) return;\r\n\r\n        const type = input.attr('type');\r\n        if (type === 'range') {\r\n          unsetCustomControl(name, this.documentName);\r\n          return;\r\n        } else if (type === 'number') {\r\n          defineRangeControl(name, input.val(), this.customControls, this.documentName);\r\n        } else if (type === 'text') {\r\n          defineSelectControl(name, input.val(), this.customControls, this.documentName);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (this.options.inputChangeCallback) {\r\n      html.on('change', 'input, select', async (event) => {\r\n        setTimeout(() => this.options.inputChangeCallback(this.getSelectedFields()), 100);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    super._updateObject(event, formData);\r\n\r\n    // Save pinned field values and labels\r\n    const pinned = game.settings.get(MODULE_ID, 'pinnedFields');\r\n    pinned[this.documentName] = this.pinnedFields;\r\n\r\n    for (const name of Object.keys(this.pinnedFields)) {\r\n      this.pinnedFields[name].value = formData[name];\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(this.editableLabels)) {\r\n      for (const [name, label] of Object.entries(this.editableLabels)) {\r\n        if (name in this.pinnedFields) {\r\n          this.pinnedFields[name].label = label;\r\n          this.pinnedFields[name].value = formData[name];\r\n        }\r\n      }\r\n      this.editableLabels = {};\r\n    }\r\n\r\n    game.settings.set(MODULE_ID, 'pinnedFields', pinned);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    if (this.callbackOnUpdate) this.callbackOnUpdate(null);\r\n    this.closeCallback?.(null);\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\nfunction defineRangeControl(name, val, customControls, documentName, { min = null, max = null, step = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>Range</label>\r\n  <div class=\"form-fields\">\r\n    <label>${localize('Minimum', false)}</label>\r\n    <input type=\"number\" value=\"${min ?? val}\" name=\"min\" step=\"any\">\r\n    <label>${localize('Maximum', false)}</label>\r\n    <input type=\"number\" value=\"${max ?? val}\" name=\"max\" step=\"any\">\r\n    <label>${localize('generic-form.step-size')}</label>\r\n    <input type=\"number\" value=\"${step ?? 1}\" name=\"step\" step=\"any\">\r\n  </div>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-range'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const min = html.find('[name=\"min\"]').val() || val;\r\n          const max = html.find('[name=\"max\"]').val() || val;\r\n          const step = html.find('[name=\"step\"]').val() || 1;\r\n\r\n          setProperty(customControls, name, { range: true, min, max, step });\r\n          const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n          allControls[documentName] = customControls;\r\n          game.settings.set(MODULE_ID, 'customControls', allControls);\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction defineSelectControl(name, val, customControls, documentName, { options = null } = {}) {\r\n  let content = `\r\n<div class=\"form-group slim\">\r\n  <label>${localize('common.options')}</label>\r\n  <textarea name=\"options\">${options ? options.join('\\n') : val}</textarea>\r\n</div>\r\n  `;\r\n  new Dialog({\r\n    title: localize('generic-form.define-dropdown'),\r\n    content: content,\r\n    buttons: {\r\n      save: {\r\n        label: localize('Save', false),\r\n        callback: async (html) => {\r\n          const options = html.find('[name=\"options\"]').val().trim();\r\n          if (options) {\r\n            setProperty(customControls, name, {\r\n              select: true,\r\n              options: options.split('\\n').filter((o) => o),\r\n            });\r\n            const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n            allControls[documentName] = customControls;\r\n            game.settings.set(MODULE_ID, 'customControls', allControls);\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction unsetCustomControl(name, documentName) {\r\n  const allControls = game.settings.get(MODULE_ID, 'customControls');\r\n  let docControls = allControls[documentName] || {};\r\n  setProperty(docControls, name, null);\r\n  game.settings.set(MODULE_ID, 'customControls', allControls);\r\n}\r\n","import { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_SHEET_CONFIGS } from '../scripts/constants.js';\r\nimport { showPlaceableTypeSelectDialog } from '../scripts/dialogs.js';\r\nimport { Spawner } from '../scripts/presets/spawner.js';\r\nimport { getData, getDocumentName } from '../scripts/utils.js';\r\nimport { getClipboardData, pasteDataUpdate } from './formUtils.js';\r\nimport { WithMassConfig } from './forms.js';\r\nimport { MassEditGenericForm } from './generic/genericForm.js';\r\n\r\nexport const LAYER_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lighting',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\nexport const SCENE_DOC_MAPPINGS = {\r\n  Token: 'tokens',\r\n  Tile: 'tiles',\r\n  Drawing: 'drawings',\r\n  Wall: 'walls',\r\n  AmbientLight: 'lights',\r\n  AmbientSound: 'sounds',\r\n  MeasuredTemplate: 'templates',\r\n  Note: 'notes',\r\n};\r\n\r\n// Retrieve currently controlled placeables\r\nexport function getControlled() {\r\n  if (canvas.activeLayer.controlled.length) {\r\n    return canvas.activeLayer.controlled;\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve hovered over placeable\r\nfunction getHover() {\r\n  let documentName = canvas.activeLayer.constructor.documentName;\r\n  // Walls do not properly cleanup hover state\r\n  if (!['Wall'].includes(documentName)) {\r\n    if (canvas.activeLayer.hover) {\r\n      return [canvas.activeLayer.hover];\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n// Retrieve documents selected using Multiple Document Selection module (https://github.com/ironmonk88/multiple-document-selection)\r\nfunction getSelectedDocuments(placeableSelect) {\r\n  const supportedDocs = [\r\n    { name: 'Actor', class: 'actor' },\r\n    { name: 'Scene', class: 'scene' },\r\n    { name: 'JournalEntry', class: 'journalentry' },\r\n    { name: 'Playlist', class: 'sound' },\r\n    { name: 'Item', class: 'item' },\r\n    { name: 'RollTable', class: 'rolltable' },\r\n    { name: 'Cards', class: 'cards' },\r\n  ];\r\n  for (const doc of supportedDocs) {\r\n    const selected = [];\r\n    $(`.directory-list .${doc.class}.selected`).each(function (_) {\r\n      let d;\r\n      if (doc.name === 'Playlist') {\r\n        d = game.collections.get(doc.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\r\n      } else {\r\n        d = game.collections.get(doc.name).get(this.dataset.documentId);\r\n      }\r\n\r\n      if (d) {\r\n        // JournalEntries themselves do not have configs, but notes that they correspond to on the scene do\r\n        if (placeableSelect && doc.name === 'JournalEntry') {\r\n          game.collections.get('Scene').forEach((s) =>\r\n            s.notes.forEach((n) => {\r\n              const eid = n.entryId ?? n.data.entryId;\r\n              if (d.id === eid) {\r\n                selected.push(n);\r\n              }\r\n            })\r\n          );\r\n          // canvas.notes.placeables\r\n          //   .filter((n) => d.id === (n.entryId ?? n.data.entryId))\r\n          //   .forEach((n) => selected.push(n));\r\n        } else {\r\n          if (d) selected.push(d);\r\n        }\r\n      }\r\n    });\r\n    if (selected.length) {\r\n      return selected;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function getSelected(base, placeable = true) {\r\n  let selected;\r\n  if (base) {\r\n    if (Array.isArray(base)) selected = base;\r\n    else selected = [base];\r\n  }\r\n  if (!selected) selected = getSelectedDocuments(placeable);\r\n  if (!selected) selected = getControlled();\r\n\r\n  // Sort placeable on the scene using their (x, y) coordinates\r\n  if (selected && selected.length > 1 && selected[0].x != null && selected[0].y != null) {\r\n    selected.sort((p1, p2) => {\r\n      const c = p1.y - p2.y;\r\n      if (c === 0) {\r\n        return p1.x - p2.x;\r\n      }\r\n      return c;\r\n    });\r\n  }\r\n\r\n  // We want one object to be treated as the target for the form\r\n  // Will prioritize hovered placeable for this purpose\r\n  let hover = getHover();\r\n  hover = hover ? hover[0] : hover;\r\n\r\n  if (!selected && hover) selected = [hover];\r\n  if (!hover && selected) hover = selected[0];\r\n\r\n  if (!hover && !selected) return [null, null];\r\n\r\n  if (hover && getDocumentName(hover) !== getDocumentName(selected[0])) {\r\n    hover = selected[0];\r\n  }\r\n\r\n  return [hover, selected];\r\n}\r\n\r\n// Show placeable search\r\nexport function showMassSelect(basePlaceable) {\r\n  let [target, selected] = getSelected(basePlaceable);\r\n\r\n  if (!target) {\r\n    showPlaceableTypeSelectDialog();\r\n    return;\r\n  }\r\n\r\n  const documentName = getDocumentName(target);\r\n\r\n  const options = {\r\n    commonData: foundry.utils.flattenObject(getData(target).toObject()),\r\n    massSelect: true,\r\n    documentName: documentName,\r\n  };\r\n\r\n  if (SUPPORTED_SHEET_CONFIGS.includes(documentName) && documentName !== 'Actor') {\r\n    const MassConfig = WithMassConfig(documentName);\r\n    new MassConfig(target, selected, options).render(true, {});\r\n  } else if (SUPPORTED_COLLECTIONS.includes(documentName)) {\r\n    new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\n// show placeable edit\r\nexport async function showMassEdit(found = null, documentName, options = {}) {\r\n  let [target, selected] = getSelected(found);\r\n\r\n  // If there are no placeable in control or just one, then either exit or display the default config window\r\n  if (!selected || !selected.length) return;\r\n\r\n  if (!options.forceForm && game.settings.get(MODULE_ID, 'singleDocDefaultConfig')) {\r\n    if (selected.length === 1) {\r\n      if (selected[0].sheet) selected[0].sheet.render(true, {});\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Display modified config window\r\n  if (!documentName) documentName = getDocumentName(target);\r\n  options = { ...options, massEdit: true, documentName };\r\n  if (SUPPORTED_SHEET_CONFIGS.includes(documentName)) {\r\n    if (documentName === 'Actor') {\r\n      target = target.prototypeToken;\r\n      selected = selected.map((s) => s.prototypeToken);\r\n      options.documentName = 'Token';\r\n    }\r\n    const MassConfig = WithMassConfig(options.documentName);\r\n    return new MassConfig(target, selected, options).render(true, {});\r\n  } else {\r\n    return new MassEditGenericForm(selected, options).render(true);\r\n  }\r\n}\r\n\r\nexport function showMassActorForm(selectedTokens, options) {\r\n  const tokens = [];\r\n  const actors = [];\r\n  selectedTokens.forEach((s) => {\r\n    if (s.actor) {\r\n      tokens.push(s);\r\n      actors.push(s.actor);\r\n    }\r\n  });\r\n\r\n  if (actors.length) {\r\n    new MassEditGenericForm(actors, {\r\n      tokens,\r\n      documentName: 'Actor',\r\n      ...options,\r\n    }).render(true);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function pasteData() {\r\n  let selected;\r\n  if (!selected) selected = getSelectedDocuments();\r\n  if (!selected) selected = getControlled();\r\n  if (!selected) selected = getHover();\r\n\r\n  if (selected) return pasteDataUpdate(selected, null, false, true);\r\n  else {\r\n    let documentName = canvas.activeLayer.constructor.documentName;\r\n    const preset = getClipboardData(documentName);\r\n    if (preset) {\r\n      Spawner.spawnPreset({ preset });\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Displays a Generic Mass Edit form for the passed in data object/s\r\n * @param {Array|Object} data Object/s to be edited using the form\r\n * @param {String} name the name to be assigned internally to this data which will be used to manage presets and pins\r\n * @returns Promised resolved once the opened form is submitted\r\n */\r\nexport function showGenericForm(data, name = 'GenericData', options) {\r\n  return new Promise((resolve) => {\r\n    new MassEditGenericForm(Array.isArray(data) ? data : [data], {\r\n      documentName: name,\r\n      callback: () => resolve(),\r\n      ...options,\r\n    }).render(true);\r\n  });\r\n}\r\n\r\n/**\r\n * Get the instance of an open Mass Edit form\r\n * @returns\r\n */\r\nexport function getMassEditForm() {\r\n  return (\r\n    Object.values(ui.windows).find((app) => app.meObjects != null) ??\r\n    Array.from(foundry.applications.instances.values()).find((app) => app.meObjects != null)\r\n  );\r\n}\r\n","import { pasteDataUpdate } from '../applications/formUtils.js';\r\nimport { MODULE_ID, PIVOTS } from './constants.js';\r\nimport { Mouse3D } from './mouse3d.js';\r\nimport { Picker } from './picker.js';\r\nimport { PresetAPI, PresetCollection } from './presets/collection.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { Spawner } from './presets/spawner.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\nimport { TagInput } from './utils.js';\r\n\r\nexport class Brush {\r\n  static app;\r\n  static deactivateCallback;\r\n  static spawner;\r\n  static eraser;\r\n  static lastSpawnTime;\r\n  // @type {Preset}\r\n  static preset;\r\n  static brushOverlay;\r\n  static updatedPlaceables = new Map();\r\n  static hoveredPlaceables = new Set();\r\n  static spawnPoints = [];\r\n  static hoveredPlaceable;\r\n  static documentName;\r\n  static active = false;\r\n  static hitTest;\r\n\r\n  static _checkDensity(pos) {\r\n    const d = canvas.grid.size * this.spawnDensity;\r\n    return this.spawnPoints.every((p) => Math.sqrt((p.x - pos.x) ** 2 + (p.y - pos.y) ** 2) >= d);\r\n  }\r\n\r\n  static _performBrushDocumentUpdate(placeable) {\r\n    this.preset.callPostSpawnHooks({ objects: [placeable], documents: [placeable.document] });\r\n    if (!this.preset.isEmpty) pasteDataUpdate([placeable], this.preset, true, true, this.transform);\r\n    this.updatedPlaceables.set(placeable.id, placeable);\r\n    BrushMenu.iterate();\r\n  }\r\n\r\n  static _performBrushDocumentCreate(pos) {\r\n    const now = new Date().getTime();\r\n    if (!this.lastSpawnTime || now - this.lastSpawnTime > 100) {\r\n      this.lastSpawnTime = now;\r\n\r\n      if (!this._checkDensity(pos)) return;\r\n      Picker.resolve(pos);\r\n      this.spawnPoints.push(pos);\r\n\r\n      BrushMenu.iterate();\r\n    }\r\n  }\r\n\r\n  static _performBrushDocumentDelete(placeable) {\r\n    this.hoveredPlaceable = null;\r\n    if (!placeable._brushDelete) placeable.document?.delete();\r\n    placeable._brushDelete = true;\r\n  }\r\n\r\n  static _hitTestWall(point, wall) {\r\n    return wall.line.hitArea.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hitTestRegion(point, region) {\r\n    return region.bounds.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hitTestControlIcon(point, placeable) {\r\n    return (\r\n      Number.between(\r\n        point.x,\r\n        placeable.x - placeable.controlIcon.width / 2,\r\n        placeable.x + placeable.controlIcon.width / 2\r\n      ) &&\r\n      Number.between(\r\n        point.y,\r\n        placeable.y - placeable.controlIcon.height / 2,\r\n        placeable.y + placeable.controlIcon.height / 2\r\n      )\r\n    );\r\n  }\r\n\r\n  static _hitTestTile(point, placeable) {\r\n    const foreground = ui.controls.control.foreground ?? false;\r\n    // V12, to be removed\r\n    if (placeable.document.hasOwnProperty('elevation')) {\r\n      if (placeable.document.elevation && !foreground) return false;\r\n    } else {\r\n      if (placeable.document.overhead !== foreground) return false;\r\n    }\r\n    return placeable.bounds.contains(point.x, point.y);\r\n  }\r\n\r\n  static _hoverTestArea(placeable) {\r\n    if (!this.hoveredPlaceable) return false;\r\n\r\n    const hBounds = this.hoveredPlaceable.bounds;\r\n    const pBounds = placeable.bounds;\r\n    return hBounds.width * hBounds.height > pBounds.width * pBounds.height;\r\n  }\r\n\r\n  static _hitTestArea(point, placeable) {\r\n    return (\r\n      Number.between(point.x, placeable.x, placeable.x + placeable.hitArea.width) &&\r\n      Number.between(point.y, placeable.y, placeable.y + placeable.hitArea.height)\r\n    );\r\n  }\r\n\r\n  static _onBrushMove(event) {\r\n    const pos = event.data.getLocalPosition(this.brushOverlay);\r\n    const layer = canvas.getLayerByEmbeddedName(this.documentName);\r\n    this._clearHover(event, pos);\r\n\r\n    for (const p of layer.placeables) {\r\n      if (p.visible && this.hitTest(pos, p) && !this.updatedPlaceables.has(p.id) && this.hoveredPlaceable !== p) {\r\n        if (this.hoverTest?.(p)) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoverTest && this.hoveredPlaceable && this.hoveredPlaceable !== p) {\r\n          this.hoveredPlaceable._onHoverOut(event);\r\n          this.hoveredPlaceable = p;\r\n        } else if (!this.hoveredPlaceable) {\r\n          this.hoveredPlaceable = p;\r\n        }\r\n\r\n        this.hoveredPlaceable._onHoverIn(event);\r\n      }\r\n    }\r\n  }\r\n\r\n  static _clearHover(event, pos, force = false) {\r\n    if (this.hoveredPlaceable) {\r\n      if (force || !this.hoveredPlaceable.visible || !this.hitTest(pos, this.hoveredPlaceable)) {\r\n        this.hoveredPlaceable._onHoverOut(event);\r\n        this.hoveredPlaceable = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  static _onBrushClickMove(event) {\r\n    if (this.spawner) {\r\n      this._performBrushDocumentCreate(event.data.getLocalPosition(this.brushOverlay));\r\n    } else if (\r\n      this.hoveredPlaceable &&\r\n      this.hoveredPlaceable.visible &&\r\n      !this.updatedPlaceables.has(this.hoveredPlaceable.id)\r\n    ) {\r\n      if (this.eraser) this._performBrushDocumentDelete(this.hoveredPlaceable);\r\n      else this._performBrushDocumentUpdate(this.hoveredPlaceable);\r\n    }\r\n  }\r\n\r\n  static _on3DBrushClick({ x, y, z, placeable } = {}) {\r\n    if (this.spawner) {\r\n      this._performBrushDocumentCreate({ x, y, z });\r\n    } else {\r\n      if (placeable && placeable.document.documentName === this.documentName) {\r\n        if (this.eraser) this._performBrushDocumentDelete(placeable);\r\n        else this._performBrushDocumentUpdate(placeable);\r\n      }\r\n      this.updatedPlaceables.clear();\r\n    }\r\n  }\r\n\r\n  static refreshPreset() {\r\n    if (this.active && this.app) {\r\n      this.preset = new Preset({\r\n        documentName: this.documentName,\r\n        data: this.app.getSelectedFields(),\r\n        randomize: this.app.randomizeFields,\r\n        addSubtract: this.app.addSubtractFields,\r\n      });\r\n    }\r\n  }\r\n\r\n  static async genPreview() {\r\n    return Spawner.spawnPreset({\r\n      preset: this.preset,\r\n      preview: true,\r\n      previewOnly: true,\r\n      pivot: PIVOTS.CENTER,\r\n      transform: this.transform,\r\n      snapToGrid: this.snap,\r\n      scaleToGrid: this.scaleToGrid,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Object} options\r\n   * @param {MassEditForm} options.app\r\n   * @param {Preset} options.preset\r\n   * @returns\r\n   */\r\n  static activate({\r\n    app = null,\r\n    preset = null,\r\n    deactivateCallback = null,\r\n    spawner = false,\r\n    spawnDensity = 0.01,\r\n    eraser = false,\r\n    refresh = false,\r\n    transform = {},\r\n    snap = true,\r\n    scaleToGrid = true,\r\n  } = {}) {\r\n    this.deactivate(refresh);\r\n    if (!canvas.ready) return false;\r\n    if (!app && !preset) return false;\r\n\r\n    if (this.brushOverlay) {\r\n      this.brushOverlay.destroy(true);\r\n    }\r\n\r\n    // Setup fields to be used for updates\r\n    this.app = app;\r\n    this.preset = preset;\r\n    this.transform = transform;\r\n    this.deactivateCallback = deactivateCallback;\r\n    this.spawner = spawner;\r\n    this.eraser = eraser;\r\n    this.snap = snap;\r\n    this.spawnDensity = spawnDensity;\r\n    this.scaleToGrid = scaleToGrid;\r\n    if (this.app) {\r\n      this.documentName = this.app.documentName;\r\n    } else {\r\n      this.documentName = this.preset.documentName;\r\n    }\r\n    if (!refresh) {\r\n      this.updatedPlaceables.clear();\r\n      this.spawnPoints = [];\r\n    }\r\n\r\n    const interaction = canvas.app.renderer.events;\r\n    if (!interaction.cursorStyles['brush']) {\r\n      interaction.cursorStyles['brush'] = `url('modules/${MODULE_ID}/images/brush_icon.png'), auto`;\r\n      interaction.cursorStyles['brush_spawn'] = `url('modules/${MODULE_ID}/images/brush_icon_spawn.png'), auto`;\r\n      interaction.cursorStyles['eraser'] = `url('modules/${MODULE_ID}/images/brush_icon_eraser.png'), auto`;\r\n    }\r\n\r\n    this.active = true;\r\n    this.refreshPreset();\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      if (this.spawner) this.genPreview();\r\n      return this._activate3d();\r\n    }\r\n\r\n    // Determine hit test test function to be used for pointer hover detection\r\n    if (this.spawner) {\r\n      this.hitTest = () => false;\r\n      this.genPreview();\r\n    } else {\r\n      switch (this.documentName) {\r\n        case 'Wall':\r\n          this.hitTest = this._hitTestWall;\r\n          break;\r\n        case 'Region':\r\n          this.hitTest = this._hitTestRegion;\r\n          break;\r\n        case 'AmbientLight':\r\n        case 'MeasuredTemplate':\r\n        case 'AmbientSound':\r\n        case 'Note':\r\n          this.hitTest = this._hitTestControlIcon;\r\n          break;\r\n        case 'Tile':\r\n          this.hitTest = this._hitTestTile;\r\n          this.hoverTest = this._hoverTestArea;\r\n          break;\r\n        default:\r\n          this.hitTest = this._hitTestArea;\r\n          this.hoverTest = this._hoverTestArea;\r\n      }\r\n    }\r\n\r\n    // Create the brush overlay\r\n    this.brushOverlay = new PIXI.Container();\r\n    this.brushOverlay.hitArea = canvas.dimensions.rect;\r\n\r\n    let cursor = 'brush';\r\n    if (spawner) cursor = 'brush_spawn';\r\n    else if (eraser) cursor = 'eraser';\r\n    this.brushOverlay.cursor = cursor;\r\n\r\n    this.brushOverlay.interactive = true;\r\n    this.brushOverlay.zIndex = Infinity;\r\n\r\n    this.brushOverlay.on('mousemove', (event) => {\r\n      Picker.feedPos(event.data.getLocalPosition(this.brushOverlay));\r\n      this._onBrushMove(event);\r\n      if (!this.mDownWithinCanvas) return; // Fix to prevent mouse interaction within apps\r\n      if (event.buttons === 1) this._onBrushClickMove(event);\r\n    });\r\n    this.brushOverlay.on('mouseup', (event) => {\r\n      this.mDownWithinCanvas = false; // Fix to prevent mouse interaction within apps\r\n      if (event.nativeEvent.which !== 2) {\r\n        this._onBrushClickMove(event);\r\n      }\r\n      this.updatedPlaceables.clear();\r\n      this.spawnPoints = [];\r\n    });\r\n\r\n    this.brushOverlay.on('mousedown', (event) => {\r\n      this.mDownWithinCanvas = true; // Fix to prevent mouse interaction within apps\r\n    });\r\n\r\n    this.brushOverlay.on('click', (event) => {\r\n      if (event.nativeEvent.which == 2) {\r\n        this.deactivate();\r\n      }\r\n    });\r\n\r\n    canvas.stage.addChild(this.brushOverlay);\r\n\r\n    // Disable canvas events to prevent selects and object placements on click\r\n    canvas.mouseInteractionManager.permissions.clickLeft = false;\r\n    // canvas.mouseInteractionManager.permissions.longPress = false;\r\n\r\n    return true;\r\n  }\r\n\r\n  static _activate3d() {\r\n    Mouse3D.activate({\r\n      mouseMoveCallback: Picker.feedPos.bind(Picker),\r\n      mouseClickCallback: this._on3DBrushClick.bind(this),\r\n      mouseWheelClickCallback: this.deactivate.bind(this),\r\n    });\r\n    return true;\r\n  }\r\n\r\n  static deactivate(refresh = false) {\r\n    if (this.active) {\r\n      canvas.mouseInteractionManager.permissions.clickLeft = true;\r\n      //canvas.mouseInteractionManager.permissions.longPress = true;\r\n      if (this.brushOverlay) this.brushOverlay.parent?.removeChild(this.brushOverlay);\r\n      this.active = false;\r\n\r\n      if (!refresh) {\r\n        this.updatedPlaceables.clear();\r\n        this.spawnPoints = [];\r\n        this._clearHover(null, null, true);\r\n      }\r\n      this.hoverTest = null;\r\n      if (!refresh) this.deactivateCallback?.();\r\n      if (this.spawner) Picker.destroy();\r\n      this.spawner = false;\r\n      this.eraser = false;\r\n      this.deactivateCallback = null;\r\n      this.app = null;\r\n      this.preset = null;\r\n      this.transform = null;\r\n      return true;\r\n    }\r\n    Mouse3D.deactivate();\r\n  }\r\n}\r\n\r\n// =================================================\r\n\r\nexport class BrushMenu extends FormApplication {\r\n  static addPresets(presets = []) {\r\n    if (!this._instance) return this.render(presets);\r\n    else this._instance.addPresets(presets);\r\n  }\r\n\r\n  static isActive() {\r\n    return Boolean(this._instance);\r\n  }\r\n\r\n  static removePreset(id) {\r\n    if (!this._instance) return;\r\n    this._instance.removePreset(id);\r\n  }\r\n\r\n  static iterate(forward = true, force = false) {\r\n    if (!this._instance) return;\r\n    this._instance.iterate(forward, force);\r\n  }\r\n\r\n  static render(presets, settings = {}) {\r\n    if (this._instance) this.addPresets(presets);\r\n    else {\r\n      this._instance = new BrushMenu(presets, settings);\r\n      this._instance.render(true);\r\n    }\r\n  }\r\n\r\n  static async close() {\r\n    return this._instance?.close(true);\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-brush-menu',\r\n      template: `modules/${MODULE_ID}/templates/preset/brush/menu.html`,\r\n      classes: ['mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      resizable: false,\r\n      minimizable: false,\r\n      width: 200,\r\n      height: 'auto',\r\n      scrollY: ['.presets'],\r\n    });\r\n  }\r\n\r\n  constructor(presets, settings = {}) {\r\n    super({}, { left: 10, top: window.innerHeight / 2 });\r\n    this.presets = presets ?? [];\r\n    this.preset = this.presets[0].clone();\r\n    this.preset.data = this.preset.data[0];\r\n    this._settings = foundry.utils.mergeObject(game.settings.get(MODULE_ID, 'brush'), settings);\r\n    this._it = -1;\r\n    this._createIndex();\r\n    this.iterate();\r\n  }\r\n\r\n  _createIndex() {\r\n    const index = [];\r\n\r\n    if (this._settings.group) {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        index.push({ pI });\r\n      }\r\n    } else {\r\n      for (let pI = 0; pI < this.presets.length; pI++) {\r\n        const preset = this.presets[pI];\r\n        for (let dI = 0; dI < preset.data.length; dI++) {\r\n          index.push({ pI, dI });\r\n        }\r\n      }\r\n    }\r\n    this._index = index;\r\n    if (this._it >= this._index.length) this._it = this._index.length - 1;\r\n  }\r\n\r\n  async _activateBrush(refresh = true) {\r\n    const index = this._index[this._it];\r\n    const p = this.presets[index.pI];\r\n    this.preset = p.clone();\r\n    if (index.hasOwnProperty('dI')) this.preset.data = [this.preset.data[index.dI]];\r\n\r\n    // Apply Color\r\n    await this._applyColor();\r\n\r\n    // Apply TMFX Filters\r\n    this._applyTmfxPresets(this.preset, this._settings.tmfxPreset);\r\n\r\n    // Apply Tagger tags\r\n    this._applyTaggerTags(this.preset, this._settings.tagger);\r\n\r\n    Brush.activate({\r\n      preset: this.preset,\r\n      deactivateCallback: this._deactivateCallback.bind(this),\r\n      spawner: this._settings.spawner,\r\n      eraser: this._settings.eraser,\r\n      transform: this._getTransform(),\r\n      refresh,\r\n      snap: this._settings.snap,\r\n      scaleToGrid: this._settings.scaleToGrid,\r\n      spawnDensity: this._settings.density,\r\n    });\r\n  }\r\n\r\n  async _applyColor() {\r\n    if (this._settings.randomColor || this._settings.color) {\r\n      let pPath;\r\n      const documentName = this.preset.documentName;\r\n      if (documentName === 'Token' || documentName === 'Tile') pPath = 'texture.tint';\r\n      else if (documentName === 'AmbientLight') pPath = 'config.color';\r\n\r\n      if (game.Levels3DPreview?._active) {\r\n        if (documentName === 'Token' || documentName === 'Tile') pPath = 'flags.levels-3d-preview.color';\r\n      }\r\n\r\n      if (pPath) {\r\n        if (this._settings.randomColor) {\r\n          const updates = this.preset.data.map(() => {\r\n            return { color: '' };\r\n          });\r\n          await applyRandomization(updates, null, { color: { type: 'color', ...this._settings.randomColor } });\r\n\r\n          this.preset.data.forEach((d, i) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, updates[i].color);\r\n            else foundry.utils.setProperty(d, pPath, updates[i].color);\r\n          });\r\n        } else {\r\n          this.preset.data.forEach((d) => {\r\n            if (this._settings.ddTint) this._applyDDTint(d, this._settings.color);\r\n            else foundry.utils.setProperty(d, pPath, this._settings.color);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  _applyDDTint(data, color) {\r\n    let filters = foundry.utils.getProperty(data, 'flags.tokenmagic.filters');\r\n\r\n    if (!color) {\r\n      if (filters) {\r\n        foundry.utils.setProperty(\r\n          data,\r\n          'flags.tokenmagic.filters',\r\n          filters.filter((f) => f.tmFilters.filterId !== 'DDTint')\r\n        );\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: foundry.utils.randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: foundry.utils.randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      foundry.utils.setProperty(data, 'flags.tokenmagic.filters', filters);\r\n    }\r\n  }\r\n\r\n  _applyTaggerTags(preset, tags) {\r\n    if (!tags || !tags.length) return;\r\n    if (!game.modules.get('tagger')?.active) return;\r\n\r\n    preset.addPostSpawnHook(({ objects } = {}) => {\r\n      Tagger.addTags(objects, tags);\r\n    });\r\n  }\r\n\r\n  _applyTmfxPresets(preset, tmfxPreset) {\r\n    if (!tmfxPreset) return;\r\n    if (!game.modules.get('tokenmagic')?.active) return;\r\n    if (!['Token', 'Tile', 'Drawing', 'MeasuredTemplate'].includes(preset.documentName)) return;\r\n\r\n    if (!Array.isArray(tmfxPreset)) tmfxPreset = [tmfxPreset];\r\n\r\n    if (tmfxPreset.includes('DELETE ALL')) {\r\n      this.preset.addPostSpawnHook(({ objects } = {}) => objects.forEach((o) => TokenMagic.deleteFilters(o)));\r\n      return;\r\n    } else if (tmfxPreset.includes('DELETE')) {\r\n      this.preset.addPostSpawnHook(({ objects } = {}) =>\r\n        objects.forEach(async (o) => {\r\n          for (const p of tmfxPreset) await TokenMagic.deleteFilters(o, p);\r\n        })\r\n      );\r\n      return;\r\n    }\r\n\r\n    const filters = [];\r\n    tmfxPreset.forEach((presetName) => TokenMagic.getPreset(presetName)?.forEach((filter) => filters.push(filter)));\r\n\r\n    if (filters.length)\r\n      this.preset.addPostSpawnHook(({ objects } = {}) =>\r\n        objects.forEach((o) => TokenMagic.addUpdateFilters(o, filters))\r\n      );\r\n  }\r\n\r\n  get title() {\r\n    return 'Brush';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    return {\r\n      presets: this.presets,\r\n      activePreset: this.preset,\r\n      ...this._settings,\r\n      tmfxActive: game.modules.get('tokenmagic')?.active,\r\n      taggerActive: game.modules.get('tagger')?.active,\r\n    };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const settings = this._settings;\r\n    const app = this;\r\n\r\n    import('./jquery-ui/jquery-ui.js').then((module) => {\r\n      const rotationRangeLabel = html.find('.rotation-range-label');\r\n      html.find('.rotation-slider').slider({\r\n        range: true,\r\n        min: -180,\r\n        max: 180,\r\n        values: settings.rotation,\r\n        slide: function (event, ui) {\r\n          rotationRangeLabel.text(`${ui.values[0]} - ${ui.values[1]}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ rotation: ui.values });\r\n        },\r\n      });\r\n\r\n      const scaleRangeLabel = html.find('.scale-range-label');\r\n      html.find('.scale-slider').slider({\r\n        range: true,\r\n        min: 0.1,\r\n        max: 4,\r\n        step: 0.01,\r\n        values: settings.scale,\r\n        slide: function (event, ui) {\r\n          scaleRangeLabel.text(`${ui.values[0]} - ${ui.values[1]}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ scale: ui.values });\r\n        },\r\n      });\r\n\r\n      const densityRangeLabel = html.find('.density-range-label');\r\n      html.find('.density-slider').slider({\r\n        range: false,\r\n        min: 0.01,\r\n        max: 4,\r\n        step: 0.01,\r\n        value: settings.density ?? 0.01,\r\n        slide: function (event, ui) {\r\n          densityRangeLabel.text(`${ui.value}`);\r\n        },\r\n        change: function (event, ui) {\r\n          app._updateBrushSettings({ density: ui.value });\r\n        },\r\n      });\r\n\r\n      this.setPosition({ height: 'auto' });\r\n    });\r\n\r\n    html.on('click', '.toggle-button', this._toggleSetting.bind(this));\r\n    html.find('.reset').on('click', this._resetToDefaults.bind(this));\r\n    html.on('click', '.preset', this._onClickPreset.bind(this));\r\n    html.on('contextmenu', '.preset', this._onRightClickPreset.bind(this));\r\n\r\n    // Colorize\r\n    html.on('click', '.randomize-color', this._onRandomizeColor.bind(this));\r\n    html.on('change', 'color-picker', this._onColorChange.bind(this));\r\n    html.on('input paste', 'color-picker input[type=\"text\"]', this._onColorChange.bind(this));\r\n    html.find('.colorizeControl').on('click', this._onColorMenu.bind(this));\r\n\r\n    html.find('.tmfxPresetControl').on('click', () => {\r\n      this._onEditTaglikeField({\r\n        label: 'TMFX',\r\n        name: 'tmfxPreset',\r\n        tags: this._settings.tmfxPreset,\r\n        simplifyTags: false,\r\n        listId: 'tmfxPresets',\r\n        listEntries: TokenMagic.getPresets().map((p) => p.name),\r\n      });\r\n    });\r\n    html.find('.taggerControl').on('click', () => {\r\n      this._onEditTaglikeField({\r\n        label: 'Tagger',\r\n        name: 'tagger',\r\n        tags: this._settings.tagger,\r\n        simplifyTags: false,\r\n      });\r\n    });\r\n  }\r\n\r\n  async _onEditTaglikeField({ label, name, tags, simplifyTags = true, listId, listEntries } = {}) {\r\n    const subMenu = this._toggleSubMenu(name);\r\n    if (!subMenu) return;\r\n\r\n    if (tags && !Array.isArray(tags)) tags = [tags];\r\n    const template = Handlebars.compile(\r\n      `{{tagInput name=name label=label tags=tags listId=listId listEntries=listEntries}}`\r\n    );\r\n    let content = template(\r\n      { name, label, tags, listId, listEntries },\r\n      {\r\n        allowProtoMethodsByDefault: true,\r\n        allowProtoPropertiesByDefault: true,\r\n      }\r\n    );\r\n\r\n    subMenu.html(content);\r\n    this.setPosition({ height: 'auto' });\r\n\r\n    TagInput.activateListeners(subMenu, {\r\n      change: (tags) => {\r\n        this.setPosition({ height: 'auto' });\r\n        this._updateBrushSettings({ [name]: tags.length ? tags : null });\r\n      },\r\n      simplifyTags,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Controls toggling of the sub-menu div container. The div is shared between many different controls, and behaviour\r\n   * depends on whether the same or different controls are being toggled\r\n   * @param {String} name a name of the control issuing a toggle\r\n   * @returns {Boolean} sub-menu element if sub-menu is to be rendered, null if sub-menu was emptied\r\n   */\r\n  _toggleSubMenu(name) {\r\n    const subMenu = this.element.find('.sub-menu');\r\n    if (subMenu.attr('data-control') === name) {\r\n      subMenu.html('').attr('data-control', null);\r\n      this.setPosition({ height: 'auto' });\r\n      return null;\r\n    } else subMenu.attr('data-control', name);\r\n    return subMenu;\r\n  }\r\n\r\n  async _onColorMenu(event) {\r\n    const subMenu = this._toggleSubMenu('colorize');\r\n    if (!subMenu) return;\r\n\r\n    const template = await getTemplate(`modules/${MODULE_ID}/templates/preset/brush/colorize.html`);\r\n    let content = template(await this.getData({}), {\r\n      allowProtoMethodsByDefault: true,\r\n      allowProtoPropertiesByDefault: true,\r\n    });\r\n\r\n    subMenu.html(content);\r\n    this.setPosition({ height: 'auto' });\r\n  }\r\n\r\n  async _onColorChange(event) {\r\n    let cString = $(event.currentTarget).val();\r\n    if (!cString) this._updateBrushSettings({ color: '' });\r\n    else {\r\n      let color = Color.fromString(cString);\r\n      if (!Number.isNaN(color.valueOf())) this._updateBrushSettings({ color: cString });\r\n    }\r\n  }\r\n\r\n  async _onClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    if (presetIndex != null) {\r\n      this._it = this._index.findIndex((i) => i.pI === presetIndex);\r\n      await this._activateBrush();\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onRandomizeColor() {\r\n    const randomColor = this._settings.randomColor ?? {};\r\n    const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n      method: 'random',\r\n      lockMethod: true,\r\n      space: randomColor.space,\r\n      hue: randomColor.hue,\r\n    });\r\n\r\n    let colorSlider;\r\n    let dialog = new Dialog({\r\n      title: `Pick Range`,\r\n      content: `<form>${colorTemp}</form>`,\r\n      buttons: {\r\n        save: {\r\n          label: 'Apply',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: {\r\n                method: 'random',\r\n                space: html.find('[name=\"space\"]').val(),\r\n                hue: html.find('[name=\"hue\"]').val(),\r\n                colors: colorSlider.getColors(),\r\n              },\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n        remove: {\r\n          label: 'Remove',\r\n          callback: async (html) => {\r\n            await this._updateBrushSettings({\r\n              randomColor: null,\r\n            });\r\n            this.render(true);\r\n          },\r\n        },\r\n      },\r\n      render: (html) => {\r\n        import('./randomizer/slider.js').then((module) => {\r\n          colorSlider = new module.ColorSlider(\r\n            html,\r\n            randomColor.colors ?? [\r\n              { hex: '#ff0000', offset: 0 },\r\n              { hex: '#ff0000', offset: 100 },\r\n            ]\r\n          );\r\n          setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n        });\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async _onRightClickPreset(event) {\r\n    const presetIndex = $(event.currentTarget).data('index');\r\n    const preset = this.presets[presetIndex];\r\n    if (preset) this.removePreset(preset.id);\r\n  }\r\n\r\n  async _resetToDefaults() {\r\n    await this._updateBrushSettings({\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      density: 1,\r\n      color: null,\r\n      randomColor: null,\r\n      tmfxPreset: null,\r\n      tagger: null,\r\n    });\r\n    this.render(true);\r\n  }\r\n\r\n  async _toggleSetting(event) {\r\n    const control = $(event.target).closest('.toggle-button');\r\n    const update = { [control.data('name')]: !control.hasClass('active') };\r\n\r\n    if (update.spawner) update.eraser = false;\r\n    if (update.eraser) update.spawner = false;\r\n\r\n    await this._updateBrushSettings(update);\r\n\r\n    if (update.random) await this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async _updateBrushSettings(update) {\r\n    foundry.utils.mergeObject(this._settings, update);\r\n    await game.settings.set(MODULE_ID, 'brush', this._settings);\r\n\r\n    if (update.hasOwnProperty('group')) this._createIndex();\r\n    await this._activateBrush();\r\n  }\r\n\r\n  addPresets(presets = []) {\r\n    for (const preset of presets) {\r\n      if (!this.presets.find((p) => p.uuid === preset.uuid)) this.presets.push(preset);\r\n    }\r\n    this._createIndex();\r\n    this.render(true);\r\n  }\r\n\r\n  removePreset(id) {\r\n    const presetIndex = this.presets.findIndex((p) => p.id === id);\r\n    if (presetIndex === -1) return;\r\n\r\n    const wasActivePreset = this._index[this._it]?.pI === presetIndex;\r\n\r\n    this.presets = this.presets.filter((p) => p.id !== id);\r\n    if (this.presets.length === 0) return this.close(true);\r\n\r\n    this._createIndex();\r\n\r\n    if (wasActivePreset) this.iterate();\r\n    else this.render(true);\r\n  }\r\n\r\n  async iterate(forward = true, force = false) {\r\n    if (force || !this._settings.lock) {\r\n      if (this._settings.random) this._it = Math.floor(Math.random() * this._index.length);\r\n      else {\r\n        this._it += forward ? 1 : -1;\r\n        if (this._it < 0) this._it = this._index.length - 1;\r\n        else this._it %= this._index.length;\r\n      }\r\n    } else {\r\n      if (this._it === -1) this._it = 0;\r\n    }\r\n\r\n    await this._activateBrush();\r\n    this.render(true);\r\n  }\r\n\r\n  /**\r\n   * Get transform to be immediately applied to the preset preview\r\n   * @returns {Object} e.g. { rotation: 45, scale: 0.8 }\r\n   */\r\n  _getTransform() {\r\n    const settings = this._settings;\r\n    const transform = {};\r\n\r\n    // Scale and Rotation transformation are accumulated on the picker\r\n    // We want to preserve these when rendering a new preview\r\n    const accumulatedTransform = Picker.getTransformAccumulator();\r\n\r\n    if (settings.scale[0] === settings.scale[1]) {\r\n      transform.scale = settings.scale[0];\r\n      transform.scale *= accumulatedTransform.scale;\r\n    } else {\r\n      const stepsInRange = (settings.scale[1] - settings.scale[0]) / 0.01;\r\n      transform.scale = Math.floor(Math.random() * stepsInRange) * 0.01 + settings.scale[0];\r\n      transform.scale *= accumulatedTransform.scale;\r\n    }\r\n\r\n    if (settings.rotation[0] === settings.rotation[1]) {\r\n      transform.rotation = settings.rotation[0];\r\n      transform.rotation += accumulatedTransform.rotation;\r\n    } else {\r\n      const stepsInRange = (settings.rotation[1] - settings.rotation[0] + 1) / 1;\r\n      transform.rotation = Math.floor(Math.random() * stepsInRange) * 1 + settings.rotation[0];\r\n    }\r\n\r\n    return transform;\r\n  }\r\n\r\n  _deactivateCallback() {\r\n    this.close(true);\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-brush-macro',\r\n      icon: 'fa-solid fa-code',\r\n      onclick: this._generateBrushMacro.bind(this),\r\n    });\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _generateBrushMacro() {\r\n    const genMacro = async function (command) {\r\n      const macro = await Macro.create({\r\n        name: 'Brush Macro',\r\n        type: 'script',\r\n        scope: 'global',\r\n        command,\r\n        img: `modules/${MODULE_ID}/images/brush_icon.png`,\r\n      });\r\n      macro.sheet.render(true);\r\n    };\r\n\r\n    const genUUIDS = function () {\r\n      const uuids = this.presets.map((p) => p.uuid).filter(Boolean);\r\n      if (!uuids.length) return;\r\n\r\n      const command = `MassEdit.openBrushMenu({ \r\n    uuid: ${JSON.stringify(uuids, null, 4)}\r\n  },\r\n  ${JSON.stringify(this._settings, null, 2)}\r\n  );`;\r\n      genMacro(command);\r\n    };\r\n\r\n    const genNames = function () {\r\n      const opts = this.presets.map((p) => {\r\n        return { name: p.name, type: p.documentName };\r\n      });\r\n\r\n      const command = `MassEdit.openBrushMenu(\r\n    ${JSON.stringify(opts, null, 4)}\r\n  ,\r\n  ${JSON.stringify(this._settings, null, 2)}\r\n  );`;\r\n      genMacro(command);\r\n    };\r\n\r\n    let dialog = new Dialog({\r\n      title: `Generate Macro`,\r\n      content: ``,\r\n      buttons: {\r\n        uuids: {\r\n          label: 'UUIDs',\r\n          callback: genUUIDS.bind(this),\r\n        },\r\n        name: {\r\n          label: 'Names',\r\n          callback: genNames.bind(this),\r\n        },\r\n      },\r\n    });\r\n\r\n    dialog.render(true);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    Brush.deactivate();\r\n    BrushMenu._instance = null;\r\n    Picker.destroy();\r\n    Picker.resetTransformAccumulator();\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\n/**\r\n * API method to activate the brush.\r\n * @param {Object} options See MassEdit.getPreset(...)\r\n * @param {String} mode update|spawn\r\n */\r\nexport async function activateBrush(options, mode = 'spawner') {\r\n  const preset = await PresetAPI.getPreset(options);\r\n  if (preset) {\r\n    Brush.activate({ preset, spawner: mode === 'spawner' });\r\n  }\r\n}\r\n\r\n/**\r\n * API method to de-activate the brush.\r\n */\r\nexport function deactivateBush() {\r\n  Brush.deactivate();\r\n}\r\n\r\n/**\r\n * Open Brush Menu using the provided presets\r\n * @param {Object} options See MassEdit.getPresets(...)\r\n * @param {Object} settings Brush Menu control settings\r\n */\r\nexport async function openBrushMenu(options, settings = {}) {\r\n  if (BrushMenu.isActive()) return BrushMenu.close();\r\n\r\n  let presets = [];\r\n\r\n  if (Array.isArray(options)) {\r\n    for (const opts of options) {\r\n      let preset = await PresetAPI.getPreset(opts);\r\n      if (preset) presets.push(preset);\r\n    }\r\n  } else {\r\n    presets = await PresetAPI.getPresets(options);\r\n  }\r\n\r\n  if (!presets?.length) return;\r\n  await PresetCollection.batchLoadPresets(presets);\r\n  BrushMenu.render(presets, settings);\r\n}\r\n","export const MODULE_ID = 'multi-token-edit';\r\nexport const SUPPORTED_PLACEABLES = [\r\n  'Token',\r\n  'MeasuredTemplate',\r\n  'Tile',\r\n  'Drawing',\r\n  'Wall',\r\n  'AmbientLight',\r\n  'AmbientSound',\r\n  'Note',\r\n  'Region',\r\n];\r\nexport const UI_DOCS = ['Bag', 'Scene', 'ALL', ...SUPPORTED_PLACEABLES];\r\nexport const SUPPORTED_SHEET_CONFIGS = [...SUPPORTED_PLACEABLES, 'Actor', 'PlaylistSound', 'Scene'];\r\nexport const SUPPORTED_COLLECTIONS = ['Item', 'Cards', 'RollTable', 'Actor', 'JournalEntry', 'Scene'];\r\n\r\nexport const IMAGE_EXTENSIONS = ['webp', 'jpg', 'jpeg', 'png', 'svg', 'apng', 'avif', 'bmp', 'gif', 'tif'];\r\nexport const VIDEO_EXTENSIONS = ['mp4', 'ogv', 'webm', 'm4v'];\r\nexport const AUDIO_EXTENSIONS = ['aac', 'flac', 'm4a', 'mid', 'mp3', 'ogg', 'opus', 'wav'];\r\nexport const FILE_EXTENSIONS = [...IMAGE_EXTENSIONS, ...VIDEO_EXTENSIONS, ...AUDIO_EXTENSIONS];\r\n\r\nexport const LINKER_DOC_ICONS = {\r\n  Token: 'modules/multi-token-edit/images/linker/person-fill.svg',\r\n  MeasuredTemplate: 'modules/multi-token-edit/images/linker/rulers.svg',\r\n  Tile: 'modules/multi-token-edit/images/linker/boxes.svg',\r\n  Drawing: 'modules/multi-token-edit/images/linker/pencil-fill.svg',\r\n  Wall: 'modules/multi-token-edit/images/linker/bricks.svg',\r\n  AmbientLight: 'modules/multi-token-edit/images/linker/lightbulb-fill.svg',\r\n  AmbientSound: 'modules/multi-token-edit/images/linker/music-note-beamed.svg',\r\n  Note: 'modules/multi-token-edit/images/linker/bookmark-fill.svg',\r\n  Region: 'modules/multi-token-edit/images/linker/border-outer.svg',\r\n};\r\n\r\nexport const LINKER_DOC_COLORS = {\r\n  Token: 0xcec66e,\r\n  MeasuredTemplate: 0xff0000,\r\n  Tile: 0x23e230,\r\n  Drawing: 0xe223ce,\r\n  Wall: 0xb7b7b7,\r\n  AmbientLight: 0xffff00,\r\n  AmbientSound: 0x00e3ff,\r\n  Note: 0xffffff,\r\n  Region: 0xdc006b,\r\n};\r\n\r\nexport const PIVOTS = {\r\n  TOP_LEFT: 0,\r\n  TOP: 1,\r\n  TOP_RIGHT: 2,\r\n  LEFT: 3,\r\n  CENTER: 4,\r\n  RIGHT: 5,\r\n  BOTTOM_LEFT: 6,\r\n  BOTTOM: 7,\r\n  BOTTOM_RIGHT: 8,\r\n};\r\n\r\nexport const THRESHOLDS = {\r\n  PIXEL_PERFECT_ALPHA: 0.75,\r\n};\r\n","class PlaylistSoundDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('lvolume' in formData) {\r\n      formData['volume'] = AudioHelper.inputToVolume(formData['lvolume']);\r\n      delete formData['lvolume'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    data['lvolume'] = (note.document ?? note).volume;\r\n  }\r\n\r\n  static updateToForm(update) {\r\n    if ('volume' in update) {\r\n      update['lvolume'] = AudioHelper.volumeToInput(update['volume']);\r\n      delete update.volume;\r\n    }\r\n  }\r\n}\r\n\r\nclass NoteDataAdapter {\r\n  static formToData(obj, formData) {\r\n    if ('icon.selected' in formData || 'icon.custom' in formData) {\r\n      formData['texture.src'] = formData['icon.selected'] || formData['icon.custom'];\r\n      delete formData['icon.selected'];\r\n      delete formData['icon.custom'];\r\n    }\r\n  }\r\n\r\n  static dataToForm(note, data) {\r\n    const doc = note.document ?? note;\r\n    if (doc.texture?.src != null) {\r\n      data['icon.selected'] = doc.texture.src;\r\n      data['icon.custom'] = doc.texture.src;\r\n    }\r\n  }\r\n}\r\n\r\nexport class TokenDataAdapter {\r\n  static updateToForm(update) {\r\n    if ('texture.scaleX' in update) {\r\n      update.mirrorX = update['texture.scaleX'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleX']);\r\n    }\r\n    if ('texture.scaleY' in update) {\r\n      update.mirrorY = update['texture.scaleY'] < 0;\r\n      update.scale = Math.abs(update['texture.scaleY']);\r\n    }\r\n  }\r\n\r\n  static dataToForm(token, data) {\r\n    const doc = token.document ?? token;\r\n    if (doc.texture?.scaleX != null) data.scale = Math.abs(doc.texture.scaleX);\r\n    if (doc.texture?.scaleX != null) data.mirrorX = doc.texture.scaleX < 0;\r\n    if (doc.texture?.scaleY != null) data.mirrorY = doc.texture.scaleY < 0;\r\n  }\r\n\r\n  static formToData(token, formData) {\r\n    const doc = token.document ?? token;\r\n\r\n    // Scale/mirroring\r\n    if ('scale' in formData || 'mirrorX' in formData || 'mirrorY' in formData) {\r\n      if (!('scale' in formData)) formData.scale = Math.abs(doc.texture.scaleX);\r\n      if (!('mirrorX' in formData)) formData.mirrorX = doc.texture.scaleX < 0;\r\n      if (!('mirrorY' in formData)) formData.mirrorY = doc.texture.scaleY < 0;\r\n      formData['texture.scaleX'] = formData.scale * (formData.mirrorX ? -1 : 1);\r\n      formData['texture.scaleY'] = formData.scale * (formData.mirrorY ? -1 : 1);\r\n      ['scale', 'mirrorX', 'mirrorY'].forEach((k) => delete formData[k]);\r\n    }\r\n\r\n    // Detection modes\r\n    TokenDataAdapter.correctDetectionModes(doc, formData);\r\n  }\r\n\r\n  static correctDetectionModeOrder(data, randomizeFields) {\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          i++;\r\n        }\r\n        const newKey = `detectionModes.${indexMap[comps[1]]}.${comps[2]}`;\r\n        delete data[k];\r\n        data[newKey] = v;\r\n        if (randomizeFields && k in randomizeFields) {\r\n          const rVal = randomizeFields[k];\r\n          delete randomizeFields[k];\r\n          randomizeFields[newKey] = rVal;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static detectionModeMatch(searchModes, tokenModes) {\r\n    for (const m1 of searchModes) {\r\n      if (!('id' in m1)) continue; // Ignore mode search attempts without ids as they can't be matched up\r\n      for (const m2 of tokenModes) {\r\n        if (m1.id === m2.id) {\r\n          if ('enabled' in m1 && m1.enabled !== m2.enabled) return false;\r\n          if ('range' in m1 && m1.range !== m2.range) return false;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  static correctDetectionModes(token, data) {\r\n    const detectionModes = [];\r\n    const indexMap = {};\r\n    let i = 0;\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (k.startsWith('detectionModes')) {\r\n        const comps = k.split('.');\r\n        if (!(comps[1] in indexMap)) {\r\n          indexMap[comps[1]] = i;\r\n          detectionModes.push({});\r\n          i++;\r\n        }\r\n        const dm = detectionModes[indexMap[comps[1]]];\r\n        dm[comps[2]] = v;\r\n        // data[`${comps[0]}.${indexMap[comps[1]]}.${comps[2]}`] = v;\r\n        delete data[k];\r\n      }\r\n    }\r\n\r\n    if (!detectionModes.length) return;\r\n\r\n    // Merge current detectionModes assigned to the token and the new ones being added\r\n    const mergedModes = foundry.utils.deepClone(token.detectionModes).filter((d) => d.id);\r\n    for (const dm of detectionModes) {\r\n      if (dm.id == null) continue;\r\n\r\n      let found = false;\r\n      for (const tdm of mergedModes) {\r\n        if (tdm.id === dm.id) {\r\n          foundry.utils.mergeObject(tdm, dm);\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n      if (!found) mergedModes.push(foundry.utils.mergeObject({ id: '', range: 0, enabled: true }, dm));\r\n    }\r\n    data.detectionModes = mergedModes;\r\n  }\r\n\r\n  static modifyPresetData(app, data) {\r\n    const pModes = Object.values(foundry.utils.expandObject(data)?.detectionModes || {});\r\n    if (!pModes.length) return;\r\n\r\n    const modes = Object.values(foundry.utils.expandObject(app._getSubmitData())?.detectionModes || {});\r\n\r\n    const dataClone = foundry.utils.deepClone(data);\r\n    const randomize = data['mass-edit-randomize'] ?? {};\r\n    const addSubtract = data['mass-edit-addSubtract'] ?? {};\r\n\r\n    const modCustomFields = function (fields, key, i, k, data) {\r\n      if (`detectionModes.${i}.${k}` in fields) {\r\n        delete fields[`detectionModes.${i}.${k}`];\r\n        fields[`detectionModes.${j}.${k}`] = data[key][`detectionModes.${i}.${k}`];\r\n      }\r\n    };\r\n\r\n    const startingModeLength = modes.length;\r\n    for (let i = 0; i < pModes.length; i++) {\r\n      if (!('id' in pModes[i])) continue;\r\n      let found = false;\r\n      for (let j = 0; j < startingModeLength; j++) {\r\n        if (pModes[i].id === modes[j].id) {\r\n          found = true;\r\n          Object.keys(pModes[i]).forEach((k) => {\r\n            delete data[`detectionModes.${i}.${k}`];\r\n            data[`detectionModes.${j}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n            modCustomFields(randomize, 'mass-edit-randomize', i, k, dataClone);\r\n            modCustomFields(addSubtract, 'mass-edit-addSubtract', i, k, dataClone);\r\n          });\r\n        }\r\n      }\r\n      if (!found) {\r\n        modes.push({ id: '', range: 0, enabled: true });\r\n        Object.keys(pModes[i]).forEach((k) => {\r\n          delete data[`detectionModes.${i}.${k}`];\r\n          data[`detectionModes.${modes.length - 1}.${k}`] = dataClone[`detectionModes.${i}.${k}`];\r\n\r\n          if (`detectionModes.${i}.${k}` in randomize) {\r\n            delete randomize[`detectionModes.${i}.${k}`];\r\n            randomize[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-randomize'][`detectionModes.${i}.${k}`];\r\n          }\r\n          if (`detectionModes.${i}.${k}` in addSubtract) {\r\n            delete addSubtract[`detectionModes.${i}.${k}`];\r\n            addSubtract[`detectionModes.${modes.length - 1}.${k}`] =\r\n              dataClone['mass-edit-addSubtract'][`detectionModes.${i}.${k}`];\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    if (startingModeLength !== modes.length) {\r\n      app._previewChanges({ detectionModes: modes });\r\n      app.render();\r\n      return true;\r\n    }\r\n  }\r\n}\r\n\r\nconst ADAPTERS = {\r\n  Token: TokenDataAdapter,\r\n  PlaylistSound: PlaylistSoundDataAdapter,\r\n  Note: NoteDataAdapter,\r\n};\r\n\r\nexport class GeneralDataAdapter {\r\n  static formToData(documentName, obj, formData) {\r\n    const adapter = ADAPTERS[documentName];\r\n    if (adapter && adapter.formToData) {\r\n      adapter.formToData(obj, formData);\r\n    }\r\n  }\r\n\r\n  static dataToForm(documentName, obj, formData) {\r\n    const adapter = ADAPTERS[documentName];\r\n    if (adapter && adapter.dataToForm) {\r\n      adapter.dataToForm(obj, formData);\r\n    }\r\n  }\r\n\r\n  static updateToForm(documentName, update) {\r\n    const adapter = ADAPTERS[documentName];\r\n    if (adapter && adapter.updateToForm) {\r\n      adapter.updateToForm(update);\r\n    }\r\n  }\r\n}\r\n","import { MODULE_ID } from '../constants';\r\nimport { Scenescape } from '../scenescape/scenescape';\r\n\r\nexport class DataTransformer {\r\n  /**\r\n   * Transform placeable data and optionally an accompanying preview with the provided delta transform\r\n   * @param {String} documentName\r\n   * @param {Object} data\r\n   * @param {Object} origin\r\n   * @param {Object} transform\r\n   * @param {PlaceableObject} preview\r\n   */\r\n  static apply(documentName, data, origin, transform, preview) {\r\n    if (transform.x == null) transform.x = 0;\r\n    if (transform.y == null) transform.y = 0;\r\n\r\n    this._3dActive = game.Levels3DPreview?._active;\r\n\r\n    if (documentName === 'Wall') {\r\n      this.transformWall(data, origin, transform, preview);\r\n    } else if (documentName === 'Tile') {\r\n      this.transformTile(data, origin, transform, preview);\r\n    } else if (documentName == 'Note') {\r\n      this.transformNote(data, origin, transform, preview);\r\n    } else if (documentName === 'Token') {\r\n      this.transformToken(data, origin, transform, preview);\r\n    } else if (documentName === 'MeasuredTemplate') {\r\n      this.transformMeasuredTemplate(data, origin, transform, preview);\r\n    } else if (documentName === 'AmbientLight') {\r\n      this.transformAmbientLight(data, origin, transform, preview);\r\n    } else if (documentName === 'AmbientSound') {\r\n      this.transformAmbientSound(data, origin, transform, preview);\r\n    } else if (documentName === 'Drawing') {\r\n      this.transformDrawing(data, origin, transform, preview);\r\n    } else if (documentName === 'Region') {\r\n      this.transformRegion(data, origin, transform, preview);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  static applyToMap(docToData, origin, transform) {\r\n    docToData.forEach((dataArr, documentName) => {\r\n      dataArr.forEach((data) => DataTransformer.apply(documentName, data, origin, transform));\r\n    });\r\n  }\r\n\r\n  static transformRegion(data, origin, transform, preview) {\r\n    if (transform.scale != null && data.shapes) {\r\n      const scale = transform.scale;\r\n\r\n      for (const shape of data.shapes) {\r\n        if (shape.type === 'polygon') {\r\n          for (let i = 0; i < shape.points.length; i++) {\r\n            shape.points[i] *= scale;\r\n          }\r\n        } else {\r\n          shape.x *= scale;\r\n          shape.y *= scale;\r\n          if (shape.type === 'ellipse') {\r\n            shape.radiusX *= scale;\r\n            shape.radiusY *= scale;\r\n          } else if (shape.type === 'rectangle') {\r\n            shape.height *= scale;\r\n            shape.width *= scale;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (data.shapes) {\r\n      data.shapes.forEach((shape) => {\r\n        if (shape.type === 'polygon') {\r\n          for (let i = 0; i < shape.points.length; i += 2) {\r\n            try {\r\n              shape.points[i] += transform.x;\r\n              shape.points[i + 1] += transform.y;\r\n            } catch (e) {\r\n              console.log(shape, transform);\r\n            }\r\n          }\r\n        } else {\r\n          shape.x += transform.x;\r\n          shape.y += transform.y;\r\n        }\r\n      });\r\n    }\r\n    if (transform.z) {\r\n      if (Number.isNumeric(data.elevation?.bottom)) data.elevation.bottom += transform.z;\r\n      if (Number.isNumeric(data.elevation?.top)) data.elevation.top += transform.z;\r\n    }\r\n\r\n    if (transform.rotation != null && data.shapes) {\r\n      for (const shape of data.shapes) {\r\n        if (shape.type === 'rectangle') {\r\n          // Foundry does not support rotation for rectangles\r\n          // Convert it to a polygon instead\r\n          shape.type = 'polygon';\r\n          shape.points = [\r\n            shape.x,\r\n            shape.y,\r\n            shape.x + shape.width,\r\n            shape.y,\r\n            shape.x + shape.width,\r\n            shape.y + shape.height,\r\n            shape.x,\r\n            shape.y + shape.height,\r\n          ];\r\n          delete shape.width;\r\n          delete shape.height;\r\n          delete shape.x;\r\n          delete shape.y;\r\n          delete shape.rotation;\r\n        }\r\n        if (shape.type === 'polygon') {\r\n          const dr = Math.toRadians(transform.rotation % 360);\r\n          for (let i = 0; i < shape.points.length; i += 2) {\r\n            [shape.points[i], shape.points[i + 1]] = this.rotatePoint(\r\n              origin.x,\r\n              origin.y,\r\n              shape.points[i],\r\n              shape.points[i + 1],\r\n              dr\r\n            );\r\n          }\r\n        } else {\r\n          const dr = Math.toRadians(transform.rotation % 360);\r\n          let rectCenter = {\r\n            x: shape.x + (shape.radiusX ?? shape.width) / 2,\r\n            y: shape.y + (shape.radiusY ?? shape.height) / 2,\r\n          };\r\n          [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n          shape.x = rectCenter.x - (shape.radiusX ?? shape.width) / 2;\r\n          shape.y = rectCenter.y - (shape.radiusY ?? shape.height) / 2;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      for (const shape of data.shapes) {\r\n        if (shape.type === 'rectangle' || shape.type === 'ellipse') {\r\n          const rectCenter = {\r\n            x: shape.x + (shape.width ?? shape.radiusX) / 2,\r\n            y: shape.y + (shape.height ?? shape.radiusY) / 2,\r\n          };\r\n          if (transform.mirrorX) {\r\n            rectCenter.x = origin.x - (rectCenter.x - origin.x);\r\n            shape.x = rectCenter.x - (shape.width ?? shape.radiusX) / 2;\r\n          }\r\n          if (transform.mirrorY) {\r\n            rectCenter.y = origin.y - (rectCenter.y - origin.y);\r\n            shape.y = rectCenter.y - (shape.height ?? shape.radiusY) / 2;\r\n          }\r\n        } else if (shape.type === 'polygon') {\r\n          if (transform.mirrorX) {\r\n            for (let i = 0; i < shape.points.length; i += 2) {\r\n              shape.points[i] = origin.x - (shape.points[i] - origin.x);\r\n            }\r\n          }\r\n          if (transform.mirrorY) {\r\n            for (let i = 1; i < shape.points.length; i += 2) {\r\n              shape.points[i] = origin.y - (shape.points[i] - origin.y);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n      if (data.shapes) {\r\n        for (let i = 0; i < data.shapes.length; i++) {\r\n          const docShape = doc.shapes[i];\r\n          const dataShape = data.shapes[i];\r\n\r\n          if (docShape.type !== dataShape.type) {\r\n            // We've performed a type change (rectangle -> polygon)\r\n            doc.shapes[i] = new foundry.data.PolygonShapeData(dataShape);\r\n          } else if (docShape.type === 'polygon') {\r\n            docShape.points = dataShape.points;\r\n          } else {\r\n            docShape.x = dataShape.x;\r\n            docShape.y = dataShape.y;\r\n\r\n            if (docShape.type === 'rectangle') {\r\n              docShape.width = dataShape.width;\r\n              docShape.height = dataShape.height;\r\n            } else if (docShape.type === 'ellipse') {\r\n              docShape.radiusX = dataShape.radiusX;\r\n              docShape.radiusY = dataShape.radiusY;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformNote(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (transform.mirrorX) {\r\n      data.x = origin.x - (data.x - origin.x);\r\n    }\r\n    if (transform.mirrorY) {\r\n      data.y = origin.y - (data.y - origin.y);\r\n    }\r\n\r\n    if (preview) {\r\n      preview.document.x = data.x;\r\n      preview.document.y = data.y;\r\n      if (data.elevation) preview.document.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformAmbientSound(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.radius *= scale;\r\n      }\r\n\r\n      if (this._3dActive && data.elevation != null) {\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    // 3D Support\r\n    if (transform.z != null) {\r\n      data.elevation = (data.elevation ?? 0) + transform.z;\r\n    }\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n    }\r\n\r\n    if (transform.mirrorX) {\r\n      data.x = origin.x - (data.x - origin.x);\r\n    }\r\n    if (transform.mirrorY) {\r\n      data.y = origin.y - (data.y - origin.y);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.radius = data.radius;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformWall(data, origin, transform, preview) {\r\n    if (!data.c) return;\r\n\r\n    const c = foundry.utils.deepClone(data.c);\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      c[0] *= scale;\r\n      c[1] *= scale;\r\n      c[2] *= scale;\r\n      c[3] *= scale;\r\n    }\r\n\r\n    c[0] += transform.x;\r\n    c[1] += transform.y;\r\n    c[2] += transform.x;\r\n    c[3] += transform.y;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [c[0], c[1]] = this.rotatePoint(origin.x, origin.y, c[0], c[1], dr);\r\n      [c[2], c[3]] = this.rotatePoint(origin.x, origin.y, c[2], c[3], dr);\r\n    }\r\n\r\n    if (transform.mirrorX) {\r\n      c[0] = origin.x - (c[0] - origin.x);\r\n      c[2] = origin.x - (c[2] - origin.x);\r\n    }\r\n    if (transform.mirrorY) {\r\n      c[1] = origin.y - (c[1] - origin.y);\r\n      c[3] = origin.y - (c[3] - origin.y);\r\n    }\r\n\r\n    data.c = c;\r\n    if (preview) preview.document.c = c;\r\n  }\r\n\r\n  static transformMeasuredTemplate(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.distance *= scale;\r\n        if (data.width) data.width *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.direction += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      if (transform.mirrorX) {\r\n        data.x = origin.x - (data.x - origin.x);\r\n        if (data.direction > 180) data.direction = 360 - (data.direction - 180);\r\n        else data.direction = 180 - data.direction;\r\n      }\r\n      if (transform.mirrorY) {\r\n        data.y = origin.y - (data.y - origin.y);\r\n        data.direction = 180 - (data.direction - 180);\r\n      }\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.direction = data.direction;\r\n      doc.distance = data.distance;\r\n      doc.width = data.width;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformAmbientLight(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale && data.config) {\r\n        data.config.dim *= scale;\r\n        data.config.bright *= scale;\r\n      }\r\n\r\n      if (this._3dActive && data.elevation != null) {\r\n        data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      [data.x, data.y] = this.rotatePoint(origin.x, origin.y, data.x, data.y, dr);\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      if (transform.mirrorX) {\r\n        data.x = origin.x - (data.x - origin.x);\r\n        data.rotation = 180 - (data.rotation - 180);\r\n      }\r\n      if (transform.mirrorY) {\r\n        data.y = origin.y - (data.y - origin.y);\r\n        if (data.rotation > 180) data.rotation = 360 - (data.rotation - 180);\r\n        else data.rotation = 180 - data.rotation;\r\n      }\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.rotation = data.rotation;\r\n      if (data.config) {\r\n        doc.config.dim = data.config.dim;\r\n        doc.config.bright = data.config.bright;\r\n      }\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n\r\n      if (preview._l3dPreview) {\r\n        const pos = game.Levels3DPreview.ruler.constructor.posCanvasTo3d({\r\n          x: doc.x,\r\n          y: doc.y,\r\n          z: doc.elevation,\r\n        });\r\n        const mesh = preview._l3dPreview.mesh;\r\n        mesh.position.x = pos.x;\r\n        mesh.position.y = pos.y;\r\n        mesh.position.z = pos.z;\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformTile(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.width *= scale;\r\n      data.height *= scale;\r\n\r\n      // 3D Support\r\n      if (this._3dActive) {\r\n        const depth = data.flags?.['levels-3d-preview']?.depth;\r\n        if (depth != null && depth != '') data.flags['levels-3d-preview'].depth = depth * scale;\r\n        if (data.elevation != null) {\r\n          data.elevation *= scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.width / 2, y: data.y + data.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.width / 2;\r\n      data.y = rectCenter.y - data.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      let rectCenter = { x: data.x + data.width / 2, y: data.y + data.height / 2 };\r\n      if (transform.mirrorX) {\r\n        rectCenter.x = origin.x - (rectCenter.x - origin.x);\r\n        data.texture.scaleX *= -1;\r\n        data.x = rectCenter.x - data.width / 2;\r\n      }\r\n      if (transform.mirrorY) {\r\n        rectCenter.y = origin.y - (rectCenter.y - origin.y);\r\n        data.texture.scaleY *= -1;\r\n        data.y = rectCenter.y - data.height / 2;\r\n      }\r\n      data.rotation = 180 - (data.rotation - 180);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n      doc.rotation = data.rotation;\r\n      doc.texture.scaleX = data.texture.scaleX;\r\n      doc.texture.scaleY = data.texture.scaleY;\r\n      if (data.elevation != null) doc.elevation = data.elevation;\r\n\r\n      if (preview._l3dPreview && preview._l3dPreview.mesh) {\r\n        const pos = game.Levels3DPreview.ruler.constructor.posCanvasTo3d({\r\n          x: doc.x + doc.width / 2,\r\n          y: doc.y + doc.height / 2,\r\n          z: doc.elevation,\r\n        });\r\n        const mesh = preview._l3dPreview.mesh;\r\n        mesh.position.x = pos.x;\r\n        mesh.position.y = pos.y;\r\n        mesh.position.z = pos.z;\r\n\r\n        if (transform.scale != null) {\r\n          mesh.scale.multiplyScalar(transform.scale);\r\n        }\r\n        if (transform.rotation != null) {\r\n          mesh.rotation.y += game.Levels3DPreview.THREE.MathUtils.degToRad(-transform.rotation);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static transformDrawing(data, origin, transform, preview) {\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      data.shape.width *= scale;\r\n      data.shape.height *= scale;\r\n      if (data.shape.points) {\r\n        const points = data.shape.points;\r\n        for (let i = 0; i < points.length; i++) {\r\n          points[i] *= scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = { x: data.x + data.shape.width / 2, y: data.y + data.shape.height / 2 };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - data.shape.width / 2;\r\n      data.y = rectCenter.y - data.shape.height / 2;\r\n      data.rotation += Math.toDegrees(dr);\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      const rectCenter = { x: data.x + data.shape.width / 2, y: data.y + data.shape.height / 2 };\r\n\r\n      if (transform.mirrorX) {\r\n        data.x = origin.x - (rectCenter.x - origin.x);\r\n        if (data.shape.points) {\r\n          const points = data.shape.points;\r\n          for (let i = 0; i < points.length; i += 2) {\r\n            points[i] = data.shape.width / 2 - (points[i] - data.shape.width / 2);\r\n          }\r\n        }\r\n        data.x = rectCenter.x - data.shape.width / 2;\r\n      }\r\n\r\n      if (transform.mirrorY) {\r\n        data.y = origin.y - (rectCenter.y - origin.y);\r\n        if (data.shape.points) {\r\n          const points = data.shape.points;\r\n          for (let i = 1; i < points.length; i += 2) {\r\n            points[i] = data.shape.height / 2 - (points[i] - data.shape.height / 2);\r\n          }\r\n        }\r\n        data.y = rectCenter.y - data.shape.height / 2;\r\n      }\r\n\r\n      data.rotation = 180 - (data.rotation - 180);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.shape.width = data.shape.width;\r\n      doc.shape.height = data.shape.height;\r\n      doc.shape.points = data.shape.points;\r\n      doc.rotation = data.rotation;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n    }\r\n  }\r\n\r\n  static transformToken(data, origin, transform, preview) {\r\n    if (Scenescape.active) {\r\n      if (data.flags?.[MODULE_ID]?.width != null) data.width = data.flags[MODULE_ID].width;\r\n      if (data.flags?.[MODULE_ID]?.height != null) data.height = data.flags[MODULE_ID].height;\r\n    }\r\n\r\n    if (transform.scale != null) {\r\n      const scale = transform.scale;\r\n      data.x *= scale;\r\n      data.y *= scale;\r\n      if (!transform.gridScale) {\r\n        data.width *= scale;\r\n        data.height *= scale;\r\n        if (this._3dActive) data.elevation *= scale;\r\n      }\r\n    }\r\n\r\n    data.x += transform.x;\r\n    data.y += transform.y;\r\n    if (data.elevation != null) data.elevation += transform.z ?? 0;\r\n\r\n    const grid = canvas.grid;\r\n    if (transform.rotation != null) {\r\n      const dr = Math.toRadians(transform.rotation % 360);\r\n      let rectCenter = {\r\n        x: data.x + (data.width * grid.sizeX) / 2,\r\n        y: data.y + (data.height * grid.sizeY) / 2,\r\n      };\r\n      [rectCenter.x, rectCenter.y] = this.rotatePoint(origin.x, origin.y, rectCenter.x, rectCenter.y, dr);\r\n      data.x = rectCenter.x - (data.width * grid.sizeX) / 2;\r\n      data.y = rectCenter.y - (data.height * grid.sizeY) / 2;\r\n      data.rotation = (data.rotation + Math.toDegrees(dr)) % 360;\r\n    }\r\n\r\n    if (transform.mirrorX || transform.mirrorY) {\r\n      let rectCenter = {\r\n        x: data.x + (data.width * grid.sizeX) / 2,\r\n        y: data.y + (data.height * grid.sizeY) / 2,\r\n      };\r\n      if (transform.mirrorX) {\r\n        rectCenter.x = origin.x - (rectCenter.x - origin.x);\r\n        data.texture.scaleX *= -1;\r\n        data.x = rectCenter.x - (data.width * grid.sizeX) / 2;\r\n      }\r\n      if (transform.mirrorY) {\r\n        rectCenter.y = origin.y - (rectCenter.y - origin.y);\r\n        data.texture.scaleY *= -1;\r\n        data.y = rectCenter.y - (data.height * grid.sizeY) / 2;\r\n      }\r\n      data.rotation = 180 - (data.rotation - 180);\r\n    }\r\n\r\n    if (Scenescape.active) {\r\n      if (data.width != null) foundry.utils.setProperty(data, `flags.${MODULE_ID}.width`, data.width);\r\n      if (data.height != null) foundry.utils.setProperty(data, `flags.${MODULE_ID}.height`, data.height);\r\n    }\r\n\r\n    if (preview) {\r\n      const doc = preview.document;\r\n      doc.x = data.x;\r\n      doc.y = data.y;\r\n      doc.elevation = data.elevation;\r\n      doc.rotation = data.rotation;\r\n      doc.width = data.width;\r\n      doc.height = data.height;\r\n      if (Scenescape.active) {\r\n        if (data.width != null) foundry.utils.setProperty(doc, `flags.${MODULE_ID}.width`, data.width);\r\n        if (data.height != null) foundry.utils.setProperty(doc, `flags.${MODULE_ID}.height`, data.height);\r\n      }\r\n      doc.texture.scaleX = data.texture.scaleX;\r\n      doc.texture.scaleY = data.texture.scaleY;\r\n      if (data.elevation) doc.elevation = data.elevation;\r\n      if (preview.hasOwnProperty('_l3dPreview')) {\r\n        preview._l3dPreview = game.Levels3DPreview.tokens[preview.id];\r\n        if (!preview._l3dPreview) return;\r\n\r\n        const pos = game.Levels3DPreview.ruler.constructor.posCanvasTo3d({\r\n          x: doc.x + (doc.width * canvas.grid.sizeX) / 2,\r\n          y: doc.y + (doc.height * canvas.grid.sizeY) / 2,\r\n          z: doc.elevation,\r\n        });\r\n        const mesh = preview._l3dPreview.mesh;\r\n        mesh.position.x = pos.x;\r\n        mesh.position.y = pos.y;\r\n        mesh.position.z = pos.z;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rotates one point around the other\r\n   * @param {Number} x pivot point\r\n   * @param {Number} y pivot point\r\n   * @param {Number} x2 point to be rotated\r\n   * @param {Number} y2 point to be rotated\r\n   * @param {Number} rot rotation in radians\r\n   * @returns\r\n   */\r\n  static rotatePoint(x, y, x2, y2, rot) {\r\n    const dx = x2 - x,\r\n      dy = y2 - y;\r\n    return [x + Math.cos(rot) * dx - Math.sin(rot) * dy, y + Math.sin(rot) * dx + Math.cos(rot) * dy];\r\n  }\r\n}\r\n","import { LAYER_MAPPINGS, showMassSelect } from '../applications/multiConfig.js';\r\nimport { SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES } from './constants.js';\r\nimport { localFormat, localize } from './utils.js';\r\n\r\nexport function showPlaceableTypeSelectDialog() {\r\n  let content = '';\r\n  for (const config of SUPPORTED_PLACEABLES.concat(SUPPORTED_COLLECTIONS)) {\r\n    content += `<option value=\"${config}\">${config}</option>`;\r\n  }\r\n  content = `<label>${localize('dialog.search-document')}</label>\r\n    <select style=\"width: 100%;\" name=\"documentName\">${content}</select>`;\r\n\r\n  new Dialog({\r\n    title: 'Document SEARCH',\r\n    content: content,\r\n    buttons: {\r\n      select: {\r\n        icon: '<i class=\"fas fa-check\"></i>',\r\n        label: 'Select',\r\n        callback: (html) => {\r\n          const documentName = html.find(\"select[name='documentName']\").val();\r\n\r\n          let docs = [];\r\n          if (SUPPORTED_PLACEABLES.includes(documentName)) {\r\n            const layer = LAYER_MAPPINGS[documentName];\r\n            if (layer && canvas[layer].placeables.length) {\r\n              docs = canvas[layer].placeables;\r\n            }\r\n          } else {\r\n            docs = Array.from(game.collections.get(documentName));\r\n          }\r\n\r\n          if (docs.length) {\r\n            showMassSelect(docs[0]);\r\n          } else {\r\n            ui.notifications.warn(localFormat('dialog.document-not-found', { document: documentName }));\r\n          }\r\n        },\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport async function importPresetFromJSONDialog() {\r\n  const content = `\r\n  <div class=\"form-group\">\r\n      <label for=\"data\">${localize('FILES.SelectFile', false)} </label>\r\n      <input type=\"file\" name=\"data\">\r\n  </div>\r\n  `;\r\n\r\n  let dialog = new Promise((resolve, reject) => {\r\n    new Dialog(\r\n      {\r\n        title: localize('presets.import'),\r\n        content: content,\r\n        buttons: {\r\n          import: {\r\n            icon: '<i class=\"fas fa-file-import\"></i>',\r\n            label: localize('common.import'),\r\n            callback: async (html) => {\r\n              let presets;\r\n              readTextFromFile(html.find('[name=\"data\"]')[0].files[0]).then((json) => {\r\n                try {\r\n                  presets = JSON.parse(json);\r\n                } catch (e) {}\r\n                resolve(presets);\r\n              });\r\n            },\r\n          },\r\n          no: {\r\n            icon: '<i class=\"fas fa-times\"></i>',\r\n            label: localize('Cancel', false),\r\n            callback: () => resolve(false),\r\n          },\r\n        },\r\n        default: 'no',\r\n      },\r\n      {\r\n        width: 400,\r\n      }\r\n    ).render(true);\r\n  });\r\n  return await dialog;\r\n}\r\n","/**\r\n * Manage placeable linking to one another using `links` flag.\r\n */\r\n\r\nimport { libWrapper } from '../shim/shim.js';\r\nimport { pickerSelectMultiLayerDocuments, updateEmbeddedDocumentsViaGM } from '../utils.js';\r\nimport { getDataBounds } from '../presets/utils.js';\r\nimport { LINKER_DOC_COLORS, MODULE_ID, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { DataTransformer } from '../data/transformer.js';\r\n\r\nconst PROCESSED_UPDATES = new Map();\r\nexport const LINK_TYPES = {\r\n  TWO_WAY: 0,\r\n  RECEIVE: 1,\r\n  SEND: 2,\r\n};\r\n\r\nexport function registerLinkerHooks() {\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    Hooks.on(`preUpdate${name}`, preUpdate);\r\n    Hooks.on(`update${name}`, update);\r\n    Hooks.on(`delete${name}`, _delete);\r\n  });\r\n\r\n  // UNDO linked document delete operation\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'PlaceablesLayer.prototype.undoHistory',\r\n    async function (wrapped, ...args) {\r\n      const type = this.history[this.history.length - 1]?.type;\r\n      const undone = await wrapped(...args);\r\n      if (type === 'delete' && undone?.length) {\r\n        for (const document of undone) {\r\n          const event = LinkerAPI.history.find((h) => h.id === document.id);\r\n\r\n          if (event) {\r\n            event.data.forEach((data, documentName) => {\r\n              canvas.scene.createEmbeddedDocuments(documentName, data, { isUndo: true, keepId: true });\r\n            });\r\n            LinkerAPI.history = LinkerAPI.history.filter((h) => h.id !== document.id);\r\n          }\r\n        }\r\n      }\r\n      return undone;\r\n    },\r\n    'WRAPPER'\r\n  );\r\n}\r\n\r\nfunction processLinks(transform, origin, links, scene, docUpdates, processedLinks, sourceId) {\r\n  SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n    const linked = scene\r\n      .getEmbeddedCollection(documentName)\r\n      .filter(\r\n        (t) =>\r\n          t.flags[MODULE_ID]?.links?.some((l1) => l1.type < 2 && links.find((l2) => l2.id === l1.id)) &&\r\n          t.id !== sourceId\r\n      );\r\n\r\n    if (linked.length) {\r\n      const updates = [];\r\n      for (const d of linked) {\r\n        const data = d._source;\r\n        let update = foundry.utils.deepClone(data);\r\n\r\n        DataTransformer.apply(documentName, update, origin, transform);\r\n        update = foundry.utils.diffObject(data, update);\r\n\r\n        update._id = d.id;\r\n        updates.push(update);\r\n\r\n        // Check if the document has unprocessed links and if so chain the update\r\n        const dLinks = d.flags[MODULE_ID].links.filter(\r\n          (l) => !(l.type === LINK_TYPES.RECEIVE || processedLinks.has(l.id))\r\n        );\r\n        if (dLinks.length) {\r\n          dLinks.forEach((l) => processedLinks.add(l.id));\r\n          processLinks(transform, origin, dLinks, scene, docUpdates, processedLinks, d.id);\r\n        }\r\n      }\r\n\r\n      docUpdates.set(documentName, (docUpdates.get(documentName) ?? []).concat(updates));\r\n    }\r\n  });\r\n}\r\n\r\nclass PromiseQueue {\r\n  queue = Promise.resolve();\r\n\r\n  add(operation) {\r\n    this.queue = this.queue.then(operation).catch(() => {});\r\n  }\r\n}\r\n\r\nconst updateQueue = new PromiseQueue();\r\n\r\nfunction preUpdate(document, change, options, userId) {\r\n  if (game.user.id !== userId || options.ignoreLinks) return true;\r\n\r\n  // If the document does not contain links do nothing\r\n  let links = document.flags[MODULE_ID]?.links?.filter((l) => l.type !== LINK_TYPES.RECEIVE);\r\n  if (!links?.length) return true;\r\n\r\n  const positionUpdate =\r\n    change.hasOwnProperty('x') ||\r\n    change.hasOwnProperty('y') ||\r\n    change.hasOwnProperty('shapes') ||\r\n    change.hasOwnProperty('c') ||\r\n    change.hasOwnProperty('elevation');\r\n  const rotationUpdate =\r\n    change.hasOwnProperty('rotation') || change.hasOwnProperty('direction') || options.hasOwnProperty('meRotation');\r\n  if (!(positionUpdate || rotationUpdate)) return true;\r\n\r\n  // Special handling for walls.\r\n  // We do not want to perform linked placeable translation if only a single wall segment is moved.\r\n  if (change.c) {\r\n    if (\r\n      (change.c[0] === document.c[0] && change.c[1] === document.c[1]) ||\r\n      (change.c[2] === document.c[2] && change.c[3] === document.c[3])\r\n    ) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  // If alt is held during during the update, we want to ignore links\r\n  if (game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)) {\r\n    return true;\r\n  }\r\n\r\n  // If an update occurred at the same time (likely same drag, or mass update) we need to check whether\r\n  // this update has unique links which need to be processed\r\n  const puLinks = PROCESSED_UPDATES.get(options.modifiedTime);\r\n  if (puLinks) {\r\n    links = links.filter((l) => !puLinks.some((l2) => l2.id === l.id));\r\n    if (!links.length) return false;\r\n    links.forEach((l) => puLinks.push(l));\r\n  } else {\r\n    PROCESSED_UPDATES.set(options.modifiedTime, links);\r\n    setTimeout(() => PROCESSED_UPDATES.delete(options.modifiedTime), 2000);\r\n    foundry.utils.setProperty(options, `links.${document.id}`, links);\r\n    foundry.utils.setProperty(options, `linkSources.${document.id}`, document.toObject());\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nasync function update(document, change, options, userId) {\r\n  if (!options.links?.[document.id] || options.ignoreLinks || game.user.id !== userId) return true;\r\n\r\n  const positionUpdate =\r\n    change.hasOwnProperty('x') ||\r\n    change.hasOwnProperty('y') ||\r\n    change.hasOwnProperty('shapes') ||\r\n    change.hasOwnProperty('c') ||\r\n    change.hasOwnProperty('elevation');\r\n  const rotationUpdate =\r\n    change.hasOwnProperty('rotation') || change.hasOwnProperty('direction') || options.hasOwnProperty('meRotation');\r\n  if (!(positionUpdate || rotationUpdate)) return true;\r\n\r\n  const previousSource = foundry.utils.deepClone(options.linkSources[document.id]);\r\n  foundry.utils.mergeObject(options.linkSources[document.id], change);\r\n\r\n  const scene = document.parent;\r\n  const { transform, origin } = calculateTransform(\r\n    document.documentName,\r\n    document.toObject(),\r\n    previousSource,\r\n    change,\r\n    options\r\n  );\r\n  const links = options.links[document.id];\r\n\r\n  updateQueue.add(async () => {\r\n    const docUpdates = new Map();\r\n    processLinks(transform, origin, links, scene, docUpdates, new Set(links.map((l) => l.id)), document.id);\r\n\r\n    for (const [documentName, updates] of docUpdates.entries()) {\r\n      const options = { ignoreLinks: true, animate: false };\r\n      if (documentName === 'Token') {\r\n        options.RidingMovement = true; // 'Auto-Rotate' module compatibility\r\n        options.forced = true; // Regions\r\n      }\r\n      //await scene.updateEmbeddedDocuments(documentName, updates, options);\r\n      await updateEmbeddedDocumentsViaGM(documentName, updates, options, scene);\r\n    }\r\n  });\r\n}\r\n\r\nfunction calculateTransform(documentName, currentSource, previousSource, change, options) {\r\n  let transform;\r\n\r\n  if (change.hasOwnProperty('shapes') || change.hasOwnProperty('c')) {\r\n    if (options.hasOwnProperty('meRotation')) {\r\n      transform = { x: 0, y: 0 };\r\n    } else {\r\n      const previousBounds = getDataBounds(documentName, previousSource);\r\n      const currentBounds = getDataBounds(documentName, currentSource);\r\n\r\n      transform = {\r\n        x: currentBounds.x1 - previousBounds.x1,\r\n        y: currentBounds.y1 - previousBounds.y1,\r\n      };\r\n    }\r\n  } else {\r\n    transform = {\r\n      x: currentSource.x - previousSource.x,\r\n      y: currentSource.y - previousSource.y,\r\n    };\r\n  }\r\n\r\n  const origin = { x: 0, y: 0 };\r\n\r\n  // Calculate rotation delta\r\n  let dRotation;\r\n  if (options.hasOwnProperty('meRotation')) dRotation = options.meRotation;\r\n  else if (currentSource.hasOwnProperty('rotation'))\r\n    dRotation = (currentSource.rotation - previousSource.rotation) % 360;\r\n  else if (currentSource.hasOwnProperty('direction'))\r\n    dRotation = (currentSource.direction - previousSource.direction) % 360;\r\n\r\n  if (dRotation != null) {\r\n    transform.rotation = dRotation;\r\n\r\n    const { x1, y1, x2, y2 } = getDataBounds(documentName, currentSource);\r\n\r\n    origin.x = x1 + (x2 - x1) / 2;\r\n    origin.y = y1 + (y2 - y1) / 2;\r\n  }\r\n\r\n  if (currentSource.hasOwnProperty('elevation')) {\r\n    let dElevation;\r\n    if (Number.isNumeric(currentSource.elevation)) {\r\n      dElevation = currentSource.elevation - previousSource.elevation;\r\n    } else {\r\n      dElevation = (currentSource.elevation.bottom ?? 0) - (previousSource.elevation.bottom ?? 0);\r\n    }\r\n    if (dElevation != 0) transform.z = dElevation;\r\n  }\r\n\r\n  return { transform, origin };\r\n}\r\n\r\n/**\r\n * Cascade delete of a placeable to other linked placeables while recording their history\r\n * for an undo operation\r\n */\r\nfunction _delete(document, options, userId) {\r\n  if (game.user.id !== userId || options.linkerDelete) return;\r\n\r\n  const linked = LinkerAPI.getHardLinkedDocuments(document);\r\n  if (!linked.size) return;\r\n\r\n  // Delete linked\r\n  const toDelete = new Map();\r\n  linked.forEach((d) => {\r\n    if (!toDelete.get(d.documentName)) toDelete.set(d.documentName, [d.toObject()]);\r\n    else toDelete.get(d.documentName).push(d.toObject());\r\n  });\r\n\r\n  const scene = document.parent;\r\n  toDelete.forEach((data, documentName) => {\r\n    scene.deleteEmbeddedDocuments(\r\n      documentName,\r\n      data.map((d) => d._id),\r\n      { linkerDelete: true, isUndo: true } // Hack to prevent history tracking\r\n    );\r\n  });\r\n\r\n  // Track history\r\n  LinkerAPI.history.push({ id: document.id, data: toDelete });\r\n  if (LinkerAPI.history.length > 10) LinkerAPI.history.shift();\r\n}\r\n\r\nexport class LinkerAPI {\r\n  /**\r\n   * Open Linker Menu window\r\n   * @returns\r\n   */\r\n  static async openMenu() {\r\n    const module = await import('./menu.js');\r\n    return module.openLinkerMenu();\r\n  }\r\n\r\n  static async smartLink({ multiLayer = false } = {}) {\r\n    let selected;\r\n    if (multiLayer) selected = await pickerSelectMultiLayerDocuments();\r\n    else selected = this._getSelected().map((p) => p.document);\r\n\r\n    if (!selected.length) return;\r\n\r\n    if (!this._smartLink) {\r\n      let link;\r\n      for (const d of selected) {\r\n        link = (this.getLinks(d) ?? []).find((l) => l.type === LINK_TYPES.TWO_WAY);\r\n        if (link) break;\r\n      }\r\n      if (!link) link = { id: foundry.utils.randomID(), type: LINK_TYPES.TWO_WAY, label: 'S_LINK' };\r\n      this._smartLink = link;\r\n\r\n      // Open menu window\r\n      const module = await import('./smartMenu.js');\r\n      module.openSmartLinkMenu(selected[0]);\r\n    }\r\n\r\n    const { id, type, label } = this._smartLink;\r\n    let numUpdates = 0;\r\n    for (const d of selected) {\r\n      if (await this.addLink(d, id, type, label)) numUpdates++;\r\n    }\r\n    if (numUpdates) {\r\n      ui.notifications.info(`Mass Edit: ${numUpdates} documents have been linked.`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Links provided documents/placeables using an already existing or otherwise an automatically\r\n   * generated link.\r\n   * @param {*} documents\r\n   * @returns\r\n   */\r\n  static async link(documents) {\r\n    if (!documents?.length || documents.length === 1) return;\r\n    documents = documents.map((d) => d.document ?? d);\r\n\r\n    let link;\r\n    for (const d of documents) {\r\n      link = (this.getLinks(d) ?? []).find((l) => l.type === LINK_TYPES.TWO_WAY);\r\n      if (link) break;\r\n    }\r\n    if (!link) link = { id: foundry.utils.randomID(), type: LINK_TYPES.TWO_WAY, label: 'A_LINK' };\r\n\r\n    const { id, type, label } = link;\r\n    for (const d of documents) {\r\n      await this.addLink(d, id, type, label);\r\n    }\r\n  }\r\n\r\n  static getLinks(document) {\r\n    document = document.document ?? document;\r\n    return document.flags[MODULE_ID]?.links;\r\n  }\r\n\r\n  /**\r\n   * Retrieve all linked embedded documents\r\n   * @param {CanvasDocumentMixin|Array<CanvasDocumentMixin>} documents embedded document/s\r\n   * @returns {Set<CanvasDocumentMixin>}\r\n   */\r\n  static getLinkedDocuments(documents) {\r\n    if (!Array.isArray(documents)) documents = [documents];\r\n    documents = documents.map((d) => d.document ?? d);\r\n\r\n    const allLinked = new Set();\r\n    documents.forEach((document) => this._findLinked(document, allLinked));\r\n    documents.forEach((document) => allLinked.delete(document));\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Retrieve TWO_WAY and SEND linked embedded documents\r\n   * @param {Array<CanvasDocumentMixin>} documents\r\n   * @returns\r\n   */\r\n  static getHardLinkedDocuments(documents) {\r\n    if (!Array.isArray(documents)) documents = [documents];\r\n\r\n    const allLinked = new Set();\r\n    documents.forEach((document) => this._findHardLinked(document, allLinked));\r\n    documents.forEach((document) => allLinked.delete(document));\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the placeable has the provided linkId\r\n   * @param {Placeable} placeable\r\n   * @param {String} linkId\r\n   * @returns\r\n   */\r\n  static hasLink(placeable, linkId) {\r\n    const document = placeable.document ?? placeable;\r\n    return Boolean(document.flags[MODULE_ID]?.links?.find((l) => l.id === linkId));\r\n  }\r\n\r\n  /**\r\n   * Returns true if the two placeables share a link\r\n   * @param {*} placeable1\r\n   * @param {*} placeable2\r\n   * @returns\r\n   */\r\n  static areLinked(placeable1, placeable2) {\r\n    const links1 = (placeable1.document ?? placeable1).flags[MODULE_ID]?.links;\r\n    const links2 = (placeable2.document ?? placeable2).flags[MODULE_ID]?.links;\r\n\r\n    if (!(links1 && links2)) return false;\r\n    return links1.some((l1) => links2.find((l2) => l1.id === l2.id));\r\n  }\r\n\r\n  /**\r\n   * Add a link to the provided placeable\r\n   * @param {Placeable} placeable\r\n   * @param {String} linkId\r\n   * @param {String} type LINK_TYPES\r\n   * @param {String} label hover text displayed within the Linker Menu\r\n   * @returns\r\n   */\r\n  static async addLink(placeable, linkId, type = LINK_TYPES.TWO_WAY, label = null) {\r\n    if (!Object.values(LINK_TYPES).includes(type)) throw Error(`Invalid link type: ${type}`);\r\n\r\n    const document = placeable.document ?? placeable;\r\n    const links = document.flags[MODULE_ID]?.links ?? [];\r\n\r\n    let link = links.find((l) => l.id === linkId);\r\n    if (!link) {\r\n      link = { id: linkId, type };\r\n      if (label) link.label = label;\r\n      links.push(link);\r\n    } else if (link.type !== type || (label && link.label !== label)) {\r\n      link.type = type;\r\n      if (label) link.label = label;\r\n    } else {\r\n      return false;\r\n    }\r\n\r\n    document.setFlag(MODULE_ID, 'links', links);\r\n    Hooks.call(`${MODULE_ID}.addLink`, document.documentName, document.id, linkId, type, label);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Remove link from the provided placeable\r\n   * @param {Placeable} placeable\r\n   * @param {String} linkId\r\n   */\r\n  static removeLink(placeable, linkId) {\r\n    const document = placeable.document ?? placeable;\r\n    let links = document.flags[MODULE_ID]?.links;\r\n    if (links) {\r\n      links = links.filter((l) => l.id !== linkId);\r\n      if (links.length) document.setFlag(MODULE_ID, 'links', links);\r\n      else document.unsetFlag(MODULE_ID, 'links');\r\n      Hooks.call(`${MODULE_ID}.removeLink`, document.id, linkId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all links from the given placeable/document\r\n   * @param {*} documents\r\n   */\r\n  static async removeLinks(documents) {\r\n    if (!Array.isArray(documents)) documents = [documents];\r\n    documents = documents.map((d) => d.document ?? d);\r\n\r\n    let removed = false;\r\n    for (const document of documents) {\r\n      if (document.flags[MODULE_ID]?.links) {\r\n        await document.unsetFlag(MODULE_ID, 'links');\r\n        Hooks.call(`${MODULE_ID}.removeNode`, document.id);\r\n        removed = true;\r\n      }\r\n    }\r\n    return removed;\r\n  }\r\n\r\n  /**\r\n   * Remove all links from selected placeables\r\n   */\r\n  static async removeLinksFromSelected({ multiLayer = false, notification = false } = {}) {\r\n    let selected;\r\n    if (multiLayer) selected = await pickerSelectMultiLayerDocuments();\r\n    else selected = LinkerAPI._getSelected();\r\n\r\n    let numRemoved = 0;\r\n    for (const s of selected) {\r\n      if (await LinkerAPI.removeLinks(s)) numRemoved++;\r\n    }\r\n    if (notification && numRemoved) ui.notifications.info(`Mass Edit: Links removed from ${numRemoved} documents.`);\r\n\r\n    // Inform Smart Link menu of removed links\r\n    Object.values(ui.windows)\r\n      .find((w) => w.unlink)\r\n      ?.unlink(selected);\r\n  }\r\n\r\n  static history = [];\r\n\r\n  /**\r\n   * Remove all links on the current scene.\r\n   * @returns\r\n   */\r\n  static removeAllLinksOnCurrentScene() {\r\n    const scene = canvas.scene;\r\n    if (!scene) return;\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const updates = [];\r\n      scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        if (d.flags[MODULE_ID]?.links) {\r\n          updates.push({ _id: d.id, [`flags.${MODULE_ID}.-=links`]: null });\r\n        }\r\n      });\r\n      if (updates.length) scene.updateEmbeddedDocuments(documentName, updates);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update linkId on the current scene with the provided label\r\n   * @param {String} linkId\r\n   * @param {String} label\r\n   * @returns\r\n   */\r\n  static updateLinkLabelOnCurrentScene(linkId, label) {\r\n    if (!linkId) return;\r\n\r\n    const scene = canvas.scene;\r\n    if (!scene) return;\r\n\r\n    let updated = false;\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const updates = [];\r\n      scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        const link = d.flags[MODULE_ID]?.links?.find((l) => l.id === linkId);\r\n        if (link && link.label != label) {\r\n          if (!label) delete link.label;\r\n          else link.label = label;\r\n\r\n          updates.push({ _id: d.id, [`flags.${MODULE_ID}.links`]: d.flags[MODULE_ID]?.links });\r\n        }\r\n      });\r\n      if (updates.length) {\r\n        scene.updateEmbeddedDocuments(documentName, updates);\r\n        updated = true;\r\n      }\r\n    });\r\n\r\n    if (updated) {\r\n      Hooks.call(`${MODULE_ID}.linkLabelChange`, linkId, label);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a link from all placeables on the current scene\r\n   * @param {String} linkId\r\n   * @returns\r\n   */\r\n  static removeLinkFromScene(linkId) {\r\n    const scene = canvas.scene;\r\n    if (!scene || !linkId) return;\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const updates = [];\r\n      scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        let links = d.flags[MODULE_ID]?.links;\r\n        if (links) {\r\n          let fLinks = links.filter((l) => l.id !== linkId);\r\n          if (fLinks.length !== links.length) {\r\n            updates.push({ _id: d.id, [`flags.${MODULE_ID}.links`]: fLinks });\r\n          }\r\n        }\r\n      });\r\n      if (updates.length) scene.updateEmbeddedDocuments(documentName, updates);\r\n    });\r\n\r\n    Hooks.call(`${MODULE_ID}.removeNode`, linkId);\r\n  }\r\n\r\n  /**\r\n   * Private Utils\r\n   */\r\n\r\n  /**\r\n   * Returns all selected placeables\r\n   * @returns\r\n   */\r\n  static _getSelected() {\r\n    const activeLayer = canvas.activeLayer;\r\n    if (!SUPPORTED_PLACEABLES.includes(activeLayer.options.objectClass.embeddedName)) return [];\r\n    return [...canvas.activeLayer.controlled];\r\n  }\r\n\r\n  /**\r\n   * Returns all documents on the current scene matching the provided linkId and type\r\n   * @param {String} linkId\r\n   * @param {LINK_TYPES|null} type\r\n   * @returns\r\n   */\r\n  static _getLinkedDocumentsUsingLink(linkId, type = null) {\r\n    if (type != null && !Object.values(LINK_TYPES).includes(type)) throw Error(`Invalid link type: ${type}`);\r\n    const allLinked = new Set();\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      canvas.scene.getEmbeddedCollection(documentName).forEach((d) => {\r\n        if (d.flags[MODULE_ID]?.links?.some((l) => l.id === linkId && (type == null || l.type === type))) {\r\n          allLinked.add(d);\r\n        }\r\n      });\r\n    });\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Utility for LinkerAPI.getLinkedDocuments\r\n   * @param {*} document\r\n   * @param {*} allLinked\r\n   * @param {*} processedLinks\r\n   * @returns\r\n   */\r\n  static _findLinked(document, allLinked, processedLinks = new Set()) {\r\n    allLinked.add(document);\r\n\r\n    const links = document.flags[MODULE_ID]?.links?.filter((l) => !processedLinks.has(l.id)).map((l) => l.id);\r\n    if (!links?.length) return allLinked;\r\n\r\n    links.forEach((l) => processedLinks.add(l));\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const linked = canvas.scene\r\n        .getEmbeddedCollection(documentName)\r\n        .filter((t) => t.flags[MODULE_ID]?.links?.some((l1) => links.find((l2) => l2 === l1.id)));\r\n\r\n      for (const d of linked) {\r\n        this._findLinked(d, allLinked, processedLinks);\r\n      }\r\n    });\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  /**\r\n   * Utility for LinkerAPI.getHardLinkedDocuments\r\n   * @param {*} document\r\n   * @param {*} allLinked\r\n   * @param {*} processedLinks\r\n   * @returns\r\n   */\r\n  static _findHardLinked(document, allLinked, processedLinks = new Set()) {\r\n    allLinked.add(document);\r\n\r\n    const links = document.flags[MODULE_ID]?.links\r\n      ?.filter((l) => l.type !== LINK_TYPES.RECEIVE && !processedLinks.has(l.id))\r\n      .map((l) => l.id);\r\n    if (!links?.length) return allLinked;\r\n\r\n    links.forEach((l) => processedLinks.add(l));\r\n\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      const linked = document.parent\r\n        .getEmbeddedCollection(documentName)\r\n        .filter((t) =>\r\n          t.flags[MODULE_ID]?.links?.some((l1) => links.find((l2) => l2 === l1.id && l1.type !== LINK_TYPES.SEND))\r\n        );\r\n\r\n      for (const d of linked) {\r\n        this._findHardLinked(d, allLinked, processedLinks);\r\n      }\r\n    });\r\n\r\n    return allLinked;\r\n  }\r\n\r\n  static _highlightDocuments(docs) {\r\n    const dg = canvas.controls.debug;\r\n    dg.clear();\r\n\r\n    const width = 8;\r\n    const alpha = 1;\r\n    docs.forEach((d) => {\r\n      let bounds = d.object.bounds;\r\n\r\n      dg.lineStyle(width + 2, 0, alpha, 0.5);\r\n      dg.drawRect(bounds.x, bounds.y, bounds.width, bounds.height);\r\n\r\n      dg.lineStyle(width, LINKER_DOC_COLORS[d.documentName], alpha, 0.5);\r\n      dg.drawRect(bounds.x, bounds.y, bounds.width, bounds.height);\r\n    });\r\n  }\r\n\r\n  static _clearHighlight() {\r\n    canvas.controls.debug.clear();\r\n  }\r\n}\r\n","/**\r\n * Mouse controls for Levels 3D\r\n */\r\n\r\nimport { BrushMenu } from './brush';\r\nimport { Picker } from './picker';\r\n\r\nexport class Mouse3D {\r\n  // Trick to keep consistent signatures for bound 3d listeners\r\n  // Required to be able to remove these function once picker is de-activated\r\n  static {\r\n    this._boundOn3DMouseDown = this._on3DMouseDown.bind(this);\r\n    this._boundOn3dMouseMove = this._on3dMouseMove.bind(this);\r\n    this._boundOn3dMouseWheel = this._on3dMouseWheel.bind(this);\r\n  }\r\n\r\n  static activate({ mouseMoveCallback = null, mouseClickCallback = null, mouseWheelClickCallback = null } = {}) {\r\n    this.mouseMoveCallback = mouseMoveCallback;\r\n    this.mouseClickCallback = mouseClickCallback;\r\n    this.mouseWheelClickCallback = mouseWheelClickCallback;\r\n\r\n    this._createTracker();\r\n    this._activate3DListeners();\r\n  }\r\n\r\n  static deactivate() {\r\n    if (this.tracker && game.Levels3DPreview?._active) {\r\n      game.Levels3DPreview.scene.remove(this.tracker);\r\n      this.tracker = null;\r\n      this.deactivate3DListeners();\r\n    }\r\n  }\r\n\r\n  static _createTracker() {\r\n    if (!this.tracker) {\r\n      const THREE = game.Levels3DPreview.THREE;\r\n\r\n      this.tracker = new THREE.Mesh(\r\n        new THREE.SphereGeometry(0.01, 8, 8),\r\n        new THREE.MeshBasicMaterial({\r\n          opacity: 0.5,\r\n          transparent: true,\r\n          color: 0x00ff00,\r\n          wireframe: true,\r\n        })\r\n      );\r\n\r\n      this.tracker.userData.interactive = false;\r\n      this.tracker.userData.ignoreHover = true;\r\n\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      this.tracker.position.set(mPos.x, mPos.y, mPos.z);\r\n\r\n      game.Levels3DPreview.scene.add(this.tracker);\r\n    }\r\n  }\r\n\r\n  static _activate3DListeners() {\r\n    // Remove listeners if they are already set\r\n    this.deactivate3DListeners();\r\n\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('mousedown', this._boundOn3DMouseDown, false);\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n    game.Levels3DPreview.renderer.domElement.addEventListener('wheel', this._boundOn3dMouseWheel, true);\r\n  }\r\n\r\n  static deactivate3DListeners() {\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('mousedown', this._boundOn3DMouseDown, false);\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('mousemove', this._boundOn3dMouseMove, false);\r\n    game.Levels3DPreview.renderer.domElement.removeEventListener('wheel', this._boundOn3dMouseWheel, true);\r\n  }\r\n\r\n  static _on3DMouseDown(event) {\r\n    if (event.which === 1) {\r\n      const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.tracker.position);\r\n      const p = game.Levels3DPreview.interactionManager.currentHover?.placeable;\r\n      this.mouseClickCallback?.({ x: posVec.x, y: posVec.y, z: posVec.z, placeable: p });\r\n      //game.Levels3DPreview.interactionManager._downCameraPosition.set(0, 0, 0);\r\n    } else if (event.which === 2) {\r\n      this.mouseWheelClickCallback?.();\r\n    }\r\n  }\r\n\r\n  static _on3dMouseMove() {\r\n    if (this.delayMoveTimer) return;\r\n\r\n    this.delayMoveTimer = setTimeout(function () {\r\n      const mPos = game.Levels3DPreview.interactionManager.canvas3dMousePosition;\r\n      const cPos = game.Levels3DPreview.interactionManager.camera.position;\r\n\r\n      const intersects = game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(\r\n        cPos,\r\n        mPos,\r\n        'collision',\r\n        false,\r\n        false,\r\n        false,\r\n        true\r\n      );\r\n\r\n      if (intersects[0]) {\r\n        const intersect = intersects[0];\r\n        Mouse3D.tracker?.position.set(intersect.point.x, intersect.point.y, intersect.point.z);\r\n        const posVec = game.Levels3DPreview.ruler.constructor.pos3DToCanvas(intersect.point);\r\n\r\n        Mouse3D.mouseMoveCallback?.({ x: posVec.x, y: posVec.y, z: posVec.z });\r\n      }\r\n      Mouse3D.delayMoveTimer = null;\r\n    }, 100);\r\n  }\r\n\r\n  static _on3dMouseWheel(event) {\r\n    //console.log(event);\r\n\r\n    if (\r\n      (Picker.isActive() || BrushMenu.isActive()) &&\r\n      (event.ctrlKey || event.shiftKey || event.metaKey || event.altKey)\r\n    ) {\r\n      event.stopPropagation();\r\n      event.preventDefault();\r\n\r\n      let dy = (event.delta = event.deltaY);\r\n      if (event.shiftKey && dy === 0) {\r\n        dy = event.delta = event.deltaX;\r\n      }\r\n      if (dy === 0) return;\r\n\r\n      // console.log(event.altKey, event.ctrlKey, event.shiftKey, event.delta);\r\n\r\n      if (event.altKey) Picker.addScaling(event.delta < 0 ? 0.05 : -0.05);\r\n      else if ((event.ctrlKey || event.metaKey) && event.shiftKey) BrushMenu.iterate(event.delta >= 0, true);\r\n      else if (event.ctrlKey || event.metaKey) Picker.addRotation(event.delta < 0 ? 2.5 : -2.5);\r\n      else if (event.shiftKey) Picker.addRotation(event.delta < 0 ? 15 : -15);\r\n      return;\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { MODULE_ID, PIVOTS, SUPPORTED_PLACEABLES } from './constants.js';\r\nimport { DataTransformer } from './data/transformer.js';\r\nimport { LinkerAPI } from './linker/linker.js';\r\nimport { Mouse3D } from './mouse3d.js';\r\nimport { getPivotOffset, getPresetDataBounds } from './presets/utils.js';\r\nimport { Scenescape } from './scenescape/scenescape.js';\r\nimport { pickerSelectMultiLayerDocuments, updateEmbeddedDocumentsViaGM } from './utils.js';\r\n\r\n/**\r\n * Cross-hair and optional preview image/label that can be activated to allow the user to select\r\n * an area on the screen.\r\n */\r\nexport class Picker {\r\n  static pickerOverlay;\r\n  static boundStart;\r\n  static boundEnd;\r\n  static callback;\r\n  static _transformAccumulator = { rotation: 0, scale: 1 };\r\n\r\n  static isActive() {\r\n    return Boolean(this.pickerOverlay);\r\n  }\r\n\r\n  static addRotation(rotation) {\r\n    this._rotation += rotation;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n    this._transformAccumulator.rotation += rotation;\r\n  }\r\n\r\n  static addScaling(scale) {\r\n    this._scale += scale;\r\n    this._transformAccumulator.scale *= this._scale;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static addElevation(elevation) {\r\n    this._elevation += elevation;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static resetTransformAccumulator() {\r\n    this._transformAccumulator.rotation = 0;\r\n    this._transformAccumulator.scale = 1;\r\n  }\r\n\r\n  static getTransformAccumulator() {\r\n    return foundry.utils.deepClone(this._transformAccumulator);\r\n  }\r\n\r\n  static mirrorX() {\r\n    this._mirrorX = true;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  static mirrorY() {\r\n    this._mirrorY = true;\r\n    this.pickerOverlay?.setPositions?.(canvas.mousePosition);\r\n  }\r\n\r\n  /**\r\n   * Activates the picker overlay.\r\n   * @param {Function} callback callback function with coordinates returned as starting and ending bounds of a rectangles\r\n   *                            { start: {x1, y1}, end: {x2, y2} }\r\n   * @param {Object}  preview\r\n   * @param {String}  preview.documentName (optional) preview placeables document name\r\n   * @param {Map[String,Array]}  preview.previewData    (req) preview placeables data\r\n   *                                                e.g. \"Tile\", \"Tile.1\", \"MeasuredTemplate.3\"\r\n   * @param {Boolean} preview.snap                  (optional) if true returned coordinates will be snapped to grid\r\n   * @param {String}  preview.label                  (optional) preview placeables document name\r\n   */\r\n  static async activate(callback, preview) {\r\n    this.destroy();\r\n\r\n    const pickerOverlay = new PIXI.Container();\r\n    this.callback = callback;\r\n\r\n    if (preview) {\r\n      let label = new PreciseText('', { ...CONFIG.canvasTextStyle, _fontSize: 24 });\r\n      label.anchor.set(0.5, 1);\r\n      label = pickerOverlay.addChild(label);\r\n\r\n      if (preview.label) {\r\n        label.text = preview.label;\r\n      }\r\n\r\n      if (Scenescape.active && Scenescape.autoScale) {\r\n        preview.snap = false;\r\n\r\n        const b = getPresetDataBounds(preview.previewData);\r\n        const bottom = { x: b.x + b.width / 2, y: b.y + b.height };\r\n        Picker._paraScale = Scenescape.getParallaxParameters(bottom).scale;\r\n\r\n        // If Picker preview was triggered via a spawnPreset(...) we want to apply the initial\r\n        // scenescape scale at the given position, as the data being previewed was not yet placed on the scene\r\n        if (preview.spawner) preview.scale = (preview.scale ?? 1) * Picker._paraScale;\r\n      }\r\n\r\n      // Move data to scene bounds to prevent creating preview outside the map\r\n      // TODO: this does not work for TA prefabs\r\n      const b = getPresetDataBounds(preview.previewData);\r\n      DataTransformer.applyToMap(preview.previewData, { x: 0, y: 0 }, { x: -b.x, y: -b.y });\r\n\r\n      let { previews, layer, previewDocuments } = await this._genPreviews(preview);\r\n      this._rotation = preview.rotation ?? 0;\r\n      this._scale = preview.scale ?? 1;\r\n      this._elevation = 0;\r\n      this._mirrorX = false;\r\n      this._mirrorY = false;\r\n\r\n      // If we're previewing multiple types of document lets use wall layer snapping\r\n      if (previewDocuments.size !== 1) {\r\n        layer = canvas.walls;\r\n      }\r\n\r\n      // Position offset to center preview over the mouse\r\n      const setPositions = function (pos) {\r\n        if (!pos) return;\r\n\r\n        // Place top-left preview corner on the mouse\r\n        const b = getPresetDataBounds(preview.previewData);\r\n        let transform = { x: pos.x - b.x, y: pos.y - b.y };\r\n\r\n        // Change preview position relative to the mouse\r\n        const offset = getPivotOffset(Scenescape.active ? PIVOTS.BOTTOM : preview.pivot, null, b);\r\n        transform.x -= offset.x;\r\n        transform.y -= offset.y;\r\n\r\n        // Snap bounds after transform\r\n        if (preview.snap && layer && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)) {\r\n          const postTransformPos = { x: b.x + transform.x, y: b.y + transform.y };\r\n          const snapped = layer.getSnappedPoint(postTransformPos);\r\n\r\n          transform.x += snapped.x - postTransformPos.x;\r\n          transform.y += snapped.y - postTransformPos.y;\r\n        }\r\n\r\n        // Dynamic scenescape scaling\r\n        if (Scenescape.active && Scenescape.autoScale) {\r\n          const params = Scenescape.getParallaxParameters(canvas.mousePosition);\r\n\r\n          // Special handling for Token drag\r\n          // Tokens have an actor defined size which we want to be maintained unless it was manually scaled during preview\r\n          if (previews.length === 1 && previews[0].documentName === 'Token') {\r\n            let size;\r\n            // Manual token scaling, this should apply a fixed size to the token\r\n            if (Picker._scale != 1) {\r\n              size = Scenescape.getTokenSize(previews[0]) * Picker._scale;\r\n\r\n              let tSize = (size * 6) / 100;\r\n              foundry.utils.setProperty(previews[0].data, `flags.${MODULE_ID}.size`, tSize);\r\n              foundry.utils.setProperty(previews[0].document, `flags.${MODULE_ID}.size`, tSize);\r\n            }\r\n\r\n            // Scenescape dynamic scaling\r\n            if (params.scale !== Picker._paraScale) {\r\n              size = size ?? Scenescape.getTokenSize(previews[0].preview);\r\n\r\n              const currHeight = previews[0].preview.document.height * canvas.dimensions.size;\r\n              const targHeight = size * params.scale;\r\n\r\n              let scale = targHeight / currHeight;\r\n\r\n              Picker._paraScale = params.scale;\r\n              Picker._scale *= scale;\r\n            }\r\n          } else {\r\n            if (params.scale !== Picker._paraScale) {\r\n              Picker._scale *= params.scale / Picker._paraScale;\r\n              Picker._paraScale = params.scale;\r\n            }\r\n          }\r\n\r\n          pos.z = params.elevation;\r\n          Picker._elevation = 0;\r\n          label.text = '';\r\n        } else {\r\n          if (Picker._elevation != 0) {\r\n            transform.z = Picker._elevation;\r\n            delete pos.z;\r\n            Picker._elevation = 0;\r\n            label.text = `[${(b.elevation.bottom + transform.z).toFixed(2)}]`;\r\n            label.anchor.set(1, -2);\r\n          }\r\n        }\r\n\r\n        if (pos.z != null) transform.z = pos.z - b.elevation.bottom;\r\n\r\n        // Transforms that are applied in response to keybind presses\r\n        if (Picker._rotation != 0) {\r\n          transform.rotation = Picker._rotation;\r\n          Picker._rotation = 0;\r\n        }\r\n        if (Picker._scale != 1) {\r\n          transform.scale = Picker._scale;\r\n          Picker._scale = 1;\r\n        }\r\n\r\n        transform.mirrorX = Picker._mirrorX;\r\n        Picker._mirrorX = false;\r\n\r\n        transform.mirrorY = Picker._mirrorY;\r\n        Picker._mirrorY = false;\r\n\r\n        // - end of transform calculations\r\n\r\n        // Apply transformations\r\n        for (const previewContainer of previews) {\r\n          const preview = previewContainer.preview;\r\n\r\n          const documentName = previewContainer.documentName;\r\n          DataTransformer.apply(documentName, previewContainer.data, pos, transform, preview);\r\n\r\n          // =====\r\n          // Hacks\r\n          // =====\r\n          if (preview) {\r\n            preview.renderFlags.set({ refresh: true });\r\n            const doc = preview.document;\r\n\r\n            // Elevation, sort, and z order hacks to make sure previews are always rendered on-top\r\n            // TODO: improve _meSort, _meElevation\r\n            if (doc.sort != null) {\r\n              if (!preview._meSort) preview._meSort = doc.sort;\r\n              doc.sort = preview._meSort + 10000;\r\n            }\r\n            if (!Scenescape.active) {\r\n              if (!game.Levels3DPreview?._active && doc.elevation != null) {\r\n                if (!preview._meElevation) preview._meElevation = doc.elevation;\r\n                doc.elevation = preview._meElevation + 10000;\r\n              }\r\n            }\r\n            // end of sort hacks\r\n\r\n            // For some reason collision bool is refreshed after creation of the preview\r\n            if (preview._l3dPreview) preview._l3dPreview.collision = false;\r\n\r\n            // Special position update conditions\r\n            // - Region: We need to simulate doc update via `_onUpdate` call\r\n            // - AmbientLight and AmbientSound sources need to be re-initialized to have their fields properly rendered\r\n            if (documentName === 'Region') {\r\n              preview._onUpdate({ shapes: null });\r\n            } else if (documentName === 'AmbientLight') {\r\n              preview.initializeLightSource();\r\n            } else if (documentName === 'AmbientSound') {\r\n              preview.initializeSoundSource();\r\n            }\r\n          }\r\n          // End of Hacks\r\n        }\r\n\r\n        if (label) {\r\n          label.x = pos.x;\r\n          label.y = pos.y - 38;\r\n        }\r\n\r\n        pickerOverlay.previewDocuments = previewDocuments;\r\n\r\n        // Changing scaling offsets the center position\r\n        // Let's immediately reposition back to it\r\n        if (transform.scale != null) {\r\n          setPositions(pos);\r\n        }\r\n      };\r\n\r\n      let lastX = Infinity;\r\n      let lastY = Infinity;\r\n      pickerOverlay.on('pointermove', (event) => {\r\n        const client = event.data.client;\r\n        if (client.x !== lastX || client.y !== lastY) {\r\n          lastX = client.x;\r\n          lastY = client.y;\r\n          setPositions(event.data.getLocalPosition(pickerOverlay));\r\n        }\r\n      });\r\n\r\n      //setTimeout(() => setPositions(canvas.mousePosition), 50);\r\n      pickerOverlay.setPositions = setPositions;\r\n    }\r\n\r\n    if (!preview?.previewOnly) {\r\n      if (game.Levels3DPreview?._active) {\r\n        Mouse3D.activate({\r\n          mouseMoveCallback: Picker.feedPos.bind(Picker),\r\n          mouseClickCallback: Picker.resolve.bind(Picker),\r\n          mouseWheelClickCallback: Picker.destroy.bind(Picker),\r\n        });\r\n      } else {\r\n        pickerOverlay.hitArea = canvas.dimensions.rect;\r\n        pickerOverlay.cursor = 'crosshair';\r\n        pickerOverlay.interactive = true;\r\n        pickerOverlay.zIndex = 5;\r\n        pickerOverlay.on('remove', () => pickerOverlay.off('pick'));\r\n        pickerOverlay.on('mousedown', (event) => {\r\n          Picker.boundStart = event.data.getLocalPosition(pickerOverlay);\r\n        });\r\n        pickerOverlay.on('mouseup', (event) => {\r\n          Picker.boundEnd = event.data.getLocalPosition(pickerOverlay);\r\n          if (preview?.confirmOnRelease) this.resolve(Picker.boundEnd);\r\n        });\r\n        pickerOverlay.on('click', (event) => {\r\n          if (event.nativeEvent.which == 2) {\r\n            this.callback?.(null);\r\n          } else {\r\n            const minX = Math.min(this.boundStart.x, this.boundEnd.x);\r\n            const maxX = Math.max(this.boundStart.x, this.boundEnd.x);\r\n            const minY = Math.min(this.boundStart.y, this.boundEnd.y);\r\n            const maxY = Math.max(this.boundStart.y, this.boundEnd.y);\r\n            this.callback?.({ start: { x: minX, y: minY }, end: { x: maxX, y: maxY } });\r\n          }\r\n          this.destroy();\r\n        });\r\n      }\r\n    }\r\n    this.pickerOverlay = pickerOverlay;\r\n    canvas.stage.addChild(pickerOverlay);\r\n    this.feedPos(canvas.mousePosition);\r\n  }\r\n\r\n  static feedPos(pos) {\r\n    this.pickerOverlay?.setPositions?.(pos);\r\n  }\r\n\r\n  static resolve(pos) {\r\n    if (this.callback) {\r\n      if (pos == null) this.callback(null);\r\n      else this.callback?.({ start: { x: pos.x, y: pos.y, z: pos.z }, end: { x: pos.x, y: pos.y, z: pos.z } });\r\n    }\r\n    this.destroy();\r\n  }\r\n\r\n  static destroy() {\r\n    if (this.pickerOverlay) {\r\n      this.pickerOverlay.parent?.removeChild(this.pickerOverlay);\r\n      if (this.pickerOverlay.previewDocuments) {\r\n        this.pickerOverlay.previewDocuments.forEach((name) => {\r\n          const layer = canvas.getLayerByEmbeddedName(name);\r\n          if (layer) {\r\n            if (game.Levels3DPreview?._active) {\r\n              layer.preview.children.forEach((c) => {\r\n                c._l3dPreview?.destroy();\r\n              });\r\n            }\r\n            layer.clearPreviewContainer();\r\n          }\r\n        });\r\n      }\r\n\r\n      this.pickerOverlay.destroy(true);\r\n      this.pickerOverlay.children?.forEach((c) => c.destroy(true));\r\n      this.callback?.(null);\r\n      this.pickerOverlay = null;\r\n      Mouse3D.deactivate();\r\n    }\r\n    this.callback = null;\r\n    Scenescape.autoScale = true;\r\n  }\r\n\r\n  // Modified Foundry _createPreview\r\n  // Does not throw warning if user lacks document create permissions\r\n  static async _createPreview(createData) {\r\n    const documentName = this.constructor.documentName;\r\n    const cls = getDocumentClass(documentName);\r\n    createData._id = foundry.utils.randomID(); // Needed to allow rendering of multiple previews at the same time\r\n    const document = new cls(createData, { parent: canvas.scene });\r\n\r\n    const object = new CONFIG[documentName].objectClass(document);\r\n    document._object = object;\r\n    object.eventMode = 'none';\r\n    if (!Scenescape.active) {\r\n      object.document.alpha = 0.4;\r\n      if (object.document.occlusion) object.document.occlusion.alpha = 0.4;\r\n    }\r\n    this.preview.addChild(object);\r\n    await object.draw();\r\n\r\n    // Since we do elevation manipulation to force previews to be rendered on top\r\n    // we don't want the user to see these temporary values\r\n    if (object.tooltip) object.tooltip.renderable = false;\r\n    if (object.controlIcon?.tooltip) object.controlIcon.tooltip.renderable = false;\r\n\r\n    object.visible = false;\r\n\r\n    // Foundry as well as various modules might have complex `isVisible` and 'visible' conditions\r\n    // lets simplify by overriding this function to make sure the preview is always visible\r\n    Picker._overridePlaceableVisibility(object);\r\n\r\n    // 3D Canvas\r\n    if (game.Levels3DPreview?._active) {\r\n      if (documentName === 'Tile') {\r\n        game.Levels3DPreview.createTile(object);\r\n        const l3dPreview = game.Levels3DPreview.tiles[object.id];\r\n\r\n        l3dPreview.castShadow = false;\r\n        l3dPreview.collision = false;\r\n\r\n        object._l3dPreview = l3dPreview;\r\n      } else if (documentName === 'Token') {\r\n        // Tokens get async loaded without a way to await them\r\n        // We'll need to retrieve the 3D token when the transforms are actually getting applied\r\n        game.Levels3DPreview.addToken(object);\r\n        object._l3dPreview = null;\r\n      } else if (documentName === 'AmbientLight') {\r\n        game.Levels3DPreview.addLight(object);\r\n        const l3dPreview = game.Levels3DPreview.lights[object.id];\r\n        object._l3dPreview = l3dPreview;\r\n      }\r\n    }\r\n\r\n    return object;\r\n  }\r\n\r\n  static _overridePlaceableVisibility(placeable) {\r\n    Object.defineProperty(placeable, 'isVisible', {\r\n      get: function () {\r\n        return true;\r\n      },\r\n      set: function () {},\r\n    });\r\n    Object.defineProperty(placeable, 'visible', {\r\n      get: function () {\r\n        return true;\r\n      },\r\n      set: function () {},\r\n    });\r\n    if (placeable.controlIcon) {\r\n      placeable.controlIcon.alpha = 0.4;\r\n      Object.defineProperty(placeable.controlIcon, 'visible', {\r\n        get: function () {\r\n          return true;\r\n        },\r\n        set: function () {},\r\n      });\r\n    }\r\n  }\r\n\r\n  static async _genPreviews(preview) {\r\n    if (!preview.previewData) return { previews: [] };\r\n\r\n    const toCreate = [];\r\n    for (const [documentName, dataArr] of preview.previewData.entries()) {\r\n      for (const data of dataArr) {\r\n        toCreate.push({ documentName, data });\r\n\r\n        if (documentName === 'Token') {\r\n          this._genTAPreviews(data, data, toCreate);\r\n        }\r\n\r\n        if (documentName === 'Tile' && Scenescape.active) {\r\n          // TODO: move setting of these fields to a more appropriate spot\r\n          foundry.utils.setProperty(data, 'restrictions.light', true);\r\n          foundry.utils.setProperty(data, 'occlusion.alpha', 1);\r\n        }\r\n      }\r\n    }\r\n\r\n    const previewDocuments = new Set();\r\n    const previews = [];\r\n    for (const { documentName, data } of toCreate) {\r\n      const previewContainer = { documentName, data };\r\n\r\n      if (!preview.restrict?.includes(documentName)) {\r\n        previewContainer.preview = await this._createPreview.call(\r\n          canvas.getLayerByEmbeddedName(documentName),\r\n          foundry.utils.deepClone(data)\r\n        );\r\n        previewDocuments.add(documentName);\r\n      }\r\n\r\n      previews.push(previewContainer);\r\n    }\r\n    return { previews, layer: canvas.getLayerByEmbeddedName(preview.documentName), previewDocuments };\r\n  }\r\n\r\n  static _genTAPreviews(data, parent, toCreate) {\r\n    if (!game.modules.get('token-attacher')?.active) return;\r\n\r\n    const attached = foundry.utils.getProperty(data, 'flags.token-attacher.prototypeAttached');\r\n    const pos = foundry.utils.getProperty(data, 'flags.token-attacher.pos');\r\n    const grid = foundry.utils.getProperty(data, 'flags.token-attacher.grid');\r\n\r\n    if (!(attached && pos && grid)) return;\r\n\r\n    const ratio = canvas.grid.size / grid.size;\r\n\r\n    for (const [name, dataList] of Object.entries(attached)) {\r\n      for (let data of dataList) {\r\n        if (['Token', 'Tile', 'Drawing'].includes(name)) {\r\n          data.width *= ratio;\r\n          data.height *= ratio;\r\n        }\r\n\r\n        if (name === 'Wall') {\r\n          data.c[0] = parent.x + (data.c[0] - pos.xy.x) * ratio;\r\n          data.c[1] = parent.y + (data.c[1] - pos.xy.y) * ratio;\r\n          data.c[2] = parent.x + (data.c[2] - pos.xy.x) * ratio;\r\n          data.c[3] = parent.y + (data.c[3] - pos.xy.y) * ratio;\r\n        } else if (name === 'Region') {\r\n          data.shapes?.forEach((shape) => {\r\n            if (shape.type === 'polygon') {\r\n              for (let i = 0; i < shape.points.length; i += 2) {\r\n                shape.points[i] = parent.x + (shape.points[i] - pos.xy.x) * ratio;\r\n                shape.points[i + 1] = parent.y + (shape.points[i + 1] - pos.xy.y) * ratio;\r\n              }\r\n            } else {\r\n              shape.x = parent.x + (shape.x - pos.xy.x) * ratio;\r\n              shape.y = parent.y + (shape.y - pos.xy.y) * ratio;\r\n              if (shape.type === 'ellipse') {\r\n                shape.radiusX *= ratio;\r\n                shape.radiusY *= ratio;\r\n              } else if (shape.type === 'rectangle') {\r\n                shape.width *= ratio;\r\n                shape.height *= ratio;\r\n              }\r\n            }\r\n          });\r\n        } else {\r\n          data.x = parent.x + (data.x - pos.xy.x) * ratio;\r\n          data.y = parent.y + (data.y - pos.xy.y) * ratio;\r\n        }\r\n\r\n        toCreate.push({ documentName: name, data });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport async function editPreviewPlaceables(placeables, confirmOnRelease = false, callback = null) {\r\n  const controlled = new Set();\r\n\r\n  if (placeables?.length) {\r\n    placeables.forEach((p) => {\r\n      controlled.add(p.document);\r\n      LinkerAPI.getLinkedDocuments(p.document).forEach((d) => controlled.add(d));\r\n    });\r\n  } else {\r\n    SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n      canvas.getLayerByEmbeddedName(documentName).controlled.forEach((p) => {\r\n        controlled.add(p.document);\r\n        LinkerAPI.getLinkedDocuments(p.document).forEach((d) => controlled.add(d));\r\n      });\r\n    });\r\n  }\r\n\r\n  if (!controlled.size) {\r\n    const pickerSelected = await pickerSelectMultiLayerDocuments();\r\n    pickerSelected.forEach((d) => controlled.add(d));\r\n  }\r\n\r\n  if (!controlled.size) return false;\r\n\r\n  // Generate data from the selected placeables and pass them to Picker to create previews\r\n  const docToData = new Map();\r\n\r\n  let mainDocumentName;\r\n\r\n  controlled.forEach((document) => {\r\n    const documentName = document.documentName;\r\n    if (!SUPPORTED_PLACEABLES.includes(documentName)) return;\r\n\r\n    let data = document.toObject();\r\n\r\n    if (\r\n      documentName === 'Token' &&\r\n      game.modules.get('token-attacher')?.active &&\r\n      tokenAttacher?.generatePrototypeAttached\r\n    ) {\r\n      const attached = data.flags?.['token-attacher']?.attached || {};\r\n      if (!foundry.utils.isEmpty(attached)) {\r\n        const prototypeAttached = tokenAttacher.generatePrototypeAttached(data, attached);\r\n        foundry.utils.setProperty(data, 'flags.token-attacher.attached', null);\r\n        foundry.utils.setProperty(data, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n        foundry.utils.setProperty(data, 'flags.token-attacher.grid', {\r\n          size: canvas.grid.size,\r\n          w: canvas.grid.sizeX,\r\n          h: canvas.grid.sizeY,\r\n        });\r\n      }\r\n    }\r\n\r\n    if (docToData.get(documentName)) docToData.get(documentName).push(data);\r\n    else docToData.set(documentName, [data]);\r\n\r\n    if (!mainDocumentName) mainDocumentName = documentName;\r\n  });\r\n\r\n  // Lets create copies of original data so that we can perform a diff after transforms have been\r\n  // applied by the Picker\r\n  const originalDocToData = new Map();\r\n  docToData.forEach((dataArr, documentName) => {\r\n    originalDocToData.set(documentName, foundry.utils.deepClone(dataArr));\r\n  });\r\n\r\n  Picker.activate(\r\n    async (coords) => {\r\n      if (coords == null) return callback?.();\r\n\r\n      docToData.forEach((data, documentName) => {\r\n        let updates = [];\r\n\r\n        const originalData = originalDocToData.get(documentName);\r\n        for (let i = 0; i < originalData.length; i++) {\r\n          const diff = foundry.utils.diffObject(originalData[i], data[i]);\r\n          if (!foundry.utils.isEmpty(diff)) {\r\n            diff._id = originalData[i]._id;\r\n            updates.push(diff);\r\n          }\r\n        }\r\n        if (updates.length) {\r\n          updateEmbeddedDocumentsViaGM(\r\n            documentName,\r\n            updates,\r\n            {\r\n              ignoreLinks: true,\r\n              animate: false,\r\n              preventParallaxScaling: true,\r\n            },\r\n            canvas.scene\r\n          );\r\n        }\r\n\r\n        callback?.(coords);\r\n      });\r\n    },\r\n    {\r\n      documentName: mainDocumentName,\r\n      previewData: docToData,\r\n      snap: true,\r\n      pivot: PIVOTS.CENTER,\r\n      confirmOnRelease,\r\n    }\r\n  );\r\n\r\n  return true;\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { TagInput } from '../utils.js';\r\nimport { PresetAPI } from './collection.js';\r\nimport { PresetContainer } from './containerApp.js';\r\nimport { Preset } from './preset.js';\r\n\r\nexport async function openBag(uuid) {\r\n  let journal = fromUuidSync(uuid);\r\n\r\n  // Attempt a fallback to a an ID tag search\r\n  // This is to support the conversion of the old bag system to the new preset based bag system\r\n  // 11/12/24\r\n  if (!journal) {\r\n    journal = await PresetAPI.getPreset({ tags: [`id-${TagInput.simplifyString(uuid)}`] });\r\n\r\n    if (!journal) {\r\n      ui.notifications.warn(`Bag not found: ` + uuid);\r\n      return;\r\n    }\r\n    uuid = journal.uuid;\r\n  }\r\n\r\n  // If bag is already open toggle it off\r\n  const app = Object.values(ui.windows).find((w) => w.presetBag && w.preset.uuid === uuid);\r\n  if (app) {\r\n    app.close(true);\r\n    return;\r\n  }\r\n\r\n  const preset = await PresetAPI.getPreset({ uuid });\r\n\r\n  new BagApplication(preset).render(true);\r\n}\r\n\r\nclass BagApplication extends PresetContainer {\r\n  // Track positions of previously opened bags\r\n  static previousPositions = {};\r\n\r\n  constructor(preset, options = {}) {\r\n    let positionOpts = BagApplication.previousPositions[preset.uuid] ?? {};\r\n\r\n    super({}, { ...options, forceAllowDelete: true, ...positionOpts });\r\n    this.preset = preset;\r\n    this.presetBag = true;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window', 'mass-edit-bag'],\r\n      template: `modules/${MODULE_ID}/templates/preset/bag/bag.html`,\r\n      width: 360,\r\n      height: 360,\r\n      resizable: true,\r\n      minimizable: true,\r\n      scrollY: ['.item-list'],\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return 'mass-edit-bag-' + this.preset.uuid;\r\n  }\r\n\r\n  /** @override */\r\n  get title() {\r\n    return `Bag: ` + this.preset.name;\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options) {\r\n    const bag = this.preset.data[0];\r\n\r\n    let uuids = bag.uuids.map((i) => i.uuid);\r\n    const containedPresets = uuids.length ? await PresetAPI.getPresets({ uuid: uuids, full: false }) : null;\r\n    const searchedPresets = bag.completedSearch?.length\r\n      ? await PresetAPI.getPresets({ uuid: bag.completedSearch, full: false })\r\n      : null;\r\n\r\n    return {\r\n      containedPresets,\r\n      searchedPresets,\r\n      displayLabels: containedPresets && searchedPresets,\r\n      searchBar: bag.searchBar,\r\n    };\r\n  }\r\n\r\n  /** @override */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    this.setAppearance();\r\n    html.find('.header-search input').on('input', this._onSearchInput.bind(this));\r\n  }\r\n\r\n  _onSearchInput(event) {\r\n    let search = event.target.value.trim().toLowerCase();\r\n\r\n    if (search) {\r\n      $(event.target).addClass('active');\r\n      this.element.find('.item').each(function () {\r\n        const item = $(this);\r\n        if (!item.attr('name').toLowerCase().includes(search)) item.hide();\r\n      });\r\n    } else {\r\n      $(event.target).removeClass('active');\r\n      this.element.find('.item').show();\r\n    }\r\n  }\r\n\r\n  setAppearance(appearance) {\r\n    appearance = appearance ?? this.preset.data[0].appearance;\r\n    if (!appearance) return;\r\n\r\n    const html = $(this.element);\r\n\r\n    const hColor = Color.fromString(appearance.header.color);\r\n    html.find('header, .static-label').css('background-color', hColor.toRGBA(appearance.header.alpha));\r\n\r\n    const bColor = Color.fromString(appearance.background.color);\r\n    html\r\n      .find('.window-content')\r\n      .attr('style', `background-color: ${bColor.toRGBA(appearance.background.alpha)} !important;`);\r\n  }\r\n\r\n  /**\r\n   * Process dropped preset uuids\r\n   * @param {Array[String]} uuids\r\n   * @returns\r\n   */\r\n  async _dropUuids(droppedUuids) {\r\n    if (!droppedUuids?.length || !game.user.isGM) return;\r\n\r\n    const bag = this.preset.data[0];\r\n\r\n    let sort = bag.uuids.length\r\n      ? Math.max.apply(\r\n          null,\r\n          bag.uuids.map((p) => p.sort)\r\n        )\r\n      : 0;\r\n\r\n    const bagUuids = bag.uuids.map((p) => p.uuid);\r\n    for (const uuid of droppedUuids) {\r\n      if (!bagUuids.includes(uuid)) {\r\n        sort++;\r\n        bag.uuids.push({ sort, uuid });\r\n      }\r\n    }\r\n\r\n    this.preset.update({ data: { uuids: bag.uuids } });\r\n    this.render(true);\r\n  }\r\n\r\n  /** @override */\r\n  async _onDeleteSelectedPresets(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n      full: false,\r\n    });\r\n\r\n    if (selected.length) {\r\n      const uuids = this.preset.data[0].uuids.filter((i) => !selected.find((s) => s.uuid === i.uuid));\r\n      this.preset.update({ data: { uuids } });\r\n\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  /** @override */\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    if (game.user.isGM) {\r\n      if (Preset.isEditable(this.preset.uuid)) {\r\n        buttons.unshift({\r\n          label: '',\r\n          class: 'mass-edit-bag-configure',\r\n          icon: 'fa-solid fa-gear',\r\n          onclick: () => {\r\n            new BagConfig(this.preset, this).render(true);\r\n          },\r\n        });\r\n      }\r\n\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-bag-macro',\r\n        icon: 'fas fa-terminal',\r\n        onclick: this._onCreateMacro.bind(this),\r\n      });\r\n    }\r\n\r\n    if (game.user.isGM && Preset.isEditable(this.preset.uuid)) {\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-bag-refresh',\r\n        icon: 'fa-solid fa-arrows-rotate',\r\n        onclick: this._onRefreshSearch.bind(this),\r\n      });\r\n    }\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _onCreateMacro() {\r\n    const response = await new Promise((resolve) => {\r\n      Dialog.confirm({\r\n        title: 'Create Bag Macro',\r\n        content: `<p>Do you wish to create a quick access macro for preset bag: [<b>${this.preset.name}</b>] ?</p>`,\r\n        yes: () => resolve(true),\r\n        no: () => resolve(false),\r\n        defaultYes: false,\r\n      });\r\n    });\r\n\r\n    if (!response) return;\r\n\r\n    const macro = await Macro.create({\r\n      name: 'Bag: ' + this.preset.name,\r\n      type: 'script',\r\n      scope: 'global',\r\n      command: `// Open Mass Edit preset bag\\nMassEdit.openBag('${this.preset.uuid}');`,\r\n      img: this.preset.img,\r\n    });\r\n    macro.sheet.render(true);\r\n  }\r\n\r\n  async _onRefreshSearch(notify = true) {\r\n    if (this.refreshing) {\r\n      ui.notification.warn('Refresh is in progress. Please wait.');\r\n      return;\r\n    }\r\n\r\n    this.refreshing = true;\r\n\r\n    const bag = this.preset.data[0];\r\n    const searches = bag.searches;\r\n    const virtualDirectory = bag.virtualDirectory;\r\n\r\n    let uuids = new Set();\r\n\r\n    for (const search of searches.inclusive) {\r\n      (\r\n        await PresetAPI.getPresets({\r\n          query: search.terms,\r\n          matchAny: !search.matchAll,\r\n          virtualDirectory,\r\n          full: false,\r\n        })\r\n      ).forEach((p) => uuids.add(p.uuid));\r\n    }\r\n\r\n    if (uuids.size) {\r\n      for (const search of searches.exclusive) {\r\n        if (tags) tags = { tags, matchAny: !search.matchAll };\r\n        (\r\n          await PresetAPI.getPresets({\r\n            query: search.terms,\r\n            matchAny: !search.matchAll,\r\n            virtualDirectory,\r\n            full: false,\r\n          })\r\n        ).forEach((p) => uuids.delete(p.uuid));\r\n      }\r\n    }\r\n\r\n    await this.preset.update({\r\n      data: {\r\n        completedSearch: uuids.size ? Array.from(uuids) : null,\r\n      },\r\n    });\r\n    if (notify) ui.notifications.info('Bag contents have been refreshed: ' + this.preset.name);\r\n    this.render(true);\r\n    this.refreshing = false;\r\n  }\r\n\r\n  // TODO OVERRIDE and add flags or post spawn hook to support MTFY\r\n  // /** @override */\r\n  // async _onSpawnPreset(preset) {\r\n\r\n  //   const flags = this.preset.data[0].flags;\r\n  //   if(flags) {\r\n\r\n  //   }\r\n\r\n  //   preset = preset.clone();\r\n\r\n  // }\r\n\r\n  /** @override */\r\n  setPosition(...args) {\r\n    super.setPosition(...args);\r\n\r\n    const { left, top, width, height } = this.position;\r\n    BagApplication.previousPositions[this.preset.uuid] = { left, top, width, height };\r\n  }\r\n}\r\n\r\nclass BagConfig extends FormApplication {\r\n  constructor(preset, parentForm) {\r\n    super({}, {});\r\n    this.preset = preset.clone();\r\n    this._originalPreset = preset;\r\n    this.parentForm = parentForm;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window', 'mass-edit-bag-config'],\r\n      template: `modules/${MODULE_ID}/templates/preset/bag/config.html`,\r\n      width: 370,\r\n      height: 'auto',\r\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.content', initial: 'search' }],\r\n      resizable: false,\r\n      minimizable: true,\r\n    });\r\n  }\r\n\r\n  /** @override */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.on('click', '.addSearchTerm', this._onAddSearchTerm.bind(this));\r\n    html.on('click', '.removeSearchTerm', this._onRemoveSearchTerm.bind(this));\r\n\r\n    //html.on('input', 'color-picker', this._onAppearanceFieldChange.bind(this));\r\n    html.on('change', 'color-picker, [type=\"range\"]', this._onAppearanceFieldChange.bind(this));\r\n    html.on('input', 'input', () => this._saveState());\r\n  }\r\n\r\n  _saveState(formData, clearEmptySearch = false) {\r\n    if (!formData) formData = this._getSubmitData();\r\n\r\n    formData = foundry.utils.expandObject(formData);\r\n\r\n    ['inclusive', 'exclusive'].forEach((type) => {\r\n      if (formData.searches?.[type]) {\r\n        const searches = [];\r\n        let i = 0;\r\n        let search = formData.searches[type][i];\r\n        while (search != undefined) {\r\n          if (!clearEmptySearch || search.terms.trim() !== '') searches.push(search);\r\n          search = formData.searches[type][++i];\r\n        }\r\n        this.preset.data[0].searches[type] = searches;\r\n      }\r\n    });\r\n\r\n    if (formData.flags) this.preset.data[0].flags = formData.flags;\r\n\r\n    this.preset.data[0].virtualDirectory = formData.virtualDirectory;\r\n    this.preset.data[0].appearance = formData.appearance;\r\n    this.preset.data[0].searchBar = formData.searchBar;\r\n  }\r\n\r\n  async _onAppearanceFieldChange() {\r\n    const appearance = foundry.utils.expandObject(this._getSubmitData()).appearance;\r\n    this.parentForm?.setAppearance(appearance);\r\n  }\r\n\r\n  async _onAddSearchTerm(event) {\r\n    const type = $(event.currentTarget).data('type');\r\n\r\n    this.preset.data[0].searches[type].push({\r\n      terms: '',\r\n      matchAll: true,\r\n    });\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onRemoveSearchTerm(event) {\r\n    const type = $(event.currentTarget).data('type');\r\n    const index = $(event.currentTarget).data('index');\r\n\r\n    this.preset.data[0].searches[type].splice(index, 1);\r\n    this.render(true);\r\n  }\r\n\r\n  /** @override */\r\n  _getFolderContextOptions() {\r\n    return [];\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options) {\r\n    const data = this.preset.data[0];\r\n    if (!data.appearance) {\r\n      data.appearance = {\r\n        header: {\r\n          color: '#000000',\r\n          alpha: 1.0,\r\n        },\r\n        background: {\r\n          color: '#323232',\r\n          alpha: 0.8,\r\n        },\r\n      };\r\n    }\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    this._saveState(formData, true);\r\n    this._originalPreset.update({ data: this.preset.data });\r\n    this.parentForm?._onRefreshSearch(false);\r\n  }\r\n\r\n  /** @override */\r\n  get title() {\r\n    return 'Configure Bag: ' + this.preset.name;\r\n  }\r\n\r\n  /** @override */\r\n  get id() {\r\n    return `mass-edit-bag-config-` + this.preset.uuid;\r\n  }\r\n}\r\n","class TrackerDialog extends Dialog {\r\n  constructor(options, { total, cancelCallback, left, top }) {\r\n    super(options, { left, top });\r\n    this.count = 0;\r\n    this.total = total;\r\n    this.cancelCallback = cancelCallback;\r\n  }\r\n\r\n  incrementCount() {\r\n    this.count++;\r\n    this.element?.find('.count').html(this.count);\r\n  }\r\n\r\n  stop() {\r\n    this.close(true);\r\n  }\r\n\r\n  get active() {\r\n    return this._state === Application.RENDER_STATES.RENDERED || this._state === Application.RENDER_STATES.RENDERING;\r\n  }\r\n}\r\n\r\nexport async function trackProgress({ title = 'Progress', cancelCallback, total } = {}) {\r\n  if (!total) return;\r\n\r\n  let content = `\r\n<div>\r\n<div  style=\"display: block; text-align: center; padding: 5px;\"><i class=\"fas fa-circle-notch fa-spin fa-3x\"></i></div>\r\n    <p style=\"text-align: center;\"><span class=\"count\">count</span>/${total}</p>\r\n</div>`;\r\n\r\n  const dialog = new TrackerDialog(\r\n    {\r\n      title,\r\n      content,\r\n      buttons: {\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-stop\"></i>',\r\n          label: 'Stop/Cancel',\r\n          callback: () => {\r\n            cancelCallback?.();\r\n          },\r\n        },\r\n      },\r\n      default: 'cancel',\r\n    },\r\n    { total, cancelCallback, left: 50, top: 50 }\r\n  );\r\n\r\n  await dialog._render(true);\r\n\r\n  return dialog;\r\n}\r\n\r\nexport function countFolderItems(folder) {\r\n  if (folder.presets) {\r\n    return (\r\n      folder.presets.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c);\r\n      }, 0)\r\n    );\r\n  } else {\r\n    return (\r\n      folder.contents.length +\r\n      folder.children.reduce(function (sum, c) {\r\n        return sum + countFolderItems(c.folder);\r\n      }, 0)\r\n    );\r\n  }\r\n}\r\n","/**\r\n * A collection of functions related to sorting objects within a parent container.\r\n */\r\nexport class SortingHelpersFixed {\r\n  /**\r\n   * Given a source object to sort, a target to sort relative to, and an Array of siblings in the container:\r\n   * Determine the updated sort keys for the source object, or all siblings if a reindex is required.\r\n   * Return an Array of updates to perform, it is up to the caller to dispatch these updates.\r\n   * Each update is structured as:\r\n   * {\r\n   *   target: object,\r\n   *   update: {sortKey: sortValue}\r\n   * }\r\n   *\r\n   * @param {object} source       The source object being sorted\r\n   * @param {object} [options]    Options which modify the sort behavior\r\n   * @param {object|null} [options.target]  The target object relative which to sort\r\n   * @param {object[]} [options.siblings]   The Array of siblings which the source should be sorted within\r\n   * @param {string} [options.sortKey=sort] The property name within the source object which defines the sort key\r\n   * @param {boolean} [options.sortBefore]  Explicitly sort before (true) or sort after( false).\r\n   *                                        If undefined the sort order will be automatically determined.\r\n   * @returns {object[]}          An Array of updates for the caller of the helper function to perform\r\n   */\r\n  static performIntegerSort(\r\n    source,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > 1) {\r\n      return [\r\n        {\r\n          target: source,\r\n          update: { [sortKey]: Math.round(0.5 * (min + max)) },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Reindex all siblings\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, source);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  static performIntegerSortMulti(\r\n    sources,\r\n    { target = null, siblings = [], sortKey = 'sort', sortBefore } = {}\r\n  ) {\r\n    let source = sources[0];\r\n    // Automatically determine the sorting direction\r\n    if (sortBefore === undefined) {\r\n      sortBefore = (source[sortKey] || 0) > (target?.[sortKey] || 0);\r\n    }\r\n\r\n    // Ensure the siblings are sorted\r\n    siblings = Array.from(siblings);\r\n    siblings.sort((a, b) => a[sortKey] - b[sortKey]);\r\n\r\n    // Determine the index target for the sort\r\n    let defaultIdx = sortBefore ? siblings.length : 0;\r\n    let idx = target ? siblings.findIndex((sib) => sib === target) : defaultIdx;\r\n\r\n    // Determine the indices to sort between\r\n    let min, max;\r\n    if (sortBefore) [min, max] = this._sortBefore(siblings, idx, sortKey);\r\n    else [min, max] = this._sortAfter(siblings, idx, sortKey);\r\n\r\n    // Easiest case - no siblings\r\n    if (siblings.length === 0) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No minimum - sort to beginning\r\n    else if (Number.isFinite(max) && min === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: max - CONST.SORT_INTEGER_DENSITY * (sources.length - i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // No maximum - sort to end\r\n    else if (Number.isFinite(min) && max === null) {\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + CONST.SORT_INTEGER_DENSITY * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Sort between two\r\n    else if (Number.isFinite(min) && Number.isFinite(max) && Math.abs(max - min) > sources.length) {\r\n      let increment = Math.floor((1 / (sources.length + 1)) * Math.abs(max - min));\r\n      if (increment === 0) increment = 1;\r\n      min = Math.min(max, min);\r\n\r\n      return sources.map((s, i) => {\r\n        return {\r\n          target: s,\r\n          update: { [sortKey]: min + increment * (i + 1) },\r\n        };\r\n      });\r\n    }\r\n\r\n    // Reindex all\r\n    else {\r\n      siblings.splice(idx + (sortBefore ? 0 : 1), 0, ...sources);\r\n      return siblings.map((sib, i) => {\r\n        return {\r\n          target: sib,\r\n          update: { [sortKey]: (i + 1) * CONST.SORT_INTEGER_DENSITY },\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort before the target\r\n   * @private\r\n   */\r\n  static _sortBefore(siblings, idx, sortKey) {\r\n    let max = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let min = siblings[idx - 1] ? siblings[idx - 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Given an ordered Array of siblings and a target position, return the [min,max] indices to sort after the target\r\n   * @private\r\n   */\r\n  static _sortAfter(siblings, idx, sortKey) {\r\n    let min = siblings[idx] ? siblings[idx][sortKey] : null;\r\n    let max = siblings[idx + 1] ? siblings[idx + 1][sortKey] : null;\r\n    return [min, max];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { PresetBrowser } from './browser/browserApp.js';\r\n\r\nexport class TagSelector extends FormApplication {\r\n  constructor(presetsApp) {\r\n    const defaultOptions = TagSelector.defaultOptions;\r\n    super({}, { left: presetsApp.position.left - defaultOptions.width - 5, top: presetsApp.position.top });\r\n    this.presetsApp = presetsApp;\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'tag-selector',\r\n      classes: ['mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/tagSelector.html`,\r\n      resizable: true,\r\n      minimizable: true,\r\n      width: 200,\r\n      height: 500,\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return 'Tag Selector';\r\n  }\r\n\r\n  async close(options = {}) {\r\n    this.presetsApp._tagSelector = null;\r\n    return super.close(options);\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    const tagMap = this.getTagsOfRendered();\r\n    const searchedTagsArr = this.getSearchedTags();\r\n\r\n    let tags = [];\r\n    let activeTags = [];\r\n    tagMap.forEach((count, tag) => {\r\n      const t = { name: tag, count };\r\n      if (searchedTagsArr.includes(tag)) activeTags.push(t);\r\n      else tags.push(t);\r\n    });\r\n\r\n    tags = tags.sort((t1, t2) => t2.count - t1.count);\r\n    activeTags = activeTags.sort((t1, t2) => t2.count - t1.count);\r\n\r\n    return { tags, activeTags };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.on('click', '.tag', this._onClickTag.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Collate all tags of render-able presets\r\n   */\r\n  getTagsOfRendered() {\r\n    const tags = new Map();\r\n\r\n    this.presetsApp.tree.folders.forEach((f) => this._getFolderTags(f, tags));\r\n    this.presetsApp.tree.extFolders.forEach((f) => this._getFolderTags(f, tags));\r\n    this.presetsApp.tree.presets.forEach((p) => this._getPresetTags(p, tags));\r\n\r\n    return tags;\r\n  }\r\n\r\n  getSearchedTags() {\r\n    const search = PresetBrowser.lastSearch ?? '';\r\n    const tags = search\r\n      .split(' ')\r\n      .filter((k) => k.startsWith('#'))\r\n      .map((k) => k.substring(1));\r\n    return tags;\r\n  }\r\n\r\n  _getFolderTags(folder, tags) {\r\n    if (!folder.render) return;\r\n\r\n    for (const f of folder.children) {\r\n      this._getFolderTags(f, tags);\r\n    }\r\n\r\n    for (const p of folder.presets) {\r\n      this._getPresetTags(p, tags);\r\n    }\r\n  }\r\n\r\n  _getPresetTags(preset, tags) {\r\n    if (preset.visible) {\r\n      for (const tag of preset.tags) {\r\n        tags.set(tag, (tags.get(tag) ?? 0) + 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  _onClickTag(event) {\r\n    const tag = '#' + $(event.currentTarget).find('span').first().text();\r\n\r\n    const searchInput = this.presetsApp.element.find('.header-search input');\r\n    let search = searchInput.val();\r\n\r\n    if ($(event.currentTarget).hasClass('active')) {\r\n      search = search\r\n        .split(' ')\r\n        .filter((k) => k !== tag)\r\n        .filter(Boolean)\r\n        .join(' ');\r\n    } else {\r\n      if (!search.endsWith(' ') && search.length) search += ' ';\r\n      search += tag;\r\n    }\r\n\r\n    searchInput.val(search).trigger('input');\r\n  }\r\n}\r\n","import { MODULE_ID, UI_DOCS } from '../../constants.js';\r\nimport { DOC_ICONS } from '../preset.js';\r\n\r\nexport default class PresetBrowserSettings extends FormApplication {\r\n  constructor(browser) {\r\n    super({}, {});\r\n    this.browser = browser;\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-browser-settings',\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/browserSettings.html`,\r\n      resizable: false,\r\n      minimizable: false,\r\n      title: 'Settings',\r\n      width: 400,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = foundry.utils.deepClone(game.settings.get(MODULE_ID, 'presetBrowser'));\r\n\r\n    data.dropdownDocuments = UI_DOCS.map((name) => {\r\n      return { name, active: data.dropdownDocuments.includes(name), icon: DOC_ICONS[name] };\r\n    });\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.find('.document-select').on('click', (event) => {\r\n      $(event.target).closest('.document-select').toggleClass('active');\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    const dropdownDocuments = [];\r\n    $(this.form)\r\n      .find('.document-select.active')\r\n      .each(function () {\r\n        dropdownDocuments.push($(this).data('name'));\r\n      });\r\n    formData.dropdownDocuments = dropdownDocuments;\r\n\r\n    const settings = foundry.utils.mergeObject(game.settings.get(MODULE_ID, 'presetBrowser'), formData);\r\n    await game.settings.set(MODULE_ID, 'presetBrowser', settings);\r\n    this.browser?.render(true);\r\n  }\r\n}\r\n","import { TokenDataAdapter } from '../../data/adapters.js';\r\nimport { copyToClipboard } from '../../../applications/formUtils.js';\r\nimport { countFolderItems, trackProgress } from '../../../applications/progressDialog.js';\r\nimport { importPresetFromJSONDialog } from '../../dialogs.js';\r\nimport { SortingHelpersFixed } from '../../fixedSort.js';\r\nimport { localFormat, localize, spawnSceneAsPreset } from '../../utils.js';\r\nimport { META_INDEX_ID, PresetAPI, PresetCollection, PresetPackFolder } from '../collection.js';\r\nimport { FileIndexer, IndexerForm } from '../fileIndexer.js';\r\nimport { LinkerAPI } from '../../linker/linker.js';\r\nimport { DOC_ICONS, Preset } from '../preset.js';\r\nimport { exportPresets, FolderState, parseSearchQuery, placeableToData } from '../utils.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES, UI_DOCS } from '../../constants.js';\r\nimport { PresetContainer } from '../containerApp.js';\r\nimport { PresetConfig } from '../editApp.js';\r\nimport { TagSelector } from '../tagSelector.js';\r\nimport PresetBrowserSettings from './settingsApp.js';\r\n\r\nconst SEARCH_MIN_CHAR = 2;\r\nconst SEARCH_FOUND_MAX_COUNT = 1001;\r\n\r\n// const FLAG_DATA = {\r\n//   documentName: null,\r\n//   data: null,\r\n//   addSubtract: null,\r\n//   randomize: null,\r\n// };\r\n\r\nconst SORT_MODES = {\r\n  manual: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeManual', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-short-wide\"></i>',\r\n  },\r\n  alphabetical: {\r\n    get tooltip() {\r\n      return localize('SIDEBAR.SortModeAlpha', false);\r\n    },\r\n    icon: '<i class=\"fa-solid fa-arrow-down-a-z\"></i>',\r\n  },\r\n};\r\n\r\nconst SEARCH_MODES = {\r\n  p: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets');\r\n    },\r\n    icon: '<i class=\"fas fa-search\"></i>',\r\n  },\r\n  pf: {\r\n    get tooltip() {\r\n      return localize('presets.search-presets-folders');\r\n    },\r\n    icon: '<i class=\"fa-solid fa-folder-magnifying-glass\"></i>',\r\n  },\r\n};\r\n\r\nexport function openPresetBrowser(documentName) {\r\n  new PresetBrowser(null, null, documentName).render(true);\r\n}\r\n\r\nexport class PresetBrowser extends PresetContainer {\r\n  static objectHover = false;\r\n  static lastSearch;\r\n  static CONFIG;\r\n\r\n  static async setSetting(setting, value) {\r\n    return await game.settings.set(MODULE_ID, 'presetBrowser', { ...PresetBrowser.CONFIG, [setting]: value });\r\n  }\r\n\r\n  get lastSearch() {\r\n    return this._lastSearch;\r\n  }\r\n\r\n  set lastSearch(val) {\r\n    this._lastSearch = val;\r\n    PresetBrowser.lastSearch = val;\r\n  }\r\n\r\n  constructor(configApp, callback, documentName, options = {}) {\r\n    // Restore position and dimensions the previously closed window\r\n    if (!options.preventPositionOverride && PresetBrowser.previousPosition) {\r\n      options = { ...options, ...PresetBrowser.previousPosition };\r\n    }\r\n\r\n    super({}, { ...options, sortable: true, duplicatable: true });\r\n    this.callback = callback;\r\n\r\n    if (!configApp && UI_DOCS.includes(documentName)) {\r\n      this.documentName = PresetBrowser.CONFIG.documentLock || documentName;\r\n    } else {\r\n      this.configApp = configApp;\r\n      this.documentName = documentName || this.configApp.documentName;\r\n    }\r\n\r\n    this.lastSearch = PresetBrowser.CONFIG.persistentSearch ? PresetBrowser.lastSearch : '';\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-presets',\r\n      classes: ['sheet', 'mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/browser.html`,\r\n      resizable: true,\r\n      minimizable: true,\r\n      width: 377,\r\n      height: 900,\r\n      scrollY: ['.item-list'],\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    let title = localize('presets.preset-browser');\r\n    if (!UI_DOCS.includes(this.documentName)) title += ` [${this.documentName}]`;\r\n    return title;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = await super.getData(options);\r\n\r\n    this.tree = await PresetCollection.getTree(this.documentName, {\r\n      externalCompendiums: PresetBrowser.CONFIG.externalCompendiums,\r\n      virtualDirectory: PresetBrowser.CONFIG.virtualDirectory,\r\n      setFormVisibility: true,\r\n    });\r\n    this._tagSelector?.render(true);\r\n\r\n    if (PresetBrowser.CONFIG.persistentSearch && this.lastSearch) {\r\n      this._onSearch(this.lastSearch, { render: false });\r\n      data.lastSearch = this.lastSearch;\r\n    } else data.lastSearch = '';\r\n\r\n    data.presets = this.tree.presets;\r\n    data.folders = this.tree.folders;\r\n    data.extFolders = this.tree.extFolders.length ? this.tree.extFolders : null;\r\n\r\n    data.createEnabled = Boolean(this.configApp);\r\n    data.isPlaceable = SUPPORTED_PLACEABLES.includes(this.documentName) || this.documentName === 'ALL';\r\n    data.allowDocumentSwap = UI_DOCS.includes(this.documentName) && !this.configApp;\r\n    data.docLockActive = PresetBrowser.CONFIG.documentLock === this.documentName;\r\n    data.layerSwitchActive = PresetBrowser.CONFIG.switchLayer;\r\n    data.autoScale = PresetBrowser.CONFIG.autoScale;\r\n    data.externalCompendiums = PresetBrowser.CONFIG.externalCompendiums;\r\n    data.virtualDirectory = PresetBrowser.CONFIG.virtualDirectory;\r\n    data.sortMode = SORT_MODES[PresetBrowser.CONFIG.sortMode];\r\n    data.searchMode = SEARCH_MODES[PresetBrowser.CONFIG.searchMode];\r\n    data.displayDragDropMessage =\r\n      data.allowDocumentSwap && !(this.tree.presets.length || this.tree.folders.length || data.extFolders);\r\n\r\n    data.docs = [];\r\n    data.docsDropdown = PresetBrowser.CONFIG.dropdownDocuments.length ? [] : null;\r\n    UI_DOCS.forEach((name) => {\r\n      const doc = { name, icon: DOC_ICONS[name], tooltip: name === 'ALL' ? 'Placeables' : name };\r\n      if (PresetBrowser.CONFIG.dropdownDocuments.includes(name)) data.docsDropdown.push(doc);\r\n      else data.docs.push(doc);\r\n    });\r\n\r\n    data.documents = UI_DOCS;\r\n    data.currentDocument = this.documentName;\r\n\r\n    data.callback = Boolean(this.callback);\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          PresetBrowser.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          PresetBrowser.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        hoverOverlay.hide();\r\n        PresetBrowser.objectHover = false;\r\n      });\r\n\r\n    // Create Preset from Selected\r\n    html.find('.create-preset').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // Create a Preset Bag\r\n    html.find('.create-bag').on('click', this._createNewBag.bind(this));\r\n\r\n    html.on('click', '.toggle-sort', this._onToggleSort.bind(this));\r\n    html.on('click', '.toggle-doc-lock', this._onToggleLock.bind(this));\r\n    html.on('click', '.toggle-setting', this._onToggleSetting.bind(this));\r\n    html.on('click', '.document-select', this._onDocumentChange.bind(this));\r\n    html.on('click', '.create-folder', this._onCreateFolder.bind(this));\r\n    html.on('click', '.preset-create', this._onPresetCreate.bind(this));\r\n    html.on('click', '.preset-update a', this._onPresetUpdate.bind(this));\r\n    html.on('click', '.preset-callback', this._onApplyPreset.bind(this));\r\n    html.on('click', '.tagSelector', this._onToggleTagSelector.bind(this));\r\n\r\n    const headerSearch = html.find('.header-search input');\r\n    headerSearch.on('input', (event) => this._onSearchInput(event));\r\n\r\n    html.on('click', '.toggle-search-mode', (event) => {\r\n      this._onToggleSearch(event, headerSearch);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Process drag and drop of an Actor or Folder of actors\r\n   * @param {*} event\r\n   * @returns\r\n   */\r\n  _foundryDrop(event) {\r\n    const data = TextEditor.getDragEventData(event.originalEvent);\r\n    if (!foundry.utils.isEmpty(data)) {\r\n      if (data.type === 'Folder') {\r\n        const folder = fromUuidSync(data.uuid);\r\n        if (folder.type !== 'Actor') return false;\r\n        if (this._importTracker?.active) return false;\r\n\r\n        trackProgress({\r\n          title: 'Converting Actors',\r\n          total: countFolderItems(folder),\r\n        }).then(async (tracker) => {\r\n          this._importTracker = tracker;\r\n          await this._importActorFolder(folder, null, { keepId: true });\r\n          this._importTracker?.stop();\r\n        });\r\n        return true;\r\n      } else if (data.type === 'Actor') {\r\n        PresetAPI.createPresetFromActorUuid(data.uuid, { keepId: true }).then((preset) => {\r\n          if (preset)\r\n            PresetCollection.set(preset).then(() => {\r\n              this.render(true);\r\n            });\r\n        });\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  async _importActorFolder(folder, parentFolder = null, options = {}) {\r\n    let nFolder = new Folder.implementation(\r\n      {\r\n        _id: options.keepId ? folder.id : null,\r\n        name: folder.name,\r\n        type: 'JournalEntry',\r\n        sorting: folder.sorting,\r\n        folder: parentFolder,\r\n        color: folder.color ?? '#000000',\r\n        flags: { [MODULE_ID]: { types: ['ALL', 'Token'] } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    nFolder = await Folder.create(nFolder, {\r\n      pack: nFolder.pack,\r\n      keepId: options.keepId,\r\n    });\r\n\r\n    for (const child of folder.children) {\r\n      if (!this._importTracker?.active) break;\r\n      await this._importActorFolder(child.folder, nFolder.id, options);\r\n    }\r\n\r\n    const presets = [];\r\n\r\n    for (const actor of folder.contents) {\r\n      if (!this._importTracker?.active) break;\r\n      presets.push(\r\n        await PresetAPI.createPresetFromActorUuid(actor.uuid, {\r\n          folder: nFolder.id,\r\n          keepId: options.keepId,\r\n        })\r\n      );\r\n      this._importTracker.incrementCount();\r\n    }\r\n\r\n    await PresetCollection.set(presets);\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onExportFolder(uuid) {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack && !this._importTracker?.active) {\r\n      const folder = this.tree.allFolders.get(uuid);\r\n      if (folder) {\r\n        this._importTracker = await trackProgress({\r\n          title: 'Exporting Folder',\r\n          total: countFolderItems(this.tree.allFolders.get(uuid)),\r\n        });\r\n        await this._onCopyFolder(uuid, null, pack, true, keepId);\r\n        this._importTracker?.stop();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onCopyFolder(uuid, parentId = null, pack, render = true, keepId = true) {\r\n    if (!pack) pack = PresetCollection.workingPack;\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    const folderDoc = await fromUuid(uuid);\r\n\r\n    if (folder) {\r\n      let types;\r\n      if (folderDoc) types = folderDoc.flags[MODULE_ID]?.types ?? ['ALL'];\r\n      else types = ['ALL'];\r\n\r\n      const data = {\r\n        _id: keepId ? folder.id : null,\r\n        name: folder.name,\r\n        color: folder.color,\r\n        sorting: folder.sorting,\r\n        folder: parentId,\r\n        flags: { [MODULE_ID]: { types } },\r\n        type: 'JournalEntry',\r\n      };\r\n      const nFolder = await Folder.create(data, { pack, keepId });\r\n\r\n      const presets = await PresetCollection.batchLoadPresets(folder.presets);\r\n\r\n      const toCreate = [];\r\n\r\n      for (const preset of presets) {\r\n        if (!this._importTracker?.active) break;\r\n        const p = preset.clone();\r\n        p.folder = nFolder.id;\r\n        if (!keepId) p.id = foundry.utils.randomID();\r\n        toCreate.push(p);\r\n        this._importTracker?.incrementCount();\r\n      }\r\n\r\n      await PresetCollection.set(toCreate, pack);\r\n\r\n      for (const child of folder.children) {\r\n        if (!this._importTracker?.active) break;\r\n        await this._onCopyFolder(child.uuid, nFolder.id, pack, false, keepId);\r\n      }\r\n\r\n      if (render) this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onExportSelectedPresetsToComp() {\r\n    let { pack, keepId } = await new Promise((resolve) =>\r\n      getCompendiumDialog(resolve, { exportTo: true, keepIdSelect: true })\r\n    );\r\n    if (pack) this._onCopySelectedPresets(pack, { keepId });\r\n  }\r\n\r\n  async _onCopyPresetToClipboard() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    if (selected.length) copyToClipboard(selected[0]);\r\n  }\r\n\r\n  async _onExportSelectedPresets() {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n    exportPresets(selected);\r\n  }\r\n\r\n  async _onDeleteSelectedPresets(item) {\r\n    const [selected, items] = await this._getSelectedPresets({\r\n      editableOnly: true,\r\n      full: false,\r\n    });\r\n    if (selected.length) {\r\n      const confirm =\r\n        selected.length === 0\r\n          ? true\r\n          : await Dialog.confirm({\r\n              title: `${localize('common.delete')} [ ${selected.length} ]`,\r\n              content: `<p>${localize('AreYouSure', false)}</p><p>${localFormat('presets.delete-presets-warn', {\r\n                count: selected.length,\r\n              })}</p>`,\r\n            });\r\n\r\n      if (confirm) {\r\n        await PresetCollection.delete(selected);\r\n        items.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onCreateFolder(event) {\r\n    const types = [];\r\n    if (SUPPORTED_PLACEABLES.includes(this.documentName)) {\r\n      types.push('ALL', this.documentName);\r\n    } else {\r\n      types.push(this.documentName);\r\n    }\r\n\r\n    const folder = new Folder.implementation(\r\n      {\r\n        name: Folder.defaultName(),\r\n        type: 'JournalEntry',\r\n        sorting: 'm',\r\n        flags: { [MODULE_ID]: { types } },\r\n      },\r\n      { pack: PresetCollection.workingPack }\r\n    );\r\n\r\n    await new Promise((resolve) => {\r\n      new PresetFolderConfig(folder, { resolve }).render(true);\r\n    });\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onFolderEdit(header) {\r\n    const uuid = $(header).closest('.folder').data('uuid');\r\n    const pFolder = this.tree.allFolders.get(uuid);\r\n\r\n    let folder;\r\n    if (pFolder instanceof PresetPackFolder) {\r\n      // This is a virtual pack folder\r\n      folder = new Folder.implementation(\r\n        {\r\n          _id: pFolder.id,\r\n          name: pFolder.name,\r\n          type: 'JournalEntry',\r\n          color: pFolder.color,\r\n          sorting: pFolder.sorting,\r\n        },\r\n        { pack: pFolder.uuid }\r\n      );\r\n    } else {\r\n      folder = await fromUuid($(header).closest('.folder').data('uuid'));\r\n    }\r\n\r\n    new Promise((resolve) => {\r\n      const options = { resolve, ...header.offset(), folder: pFolder };\r\n      options.top += header.height();\r\n\r\n      new PresetFolderConfig(folder, options).render(true);\r\n    }).then(() => this.render(true));\r\n  }\r\n\r\n  async _onFolderDelete(uuid, { render = true, deleteAll = false } = {}) {\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder) {\r\n      let confirm;\r\n\r\n      if (deleteAll) {\r\n        // Construct warning count of what is about to be removed\r\n        const count = { Folder: 0 };\r\n        const traverseFolder = function (folder) {\r\n          count['Folder'] += 1;\r\n          folder.presets?.forEach((p) => {\r\n            count[p.documentName] = (count[p.documentName] ?? 0) + 1;\r\n          });\r\n          folder.children?.forEach((c) => traverseFolder(c));\r\n        };\r\n        traverseFolder(folder);\r\n\r\n        let countWarning = '';\r\n        if (Object.keys(count).length) {\r\n          countWarning += '<table>';\r\n          Object.keys(count).forEach((name) => {\r\n            countWarning += `<tr><td>${name}s</td><td>${count[name]}</td></tr>`;\r\n          });\r\n          countWarning += '</table>';\r\n        }\r\n        // end of constructing warning\r\n\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Delete', false)}: ${folder.name}`,\r\n          content: `<div style=\"color:red;\"><h4>${localize('AreYouSure', false)}</h4><p>${localize(\r\n            'FOLDER.DeleteWarning',\r\n            false\r\n          )}</p>${countWarning}</div>`,\r\n        });\r\n      } else {\r\n        confirm = await Dialog.confirm({\r\n          title: `${localize('FOLDER.Remove', false)}: ${folder.name}`,\r\n          content: `<h4>${localize('AreYouSure', false)}</h4><p>${localize('FOLDER.RemoveWarning', false)}</p>`,\r\n        });\r\n      }\r\n\r\n      if (confirm) {\r\n        await PresetCollection.deleteFolder(uuid, deleteAll);\r\n        if (render) this.render(true);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Throttle input and perform preset search\r\n  _onSearchInput(event) {\r\n    clearTimeout(this._searchTimer);\r\n    this._searchTimer = setTimeout(() => this._onSearch(event.target.value, { event }), 250);\r\n  }\r\n\r\n  async _onSearch(search, { event, render = true } = {}) {\r\n    let previousSearch = this.lastSearch || '';\r\n    this.lastSearch = search;\r\n\r\n    if (previousSearch.length >= SEARCH_MIN_CHAR && search.length < SEARCH_MIN_CHAR) {\r\n      if (event) $(event.target).removeClass('active');\r\n      this._resetSearchState();\r\n      if (render) this._renderContent();\r\n      return;\r\n    }\r\n\r\n    if (search.length < SEARCH_MIN_CHAR) return;\r\n\r\n    const { terms, tags, type } = parseSearchQuery(search, { matchAny: false });\r\n    if (!(terms || tags || type)) return;\r\n    if (event) $(event.target).addClass('active');\r\n\r\n    this._searchFoundPresets = [];\r\n    this.tree.folders.forEach((f) => this._searchFolder(terms, tags, type, f));\r\n    this.tree.extFolders.forEach((f) => this._searchFolder(terms, tags, type, f));\r\n    this.tree.presets.forEach((p) => this._searchPreset(terms, tags, type, p));\r\n\r\n    if (render) this._renderContent();\r\n  }\r\n\r\n  _searchFolder(filter, tags, type, folder, forceRender = false) {\r\n    const folderName = folder.name.toLowerCase();\r\n    let match = !tags && filter?.every((k) => folderName.includes(k));\r\n\r\n    let childFolderMatch = false;\r\n    for (const f of folder.children) {\r\n      if (this._searchFolder(filter, tags, type, f, match || forceRender)) childFolderMatch = true;\r\n    }\r\n\r\n    let presetMatch = false;\r\n    for (const p of folder.presets) {\r\n      if (this._searchPreset(filter, tags, type, p, match || forceRender)) presetMatch = true;\r\n    }\r\n\r\n    const containsMatch = match || childFolderMatch || presetMatch;\r\n    folder.expanded = childFolderMatch || presetMatch;\r\n    folder.render = containsMatch || forceRender;\r\n\r\n    return containsMatch;\r\n  }\r\n\r\n  _searchPreset(filter, tags, type, preset, forceRender = false) {\r\n    if (!preset._visible) return false;\r\n\r\n    const presetName = preset.name.toLowerCase();\r\n\r\n    let matched = true;\r\n    if (this._searchFoundPresets.length > SEARCH_FOUND_MAX_COUNT) matched = false;\r\n    else if (filter && !filter.every((k) => presetName.includes(k) || preset.tags.includes(k))) matched = false;\r\n    else if (type && preset.documentName !== type) matched = false;\r\n    else if (tags) {\r\n      if (tags.matchAny) matched = tags.tags.some((k) => preset.tags.includes(k));\r\n      else matched = tags.tags.every((k) => preset.tags.includes(k));\r\n    }\r\n\r\n    if (matched) {\r\n      preset._render = true;\r\n      this._searchFoundPresets.push(preset);\r\n      return preset._render;\r\n    } else {\r\n      preset._render = false || forceRender;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _resetSearchState() {\r\n    this._searchFoundPresets = [];\r\n    this.tree.folders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.extFolders.forEach((f) => this._resetSearchStateFolder(f));\r\n    this.tree.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStateFolder(folder) {\r\n    folder.expanded = FolderState.expanded(folder.uuid);\r\n    folder.render = true;\r\n    folder.children.forEach((f) => this._resetSearchStateFolder(f));\r\n    folder.presets.forEach((p) => this._resetSearchStatePreset(p));\r\n  }\r\n\r\n  _resetSearchStatePreset(preset) {\r\n    preset._render = true;\r\n  }\r\n\r\n  async _renderContent() {\r\n    let data;\r\n    if (PresetBrowser.CONFIG.searchMode === 'p') {\r\n      data = {\r\n        callback: Boolean(this.callback),\r\n        presets: this._searchFoundPresets,\r\n        folders: [],\r\n        createEnabled: Boolean(this.configApp),\r\n        extFolders: null,\r\n      };\r\n    } else {\r\n      data = {\r\n        callback: Boolean(this.callback),\r\n        presets: this.tree.presets,\r\n        folders: this.tree.folders,\r\n        createEnabled: Boolean(this.configApp),\r\n        extFolders: this.tree.extFolders.length ? this.tree.extFolders : null,\r\n      };\r\n    }\r\n\r\n    await super._renderContent(data);\r\n    this._tagSelector?.render(true);\r\n  }\r\n\r\n  async _onFolderSort(sourceUuid, targetUuid, { inside = true, folderUuid = null } = {}) {\r\n    let source = this.tree.allFolders.get(sourceUuid);\r\n    let target = this.tree.allFolders.get(targetUuid);\r\n\r\n    let folders;\r\n    if (folderUuid) folders = this.tree.allFolders.get(folderUuid).children;\r\n    else folders = this.tree.folders;\r\n\r\n    const siblings = [];\r\n    for (const folder of folders) {\r\n      if (folder.uuid !== sourceUuid) siblings.push(folder);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSort(source, {\r\n      target,\r\n      siblings,\r\n      sortBefore: true,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await Folder.updateDocuments(updates, {\r\n        pack: PresetCollection.workingPack,\r\n      });\r\n    }\r\n    this.render(true);\r\n  }\r\n\r\n  async _onItemSort(sourceUuids, targetUuid, { before = true, folderUuid = null } = {}) {\r\n    const sourceUuidsSet = new Set(sourceUuids);\r\n    const sources = this.tree.allPresets.filter((p) => sourceUuidsSet.has(p.uuid));\r\n\r\n    let target = this.tree.allPresets.find((p) => p.uuid === targetUuid);\r\n\r\n    // Determine siblings based on folder\r\n    let presets;\r\n    if (folderUuid) presets = this.tree.allFolders.get(folderUuid).presets;\r\n    else presets = this.tree.presets;\r\n\r\n    const siblings = [];\r\n    for (const preset of presets) {\r\n      if (!sourceUuidsSet.has(preset.uuid)) siblings.push(preset);\r\n    }\r\n\r\n    const result = SortingHelpersFixed.performIntegerSortMulti(sources, {\r\n      target,\r\n      siblings,\r\n      sortBefore: before,\r\n    });\r\n\r\n    if (result.length) {\r\n      const updates = [];\r\n      result.forEach((ctrl) => {\r\n        const update = ctrl.update;\r\n        update._id = ctrl.target.id;\r\n        update.folder = this.tree.allFolders.get(folderUuid)?.id ?? null;\r\n        updates.push(update);\r\n\r\n        // update preset object itself\r\n        // TODO: improve, this is done so that preset/pack does not need to get reloaded\r\n        const p = presets.find((p) => p.id === update._id);\r\n        if (p) {\r\n          p.folder = update.folder;\r\n          p.sort = update.sort;\r\n        }\r\n\r\n        ctrl.target.sort = update.sort;\r\n      });\r\n      await PresetCollection.updatePresets(updates);\r\n    }\r\n\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSort(event) {\r\n    await PresetBrowser.setSetting('sortMode', PresetBrowser.CONFIG.sortMode === 'manual' ? 'alphabetical' : 'manual');\r\n    this.render(true);\r\n  }\r\n\r\n  async _onToggleSearch(event, headerSearch) {\r\n    const searchControl = $(event.target).closest('.toggle-search-mode');\r\n\r\n    const currentMode = PresetBrowser.CONFIG.searchMode;\r\n    const newMode = currentMode === 'p' ? 'pf' : 'p';\r\n    await PresetBrowser.setSetting('searchMode', newMode);\r\n\r\n    const mode = SEARCH_MODES[newMode];\r\n    searchControl.attr('data-tooltip', mode.tooltip).html(mode.icon);\r\n\r\n    if (this.lastSearch) headerSearch.trigger('input');\r\n  }\r\n\r\n  _onToggleLock(event) {\r\n    const lockControl = $(event.target).closest('.toggle-doc-lock');\r\n\r\n    let newLock = this.documentName;\r\n    if (newLock !== PresetBrowser.CONFIG.documentLock) lockControl.addClass('active');\r\n    else {\r\n      lockControl.removeClass('active');\r\n      newLock = '';\r\n    }\r\n\r\n    PresetBrowser.setSetting('documentLock', newLock);\r\n  }\r\n\r\n  async _onToggleSetting(event) {\r\n    const setting = $(event.currentTarget).data('setting');\r\n    await PresetBrowser.setSetting(setting, !PresetBrowser.CONFIG[setting]);\r\n    this.render(true);\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    const newDocumentName = $(event.target).closest('.document-select').data('name');\r\n    if (newDocumentName != this.documentName) {\r\n      this.documentName = newDocumentName;\r\n\r\n      if (PresetBrowser.CONFIG.switchLayer)\r\n        canvas.getLayerByEmbeddedName(this.documentName === 'Actor' ? 'Token' : this.documentName)?.activate();\r\n\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  async _onApplyPreset(event) {\r\n    if (this.callback) {\r\n      const uuid = $(event.target).closest('.item').data('uuid');\r\n      this.callback(await PresetCollection.get(uuid));\r\n    }\r\n  }\r\n\r\n  async _onToggleTagSelector(event) {\r\n    if (this._tagSelector) {\r\n      this._tagSelector.close(true);\r\n      this._tagSelector = null;\r\n    } else {\r\n      this._tagSelector = new TagSelector(this);\r\n      this._tagSelector.render(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * Application.setPosition(...) has been modified to use css transform for window translation across the screen\r\n   * instead of top/left css properties which force full-window style recomputation\r\n   */\r\n  setPosition(...args) {\r\n    const position = super.setPosition(...args);\r\n\r\n    // Track position post window close\r\n    if (!this.options.preventPositionOverride) {\r\n      const { left, top, width, height } = position;\r\n      PresetBrowser.previousPosition = { left, top, width, height };\r\n    }\r\n\r\n    // Return the updated position object\r\n    return position;\r\n  }\r\n\r\n  async close(options = {}) {\r\n    PresetBrowser.objectHover = false;\r\n    this._tagSelector?.close();\r\n    this._endPreview();\r\n    return super.close(options);\r\n  }\r\n\r\n  async _onPresetUpdate(event) {\r\n    const preset = await PresetCollection.get($(event.target).closest('.item').data('uuid'));\r\n    if (!preset) return;\r\n\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const randomize = foundry.utils.deepClone(this.configApp.randomizeFields || {});\r\n    const addSubtract = foundry.utils.deepClone(this.configApp.addSubtractFields || {});\r\n\r\n    // Detection modes may have been selected out of order\r\n    // Fix that here\r\n    if (this.documentName === 'Token') {\r\n      TokenDataAdapter.correctDetectionModeOrder(selectedFields, randomize);\r\n    }\r\n\r\n    preset.update({ data: selectedFields, randomize, addSubtract });\r\n\r\n    ui.notifications.info(`Preset \"${preset.name}\" updated`);\r\n  }\r\n\r\n  async _onPresetCreate(event) {\r\n    const selectedFields =\r\n      this.configApp instanceof ActiveEffectConfig ? this._getActiveEffectFields() : this.configApp.getSelectedFields();\r\n    if (!selectedFields || foundry.utils.isEmpty(selectedFields)) {\r\n      ui.notifications.warn(localize('presets.warn-no-fields'));\r\n      return;\r\n    }\r\n\r\n    const preset = new Preset({\r\n      name: localize('presets.default-name'),\r\n      documentName: this.documentName,\r\n      data: selectedFields,\r\n      addSubtract: this.configApp.addSubtractFields,\r\n      randomize: this.configApp.randomizeFields,\r\n    });\r\n\r\n    await PresetCollection.set(preset);\r\n    this.render(true);\r\n\r\n    this._editPresets([preset], { isCreate: true }, event);\r\n  }\r\n\r\n  async _createNewBag() {\r\n    const presetBag = new Preset({\r\n      name: 'New Bag',\r\n      documentName: 'Bag',\r\n      img: `icons/containers/bags/pack-engraved-leather-tan.webp`,\r\n      data: [\r\n        {\r\n          uuids: [],\r\n          searches: {\r\n            inclusive: [],\r\n            exclusive: [],\r\n          },\r\n          virtualDirectory: true,\r\n        },\r\n      ],\r\n    });\r\n    await PresetCollection.set(presetBag);\r\n    this.render(true);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped on the form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n\r\n    // Switch to just created preset's category before rendering if not set to 'ALL'\r\n    const documentName = placeables[0].document.documentName;\r\n    if (this.documentName !== 'ALL' && this.documentName !== documentName) this.documentName = documentName;\r\n\r\n    const options = { isCreate: true };\r\n    options.left = this.position.left + this.position.width + 20;\r\n    options.top = this.position.top;\r\n\r\n    const linked = LinkerAPI.getLinkedDocuments(placeables.map((p) => p.document));\r\n    if (linked.size) {\r\n      const response = await new Promise((resolve) => {\r\n        Dialog.confirm({\r\n          title: 'Attach Linked',\r\n          content: `<p>Linked placeables have been detected [<b>${linked.size}</b>].</p><p>Should they be included as <b>Attached</b>?</p>`,\r\n          yes: () => resolve(true),\r\n          no: () => resolve(false),\r\n          defaultYes: false,\r\n        });\r\n      });\r\n      if (response) {\r\n        options.attached = Array.from(linked).map((l) => {\r\n          return { documentName: l.documentName, data: placeableToData(l) };\r\n        });\r\n      }\r\n    }\r\n\r\n    this._editPresets(presets, options, event);\r\n    this.render(true);\r\n  }\r\n\r\n  async actorToPreset(actor) {\r\n    const presets = await PresetAPI.createPreset(placeables);\r\n  }\r\n\r\n  _getActiveEffectFields() {\r\n    return {\r\n      changes: foundry.utils.deepClone(this.configApp.object.changes ?? []),\r\n    };\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-settings-config',\r\n      icon: 'fas fa-gear',\r\n      onclick: this._onSettingConfig.bind(this),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-change-compendium',\r\n      icon: 'fas fa-atlas',\r\n      onclick: this._onWorkingPackChange.bind(this),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-indexer',\r\n      icon: 'fas fa-archive',\r\n      onclick: this._onOpenIndexer.bind(this),\r\n    });\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: this._onExport.bind(this),\r\n    });\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-import',\r\n      icon: 'fas fa-file-import',\r\n      onclick: this._onImport.bind(this),\r\n    });\r\n\r\n    if (game.settings.get(MODULE_ID, 'debug')) {\r\n      buttons.unshift({\r\n        label: 'Debug',\r\n        class: 'mass-edit-debug',\r\n        icon: 'fas fa-bug',\r\n        onclick: (ev) => {\r\n          console.log({\r\n            index: game.packs.get(PresetCollection.workingPack).get(META_INDEX_ID)?.flags[MODULE_ID]?.index,\r\n            tree: this.tree,\r\n          });\r\n        },\r\n      });\r\n    }\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async _onWorkingPackChange() {\r\n    let pack = await new Promise((resolve) => getCompendiumDialog(resolve, {}));\r\n    if (pack && pack !== PresetCollection.workingPack) {\r\n      await game.settings.set(MODULE_ID, 'workingPack', pack);\r\n      this.render(true);\r\n    }\r\n  }\r\n\r\n  _onSettingConfig() {\r\n    new PresetBrowserSettings(this).render(true);\r\n  }\r\n\r\n  async _onOpenIndexer() {\r\n    if (FileIndexer._buildingIndex) {\r\n      ui.notifications.warn('Index Build In-Progress. Wait for it to finish before attempting it again.');\r\n      return;\r\n    }\r\n    new IndexerForm().render(true);\r\n  }\r\n\r\n  /**\r\n   * Export all working pack presets as as JSON file\r\n   */\r\n  async _onExport() {\r\n    const pack = game.packs.get(PresetCollection.workingPack);\r\n    await pack.getDocuments();\r\n    const tree = await PresetCollection.getTree(null, { externalCompendiums: false, virtualDirectory: false });\r\n    exportPresets(tree.allPresets);\r\n  }\r\n\r\n  async _onImport() {\r\n    const json = await importPresetFromJSONDialog();\r\n    if (!json) return;\r\n\r\n    let importCount = 0;\r\n\r\n    if (foundry.utils.getType(json) === 'Array') {\r\n      const presets = [];\r\n\r\n      for (const p of json) {\r\n        if (!('documentName' in p)) continue;\r\n        if (!('data' in p) || foundry.utils.isEmpty(p.data)) continue;\r\n\r\n        const preset = new Preset(p);\r\n        preset._pages = p.pages;\r\n\r\n        presets.push(preset);\r\n\r\n        importCount++;\r\n      }\r\n\r\n      await PresetCollection.set(presets);\r\n    }\r\n\r\n    ui.notifications.info(`Mass Edit: ${localFormat('presets.imported', { count: importCount })}`);\r\n\r\n    if (importCount) this.render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    if (this.callback) {\r\n      this.callback(await PresetCollection.get(event.submitter.data.id));\r\n    }\r\n  }\r\n}\r\n\r\nclass PresetFolderConfig extends FolderConfig {\r\n  static name = 'PresetFolderConfig';\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'folder-edit'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFolderEdit.html`,\r\n      width: 360,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return this.object.id ? super.id : 'folder-create';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    if (this.object.id) return `${localize('FOLDER.Update', false)}: ${this.object.name}`;\r\n    return localize('FOLDER.Create', false);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.document-select').on('click', this._onDocumentChange.bind(this));\r\n  }\r\n\r\n  _onDocumentChange(event) {\r\n    $(event.target).closest('.document-select').toggleClass('active');\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const folder = this.document.toObject();\r\n    const label = localize(Folder.implementation.metadata.label, false);\r\n\r\n    let folderDocs = folder.flags[MODULE_ID]?.types ?? ['ALL'];\r\n\r\n    let docs;\r\n\r\n    // This is a non-placeable folder type, so we will not display controls to change types\r\n    if (\r\n      this.options?.folder instanceof PresetPackFolder ||\r\n      (folderDocs.length === 1 && (folderDocs[0] === 'Bag' || !UI_DOCS.includes(folderDocs[0])))\r\n    ) {\r\n      this.displayTypes = false;\r\n    } else {\r\n      this.displayTypes = true;\r\n      docs = [];\r\n      UI_DOCS.forEach((type) => {\r\n        docs.push({\r\n          name: type,\r\n          icon: DOC_ICONS[type],\r\n          active: folderDocs.includes(type),\r\n        });\r\n      });\r\n    }\r\n\r\n    return {\r\n      folder: folder,\r\n      name: folder._id ? folder.name : '',\r\n      newName: localFormat('DOCUMENT.New', { type: label }, false),\r\n      safeColor: folder.color ?? '#000000',\r\n      sortingModes: { a: 'FOLDER.SortAlphabetical', m: 'FOLDER.SortManual' },\r\n      submitText: localize(folder._id ? 'FOLDER.Update' : 'FOLDER.Create', false),\r\n      docs,\r\n      virtualPackFolder: this.options.folder instanceof PresetPackFolder,\r\n      group: this.options.folder?.group,\r\n    };\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    if (this.displayTypes) {\r\n      let visibleTypes = [];\r\n      $(this.form)\r\n        .find('.document-select.active')\r\n        .each(function () {\r\n          visibleTypes.push($(this).data('name'));\r\n        });\r\n      if (!visibleTypes.length) visibleTypes.push('ALL');\r\n\r\n      formData[`flags.${MODULE_ID}.types`] = visibleTypes;\r\n    }\r\n\r\n    let document = this.object;\r\n    if (this.options.folder instanceof PresetPackFolder) {\r\n      // This is a virtual folder used to store Compendium contents within\r\n      // Update using the provided interface\r\n      let update = {};\r\n      ['name', 'color', 'group'].forEach((k) => {\r\n        if (!formData[k]?.trim()) update['-=' + k] = null;\r\n        else update[k] = formData[k].trim();\r\n      });\r\n\r\n      await this.options.folder.update(update);\r\n    } else {\r\n      // This is a real folder, update/create it\r\n      if (!formData.name?.trim()) formData.name = Folder.implementation.defaultName();\r\n      if (this.object.id) await this.object.update(formData);\r\n      else {\r\n        this.object.updateSource(formData);\r\n        document = await Folder.create(this.object, { pack: this.object.pack });\r\n      }\r\n    }\r\n\r\n    this.options.resolve?.(document);\r\n    return document;\r\n  }\r\n}\r\n\r\nfunction getCompendiumDialog(resolve, { excludePack, exportTo = false, keepIdSelect = false } = {}) {\r\n  let config;\r\n  if (exportTo) {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.export-directory-message'),\r\n      buttonLabel: localize('FOLDER.Export', false),\r\n    };\r\n  } else {\r\n    config = {\r\n      title: localize('presets.select-compendium'),\r\n      message: localize('presets.working-directory-message'),\r\n      buttonLabel: localize('common.swap'),\r\n    };\r\n  }\r\n\r\n  let options = '';\r\n  for (const p of game.packs) {\r\n    if (!p.locked && p.documentName === 'JournalEntry') {\r\n      if (p.collection === excludePack) continue;\r\n      const workingPack = p.collection === PresetCollection.workingPack;\r\n      options += `<option value=\"${p.collection}\" ${workingPack ? 'selected=\"selected\"' : ''}>${p.title}</option>`;\r\n    }\r\n  }\r\n\r\n  let content = `\r\n  <p style=\"color: orangered;\">${config.message}</p>\r\n  <div class=\"form-group\">\r\n    <label>${localize('PACKAGE.TagCompendium', false)}</label>\r\n    <div class=\"form-fields\">\r\n      <select style=\"width: 100%; margin-bottom: 10px;\">${options}</select>\r\n    </div>\r\n  </div>`;\r\n\r\n  if (keepIdSelect) {\r\n    content += `\r\n<div class=\"form-group\">\r\n    <label>${localize('presets.keep-ids')}</label>\r\n    <input type=\"checkbox\" name=\"keepId\" checked>\r\n    <p style=\"font-size: smaller;\">${localize('presets.keep-ids-hint')}</p>\r\n</div>`;\r\n  }\r\n\r\n  new Dialog({\r\n    title: config.title,\r\n    content: content,\r\n    buttons: {\r\n      export: {\r\n        label: config.buttonLabel,\r\n        callback: (html) => {\r\n          const pack = $(html).find('select').val();\r\n          if (keepIdSelect)\r\n            resolve({\r\n              pack,\r\n              keepId: $(html).find('[name=\"keepId\"]').is(':checked'),\r\n            });\r\n          else resolve(pack);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: localize('Cancel', false),\r\n        callback: () => resolve(keepIdSelect ? {} : null),\r\n      },\r\n    },\r\n    close: () => resolve(keepIdSelect ? {} : null),\r\n    default: 'cancel',\r\n  }).render(true);\r\n}\r\n\r\nexport function registerPresetBrowserHooks() {\r\n  // Intercept and prevent certain placeable drag and drop if they are hovering over the PresetBrowser form\r\n  // passing on the placeable to it to perform preset creation.\r\n  const dragDropHandler = function (wrapped, ...args) {\r\n    if (PresetBrowser.objectHover || PresetConfig.objectHover) {\r\n      this.mouseInteractionManager.cancel(...args);\r\n      const app = Object.values(ui.windows).find(\r\n        (x) =>\r\n          (PresetBrowser.objectHover && x instanceof PresetBrowser) ||\r\n          (PresetConfig.objectHover && x instanceof PresetConfig)\r\n      );\r\n      if (app) {\r\n        const placeables = canvas.activeLayer.controlled.length ? [...canvas.activeLayer.controlled] : [this];\r\n        app.dropPlaceable(placeables, ...args);\r\n      }\r\n      // Pass in a fake event that hopefully is enough to allow other modules to function\r\n      this._onDragLeftCancel(...args);\r\n    } else {\r\n      return wrapped(...args);\r\n    }\r\n  };\r\n\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    libWrapper.register(MODULE_ID, `${name}.prototype._onDragLeftDrop`, dragDropHandler, 'MIXED');\r\n  });\r\n\r\n  // Scene Control to open preset browser\r\n  Hooks.on('renderSceneControls', (sceneControls, html, options) => {\r\n    if (!game.user.isGM) return;\r\n    if (!game.settings.get(MODULE_ID, 'presetSceneControl')) return;\r\n\r\n    const presetControl = $(`\r\n<li class=\"scene-control mass-edit-scene-control\" data-control=\"me-presets\" aria-label=\"Mass Edit: Presets\" role=\"tab\" data-tooltip=\"Mass Edit: Presets\">\r\n  <i class=\"fa-solid fa-books\"></i>\r\n</li>\r\n  `);\r\n\r\n    presetControl.on('click', () => {\r\n      let documentName = canvas.activeLayer.constructor.documentName;\r\n      if (!SUPPORTED_PLACEABLES.includes(documentName)) documentName = 'ALL';\r\n\r\n      const presetForm = Object.values(ui.windows).find((app) => app instanceof PresetBrowser);\r\n      if (presetForm) {\r\n        presetForm.close();\r\n        return;\r\n      }\r\n\r\n      new PresetBrowser(null, null, documentName, {\r\n        left: presetControl.position().left + presetControl.width() + 40,\r\n      }).render(true);\r\n    });\r\n\r\n    html.find('.control-tools').find('.scene-control').last().after(presetControl);\r\n  });\r\n\r\n  // Change default behavior of JournalEntry click and context menu within the CompendiumDirectory\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'CompendiumDirectory.prototype._getEntryContextOptions',\r\n    function (wrapped, ...args) {\r\n      const options = wrapped(...args);\r\n      options.push({\r\n        name: 'Open Journal Compendium',\r\n        icon: '<i class=\"fas fa-book-open\"></i>',\r\n        condition: (li) => {\r\n          const pack = game.packs.get(li.data('pack'));\r\n          return pack.metadata.type === 'JournalEntry' && pack.index.get(META_INDEX_ID);\r\n        },\r\n        callback: (li) => {\r\n          const pack = game.packs.get(li.data('pack'));\r\n          pack.render(true);\r\n        },\r\n      });\r\n      return options;\r\n    },\r\n    'WRAPPER'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Compendium.prototype._getEntryContextOptions',\r\n    function (wrapped, ...args) {\r\n      const options = wrapped(...args);\r\n\r\n      if (this.collection.documentName !== 'Scene') return options;\r\n\r\n      options.push({\r\n        name: 'Spawn as Preset',\r\n        icon: '<i class=\"fa-solid fa-books\"></i>',\r\n        callback: async (li) => {\r\n          spawnSceneAsPreset(await this.collection.getDocument(li.data('document-id')));\r\n        },\r\n      });\r\n      return options;\r\n    },\r\n    'WRAPPER'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'SceneDirectory.prototype._getEntryContextOptions',\r\n    function (wrapped, ...args) {\r\n      const options = wrapped(...args);\r\n      options.push({\r\n        name: 'Spawn as Preset',\r\n        icon: '<i class=\"fa-solid fa-books\"></i>',\r\n        condition: (li) => game.user.isGM && li.data('documentId') !== canvas.scene.id,\r\n        callback: (li) => {\r\n          spawnSceneAsPreset(game.scenes.get(li.data('documentId')));\r\n        },\r\n      });\r\n      return options;\r\n    },\r\n    'WRAPPER'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'CompendiumDirectory.prototype._onClickEntryName',\r\n    async function (wrapped, event) {\r\n      const element = event.currentTarget;\r\n      const packId = element.closest('[data-pack]').dataset.pack;\r\n      const pack = game.packs.get(packId);\r\n      if (pack.metadata.type === 'JournalEntry' && pack.index.get(META_INDEX_ID)) {\r\n        openPresetBrowser('ALL');\r\n        return;\r\n      }\r\n      return wrapped(event);\r\n    },\r\n    'MIXED'\r\n  );\r\n}\r\n","import { Brush } from '../brush.js';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { SeededRandom, applyPresetToScene, localize } from '../utils.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\nimport { PresetBrowser } from './browser/browserApp.js';\r\nimport { Preset, VirtualFilePreset } from './preset.js';\r\nimport { Spawner } from './spawner.js';\r\nimport { FolderState, decodeURIComponentSafely, parseSearchQuery, placeableToData } from './utils.js';\r\n\r\nconst DEFAULT_PACK = 'world.mass-edit-presets-main';\r\nexport const META_INDEX_ID = 'MassEditMetaData';\r\nexport const META_INDEX_FIELDS = ['id', 'img', 'documentName', 'tags'];\r\n\r\nexport class PresetCollection {\r\n  static presets;\r\n\r\n  static workingPack;\r\n\r\n  static async getTree(type, { externalCompendiums = true, virtualDirectory = true, setFormVisibility = false } = {}) {\r\n    if (CONFIG.debug.MassEdit) console.time('getTree');\r\n\r\n    let pack;\r\n    let mainTree;\r\n    try {\r\n      pack = await this._initCompendium(this.workingPack);\r\n      if (!pack) throw Error('Unable to retrieve working compendium.');\r\n      mainTree = await PresetTree.init(pack, type, { forceLoad: true, setFormVisibility });\r\n    } catch (e) {\r\n      // Fail-safe. Return back to DEFAULT_PACK\r\n      console.log(e);\r\n      console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`);\r\n      console.log('RETURNING TO DEFAULT');\r\n      await game.settings.set(MODULE_ID, 'workingPack', DEFAULT_PACK);\r\n      this.workingPack = DEFAULT_PACK;\r\n      pack = await this._initCompendium(this.workingPack);\r\n      mainTree = await PresetTree.init(pack, type, { forceLoad: true, setFormVisibility });\r\n    }\r\n\r\n    const extFolders = [];\r\n\r\n    if (externalCompendiums) {\r\n      for (const p of game.packs) {\r\n        if (p.collection !== this.workingPack && p.index.get(META_INDEX_ID)) {\r\n          const tree = await PresetTree.init(p, type, { setFormVisibility });\r\n          if (setFormVisibility && !tree.hasVisible) continue;\r\n\r\n          const topFolder = new PresetPackFolder({ pack: p, tree });\r\n          extFolders.push(topFolder);\r\n\r\n          // Collate all folders with the main tree\r\n          mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n          for (const [uuid, folder] of tree.allFolders) {\r\n            mainTree.allFolders.set(uuid, folder);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Read File Index\r\n    if (virtualDirectory) {\r\n      const vTree = await FileIndexer.getVirtualDirectoryTree(type, { setFormVisibility });\r\n      if (vTree?.hasVisible || !setFormVisibility) {\r\n        const topFolder = new VirtualFileFolder({\r\n          name: 'VIRTUAL DIRECTORY',\r\n          children: vTree.folders,\r\n          uuid: 'virtual_directory',\r\n          color: '#1c5fa385',\r\n        });\r\n        extFolders.push(topFolder);\r\n\r\n        // Collate all folders with the main tree\r\n        mainTree.allFolders.set(topFolder.uuid, topFolder);\r\n        for (const [uuid, folder] of vTree.allFolders) {\r\n          mainTree.allFolders.set(uuid, folder);\r\n        }\r\n      }\r\n    }\r\n\r\n    mainTree.extFolders = this._groupExtFolders(extFolders, mainTree.allFolders);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd('getTree');\r\n    return mainTree;\r\n  }\r\n\r\n  static _groupExtFolders(folders, allFolders) {\r\n    folders = folders.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n\r\n    const groups = {};\r\n    const groupless = [];\r\n    folders.forEach((f) => {\r\n      if (f.group) {\r\n        if (!(f.group in groups)) groups[f.group] = [];\r\n        groups[f.group].push(f);\r\n      } else {\r\n        groupless.push(f);\r\n      }\r\n    });\r\n\r\n    const newExtFolders = [];\r\n    for (const [group, folders] of Object.entries(groups)) {\r\n      const id = SeededRandom.randomID(group); // For export operation a real ID is needed. Lets keep it consistent by seeding\r\n      const uuid = 'virtual@' + group; // faux uuid\r\n\r\n      const groupFolder = new PresetVirtualFolder({\r\n        id,\r\n        uuid,\r\n        name: group,\r\n        children: folders,\r\n        draggable: false,\r\n      });\r\n\r\n      allFolders.set(uuid, groupFolder);\r\n      newExtFolders.push(groupFolder);\r\n    }\r\n\r\n    return newExtFolders.concat(groupless).sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n  }\r\n\r\n  // Fixing meta index by removing loose indexes\r\n  // 06/03/2024\r\n  static async _cleanIndex(pack, metaDoc, metaIndex) {\r\n    if (pack.locked || !metaDoc || foundry.utils.isEmpty(metaIndex)) return;\r\n    const index = pack.index;\r\n\r\n    const update = {};\r\n    for (const idx of Object.keys(metaIndex)) {\r\n      if (!index.has(idx)) update['-=' + idx] = null;\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      if (CONFIG.debug.MassEdit) console.log('Mass Edit - Index Cleanup', update);\r\n      metaDoc.setFlag(MODULE_ID, 'index', update);\r\n      delete PresetTree._packTrees[pack.metadata.name];\r\n    }\r\n  }\r\n\r\n  static _sortFolders(folders, sorting = 'a') {\r\n    for (const folder of folders) {\r\n      folder.children = this._sortFolders(folder.children, folder.sorting);\r\n      folder.presets = this._sortPresets(folder.presets, folder.sorting);\r\n    }\r\n\r\n    if (sorting === 'a') return folders.sort((f1, f2) => f1.name.localeCompare(f2.name, 'en', { numeric: true }));\r\n    else return folders.sort((f1, f2) => f1.sort - f2.sort);\r\n  }\r\n\r\n  static _sortPresets(presets, sorting = 'a') {\r\n    if (sorting === 'a') return presets.sort((p1, p2) => p1.name.localeCompare(p2.name, 'en', { numeric: true }));\r\n    else return presets.sort((p1, p2) => p1.sort - p2.sort);\r\n  }\r\n\r\n  static async packToPresets(pack) {\r\n    if (!pack) return [];\r\n\r\n    const presets = [];\r\n\r\n    let metaIndex = (await pack.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  static async update(preset) {\r\n    const compendium = await this._initCompendium(this.workingPack);\r\n    const doc = await compendium.getDocument(preset.id);\r\n    const updateDoc = {\r\n      name: preset.name,\r\n      flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n    };\r\n    const pages = preset.pages;\r\n    if (pages) updateDoc.pages = pages;\r\n    await doc.update(updateDoc);\r\n\r\n    const metaDoc = await this._initMetaDocument(this.workingPack);\r\n    const update = {};\r\n    META_INDEX_FIELDS.forEach((f) => {\r\n      update[f] = preset[f];\r\n    });\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', { [preset.id]: update });\r\n    delete PresetTree._packTrees[compendium.metadata.name];\r\n  }\r\n\r\n  /**\r\n   * Update multiple presets at the same time\r\n   * @param {*} updates\r\n   */\r\n  static async updatePresets(updates, pack = this.workingPack) {\r\n    // TODO update meta and preset itself\r\n    await JournalEntry.updateDocuments(updates, { pack });\r\n  }\r\n\r\n  /**\r\n   * Create presets within a pack\r\n   * @param {Preset|Array[Preset]} presets\r\n   * @param {String} pack\r\n   */\r\n  static async set(presets, pack) {\r\n    if (!presets) throw new Error('Attempting to set invalid Preset/s', presets);\r\n    if (!pack) pack = this.workingPack;\r\n    if (!(presets instanceof Array)) presets = [presets];\r\n\r\n    const compendium = await this._initCompendium(pack);\r\n\r\n    const toCreatePresets = [];\r\n\r\n    for (const preset of presets) {\r\n      if (compendium.index.get(preset.id)) {\r\n        await this.update(preset);\r\n      } else toCreatePresets.push(preset);\r\n    }\r\n\r\n    if (!toCreatePresets.length) return;\r\n\r\n    const data = toCreatePresets.map((preset) => {\r\n      return {\r\n        _id: preset.id,\r\n        name: preset.name,\r\n        pages: preset.pages ?? [],\r\n        folder: preset.folder,\r\n        flags: { [MODULE_ID]: { preset: preset.toJSON() } },\r\n      };\r\n    });\r\n\r\n    const documents = await JournalEntry.createDocuments(data, {\r\n      pack: pack,\r\n      keepId: true,\r\n    });\r\n\r\n    for (const preset of toCreatePresets) {\r\n      const document = documents.find((d) => d.id === preset.id);\r\n      preset.uuid = document.uuid;\r\n      await preset.load(false, document);\r\n    }\r\n\r\n    const metaDoc = await this._initMetaDocument(pack);\r\n    const update = {};\r\n\r\n    for (const preset of toCreatePresets) {\r\n      const metaFields = {};\r\n      META_INDEX_FIELDS.forEach((f) => {\r\n        metaFields[f] = preset[f];\r\n      });\r\n      update[preset.id] = metaFields;\r\n    }\r\n\r\n    await metaDoc.setFlag(MODULE_ID, 'index', update);\r\n    delete PresetTree._packTrees[pack];\r\n  }\r\n\r\n  static async get(uuid, { full = true } = {}) {\r\n    if (uuid.startsWith('virtual@')) return this._constructVirtualFilePreset(uuid, { full });\r\n\r\n    let { collection, documentId, documentType, embedded, doc } = foundry.utils.parseUuid(uuid);\r\n    const index = collection.index.get(documentId);\r\n\r\n    if (index) {\r\n      const metaIndex = (await collection.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n      const mIndex = metaIndex[index._id];\r\n\r\n      const preset = new Preset({ ...index, ...mIndex, pack: collection.collection });\r\n      if (full) await preset.load();\r\n      return preset;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  static async getBatch(uuids, { full = true }) {\r\n    const presets = [];\r\n\r\n    for (const uuid of uuids) {\r\n      if (uuid.startsWith('virtual@')) presets.push(await this._constructVirtualFilePreset(uuid, { full: false }));\r\n      else {\r\n        let { collection, documentId } = foundry.utils.parseUuid(uuid);\r\n        const index = collection.index.get(documentId);\r\n\r\n        if (index) {\r\n          const metaIndex = (await collection.getDocument(META_INDEX_ID))?.getFlag(MODULE_ID, 'index');\r\n          const mIndex = metaIndex[index._id];\r\n          const preset = new Preset({ ...index, ...mIndex });\r\n          preset.pack = collection.collection;\r\n\r\n          presets.push(preset);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (full) {\r\n      return this.batchLoadPresets(presets);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  /**\r\n   * Batch load preset documents using pack.getDocuments({ _id__in: ids }) query.\r\n   * @param {Array[Preset]} presets\r\n   * @returns\r\n   */\r\n  static async batchLoadPresets(presets) {\r\n    const collectionToPreset = new Map();\r\n\r\n    for (const preset of presets) {\r\n      if (preset.virtual) await preset.load();\r\n      else {\r\n        let { collection } = foundry.utils.parseUuid(preset.uuid);\r\n        if (collectionToPreset.get(collection)) collectionToPreset.get(collection).push(preset);\r\n        else collectionToPreset.set(collection, [preset]);\r\n      }\r\n    }\r\n\r\n    for (const [collection, presets] of collectionToPreset) {\r\n      const ids = presets.map((p) => p.id);\r\n      const documents = await collection.getDocuments({ _id__in: ids });\r\n\r\n      for (const preset of presets) {\r\n        const d = documents.find((d) => d.id === preset.id);\r\n        if (d) await preset.load(false, d);\r\n      }\r\n    }\r\n\r\n    return presets;\r\n  }\r\n\r\n  static async _constructVirtualFilePreset(uuid, { full = true } = {}) {\r\n    const src = uuid.substring(8);\r\n    const preset = new VirtualFilePreset({ src });\r\n    if (full) await preset.load();\r\n    return preset;\r\n  }\r\n\r\n  /**\r\n   * @param {Preset|Array[Preset]} preset\r\n   */\r\n  static async delete(presets) {\r\n    if (!presets) return;\r\n    if (!(presets instanceof Array)) presets = [presets];\r\n\r\n    // Sort by compendium\r\n    const sorted = {};\r\n    for (const preset of presets) {\r\n      let { collection } = foundry.utils.parseUuid(preset.uuid);\r\n      if (!collection) continue;\r\n      collection = collection.collection;\r\n      if (!sorted[collection]) sorted[collection] = [preset];\r\n      else sorted[collection].push(preset);\r\n    }\r\n\r\n    for (const pack of Object.keys(sorted)) {\r\n      const compendium = await game.packs.get(pack);\r\n      if (!compendium) continue;\r\n\r\n      const metaDoc = await this._initMetaDocument(pack);\r\n      const metaUpdate = {};\r\n\r\n      const deleteIds = [];\r\n      for (const preset of sorted[pack]) {\r\n        deleteIds.push(preset.id);\r\n        metaUpdate['-=' + preset.id] = null;\r\n      }\r\n\r\n      const opts = { pack };\r\n      opts.ids = deleteIds; // v12 fix\r\n      await JournalEntry.deleteDocuments(deleteIds, opts);\r\n      await metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n      delete PresetTree._packTrees[compendium.metadata.name];\r\n    }\r\n  }\r\n\r\n  static async _initCompendium(pack) {\r\n    let compendium = game.packs.get(pack);\r\n    if (!compendium && pack === DEFAULT_PACK) {\r\n      compendium = await CompendiumCollection.createCompendium({\r\n        label: 'Mass Edit: Presets (MAIN)',\r\n        type: 'JournalEntry',\r\n        ownership: {\r\n          GAMEMASTER: 'NONE',\r\n          PLAYER: 'NONE',\r\n          ASSISTANT: 'NONE',\r\n        },\r\n        packageType: 'world',\r\n      });\r\n\r\n      await this._initMetaDocument(pack);\r\n    }\r\n\r\n    return compendium;\r\n  }\r\n\r\n  static async _initMetaDocument(pack) {\r\n    const compendium = game.packs.get(pack);\r\n    const metaDoc = await compendium.getDocument(META_INDEX_ID);\r\n    if (metaDoc) return metaDoc;\r\n\r\n    const documents = await JournalEntry.createDocuments(\r\n      [\r\n        {\r\n          _id: META_INDEX_ID,\r\n          name: '!!! METADATA: DO NOT DELETE !!!',\r\n          flags: { [MODULE_ID]: { index: {} } },\r\n        },\r\n      ],\r\n      {\r\n        pack: pack,\r\n        keepId: true,\r\n      }\r\n    );\r\n    return documents[0];\r\n  }\r\n\r\n  static async deleteFolder(uuid, deleteAll = false) {\r\n    const folderDoc = await fromUuid(uuid);\r\n    if (folderDoc.compendium.locked) return;\r\n\r\n    if (deleteAll) {\r\n      const metaDoc = folderDoc.compendium.get(META_INDEX_ID);\r\n      if (!metaDoc) return;\r\n\r\n      const metaUpdate = {};\r\n      const traverseFolder = function (folder) {\r\n        folder.contents.forEach((j) => (metaUpdate['-=' + j._id] = null));\r\n        folder.children.forEach((c) => traverseFolder(c.folder));\r\n      };\r\n      traverseFolder(folderDoc);\r\n\r\n      metaDoc.setFlag(MODULE_ID, 'index', metaUpdate);\r\n    }\r\n\r\n    delete PresetTree._packTrees[folderDoc.compendium.metadata.name];\r\n    return await folderDoc.delete({ deleteSubfolders: deleteAll, deleteContents: deleteAll });\r\n  }\r\n\r\n  static _searchPresetTree(tree, options) {\r\n    const presets = [];\r\n\r\n    if (!options.folder) this._searchPresetList(tree.allPresets, presets, options);\r\n    tree.allFolders.forEach((folder) => this._searchPresetFolder(folder, presets, options));\r\n\r\n    return presets;\r\n  }\r\n\r\n  static _searchPresets(presets, options) {\r\n    const results = [];\r\n\r\n    // Make sure terms are provided in lowercase\r\n    if (options.terms) options.terms = options.terms.map((t) => t.toLowerCase());\r\n\r\n    this._searchPresetList(presets, results, options);\r\n\r\n    return results;\r\n  }\r\n\r\n  static _searchPresetFolder(folder, presets, options) {\r\n    if (options.folder && folder.name !== options.folder) return;\r\n    this._searchPresetList(folder.presets, presets, options, folder.name);\r\n  }\r\n\r\n  static _searchPresetList(toSearch, presets, { name, type, tags, terms } = {}) {\r\n    for (const preset of toSearch) {\r\n      let match = true;\r\n      if (name && name !== preset.name) match = false;\r\n      if (type && type !== preset.documentName) match = false;\r\n      if (terms && !terms.every((t) => preset.name.toLowerCase().includes(t))) match = false;\r\n      if (match && tags) {\r\n        if (tags.matchAny) match = tags.tags.some((t) => preset.tags.includes(t));\r\n        else match = tags.tags.every((t) => preset.tags.includes(t));\r\n      }\r\n\r\n      if (match) presets.push(preset);\r\n    }\r\n  }\r\n  /**\r\n   * Build preset index for 'Spotlight Omnisearch' module\r\n   * @param {Array[CONFIG.SpotlightOmnisearch.SearchTerm]} soIndex\r\n   */\r\n  static async buildSpotlightOmnisearchIndex(soIndex) {\r\n    const tree = await PresetCollection.getTree(null, { externalCompendiums: true });\r\n\r\n    const SearchTerm = CONFIG.SpotlightOmnisearch.SearchTerm;\r\n\r\n    const onClick = async function () {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        ui.spotlightOmnisearch?.setDraggingState(true);\r\n        await Spawner.spawnPreset({\r\n          preset: this.data,\r\n          preview: true,\r\n          scaleToGrid: PresetBrowser.CONFIG.autoScale,\r\n        });\r\n        ui.spotlightOmnisearch?.setDraggingState(false);\r\n      }\r\n    };\r\n\r\n    const onDragEnd = function (event) {\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        const { x, y } = canvas.canvasCoordinatesFromClient({ x: event.clientX, y: event.clientY });\r\n        Spawner.spawnPreset({\r\n          preset: this.data,\r\n          x,\r\n          y,\r\n          scaleToGrid: PresetBrowser.CONFIG.autoScale,\r\n        });\r\n      } else if (this.data.documentName === 'Scene') {\r\n        applyPresetToScene(this.data);\r\n      }\r\n    };\r\n\r\n    const deactivateCallback = function () {\r\n      ui.spotlightOmnisearch?.setDraggingState(false);\r\n    };\r\n\r\n    const getActions = function () {\r\n      const actions = [\r\n        {\r\n          name: 'MassEdit.presets.open-journal',\r\n          icon: '<i class=\"fas fa-book-open fa-fw\"></i>',\r\n          callback: () => {\r\n            this.data.openJournal();\r\n          },\r\n        },\r\n      ];\r\n      if (SUPPORTED_PLACEABLES.includes(this.data.documentName)) {\r\n        actions.push({\r\n          name: `MassEdit.presets.controls.activate-brush`,\r\n          icon: '<i class=\"fas fa-paint-brush\"></i>',\r\n          callback: async () => {\r\n            canvas.getLayerByEmbeddedName(this.data.documentName)?.activate();\r\n            if (Brush.activate({ preset: await this.data.load(), deactivateCallback })) {\r\n              ui.spotlightOmnisearch.setDraggingState(true);\r\n            }\r\n          },\r\n        });\r\n      }\r\n      return actions;\r\n    };\r\n\r\n    const buildTerm = function (preset) {\r\n      soIndex.push(\r\n        new SearchTerm({\r\n          name: preset.name,\r\n          description: 'Mass Edit: Preset',\r\n          type: preset.documentName + ' preset',\r\n          img: preset.img,\r\n          icon: ['fa-solid fa-books', preset.icon],\r\n          keywords: preset.tags,\r\n          onClick,\r\n          onDragEnd,\r\n          data: preset,\r\n          actions: getActions,\r\n        })\r\n      );\r\n    };\r\n\r\n    tree.presets.forEach(buildTerm);\r\n    tree.allFolders.forEach((f) => f.presets.forEach(buildTerm));\r\n  }\r\n}\r\n\r\nexport class PresetAPI {\r\n  static name = 'PresetAPI';\r\n\r\n  /**\r\n   * Retrieve preset\r\n   * @param {object} [options={}]\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String} [options.query]                     Search query to be ran. Format: \"blue #castle @AmbientLight\"\r\n   *                                                     Terms: blue, Tags: castle, Type: AmbientLight\r\n   *                                                     None, or all component of the query can be provided or excluded\r\n   * @param {String|Array[String]|Object} [options.tags] Tags to match a preset against. Can be provided as an object containing 'tags' array and 'matchAny' flag.\r\n   *                                                     Comma separated string, or a list of strings. In the latter 2 cases 'matchAny' is assumed true\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {Boolean} [options.random]                   If multiple presets are found a random one will be chosen\r\n   * @returns {Preset}\r\n   */\r\n  static async getPreset({\r\n    uuid,\r\n    name,\r\n    type,\r\n    folder,\r\n    tags,\r\n    query,\r\n    matchAny = true,\r\n    random = false,\r\n    virtualDirectory = true,\r\n    externalCompendiums = true,\r\n    full = true,\r\n  } = {}) {\r\n    if (uuid) return await PresetCollection.get(uuid, { full });\r\n    else if (!name && !type && !folder && !tags && !query)\r\n      throw Error('UUID, Name, Type, Folder, and/or Query required to retrieve a Preset.');\r\n\r\n    let terms;\r\n    if (query) {\r\n      ({ terms, tags, type } = parseSearchQuery(query, { matchAny }));\r\n    }\r\n\r\n    if (tags) {\r\n      if (Array.isArray(tags)) tags = { tags, matchAny };\r\n      else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny };\r\n    }\r\n\r\n    const presets = PresetCollection._searchPresetTree(\r\n      await PresetCollection.getTree(type, { externalCompendiums, virtualDirectory }),\r\n      {\r\n        name,\r\n        type,\r\n        terms,\r\n        folder,\r\n        tags,\r\n      }\r\n    );\r\n\r\n    let preset = random ? presets[Math.floor(Math.random() * presets.length)] : presets[0];\r\n    if (preset) {\r\n      preset = preset.clone();\r\n      if (full) await preset.load();\r\n    }\r\n    return preset;\r\n  }\r\n\r\n  /**\r\n   * Retrieve presets\r\n   * @param {object} [options={}]\r\n   * @param {String|Array[String]} [options.uuid]        Preset UUID/s\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String} [options.query]                     See PresetAPI.getPreset\r\n   * @param {String} [options.folder]                    Folder name\r\n   * @param {String|Array[String]|Object} [options.tags] See PresetAPI.getPreset\r\n   * @returns {Array[Preset]|Array[String]|Array[Object]}\r\n   */\r\n  static async getPresets({\r\n    uuid,\r\n    name,\r\n    type,\r\n    query,\r\n    matchAny = true,\r\n    folder,\r\n    tags,\r\n    virtualDirectory = true,\r\n    externalCompendiums = true,\r\n    full = true,\r\n    presets,\r\n  } = {}) {\r\n    let results;\r\n    if (uuid) {\r\n      results = [];\r\n      const uuids = Array.isArray(uuid) ? uuid : [uuid];\r\n      results = await PresetCollection.getBatch(uuids, { full });\r\n    } else if (!name && !type && !folder && !tags && !query) {\r\n      throw Error('UUID, Name, Type, Folder, Tags, and/or Query required to retrieve Presets.');\r\n    } else {\r\n      let terms;\r\n      if (query) {\r\n        ({ terms, type, tags } = parseSearchQuery(query, { matchAny }));\r\n      }\r\n\r\n      if (tags) {\r\n        if (Array.isArray(tags)) tags = { tags, matchAny };\r\n        else if (typeof tags === 'string') tags = { tags: tags.split(','), matchAny };\r\n      }\r\n\r\n      if (presets) {\r\n        results = PresetCollection._searchPresets(presets, { name, type, terms, folder, tags });\r\n      } else {\r\n        results = PresetCollection._searchPresetTree(\r\n          await PresetCollection.getTree(type, { externalCompendiums, virtualDirectory }),\r\n          {\r\n            name,\r\n            type,\r\n            terms,\r\n            folder,\r\n            tags,\r\n          }\r\n        );\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Create a Token preset from the provided Actor\r\n   */\r\n  static async createPresetFromActor(actor, { keepId = false, folder } = {}) {\r\n    if (!actor || actor.documentName !== 'Actor') return;\r\n\r\n    const presetData = {\r\n      id: keepId ? actor.id : null,\r\n      name: actor.name,\r\n      documentName: 'Token',\r\n      img: actor.img,\r\n      data: [actor.prototypeToken.toJSON()],\r\n      folder: folder,\r\n    };\r\n\r\n    presetData.gridSize = canvas.scene.grid.size;\r\n\r\n    const preset = new Preset(presetData);\r\n    return preset;\r\n  }\r\n\r\n  static async createPresetFromActorUuid(uuid, options = {}) {\r\n    const actor = await fromUuid(uuid);\r\n    if (!actor.documentName === 'Actor') return;\r\n\r\n    return await this.createPresetFromActor(actor, options);\r\n  }\r\n\r\n  /**\r\n   * Create Presets from passed in placeables\r\n   * @param {PlaceableObject|Array[PlaceableObject]} placeables Placeable/s to create the presets from.\r\n   * @param {object} [options={}]                               Optional Preset information\r\n   * @param {String} [options.name]                             Preset name\r\n   * @param {String} [options.img]                              Preset thumbnail image\r\n   * @returns {Preset|Array[Preset]}\r\n   */\r\n  static async createPreset(placeables, options = {}) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    // Alike placeables will be made into single presets. Lets batch them up together.\r\n\r\n    const groups = {};\r\n    for (const placeable of placeables) {\r\n      const documentName = placeable.document.documentName;\r\n      if (!groups.hasOwnProperty(documentName)) groups[documentName] = [];\r\n      groups[documentName].push(placeable);\r\n    }\r\n\r\n    const presets = [];\r\n    for (const [documentName, placeables] of Object.entries(groups)) {\r\n      const data = [];\r\n      for (const placeable of placeables) {\r\n        data.push(placeableToData(placeable));\r\n      }\r\n\r\n      // Preset data before merging with user provided\r\n      const defPreset = {\r\n        name: localize('presets.default-name'),\r\n        documentName,\r\n        data: data,\r\n      };\r\n\r\n      // Assign preset image\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n        case 'Tile':\r\n        case 'Note':\r\n          defPreset.img = data[0].texture.src;\r\n          break;\r\n        case 'AmbientSound':\r\n          defPreset.img = 'icons/svg/sound.svg';\r\n          break;\r\n        case 'AmbientLight':\r\n          defPreset.img = 'icons/svg/light.svg';\r\n          break;\r\n        case 'Drawing':\r\n          defPreset.img = 'icons/svg/acid.svg';\r\n          break;\r\n        case 'MeasuredTemplate':\r\n          defPreset.img = 'icons/svg/circle.svg';\r\n          break;\r\n      }\r\n\r\n      //  Assign preset name\r\n      switch (defPreset.documentName) {\r\n        case 'Token':\r\n          defPreset.name = data[0].name;\r\n          break;\r\n        default:\r\n          const taggerTag = data[0].flags?.tagger?.tags?.[0];\r\n          if (taggerTag) defPreset.name = taggerTag;\r\n          break;\r\n      }\r\n\r\n      defPreset.gridSize = placeables[0].document.parent.grid.size;\r\n\r\n      foundry.utils.mergeObject(defPreset, options, { inplace: true });\r\n\r\n      const preset = new Preset(defPreset);\r\n      await PresetCollection.set(preset);\r\n      presets.push(preset);\r\n    }\r\n\r\n    return presets;\r\n  }\r\n}\r\n\r\nexport class PresetFolder {\r\n  static isEditable(uuid) {\r\n    const { collection } = foundry.utils.parseUuid(uuid);\r\n    return collection && !collection.locked;\r\n  }\r\n\r\n  constructor({\r\n    id,\r\n    uuid,\r\n    name,\r\n    sorting = 'm',\r\n    color = '#000000',\r\n    sort = 0,\r\n    children = [],\r\n    presets = [],\r\n    draggable = true,\r\n    folder = null,\r\n    visible = true,\r\n    render = true,\r\n    types = [],\r\n  } = {}) {\r\n    this.id = id;\r\n    this.uuid = uuid;\r\n    this.name = name;\r\n    this.sorting = sorting;\r\n    this.color = color;\r\n    this.sort = sort;\r\n    this.children = children;\r\n    this.children.forEach((c) => {\r\n      c.folder = this.id;\r\n    });\r\n    this.presets = presets;\r\n    this.draggable = draggable;\r\n    this.folder = folder;\r\n    this.visible = visible;\r\n    this.render = render;\r\n    this.expanded = FolderState.expanded(this.uuid);\r\n    this.types = types;\r\n  }\r\n\r\n  async update(data) {\r\n    const doc = await fromUuid(this.uuid);\r\n    if (doc) {\r\n      foundry.utils.mergeObject(this, data);\r\n      await doc.update(data);\r\n    }\r\n  }\r\n}\r\n\r\nexport class PresetVirtualFolder extends PresetFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.virtual = true;\r\n    this.draggable = false;\r\n  }\r\n\r\n  async update(data) {}\r\n}\r\n\r\nexport class VirtualFileFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    super(options);\r\n    this.id = foundry.utils.randomID();\r\n    if (!options.types) this.types = ['ALL'];\r\n    this.bucket = options.bucket;\r\n    this.source = options.source;\r\n    this.name = decodeURIComponentSafely(this.name);\r\n    this.icon = options.icon;\r\n    this.subtext = options.subtext;\r\n    if (options.source && ['data', 'forgevtt'].includes(options.source)) this.indexable = true;\r\n  }\r\n}\r\n\r\nexport class PresetPackFolder extends PresetVirtualFolder {\r\n  constructor(options) {\r\n    const tree = options.tree;\r\n    const pack = options.pack;\r\n    const packFolderData = tree.metaDoc.getFlag(MODULE_ID, 'folder') ?? {};\r\n    const uuid = pack.collection;\r\n    super({\r\n      uuid,\r\n      id: SeededRandom.randomID(uuid),\r\n      name: packFolderData.name ?? pack.title,\r\n      children: tree.folders,\r\n      presets: tree.presets,\r\n      draggable: false,\r\n      color: packFolderData.color ?? '#000000',\r\n    });\r\n    this.group = packFolderData.group;\r\n  }\r\n\r\n  get pack() {\r\n    return this.uuid;\r\n  }\r\n\r\n  async update(data = {}) {\r\n    const pack = game.packs.get(this.pack);\r\n    if (pack.locked) return;\r\n    if (data.hasOwnProperty('name') && data.name === pack.title) delete data.name;\r\n    if (foundry.utils.isEmpty(data)) return;\r\n\r\n    const metaDoc = await PresetCollection._initMetaDocument(this.pack);\r\n    await metaDoc.setFlag(MODULE_ID, 'folder', data);\r\n\r\n    foundry.utils.mergeObject(this, data);\r\n  }\r\n}\r\n\r\nexport class PresetTree {\r\n  static _packTrees = {};\r\n\r\n  static async init(pack, type, { forceLoad = false, setFormVisibility = false } = {}) {\r\n    if (!pack) return null;\r\n\r\n    if (CONFIG.debug.MassEdit) console.time(pack.title);\r\n\r\n    // Re-use tree if already parsed\r\n    if (!forceLoad && PresetTree._packTrees[pack.metadata.name]) {\r\n      const tree = PresetTree._packTrees[pack.metadata.name];\r\n      if (setFormVisibility) tree.setVisibility(type);\r\n      if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n      return tree;\r\n    }\r\n\r\n    // Setup folders ready for parent/children processing\r\n    const folders = new Map();\r\n    const topLevelFolders = new Map();\r\n    const folderContents = pack.folders.contents;\r\n    for (const f of folderContents) {\r\n      const folder = new PresetFolder({\r\n        id: f._id,\r\n        uuid: f.uuid,\r\n        name: f.name,\r\n        sorting: f.sorting,\r\n        color: f.color,\r\n        sort: f.sort,\r\n        draggable: f.pack === PresetCollection.workingPack,\r\n        folder: f.folder?.uuid,\r\n        types: f.flags[MODULE_ID]?.types || ['ALL'],\r\n      });\r\n\r\n      folders.set(folder.uuid, folder);\r\n      topLevelFolders.set(f.uuid, folder);\r\n    }\r\n\r\n    // If folders have parent folders add them as children and remove them as a top level folder\r\n    for (const f of folderContents) {\r\n      if (f.folder) {\r\n        const parent = folders.get(f.folder.uuid);\r\n        parent.children.push(folders.get(f.uuid));\r\n        topLevelFolders.delete(f.uuid);\r\n      }\r\n    }\r\n\r\n    // Process presets\r\n    const allPresets = [];\r\n    const topLevelPresets = [];\r\n    let hasVisible = false; // tracks whether there exists at least one visible preset within this tree\r\n    const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n    let metaIndex = metaDoc?.getFlag(MODULE_ID, 'index');\r\n\r\n    const index = pack.index.contents;\r\n\r\n    // TEMP - 06/03/2024\r\n    // Due to poor implementation of Folder+Folder Content delete, there are likely to be some indexes which were not removed\r\n    // Lets clean them up here for now\r\n    PresetCollection._cleanIndex(pack, metaDoc, metaIndex);\r\n    // Remove after sufficient enough time has passed to have reasonable confidence that All/Most users have executed this ^\r\n\r\n    for (const idx of index) {\r\n      if (idx._id === META_INDEX_ID) continue;\r\n      const mIndex = metaIndex[idx._id];\r\n      const preset = new Preset({ ...idx, ...mIndex, pack: pack.collection });\r\n\r\n      // If no document name is available (missing metadata) attempt to load the preset to retrieve it\r\n      // If still no name is found, skip it\r\n      if (!preset.documentName) {\r\n        console.log(`Missing MetaData. Attempting document load: ${preset.id} | ${preset.name}`);\r\n        await preset.load(true);\r\n        if (!preset.documentName) continue;\r\n        console.log(`MetaData. Found for: ${preset.id} | ${preset.name}`);\r\n        if (!pack.locked) await preset._updateIndex(preset); // Insert missing preset into metadata index\r\n      }\r\n\r\n      if (preset.folder) {\r\n        let matched = false;\r\n        for (const [uuid, folder] of folders) {\r\n          if (folder.id === preset.folder) {\r\n            folder.presets.push(preset);\r\n            matched = true;\r\n            break;\r\n          }\r\n        }\r\n        if (!matched) topLevelPresets.push(preset);\r\n      } else topLevelPresets.push(preset);\r\n\r\n      allPresets.push(preset);\r\n      hasVisible |= preset._visible;\r\n    }\r\n\r\n    // Sort folders\r\n    const sorting = PresetBrowser.CONFIG.sortMode === 'manual' ? 'm' : 'a';\r\n    const sortedFolders = PresetCollection._sortFolders(Array.from(topLevelFolders.values()), sorting);\r\n    const sortedPresets = PresetCollection._sortPresets(topLevelPresets, sorting);\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd(pack.title);\r\n\r\n    const tree = new PresetTree({\r\n      folders: sortedFolders,\r\n      presets: sortedPresets,\r\n      allPresets,\r\n      allFolders: folders,\r\n      hasVisible,\r\n      metaDoc,\r\n      pack,\r\n    });\r\n\r\n    if (setFormVisibility) tree.setVisibility(type);\r\n    PresetTree._packTrees[pack.metadata.name] = tree;\r\n\r\n    return tree;\r\n  }\r\n\r\n  constructor({ folders, presets, allPresets, allFolders, hasVisible, metaDoc, pack } = {}) {\r\n    this.folders = folders;\r\n    this.presets = presets;\r\n    this.allPresets = allPresets;\r\n    this.allFolders = allFolders;\r\n    this.hasVisible = hasVisible;\r\n    this.metaDoc = metaDoc;\r\n    this.pack = pack;\r\n  }\r\n\r\n  setVisibility(type) {\r\n    this.allFolders.forEach((f) => {\r\n      f.render = true;\r\n      f.visible = type ? f.types.includes(type) : true;\r\n    });\r\n\r\n    this.hasVisible = false;\r\n\r\n    for (const preset of this.allPresets) {\r\n      preset._visible = true;\r\n      preset._render = true;\r\n      if (type) {\r\n        if (type === 'ALL') {\r\n          if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) preset._visible = false;\r\n        } else if (preset.documentName !== type) preset._visible = false;\r\n      }\r\n\r\n      this.hasVisible = this.hasVisible || preset._visible;\r\n    }\r\n  }\r\n\r\n  _setChildAndParentFoldersVisible(folder) {\r\n    folder.visible = true;\r\n    if (folder.folder) {\r\n      for (const [uuid, f] of this.allFolders.entries()) {\r\n        if (f.id === folder.folder) return this._setChildAndParentFoldersVisible(f);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { pasteDataUpdate } from '../../applications/formUtils.js';\r\nimport { getMassEditForm } from '../../applications/multiConfig.js';\r\nimport { BrushMenu } from '../brush.js';\r\nimport { MODULE_ID, PIVOTS, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { Scenescape } from '../scenescape/scenescape.js';\r\nimport { applyPresetToScene, isAudio, localize, spawnSceneAsPreset } from '../utils.js';\r\nimport { PresetAPI, PresetCollection, PresetFolder, PresetPackFolder, VirtualFileFolder } from './collection.js';\r\nimport { PresetConfig } from './editApp.js';\r\nimport { PresetBrowser } from './browser/browserApp.js';\r\nimport { Preset } from './preset.js';\r\nimport { Spawner } from './spawner.js';\r\nimport { FolderState, isVideo } from './utils.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\n\r\nexport async function registerPresetHandlebarPartials() {\r\n  await getTemplate(`modules/${MODULE_ID}/templates/preset/partials/preset.html`, 'me-preset');\r\n  await getTemplate(`modules/${MODULE_ID}/templates/preset/partials/folder.html`, 'me-preset-folder');\r\n  await getTemplate(`modules/${MODULE_ID}/templates/preset/partials/presetsContent.html`, 'me-presets-content');\r\n  await getTemplate(`modules/${MODULE_ID}/templates/preset/partials/presetsTopList.html`, 'me-preset-list');\r\n}\r\n\r\nexport class PresetContainer extends FormApplication {\r\n  constructor(opts1, opts2) {\r\n    super(opts1, opts2);\r\n\r\n    // Drag/Drop tracking\r\n    this.dragType = null;\r\n    this.dragData = null;\r\n    this.draggedElements = null;\r\n\r\n    this.presetsSortable = opts2.sortable;\r\n    this.presetsDuplicatable = opts2.duplicatable;\r\n    this.presetsForceAllowDelete = opts2.forceAllowDelete;\r\n    this.presetsDisableDelete = opts2.disableDelete;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    // =====================\r\n    // Preset multi-select & drag Listeners\r\n    const itemList = html.find('.item-list');\r\n\r\n    // Multi-select\r\n    html.on('click', '.item', (event) => {\r\n      itemSelect(event, itemList);\r\n    });\r\n\r\n    // Play previews\r\n    html.on('mouseenter', '.item', (event) => {\r\n      this._playPreview(event);\r\n    });\r\n    html.on('mouseleave', '.item', (event) => {\r\n      this._endPreview(event);\r\n    });\r\n\r\n    html.on('dragstart', '.item', (event) => {\r\n      this.dragType = 'item';\r\n\r\n      const item = $(event.target).closest('.item');\r\n\r\n      // Drag has been started on an item that hasn't been selected\r\n      // Assume that this is the only item to be dragged and select it\r\n      if (!item.hasClass('selected')) {\r\n        itemList.find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n        item.addClass('selected').addClass('last-selected');\r\n      }\r\n\r\n      const uuids = [];\r\n      itemList.find('.item.selected').each(function () {\r\n        uuids.push($(this).data('uuid'));\r\n      });\r\n      this.dragData = uuids;\r\n      this.draggedElements = itemList.find('.item.selected');\r\n\r\n      if (event.originalEvent.dataTransfer) {\r\n        event.originalEvent.dataTransfer.clearData();\r\n        event.originalEvent.dataTransfer.setData('text/plain', JSON.stringify({ uuids }));\r\n      }\r\n    });\r\n\r\n    if (this.presetsSortable) {\r\n      html.on('dragleave', '.item.sortable', (event) => {\r\n        $(event.target).closest('.item').removeClass('drag-bot').removeClass('drag-top');\r\n      });\r\n\r\n      html.on('dragover', '.item.sortable', (event) => {\r\n        if (this.dragType !== 'item') return;\r\n        if (!this.draggedElements.hasClass('sortable')) return;\r\n\r\n        const targetItem = $(event.target).closest('.item');\r\n\r\n        // Check that we're not above a selected item  (i.e. item being dragged)\r\n        if (targetItem.hasClass('selected')) return;\r\n\r\n        // Determine if mouse is hovered over top, middle, or bottom\r\n        var domRect = event.currentTarget.getBoundingClientRect();\r\n        let prc = event.offsetY / domRect.height;\r\n\r\n        if (prc < 0.2) {\r\n          targetItem.removeClass('drag-bot').addClass('drag-top');\r\n        } else if (prc > 0.8) {\r\n          targetItem.removeClass('drag-top').addClass('drag-bot');\r\n        }\r\n      });\r\n\r\n      html.on('drop', '.item.sortable', (event) => {\r\n        if (this.lastSearch?.length) return; // Prevent drops while searching\r\n        if (this.dragType !== 'item') return;\r\n        if (!this.draggedElements.hasClass('sortable')) return;\r\n\r\n        const targetItem = $(event.target).closest('.item');\r\n\r\n        const top = targetItem.hasClass('drag-top');\r\n        targetItem.removeClass('drag-bot').removeClass('drag-top');\r\n\r\n        const uuids = this.dragData;\r\n        if (uuids) {\r\n          if (!targetItem.hasClass('selected')) {\r\n            // Move HTML Elements\r\n            (top ? uuids : uuids.reverse()).forEach((uuid) => {\r\n              const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n              if (item) {\r\n                if (top) item.insertBefore(targetItem);\r\n                else item.insertAfter(targetItem);\r\n              }\r\n            });\r\n\r\n            this._onItemSort(uuids, targetItem.data('uuid'), {\r\n              before: top,\r\n              folderUuid: targetItem.closest('.folder').data('uuid'),\r\n            });\r\n          }\r\n        }\r\n\r\n        this.dragType = null;\r\n        this.dragData = null;\r\n        this.draggedElements = null;\r\n      });\r\n    }\r\n\r\n    html.on('dragend', '.item', (event) => {\r\n      if (!checkMouseInWindow(event)) {\r\n        this._onPresetDragOut(event);\r\n      }\r\n    });\r\n\r\n    // ================\r\n    // Folder Listeners\r\n    html.on('click', '.folder > header', (event) => this._folderToggle($(event.target).closest('.folder')));\r\n\r\n    if (this.presetsSortable) {\r\n      html.on('dragstart', '.folder.sortable', (event) => {\r\n        if (this.dragType == 'item') return;\r\n        this.dragType = 'folder';\r\n\r\n        const folder = $(event.target).closest('.folder');\r\n        const uuids = [folder.data('uuid')];\r\n\r\n        $(event.target)\r\n          .find('.folder')\r\n          .each(function () {\r\n            uuids.push($(this).data('uuid'));\r\n          });\r\n\r\n        this.dragData = uuids;\r\n      });\r\n\r\n      html.on('dragleave', '.folder.sortable header', (event) => {\r\n        $(event.target).closest('.folder').removeClass('drag-mid').removeClass('drag-top');\r\n      });\r\n\r\n      html.on('dragover', '.folder.sortable header', (event) => {\r\n        const targetFolder = $(event.target).closest('.folder');\r\n\r\n        if (this.dragType === 'folder') {\r\n          // Check that we're not above folders being dragged\r\n          if (this.dragData.includes(targetFolder.data('uuid'))) return;\r\n\r\n          // Determine if mouse is hovered over top, middle, or bottom\r\n          var domRect = event.currentTarget.getBoundingClientRect();\r\n          let prc = event.offsetY / domRect.height;\r\n\r\n          if (prc < 0.2) {\r\n            targetFolder.removeClass('drag-mid').addClass('drag-top');\r\n          } else {\r\n            targetFolder.removeClass('drag-top').addClass('drag-mid');\r\n          }\r\n        } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n          targetFolder.addClass('drag-mid');\r\n        }\r\n      });\r\n\r\n      html.on('drop', '.folder.sortable header', (event) => {\r\n        if (this._foundryDrop?.(event)) return;\r\n        if (this.lastSearch?.length) return; // Prevent drops while searching\r\n\r\n        const targetFolder = $(event.target).closest('.folder');\r\n\r\n        if (this.dragType === 'folder') {\r\n          const top = targetFolder.hasClass('drag-top');\r\n          targetFolder.removeClass('drag-mid').removeClass('drag-top');\r\n\r\n          const uuids = this.dragData;\r\n          if (uuids) {\r\n            if (uuids.includes(targetFolder.data('uuid'))) return;\r\n\r\n            const uuid = uuids[0];\r\n            const folder = html.find(`.folder[data-uuid=\"${uuid}\"]`);\r\n            if (folder) {\r\n              // Move HTML Elements\r\n              if (top) folder.insertBefore(targetFolder);\r\n              else targetFolder.find('.folder-items').first().append(folder);\r\n\r\n              if (top) {\r\n                this._onFolderSort(uuid, targetFolder.data('uuid'), {\r\n                  inside: false,\r\n                  folderUuid: targetFolder.parent().closest('.folder').data('uuid') ?? null,\r\n                });\r\n              } else {\r\n                this._onFolderSort(uuid, null, {\r\n                  inside: true,\r\n                  folderUuid: targetFolder.data('uuid'),\r\n                });\r\n              }\r\n            }\r\n          }\r\n        } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n          targetFolder.removeClass('drag-mid');\r\n          const uuids = this.dragData;\r\n\r\n          // Move HTML Elements\r\n          const presetItems = targetFolder.children('.preset-items');\r\n          uuids?.forEach((uuid) => {\r\n            const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n            if (item.length) presetItems.append(item);\r\n          });\r\n\r\n          this._onItemSort(uuids, null, {\r\n            folderUuid: targetFolder.data('uuid'),\r\n          });\r\n        }\r\n\r\n        this.dragType = null;\r\n        this.dragData = null;\r\n        this.draggedElements = null;\r\n      });\r\n\r\n      html.on('drop', '.top-level-preset-items', (event) => {\r\n        if (this._foundryDrop?.(event)) return;\r\n        if (this.lastSearch?.length) return; // Prevent drops while searching\r\n        if (this.dragType === 'folder') {\r\n          // Move HTML Elements\r\n          const target = html.find('.top-level-folder-items');\r\n          const folder = html.find(`.folder[data-uuid=\"${this.dragData[0]}\"]`);\r\n          target.append(folder);\r\n\r\n          this._onFolderSort(this.dragData[0], null);\r\n        } else if (this.dragType === 'item' && this.draggedElements.hasClass('sortable')) {\r\n          const uuids = this.dragData;\r\n\r\n          // Move HTML Elements\r\n          const target = html.find('.top-level-preset-items');\r\n          uuids?.forEach((uuid) => {\r\n            const item = itemList.find(`.item[data-uuid=\"${uuid}\"]`);\r\n            if (item.length) target.append(item);\r\n          });\r\n\r\n          this._onItemSort(uuids, null);\r\n        }\r\n\r\n        this.dragType = null;\r\n        this.dragData = null;\r\n        this.draggedElements = null;\r\n      });\r\n    }\r\n    // End of Folder Listeners\r\n    // ================\r\n\r\n    html.on('dblclick', '.item', this._onDoubleClickPreset.bind(this));\r\n\r\n    // Activate context menu\r\n    this._contextMenu(html.find('.item-list'));\r\n  }\r\n\r\n  async _onDoubleClickPreset(event) {\r\n    const item = $(event.target).closest('.item');\r\n    const uuid = item.data('uuid');\r\n    if (!uuid) return;\r\n\r\n    let preset = await PresetAPI.getPreset({ uuid });\r\n    if (!preset) return;\r\n\r\n    BrushMenu.close();\r\n\r\n    if (preset.documentName === 'Scene') {\r\n      ui.notifications.info(`Mass Edit: ${localize('common.apply')} [${preset.name}]`);\r\n      applyPresetToScene(preset);\r\n    } else if (preset.documentName === 'Bag') {\r\n      this._onOpenBag(preset.uuid);\r\n    } else if (preset.documentName === 'FauxScene') {\r\n      const scene = await fromUuid(preset.data[0].uuid);\r\n      scene.sheet.render(true);\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    ui.notifications.info(`Mass Edit: ${localize('presets.spawning')} [${preset.name}]`);\r\n\r\n    // Spawn Preset\r\n    this._setInteractivityState(false);\r\n    await this._onSpawnPreset(preset);\r\n    this._setInteractivityState(true);\r\n  }\r\n\r\n  async _onSpawnPreset(preset, options = {}) {\r\n    return await Spawner.spawnPreset({\r\n      preset,\r\n      preview: true,\r\n      layerSwitch: PresetBrowser.CONFIG.switchLayer,\r\n      scaleToGrid: PresetBrowser.CONFIG.autoScale || Scenescape.active,\r\n      pivot: PIVOTS.CENTER,\r\n      ...options,\r\n    });\r\n  }\r\n\r\n  async _onRightClickPreset(eventTarget) {\r\n    const item = $(eventTarget).closest('.item');\r\n\r\n    // If right-clicked item is not selected, de-select the others and select it\r\n    if (!item.hasClass('selected')) {\r\n      item.closest('.item-list').find('.item.selected').removeClass('selected').removeClass('last-selected');\r\n      item.addClass('selected').addClass('last-selected');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the window app as translucent and inactive to mouse pointer events\r\n   * @param {Boolean} state true = active, false = inactive\r\n   */\r\n  _setInteractivityState(state) {\r\n    if (state) this.element.removeClass('mass-edit-inactive');\r\n    else this.element.addClass('mass-edit-inactive');\r\n  }\r\n\r\n  _contextMenu(html) {\r\n    const itemOptions = this._getItemContextOptions().sort((o1, o2) => (o1.sort ?? -1) - (o2.sort ?? -1));\r\n    ContextMenu.create(this, html, '.item', itemOptions, {\r\n      hookName: 'MassEditPresetContext',\r\n      onOpen: this._onRightClickPreset.bind(this),\r\n    });\r\n\r\n    const folderOptions = this._getFolderContextOptions().sort((o1, o2) => (o1.sort ?? -1) - (o2.sort ?? -1));\r\n    ContextMenu.create(this, html, '.folder header', folderOptions, {\r\n      hookName: 'MassEditFolderContext',\r\n    });\r\n  }\r\n\r\n  _getItemContextOptions() {\r\n    return [\r\n      {\r\n        name: 'Open Bag',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (item) => item.data('doc-name') === 'Bag',\r\n        callback: (item) => this._onOpenBag(),\r\n        sort: 0,\r\n      },\r\n      {\r\n        name: 'Import Scene',\r\n        icon: '<i class=\"fas fa-download fa-fw\"></i>',\r\n        condition: (item) => item.data('doc-name') === 'FauxScene',\r\n        callback: this._onImportFauxScene,\r\n        sort: 50,\r\n      },\r\n      {\r\n        name: 'Spawn Scene',\r\n        icon: '<i class=\"fa-solid fa-books\"></i>',\r\n        condition: (item) => item.data('doc-name') === 'FauxScene',\r\n        callback: this._onSpawnScene,\r\n        sort: 51,\r\n      },\r\n      {\r\n        name: localize('CONTROLS.CommonEdit', false),\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (item) => game.user.isGM && Preset.isEditable(item.data('uuid')),\r\n        callback: (item) => this._onEditSelectedPresets(item),\r\n        sort: 100,\r\n      },\r\n      {\r\n        name: 'Brush',\r\n        icon: '<i class=\"fa-solid fa-paintbrush\"></i>',\r\n        condition: (item) => game.user.isGM && SUPPORTED_PLACEABLES.includes(item.data('doc-name')),\r\n        callback: (item) => this._onActivateBrush(item),\r\n        sort: 200,\r\n      },\r\n      {\r\n        name: localize('presets.open-journal'),\r\n        icon: '<i class=\"fas fa-book-open\"></i>',\r\n        condition: (item) => !item.hasClass('virtual'),\r\n        callback: (item) => this._onOpenJournal(item),\r\n        sort: 300,\r\n      },\r\n      {\r\n        name: localize('presets.apply-to-selected'),\r\n        icon: '<i class=\"fas fa-arrow-circle-right\"></i>',\r\n        condition: (item) =>\r\n          game.user.isGM &&\r\n          SUPPORTED_PLACEABLES.includes(item.data('doc-name')) &&\r\n          canvas.getLayerByEmbeddedName(item.data('doc-name')).controlled.length,\r\n        callback: (item) => this._onApplyToSelected(item),\r\n        sort: 400,\r\n      },\r\n      {\r\n        name: localize('Duplicate', false),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) =>\r\n          game.user.isGM &&\r\n          this.presetsDuplicatable &&\r\n          Preset.isEditable(item.data('uuid')) &&\r\n          !item.hasClass('virtual'),\r\n        callback: (item) =>\r\n          this._onCopySelectedPresets(null, {\r\n            keepFolder: true,\r\n            keepId: false,\r\n          }),\r\n        sort: 500,\r\n      },\r\n      {\r\n        name: localize('presets.copy-source-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => item.data('uuid').startsWith('virtual@'),\r\n        callback: (item) => game.clipboard.copyPlainText(item.data('uuid').substring(8)),\r\n        sort: 600,\r\n      },\r\n      {\r\n        name: localize('presets.copy-to-clipboard'),\r\n        icon: '<i class=\"fa-solid fa-copy\"></i>',\r\n        condition: (item) => game.user.isGM && $(this.form).find('.item-list').find('.item.selected').length === 1,\r\n        callback: (item) => this._onCopyPresetToClipboard(),\r\n        sort: 700,\r\n      },\r\n      {\r\n        name: 'Copy UUID',\r\n        icon: '<i class=\"fa-solid fa-passport\"></i>',\r\n        condition: () => game.user.isGM,\r\n        callback: (item) => this._onCopyUUID(item),\r\n        sort: 800,\r\n      },\r\n      {\r\n        name: localize('presets.export-as-json'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        condition: () => game.user.isGM,\r\n        callback: (item) => this._onExportSelectedPresets(),\r\n        sort: 900,\r\n      },\r\n      {\r\n        name: localize('presets.export-to-compendium'),\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        condition: () => game.user.isGM && this.presetsDuplicatable,\r\n        callback: (item) => this._onExportSelectedPresetsToComp(),\r\n        sort: 1000,\r\n      },\r\n      {\r\n        name: localize('CONTROLS.CommonDelete', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (item) =>\r\n          game.user.isGM &&\r\n          !this.presetsDisableDelete &&\r\n          (this.presetsForceAllowDelete || (Preset.isEditable(item.data('uuid')) && !item.hasClass('virtual'))),\r\n        callback: (item) => this._onDeleteSelectedPresets(item),\r\n        sort: 1100,\r\n      },\r\n    ];\r\n  }\r\n\r\n  async _onImportFauxScene(item) {\r\n    const preset = await PresetAPI.getPreset({ uuid: item.data('uuid') });\r\n    const scene = await fromUuid(preset.data[0].uuid);\r\n    return game.scenes.importFromCompendium(scene.compendium, scene.id, {}, { renderSheet: true });\r\n  }\r\n\r\n  async _onSpawnScene(item) {\r\n    const preset = await PresetAPI.getPreset({ uuid: item.data('uuid') });\r\n    const scene = await fromUuid(preset.data[0].uuid);\r\n    return spawnSceneAsPreset(scene);\r\n  }\r\n\r\n  _getFolderContextOptions() {\r\n    return [\r\n      {\r\n        name: 'Edit',\r\n        icon: '<i class=\"fas fa-edit\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !folder.virtual || folder instanceof PresetPackFolder;\r\n        },\r\n        callback: (header) => this._onFolderEdit(header),\r\n      },\r\n      {\r\n        name: 'Save Index',\r\n        icon: '<i class=\"fas fa-file-search\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return folder.indexable;\r\n        },\r\n        callback: (header) => {\r\n          FileIndexer.saveFolderToCache(this.tree.allFolders.get(header.closest('.folder').data('uuid')));\r\n        },\r\n      },\r\n      {\r\n        name: 'Export to Compendium',\r\n        icon: '<i class=\"fas fa-file-export fa-fw\"></i>',\r\n        condition: (header) => {\r\n          const folder = this.tree.allFolders.get(header.closest('.folder').data('uuid'));\r\n          return !(folder instanceof VirtualFileFolder);\r\n        },\r\n        callback: (header) => {\r\n          this._onExportFolder(header.closest('.folder').data('uuid'));\r\n        },\r\n      },\r\n      {\r\n        name: localize('FOLDER.Remove', false),\r\n        icon: '<i class=\"fas fa-trash fa-fw\"></i>',\r\n        condition: (header) => PresetFolder.isEditable(header.closest('.folder').data('uuid')),\r\n        callback: (header) => this._onFolderDelete(header.closest('.folder').data('uuid')),\r\n      },\r\n      {\r\n        name: localize('FOLDER.Delete', false),\r\n        icon: '<i class=\"fas fa-dumpster\"></i>',\r\n        condition: (header) => PresetFolder.isEditable(header.closest('.folder').data('uuid')),\r\n        callback: (header) =>\r\n          this._onFolderDelete(header.closest('.folder').data('uuid'), {\r\n            deleteAll: true,\r\n          }),\r\n      },\r\n      {\r\n        name: 'Randomize Child Folder Colors',\r\n        icon: '<i class=\"fas fa-dice\"></i>',\r\n        condition: () => game.settings.get(MODULE_ID, 'debug'),\r\n        callback: (header) =>\r\n          randomizeChildrenFolderColors(header.closest('.folder').data('uuid'), this.tree, () => this.render(true)),\r\n      },\r\n    ];\r\n  }\r\n\r\n  async _onApplyToSelected(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n    });\r\n    if (!selected.length) return;\r\n\r\n    // Confirm that all presets are of the same document type\r\n    const types = new Set();\r\n    for (const s of selected) {\r\n      types.add(s.documentName);\r\n      if (types.size > 1) {\r\n        ui.notifications.warn(localize('presets.apply-to-selected-warn'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    const controlled = canvas.getLayerByEmbeddedName(selected[0].documentName).controlled;\r\n    if (!controlled.length) return;\r\n\r\n    for (const s of selected) {\r\n      pasteDataUpdate(controlled, s, false, true);\r\n    }\r\n  }\r\n\r\n  async _onCopySelectedPresets(pack, { keepFolder = false, keepId = true } = {}) {\r\n    const [selected, _] = await this._getSelectedPresets();\r\n\r\n    const presets = selected.map((s) => {\r\n      const p = s.clone();\r\n      if (!keepFolder) p.folder = null;\r\n      if (!keepId) p.id = foundry.utils.randomID();\r\n      return p;\r\n    });\r\n\r\n    await PresetCollection.set(presets, pack);\r\n\r\n    if (selected.length) this.render(true);\r\n  }\r\n\r\n  async _onActivateBrush(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n    });\r\n    BrushMenu.addPresets(selected);\r\n  }\r\n\r\n  async _onOpenJournal(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      editableOnly: false,\r\n    });\r\n    selected.forEach((p) => p.openJournal());\r\n  }\r\n\r\n  async _onEditSelectedPresets(item) {\r\n    const [selected, _] = await this._getSelectedPresets({\r\n      virtualOnly: item.hasClass('virtual'),\r\n      editableOnly: true,\r\n    });\r\n    if (selected.length) {\r\n      // Position edit window just bellow the item\r\n      const options = item.offset();\r\n      options.top += item.height();\r\n\r\n      this._editPresets(selected, options);\r\n    }\r\n  }\r\n\r\n  async _getSelectedPresets({ editableOnly = false, virtualOnly = false, full = true } = {}) {\r\n    const uuids = [];\r\n    let selector = '.item.selected';\r\n    if (virtualOnly) selector += '.virtual';\r\n\r\n    let items = this.element.find('.item-list').find(selector);\r\n    if (editableOnly)\r\n      items = items.filter(function () {\r\n        return Preset.isEditable($(this).data('uuid'));\r\n      });\r\n\r\n    items.each(function () {\r\n      const uuid = $(this).data('uuid');\r\n      uuids.push(uuid);\r\n    });\r\n\r\n    const selected = await PresetCollection.getBatch(uuids, { full });\r\n    return [selected, items];\r\n  }\r\n\r\n  _editPresets(presets, options = {}, event) {\r\n    options.callback = () => this.render(true);\r\n    if (!('left' in options) && event) {\r\n      options.left = event.originalEvent.x - PresetConfig.defaultOptions.width / 2;\r\n      options.top = event.originalEvent.y;\r\n    }\r\n    new PresetConfig(presets, options).render(true);\r\n  }\r\n\r\n  async _playPreview(event) {\r\n    clearTimeout(this._previewTimeout);\r\n    this._previewTimeout = setTimeout(() => this._renderPlayPreview(event), 200);\r\n  }\r\n\r\n  async _endPreview() {\r\n    clearTimeout(this._previewTimeout);\r\n    game.audio.playing.forEach((s) => {\r\n      if (s._mePreview) s.stop();\r\n    });\r\n    if (this._previewElement) {\r\n      this._previewElement.remove();\r\n      this._previewElement = null;\r\n    }\r\n  }\r\n\r\n  async _renderPlayPreview(event) {\r\n    await this._endPreview();\r\n    const uuid = $(event.currentTarget).data('uuid');\r\n    if (!uuid) return;\r\n\r\n    const addClearPreviewElement = () => {\r\n      if (!this._previewElement) {\r\n        this._previewElement = $('<div class=\"mePreviewElement\"></div>');\r\n        $(document.body).append(this._previewElement);\r\n      } else {\r\n        this._previewElement.empty();\r\n      }\r\n    };\r\n\r\n    const preset = await PresetCollection.get(uuid, { full: false });\r\n    if (preset.documentName === 'AmbientSound') {\r\n      const src = isAudio(preset.img) ? preset.img : (await preset.load()).data[0]?.path;\r\n      if (!src) return;\r\n      const sound = await game.audio.play(src);\r\n      sound._mePreview = true;\r\n\r\n      addClearPreviewElement();\r\n      this._previewElement.append(`<img width=\"320\" height=\"320\" src='icons/svg/sound.svg'></img>`);\r\n    } else if (preset.documentName === 'Tile' && preset.thumbnail === 'icons/svg/video.svg') {\r\n      await preset.load();\r\n      const src = preset.data[0].texture?.src;\r\n      if (src && isVideo(src)) {\r\n        addClearPreviewElement();\r\n        const ratio = visualViewport.width / 1024;\r\n        this._previewElement.append(\r\n          `<video width=\"${320 * ratio}\" height=\"${240 * ratio}\" autoplay loop><source src=\"${src}\" type=\"video/${src\r\n            .split('.')\r\n            .pop()\r\n            .toLowerCase()}\"></video>`\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  async _onPresetDragOut(event) {\r\n    const uuid = $(event.originalEvent.target).closest('.item').data('uuid');\r\n    const preset = await PresetCollection.get(uuid);\r\n    if (!preset) return;\r\n\r\n    // If released on top of a Mass Edit form, apply the preset to it instead of spawning it\r\n    let form = getMassEditForm();\r\n    if (form && form.documentName === preset.documentName && hoverForm(form, event.pageX, event.pageY)) {\r\n      form._applyPreset(preset);\r\n      return;\r\n    }\r\n\r\n    // If release on top of a Preset Bag, pass dragged UUIDs to it\r\n    let forms = Object.values(ui.windows).filter((w) => w.presetBag);\r\n    for (const form of forms) {\r\n      if (form && hoverForm(form, event.pageX, event.pageY)) {\r\n        form._dropUuids(this.dragData);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // If it's a scene preset apply it to the currently active scene\r\n    if (preset.documentName === 'Scene') {\r\n      applyPresetToScene(preset);\r\n      return;\r\n    }\r\n\r\n    if (!SUPPORTED_PLACEABLES.includes(preset.documentName)) return;\r\n\r\n    // For some reason canvas.mousePosition does not get updated during drag and drop\r\n    // Acquire the cursor position transformed to Canvas coordinates\r\n    let mouseX;\r\n    let mouseY;\r\n    let mouseZ;\r\n\r\n    if (game.Levels3DPreview?._active) {\r\n      game.Levels3DPreview.interactionManager._onMouseMove(event, true);\r\n      const { x, y, z } = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n      mouseX = x;\r\n      mouseY = y;\r\n      mouseZ = z;\r\n    } else {\r\n      const [x, y] = [event.clientX, event.clientY];\r\n      const t = canvas.stage.worldTransform;\r\n\r\n      mouseX = (x - t.tx) / canvas.stage.scale.x;\r\n      mouseY = (y - t.ty) / canvas.stage.scale.y;\r\n\r\n      if (preset.documentName === 'Token' || preset.documentName === 'Tile') {\r\n        mouseX -= canvas.dimensions.size / 2;\r\n        mouseY -= canvas.dimensions.size / 2;\r\n      }\r\n    }\r\n\r\n    Spawner.spawnPreset({\r\n      preset,\r\n      x: mouseX,\r\n      y: mouseY,\r\n      z: mouseZ,\r\n      mousePosition: false,\r\n      layerSwitch: PresetBrowser.CONFIG.switchLayer,\r\n      scaleToGrid: PresetBrowser.CONFIG.autoScale,\r\n    });\r\n  }\r\n\r\n  _folderToggle(folderElement) {\r\n    const uuid = folderElement.data('uuid');\r\n\r\n    const folder = this.tree.allFolders.get(uuid);\r\n    if (folder.expanded) this._folderCollapse(folderElement, folder);\r\n    else this._folderExpand(folderElement, folder);\r\n  }\r\n\r\n  async _folderExpand(folderElement, folder) {\r\n    FolderState.setExpanded(folder.uuid, true);\r\n    folder.expanded = true;\r\n\r\n    if (folderElement.find('.folder-items').length) {\r\n      folderElement.removeClass('collapsed');\r\n      folderElement.find('header .folder-icon').first().removeClass('fa-folder-closed').addClass('fa-folder-open');\r\n    } else {\r\n      let content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/partials/folder.html`, {\r\n        folder,\r\n        createEnabled: Boolean(this.configApp),\r\n        callback: Boolean(this.callback),\r\n        sortable:\r\n          !folder.uuid.startsWith('virtual@') && fromUuidSync(folder.uuid)?.pack === PresetCollection.workingPack,\r\n      });\r\n      folderElement.replaceWith(content);\r\n    }\r\n  }\r\n\r\n  _folderCollapse(folderElement, folder) {\r\n    folderElement.addClass('collapsed');\r\n    folderElement.find('header .folder-icon').first().removeClass('fa-folder-open').addClass('fa-folder-closed');\r\n\r\n    FolderState.setExpanded(folder.uuid, false);\r\n    folder.expanded = false;\r\n  }\r\n\r\n  async _renderContent({ callback = false, presets, folders, createEnabled = false, extFolders } = {}) {\r\n    const content = await renderTemplate(`modules/${MODULE_ID}/templates/preset/partials/presetsContent.html`, {\r\n      callback,\r\n      presets,\r\n      folders,\r\n      createEnabled,\r\n      extFolders,\r\n    });\r\n    this.element.find('.item-list').html(content);\r\n  }\r\n\r\n  _onCopyUUID(item) {\r\n    game.clipboard.copyPlainText(item.data('uuid'));\r\n    ui.notifications.info(\r\n      game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n        label: item.attr('name'),\r\n        type: 'uuid',\r\n        id: item.data('uuid'),\r\n      })\r\n    );\r\n  }\r\n\r\n  async _onItemSort(sourceUuids, targetUuid, { before = true, folderUuid = null } = {}) {\r\n    throw new Error('A subclass of the PresetContainer must implement the _onItemSort method.');\r\n  }\r\n\r\n  async _onFolderDelete(uuid, { render = true, deleteAll = false } = {}) {\r\n    throw new Error('A subclass of the PresetContainer must implement the _onFolderDelete method.');\r\n  }\r\n\r\n  async _onExportSelectedPresetsToComp() {\r\n    throw new Error('A subclass of the PresetContainer must implement the _onExportSelectedPresetsToComp method.');\r\n  }\r\n\r\n  async _onDeleteSelectedPresets(item) {\r\n    throw new Error('A subclass of the PresetContainer must implement the _onDeleteSelectedPresets method.');\r\n  }\r\n\r\n  async _onOpenBag(uuid) {\r\n    if (!uuid) {\r\n      let [selected, _] = await this._getSelectedPresets({\r\n        editableOnly: false,\r\n      });\r\n\r\n      if (selected.length) {\r\n        const module = await import('./bagApp.js');\r\n        selected.filter((p) => p.documentName === 'Bag').forEach((p) => module.openBag(p.uuid));\r\n      }\r\n    } else {\r\n      const module = await import('./bagApp.js');\r\n      module.openBag(uuid);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * Application.setPosition(...) has been modified to use css transform for window translation across the screen\r\n   * instead of top/left css properties which force full-window style recomputation\r\n   */\r\n  setPosition({ left, top, width, height, scale } = {}) {\r\n    if (!this.popOut && !this.options.resizable) return; // Only configure position for popout or resizable apps.\r\n    const el = this.element[0];\r\n    const currentPosition = this.position;\r\n    const pop = this.popOut;\r\n    const styles = window.getComputedStyle(el);\r\n    if (scale === null) scale = 1;\r\n    scale = scale ?? currentPosition.scale ?? 1;\r\n\r\n    // If Height is \"auto\" unset current preference\r\n    if (height === 'auto' || this.options.height === 'auto') {\r\n      el.style.height = '';\r\n      height = null;\r\n    }\r\n\r\n    // Update width if an explicit value is passed, or if no width value is set on the element\r\n    if (!el.style.width || width) {\r\n      const tarW = width || el.offsetWidth;\r\n      const minW = parseInt(styles.minWidth) || (pop ? MIN_WINDOW_WIDTH : 0);\r\n      const maxW = el.style.maxWidth || window.innerWidth / scale;\r\n      currentPosition.width = width = Math.clamp\r\n        ? Math.clamp(tarW, minW, maxW) // v12\r\n        : Math.clamped(tarW, minW, maxW);\r\n      el.style.width = `${width}px`;\r\n      if (width * scale + currentPosition.left > window.innerWidth) left = currentPosition.left;\r\n    }\r\n    width = el.offsetWidth;\r\n\r\n    // Update height if an explicit value is passed, or if no height value is set on the element\r\n    if (!el.style.height || height) {\r\n      const tarH = height || el.offsetHeight + 1;\r\n      const minH = parseInt(styles.minHeight) || (pop ? MIN_WINDOW_HEIGHT : 0);\r\n      const maxH = el.style.maxHeight || window.innerHeight / scale;\r\n      currentPosition.height = height = Math.clamp\r\n        ? Math.clamp(tarH, minH, maxH) // v12\r\n        : Math.clamped(tarH, minH, maxH);\r\n      el.style.height = `${height}px`;\r\n      if (height * scale + currentPosition.top > window.innerHeight + 1) top = currentPosition.top - 1;\r\n    }\r\n    height = el.offsetHeight;\r\n\r\n    let leftT, topT;\r\n    // Update Left\r\n    if ((pop && !this.posSet) || Number.isFinite(left)) {\r\n      const scaledWidth = width * scale;\r\n      const tarL = Number.isFinite(left) ? left : (window.innerWidth - scaledWidth) / 2;\r\n      const maxL = Math.max(window.innerWidth - scaledWidth, 0);\r\n      currentPosition.left = left = Math.clamp\r\n        ? Math.clamp(tarL, 0, maxL) // v12\r\n        : Math.clamped(tarL, 0, maxL);\r\n      leftT = left;\r\n    }\r\n\r\n    // Update Top\r\n    if ((pop && !this.posSet) || Number.isFinite(top)) {\r\n      const scaledHeight = height * scale;\r\n      const tarT = Number.isFinite(top) ? top : (window.innerHeight - scaledHeight) / 2;\r\n      const maxT = Math.max(window.innerHeight - scaledHeight, 0);\r\n      currentPosition.top = Math.clamp\r\n        ? Math.clamp(tarT, 0, maxT) // v12\r\n        : Math.clamped(tarT, 0, maxT);\r\n\r\n      topT = currentPosition.top;\r\n    }\r\n\r\n    let transform = '';\r\n\r\n    // Update Scale\r\n    if (scale) {\r\n      currentPosition.scale = Math.max(scale, 0);\r\n\r\n      if (scale === 1) transform += ``;\r\n      else transform += `scale(${scale})`;\r\n    }\r\n\r\n    if (leftT || topT) {\r\n      this.posSet = true;\r\n      transform += 'translate(' + leftT + 'px,' + topT + 'px)';\r\n    }\r\n\r\n    if (transform) {\r\n      el.style.transform = transform;\r\n    }\r\n\r\n    // Return the updated position object\r\n    return currentPosition;\r\n  }\r\n}\r\n\r\n/**\r\n * Controls select/multi-select flow for item lists\r\n * @param {*} e item click event\r\n * @param {*} itemList list of items that this item exists within\r\n */\r\nexport function itemSelect(e, itemList) {\r\n  const item = $(e.target).closest('.item');\r\n  const items = itemList.find('.item');\r\n  const lastSelected = items.filter('.last-selected');\r\n\r\n  if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {\r\n    lastSelected.removeClass('last-selected');\r\n    items.removeClass('selected');\r\n    item.addClass('selected').addClass('last-selected');\r\n  } else if (e.ctrlKey || e.metaKey) {\r\n    item.toggleClass('selected');\r\n    if (item.hasClass('selected')) {\r\n      lastSelected.removeClass('last-selected');\r\n      item.addClass('last-selected');\r\n    } else item.removeClass('last-index');\r\n  } else if (e.shiftKey) {\r\n    if (lastSelected.length) {\r\n      let itemIndex = items.index(item);\r\n      let lastSelectedIndex = items.index(lastSelected);\r\n\r\n      if (itemIndex === lastSelectedIndex) {\r\n        item.toggleClass('selected');\r\n        if (item.hasClass('selected')) item.addClass('last-selected');\r\n        else lastSelected.removeClass('last-selected');\r\n      } else {\r\n        let itemArr = items.toArray();\r\n        if (itemIndex > lastSelectedIndex) {\r\n          for (let i = lastSelectedIndex; i <= itemIndex; i++) $(itemArr[i]).addClass('selected');\r\n        } else {\r\n          for (let i = lastSelectedIndex; i >= itemIndex; i--) $(itemArr[i]).addClass('selected');\r\n        }\r\n      }\r\n    } else {\r\n      lastSelected.removeClass('last-selected');\r\n      item.toggleClass('selected');\r\n      if (item.hasClass('selected')) item.addClass('last-selected');\r\n    }\r\n  }\r\n}\r\n\r\nfunction checkMouseInWindow(event) {\r\n  let inWindow = false;\r\n\r\n  if (ui.sidebar?.element?.length) {\r\n    inWindow = _coordOverElement(event.pageX, event.pageY, ui.sidebar.element);\r\n  }\r\n  if (!inWindow) {\r\n    inWindow = _coordOverElement(event.pageX, event.pageY, $(event.target).closest('.window-app'));\r\n  }\r\n\r\n  return inWindow;\r\n}\r\n\r\nfunction _coordOverElement(x, y, element) {\r\n  var offset = element.offset();\r\n  let appX = offset.left;\r\n  let appY = offset.top;\r\n  let appW = element.width();\r\n  let appH = element.height();\r\n\r\n  if (x > appX && x < appX + appW && y > appY && y < appY + appH) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Return true if mouse is hovering over the provided form\r\n * @param {Number} mouseX\r\n * @param {Number} mouseY\r\n * @returns {Application|null} MassEdit form\r\n */\r\nfunction hoverForm(form, mouseX, mouseY) {\r\n  if (!form) return false;\r\n\r\n  const hitTest = function (app) {\r\n    const position = app.position;\r\n    const appX = position.left;\r\n    const appY = position.top;\r\n    const height = Number.isNumeric(position.height) ? position.height : $(app.element).height();\r\n    const width = Number.isNumeric(position.width) ? position.width : $(app.element).width();\r\n\r\n    if (mouseX > appX && mouseX < appX + width && mouseY > appY && mouseY < appY + height) return true;\r\n    return false;\r\n  };\r\n\r\n  return hitTest(form);\r\n}\r\n","import { showMassEdit } from '../../applications/multiConfig';\r\nimport { MODULE_ID, SUPPORTED_PLACEABLES, SUPPORTED_SHEET_CONFIGS } from '../constants.js';\r\nimport { LinkerAPI } from '../linker/linker.js';\r\nimport { localFormat, localize, TagInput } from '../utils';\r\nimport { itemSelect } from './containerApp.js';\r\nimport { DOC_ICONS, Preset, VirtualFilePreset } from './preset.js';\r\nimport { exportPresets, mergePresetDataToDefaultDoc, placeableToData } from './utils.js';\r\n\r\nexport class PresetConfig extends FormApplication {\r\n  static name = 'PresetConfig';\r\n\r\n  /**\r\n   * @param {Array[Preset]} presets\r\n   */\r\n  constructor(presets, options = {}) {\r\n    super({}, options);\r\n    this.presets = presets;\r\n    this.callback = options.callback;\r\n    this.isCreate = options.isCreate;\r\n    this.attached = options.attached;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetEdit.html`,\r\n      width: 360,\r\n      height: 'auto',\r\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.content', initial: 'main' }],\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return 'mass-edit-preset-edit';\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    const prefix = this.presets[0] instanceof VirtualFilePreset ? 'File' : 'Preset';\r\n    if (this.presets.length > 1) return `${prefix}s [${this.presets.length}]`;\r\n    else return `${prefix}: ${this.presets[0].name.substring(0, 20)}${this.presets[0].name.length > 20 ? '...' : ''}`;\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: '',\r\n      class: 'mass-edit-export',\r\n      icon: 'fas fa-file-export',\r\n      onclick: (ev) => this._onExport(ev),\r\n    });\r\n    return buttons;\r\n  }\r\n\r\n  _onExport() {\r\n    let fileName;\r\n    if (this.presets.length === 1) {\r\n      fileName = 'mass-edit-preset-' + this.presets[0].name.replace(' ', '_').replace(/\\W/g, '');\r\n    }\r\n    exportPresets(this.presets, fileName);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @inheritdoc */\r\n  async close(options = {}) {\r\n    if (!this.options.submitOnClose) this.options.resolve?.(null);\r\n    return super.close(options);\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = {};\r\n\r\n    data.virtual = this.presets[0] instanceof VirtualFilePreset;\r\n\r\n    data.preset = {};\r\n    if (this.presets.length === 1) {\r\n      data.preset = foundry.utils.deepClone(this.presets[0].toJSON());\r\n      data.displayFieldDelete = true;\r\n\r\n      data.attached = this.attached || data.preset.attached;\r\n      if (data.attached) {\r\n        data.attached = data.attached.map((at) => {\r\n          let tooltip = at.documentName;\r\n          if (at.documentName === 'Token' && at.data.name) tooltip += ': ' + at.data.name;\r\n          return {\r\n            icon: DOC_ICONS[at.documentName] ?? DOC_ICONS.DEFAULT,\r\n            tooltip,\r\n          };\r\n        });\r\n      }\r\n    } else {\r\n      data.multiEdit = true;\r\n      data.preset = {};\r\n    }\r\n\r\n    // Form data stored if re-render was required\r\n    if (this._submitData) {\r\n      foundry.utils.mergeObject(data.preset, this._submitData);\r\n    }\r\n\r\n    data.minlength = this.presets.length > 1 ? 0 : 1;\r\n    data.tva = game.modules.get('token-variants')?.active;\r\n\r\n    if ((this.data && !(this.data instanceof Array)) || (!this.data && this.presets[0].isEmpty)) {\r\n      data.modifyDisabled = true;\r\n      data.deleteDisabled = true;\r\n    }\r\n\r\n    // Check if all presets are for the same document type and thus can be edited using a Mass Edit form\r\n    const documentName = this.presets[0].documentName;\r\n    if (\r\n      documentName !== 'Actor' &&\r\n      SUPPORTED_SHEET_CONFIGS.includes(documentName) &&\r\n      this.presets.every((p) => p.documentName === documentName)\r\n    ) {\r\n      data.documentEdit = documentName;\r\n      data.isPlaceable = SUPPORTED_PLACEABLES.includes(documentName);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    // Auto-select so that the pre-defined names can be conveniently erased\r\n    html.find('[name=\"name\"]').select();\r\n\r\n    html.find('.edit-document').on('click', this._onEditDocument.bind(this));\r\n    html.find('.assign-document').on('click', this._onAssignDocument.bind(this));\r\n    html.find('.delete-fields').on('click', this._onDeleteFields.bind(this));\r\n    html.find('.spawn-fields').on('click', this._onSpawnFields.bind(this));\r\n    html.find('summary').on('click', () => setTimeout(() => this.setPosition({ height: 'auto' }), 30));\r\n    html.find('.attached').on('click', this.onAttachedRemove.bind(this));\r\n    html.find('.attach-selected').on('click', () => {\r\n      const controlled = canvas.activeLayer.controlled;\r\n      if (controlled.length && SUPPORTED_PLACEABLES.includes(controlled[0].document.documentName)) {\r\n        this.dropPlaceable(controlled);\r\n      }\r\n    });\r\n\r\n    // TVA Support\r\n    const tvaButton = html.find('.token-variants-image-select-button');\r\n    tvaButton.on('click', (event) => {\r\n      game.modules.get('token-variants').api.showArtSelect('Preset', {\r\n        callback: (imgSrc, name) => {\r\n          tvaButton.siblings(`[name=\"${tvaButton.data('target')}\"]`).val(imgSrc);\r\n        },\r\n        searchType: 'Item',\r\n      });\r\n    });\r\n\r\n    //Hover\r\n    const hoverOverlay = html.closest('.window-content').find('.drag-drop-overlay');\r\n    html\r\n      .closest('.window-content')\r\n      .on('mouseover', (event) => {\r\n        if (this.presets.length !== 1) return;\r\n        if (canvas.activeLayer?.preview?.children.some((c) => c._original?.mouseInteractionManager?.isDragging)) {\r\n          hoverOverlay.show();\r\n          PresetConfig.objectHover = true;\r\n        } else {\r\n          hoverOverlay.hide();\r\n          PresetConfig.objectHover = false;\r\n        }\r\n      })\r\n      .on('mouseout', () => {\r\n        if (this.presets.length !== 1) return;\r\n        hoverOverlay.hide();\r\n        PresetConfig.objectHover = false;\r\n      });\r\n\r\n    //Tags\r\n    TagInput.activateListeners(html, {\r\n      change: () => this.setPosition({ height: 'auto' }),\r\n    });\r\n  }\r\n\r\n  _getSubmitData(updateData = {}) {\r\n    const data = super._getSubmitData(updateData);\r\n\r\n    data.name = data.name?.trim();\r\n    data.img = data.img?.trim() || null;\r\n    data.preSpawnScript = data.preSpawnScript?.trim();\r\n    data.postSpawnScript = data.postSpawnScript?.trim();\r\n    data.tags = data.tags ? data.tags.split(',') : [];\r\n    data.addTags = data.addTags ? data.addTags.split(',') : [];\r\n    data.removeTags = data.removeTags ? data.removeTags.split(',') : [];\r\n\r\n    return data;\r\n  }\r\n\r\n  async render(force = false) {\r\n    if (this.form) this._submitData = this._getSubmitData();\r\n    return await super.render(force);\r\n  }\r\n\r\n  /**\r\n   * Create a preset from placeables dragged and dropped ont he form\r\n   * @param {Array[Placeable]} placeables\r\n   * @param {Event} event\r\n   */\r\n  async dropPlaceable(placeables, event) {\r\n    if (!this.attached) this.attached = foundry.utils.deepClone(this.presets[0].attached ?? []);\r\n    placeables.forEach((p) =>\r\n      this.attached.push({\r\n        documentName: p.document.documentName,\r\n        data: placeableToData(p),\r\n      })\r\n    );\r\n\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async onAttachedRemove(event) {\r\n    const index = $(event.target).closest('.attached').data('index');\r\n    this.attached = this.attached || foundry.utils.deepClone(this.presets[0].attached);\r\n    this.attached.splice(index, 1);\r\n    await this.render(true);\r\n    setTimeout(() => this.setPosition({ height: 'auto' }), 30);\r\n  }\r\n\r\n  async _onSpawnFields() {\r\n    new PresetFieldModify(\r\n      this.data ?? this.presets[0].data,\r\n      (modifyOnSpawn) => {\r\n        this.modifyOnSpawn = modifyOnSpawn;\r\n      },\r\n      this.modifyOnSpawn ?? this.presets[0].modifyOnSpawn\r\n    ).render(true);\r\n  }\r\n\r\n  async _onDeleteFields() {\r\n    new PresetFieldDelete(this.data ?? this.presets[0].data, (data) => {\r\n      this.data = data;\r\n    }).render(true);\r\n  }\r\n\r\n  async _onAssignDocument() {\r\n    const controlled = canvas.getLayerByEmbeddedName(this.presets[0].documentName)?.controlled.map((p) => p.document);\r\n    if (!controlled?.length) return;\r\n\r\n    const linked = LinkerAPI.getLinkedDocuments(controlled);\r\n    if (linked.size) {\r\n      const response = await new Promise((resolve) => {\r\n        Dialog.confirm({\r\n          title: 'Override Attached',\r\n          content: `<p>Linked placeables have been detected [<b>${linked.size}</b>].</p><p>Should they be included and override <b>Attached</b>?</p>`,\r\n          yes: () => resolve(true),\r\n          no: () => resolve(false),\r\n          defaultYes: false,\r\n        });\r\n      });\r\n      if (response) {\r\n        this.attached = Array.from(linked).map((l) => {\r\n          return { documentName: l.documentName, data: placeableToData(l) };\r\n        });\r\n      }\r\n    }\r\n\r\n    const data = controlled.map((p) => placeableToData(p));\r\n    this.data = data;\r\n    ui.notifications.info(\r\n      localFormat('presets.assign', {\r\n        count: data.length,\r\n        document: this.presets[0].documentName,\r\n      })\r\n    );\r\n    this.gridSize = canvas.grid.size;\r\n    this.modifyOnSpawn = [];\r\n    this.render(true);\r\n  }\r\n\r\n  async _onEditDocument() {\r\n    const documents = [];\r\n    const cls = CONFIG[this.presets[0].documentName].documentClass;\r\n\r\n    for (const p of this.presets) {\r\n      p.data.forEach((d) => {\r\n        const tempDoc = new cls(mergePresetDataToDefaultDoc(p, d), { parent: canvas.scene });\r\n        documents.push(tempDoc);\r\n      });\r\n    }\r\n\r\n    const app = await showMassEdit(documents, null, {\r\n      presetEdit: true,\r\n      callback: (obj) => {\r\n        this.addSubtract = {};\r\n        this.randomize = {};\r\n        for (const k of Object.keys(obj.data)) {\r\n          if (k in obj.randomize) this.randomize[k] = obj.randomize[k];\r\n          if (k in obj.addSubtract) this.addSubtract[k] = obj.addSubtract[k];\r\n        }\r\n        this.data = obj.data;\r\n        this.render(true);\r\n      },\r\n      forceForm: true,\r\n    });\r\n\r\n    // For randomize and addSubtract only take into account the first preset\r\n    // and apply them to the form\r\n    const preset = new Preset({\r\n      data: {},\r\n      randomize: this.presets[0].randomize,\r\n      addSubtract: this.presets[0].addSubtract,\r\n    });\r\n    setTimeout(() => {\r\n      app._applyPreset(preset);\r\n    }, 400);\r\n  }\r\n\r\n  async _updatePresets(formData) {\r\n    for (const preset of this.presets) {\r\n      let update;\r\n      if (this.isCreate) {\r\n        update = {\r\n          name: formData.name || preset.name || localize('presets.default-name'),\r\n          img: formData.img ?? preset.img,\r\n        };\r\n      } else {\r\n        update = {\r\n          name: formData.name || preset.name,\r\n          img: formData.img || preset.img,\r\n        };\r\n      }\r\n\r\n      if (this.data) update.data = this.data;\r\n      if (this.addSubtract) update.addSubtract = this.addSubtract;\r\n      if (this.randomize) update.randomize = this.randomize;\r\n      if (this.modifyOnSpawn) update.modifyOnSpawn = this.modifyOnSpawn;\r\n      if (this.gridSize || formData.gridSize) update.gridSize = this.gridSize ?? formData.gridSize;\r\n      if (this.attached) update.attached = this.attached;\r\n      if (formData.preSpawnScript != null) update.preSpawnScript = formData.preSpawnScript;\r\n      if (formData.postSpawnScript != null) update.postSpawnScript = formData.postSpawnScript;\r\n      if (formData.spawnRandom != null) update.spawnRandom = formData.spawnRandom;\r\n      if (formData.preserveLinks != null) update.preserveLinks = formData.preserveLinks;\r\n\r\n      // If this is a single preset config, we override all tags\r\n      // If not we merge\r\n      if (this.presets.length === 1) {\r\n        update.tags = formData.tags;\r\n      } else if (formData.addTags.length || formData.removeTags.length) {\r\n        let tags = preset.tags ?? [];\r\n        if (formData.addTags.length) tags = Array.from(new Set(tags.concat(formData.addTags)));\r\n        if (formData.removeTags.length) tags = tags.filter((t) => !formData.removeTags.includes(t));\r\n        update.tags = tags;\r\n      }\r\n\r\n      await preset.update(update, true);\r\n    }\r\n\r\n    await Preset.processBatchUpdates();\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    // Particularly large updates can take a while, prevent the submit button being clicked multiple times\r\n    this.element.find('button[type=\"submit\"]').prop('disabled', true);\r\n\r\n    await this._updatePresets(formData);\r\n\r\n    if (this.callback) this.callback(this.presets);\r\n    return this.presets;\r\n  }\r\n\r\n  /** @inheritDoc */\r\n  async _renderOuter() {\r\n    const html = await super._renderOuter();\r\n    this._createDocumentIdLink(html);\r\n    return html;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /**\r\n   * Create an ID link button in the header which displays the JournalEntry ID and copies it to clipboard\r\n   * @param {jQuery} html\r\n   * @protected\r\n   */\r\n  _createDocumentIdLink(html) {\r\n    const title = html.find('.window-title');\r\n    const label = localize('DOCUMENT.JournalEntry', false);\r\n    const idLink = document.createElement('a');\r\n    idLink.classList.add('document-id-link');\r\n    idLink.setAttribute('alt', 'Copy document id');\r\n    idLink.dataset.tooltip = `${label}: ${this.presets.map((p) => p.id).join(', ')}`;\r\n    idLink.dataset.tooltipDirection = 'UP';\r\n    idLink.innerHTML = '<i class=\"fa-solid fa-passport\"></i>';\r\n    idLink.addEventListener('click', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.id).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'id',\r\n          id: this.presets.map((p) => p.id).join(', '),\r\n        })\r\n      );\r\n    });\r\n    idLink.addEventListener('contextmenu', (event) => {\r\n      event.preventDefault();\r\n      game.clipboard.copyPlainText(this.presets.map((p) => p.uuid).join(', '));\r\n      ui.notifications.info(\r\n        game.i18n.format('DOCUMENT.IdCopiedClipboard', {\r\n          label,\r\n          type: 'uuid',\r\n          id: this.presets.map((p) => p.uuid).join(', '),\r\n        })\r\n      );\r\n    });\r\n    title.append(idLink);\r\n  }\r\n}\r\n\r\nclass PresetFieldSelect extends FormApplication {\r\n  static name = 'PresetFieldSelect';\r\n\r\n  constructor(data, callback) {\r\n    super();\r\n    this.presetData = data;\r\n    this.isObject = !(data instanceof Array);\r\n    this.callback = callback;\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'preset-field-select', 'mass-edit-dark-window', 'mass-edit-window-fill'],\r\n      template: `modules/${MODULE_ID}/templates/preset/presetFieldSelect.html`,\r\n      width: 600,\r\n      resizable: false,\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    html.find('.item').on('click', this._onFieldClick);\r\n  }\r\n\r\n  _onFieldClick(e) {\r\n    itemSelect(e, $(e.target).closest('.preset-field-list'));\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const singleData = !this.isObject && this.presetData.length === 1;\r\n\r\n    let index;\r\n    let fields = [];\r\n    for (const [k, v] of Object.entries(data)) {\r\n      if (!singleData) {\r\n        const i = k.split('.')[0];\r\n        if (!index) {\r\n          fields.push({ header: true, index: 0 });\r\n        } else if (i !== index) {\r\n          fields.push({ header: true, index: i });\r\n        }\r\n        index = i;\r\n      }\r\n\r\n      let label = k;\r\n      if (singleData) label = label.substring(label.indexOf('.') + 1);\r\n\r\n      let value;\r\n      const t = foundry.utils.getType(v);\r\n      if (t === 'Object' || t === 'Array' || t === 'null') value = JSON.stringify(v);\r\n      else value = v;\r\n\r\n      fields.push({ name: k, label, value, selected: false });\r\n    }\r\n\r\n    return { fields };\r\n  }\r\n}\r\n\r\nclass PresetFieldModify extends PresetFieldSelect {\r\n  static name = 'PresetFieldModify';\r\n\r\n  constructor(data, callback, modifyOnSpawn) {\r\n    super(data, callback);\r\n    this.modifyOnSpawn = modifyOnSpawn ?? [];\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-modify');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = {\r\n      icon: '<i class=\"fas fa-check\"></i>',\r\n      text: localize('CONTROLS.CommonSelect', false),\r\n    };\r\n    for (const field of data.fields) {\r\n      if (this.modifyOnSpawn.includes(field.name)) field.selected = true;\r\n    }\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    const form = $(event.target).closest('form');\r\n    const modifyOnSpawn = [];\r\n    form.find('.item.selected').each(function () {\r\n      let name = $(this).attr('name');\r\n      modifyOnSpawn.push(name);\r\n    });\r\n\r\n    this.callback(modifyOnSpawn);\r\n  }\r\n}\r\n\r\nclass PresetFieldDelete extends PresetFieldSelect {\r\n  static name = 'PresetFieldDelete';\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get title() {\r\n    return localize('presets.select-delete');\r\n  }\r\n\r\n  /** @override */\r\n  async getData(options = {}) {\r\n    const data = await super.getData(options);\r\n    data.button = {\r\n      icon: '<i class=\"fas fa-trash\"></i>',\r\n      text: localize('common.delete'),\r\n    };\r\n    return data;\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  async _updateObject(event, formData) {\r\n    let data = foundry.utils.flattenObject(this.presetData);\r\n\r\n    const form = $(event.target).closest('form');\r\n    form.find('.item.selected').each(function () {\r\n      const name = $(this).attr('name');\r\n      delete data[name];\r\n    });\r\n    data = foundry.utils.expandObject(data);\r\n\r\n    if (!this.isObject) {\r\n      let reorganizedData = [];\r\n      for (let i = 0; i < this.presetData.length; i++) {\r\n        if (!data[i]) continue;\r\n        reorganizedData.push(data[i]);\r\n      }\r\n      data = reorganizedData;\r\n    }\r\n\r\n    this.callback(data);\r\n  }\r\n}\r\n","import { FILE_EXTENSIONS, MODULE_ID } from '../constants.js';\r\nimport { TagInput } from '../utils.js';\r\nimport { PresetTree, VirtualFileFolder } from './collection.js';\r\nimport { VirtualFilePreset } from './preset.js';\r\nimport { encodeURIComponentSafely, readJSONFile } from './utils.js';\r\n\r\nconst CACHE_PATH = '';\r\nconst CACHE_NAME = 'mass_edit_cache.json';\r\n\r\nexport class FileIndexer {\r\n  static _loadedTree;\r\n  static _buildingIndex = false;\r\n\r\n  static async getVirtualDirectoryTree(type, { setFormVisibility = false } = {}) {\r\n    if (CONFIG.debug.MassEdit) console.time('Virtual File Directory');\r\n\r\n    // If we already have a loaded index, re-use it\r\n    if (this._loadedTree) {\r\n      if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n      if (setFormVisibility) this._loadedTree.setVisibility(type);\r\n      return this._loadedTree;\r\n    }\r\n\r\n    // Load and convert an index cache to a virtual folder\r\n    const allFolders = new Map();\r\n    const allPresets = [];\r\n    const topLevelFolders = [];\r\n\r\n    const cache = await this.loadMainIndexCache();\r\n    if (!cache) {\r\n      if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n      return null;\r\n    }\r\n\r\n    for (const source of cache) {\r\n      let prePend = '';\r\n      if (source.source === 'forge-bazaar') {\r\n        prePend = `https://assets.forge-vtt.com/bazaar/`;\r\n      } else if (source.source === 'forgevtt') {\r\n        if (typeof ForgeVTT === 'undefined' || !ForgeVTT.usingTheForge) continue;\r\n        const userId = await ForgeAPI.getUserId();\r\n        if (!userId) continue;\r\n        prePend = `https://assets.forge-vtt.com/${userId}/`;\r\n      } else if (source.source === 's3') {\r\n        const s3 = game.data.files.s3;\r\n        if (!s3 || !s3.buckets.includes(source.bucket)) continue;\r\n        prePend = `https://${source.bucket}.${s3.endpoint.host}`;\r\n      }\r\n      const folders = source.index.map((f) =>\r\n        this._indexToVirtualFolder(f, '', allFolders, allPresets, {\r\n          prePend,\r\n          source: source.source,\r\n          bucket: source.bucket,\r\n        })\r\n      );\r\n\r\n      if (folders?.length) {\r\n        const sFolder = new VirtualFileFolder({\r\n          uuid: 'virtual@source@' + source.source,\r\n          name: source.source,\r\n          children: folders,\r\n          types: ['ALL'],\r\n          bucket: source.bucket,\r\n        });\r\n        if (folders.some((f) => f.types.includes('Tile'))) sFolder.types.push('Tile');\r\n        if (folders.some((f) => f.types.includes('AmbientSound'))) sFolder.types.push('AmbientSound');\r\n        folders.forEach((f) => {\r\n          f.folder = sFolder.id;\r\n        });\r\n        allFolders.set(sFolder.uuid, sFolder);\r\n        topLevelFolders.push(sFolder);\r\n      }\r\n    }\r\n\r\n    let tree;\r\n    if (topLevelFolders.length) {\r\n      tree = new PresetTree({\r\n        folders: topLevelFolders,\r\n        presets: [],\r\n        allPresets,\r\n        allFolders,\r\n        hasVisible: allPresets.some((p) => p._visible),\r\n        metaDoc: null,\r\n        pack: null,\r\n      });\r\n\r\n      if (setFormVisibility) tree.setVisibility(type);\r\n    }\r\n\r\n    this._loadedTree = tree;\r\n\r\n    if (CONFIG.debug.MassEdit) console.timeEnd('Virtual File Directory');\r\n    return tree;\r\n  }\r\n\r\n  /**\r\n   * Build the directory index using the user defined paths to be scanned.\r\n   * Index structure: [{ dir: 'modules', files: [{ name: 'box.webp', tags: [] }], dirs: [] }];\r\n   */\r\n  static async buildIndex() {\r\n    if (this._buildingIndex) {\r\n      ui.notifications.warn('Index Build In-Progress. Wait for it to finish before attempting it again.');\r\n      return;\r\n    }\r\n\r\n    this._buildingIndex = true;\r\n\r\n    ui.notifications.info('Building Mass Edit directory index.');\r\n\r\n    const settings = game.settings.get(MODULE_ID, 'indexer');\r\n\r\n    try {\r\n      const scannedSources = [];\r\n      const foundCaches = [];\r\n\r\n      // Traverse directories specified in settings.indexDirs\r\n      for (const dir of settings.indexDirs) {\r\n        if (dir.source === 'forge-bazaar' || dir.source === 'forgevtt') {\r\n          await this._buildFauxForgeBrowser(dir.source, dir.target);\r\n        }\r\n        let iDir = await this.generateIndex(dir.target, foundCaches, dir.source, dir.bucket, settings);\r\n\r\n        if (iDir) {\r\n          const sPath = dir.target.split('/').filter(Boolean);\r\n          for (let i = sPath.length - 2; i >= 0; i--) {\r\n            iDir = { dir: sPath[i], dirs: [iDir] };\r\n          }\r\n\r\n          let index = scannedSources.find((i) => i.source === dir.source && i.bucket == dir.bucket);\r\n          if (index) this.mergeIndex(index.index, [iDir]);\r\n          else {\r\n            index = { source: dir.source, index: [iDir] };\r\n            if (dir.bucket) index.bucket = dir.bucket;\r\n            scannedSources.push(index);\r\n          }\r\n        }\r\n      }\r\n\r\n      // If pre-generated caches have been found we want to load and merge them here\r\n      for (const cacheFile of foundCaches) {\r\n        const cache = await this.loadIndexCache(cacheFile);\r\n        if (cache) this.mergeCaches(scannedSources, cache);\r\n      }\r\n\r\n      // User can specify if he wants the tags associated with images/video to be retained or not.\r\n      // overrideNullTagsOnly - true - will essentially override user changes to pre-cached directories\r\n      // overrideNullTagsOnly - false - pre-cached directory tags will be ignored, favoring user tags\r\n      const currentCache = await this.loadIndexCache(CACHE_PATH + '/' + CACHE_NAME);\r\n      if (currentCache) {\r\n        this.mergeCaches(scannedSources, currentCache, {\r\n          tagsOnly: true,\r\n          overrideNullTagsOnly: settings.overrideTags,\r\n        });\r\n      }\r\n\r\n      if (scannedSources.length) await this._writeIndexToCache(scannedSources);\r\n      this._loadedTree = null;\r\n\r\n      ui.notifications.info(`MassEdit Index build finished.`);\r\n    } catch (e) {\r\n      console.log(e);\r\n    }\r\n\r\n    this._buildingIndex = false;\r\n  }\r\n\r\n  static mergeCaches(cacheTo, cacheFrom, { tagsOnly = false, overrideNullTagsOnly = false } = {}) {\r\n    for (const indexSourceFrom of cacheFrom) {\r\n      const indexSourceTo = cacheTo.find(\r\n        (i) => i.source === indexSourceFrom.source && i.bucket == indexSourceFrom.bucket\r\n      );\r\n      if (indexSourceTo) {\r\n        this.mergeIndex(indexSourceTo.index, indexSourceFrom.index, {\r\n          tagsOnly,\r\n          overrideNullTagsOnly,\r\n        });\r\n      } else if (!tagsOnly) cacheTo.push(indexSourceFrom);\r\n    }\r\n  }\r\n\r\n  // options to only merge tags if they didn't have any\r\n  static mergeIndex(indexTo, indexFrom, { tagsOnly = false, overrideNullTagsOnly = false } = {}) {\r\n    for (const dirFrom of indexFrom) {\r\n      const dirTo = indexTo.find((dir) => dir.dir === dirFrom.dir);\r\n      if (dirTo) {\r\n        // TODO: We may want to merge customizable fields here\r\n        if (!tagsOnly) {\r\n          dirTo.icon = dirFrom.icon;\r\n          dirTo.subtext = dirFrom.subtext;\r\n        }\r\n\r\n        // Merge directories\r\n        if (dirFrom.dirs) {\r\n          if (dirTo.dirs) {\r\n            this.mergeIndex(dirTo.dirs, dirFrom.dirs, { tagsOnly, overrideNullTagsOnly });\r\n          } else if (!tagsOnly) {\r\n            dirTo.dirs = dirFrom.dirs;\r\n          }\r\n        }\r\n\r\n        // Merge files\r\n        if (dirFrom.files) {\r\n          if (dirTo.files) {\r\n            for (const fileFrom of dirFrom.files) {\r\n              const fileTo = dirTo.files?.find((f) => f.name === fileFrom.name);\r\n\r\n              if (fileTo) {\r\n                // TODO: We may want to merge customizable fields here\r\n                if (!overrideNullTagsOnly || fileTo.tags == null) fileTo.tags = fileFrom.tags;\r\n              } else if (!tagsOnly) {\r\n                if (!dirTo.files) dirTo.files = [];\r\n                dirTo.files.push(fileFrom);\r\n              }\r\n            }\r\n          } else if (!tagsOnly) dirTo.files = dirFrom.files;\r\n        }\r\n      } else if (!tagsOnly) indexTo.push(dirFrom);\r\n    }\r\n  }\r\n\r\n  static async getPreset(uuid) {\r\n    if (!this._loadedTree) await FileIndexer.getVirtualDirectoryTree();\r\n    if (!this._loadedTree) return null;\r\n    return this._loadedTree.allPresets.find((p) => p.uuid === uuid);\r\n  }\r\n\r\n  static async saveIndexToCache(\r\n    folders = this._loadedTree?.folders,\r\n    { path = CACHE_PATH, notify = true, source = 'data' } = {}\r\n  ) {\r\n    if (folders) {\r\n      const cache = [];\r\n      for (const sourceFolder of folders) {\r\n        const sourceCache = {\r\n          source: sourceFolder.name,\r\n          index: sourceFolder.children.map((f) => this._cacheFolder(f)),\r\n        };\r\n        if (sourceFolder.bucket) sourceCache.bucket = sourceFolder.bucket;\r\n        cache.push(sourceCache);\r\n      }\r\n\r\n      this._writeIndexToCache(cache, { path, notify, source });\r\n    }\r\n  }\r\n\r\n  static async _writeIndexToCache(index, { path = CACHE_PATH, notify = true, source = 'data' } = {}) {\r\n    const str = JSON.stringify(index);\r\n\r\n    const tFile = await StringCompress.compress(str);\r\n    await FilePicker.upload(source, path, tFile, {}, { notify });\r\n  }\r\n\r\n  static async saveFolderToCache(folder) {\r\n    if (!(this._loadedTree || folder.indexable || folder.source)) return;\r\n    const allFolders = this._loadedTree.allFolders;\r\n\r\n    let wFolder = folder;\r\n    while (wFolder.folder) {\r\n      let pFolder;\r\n      for (const [uuid, folder] of allFolders) {\r\n        if (folder.id === wFolder.folder) {\r\n          pFolder = folder;\r\n          break;\r\n        }\r\n      }\r\n      if (!pFolder) return;\r\n\r\n      pFolder = new VirtualFileFolder({\r\n        name: pFolder.name,\r\n        folder: pFolder.folder,\r\n      });\r\n      if (wFolder) pFolder.children = [wFolder];\r\n      wFolder = pFolder;\r\n    }\r\n\r\n    this.saveIndexToCache([wFolder], { path: folder.uuid.replace('virtual@', ''), source: folder.source });\r\n  }\r\n\r\n  static _cacheFolder(folder) {\r\n    const fDic = { dir: encodeURIComponentSafely(folder.name) };\r\n    if (folder.presets.length) fDic.files = folder.presets.map((p) => this._cachePreset(p));\r\n    if (folder.children.length) fDic.dirs = folder.children.map((c) => this._cacheFolder(c));\r\n    return fDic;\r\n  }\r\n\r\n  static _cachePreset(preset) {\r\n    const pDic = { name: encodeURIComponentSafely(preset.name) };\r\n    if (preset.tags?.length) pDic.tags = preset.tags;\r\n    return pDic;\r\n  }\r\n\r\n  static async loadIndexCache(cacheFile) {\r\n    let cache;\r\n    try {\r\n      cache = await StringCompress.decompressCache(cacheFile);\r\n    } catch (error) {\r\n      ui.notifications.warn(`Failed to load cache: ` + cacheFile);\r\n    }\r\n    return cache;\r\n  }\r\n\r\n  static async loadMainIndexCache() {\r\n    let path;\r\n    if (typeof ForgeVTT !== 'undefined' && ForgeVTT.usingTheForge) {\r\n      const userId = await ForgeAPI.getUserId();\r\n      path = `https://assets.forge-vtt.com/${userId}/${CACHE_NAME}`;\r\n    } else {\r\n      path = CACHE_PATH + '/' + CACHE_NAME;\r\n    }\r\n    return await this.loadIndexCache(path);\r\n  }\r\n\r\n  static _indexToVirtualFolder(cache, parentDirPath, allFolders, allPresets, options) {\r\n    const fullPath = parentDirPath + '/' + cache.dir;\r\n    const uuid = 'virtual@' + options.prePend + fullPath;\r\n    const fileFolder = new VirtualFileFolder({\r\n      uuid,\r\n      name: cache.dir,\r\n      subtext: cache.subtext,\r\n      icon: cache.icon,\r\n      color: cache.color,\r\n      source: options.source,\r\n      bucket: options.bucket,\r\n    });\r\n\r\n    if (cache.dirs) {\r\n      for (const dir of cache.dirs) {\r\n        const childFolder = this._indexToVirtualFolder(dir, fullPath, allFolders, allPresets, options);\r\n        if (childFolder) {\r\n          childFolder.folder = fileFolder.id;\r\n          fileFolder.children.push(childFolder);\r\n        }\r\n      }\r\n      fileFolder.children.sort((f1, f2) => f1.name.localeCompare(f2.name));\r\n    }\r\n\r\n    if (cache.files) {\r\n      for (const file of cache.files) {\r\n        const preset = new VirtualFilePreset({\r\n          name: file.name,\r\n          src: options.prePend + fullPath + '/' + file.name,\r\n          tags: file.tags,\r\n          folder: fileFolder.id,\r\n        });\r\n        allPresets.push(preset);\r\n        fileFolder.presets.push(preset);\r\n      }\r\n    }\r\n\r\n    // Assign folder to categories based on whether the folder itself or\r\n    // it's child folders contain presets of those types\r\n    ['Tile', 'AmbientSound'].forEach((type) => {\r\n      if (\r\n        fileFolder.presets.some((p) => p.documentName === type) ||\r\n        fileFolder.children.some((c) => c.types.includes(type))\r\n      ) {\r\n        fileFolder.types.push(type);\r\n      }\r\n    });\r\n\r\n    allFolders.set(uuid, fileFolder);\r\n    return fileFolder;\r\n  }\r\n\r\n  static async generateIndex(dir, foundCaches = [], source = 'data', bucket = null, settings, options = {}, tags = []) {\r\n    // Get options associated to this specific directory\r\n    let opts = options[dir] ?? {};\r\n    if (opts.noscan) return null;\r\n\r\n    // Get directory contents\r\n    // contents.dirs -> array of children directories\r\n    // contents.files -> array of contained files\r\n    let content;\r\n    try {\r\n      content = await this._browse(source, dir, { bucket });\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n\r\n    const indexerFile = content.files.find((f) => f.endsWith('indexer.json'));\r\n    if (indexerFile) {\r\n      options = (await readJSONFile(indexerFile)) ?? {};\r\n      opts = options[dir] ?? {};\r\n      if (opts.noscan) return null;\r\n    }\r\n\r\n    if (opts.tags) {\r\n      tags = opts.tags\r\n        .map((t) => TagInput.simplifyString(t))\r\n        .filter(Boolean)\r\n        .concat(tags);\r\n    }\r\n\r\n    const folder = {\r\n      dir: dir.split('/').filter(Boolean).pop(),\r\n      dirs: [],\r\n      files: [],\r\n    };\r\n    if (settings.folderFilters.some((k) => folder.dir.includes(k))) return null;\r\n    if (!foundry.utils.isEmpty(opts)) {\r\n      ['color', 'icon', 'subtext'].forEach((k) => {\r\n        if (opts[k]) folder[k] = opts[k];\r\n      });\r\n    }\r\n\r\n    for (let path of content.files) {\r\n      const fileName = path.split('\\\\').pop().split('/').pop();\r\n      if (settings.fileFilters.some((k) => fileName.includes(k))) continue;\r\n\r\n      // Special file processing\r\n\r\n      // Cancel indexing if noscan.txt or cache file is present within the directory\r\n      if (fileName === 'noscan.txt') return null;\r\n      else if (fileName === CACHE_NAME && !settings.ignoreExternal) {\r\n        const cacheDir = settings.cacheDir;\r\n        if (!(cacheDir.target === dir.target && cacheDir.source === source && cacheDir.bucket === bucket)) {\r\n          foundCaches.push(path);\r\n          return null;\r\n        }\r\n      } else if (fileName === 'module.json') {\r\n        // Read metadata from module's json file applying subtext to current folder\r\n        // and tags to all files\r\n        const author = await this._getAuthorFromModule(path);\r\n        if (author) {\r\n          folder.subtext = opts.subtext ?? author;\r\n          const tag = TagInput.simplifyString(author.split(/[ ,\\-_@]+/)[0] ?? '');\r\n          if (tag && tag.length >= 3) {\r\n            tags = [...tags, tag];\r\n            folder.files.forEach((f) => {\r\n              f.tags = tags;\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      // Otherwise process the file\r\n      let ext = fileName.split('.');\r\n      ext = ext[ext.length - 1].toLowerCase();\r\n\r\n      if (FILE_EXTENSIONS.includes(ext)) {\r\n        const f = { name: fileName };\r\n        if (tags.length) f.tags = tags;\r\n        folder.files.push(f);\r\n      }\r\n    }\r\n\r\n    for (let dir of content.dirs) {\r\n      dir = await this.generateIndex(dir, foundCaches, source, bucket, settings, options, tags);\r\n      if (dir) folder.dirs.push(dir);\r\n    }\r\n\r\n    if (!folder.dirs.length) delete folder.dirs;\r\n    if (!folder.files.length) delete folder.files;\r\n\r\n    if (!(folder.dirs || folder.files)) return null;\r\n    return folder;\r\n  }\r\n\r\n  static async _browse(source, dir, options) {\r\n    if (source === 'forge-bazaar' || source === 'forgevtt') {\r\n      return this._fauxForgeBrowser?.get(dir) ?? { dirs: [], files: [] };\r\n    } else {\r\n      return await FilePicker.browse(source, dir, options);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ForgeVTT forge-bazaar can be browsed recursively returning all the found dirs and files at a given path.\r\n   * To keep the processing consistent between different sources however we will simulate FilePicker.browse results\r\n   * by rebuilding the directory structure using the recursively retrieved results.\r\n   * This faux structure will be used by FileIndexer._browse(...)\r\n   * @param {String} source forge-bazaar or forgevtt\r\n   * @param {String} dir\r\n   */\r\n  static async _buildFauxForgeBrowser(source, dir) {\r\n    this._fauxForgeBrowser = new Map();\r\n\r\n    if (typeof ForgeVTT === 'undefined' || !ForgeVTT.usingTheForge) {\r\n      return;\r\n    }\r\n\r\n    // Recursion doesn't work for forge-bazaar paths at one level above root. Perform non-recursive browse\r\n    // and then recursive one on all of the retrieved dirs\r\n    let paths;\r\n    if (source === 'forgevtt' || !['modules', 'systems', 'worlds', 'assets'].includes(dir.replaceAll(/[\\/\\\\]/g, ''))) {\r\n      paths = [dir];\r\n    } else {\r\n      const contents = await FilePicker.browse(source, dir, { recursive: false });\r\n      paths = contents.dirs;\r\n    }\r\n\r\n    const insertFile = (dirs, file) => {\r\n      for (let i = 1; i < dirs.length + 1; i++) {\r\n        const pDirPath = dirs.slice(0, i).join('/');\r\n        const chDirPath = dirs.slice(0, i + 1).join('/');\r\n\r\n        let pDir = this._fauxForgeBrowser.get(pDirPath);\r\n        if (!pDir) {\r\n          pDir = { dirs: [], files: [] };\r\n          this._fauxForgeBrowser.set(pDirPath, pDir);\r\n        }\r\n        if (pDirPath === chDirPath) pDir.files.push(file);\r\n        else if (!pDir.dirs.includes(chDirPath)) pDir.dirs.push(chDirPath);\r\n      }\r\n    };\r\n\r\n    for (const path of paths) {\r\n      const contents = await FilePicker.browse(source, path, { recursive: true });\r\n      for (const file of contents.files) {\r\n        const pathname = new URL(file).pathname;\r\n        const components = pathname.split('/');\r\n        insertFile(components.slice(2, components.length - 1), components.slice(2).join('/'));\r\n      }\r\n    }\r\n  }\r\n\r\n  static async _getAuthorFromModule(moduleFile) {\r\n    const module = await readJSONFile(moduleFile);\r\n    if (module) {\r\n      const author = module.author ?? module.authors?.[0]?.name;\r\n      if (typeof author === 'string') return author;\r\n    }\r\n    return null;\r\n  }\r\n}\r\n\r\nclass StringCompress {\r\n  /**\r\n   * Compresses the provided string using native gzip implementation and return it as a File ready to be uploaded.\r\n   * @param {String} str string to be compressed\r\n   * @returns {File} compressed string file\r\n   */\r\n  static async compress(str) {\r\n    const stream = new Blob([str]).stream();\r\n    const compressedStream = stream.pipeThrough(new CompressionStream('gzip'));\r\n    const chunks = [];\r\n    for await (const chunk of this.streamAsyncIterator(compressedStream)) {\r\n      chunks.push(chunk);\r\n    }\r\n    const blob = new Blob(chunks);\r\n    const file = new File([blob], CACHE_NAME);\r\n    return file;\r\n  }\r\n\r\n  /**\r\n   * Decompressed provided compressed json file\r\n   * @param {String} filePath path to the compressed json file\r\n   * @returns {Object} decompressed and parsed json object\r\n   */\r\n  static async decompressCache(filePath) {\r\n    let cache;\r\n    try {\r\n      const response = await fetch(filePath);\r\n      if (response.ok) {\r\n        const str = await this.decompress(response.body);\r\n        cache = JSON.parse(str);\r\n      }\r\n    } catch (e) {}\r\n    return cache;\r\n  }\r\n\r\n  static async decompress(stream) {\r\n    const decompressedStream = stream.pipeThrough(new DecompressionStream('gzip'));\r\n    const chunks = [];\r\n    for await (const chunk of this.streamAsyncIterator(decompressedStream)) {\r\n      chunks.push(chunk);\r\n    }\r\n    const stringBytes = await this.concatUint8Arrays(chunks);\r\n    return new TextDecoder().decode(stringBytes);\r\n  }\r\n\r\n  static async concatUint8Arrays(uint8arrays) {\r\n    const blob = new Blob(uint8arrays);\r\n    const buffer = await blob.arrayBuffer();\r\n    return new Uint8Array(buffer);\r\n  }\r\n\r\n  static async *streamAsyncIterator(stream) {\r\n    const reader = stream.getReader();\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) return;\r\n        yield value;\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Form to help configure and execute index build.\r\n */\r\nexport class IndexerForm extends FormApplication {\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/preset/indexer.html`,\r\n      width: 500,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return 'Directory Indexer';\r\n  }\r\n\r\n  async getData(options = {}) {\r\n    const data = foundry.utils.deepClone(game.settings.get(MODULE_ID, 'indexer'));\r\n    data.fileFilters = data.fileFilters.join(', ');\r\n    data.folderFilters = data.folderFilters.join(', ');\r\n    return data;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.on('click', '.addDirectory', this._onAddDirectory.bind(this));\r\n    html.on('click', '.deleteDirectory', this._onDeleteDirectory.bind(this));\r\n    html.on('input', '[name=\"fileFilters\"]', this._onFileFiltersChange.bind(this));\r\n    html.on('input', '[name=\"folderFilters\"]', this._onFolderFiltersChange.bind(this));\r\n    html.find('input[type=\"checkbox\"]').on('change', this._onToggleCheckbox.bind(this));\r\n  }\r\n\r\n  _onToggleCheckbox(event) {\r\n    const chkBox = $(event.currentTarget);\r\n    const name = chkBox.attr('name');\r\n    this._updateIndexerSettings({ [name]: chkBox.is(':checked') }, false);\r\n  }\r\n\r\n  _onFileFiltersChange(event) {\r\n    clearTimeout(this._onInputTimeOut);\r\n    this._onInputTimeOut = setTimeout(() => {\r\n      const fileFilters = $(event.currentTarget)\r\n        .val()\r\n        .split(',')\r\n        .map((f) => f.trim())\r\n        .filter(Boolean);\r\n      this._updateIndexerSettings({ fileFilters }, false);\r\n    }, 500);\r\n  }\r\n\r\n  _onFolderFiltersChange(event) {\r\n    clearTimeout(this._onInputTimeOut);\r\n    this._onInputTimeOut = setTimeout(() => {\r\n      const folderFilters = $(event.currentTarget)\r\n        .val()\r\n        .split(',')\r\n        .map((f) => f.trim())\r\n        .filter(Boolean);\r\n      this._updateIndexerSettings({ folderFilters }, false);\r\n    }, 500);\r\n  }\r\n\r\n  async _onAddDirectory() {\r\n    this.selectFolder(async (selection) => {\r\n      if (!selection) return;\r\n      if (!selection.bucket) delete selection.bucket;\r\n\r\n      if (!['data', 'public', 'forge-bazaar', 'forgevtt', 's3'].includes(selection.source)) {\r\n        ui.notifications.warn(`${selection.source} is not a supported source.`);\r\n        return;\r\n      }\r\n\r\n      const indexDirs = game.settings.get(MODULE_ID, 'indexer').indexDirs;\r\n      // Make sure the selection is unique\r\n      if (\r\n        indexDirs.find(\r\n          (id) => id.source === selection.source && id.target === selection.target && id.bucket == selection.bucket\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      indexDirs.push(selection);\r\n      this._updateIndexerSettings({ indexDirs });\r\n    });\r\n  }\r\n\r\n  async _onDeleteDirectory(event) {\r\n    const directory = $(event.target).closest('.directory');\r\n    const source = directory.find('.source').val();\r\n    const target = directory.find('.target').val();\r\n    const bucket = directory.find('.bucket').val() || null;\r\n\r\n    const indexDirs = game.settings\r\n      .get(MODULE_ID, 'indexer')\r\n      .indexDirs.filter((id) => !(id.source === source && id.target === target && id.bucket == bucket));\r\n\r\n    this._updateIndexerSettings({ indexDirs });\r\n  }\r\n\r\n  async _updateIndexerSettings(update = {}, render = true) {\r\n    const settings = game.settings.get(MODULE_ID, 'indexer');\r\n    foundry.utils.mergeObject(settings, update);\r\n    await game.settings.set(MODULE_ID, 'indexer', settings);\r\n    if (render) await this.render();\r\n  }\r\n\r\n  async selectFolder(callback) {\r\n    new FilePicker({\r\n      type: 'folder',\r\n      activeSource: 'data',\r\n      current: '',\r\n      callback: (path, fp) => {\r\n        const selection = { target: fp.result.target, source: fp.activeSource, bucket: fp.result.bucket };\r\n        if (!selection.bucket) delete selection.bucket;\r\n        callback(selection);\r\n      },\r\n    }).render(true);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    FileIndexer.buildIndex();\r\n  }\r\n}\r\n\r\nexport class FileIndexerAPI {\r\n  static async readCacheFile(cacheFile) {\r\n    return FileIndexer.loadIndexCache(cacheFile);\r\n  }\r\n}\r\n","import { MODULE_ID, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { Scenescape } from '../scenescape/scenescape.js';\r\nimport { isAudio, loadImageVideoDimensions } from '../utils.js';\r\nimport { META_INDEX_FIELDS, META_INDEX_ID, PresetTree } from './collection.js';\r\nimport { FileIndexer } from './fileIndexer.js';\r\nimport { decodeURIComponentSafely, isVideo, placeableToData } from './utils.js';\r\n\r\nconst DOCUMENT_FIELDS = ['id', 'name', 'sort', 'folder'];\r\n\r\nexport const PRESET_FIELDS = [\r\n  'id',\r\n  'name',\r\n  'data',\r\n  'sort',\r\n  'folder',\r\n  'uuid',\r\n  'documentName',\r\n  'addSubtract',\r\n  'randomize',\r\n  'img',\r\n  'gridSize',\r\n  'modifyOnSpawn',\r\n  'preSpawnScript',\r\n  'postSpawnScript',\r\n  'spawnRandom',\r\n  'attached',\r\n  'tags',\r\n  'preserveLinks',\r\n];\r\n\r\nexport const DOC_ICONS = {\r\n  ALL: 'fas fa-globe',\r\n  Bag: 'fa-solid fa-sack',\r\n  Token: 'fas fa-user-circle',\r\n  MeasuredTemplate: 'fas fa-ruler-combined',\r\n  Tile: 'fa-solid fa-cubes',\r\n  Drawing: 'fa-solid fa-pencil-alt',\r\n  Wall: 'fa-solid fa-block-brick',\r\n  AmbientLight: 'fa-regular fa-lightbulb',\r\n  AmbientSound: 'fa-solid fa-music',\r\n  Note: 'fa-solid fa-bookmark',\r\n  Region: 'fa-regular fa-game-board',\r\n  Actor: 'fas fa-user-alt',\r\n  Scene: 'fas fa-map',\r\n  FauxScene: 'fas fa-map',\r\n  DEFAULT: 'fa-solid fa-question',\r\n};\r\n\r\nexport class Preset {\r\n  static isEditable(uuid) {\r\n    if (uuid.startsWith('virtual@')) return true;\r\n    let { collection } = foundry.utils.parseUuid(uuid);\r\n    if (!collection) return false;\r\n    return !collection.locked;\r\n  }\r\n\r\n  constructor(data) {\r\n    this.id = data.id ?? data._id ?? foundry.utils.randomID();\r\n    this.name = data.name ?? 'Mass Edit Preset';\r\n    this.documentName = data.documentName;\r\n    this.sort = data.sort ?? 0;\r\n    this.tags = data.tags ?? [];\r\n    this.addSubtract =\r\n      data.addSubtract instanceof Array\r\n        ? Object.fromEntries(data.addSubtract)\r\n        : foundry.utils.deepClone(data.addSubtract ?? {});\r\n    this.randomize =\r\n      data.randomize instanceof Array\r\n        ? Object.fromEntries(data.randomize)\r\n        : foundry.utils.deepClone(data.randomize ?? {});\r\n    this.data = foundry.utils.deepClone(data.data);\r\n    this.img = data.img;\r\n    this.folder = data.folder;\r\n    this.uuid = data.uuid;\r\n    this.gridSize = data.gridSize;\r\n    this.modifyOnSpawn = data.modifyOnSpawn;\r\n    this.preSpawnScript = data.preSpawnScript;\r\n    this.postSpawnScript = data.postSpawnScript;\r\n    this.attached = data.attached;\r\n    this.spawnRandom = data.spawnRandom;\r\n    this.preserveLinks = data.preserveLinks;\r\n    this._visible = true;\r\n    this._render = true;\r\n  }\r\n\r\n  get visible() {\r\n    return this._visible && this._render;\r\n  }\r\n\r\n  get icon() {\r\n    return DOC_ICONS[this.documentName] ?? DOC_ICONS.DEFAULT;\r\n  }\r\n\r\n  get thumbnail() {\r\n    if (!this.img) return CONST.DEFAULT_TOKEN;\r\n    else if (isAudio(this.img)) return 'icons/svg/sound.svg';\r\n    else if (isVideo(this.img)) return 'icons/svg/video.svg';\r\n    return this.img;\r\n  }\r\n\r\n  get pages() {\r\n    if (this.document?.pages.size) return this.document.toJSON().pages;\r\n    else if (this._pages) return this._pages;\r\n    return null;\r\n  }\r\n\r\n  set data(data) {\r\n    if (data instanceof Array) this._data = data.length ? data : [{}];\r\n    else if (data == null) this._data = [{}];\r\n    else this._data = [data];\r\n  }\r\n\r\n  get data() {\r\n    return this._data;\r\n  }\r\n\r\n  get isPlaceable() {\r\n    return SUPPORTED_PLACEABLES.includes(this.documentName);\r\n  }\r\n\r\n  get isEmpty() {\r\n    return foundry.utils.isEmpty(this.data[0]);\r\n  }\r\n\r\n  addPostSpawnHook(hook) {\r\n    if (!this._postSpawnHooks) this._postSpawnHooks = [];\r\n    this._postSpawnHooks.push(hook);\r\n  }\r\n\r\n  async callPostSpawnHooks(options) {\r\n    if (this._postSpawnHooks) {\r\n      for (const hook of this._postSpawnHooks) {\r\n        await hook(options);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads underlying JournalEntry document from the compendium\r\n   * @returns this\r\n   */\r\n  async load(force = false, document) {\r\n    if (this.document && !force) return this;\r\n    if (!this.document && this.uuid) {\r\n      this.document = document ?? (await fromUuid(this.uuid));\r\n    }\r\n\r\n    if (this.document) {\r\n      const preset = this.document.getFlag(MODULE_ID, 'preset') ?? {};\r\n      this.documentName = preset.documentName;\r\n      this.img = preset.img;\r\n      this.data = preset.data;\r\n      this.randomize =\r\n        foundry.utils.getType(preset.randomize) === 'Object'\r\n          ? preset.randomize\r\n          : Object.fromEntries(preset.randomize ?? []);\r\n      this.addSubtract =\r\n        foundry.utils.getType(preset.addSubtract) === 'Object'\r\n          ? preset.addSubtract\r\n          : Object.fromEntries(preset.addSubtract ?? []);\r\n      this.gridSize = preset.gridSize;\r\n      this.modifyOnSpawn = preset.modifyOnSpawn;\r\n      this.preSpawnScript = preset.preSpawnScript;\r\n      this.postSpawnScript = preset.postSpawnScript;\r\n      this.attached = preset.attached;\r\n      this.spawnRandom = preset.spawnRandom;\r\n      this.preserveLinks = preset.preserveLinks;\r\n      this.tags = preset.tags ?? [];\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  async openJournal() {\r\n    if (!this.document) await this.load();\r\n    if (this.document) this.document.sheet.render(true);\r\n  }\r\n\r\n  /**\r\n   * Looks for a tag in the format of '#ft' and returns the numerical value\r\n   * @returns\r\n   */\r\n  scenescapeSizeOverride() {\r\n    const regex = new RegExp(/(\\d+)ft/);\r\n    let size = this.tags.find((t) => t.match(regex))?.match(regex)[1];\r\n    if (!size && this.documentName === 'Token') {\r\n      const actor = game.actors.get(this.data[0].actorId);\r\n      if (actor) return Scenescape._getActorSize(actor, this.data[0]);\r\n      return 6;\r\n    }\r\n    if (size) return Number(size);\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Attach placeables\r\n   * @param {Placeable|Array[Placeable]} placeables\r\n   * @returns\r\n   */\r\n  async attach(placeables) {\r\n    if (!placeables) return;\r\n    if (!(placeables instanceof Array)) placeables = [placeables];\r\n\r\n    if (!this.attached) this.attached = [];\r\n    for (const placeable of placeables) {\r\n      this.attached.push({ documentName: placeable.document.documentName, data: placeableToData(placeable) });\r\n    }\r\n\r\n    await this.update({ attached: this.attached });\r\n  }\r\n\r\n  static _updateBatch = {};\r\n\r\n  /**\r\n   * Collate document updates to be processed at a later time using `processBatchUpdates`\r\n   * @param {Document} document\r\n   * @param {object} update\r\n   */\r\n  static batchUpdate(document, update) {\r\n    this._updateBatch[document.pack] = foundry.utils.mergeObject(this._updateBatch[document.pack] ?? {}, {\r\n      [document.id]: update,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Process updates collated using `batchUpdate`\r\n   */\r\n  static async processBatchUpdates() {\r\n    const batch = this._updateBatch;\r\n    this._updateBatch = {};\r\n\r\n    for (const pack of Object.keys(batch)) {\r\n      const updates = [];\r\n\r\n      for (const id of Object.keys(batch[pack])) {\r\n        const update = batch[pack][id];\r\n        update._id = id;\r\n        updates.push(update);\r\n      }\r\n\r\n      await JournalEntry.updateDocuments(updates, { pack });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update preset with the provided data\r\n   * @param {Object} update\r\n   */\r\n  async update(update, batch = false) {\r\n    if (this.document) {\r\n      const flagUpdate = {};\r\n      Object.keys(update).forEach((k) => {\r\n        if (k === 'randomize' || k === 'addSubtract') {\r\n          flagUpdate[k] = Object.entries(update[k]);\r\n          this[k] = update[k];\r\n        } else if (k === 'data' && !(update.data instanceof Array)) {\r\n          flagUpdate.data = this.data.map((d) => {\r\n            return foundry.utils.mergeObject(d, update.data);\r\n          });\r\n          this.data = flagUpdate.data;\r\n        } else if (PRESET_FIELDS.includes(k) && update[k] !== this[k]) {\r\n          flagUpdate[k] = update[k];\r\n          this[k] = update[k];\r\n        }\r\n      });\r\n\r\n      if (!foundry.utils.isEmpty(flagUpdate)) {\r\n        const docUpdate = { flags: { [MODULE_ID]: { preset: flagUpdate } } };\r\n        DOCUMENT_FIELDS.forEach((field) => {\r\n          if (field in flagUpdate && this.document[field] !== flagUpdate[field]) {\r\n            docUpdate[field] = flagUpdate[field];\r\n          }\r\n        });\r\n\r\n        if (batch) Preset.batchUpdate(this.document, docUpdate);\r\n        else await this.document.update(docUpdate);\r\n      }\r\n      await this._updateIndex(flagUpdate, batch);\r\n    } else {\r\n      console.warn('Updating preset without document', this.id, this.uuid, this.name);\r\n    }\r\n  }\r\n\r\n  async _updateIndex(data, batch = false) {\r\n    const update = {};\r\n\r\n    META_INDEX_FIELDS.forEach((field) => {\r\n      if (field in data) update[field] = data[field];\r\n    });\r\n\r\n    if (!foundry.utils.isEmpty(update)) {\r\n      const pack = game.packs.get(this.document.pack);\r\n      const metaDoc = await pack.getDocument(META_INDEX_ID);\r\n      if (metaDoc) {\r\n        if (batch) Preset.batchUpdate(metaDoc, { flags: { [MODULE_ID]: { index: { [this.id]: update } } } });\r\n        else await metaDoc.setFlag(MODULE_ID, 'index', { [this.id]: update });\r\n        delete PresetTree._packTrees[pack.metadata.name];\r\n      } else {\r\n        console.warn(`META INDEX missing in ${this.document.pack}`);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  toJSON() {\r\n    let json = {};\r\n    PRESET_FIELDS.forEach((field) => {\r\n      json[field] = this[field];\r\n    });\r\n\r\n    json.randomize = Object.entries(json.randomize ?? {});\r\n    json.addSubtract = Object.entries(json.addSubtract ?? {});\r\n    const pages = this.pages;\r\n    if (pages) json.pages = pages;\r\n\r\n    return json;\r\n  }\r\n\r\n  clone() {\r\n    const clone = new Preset(this.toJSON());\r\n    clone.document = this.document;\r\n    return clone;\r\n  }\r\n}\r\n\r\nexport class VirtualFilePreset extends Preset {\r\n  constructor(data) {\r\n    if (!data.name) data.name = data.src.split('/').pop();\r\n    data.name = decodeURIComponentSafely(data.name);\r\n\r\n    data.uuid = 'virtual@' + data.src;\r\n    data.documentName = isAudio(data.src) ? 'AmbientSound' : 'Tile';\r\n\r\n    if (!data.data) {\r\n      if (data.documentName === 'Tile') {\r\n        data.data = [{ texture: { src: data.src, scaleY: 1, scaleX: 1 }, x: 0, y: 0, rotation: 0 }];\r\n      } else {\r\n        data.data = [{ path: data.src, radius: 20, x: 0, y: 0 }];\r\n      }\r\n      data.img = data.src;\r\n    }\r\n\r\n    data.gridSize = 150;\r\n    super(data);\r\n  }\r\n\r\n  get virtual() {\r\n    return true;\r\n  }\r\n\r\n  async load(force = false) {\r\n    if (this._storedReference) return this;\r\n\r\n    const p = await FileIndexer.getPreset(this.uuid);\r\n    if (p) this.tags = p.tags;\r\n    this._storedReference = p;\r\n\r\n    // Ambient Sound, no further processing required\r\n    if (this.data[0].path) return this;\r\n\r\n    // Load image/video metadata to retrieve the width/height\r\n    const src = this.data[0].texture?.src;\r\n\r\n    let { width, height } = await loadImageVideoDimensions(src);\r\n\r\n    this.data[0].width = width ?? 100;\r\n    this.data[0].height = height ?? 100;\r\n\r\n    return this;\r\n  }\r\n\r\n  async update(update) {\r\n    if (!update.hasOwnProperty('tags')) return;\r\n\r\n    if (this._storedReference) {\r\n      this._storedReference.tags = update.tags;\r\n      clearTimeout(VirtualFilePreset._updateTimeout);\r\n      VirtualFilePreset._updateTimeout = setTimeout(() => FileIndexer.saveIndexToCache(), 3000);\r\n    }\r\n  }\r\n\r\n  clone() {\r\n    const data = this.toJSON();\r\n    data.src = data.img;\r\n    return new VirtualFilePreset(data);\r\n  }\r\n}\r\n","import { checkApplySpecialFields } from '../../applications/formUtils.js';\r\nimport { showGenericForm } from '../../applications/multiConfig.js';\r\nimport { MODULE_ID, PIVOTS } from '../constants.js';\r\nimport { DataTransformer } from '../data/transformer.js';\r\nimport { Picker } from '../picker.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport { Scenescape } from '../scenescape/scenescape.js';\r\nimport { createDocuments, executeScript } from '../utils.js';\r\nimport { PresetAPI } from './collection.js';\r\nimport { Preset } from './preset.js';\r\nimport {\r\n  applyTaggerTagRules,\r\n  getPivotOffset,\r\n  getPresetDataBounds,\r\n  getTransformToOrigin,\r\n  mergePresetDataToDefaultDoc,\r\n} from './utils.js';\r\n\r\nexport class Spawner {\r\n  /**\r\n   * Spawn a preset on the scene (uuid, name or preset itself are required).\r\n   * By default the current mouse position is used.\r\n   * @param {object} [options={}]\r\n   * @param {Preset} [options.preset]                    Preset\r\n   * @param {String} [options.uuid]                      Preset UUID\r\n   * @param {String} [options.name]                      Preset name\r\n   * @param {String} [options.type]                      Preset type (\"Token\", \"Tile\", etc)\r\n   * @param {String|Array[String]|Object} [options.tags] Preset tags, See PresetAPI.getPreset\r\n   * @param {Boolean} [options.random]                   If a unique preset could not be found, a random one will be chosen from the matched list\r\n   * @param {Number} [options.x]                         Spawn canvas x coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.y]                         Spawn canvas y coordinate (mouse position used if x or y are null)\r\n   * @param {Number} [options.z]                         Spawn canvas z coordinate (3D Canvas)\r\n   * @param {Boolean} [options.snapToGrid]               If 'true' snaps spawn position to the grid.\r\n   * @param {Boolean} [options.hidden]                   If 'true' preset will be spawned hidden.\r\n   * @param {Boolean} [options.layerSwitch]              If 'true' the layer of the spawned preset will be activated.\r\n   * @param {Boolean} [options.scaleToGrid]              If 'true' Tiles, Drawings, and Walls will be scaled relative to grid size.\r\n   * @param {Boolean} [options.modifyPrompt]             If 'true' a field modification prompt will be shown if configured via `Preset Edit > Modify` form\r\n   * @param {Boolean} [options.preview]                  If 'true' a preview will be shown allowing spawn position to be picked\r\n   * @param {String} [options.previewLabel]               Label displayed above crosshair when `preview` is enabled\r\n   * @returns {Array[Document]}\r\n   */\r\n  static async spawnPreset({\r\n    uuid,\r\n    preset,\r\n    name,\r\n    type,\r\n    folder,\r\n    tags,\r\n    random = false,\r\n    x,\r\n    y,\r\n    z,\r\n    preview = false,\r\n    previewLabel,\r\n    previewRestrictedDocuments = null,\r\n    sceneId = canvas.scene.id,\r\n    snapToGrid = true,\r\n    hidden = false,\r\n    layerSwitch = false,\r\n    scaleToGrid = false,\r\n    modifyPrompt = true,\r\n    pivot = PIVOTS.TOP_LEFT,\r\n    transform = {},\r\n    previewOnly = false,\r\n    flags,\r\n  } = {}) {\r\n    if (!canvas.ready) throw Error(\"Canvas need to be 'ready' for a preset to be spawned.\");\r\n    if (!(uuid || preset || name || type || folder || tags))\r\n      throw Error('ID, Name, Folder, Tags, or Preset is needed to spawn it.');\r\n    if (!preview && ((x == null && y != null) || (x != null && y == null)))\r\n      throw Error('Need both X and Y coordinates to spawn a preset.');\r\n\r\n    if (preset) await preset.load();\r\n    preset = preset ?? (await PresetAPI.getPreset({ uuid, name, type, folder, tags, random }));\r\n    if (!preset) throw Error(`No preset could be found matching: { uuid: \"${uuid}\", name: \"${name}\", type: \"${type}\"}`);\r\n\r\n    let presetData = foundry.utils.deepClone(preset.data);\r\n\r\n    // Instead of using the entire data group use only one random one\r\n    if (preset.spawnRandom && presetData.length) {\r\n      presetData = [presetData[Math.floor(Math.random() * presetData.length)]];\r\n    }\r\n\r\n    // Display prompt to modify data if needed\r\n    if (modifyPrompt && preset.modifyOnSpawn?.length) {\r\n      presetData = await Spawner.modifySpawnData(presetData, preset.modifyOnSpawn);\r\n      // presetData being returned as null means that the modify field form has been canceled\r\n      // in which case we should cancel spawning as well\r\n      if (presetData == null) return;\r\n    }\r\n\r\n    // Populate preset data with default placeable data\r\n    presetData = presetData.map((data) => {\r\n      return mergePresetDataToDefaultDoc(preset, data);\r\n    });\r\n    presetData = presetData.map((d) => foundry.utils.flattenObject(d));\r\n    if (!foundry.utils.isEmpty(preset.randomize)) await applyRandomization(presetData, null, preset.randomize); // Randomize data if needed\r\n    await checkApplySpecialFields(preset.documentName, presetData, presetData); // Apply Special fields (TMFX)\r\n    presetData = presetData.map((d) => foundry.utils.expandObject(d));\r\n\r\n    let presetAttached = foundry.utils.deepClone(preset.attached);\r\n\r\n    // Now that data is ready, execute the pre-spawn script to allow user modifications\r\n    if (preset.preSpawnScript) {\r\n      await executeScript(preset.preSpawnScript, { data: presetData, attached: presetAttached });\r\n    }\r\n\r\n    // Lets sort the preset data as well as any attached placeable data into document groups\r\n    // documentName -> data array\r\n    const docToData = new Map();\r\n    docToData.set(preset.documentName, presetData);\r\n    if (presetAttached) {\r\n      for (const attached of presetAttached) {\r\n        if (!docToData.get(attached.documentName)) docToData.set(attached.documentName, []);\r\n        docToData.get(attached.documentName).push(attached.data);\r\n      }\r\n    }\r\n\r\n    // Assign ownership to the user who triggered the spawn call, hide, apply flags, and re-generate links\r\n    Spawner._autoModifyData(docToData, hidden, flags, preset.preserveLinks, sceneId);\r\n\r\n    // =======================\r\n    // Spawn position handling\r\n    // =======================\r\n\r\n    if (!preview) {\r\n      const pos = Spawner._determineSpawnPosition(x, y, z, preset.documentName, snapToGrid);\r\n      ({ x, y, z } = pos);\r\n    }\r\n\r\n    // Scale data relative to grid size\r\n    if (scaleToGrid) {\r\n      let scale = 1.0;\r\n\r\n      if (Scenescape.active) {\r\n        const size = preset.scenescapeSizeOverride();\r\n        if (size) scale = ((100 / 6) * size) / getPresetDataBounds(docToData).height;\r\n\r\n        if (!preview) {\r\n          const params = Scenescape.getParallaxParameters({ x, y });\r\n          scale *= params.scale;\r\n        }\r\n      } else {\r\n        scale = canvas.grid.size / (preset.gridSize || 100);\r\n      }\r\n\r\n      DataTransformer.applyToMap(docToData, { x: 0, y: 0 }, { scale });\r\n    }\r\n\r\n    // Handle positioning of data around the spawn location\r\n    if (!preview) {\r\n      // Transform data to spawn position\r\n      const posTransform = getTransformToOrigin(docToData);\r\n      posTransform.x += x;\r\n      posTransform.y += y;\r\n\r\n      // 3D Support\r\n      if (game.Levels3DPreview?._active) {\r\n        if (z == null) posTransform.z = 0;\r\n        else posTransform.z += z;\r\n      } else delete posTransform.z;\r\n\r\n      let offset = getPivotOffset(Scenescape.active ? PIVOTS.BOTTOM : pivot, docToData);\r\n      posTransform.x -= offset.x;\r\n      posTransform.y -= offset.y;\r\n\r\n      DataTransformer.applyToMap(docToData, { x: 0, y: 0 }, posTransform);\r\n    } else {\r\n      // Display preview of the preset\r\n      const coords = await new Promise(async (resolve) => {\r\n        Picker.activate(resolve, {\r\n          documentName: preset.documentName,\r\n          previewData: docToData,\r\n          snap: snapToGrid,\r\n          label: previewLabel,\r\n          restrict: previewRestrictedDocuments,\r\n          pivot,\r\n          previewOnly,\r\n          ...transform,\r\n          spawner: true,\r\n        });\r\n      });\r\n      if (coords == null) return [];\r\n    }\r\n\r\n    // ================================\r\n    // end of - Spawn position handling\r\n    // ================================\r\n\r\n    // Switch active layer to the preset's base placeable type\r\n    if (layerSwitch) {\r\n      if (game.user.isGM || ['Token', 'MeasuredTemplate', 'Note'].includes(preset.documentName))\r\n        canvas.getLayerByEmbeddedName(preset.documentName)?.activate();\r\n    }\r\n\r\n    // ================\r\n    // Create Documents\r\n    // ================\r\n    const allDocuments = [];\r\n\r\n    for (const [documentName, dataArr] of docToData.entries()) {\r\n      const documents = await createDocuments(documentName, dataArr, sceneId, { spawnPreset: true });\r\n      documents.forEach((d) => allDocuments.push(d));\r\n    }\r\n\r\n    // Execute post spawn script/function\r\n    if (preset.postSpawnScript) {\r\n      await executeScript(preset.postSpawnScript, {\r\n        documents: allDocuments,\r\n        objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n      });\r\n    }\r\n    await preset.callPostSpawnHooks({\r\n      documents: allDocuments,\r\n      objects: allDocuments.map((d) => d.object).filter(Boolean),\r\n    });\r\n\r\n    return allDocuments;\r\n  }\r\n\r\n  static _regenerateLinks(docToData) {\r\n    const links = new Map();\r\n\r\n    const newLinkId = function (oldId) {\r\n      let id = links.get(oldId);\r\n      if (!id) {\r\n        if (oldId.startsWith('LinkTokenBehavior - ')) {\r\n          id = 'LinkTokenBehavior - ' + foundry.utils.randomID(8);\r\n        } else {\r\n          id = foundry.utils.randomID();\r\n        }\r\n        links.set(oldId, id);\r\n      }\r\n      return id;\r\n    };\r\n\r\n    docToData.forEach((data) => {\r\n      data.forEach((d) => {\r\n        d.flags?.[MODULE_ID]?.links?.forEach((l) => {\r\n          l.id = newLinkId(l.id);\r\n        });\r\n        d.behaviors?.forEach((b) => {\r\n          if (b.system?.linkId) b.system.linkId = newLinkId(b.system.linkId);\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  static _determineSpawnPosition(x, y, z, documentName, snapToGrid) {\r\n    if (x == null || y == null) {\r\n      if (game.Levels3DPreview?._active) {\r\n        const pos3d = game.Levels3DPreview.interactionManager.canvas2dMousePosition;\r\n        x = pos3d.x;\r\n        y = pos3d.y;\r\n        z = pos3d.z;\r\n      } else {\r\n        x = canvas.mousePosition.x;\r\n        y = canvas.mousePosition.y;\r\n\r\n        if (documentName === 'Token' || documentName === 'Tile') {\r\n          x -= canvas.dimensions.size / 2;\r\n          y -= canvas.dimensions.size / 2;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!Scenescape.active && snapToGrid && !game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)) {\r\n      let pos = canvas.getLayerByEmbeddedName(documentName).getSnappedPoint({ x, y });\r\n      x = pos.x;\r\n      y = pos.y;\r\n    }\r\n    return { x, y, z };\r\n  }\r\n\r\n  /**\r\n   * Assign ownership to the user who triggered the spawn, hide and apply flags if necessary\r\n   * @param {*} docToData\r\n   */\r\n  static _autoModifyData(docToData, hidden, flags, preserveLinks, sceneId) {\r\n    hidden = hidden || game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT);\r\n\r\n    docToData.forEach((dataArr, documentName) => {\r\n      dataArr.forEach((data) => {\r\n        // Assign ownership for Drawings and MeasuredTemplates\r\n        if (['Drawing', 'MeasuredTemplate'].includes(documentName)) {\r\n          if (documentName === 'Drawing') data.author = game.user.id;\r\n          else if (documentName === 'MeasuredTemplate') data.user = game.user.id;\r\n        }\r\n\r\n        // Hide\r\n        if (hidden) data.hidden = true;\r\n\r\n        // Apply flags\r\n        if (flags) data.flags = foundry.utils.mergeObject(data.flags ?? {}, flags);\r\n\r\n        // Apply Tagger rules for Spawn Preset behaviors\r\n        if (documentName === 'Region' && data.behaviors) {\r\n          data.behaviors.forEach((b) => {\r\n            if (b.system?.destinationTags?.length)\r\n              b.system.destinationTags = applyTaggerTagRules(b.system.destinationTags);\r\n          });\r\n        }\r\n\r\n        // TODO: REMOVE once Foundry implements bug fix for null flag override\r\n        if (documentName === 'Token' && data.flags?.['token-attacher']?.attached === null) {\r\n          delete data.flags['token-attacher'].attached;\r\n        }\r\n      });\r\n    });\r\n\r\n    // We need to make sure that newly spawned tiles are displayed above currently places ones\r\n    if (docToData.get('Tile')) {\r\n      const maxSort = Math.max(0, ...game.scenes.get(sceneId).tiles.map((d) => d.sort)) + 1;\r\n      docToData\r\n        .get('Tile')\r\n        .sort((t1, t2) => (t1.sort ?? 0) - (t2.sort ?? 0))\r\n        .forEach((d, i) => (d.sort = maxSort + i));\r\n    }\r\n\r\n    // Regenerate Linker links to ensure uniqueness on the spawned in scene\r\n    if (!preserveLinks) Spawner._regenerateLinks(docToData);\r\n  }\r\n\r\n  /**\r\n   * Opens a GenericMassEdit form to modify specific fields within the provided data\r\n   * @param {Object} data            data to be modified\r\n   * @param {Array[String]} toModify fields within data to be modified\r\n   * @returns modified data or null if form was canceled\r\n   */\r\n  static async modifySpawnData(data, toModify) {\r\n    const fields = {};\r\n    const flatData = foundry.utils.flattenObject(data);\r\n    for (const field of toModify) {\r\n      if (field in flatData) {\r\n        if (flatData[field] == null) fields[field] = '';\r\n        else fields[field] = flatData[field];\r\n      }\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(fields)) {\r\n      await new Promise((resolve) => {\r\n        showGenericForm(fields, 'PresetFieldModify', {\r\n          callback: (modified) => {\r\n            if (foundry.utils.isEmpty(modified)) {\r\n              if (modified == null) data = null;\r\n              resolve();\r\n              return;\r\n            }\r\n\r\n            for (const [k, v] of Object.entries(modified)) {\r\n              flatData[k] = v;\r\n            }\r\n\r\n            const tmpData = foundry.utils.expandObject(flatData);\r\n\r\n            const reorganizedData = [];\r\n            for (let i = 0; i < data.length; i++) {\r\n              reorganizedData.push(tmpData[i]);\r\n            }\r\n            data = reorganizedData;\r\n            resolve();\r\n          },\r\n          simplified: true,\r\n          noTabs: true,\r\n        });\r\n      });\r\n    }\r\n\r\n    return data;\r\n  }\r\n}\r\n","import { MODULE_ID, PIVOTS } from '../constants.js';\r\nimport { applyRandomization } from '../randomizer/randomizerUtils.js';\r\nimport { PresetAPI, PresetCollection } from './collection.js';\r\nimport { Preset } from './preset.js';\r\n\r\n/**\r\n * Tracking of folder open/close state\r\n */\r\nexport class FolderState {\r\n  static expanded(uuid) {\r\n    return game.folders._expanded[uuid];\r\n  }\r\n\r\n  static setExpanded(uuid, state) {\r\n    game.folders._expanded[uuid] = state;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert provided placeable into an object usable as Preset data\r\n * @param {Placeable} placeable\r\n * @returns\r\n */\r\nexport function placeableToData(placeable) {\r\n  const document = placeable.document ?? placeable;\r\n  const data = document.toObject();\r\n\r\n  // Check if `Token Attacher` has attached elements to this token\r\n  if (\r\n    document.documentName === 'Token' &&\r\n    game.modules.get('token-attacher')?.active &&\r\n    tokenAttacher?.generatePrototypeAttached\r\n  ) {\r\n    const attached = data.flags?.['token-attacher']?.attached || {};\r\n    if (!foundry.utils.isEmpty(attached)) {\r\n      const prototypeAttached = tokenAttacher.generatePrototypeAttached(data, attached);\r\n      foundry.utils.setProperty(data, 'flags.token-attacher.attached', null);\r\n      foundry.utils.setProperty(data, 'flags.token-attacher.prototypeAttached', prototypeAttached);\r\n      foundry.utils.setProperty(data, 'flags.token-attacher.grid', {\r\n        size: canvas.grid.size,\r\n        w: canvas.grid.sizeX ?? canvas.grid.w, // v12\r\n        h: canvas.grid.sizeY ?? canvas.grid.h, // v12\r\n      });\r\n    }\r\n  } else if (document.documentName === 'Token') {\r\n    // Scenescape data\r\n    const width = foundry.utils.getProperty(data, `flags.${MODULE_ID}.width`);\r\n    const height = foundry.utils.getProperty(data, `flags.${MODULE_ID}.height`);\r\n    if (width) data.width = width;\r\n    if (height) data.height = height;\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\n/**\r\n * Portions of code taken from Tagger (https://github.com/fantasycalendar/FoundryVTT-Tagger)\r\n * Applies Tagger module's tag rules\r\n * @param {Array[String]} tags\r\n * @returns {Array[String]}\r\n */\r\nexport function applyTaggerTagRules(tags) {\r\n  if (game.modules.get('tagger')?.active) {\r\n    const rules = {\r\n      /**\r\n       * Replaces a portion of the tag with a number based on how many objects in this scene has the same numbered tag\r\n       * @private\r\n       */\r\n      '{#}': (tag, regx) => {\r\n        const findTag = new RegExp('^' + tag.replace(regx, '([1-9]+[0-9]*)') + '$');\r\n        const existingDocuments = Tagger.getByTag(findTag);\r\n        if (!existingDocuments.length) return tag.replace(regx, 1);\r\n\r\n        const numbers = existingDocuments.map((existingDocument) => {\r\n          return Number(\r\n            Tagger.getTags(existingDocument)\r\n              .find((tag) => {\r\n                return tag.match(findTag);\r\n              })\r\n              .match(findTag)[1]\r\n          );\r\n        });\r\n\r\n        const length = Math.max(...numbers) + 1;\r\n        for (let i = 1; i <= length; i++) {\r\n          if (!numbers.includes(i)) {\r\n            return tag.replace(regx, i);\r\n          }\r\n        }\r\n      },\r\n\r\n      /**\r\n       *  Replaces the section of the tag with a random ID\r\n       *  @private\r\n       */\r\n      '{id}': (tag, regx, index) => {\r\n        let id = temporaryIds?.[tag]?.[index];\r\n        if (!id) {\r\n          if (!temporaryIds?.[tag]) {\r\n            temporaryIds[tag] = [];\r\n          }\r\n          id = foundry.utils.randomID();\r\n          temporaryIds[tag].push(id);\r\n        }\r\n        return tag.replace(regx, id);\r\n      },\r\n    };\r\n\r\n    const tagRules = Object.entries(rules).filter((entry) => {\r\n      entry[0] = new RegExp(`${entry[0]}`, 'g');\r\n      return entry;\r\n    });\r\n\r\n    tags = Tagger._validateTags(tags, 'TaggerHandler');\r\n\r\n    tags = tags.map((tag, index) => {\r\n      const applicableTagRules = tagRules.filter(([regx]) => {\r\n        return tag.match(regx);\r\n      });\r\n      if (!applicableTagRules.length) return tag;\r\n\r\n      applicableTagRules.forEach(([regx, method]) => {\r\n        tag = method(tag, regx, index);\r\n      });\r\n\r\n      return tag;\r\n    });\r\n  }\r\n  return tags;\r\n}\r\n\r\n/**\r\n * A Preset may not contain enough information within its data to spawn a placeable. This method populates\r\n * the data with some defaults so that a minimum viable placeable can be spawned.\r\n * @param {Preset} preset\r\n * @param {Object} presetData\r\n * @returns\r\n */\r\nexport function mergePresetDataToDefaultDoc(preset, presetData) {\r\n  let data;\r\n\r\n  // Set default values if needed\r\n  switch (preset.documentName) {\r\n    case 'Token':\r\n      data = { name: preset.name, elevation: 0, x: 0, y: 0, rotation: 0, width: 1, height: 1 };\r\n      break;\r\n    case 'Tile':\r\n      data = {\r\n        width: canvas.grid.sizeX ?? canvas.grid.w, // v12\r\n        height: canvas.grid.sizeY ?? canvas.grid.h, // v12\r\n        x: 0,\r\n        y: 0,\r\n        rotation: 0,\r\n        elevation: 0,\r\n      };\r\n      break;\r\n    case 'AmbientSound':\r\n      data = { radius: 20, x: 0, y: 0 };\r\n      break;\r\n    case 'Drawing':\r\n      data = {\r\n        shape: {\r\n          width: (canvas.grid.sizeX ?? canvas.grid.w) * 2, // v12\r\n          height: (canvas.grid.sizeY ?? canvas.grid.h) * 2, // v12\r\n          strokeWidth: 8,\r\n          strokeAlpha: 1.0,\r\n        },\r\n        x: 0,\r\n        y: 0,\r\n        rotation: 0,\r\n      };\r\n      break;\r\n    case 'MeasuredTemplate':\r\n      data = { distance: 10, x: 0, y: 0 };\r\n      break;\r\n    case 'AmbientLight':\r\n      data = { config: { dim: 20, bright: 20 }, x: 0, y: 0 };\r\n      break;\r\n    case 'Scene':\r\n      data = { name: preset.name };\r\n      break;\r\n    case 'Wall':\r\n      data = { c: [0, 0, canvas.grid.size, 0] };\r\n      break;\r\n    case 'Region':\r\n      data = {\r\n        name: preset.name,\r\n        shapes: [\r\n          {\r\n            type: 'rectangle',\r\n            hole: false,\r\n            x: 0,\r\n            y: 0,\r\n            width: (canvas.grid.sizeX ?? canvas.grid.w) * 2,\r\n            height: (canvas.grid.sizeX ?? canvas.grid.w) * 2,\r\n            rotation: 0,\r\n          },\r\n        ],\r\n      };\r\n      break;\r\n    default:\r\n      data = { x: 0, y: 0 };\r\n  }\r\n\r\n  return foundry.utils.mergeObject(data, presetData);\r\n}\r\n\r\nexport async function randomizeChildrenFolderColors(uuid, tree, callback) {\r\n  const folder = tree.allFolders.get(uuid);\r\n\r\n  const children = folder.children;\r\n  if (!children.length) return;\r\n\r\n  const colorTemp = await renderTemplate(`modules/${MODULE_ID}/templates/randomizer/color.html`, {\r\n    method: 'interpolateReverse',\r\n    space: 'srgb',\r\n    hue: 'longer',\r\n  });\r\n\r\n  let colorSlider;\r\n\r\n  const applyColors = async function (method, space, hue) {\r\n    const updates = children.map((c) => {\r\n      return {\r\n        color: '#000000',\r\n      };\r\n    });\r\n    const randObj = { color: { type: 'color', method, space, hue, colors: colorSlider.getColors() } };\r\n\r\n    await applyRandomization(updates, children, randObj);\r\n\r\n    for (let i = 0; i < children.length; i++) {\r\n      await children[i].update(updates[i]);\r\n    }\r\n\r\n    callback?.();\r\n  };\r\n\r\n  let dialog = new Dialog({\r\n    title: `Pick Range`,\r\n    content: `<form>${colorTemp}</form>`,\r\n    buttons: {\r\n      save: {\r\n        label: 'Apply',\r\n        callback: async (html) => {\r\n          applyColors(\r\n            html.find('[name=\"method\"]').val(),\r\n            html.find('[name=\"space\"]').val(),\r\n            html.find('[name=\"hue\"]').val()\r\n          );\r\n        },\r\n      },\r\n    },\r\n    render: (html) => {\r\n      import('../randomizer/slider.js').then((module) => {\r\n        colorSlider = new module.ColorSlider(html, [\r\n          { hex: '#663600', offset: 0 },\r\n          { hex: '#944f00', offset: 100 },\r\n        ]);\r\n        setTimeout(() => dialog.setPosition({ height: 'auto' }), 100);\r\n      });\r\n    },\r\n  });\r\n\r\n  dialog.render(true);\r\n}\r\n\r\n/**\r\n * Returns a transform that return first element to x:0, y:0 (z: 0)\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getTransformToOrigin(docToData) {\r\n  const [name, data] = docToData.entries().next().value;\r\n  const transform = {};\r\n  if (name === 'Wall') {\r\n    const c = data[0].c;\r\n    transform.x = -c[0];\r\n    transform.y = -c[1];\r\n    transform.z = 0;\r\n  } else if (name === 'Region') {\r\n    const b = getDataBounds(name, data[0]);\r\n    transform.x = -b.x1;\r\n    transform.y = -b.y1;\r\n    transform.z = -b.z1;\r\n  } else {\r\n    transform.x = -data[0].x;\r\n    transform.y = -data[0].y;\r\n    transform.z = -(data[0].elevation ?? 0);\r\n  }\r\n  return transform;\r\n}\r\n\r\n/**\r\n * Calculates and returns the overall bounds of the preset data\r\n * @param {Map<String, Array[Object]>} docToData\r\n * @returns\r\n */\r\nexport function getPresetDataBounds(docToData) {\r\n  let x1 = Number.MAX_SAFE_INTEGER;\r\n  let y1 = Number.MAX_SAFE_INTEGER;\r\n  let x2 = Number.MIN_SAFE_INTEGER;\r\n  let y2 = Number.MIN_SAFE_INTEGER;\r\n  let z1 = Number.MAX_SAFE_INTEGER;\r\n  let z2 = Number.MIN_SAFE_INTEGER;\r\n  docToData.forEach((dataArr, documentName) => {\r\n    for (const data of dataArr) {\r\n      const b = getDataBounds(documentName, data);\r\n      if (b.x1 < x1) x1 = b.x1;\r\n      if (b.y1 < y1) y1 = b.y1;\r\n      if (b.x2 > x2) x2 = b.x2;\r\n      if (b.y2 > y2) y2 = b.y2;\r\n      if (b.z1 < z1) z1 = b.z1;\r\n      if (b.z2 > z2) z2 = b.z2;\r\n    }\r\n  });\r\n  return { x: x1, y: y1, width: x2 - x1, height: y2 - y1, elevation: { bottom: z1, top: z2 } };\r\n}\r\n\r\n/**\r\n * Calculates and returns bounds of placeable's data\r\n * @param {String} documentName\r\n * @param {Object} data\r\n * @returns\r\n */\r\nexport function getDataBounds(documentName, data) {\r\n  let x1, y1, x2, y2, z1, z2;\r\n\r\n  if (documentName === 'Wall') {\r\n    x1 = Math.min(data.c[0], data.c[2]);\r\n    y1 = Math.min(data.c[1], data.c[3]);\r\n    x2 = Math.max(data.c[0], data.c[2]);\r\n    y2 = Math.max(data.c[1], data.c[3]);\r\n    z1 = 0;\r\n    z2 = 0;\r\n  } else if (documentName === 'Region') {\r\n    x2 = -Infinity;\r\n    y2 = -Infinity;\r\n    x1 = Infinity;\r\n    y1 = Infinity;\r\n    z1 = data.elevation?.bottom ?? 0;\r\n    z2 = data.elevation?.top ?? 0;\r\n    data.shapes?.forEach((shape) => {\r\n      if (shape.points) {\r\n        for (let i = 0; i < shape.points.length; i += 2) {\r\n          let x = shape.points[i];\r\n          let y = shape.points[i + 1];\r\n          x1 = Math.min(x1, x);\r\n          y1 = Math.min(y1, y);\r\n          x2 = Math.max(x2, x);\r\n          y2 = Math.max(y2, y);\r\n        }\r\n      } else {\r\n        x1 = Math.min(x1, shape.x);\r\n        y1 = Math.min(y1, shape.y);\r\n        x2 = Math.max(x2, shape.x + (shape.radiusX ?? shape.width));\r\n        y2 = Math.max(y2, shape.y + (shape.radiusY ?? shape.height));\r\n      }\r\n    });\r\n    return { x1, y1, x2, y2, z1, z2 };\r\n  } else {\r\n    x1 = data.x || 0;\r\n    y1 = data.y || 0;\r\n    z1 = data.elevation ?? 0;\r\n\r\n    let width, height;\r\n    if (documentName === 'Tile') {\r\n      width = data.width;\r\n      height = data.height;\r\n    } else if (documentName === 'Drawing') {\r\n      width = data.shape.width;\r\n      height = data.shape.height;\r\n    } else if (documentName === 'Token') {\r\n      if (data.flags?.[MODULE_ID]?.width != null) {\r\n        width = data.flags[MODULE_ID].width;\r\n      } else {\r\n        width = data.width;\r\n      }\r\n\r\n      if (data.flags?.[MODULE_ID]?.height != null) {\r\n        height = data.flags[MODULE_ID].height;\r\n      } else {\r\n        height = data.height;\r\n      }\r\n\r\n      width *= canvas.dimensions.size;\r\n      height *= canvas.dimensions.size;\r\n    } else {\r\n      width = 0;\r\n      height = 0;\r\n    }\r\n\r\n    x2 = x1 + (width || 0);\r\n    y2 = y1 + (height || 0);\r\n    z2 = z1;\r\n  }\r\n  return { x1, y1, x2, y2, z1, z2 };\r\n}\r\n\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['jpg', 'jpeg', 'png', 'svg', 'webp', 'gif'].includes(extension);\r\n}\r\n\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return ['mp4', 'ogg', 'webm', 'm4v'].includes(extension);\r\n}\r\n\r\nexport function decodeURIComponentSafely(uri) {\r\n  try {\r\n    return decodeURIComponent(uri);\r\n  } catch (e) {\r\n    console.warn('URI Component not decodable: ' + uri);\r\n    return uri;\r\n  }\r\n}\r\n\r\nexport function encodeURIComponentSafely(uri) {\r\n  try {\r\n    return encodeURIComponent(uri);\r\n  } catch (e) {\r\n    console.warn('URI Component not encodable: ' + uri);\r\n    return uri;\r\n  }\r\n}\r\n\r\nexport async function readJSONFile(url) {\r\n  try {\r\n    return await jQuery.getJSON(url);\r\n  } catch (e) {}\r\n  return null;\r\n}\r\n\r\n/**\r\n * Handle dropping of AmbientSound presets onto the sidebar playlists\r\n */\r\nexport function registerSideBarPresetDropListener() {\r\n  Hooks.on('renderSidebar', (sidebar, html) => {\r\n    if (!game.user.isGM) return;\r\n    html.on('drop', async (event) => {\r\n      const playlistId = $(event.target).closest('.directory-item.playlist').data('document-id');\r\n      if (!playlistId) return;\r\n      const playlist = game.playlists.get(playlistId);\r\n      if (!playlist) return;\r\n\r\n      let data = event.originalEvent.dataTransfer.getData('text/plain');\r\n      if (!data) return;\r\n      data = JSON.parse(data);\r\n\r\n      let presets = (await PresetAPI.getPresets({ uuid: data.uuids, full: false })).filter(\r\n        (p) => p.documentName === 'AmbientSound'\r\n      );\r\n\r\n      await PresetCollection.batchLoadPresets(presets);\r\n\r\n      const updates = [];\r\n\r\n      presets.forEach((p) => {\r\n        p.data.forEach((d) => {\r\n          if (d.path) {\r\n            updates.push({\r\n              name: p.name,\r\n              path: d.path,\r\n              channel: 'music',\r\n              repeat: false,\r\n              fade: null,\r\n              description: 'Mass Edit Preset',\r\n              volume: 0.52,\r\n              playing: false,\r\n              pausedTime: null,\r\n              flags: {},\r\n            });\r\n          }\r\n        });\r\n      });\r\n\r\n      PlaylistSound.create(updates, { parent: playlist });\r\n    });\r\n  });\r\n}\r\n\r\nexport function getPivotOffset(pivot, docToData, bounds) {\r\n  const { width, height } = bounds ?? getPresetDataBounds(docToData);\r\n  switch (pivot) {\r\n    case PIVOTS.TOP_LEFT:\r\n      return { x: 0, y: 0 };\r\n    case PIVOTS.TOP:\r\n      return { x: width / 2, y: 0 };\r\n    case PIVOTS.TOP_RIGHT:\r\n      return { x: width, y: 0 };\r\n    case PIVOTS.LEFT:\r\n      return { x: 0, y: height / 2 };\r\n    case PIVOTS.CENTER:\r\n      return { x: width / 2, y: height / 2 };\r\n    case PIVOTS.RIGHT:\r\n      return { x: height, y: height / 2 };\r\n    case PIVOTS.BOTTOM_LEFT:\r\n      return { x: 0, y: height };\r\n    case PIVOTS.BOTTOM:\r\n      return { x: width / 2, y: height };\r\n    case PIVOTS.BOTTOM_RIGHT:\r\n      return { x: width, y: height };\r\n  }\r\n\r\n  return { x: 0, y: 0 };\r\n}\r\n\r\nexport async function exportPresets(presets, fileName) {\r\n  if (!presets.length) return;\r\n\r\n  await PresetCollection.batchLoadPresets(presets);\r\n\r\n  presets = presets.map((p) => {\r\n    const preset = p.clone();\r\n    preset.folder = null;\r\n    preset.uuid = null;\r\n    return preset;\r\n  });\r\n\r\n  saveDataToFile(JSON.stringify(presets, null, 2), 'text/json', (fileName ?? 'mass-edit-presets') + '.json');\r\n}\r\n\r\n/**\r\n * Parses a search query returning terms, tags, and type found within it\r\n * @param {String} query\r\n * @returns {object} query components\r\n */\r\nexport function parseSearchQuery(query, { matchAny = true } = {}) {\r\n  let parsedQuery = {};\r\n\r\n  let terms = query\r\n    .trim()\r\n    .split(' ')\r\n    .filter((w) => w.length >= 2);\r\n  if (!terms.length) return parsedQuery;\r\n\r\n  const tags = terms.filter((f) => f.startsWith('#')).map((f) => f.substring(1));\r\n  if (tags.length) parsedQuery.tags = { tags, matchAny };\r\n\r\n  const type = terms.find((f) => f.startsWith('@'))?.substring(1);\r\n  if (type) parsedQuery.type = type;\r\n\r\n  terms = terms.filter((f) => !(f.startsWith('#') || f.startsWith('@'))).map((t) => t.toLocaleLowerCase());\r\n  if (terms.length) parsedQuery.terms = terms;\r\n\r\n  return parsedQuery;\r\n}\r\n\r\nexport async function importSceneCompendium(pack) {\r\n  // TODO: Display a dialog with scene compendium options\r\n\r\n  const compendium = game.packs.get(pack) ?? game.packs.getName(pack);\r\n  if (!compendium) throw Error('Invalid pack: ' + pack);\r\n  if (compendium.documentName !== 'Scene') throw Error('Pack provided is not a Scene compendium: ' + pack);\r\n\r\n  const presets = [];\r\n\r\n  const workingPackTree = await PresetCollection.getTree('SceneP', {\r\n    externalCompendiums: false,\r\n    virtualDirectory: false,\r\n    setFormVisibility: false,\r\n  });\r\n  const index = workingPackTree.metaDoc?.flags[MODULE_ID].index;\r\n\r\n  let alreadyImportedCount = 0;\r\n\r\n  compendium.index.forEach((i) => {\r\n    if (!index?.[i._id]) {\r\n      const preset = new Preset({\r\n        documentName: 'FauxScene',\r\n        id: i._id,\r\n        name: i.name,\r\n        img: i.thumb,\r\n        data: [\r\n          {\r\n            uuid: i.uuid,\r\n          },\r\n        ],\r\n      });\r\n      presets.push(preset);\r\n    } else {\r\n      alreadyImportedCount++;\r\n    }\r\n  });\r\n\r\n  await PresetCollection.set(presets);\r\n\r\n  ui.notifications.info(`Imported scenes: ${presets.length}/${alreadyImportedCount + presets.length}`);\r\n}\r\n","import { getData, regexStringReplace, wildcardStringReplace } from '../utils.js';\r\n\r\nexport function selectField(control) {\r\n  const formGroup = control.closest('.form-group');\r\n  formGroup.find('.mass-edit-checkbox input').prop('checked', true).trigger('change');\r\n  formGroup.find('.mass-edit-randomize').addClass('active');\r\n}\r\n\r\nexport function deselectField(control, configApp) {\r\n  const formGroup = control.closest('.form-group');\r\n\r\n  let allRandomizedRemoved = true;\r\n  if (configApp) {\r\n    formGroup.find('[name]').each(function () {\r\n      if (allRandomizedRemoved) allRandomizedRemoved = !Boolean(configApp.randomizeFields[this.name]);\r\n    });\r\n  }\r\n\r\n  if (allRandomizedRemoved) {\r\n    formGroup.find('.mass-edit-checkbox input').prop('checked', false).trigger('change');\r\n    formGroup.find('.mass-edit-randomize').removeClass('active');\r\n  }\r\n}\r\n\r\nexport function selectRandomizerFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    selectField(form.find(`[name=\"${key}\"]`));\r\n  }\r\n}\r\n\r\nexport async function applyRandomization(updates, objects, randomizeFields) {\r\n  // See if any field is to be randomized\r\n  if (!randomizeFields || foundry.utils.isEmpty(randomizeFields)) return;\r\n\r\n  let requiresCoordRandomization = false;\r\n\r\n  for (let i = 0; i < updates.length; i++) {\r\n    const update = updates[i];\r\n    for (const field of Object.keys(update)) {\r\n      if (field in randomizeFields) {\r\n        const obj = randomizeFields[field];\r\n\r\n        if (obj.type === 'select') {\r\n          update[field] = obj.selection[Math.floor(Math.random() * obj.selection.length)];\r\n        } else if (obj.type === 'number') {\r\n          obj.step = obj.step === 'any' ? 1 : Number(obj.step);\r\n          if (Number.isNaN(obj.step)) obj.step = 1;\r\n\r\n          if (obj.method === 'interpolate') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step + 1;\r\n            update[field] = (i % stepsInRange) * obj.step + obj.min;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            const stepsInRange = (obj.max - obj.min) / obj.step;\r\n            update[field] = (stepsInRange - (i % (stepsInRange + 1))) * obj.step + obj.min;\r\n          } else {\r\n            const stepsInRange = (obj.max - obj.min + (Number.isInteger(obj.step) ? 1 : 0)) / obj.step;\r\n            update[field] = Math.floor(Math.random() * stepsInRange) * obj.step + obj.min;\r\n          }\r\n        } else if (obj.type === 'boolean') {\r\n          update[field] = Math.random() < 0.5;\r\n        } else if (obj.type === 'color') {\r\n          // Convert to new format if needed\r\n          if (obj.color1) {\r\n            obj.colors = [\r\n              { hex: obj.color1, offset: 0 },\r\n              { hex: obj.color2, offset: 100 },\r\n            ];\r\n          }\r\n\r\n          // If space is discrete we simple choose a color, no blending required\r\n          if (obj.space === 'discrete') {\r\n            if (obj.method === 'interpolate') {\r\n              update[field] = obj.colors[i % obj.colors.length].hex;\r\n            } else if (obj.method === 'interpolateReverse') {\r\n              update[field] = obj.colors[obj.colors.length - 1 - (i % obj.colors.length)].hex;\r\n            } else {\r\n              update[field] = obj.colors[Math.floor(Math.random() * obj.colors.length)].hex;\r\n            }\r\n            continue;\r\n          }\r\n\r\n          let colors = obj.colors.map((c) => c);\r\n          if (colors[0].offset > 0) {\r\n            colors.unshift({ hex: colors[0].hex, offset: 0 });\r\n          }\r\n          if (colors[colors.length - 1].offset < 100) {\r\n            colors.push({ hex: colors[colors.length - 1].hex, offset: 100 });\r\n          }\r\n\r\n          // Calculate random offset\r\n          let rOffset;\r\n          if (obj.method === 'interpolate') {\r\n            rOffset = 1 - (i + 1) / updates.length;\r\n          } else if (obj.method === 'interpolateReverse') {\r\n            rOffset = (i + 1) / updates.length;\r\n          } else {\r\n            rOffset = Math.random();\r\n          }\r\n          rOffset *= 100;\r\n\r\n          // Find the two colors the random offset falls between\r\n          let j = 0;\r\n          while (j < colors.length - 1 && colors[j + 1].offset < rOffset) j++;\r\n          let color1, color2;\r\n          if (j === colors.length - 1) {\r\n            color1 = colors[j - 1];\r\n            color2 = colors[j];\r\n          } else {\r\n            color1 = colors[j];\r\n            color2 = colors[j + 1];\r\n          }\r\n\r\n          // Normalize the random offset\r\n          let rnOffset = rOffset - color1.offset;\r\n          rnOffset = rnOffset / (color2.offset - color1.offset);\r\n\r\n          // Create a Color.js range\r\n          const Color = (await import('../color/color.js')).default;\r\n          color1 = new Color(color1.hex);\r\n          color2 = new Color(color2.hex);\r\n          const space = obj.space || 'srgb';\r\n          const hue = obj.hue || 'shorter';\r\n          let range = color1.range(color2, {\r\n            space: space, // interpolation space\r\n            hue: hue,\r\n            outputSpace: 'srgb',\r\n          });\r\n\r\n          // Pick a color from range using normalized random offset\r\n          let rgb3 = range(rnOffset);\r\n          let hexColor = rgb3.toString({ format: 'hex' });\r\n          if (hexColor.length < 7) {\r\n            // 3 char hex, duplicate chars\r\n            hexColor = '#' + hexColor[1] + hexColor[1] + hexColor[2] + hexColor[2] + hexColor[3] + hexColor[3];\r\n          }\r\n          update[field] = hexColor;\r\n        } else if (obj.type === 'image') {\r\n          if (obj.method === 'sequential') {\r\n            update[field] = obj.images[i % obj.images.length];\r\n          } else {\r\n            update[field] = obj.images[Math.floor(Math.random() * obj.images.length)];\r\n          }\r\n\r\n          if (obj.maintainAspect) {\r\n            const width = objects?.[i]?.width ?? update.width;\r\n            const height = objects?.[i]?.height ?? update.height;\r\n            if (height != null && width != null) {\r\n              try {\r\n                const tex = await loadTexture(update[field]);\r\n                if (tex) {\r\n                  const tileRatio = width / height;\r\n                  const texRatio = tex.width / tex.height;\r\n                  if (texRatio !== tileRatio) {\r\n                    if (texRatio > tileRatio) {\r\n                      update['texture.scaleX'] = 1;\r\n                      update['texture.scaleY'] = tileRatio;\r\n                    } else {\r\n                      update['texture.scaleX'] = height / width;\r\n                      update['texture.scaleY'] = 1;\r\n                    }\r\n                  }\r\n                }\r\n              } catch (e) {}\r\n            }\r\n          }\r\n        } else if (obj.type === 'text') {\r\n          if (obj.method === 'findAndReplace' || obj.method === 'findAndReplaceRegex') {\r\n            if (objects) {\r\n              const data = foundry.utils.flattenObject(getData(objects[i]).toObject());\r\n              if (!data[field] && !obj.find) {\r\n                update[field] = obj.replace;\r\n              } else if (data[field]) {\r\n                // special handling for Tagger tags\r\n                if (field === 'flags.tagger.tags') {\r\n                  data[field] = data[field].join(',');\r\n                }\r\n\r\n                if (obj.method === 'findAndReplaceRegex') {\r\n                  update[field] = regexStringReplace(obj.find, obj.replace, data[field]);\r\n                } else {\r\n                  update[field] = wildcardStringReplace(obj.find, obj.replace, data[field]);\r\n                }\r\n              }\r\n            }\r\n          } else {\r\n            if (obj.method === 'unique') {\r\n              if (!obj.shuffled) {\r\n                shuffleArray(obj.strings);\r\n                obj.shuffled = true;\r\n                obj.i = -1;\r\n              }\r\n              obj.i++;\r\n              update[field] = obj.strings[obj.i % obj.strings.length];\r\n            } else {\r\n              update[field] = obj.strings[Math.floor(Math.random() * obj.strings.length)];\r\n            }\r\n          }\r\n        } else if (obj.type === 'coordinate') {\r\n          requiresCoordRandomization = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (requiresCoordRandomization) {\r\n    let coordCtrl;\r\n\r\n    // Sort placeables based on size\r\n    let pUpdates = [];\r\n    for (let i = 0; i < objects.length; i++) {\r\n      pUpdates.push({ p: objects[i], update: updates[i] });\r\n    }\r\n    pUpdates.sort(\r\n      (a, b) =>\r\n        (b.p.w ?? b.p.width ?? 0) + (b.p.h ?? b.p.height ?? 0) - (a.p.w ?? a.p.width ?? 0) - (a.p.h ?? a.p.height ?? 0)\r\n    );\r\n\r\n    for (const pUpdate of pUpdates) {\r\n      const obj = randomizeFields.x ?? randomizeFields.y;\r\n      if (obj.method === 'noOverlap') {\r\n        if (!coordCtrl) {\r\n          coordCtrl = {\r\n            freeId: 0,\r\n            boundingBox: obj.boundingBox,\r\n            freeRectangles: { 0: obj.boundingBox },\r\n            stepX: obj.stepX,\r\n            stepY: obj.stepY,\r\n          };\r\n        }\r\n        const [x, y] = randomPlace(pUpdate.p, coordCtrl);\r\n        pUpdate.update.x = x;\r\n        pUpdate.update.y = y;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the closest step increment to the provided number\r\n * @param {*} num\r\n * @param {*} step\r\n * @returns\r\n */\r\nexport function nearestStep(num, step) {\r\n  if (num % step <= step / 2) {\r\n    return num - (num % step);\r\n  }\r\n  return num - (num % step) + step;\r\n}\r\n\r\n/**\r\n * Generates a random number within the given range and step increment\r\n * @param {*} min\r\n * @param {*} max\r\n * @param {*} step\r\n * @returns\r\n */\r\nfunction randomNum(min, max, step) {\r\n  if (step === 'any') step = 1; // default to integer 1 just to avoid very large decimals\r\n  else step = Number(step);\r\n  const stepsInRange = (max - min) / step;\r\n  return Math.floor(Math.random() * (stepsInRange + (Number.isInteger(step) ? 1 : 0))) * step + min;\r\n}\r\n\r\n/**\r\n * In-place random shuffle of an array\r\n * @param {*} array\r\n * @returns\r\n */\r\nfunction shuffleArray(array) {\r\n  var i = array.length,\r\n    j = 0,\r\n    temp;\r\n\r\n  while (i--) {\r\n    j = Math.floor(Math.random() * (i + 1));\r\n\r\n    // swap randomly chosen element with current element\r\n    temp = array[i];\r\n    array[i] = array[j];\r\n    array[j] = temp;\r\n  }\r\n\r\n  return array;\r\n}\r\n\r\n/* ================================\r\n * === Coordinate Randomization ==\r\n * =============================== */\r\n\r\nfunction randomPlace(placeable, ctrl) {\r\n  const width = nearestStep(placeable.w ?? placeable.width, ctrl.stepX);\r\n  const height = nearestStep(placeable.h ?? placeable.height, ctrl.stepY);\r\n\r\n  const rec = { x: 0, y: 0, width: width, height: height };\r\n  const freeRectangles = ctrl.freeRectangles;\r\n\r\n  // get all free rectangles that can contain rec\r\n  let fittingRecs = Object.keys(freeRectangles).filter((id) => _canFit(freeRectangles[id], rec));\r\n\r\n  // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n\r\n  if (fittingRecs.length) {\r\n    // Pick a random free rectangle and choose a random location within so that it fits rec\r\n    const i = fittingRecs[Math.floor(Math.random() * fittingRecs.length)];\r\n    rec.x = randomNum(\r\n      freeRectangles[i].x,\r\n      Math.max(freeRectangles[i].x + freeRectangles[i].width - rec.width, 0),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      freeRectangles[i].y,\r\n      Math.max(freeRectangles[i].y + freeRectangles[i].height - rec.height, 0),\r\n      ctrl.stepY\r\n    );\r\n  } else {\r\n    // if there are no fitting places left, then place it randomly anywhere within the bounding box\r\n    rec.x = randomNum(\r\n      ctrl.boundingBox.x,\r\n      Math.max(ctrl.boundingBox.x + ctrl.boundingBox.width - rec.width, ctrl.boundingBox.x),\r\n      ctrl.stepX\r\n    );\r\n    rec.y = randomNum(\r\n      ctrl.boundingBox.y,\r\n      Math.max(ctrl.boundingBox.y + ctrl.boundingBox.height - rec.height, ctrl.boundingBox.y),\r\n      ctrl.stepY\r\n    );\r\n  }\r\n\r\n  // Find all free rectangles that this spot overlaps\r\n  let overlaps = Object.keys(freeRectangles).filter((id) => _intersectRec(freeRectangles[id], rec));\r\n\r\n  for (const id of overlaps) {\r\n    const overlap = freeRectangles[id];\r\n    // remove original rectangle\r\n    delete freeRectangles[id];\r\n\r\n    // left split\r\n    if (overlap.x < rec.x) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: rec.x - overlap.x,\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // right split\r\n    if (overlap.x + overlap.width > rec.x + rec.width) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: rec.x + rec.width,\r\n          y: overlap.y,\r\n          width: overlap.x + overlap.width - (rec.x + rec.width),\r\n          height: overlap.height,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // top split\r\n    if (overlap.y < rec.y) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: overlap.y,\r\n          width: overlap.width,\r\n          height: rec.y - overlap.y,\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n\r\n    // bottom split\r\n    if (overlap.y + overlap.height > rec.y + rec.height) {\r\n      _addAndMergeFreeRectangle(\r\n        freeRectangles,\r\n        {\r\n          x: overlap.x,\r\n          y: rec.y + rec.height,\r\n          width: overlap.width,\r\n          height: overlap.y + overlap.height - (rec.y + rec.height),\r\n        },\r\n        ctrl\r\n      );\r\n    }\r\n  }\r\n\r\n  return [rec.x, rec.y];\r\n}\r\n\r\n/**\r\n * Checks if rectangle rec2 can fit within rectangle rec1\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _canFit(rec1, rec2) {\r\n  return rec2.width <= rec1.width && rec2.height <= rec1.height;\r\n}\r\n\r\n/**\r\n * Checks whether rectangle rec1 and rectangle rec2 intersect\r\n * @param {*} rec1\r\n * @param {*} rec2\r\n * @returns\r\n */\r\nfunction _intersectRec(rec1, rec2) {\r\n  if (rec1.x < rec2.x + rec2.width && rec2.x < rec1.x + rec1.width && rec1.y < rec2.y + rec2.height)\r\n    return rec2.y < rec1.y + rec1.height;\r\n  else return false;\r\n}\r\n\r\n/**\r\n * Check if rectangle rec1 fully contains rectangle rec2\r\n * @param {*} rec1\r\n * @param {*} rec\r\n * @returns\r\n */\r\nfunction _fullyContains(rec1, rec2) {\r\n  return (\r\n    rec1.x <= rec2.x &&\r\n    rec1.x + rec1.width >= rec2.x + rec2.width &&\r\n    rec1.y <= rec2.y &&\r\n    rec1.y + rec1.height >= rec2.y + rec2.height\r\n  );\r\n}\r\n\r\n/**\r\n *\r\n * @param {*} freeRectangles\r\n * @param {*} rec\r\n * @param {*} ctrl\r\n * @returns\r\n */\r\nfunction _addAndMergeFreeRectangle(freeRectangles, rec, ctrl) {\r\n  const keys = Object.keys(freeRectangles);\r\n  for (const key of keys) {\r\n    if (_fullyContains(freeRectangles[key], rec)) {\r\n      return;\r\n    }\r\n  }\r\n  ctrl.freeId++;\r\n  freeRectangles[ctrl.freeId] = rec;\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { editPreviewPlaceables, Picker } from '../picker.js';\r\nimport { libWrapper } from '../shim/shim.js';\r\nimport { enablePixelPerfectSelect } from '../tools/selectTool.js';\r\nimport { loadImageVideoDimensions } from '../utils.js';\r\nimport ScenescapeConfig from './configuration.js';\r\nimport { Scenescape } from './scenescape.js';\r\n\r\n/**\r\n * Class to manage registering and un-registering of wrapper functions to change\r\n * token and tile control behavior on Scenescapes\r\n */\r\nexport class ScenescapeControls {\r\n  static _wrapperIds = [];\r\n  static _hooks = [];\r\n\r\n  static registerMainHooks() {\r\n    Hooks.on('updateScene', (scene) => {\r\n      if (scene.id === canvas.scene?.id) {\r\n        Scenescape.loadFlags();\r\n        this._checkActivateControls();\r\n      }\r\n    });\r\n\r\n    Hooks.on('canvasInit', (canvas) => {\r\n      Scenescape.loadFlags();\r\n      this._checkActivateControls();\r\n      ScenescapeConfig.close();\r\n    });\r\n  }\r\n\r\n  static _checkActivateControls() {\r\n    if (Scenescape.active) {\r\n      ScenescapeControls._register();\r\n      this.displayBlackBars(Scenescape.blackBars);\r\n      enablePixelPerfectSelect(Scenescape.pixelPerfect);\r\n    } else {\r\n      ScenescapeControls._unregister();\r\n      this.displayBlackBars(false);\r\n      enablePixelPerfectSelect();\r\n    }\r\n  }\r\n\r\n  static _register() {\r\n    this._registerLibWrappers();\r\n    this._registerHooks();\r\n  }\r\n\r\n  static _unregister() {\r\n    this._wrapperIds.forEach((id) => {\r\n      libWrapper.unregister(MODULE_ID, id);\r\n    });\r\n    this._hooks.forEach((h) => {\r\n      Hooks.off(h.hook, h.id);\r\n    });\r\n    this._wrapperIds = [];\r\n    this._hooks = [];\r\n  }\r\n\r\n  static _registerHooks() {\r\n    if (this._hooks.length) return;\r\n\r\n    let id;\r\n\r\n    id = Hooks.on('preCreateToken', async (token, data, options, userId) => {\r\n      if (!options.spawnPreset && token.actor?.img) token.updateSource({ 'texture.src': token.actor.img });\r\n    });\r\n    this._hooks.push({ hook: 'preCreateToken', id });\r\n\r\n    // On token texture update we want to keep the token height and position the same while\r\n    // adopting the new aspect ratio\r\n    id = Hooks.on('updateToken', async (token, change, options, userId) => {\r\n      if (game.user.id === userId && foundry.utils.getProperty(change, 'texture.src') && token.object) {\r\n        let { width, height } = token.object.getSize();\r\n        let textureDimensions = await loadImageVideoDimensions(change.texture.src);\r\n\r\n        let updatedWidth = textureDimensions.width * (height / textureDimensions.height);\r\n\r\n        token.update(\r\n          {\r\n            width: updatedWidth / canvas.scene.grid.sizeX,\r\n            [`flags.${MODULE_ID}.width`]: updatedWidth / canvas.scene.grid.sizeX,\r\n            x: token.x + (width - updatedWidth) / 2,\r\n          },\r\n          { animate: false }\r\n        );\r\n      }\r\n    });\r\n    this._hooks.push({ hook: 'updateToken', id });\r\n\r\n    id = Hooks.on('createToken', async (token, options, userId) => {\r\n      if (game.user.id !== userId || options.spawnPreset) return;\r\n\r\n      let { width, height } = await loadImageVideoDimensions(token.texture.src);\r\n      if (width && height) {\r\n        const bottom = {\r\n          x: token.x + (token.width * canvas.dimensions.size) / 2,\r\n          y: token.y + token.height * canvas.dimensions.size,\r\n        };\r\n\r\n        const { scale, elevation } = Scenescape.getParallaxParameters(bottom);\r\n\r\n        const size = Scenescape._getActorSize(token.actor, token);\r\n        const actorDefinedSize = (size / 6) * 100;\r\n        const r = actorDefinedSize / height;\r\n\r\n        width *= scale * r;\r\n        height *= scale * r;\r\n\r\n        const x = bottom.x - width / 2;\r\n        const y = bottom.y - height;\r\n\r\n        width /= canvas.dimensions.size;\r\n        height /= canvas.dimensions.size;\r\n\r\n        token.update({ x, y, width, height, elevation, flags: { [MODULE_ID]: { width, height, size } } });\r\n      }\r\n    });\r\n    this._hooks.push({ hook: 'createToken', id });\r\n  }\r\n\r\n  static _registerLibWrappers() {\r\n    if (this._wrapperIds.length) return;\r\n\r\n    let id;\r\n\r\n    // Hide token elevation tooltip\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'Token.prototype._getTooltipText',\r\n      function (wrapped, ...args) {\r\n        wrapped(...args);\r\n        return '';\r\n      },\r\n      'WRAPPER'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    // Only show token border when it is controlled\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'Token.prototype._refreshState',\r\n      function (wrapped, ...args) {\r\n        const result = wrapped(...args);\r\n        this.border.visible = !this.document.isSecret && this.controlled;\r\n        return result;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    // Hide AmbientLight warning on drag\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'AmbientLight.prototype._canDragLeftStart',\r\n      function (wrapped, ...args) {\r\n        if (this.layer?.preview?.children.length) return false;\r\n        return wrapped(...args);\r\n      },\r\n      'MIXED'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    id = libWrapper.register(MODULE_ID, 'TokenLayer.prototype.moveMany', this._moveMany, 'OVERRIDE');\r\n    this._wrapperIds.push(id);\r\n\r\n    id = libWrapper.register(MODULE_ID, 'TilesLayer.prototype.moveMany', this._moveMany, 'OVERRIDE');\r\n    this._wrapperIds.push(id);\r\n\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'Token.prototype.getSize',\r\n      function (...args) {\r\n        let { width, height } = ScenescapeControls._getTokenDimensions(this.document);\r\n\r\n        const grid = this.scene.grid;\r\n        width *= grid.sizeX;\r\n        height *= grid.sizeY;\r\n        return { width, height };\r\n      },\r\n      'OVERRIDE'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'Token.prototype._onUpdate',\r\n      function (wrapped, changed, options, userId) {\r\n        if (\r\n          foundry.utils.getProperty(changed, `flags.${MODULE_ID}.width`) != null ||\r\n          foundry.utils.getProperty(changed, `flags.${MODULE_ID}.height`) != null\r\n        ) {\r\n          this.renderFlags.set({ refreshSize: true });\r\n        }\r\n        return wrapped(changed, options, userId);\r\n      },\r\n      'WRAPPER'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    /**\r\n     * Activate Picker preview instead of regular drag/drop flow\r\n     */\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'PlaceableObject.prototype._onDragLeftStart',\r\n      function (event) {\r\n        let objects = this.layer.options.controllableObjects ? this.layer.controlled : [this];\r\n\r\n        objects = objects.filter((o) => o._canDrag(game.user, event) && !o.document.locked);\r\n\r\n        if (objects.length) {\r\n          const draggedObject = objects[0];\r\n          draggedObject._meDragging = true;\r\n          editPreviewPlaceables([draggedObject], true, () => {\r\n            draggedObject._meDragging = undefined;\r\n            draggedObject.renderFlags.set({ refreshState: true });\r\n          });\r\n        }\r\n\r\n        event.interactionData.clones = [];\r\n        return false;\r\n      },\r\n      'OVERRIDE'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'PlaceableObject.prototype._canDragLeftStart',\r\n      function (wrapped, user, event) {\r\n        if (Picker.isActive() || !this._canDrag(game.user, event)) return false;\r\n\r\n        return wrapped(user, event);\r\n      },\r\n      'MIXED'\r\n    );\r\n    this._wrapperIds.push(id);\r\n\r\n    id = libWrapper.register(\r\n      MODULE_ID,\r\n      'PlaceableObject.prototype._getTargetAlpha',\r\n      function (wrapped) {\r\n        if (this._meDragging) return 0.4;\r\n        return wrapped();\r\n      },\r\n      'MIXED'\r\n    );\r\n    this._wrapperIds.push(id);\r\n  }\r\n\r\n  static _getTokenDimensions(token) {\r\n    let { width, height } = token;\r\n\r\n    if (token.flags?.[MODULE_ID]?.width != null) width = token.flags[MODULE_ID].width;\r\n    if (token.flags?.[MODULE_ID]?.height != null) height = token.flags[MODULE_ID].height;\r\n\r\n    return { width, height };\r\n  }\r\n\r\n  static async _moveMany({ dx = 0, dy = 0, rotate = false, ids, includeLocked = false } = {}) {\r\n    if (dx === 0 && dy === 0) return [];\r\n\r\n    const objects = this._getMovableObjects(ids, includeLocked);\r\n    if (!objects.length) return objects;\r\n\r\n    // Conceal any active HUD\r\n    this.hud?.clear();\r\n\r\n    const documentName = this.constructor.documentName;\r\n    const incrementScale = game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT) ? 0.5 : 1.0;\r\n\r\n    const updateData = objects.map((obj) => {\r\n      let update = { _id: obj.id };\r\n\r\n      const size = documentName === 'Token' ? obj.getSize() : obj.document;\r\n      const bottom = { x: obj.document.x + size.width / 2, y: obj.document.y + size.height };\r\n      const params = Scenescape.getParallaxParameters(bottom);\r\n      const dimensions = canvas.dimensions;\r\n\r\n      const nBottom = Scenescape.moveCoordinate(\r\n        bottom,\r\n        dx * incrementScale,\r\n        dy * incrementScale,\r\n        documentName === 'Tile'\r\n      );\r\n      const nParams = Scenescape.getParallaxParameters(nBottom);\r\n\r\n      if (documentName === 'Token') {\r\n        const fixedSize = Scenescape.getTokenSize(obj);\r\n\r\n        update.height = (fixedSize * nParams.scale) / dimensions.size;\r\n        update.width = (update.height / size.height) * size.width;\r\n\r\n        update.flags = {\r\n          [MODULE_ID]: {\r\n            width: update.width,\r\n            height: update.height,\r\n          },\r\n        };\r\n\r\n        update.x = nBottom.x - (update.width * dimensions.size) / 2;\r\n        update.y = nBottom.y - update.height * dimensions.size;\r\n\r\n        // Prevent foundry validation errors\r\n        // We attempt to keep TokenDocument and the width/height flag as close as possible where we can\r\n        // but we have to diverge at this threshold\r\n        if (update.width < 0.5 || update.height < 0.5) {\r\n          update.width = 0.5;\r\n          update.height = 0.5;\r\n        }\r\n      } else {\r\n        const deltaScale = nParams.scale / params.scale;\r\n\r\n        update.width = size.width * deltaScale;\r\n        update.height = size.height * deltaScale;\r\n\r\n        update.x = nBottom.x - update.width / 2;\r\n        update.y = nBottom.y - update.height;\r\n      }\r\n\r\n      update.elevation = nParams.elevation;\r\n\r\n      return update;\r\n    });\r\n\r\n    await canvas.scene.updateEmbeddedDocuments(documentName, updateData, { teleport: true });\r\n    return objects;\r\n  }\r\n\r\n  static displayBlackBars(display) {\r\n    let bars = canvas.primary.getChildByName('scenescapeBlackBars');\r\n    if (!display && bars) {\r\n      canvas.primary.removeChild(bars)?.destroy(true);\r\n    } else if (display) {\r\n      if (bars) canvas.primary.removeChild(bars)?.destroy(true);\r\n\r\n      bars = new PIXI.Container();\r\n      bars.name = 'scenescapeBlackBars';\r\n      bars.sortLayer = PrimaryCanvasGroup.SORT_LAYERS.DRAWINGS;\r\n      bars.elevation = 99999999;\r\n      bars.restrictsLight = true;\r\n\r\n      const graphics = new PIXI.Graphics();\r\n      bars.addChild(graphics);\r\n\r\n      const dimensions = canvas.scene.dimensions;\r\n\r\n      graphics.beginFill(0x000000);\r\n      graphics.drawRect(0, 0, dimensions.width, dimensions.height);\r\n      graphics.endFill();\r\n\r\n      graphics.beginHole();\r\n      graphics.drawRect(dimensions.sceneX, dimensions.sceneY, dimensions.sceneWidth, dimensions.sceneHeight);\r\n      graphics.endHole();\r\n\r\n      canvas.primary.addChild(bars);\r\n    }\r\n  }\r\n}\r\n","import { MODULE_ID, PIVOTS } from '../constants.js';\r\nimport { Preset } from '../presets/preset.js';\r\nimport { Spawner } from '../presets/spawner.js';\r\nimport { ScenescapeControls } from './controls.js';\r\nimport { Scenescape } from './scenescape.js';\r\n\r\nconst TEMPLATES = [\r\n  { height: 3, src: `modules/${MODULE_ID}/images/3ft.webp` },\r\n  { height: 6, src: `modules/${MODULE_ID}/images/6ft.webp` },\r\n  { height: 30, src: `modules/${MODULE_ID}/images/30ft.webp` },\r\n  { height: 100, src: `modules/${MODULE_ID}/images/100ft.webp` },\r\n];\r\n\r\nexport default class ScenescapeConfig extends FormApplication {\r\n  static close() {\r\n    Object.values(ui.windows)\r\n      .find((w) => w instanceof ScenescapeConfig)\r\n      ?.close();\r\n  }\r\n\r\n  constructor() {\r\n    super({}, { left: 60 });\r\n    this.scene = canvas.scene;\r\n    this.flags = this.scene.getFlag(MODULE_ID, 'scenescape') ?? {};\r\n    this.dataUpdate = {};\r\n    this._createReferenceMarkers();\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      id: 'mass-edit-scenescape',\r\n      classes: ['sheet', 'mass-edit-dark-window'],\r\n      template: `modules/${MODULE_ID}/templates/scenescape.html`,\r\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.content', initial: 'scale' }],\r\n      resizable: false,\r\n      minimizable: false,\r\n      width: 300,\r\n      height: 'auto',\r\n    });\r\n  }\r\n\r\n  get title() {\r\n    return 'Scenescape: ' + this.scene.name;\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    buttons.unshift({\r\n      label: 'Revert',\r\n      class: 'mass-edit-scenescape-delete',\r\n      icon: 'fas fa-trash fa-fw',\r\n      onclick: () => {\r\n        this.scene.unsetFlag(MODULE_ID, 'scenescape');\r\n        this.close();\r\n        ScenescapeControls._checkActivateControls();\r\n      },\r\n    });\r\n\r\n    return buttons;\r\n  }\r\n\r\n  async getData(options) {\r\n    const data = super.getData(options);\r\n    data.markerTemplates = TEMPLATES;\r\n    data.scaleDistance = this.flags.scaleDistance ?? 32;\r\n    data.speed = this.flags.speed ?? 4.3;\r\n    data.speedY = this.flags.speedY ?? 8.6;\r\n    data.blackBars = this.flags.blackBars;\r\n    data.pixelPerfect = this.flags.pixelPerfect ?? true;\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {JQuery} html\r\n   */\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.on('click', '.marker > img', this._onClickMarker.bind(this));\r\n    html.on('click', '.select-limit-lower', () => this._onSelectLimit('y2'));\r\n    html.on('click', '.select-limit-upper', () => this._onSelectLimit('y1'));\r\n    html.on('click', '.auto-select-limits', this._onAutoSelectLimits.bind(this));\r\n    html.on('click', '.clear-limits', this._onClearLimits.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Set movement limits to lowest and highest reference markers\r\n   * @returns\r\n   */\r\n  _onAutoSelectLimits() {\r\n    const ys = this.scene.tiles\r\n      .filter((d) => d.getFlag(MODULE_ID, 'scenescape')?.marker)\r\n      .map((d) => d.y + d.height)\r\n      .sort((y1, y2) => y1 - y2);\r\n    if (!ys.length) return this._onClearLimits();\r\n\r\n    foundry.utils.mergeObject(this.flags, {\r\n      movementLimits: {\r\n        y1: ys[0],\r\n        y2: ys[ys.length - 1],\r\n      },\r\n    });\r\n\r\n    ui.notifications.info(`Limits set to: {${ys[0]}, ${ys[ys.length - 1]}}`);\r\n  }\r\n\r\n  async _onLockInScale() {\r\n    const { markers, foregroundElevation } = Scenescape.processReferenceMarkers(this.scene);\r\n    if (markers) {\r\n      const update = { [`flags.${MODULE_ID}.scenescape.markers`]: markers, foregroundElevation };\r\n\r\n      // Disable settings which interfere with Scenescapes\r\n      update['grid.type'] = CONST.GRID_TYPES.GRIDLESS;\r\n      update['fog.exploration'] = false;\r\n      update.tokenVision = false;\r\n      update['flags.levels.lightMasking'] = true;\r\n      update['flags.wall-height.advancedVision'] = false;\r\n\r\n      await this.scene.update(update);\r\n    } else {\r\n      await this.scene.update({ [`flags.${MODULE_ID}.scenescape.-=markers`]: null });\r\n    }\r\n  }\r\n\r\n  _onSelectLimit(varName) {\r\n    this._onMinimize();\r\n    LineSelector.select((pos) => {\r\n      if (pos) {\r\n        const limits = this.flags.movementLimits ?? {};\r\n        limits[varName] = pos.y;\r\n\r\n        if (limits.y1 != null && limits.y2 != null) {\r\n          let y1 = Math.min(limits.y1, limits.y2);\r\n          limits.y2 = Math.max(limits.y1, limits.y2);\r\n          limits.y1 = y1;\r\n        }\r\n\r\n        foundry.utils.mergeObject(this.flags, { movementLimits: limits });\r\n      }\r\n      this._onMaximize();\r\n    }, Object.values(this.flags.movementLimits ?? {}));\r\n  }\r\n\r\n  _onClearLimits() {\r\n    delete this.flags.movementLimits;\r\n  }\r\n\r\n  async _onClickMarker(event) {\r\n    this._onMinimize();\r\n\r\n    const height = Number($(event.target).closest('.marker').data('height'));\r\n    const preset = new Preset({\r\n      documentName: 'Tile',\r\n      data: [\r\n        {\r\n          texture: { src: TEMPLATES.find((t) => t.height === height).src },\r\n          width: 100 * (height / 6),\r\n          height: 100 * (height / 6),\r\n          flags: {\r\n            [MODULE_ID]: {\r\n              scenescape: {\r\n                marker: true,\r\n                size: height,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      ],\r\n      tags: [`${height}ft`],\r\n    });\r\n\r\n    await Spawner.spawnPreset({\r\n      preset,\r\n      preview: true,\r\n      pivot: PIVOTS.BOTTOM,\r\n      snapToGrid: false,\r\n      scaleToGrid: true,\r\n      layerSwitch: true,\r\n    });\r\n    this._onMaximize();\r\n  }\r\n\r\n  _deleteReferenceMarkers() {\r\n    const ids = this.scene.tiles.filter((d) => d.getFlag(MODULE_ID, 'scenescape')?.marker).map((d) => d.id);\r\n    if (ids.length) this.scene.deleteEmbeddedDocuments('Tile', ids);\r\n  }\r\n\r\n  _createReferenceMarkers() {\r\n    if (this.scene.tiles.find((d) => d.getFlag(MODULE_ID, 'scenescape')?.marker)) return;\r\n\r\n    const markers = this.flags.markers?.filter((m) => !m.virtual);\r\n    if (!markers?.length) return;\r\n\r\n    for (const m of markers) {\r\n      const preset = new Preset({\r\n        documentName: 'Tile',\r\n        data: [\r\n          {\r\n            texture: { src: TEMPLATES.find((t) => t.height === m.size).src },\r\n            width: m.height,\r\n            height: m.height,\r\n            elevation: this.scene.foregroundElevation,\r\n            flags: {\r\n              [MODULE_ID]: {\r\n                scenescape: {\r\n                  marker: true,\r\n                  size: m.size,\r\n                },\r\n              },\r\n            },\r\n          },\r\n        ],\r\n        tags: [`${m.size}ft`],\r\n      });\r\n      Spawner.spawnPreset({ preset, x: m.x, y: m.y, preview: false, pivot: PIVOTS.BOTTOM, scaleToGrid: false });\r\n    }\r\n  }\r\n\r\n  _onMinimize() {\r\n    this.minimize();\r\n    Object.values(ui.windows)\r\n      .find((w) => w.object?.id === this.scene.id)\r\n      ?.minimize();\r\n  }\r\n\r\n  _onMaximize() {\r\n    this.maximize();\r\n    Object.values(ui.windows)\r\n      .find((w) => w.object?.id === this.scene.id)\r\n      ?.maximize();\r\n  }\r\n\r\n  /**\r\n   * @param {Event} event\r\n   * @param {Object} formData\r\n   */\r\n  async _updateObject(event, formData) {\r\n    let update = {};\r\n\r\n    foundry.utils.mergeObject(this.flags, formData);\r\n\r\n    ['movementLimits', 'speed', 'speedY', 'scaleDistance', 'blackBars', 'pixelPerfect'].forEach((varName) => {\r\n      if (foundry.utils.isEmpty(this.flags[varName])) update[`flags.${MODULE_ID}.scenescape.-=${varName}`] = null;\r\n      else update[`flags.${MODULE_ID}.scenescape.${varName}`] = this.flags[varName];\r\n    });\r\n\r\n    if (!foundry.utils.isEmpty(this.dataUpdate)) {\r\n      foundry.utils.mergeObject(update, this.dataUpdate);\r\n    }\r\n\r\n    if (!foundry.utils.isEmpty(update)) await this.scene.update(update);\r\n    await this._onLockInScale(this.scene);\r\n  }\r\n\r\n  async close(options = {}) {\r\n    this._deleteReferenceMarkers();\r\n    return super.close(options);\r\n  }\r\n}\r\n\r\nclass LineSelector {\r\n  static select(callback, lines = []) {\r\n    if (this.overlay) return;\r\n\r\n    this.callback = callback;\r\n    this.lines = lines;\r\n\r\n    let overlay = new PIXI.Container();\r\n    overlay.hitArea = canvas.dimensions.rect;\r\n    overlay.cursor = 'crosshair';\r\n    overlay.interactive = true;\r\n    overlay.zIndex = 5;\r\n\r\n    this.graphics = new PIXI.Graphics();\r\n    overlay.addChild(this.graphics);\r\n\r\n    overlay.on('mouseup', (event) => {\r\n      if (event.nativeEvent.which == 1) this._save(this.pos);\r\n      this._exit();\r\n    });\r\n    overlay.on('contextmenu', () => {\r\n      this._exit();\r\n    });\r\n\r\n    overlay.on('pointermove', (event) => {\r\n      const pos = event.data.getLocalPosition(overlay);\r\n      const dimensions = canvas.dimensions;\r\n      pos.y = Math.clamp(pos.y, 0, dimensions.height);\r\n      this._drawLine(pos);\r\n      this.pos = pos;\r\n    });\r\n\r\n    canvas.stage.addChild(overlay);\r\n\r\n    this.overlay = overlay;\r\n  }\r\n\r\n  static _drawLine(pos) {\r\n    const graphics = this.overlay.children[0];\r\n    graphics.clear();\r\n    graphics.lineStyle(3, 0xff0000, 1.0, 0.5).moveTo(0, pos.y).lineTo(canvas.dimensions.rect.width, pos.y);\r\n\r\n    this.lines.forEach((l) => {\r\n      graphics.lineStyle(3, 0x0000ff, 1.0, 0.5).moveTo(0, l).lineTo(canvas.dimensions.rect.width, l);\r\n    });\r\n  }\r\n\r\n  static _save(pos) {\r\n    this.callback?.(pos);\r\n    this.callback = null;\r\n  }\r\n\r\n  static _exit() {\r\n    const overlay = this.overlay;\r\n    if (overlay) {\r\n      overlay.parent?.removeChild(overlay);\r\n      overlay.destroy(true);\r\n      overlay.children?.forEach((c) => c.destroy(true));\r\n      this.overlay = null;\r\n      this.callback?.(null);\r\n    }\r\n  }\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport ScenescapeConfig from './configuration.js';\r\nimport { ScenescapeControls } from './controls.js';\r\n\r\nexport function registerScenescapeHooks() {\r\n  Hooks.on('renderSceneConfig', (app, html, options) => {\r\n    const element = $(`\r\n    <div class=\"form-group\">\r\n        <label>Scenescape</label>\r\n        <div class=\"form-fields\">\r\n            <button  class=\"configureScenescape\" type=\"button\" data-tooltip=\"Configure Scenescape\">\r\n              <i class=\"fa-regular fa-mountain-sun\"></i>\r\n            </button>\r\n        </div>\r\n        <p class=\"notes\">Configure this scene as a 'Scenescape' allowing dynamic scaling and positioning of assets on a landscape background.</p>\r\n    </div>\r\n            `);\r\n    element.on('click', '.configureScenescape', () => new ScenescapeConfig().render(true));\r\n    html.find('.initial-position').after(element);\r\n    app.setPosition({ height: 'auto' });\r\n  });\r\n\r\n  ScenescapeControls.registerMainHooks();\r\n}\r\n\r\nexport class Scenescape {\r\n  static get active() {\r\n    return this._active;\r\n  }\r\n\r\n  static get distanceRatio() {\r\n    return this._distanceRatio;\r\n  }\r\n\r\n  static get stepDistanceX() {\r\n    return this._stepDistanceX;\r\n  }\r\n\r\n  static get stepDistanceY() {\r\n    return this._stepDistanceY;\r\n  }\r\n\r\n  static get movementLimits() {\r\n    return this._movementLimits;\r\n  }\r\n\r\n  static get depth() {\r\n    if (this._markers?.length) {\r\n      return this._markers[this._markers.length - 1].elevation;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  static loadFlags() {\r\n    const flags = canvas.scene.getFlag(MODULE_ID, 'scenescape');\r\n    this._active = Boolean(flags?.markers?.length);\r\n\r\n    if (flags) {\r\n      this._distanceRatio = (flags.scaleDistance ?? 32) / 2;\r\n      this._stepDistanceX = flags.speed ?? 4.3;\r\n      this._stepDistanceY = flags.speedY ?? 8.6;\r\n      this._movementLimits = flags.movementLimits;\r\n      this._markers = flags.markers;\r\n      this.blackBars = Boolean(flags.blackBars);\r\n      this.pixelPerfect = Boolean(flags.pixelPerfect ?? true);\r\n    }\r\n  }\r\n\r\n  static getParallaxParameters(pos) {\r\n    const markers = canvas.scene.getFlag(MODULE_ID, 'scenescape')?.markers;\r\n    if (!markers) return { scale: 1, elevation: 0 };\r\n\r\n    const y = Math.clamp(pos.y, 0, canvas.dimensions.height);\r\n    const { m1, m2 } = this._getBoundingMarkers(y, 'y');\r\n\r\n    if (m1 == m2) return { scale: m1.height / m1.realHeight, elevation: m1.elevation };\r\n\r\n    // Percentage wise where is pos between the markers\r\n    const r = (y - m1.y) / (m2.y - m1.y);\r\n\r\n    // Assume linear change in scale between the markers\r\n    let scale1 = m1.height / m1.realHeight;\r\n    let scale2 = m2.height / m2.realHeight;\r\n    let scale = (scale2 - scale1) * r + scale1;\r\n\r\n    let elevation = (m2.elevation - m1.elevation) * r + m1.elevation;\r\n\r\n    return { scale, elevation };\r\n  }\r\n\r\n  /**\r\n   * Retrieves markers that bound the provided value with param as the value's name\r\n   * @param {number} val y coordinate or elevation\r\n   * @param {String} param 'y' | 'elevation'\r\n   * @param {object} markers\r\n   * @returns\r\n   */\r\n  static _getBoundingMarkers(val, param) {\r\n    if (!this._markers) return {};\r\n\r\n    // Find the 2 markers pos is between\r\n    let i = this._markers.length - 1;\r\n    while (this._markers[i][param] > val) i--;\r\n    let m1 = this._markers[i];\r\n\r\n    i = 0;\r\n    while (this._markers[i][param] < val) i++;\r\n    let m2 = this._markers[i];\r\n\r\n    return { m1, m2 };\r\n  }\r\n\r\n  static moveCoordinate(pos, dx, dy, ignoreLimits = false) {\r\n    if (dx === 0 && dy === 0) return pos;\r\n\r\n    let nX = pos.x;\r\n    let nY = pos.y;\r\n\r\n    let { scale, elevation } = this.getParallaxParameters(pos);\r\n\r\n    if (dx !== 0) {\r\n      dx = this.stepDistanceX * dx;\r\n      nX += (100 / 6) * scale * dx;\r\n      nX = Math.clamp(nX, 0, canvas.dimensions.width);\r\n    }\r\n\r\n    if (dy !== 0) {\r\n      dy = this.stepDistanceY * dy;\r\n      const markers = this._markers;\r\n\r\n      let nElevation = Math.clamp(elevation + dy, 0, markers[markers.length - 1].elevation);\r\n      let { m1, m2 } = this._getBoundingMarkers(nElevation, 'elevation', markers);\r\n\r\n      if (m1 == m2) {\r\n        nY = m1.y;\r\n      } else {\r\n        // Percentage wise where is new elevation between the markers\r\n        const r = (nElevation - m1.elevation) / (m2.elevation - m1.elevation);\r\n\r\n        nY = (m2.y - m1.y) * r + m1.y;\r\n      }\r\n    }\r\n\r\n    // Enforce movement limits\r\n    if (this.movementLimits && !ignoreLimits) {\r\n      if (this.movementLimits.y1 != null) nY = Math.max(nY, this.movementLimits.y1);\r\n      if (this.movementLimits.y2 != null) nY = Math.min(nY, this.movementLimits.y2);\r\n    }\r\n\r\n    return { x: nX, y: nY };\r\n  }\r\n\r\n  static processReferenceMarkers(scene) {\r\n    this.loadFlags();\r\n    // Retrieve marker tiles from the scene and sort them on the y-axis\r\n    const markers = scene.tiles\r\n      .filter((d) => d.getFlag(MODULE_ID, 'scenescape')?.marker)\r\n      .map((d) => {\r\n        const size = d.getFlag(MODULE_ID, 'scenescape').size;\r\n        return {\r\n          x: d.x + d.width / 2,\r\n          y: d.y + d.height,\r\n          size,\r\n          height: d.height,\r\n          realHeight: 100 * (size / 6),\r\n        };\r\n      })\r\n      .sort((m1, m2) => m1.y - m2.y)\r\n      .filter((m, pos, arr) => {\r\n        return !pos || m.y !== arr[pos - 1].y;\r\n      });\r\n\r\n    // To simplify processing later, lets insert markers at y=0 and y=scene height\r\n    if (markers.length) {\r\n      if (markers[0].y > 0) {\r\n        markers.unshift({ ...markers[0], y: 0, virtual: true });\r\n      }\r\n      if (markers[markers.length - 1].y < canvas.dimensions.height) {\r\n        markers.push({ ...markers[markers.length - 1], y: canvas.dimensions.height, virtual: true });\r\n      }\r\n    }\r\n\r\n    // Calculate and assign elevation to each marker\r\n    if (markers.length) {\r\n      let elevation = 0;\r\n      markers[0].elevation = 0;\r\n      for (let i = 1; i < markers.length; i++) {\r\n        let m1 = markers[i - 1];\r\n        let m2 = markers[i];\r\n\r\n        let scale1 = m1.height / m1.realHeight;\r\n        let scale2 = m2.height / m2.realHeight;\r\n\r\n        let distance;\r\n        if (scale1 < scale2) {\r\n          distance = Scenescape.distanceRatio * (scale2 / scale1);\r\n        } else if (scale1 > scale2) {\r\n          distance = Scenescape.distanceRatio * (scale1 / scale2);\r\n        } else {\r\n          distance = ((m2.y - m1.y) / scale1) * (6 / 100); // TODO test\r\n        }\r\n\r\n        elevation += distance;\r\n\r\n        markers[i].elevation = elevation;\r\n      }\r\n    }\r\n\r\n    if (markers.length) {\r\n      let lastM = markers[markers.length - 1];\r\n\r\n      return {\r\n        markers,\r\n        foregroundElevation:\r\n          Math.round(lastM.elevation + (lastM.size / lastM.height) * (canvas.dimensions.height - lastM.y)) + 1,\r\n      };\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Determines actor size in feet\r\n   * @param {Actor} actor\r\n   * @returns {Number} feet\r\n   */\r\n  static _getActorSize(actor, token) {\r\n    if (!actor) return token.height * 6;\r\n\r\n    // Retrieves numbers from a string assuming the first number represents feet and the 2nd inches\r\n    // The total is returned in feet\r\n    // e.g. \"6 feet 6 inches\" => 6.5\r\n    // e.g. 4'3'' => 4.25\r\n    const parseHeightString = function (heightString) {\r\n      const matches = heightString.match(/[\\d|,|.|\\+]+/g);\r\n      if (matches?.length) {\r\n        let feet = Number(matches[0]);\r\n        let inches = matches.length > 1 ? Number(matches[1]) : 0;\r\n        feet += inches / 12;\r\n        return feet;\r\n      }\r\n      return null;\r\n    };\r\n\r\n    if (game.system.id === 'dnd5e') {\r\n      const height = parseHeightString(actor.system.details?.height ?? '');\r\n      if (height) return height;\r\n    }\r\n\r\n    return actor.prototypeToken.height * 6;\r\n  }\r\n\r\n  static getTokenSize(token) {\r\n    token = token.document ?? token;\r\n\r\n    let size =\r\n      foundry.utils.getProperty(token, `flags.${MODULE_ID}.size`) ?? Scenescape._getActorSize(token.actor, token);\r\n    return (size / 6) * 100;\r\n  }\r\n}\r\n","// SPDX-License-Identifier: MIT\r\n// Copyright  2021 fvtt-lib-wrapper Rui Pinheiro\r\n\r\n'use strict';\r\n\r\n// A shim for the libWrapper library\r\nexport let libWrapper = undefined;\r\n\r\nexport const VERSIONS = [1, 12, 2];\r\nexport const TGT_SPLIT_RE = new RegExp(\r\n  '([^.[]+|\\\\[(\\'([^\\'\\\\\\\\]|\\\\\\\\.)+?\\'|\"([^\"\\\\\\\\]|\\\\\\\\.)+?\")\\\\])',\r\n  'g'\r\n);\r\nexport const TGT_CLEANUP_RE = new RegExp('(^\\\\[\\'|\\'\\\\]$|^\\\\[\"|\"\\\\]$)', 'g');\r\n\r\n// Main shim code\r\nHooks.once('init', () => {\r\n  // Check if the real module is already loaded - if so, use it\r\n  if (globalThis.libWrapper && !(globalThis.libWrapper.is_fallback ?? true)) {\r\n    libWrapper = globalThis.libWrapper;\r\n    return;\r\n  }\r\n\r\n  // Fallback implementation\r\n  libWrapper = class {\r\n    static get is_fallback() {\r\n      return true;\r\n    }\r\n\r\n    static get WRAPPER() {\r\n      return 'WRAPPER';\r\n    }\r\n    static get MIXED() {\r\n      return 'MIXED';\r\n    }\r\n    static get OVERRIDE() {\r\n      return 'OVERRIDE';\r\n    }\r\n\r\n    static register(package_id, target, fn, type = 'MIXED', { chain = undefined, bind = [] } = {}) {\r\n      const is_setter = target.endsWith('#set');\r\n      target = !is_setter ? target : target.slice(0, -4);\r\n      const split = target\r\n        .match(TGT_SPLIT_RE)\r\n        .map((x) => x.replace(/\\\\(.)/g, '$1').replace(TGT_CLEANUP_RE, ''));\r\n      const root_nm = split.splice(0, 1)[0];\r\n\r\n      let obj, fn_name;\r\n      if (split.length == 0) {\r\n        obj = globalThis;\r\n        fn_name = root_nm;\r\n      } else {\r\n        const _eval = eval;\r\n        fn_name = split.pop();\r\n        obj = split.reduce((x, y) => x[y], globalThis[root_nm] ?? _eval(root_nm));\r\n      }\r\n\r\n      let iObj = obj;\r\n      let descriptor = null;\r\n      while (iObj) {\r\n        descriptor = Object.getOwnPropertyDescriptor(iObj, fn_name);\r\n        if (descriptor) break;\r\n        iObj = Object.getPrototypeOf(iObj);\r\n      }\r\n      if (!descriptor || descriptor?.configurable === false)\r\n        throw new Error(\r\n          `libWrapper Shim: '${target}' does not exist, could not be found, or has a non-configurable descriptor.`\r\n        );\r\n\r\n      let original = null;\r\n      const wrapper =\r\n        chain ?? (type.toUpperCase?.() != 'OVERRIDE' && type != 3)\r\n          ? function (...args) {\r\n              return fn.call(this, original.bind(this), ...bind, ...args);\r\n            }\r\n          : function (...args) {\r\n              return fn.call(this, ...bind, ...args);\r\n            };\r\n      if (!is_setter) {\r\n        if (descriptor.value) {\r\n          original = descriptor.value;\r\n          descriptor.value = wrapper;\r\n        } else {\r\n          original = descriptor.get;\r\n          descriptor.get = wrapper;\r\n        }\r\n      } else {\r\n        if (!descriptor.set) throw new Error(`libWrapper Shim: '${target}' does not have a setter`);\r\n        original = descriptor.set;\r\n        descriptor.set = wrapper;\r\n      }\r\n\r\n      descriptor.configurable = true;\r\n      Object.defineProperty(obj, fn_name, descriptor);\r\n    }\r\n  };\r\n});\r\n","export async function applyDDTint(placeable, color) {\r\n  placeable = placeable.object ?? placeable;\r\n  color = _string2hex(color);\r\n  if (placeable instanceof PlaceableObject) {\r\n    if (isNaN(color)) {\r\n      await TokenMagic.deleteFilters(placeable, 'DDTint');\r\n    } else {\r\n      await TokenMagic.addUpdateFilters(placeable, [\r\n        {\r\n          filterType: 'ddTint',\r\n          filterId: 'DDTint',\r\n          tint: PIXI.utils.hex2rgb(color),\r\n        },\r\n      ]);\r\n    }\r\n  } else {\r\n    let filters = placeable['flags.tokenmagic.filters'];\r\n    if (isNaN(color)) {\r\n      if (filters) {\r\n        placeable['flags.tokenmagic.filters'] = filters.filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      }\r\n    } else {\r\n      filters = (filters ?? []).filter((f) => f.tmFilters.filterId !== 'DDTint');\r\n      filters.push({\r\n        tmFilters: {\r\n          tmFilterId: 'DDTint',\r\n          tmFilterInternalId: foundry.utils.randomID(),\r\n          tmFilterType: 'ddTint',\r\n          filterOwner: game.data.userId,\r\n          tmParams: {\r\n            tmFilterType: 'ddTint',\r\n            filterId: 'DDTint',\r\n            tint: PIXI.utils.hex2rgb(color),\r\n            updateId: foundry.utils.randomID(),\r\n            rank: 10000,\r\n            enabled: true,\r\n            filterOwner: game.data.userId,\r\n          },\r\n        },\r\n      });\r\n      placeable['flags.tokenmagic.filters'] = filters;\r\n    }\r\n  }\r\n}\r\n\r\nexport function getDDTint(placeable) {\r\n  let color = 0xff0000;\r\n  let obj = placeable.object ?? placeable;\r\n  if (obj._TMFXgetSprite) {\r\n    const filter = obj._TMFXgetSprite()?.filters?.find((f) => f.filterId === 'DDTint');\r\n    if (filter) color = PIXI.utils.rgb2hex(filter.uniforms.tint);\r\n  }\r\n  return _hex2string(color);\r\n}\r\n\r\nexport async function applyTMFXPreset(placeable, presetName, remove = false) {\r\n  placeable = placeable.object ?? placeable;\r\n  if (!(placeable instanceof PlaceableObject)) return;\r\n  if (presetName === 'DELETE ALL') {\r\n    await TokenMagic.deleteFilters(placeable);\r\n  } else if (remove) {\r\n    await TokenMagic.deleteFilters(placeable, presetName);\r\n  } else {\r\n    const preset = TokenMagic.getPreset(presetName);\r\n    if (preset) await TokenMagic.addUpdateFilters(placeable, foundry.utils.deepClone(preset));\r\n  }\r\n}\r\n\r\nfunction _hex2string(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toHex();\r\n  } else {\r\n    return PIXI.utils.hex2string(color);\r\n  }\r\n}\r\n\r\nfunction _string2hex(color) {\r\n  if (PIXI.Color) {\r\n    return new PIXI.Color(color).toNumber();\r\n  } else {\r\n    return PIXI.utils.string2hex(color);\r\n  }\r\n}\r\n","import { MODULE_ID, SUPPORTED_PLACEABLES, THRESHOLDS } from '../constants.js';\r\nimport { DataTransformer } from '../data/transformer.js';\r\nimport { getDataBounds } from '../presets/utils.js';\r\nimport { libWrapper } from '../shim/shim.js';\r\n\r\n/**\r\n * Register/un-register pixel perfect hover wrappers\r\n */\r\nlet pixelPerfectTileWrapper;\r\nlet pixelPerfectTokenWrapper;\r\n\r\nexport function enablePixelPerfectSelect(force = false) {\r\n  let tileWrapperChanged, tokenWrapperChanged;\r\n\r\n  // Pixel perfect hover for tiles\r\n  if (!game.settings.get(MODULE_ID, 'pixelPerfectTile') && !force) {\r\n    if (pixelPerfectTileWrapper) {\r\n      libWrapper.unregister(MODULE_ID, pixelPerfectTileWrapper);\r\n      pixelPerfectTileWrapper = undefined;\r\n      tileWrapperChanged = true;\r\n    }\r\n  } else if (!pixelPerfectTileWrapper) {\r\n    pixelPerfectTileWrapper = libWrapper.register(\r\n      MODULE_ID,\r\n      'Tile.prototype._draw',\r\n      async function (wrapped, ...args) {\r\n        const result = await wrapped(...args);\r\n\r\n        // Change the frame to use pixel contain function instead of rectangle contain\r\n        const hitArea = this.frame.interaction.hitArea;\r\n        hitArea._originalContains = hitArea.contains;\r\n        hitArea._mesh = this.mesh;\r\n        hitArea.contains = function (...args) {\r\n          let contains = this._originalContains.call(this, ...args);\r\n          if (contains && this._mesh)\r\n            return this._mesh.containsCanvasPoint(canvas.mousePosition, THRESHOLDS.PIXEL_PERFECT_ALPHA);\r\n          return contains;\r\n        };\r\n\r\n        return result;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n    tileWrapperChanged = true;\r\n  }\r\n\r\n  // Pixel perfect hover for tokens\r\n  if (!game.settings.get(MODULE_ID, 'pixelPerfectToken') && !force) {\r\n    if (pixelPerfectTokenWrapper) {\r\n      libWrapper.unregister(MODULE_ID, pixelPerfectTokenWrapper);\r\n      pixelPerfectTokenWrapper = undefined;\r\n      tokenWrapperChanged = true;\r\n    }\r\n  } else if (!pixelPerfectTokenWrapper) {\r\n    pixelPerfectTokenWrapper = libWrapper.register(\r\n      MODULE_ID,\r\n      'Token.prototype.getShape',\r\n      function (wrapped, ...args) {\r\n        const shape = wrapped(...args);\r\n\r\n        // Change the frame to use pixel contain function instead of rectangle contain\r\n        shape._originalContains = shape.contains;\r\n        shape._mesh = this.mesh;\r\n        shape.contains = function (...args) {\r\n          let contains = this._originalContains.call(this, ...args);\r\n          if (contains && this._mesh)\r\n            return this._mesh.containsCanvasPoint(canvas.mousePosition, THRESHOLDS.PIXEL_PERFECT_ALPHA);\r\n          return contains;\r\n        };\r\n\r\n        return shape;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n    tokenWrapperChanged = true;\r\n  }\r\n\r\n  if (tileWrapperChanged) canvas.tiles?.placeables.forEach((t) => t.renderFlags.set({ redraw: true }));\r\n  if (tokenWrapperChanged) canvas.tokens?.placeables.forEach((t) => t.renderFlags.set({ refreshShape: true }));\r\n}\r\n\r\n/**\r\n * Enable 'Select' tool for layers that do not have it. (AmbientLight, AmbientSound, MeasuredTemplate, and Note)\r\n */\r\nexport function enableUniversalSelectTool() {\r\n  if (game.modules.get('select-tool-everywhere')?.active) return;\r\n\r\n  const missingLayers = ['AmbientLight', 'AmbientSound', 'MeasuredTemplate', 'Note'];\r\n\r\n  missingLayers.forEach((layer) => {\r\n    Hooks.on(`refresh${layer}`, _placeableRefresh);\r\n  });\r\n\r\n  Hooks.on('canvasReady', () => {\r\n    missingLayers.forEach((layer) => (canvas.getLayerByEmbeddedName(layer).options.controllableObjects = true));\r\n    if (SUPPORTED_PLACEABLES.includes('Region')) canvas.regions.options.rotatableObjects = true;\r\n  });\r\n\r\n  Hooks.on('getSceneControlButtons', (controls) => _getControlButtons(controls));\r\n\r\n  // :: Fixes ::\r\n\r\n  // For notes the refresh hook is called while ControlIcon is still loading its texture (see ControlIcon.draw())\r\n  // Once the texture is loaded border visibility will be reset to false undoing our change in _placeableRefresh\r\n  // Instead delay and set visibility after draw to account for this\r\n  Hooks.on('drawNote', (note) => {\r\n    setTimeout(() => _placeableRefresh(note), 10);\r\n  });\r\n\r\n  // To avoid race conditions between multiple AmbientLight _onDragLeftCancel calls we'll defer the\r\n  // canvas.perception update within 'updateSource' via a 'defer' argument\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'AmbientLight.prototype._onDragLeftCancel',\r\n    function (...args) {\r\n      Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this, args);\r\n      // V12\r\n      if (this.initializeLightSource) this.initializeLightSource({ defer: true });\r\n      else this.updateSource({ defer: true });\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  if (foundry.utils.isNewerVersion(game.version, 12)) registerRegionWrappers();\r\n}\r\n\r\n/**\r\n * Insert select tools if missing\r\n */\r\nfunction _getControlButtons(controls) {\r\n  for (const control of controls) {\r\n    if (['lighting', 'sounds', 'measure'].includes(control.name)) {\r\n      if (!control.tools.find((t) => t.name === 'select')) {\r\n        control.tools.unshift({\r\n          name: 'select',\r\n          title: 'CONTROLS.CommonSelect',\r\n          icon: 'fas fa-expand',\r\n        });\r\n        control.activeTool = 'select';\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!game.settings.get(MODULE_ID, 'disablePixelPerfectHoverButton')) {\r\n    for (const control of controls) {\r\n      if (control.name === 'tiles') {\r\n        control.tools.push({\r\n          name: 'pixelPerfect',\r\n          title: 'Pixel Perfect Hover',\r\n          icon: 'fa-solid fa-bullseye-pointer',\r\n          visible: game.user.isGM,\r\n          active: game.settings.get(MODULE_ID, 'pixelPerfectTile'),\r\n          toggle: true,\r\n          onClick: () => {\r\n            game.settings.set(MODULE_ID, 'pixelPerfectTile', !game.settings.get(MODULE_ID, 'pixelPerfectTile'));\r\n          },\r\n        });\r\n      } else if (control.name === 'token') {\r\n        control.tools.push({\r\n          name: 'pixelPerfect',\r\n          title: 'Pixel Perfect Hover',\r\n          icon: 'fa-solid fa-bullseye-pointer',\r\n          visible: game.user.isGM,\r\n          active: game.settings.get(MODULE_ID, 'pixelPerfectToken'),\r\n          toggle: true,\r\n          onClick: () => {\r\n            game.settings.set(MODULE_ID, 'pixelPerfectToken', !game.settings.get(MODULE_ID, 'pixelPerfectToken'));\r\n          },\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction _placeableRefresh(placeable) {\r\n  if (placeable.controlled) placeable.controlIcon.border.visible = true;\r\n}\r\n\r\nfunction registerRegionWrappers() {\r\n  // Enable drag\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype._canDrag',\r\n    function () {\r\n      return game.user.isGM;\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype._onDragLeftMove',\r\n    function (event) {\r\n      canvas._onDragCanvasPan(event);\r\n      const { clones, destination, origin } = event.interactionData;\r\n      const { x1, y1 } = getDataBounds('Region', this.document);\r\n\r\n      // Calculate the (snapped) position of the dragged object\r\n      let position = {\r\n        x: x1 + (destination.x - origin.x),\r\n        y: y1 + (destination.y - origin.y),\r\n      };\r\n\r\n      if (!event.shiftKey) position = this.layer.getSnappedPoint(position);\r\n\r\n      const dx = position.x - x1;\r\n      const dy = position.y - y1;\r\n      for (const c of clones || []) {\r\n        DataTransformer.apply('Region', c.document.toObject(), { x: 0, y: 0 }, { x: dx, y: dy }, c);\r\n        c.visible = true;\r\n        c._onUpdate({ shapes: null });\r\n      }\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype._prepareDragLeftDropUpdates',\r\n    function (event) {\r\n      const updates = [];\r\n      for (const clone of event.interactionData.clones) {\r\n        updates.push({ _id: clone._original.id, shapes: clone.document.toObject(false).shapes });\r\n      }\r\n      return updates;\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  // Enable rotation\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Region.prototype.rotate',\r\n    async function (delta, snap) {\r\n      if (game.paused && !game.user.isGM) {\r\n        ui.notifications.warn('GAME.PausedWarning', { localize: true });\r\n        return this;\r\n      }\r\n\r\n      const data = this.document.toObject();\r\n      const { x1, y1, x2, y2 } = getDataBounds('Region', data);\r\n      const origin = {\r\n        x: x1 + (x2 - x1) / 2,\r\n        y: y1 + (y2 - y1) / 2,\r\n      };\r\n\r\n      DataTransformer.apply('Region', data, origin, { rotation: delta });\r\n      await this.document.update({ shapes: data.shapes }, { meRotation: delta });\r\n      return this;\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'RegionLayer.prototype._onMouseWheel',\r\n    function (event) {\r\n      // Identify the hovered light source\r\n      const region = this.hover;\r\n      if (!region || region.isPreview || region.document.shapes.some((s) => s.type === 'ellipse')) return;\r\n\r\n      // Determine the incremental angle of rotation from event data\r\n      const snap = event.shiftKey ? 15 : 3;\r\n      const delta = snap * Math.sign(event.delta);\r\n\r\n      region.rotate(delta, snap);\r\n    },\r\n    'OVERRIDE'\r\n  );\r\n}\r\n","import { AUDIO_EXTENSIONS, IMAGE_EXTENSIONS, MODULE_ID, SUPPORTED_PLACEABLES, VIDEO_EXTENSIONS } from './constants.js';\r\nimport { Picker } from './picker.js';\r\nimport { PresetBrowser } from './presets/browser/browserApp.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { Spawner } from './presets/spawner.js';\r\nimport { applyRandomization } from './randomizer/randomizerUtils.js';\r\n\r\nexport function interpolateColor(u, c1, c2) {\r\n  return c1.map((a, i) => Math.floor((1 - u) * a + u * c2[i]));\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to an image\r\n */\r\nexport function isImage(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return IMAGE_EXTENSIONS.includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to a video\r\n */\r\nexport function isVideo(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return VIDEO_EXTENSIONS.includes(extension);\r\n}\r\n\r\n/**\r\n * Returns true of provided path points to an audio file\r\n */\r\nexport function isAudio(path) {\r\n  var extension = path.split('.');\r\n  extension = extension[extension.length - 1].toLowerCase();\r\n  return AUDIO_EXTENSIONS.includes(extension);\r\n}\r\n\r\nexport async function recursiveTraverse(path, source, bucket, files = []) {\r\n  const result = await FilePicker.browse(source, path, {\r\n    bucket: bucket,\r\n  });\r\n\r\n  if (result) {\r\n    for (const file of result.files) {\r\n      files.push(file);\r\n    }\r\n\r\n    for (const dir of result.dirs) {\r\n      await recursiveTraverse(dir, source, bucket, files);\r\n    }\r\n  }\r\n\r\n  return files;\r\n}\r\n\r\n// To get rid of v10 warnings\r\nexport function getData(obj) {\r\n  return obj.document ? obj.document : obj;\r\n}\r\n\r\n// Flags are stored inconsistently. Absence of a flag, being set to null, undefined, empty object or empty string\r\n// should all be considered equal\r\nexport function flagCompare(data, flag, flagVal) {\r\n  if (data[flag] == flagVal) return true;\r\n\r\n  const falseyFlagVal =\r\n    flagVal == null ||\r\n    flagVal === false ||\r\n    flagVal === '' ||\r\n    (foundry.utils.getType(flagVal) === 'Object' && foundry.utils.isEmpty(flagVal));\r\n\r\n  const falseyDataVal =\r\n    data[flag] == null ||\r\n    data[flag] === false ||\r\n    data[flag] === '' ||\r\n    (foundry.utils.getType(data[flag]) === 'Object' && foundry.utils.isEmpty(data[flag]));\r\n\r\n  if (falseyFlagVal && falseyDataVal) return true;\r\n\r\n  // Special treatment for Tagger module's tags\r\n  // Instead of directly comparing string we check if it contains the string\r\n  if (flag === 'flags.tagger.tags') {\r\n    const tags = data[flag] || [];\r\n    let compTags = flagVal;\r\n    if (!Array.isArray(compTags)) {\r\n      compTags = flagVal ? flagVal.split(',').map((s) => s.trim()) : [];\r\n    }\r\n    for (const t of compTags) {\r\n      if (!tags.includes(t)) return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  if (flagVal && typeof flagVal === 'string' && flagVal.includes('*')) {\r\n    return wildcardStringMatch(flagVal, data[flag]);\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function hasFlagRemove(flag, formData) {\r\n  const comp = flag.split('.');\r\n  for (let i = comp.length - 1; i >= 1; i--) {\r\n    const tempFlag = comp.slice(0, i).join('.') + '.-=' + comp[i];\r\n    if (tempFlag in formData) {\r\n      return tempFlag;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function selectAddSubtractFields(form, fields) {\r\n  if (!fields) return;\r\n  for (const key of Object.keys(fields)) {\r\n    form\r\n      .find(`[name=\"${key}\"]`)\r\n      .removeClass('me-add')\r\n      .removeClass('me-subtract')\r\n      .addClass(fields[key].method === 'add' ? 'me-add' : 'me-subtract')\r\n      .attr(\r\n        'title',\r\n        fields[key].method === 'add' ? `+ ${localize('form.adding')}` : `- ${localize('form.subtracting')}`\r\n      );\r\n  }\r\n}\r\n\r\nexport function getCommonData(objects) {\r\n  if (!objects || !objects.length) return {};\r\n  const commonData = foundry.utils.flattenObject(objects[0]);\r\n  for (let i = 1; i < objects.length; i++) {\r\n    const diff = foundry.utils.flattenObject(\r\n      foundry.utils.diffObject(commonData, foundry.utils.flattenObject(objects[i]))\r\n    );\r\n    for (const k of Object.keys(diff)) {\r\n      // Special handling for empty/undefined data\r\n      if ((diff[k] === '' || diff[k] == null) && (commonData[k] === '' || commonData[k] == null)) {\r\n        // matches, do not remove\r\n      } else {\r\n        delete commonData[k];\r\n      }\r\n    }\r\n  }\r\n  return commonData;\r\n}\r\n\r\n/**\r\n * Merges 'other' into 'original' without expanding and duplicating the 'original' if it contains dot notation using keys\r\n */\r\nexport function mergeObjectPreserveDot(original, other = {}, nestedKey = '') {\r\n  if (!other) return;\r\n  for (const [key, val] of Object.entries(original)) {\r\n    const fullKey = nestedKey ? nestedKey + '.' + key : key;\r\n    const t = foundry.utils.getType(val);\r\n    if (t === 'Object') mergeObjectPreserveDot(val, other, fullKey);\r\n    else {\r\n      const prop = foundry.utils.getProperty(other, fullKey);\r\n      if (prop !== undefined) {\r\n        original[key] = prop;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function panToFitPlaceables(placeables) {\r\n  placeables = placeables.map((p) => p.object ?? p).filter((p) => p.center);\r\n  if (placeables.length) {\r\n    if (placeables.length === 1) {\r\n      if (placeables[0].center?.x) {\r\n        canvas.animatePan({ x: placeables[0].center.x, y: placeables[0].center.y, duration: 250 });\r\n      }\r\n    } else {\r\n      // Determine top left and bottom right corners to later determine the view's center position and scale\r\n      const topLeft = { x: 999999999, y: 999999999 };\r\n      const bottomRight = { x: -999999999, y: -999999999 };\r\n\r\n      for (let p of placeables) {\r\n        let tlc = p;\r\n        if (p instanceof Wall) {\r\n          tlc = { x: p.center.x - p.width / 2, y: p.center.y - p.height / 2 };\r\n        }\r\n\r\n        if (tlc.x < topLeft.x) topLeft.x = tlc.x;\r\n        if (tlc.y < topLeft.y) topLeft.y = tlc.y;\r\n        if (tlc.x + p.width > bottomRight.x) bottomRight.x = tlc.x + p.width;\r\n        if (tlc.y + p.height > bottomRight.y) bottomRight.y = tlc.y + p.height;\r\n      }\r\n\r\n      // Checking if screen at current scale fits placeables along x and y axis\r\n      let scale = canvas.scene._viewPosition.scale;\r\n      // Adjust the size of the rectangle that placeable occupy in our scale calculations\r\n      // to account for UI elements\r\n      const padding = 100;\r\n      if (bottomRight.x - topLeft.x + padding > canvas.screenDimensions[0] / scale) {\r\n        scale = canvas.screenDimensions[0] / (bottomRight.x - topLeft.x + padding);\r\n      }\r\n      if (bottomRight.y - topLeft.y + padding > canvas.screenDimensions[1] / scale) {\r\n        scale = canvas.screenDimensions[1] / (bottomRight.y - topLeft.y + padding);\r\n      }\r\n\r\n      canvas.animatePan({\r\n        duration: 250,\r\n        scale,\r\n        x: (bottomRight.x - topLeft.x) / 2 + topLeft.x,\r\n        y: (bottomRight.y - topLeft.y) / 2 + topLeft.y,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns a hash code from a string\r\n * @param  {String} str The string to hash.\r\n * @return {Number}    A 32bit integer\r\n * @see http://werxltd.com/wp/2010/05/13/javascript-implementation-of-javas-string-hashcode-method/\r\n */\r\nexport function hashCode(str) {\r\n  let hash = 0;\r\n  for (let i = 0, len = str.length; i < len; i++) {\r\n    let chr = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + chr;\r\n    hash |= 0; // Convert to 32bit integer\r\n  }\r\n  return hash;\r\n}\r\n\r\nfunction escapeRegex(string) {\r\n  return string.replace(/[/\\-\\\\^$+?.()|[\\]{}]/g, '\\\\$&');\r\n}\r\n\r\nexport function wildcardStringMatch(sw, s2) {\r\n  return new RegExp('^' + escapeRegex(sw).replaceAll('*', '.*') + '$').test(s2);\r\n}\r\n\r\nexport function wildcardStringReplace(sw, replaceWith, s2) {\r\n  let re = new RegExp(escapeRegex(sw).replaceAll('*', '.*'), 'g');\r\n  return s2.replaceAll(re, replaceWith);\r\n}\r\n\r\nexport function regexStringReplace(sw, replaceWith, s2) {\r\n  try {\r\n    let re = new RegExp(sw, 'g');\r\n    return s2.replaceAll(re, replaceWith);\r\n  } catch (e) {}\r\n  return s2;\r\n}\r\n\r\nexport function flattenToDepth(obj, d = 0) {\r\n  if (d === 0) return obj;\r\n\r\n  const flat = {};\r\n  for (let [k, v] of Object.entries(obj)) {\r\n    let t = foundry.utils.getType(v);\r\n    if (t === 'Object') {\r\n      if (foundry.utils.isEmpty(v)) flat[k] = v;\r\n      let inner = flattenToDepth(v, d - 1);\r\n      for (let [ik, iv] of Object.entries(inner)) {\r\n        flat[`${k}.${ik}`] = iv;\r\n      }\r\n    } else flat[k] = v;\r\n  }\r\n  return flat;\r\n}\r\n\r\nexport function activeEffectPresetSelect(aeConfig) {\r\n  const showPresetGeneric = function (documentName) {\r\n    new PresetBrowser(\r\n      aeConfig,\r\n      async (preset) => {\r\n        if (!foundry.utils.isEmpty(preset.randomize)) {\r\n          await applyRandomization(preset.data, null, preset.randomize);\r\n        }\r\n\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        Object.keys(preset.data[0]).forEach((k) => {\r\n          let value;\r\n          if (foundry.utils.getType(preset.data[0][k]) === 'string') value = preset.data[0][k];\r\n          else value = JSON.stringify(preset.data[0][k]);\r\n\r\n          nChanges.push({\r\n            key: documentName === 'Token' ? 'ATL.' + k : k,\r\n            mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE,\r\n            priority: 20,\r\n            value,\r\n          });\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      documentName\r\n    ).render(true);\r\n  };\r\n\r\n  const showPresetActiveEffect = function () {\r\n    new PresetBrowser(\r\n      aeConfig,\r\n      (preset) => {\r\n        const changes = aeConfig.object.changes ?? [];\r\n        let nChanges = [];\r\n\r\n        preset.data[0].changes?.forEach((change) => {\r\n          if (change.key) {\r\n            nChanges.push(\r\n              foundry.utils.mergeObject({ mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE, priority: 20 }, change)\r\n            );\r\n          }\r\n        });\r\n\r\n        for (let i = changes.length - 1; i >= 0; i--) {\r\n          if (!nChanges.find((nc) => nc.key === changes[i].key)) nChanges.unshift(changes[i]);\r\n        }\r\n\r\n        aeConfig.object.update({ changes: nChanges });\r\n      },\r\n      'ActiveEffect'\r\n    ).render(true);\r\n  };\r\n\r\n  new Dialog({\r\n    title: localize('common.presets'),\r\n    content: ``,\r\n    buttons: {\r\n      activeEffect: {\r\n        label: 'ActiveEffect',\r\n        callback: () => showPresetActiveEffect(),\r\n      },\r\n      token: {\r\n        label: 'Token',\r\n        callback: () => showPresetGeneric('Token'),\r\n      },\r\n      actor: {\r\n        label: 'Actor',\r\n        callback: () => showPresetGeneric('Actor'),\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nexport function getDocumentName(doc) {\r\n  const documentName = doc.document ? doc.document.documentName : doc.documentName;\r\n  return documentName ?? 'NONE';\r\n}\r\n\r\nexport const DOCUMENT_CREATE_REQUESTS = {};\r\n\r\n/**\r\n * Creates documents either directly or by delegating the task to a GM\r\n * @param {String} documentName  document type to be created\r\n * @param {Array[Object]} data   data defining the documents\r\n * @param {String} sceneID       scene the documents should be created on\r\n * @param {object} options       options to be passed to createEmbeddedDocuments\r\n * @returns placeable documents that have been created\r\n */\r\nexport async function createDocuments(documentName, data, sceneID, options = {}) {\r\n  if (game.user.isGM) {\r\n    return game.scenes.get(sceneID).createEmbeddedDocuments(documentName, data, options);\r\n  }\r\n\r\n  const requestID = foundry.utils.randomID();\r\n\r\n  const message = {\r\n    handlerName: 'document',\r\n    args: { sceneID, documentName, data, requestID, options },\r\n    type: 'CREATE',\r\n  };\r\n  game.socket.emit(`module.${MODULE_ID}`, message);\r\n\r\n  // Self resolve in 4s if no response from a GM is received\r\n  setTimeout(() => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID]?.([]);\r\n  }, 4000);\r\n\r\n  return new Promise((resolve) => {\r\n    DOCUMENT_CREATE_REQUESTS[requestID] = resolve;\r\n  });\r\n}\r\n\r\n/**\r\n * Resolves the delegated create documents request\r\n * @param {object} options\r\n * @param {String} options.requestID          request to be resolved\r\n * @param {String} options.sceneID            scene the documents have been created on\r\n * @param {String} options.documentName       type of document that has been created\r\n * @param {Array[String]} options.documentIDs array of document ids that have been created\r\n */\r\nexport function resolveCreateDocumentRequest({ requestID, sceneID, documentName, documentIDs } = {}) {\r\n  if (!DOCUMENT_CREATE_REQUESTS.hasOwnProperty(requestID)) return;\r\n\r\n  const scene = game.scenes.get(sceneID);\r\n  const documents = [];\r\n  for (const docID of documentIDs) {\r\n    documents.push(scene.getEmbeddedDocument(documentName, docID));\r\n  }\r\n\r\n  DOCUMENT_CREATE_REQUESTS[requestID](documents);\r\n  delete DOCUMENT_CREATE_REQUESTS[requestID];\r\n}\r\n\r\nexport async function updateEmbeddedDocumentsViaGM(documentName, updates, context, scene) {\r\n  if (game.user.isGM) {\r\n    return scene.updateEmbeddedDocuments(documentName, updates, context);\r\n  } else {\r\n    const message = {\r\n      handlerName: 'document',\r\n      args: { sceneID: scene.id, documentName, updates, context },\r\n      type: 'UPDATE',\r\n    };\r\n    game.socket.emit(`module.${MODULE_ID}`, message);\r\n  }\r\n}\r\n\r\nexport function isResponsibleGM() {\r\n  return game.users.filter((u) => u.active && u.isGM).sort((a, b) => b.role - a.role || a.id.compare(b.id))[0]?.isSelf;\r\n}\r\n\r\nexport function localize(path, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.localize(`MassEdit.${path}`);\r\n  return game.i18n.localize(path);\r\n}\r\n\r\nexport function localFormat(path, insert, moduleLocalization = true) {\r\n  if (moduleLocalization) return game.i18n.format(`MassEdit.${path}`, insert);\r\n  return game.i18n.format(path, insert);\r\n}\r\n\r\nexport async function applyPresetToScene(preset) {\r\n  if (preset && canvas.scene) {\r\n    await preset.load();\r\n    const data = foundry.utils.flattenObject(preset.data[0]);\r\n\r\n    const randomizer = preset.randomize;\r\n    if (!foundry.utils.isEmpty(randomizer)) {\r\n      await applyRandomization([data], null, randomizer);\r\n    }\r\n\r\n    await canvas.scene.update(data);\r\n\r\n    // Grid doesn't redraw on scene update, do it manually here\r\n    if ('grid.color' in data || 'grid.alpha' in data) {\r\n      canvas.grid.grid.draw({\r\n        color: (data['grid.color'] ?? canvas.scene.grid.color).replace('#', '0x'),\r\n        alpha: Number(data['grid.alpha'] ?? canvas.scene.grid.alpha),\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport async function executeScript(command, { actor, token, ...scope } = {}) {\r\n  // Add variables to the evaluation scope\r\n  const speaker = ChatMessage.implementation.getSpeaker({ actor, token });\r\n  const character = game.user.character;\r\n  token = token || (canvas.ready ? canvas.tokens.get(speaker.token) : null);\r\n  actor = actor || token?.actor || game.actors.get(speaker.actor);\r\n\r\n  // Unpack argument names and values\r\n  const argNames = Object.keys(scope);\r\n  if (argNames.some((k) => Number.isNumeric(k))) {\r\n    throw new Error('Illegal numeric Macro parameter passed to execution scope.');\r\n  }\r\n  const argValues = Object.values(scope);\r\n\r\n  // Define an AsyncFunction that wraps the macro content\r\n  const AsyncFunction = async function () {}.constructor;\r\n  // eslint-disable-next-line no-new-func\r\n  const fn = new AsyncFunction('speaker', 'actor', 'token', 'character', 'scope', ...argNames, `{${command}\\n}`);\r\n\r\n  // Attempt macro execution\r\n  try {\r\n    return await fn.call(this, speaker, actor, token, character, scope, ...argValues);\r\n  } catch (err) {\r\n    ui.notifications.error('MACRO.Error', { localize: true });\r\n  }\r\n}\r\n\r\nexport class SeededRandom {\r\n  /**\r\n   * Seeded variation of the Foundry's randomID(...) function.\r\n   * Generate a random string ID of a given requested length.\r\n   * @param {String} seed      Seed to be fed into random number generator\r\n   * @param {number} length    The length of the random ID to generate\r\n   * @return {string}          Return a string containing random letters and numbers\r\n   */\r\n  static randomID(seed, length = 16) {\r\n    seed = this.cyrb128(seed);\r\n    const random = this.sfc32(seed[0], seed[1], seed[2], seed[3]);\r\n\r\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    const r = Array.from({ length }, () => (random() * chars.length) >> 0);\r\n    return r.map((i) => chars[i]).join('');\r\n  }\r\n\r\n  // Courtesy of bryc\r\n  // github.com/bryc\r\n  static cyrb128(str) {\r\n    let h1 = 1779033703,\r\n      h2 = 3144134277,\r\n      h3 = 1013904242,\r\n      h4 = 2773480762;\r\n    for (let i = 0, k; i < str.length; i++) {\r\n      k = str.charCodeAt(i);\r\n      h1 = h2 ^ Math.imul(h1 ^ k, 597399067);\r\n      h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);\r\n      h3 = h4 ^ Math.imul(h3 ^ k, 951274213);\r\n      h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);\r\n    }\r\n    h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);\r\n    h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);\r\n    h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);\r\n    h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);\r\n    (h1 ^= h2 ^ h3 ^ h4), (h2 ^= h1), (h3 ^= h1), (h4 ^= h1);\r\n    return [h1 >>> 0, h2 >>> 0, h3 >>> 0, h4 >>> 0];\r\n  }\r\n\r\n  // Courtesy of Chris Doty-Humphrey\r\n  // https://pracrand.sourceforge.net/\r\n  static sfc32(a, b, c, d) {\r\n    return function () {\r\n      a |= 0;\r\n      b |= 0;\r\n      c |= 0;\r\n      d |= 0;\r\n      var t = (((a + b) | 0) + d) | 0;\r\n      d = (d + 1) | 0;\r\n      a = b ^ (b >>> 9);\r\n      b = (c + (c << 3)) | 0;\r\n      c = (c << 21) | (c >>> 11);\r\n      c = (c + t) | 0;\r\n      return (t >>> 0) / 4294967296;\r\n    };\r\n  }\r\n}\r\n\r\nexport class TagInput {\r\n  static simplifyString(str) {\r\n    return str.replace(/[^0-9a-zA-Z_\\- ]/gi, '').toLowerCase();\r\n  }\r\n\r\n  static registerHandlebarsHelper() {\r\n    Handlebars.registerHelper('tagInput', (options) => {\r\n      const name = options.hash.name;\r\n      const label = options.hash.label ?? 'Tags';\r\n      const listId = options.hash.listId;\r\n      const listEntries = options.hash.listEntries;\r\n\r\n      let tags = options.hash.tags;\r\n      if (!Handlebars.Utils.isArray(tags)) tags = [];\r\n\r\n      // Construct the HTML\r\n      let tagHtml = '';\r\n      tags.forEach((tag) => {\r\n        tagHtml += this._tagField(tag);\r\n      });\r\n\r\n      // DataList\r\n      let listAttr = '';\r\n      let dataList = '';\r\n      if (listId && listEntries) {\r\n        listAttr = `list=\"${listId}\"`;\r\n\r\n        dataList = `<datalist id=\"${listId}\"><option value=\"DELETE\"><option value=\"DELETE ALL\">`;\r\n        listEntries.forEach((le) => {\r\n          dataList += `<option value=\"${le}\">`;\r\n        });\r\n        dataList += `</datalist>`;\r\n      }\r\n\r\n      return new Handlebars.SafeString(`\r\n      ${dataList}\r\n      <fieldset>\r\n        <legend>${label}</legend>\r\n        <div class=\"form-group me-tags\">\r\n            <input type=\"text\" ${listAttr} class=\"tag-input\">  \r\n            <input type=\"text\" class=\"tag-hidden-input\" name=\"${name}\" value=\"${tags.join(',')}\" hidden>\r\n            <button type=\"button\" class=\"add-tag\"><i class=\"fas fa-save\" style=\"margin: auto;\"></i></button>\r\n            <div class=\"tag-container\">${tagHtml}</div>\r\n        </div>\r\n      </fieldset>\r\n    `);\r\n    });\r\n  }\r\n\r\n  static _tagField(tag) {\r\n    return `<div class=\"tag\"><span>${tag}</span> <a class=\"delete-tag\"><i class=\"fa-solid fa-x fa-xs\"></i></a></div>`;\r\n  }\r\n\r\n  static activateListeners(html, { change, simplifyTags = true } = {}) {\r\n    html.find('.me-tags .add-tag').on('click', (event) => {\r\n      const meTags = $(event.target).closest('.me-tags');\r\n      const input = meTags.find('.tag-input');\r\n\r\n      const newTags = input\r\n        .val()\r\n        .split(',')\r\n        .map((t) => {\r\n          t = t.trim();\r\n          if (simplifyTags) t = this.simplifyString(t);\r\n          return t;\r\n        })\r\n        .filter(Boolean);\r\n\r\n      if (newTags.length) {\r\n        input.val('');\r\n        const hiddenInput = meTags.find('.tag-hidden-input');\r\n        const currentTags = hiddenInput.val().split(',').filter(Boolean);\r\n        for (const tag of newTags) {\r\n          if (!currentTags.includes(tag)) {\r\n            currentTags.push(tag);\r\n            meTags.find('.tag-container').append(this._tagField(tag));\r\n          }\r\n        }\r\n        hiddenInput.attr('value', currentTags.join(','));\r\n        change?.(currentTags);\r\n      }\r\n    });\r\n\r\n    html.find('.me-tags').on('click', '.delete-tag', (event) => {\r\n      const tag = $(event.target).closest('.tag');\r\n\r\n      // Remove tag from hidden input\r\n      const tagValue = tag.find('span').text();\r\n      const hiddenInput = tag.closest('.me-tags').find('.tag-hidden-input');\r\n      const newTags = hiddenInput\r\n        .val()\r\n        .split(',')\r\n        .filter((t) => t !== tagValue);\r\n      hiddenInput.attr('value', newTags.join(','));\r\n\r\n      // Remove the tag element itself\r\n      tag.remove();\r\n\r\n      change?.(newTags);\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Activates Picker allowing drag selection of document across all placeables layers\r\n * @returns {Array[CanvasDocumentMixin]}\r\n */\r\nexport async function pickerSelectMultiLayerDocuments() {\r\n  // Activate picker to define select box\r\n  const coords = await new Promise(async (resolve) => {\r\n    Picker.activate(resolve);\r\n  });\r\n  if (!coords) return [];\r\n\r\n  // Selects placeables within the bounding box\r\n  const selectionRect = new PIXI.Rectangle(\r\n    coords.start.x,\r\n    coords.start.y,\r\n    coords.end.x - coords.start.x,\r\n    coords.end.y - coords.start.y\r\n  );\r\n\r\n  let selected = [];\r\n  SUPPORTED_PLACEABLES.forEach((documentName) => {\r\n    canvas.getLayerByEmbeddedName(documentName).placeables.forEach((p) => {\r\n      const c = p.center;\r\n      if (selectionRect.contains(c.x, c.y)) selected.push(p.document);\r\n    });\r\n  });\r\n\r\n  return selected;\r\n}\r\n\r\n/**\r\n * Returns dimensions of the provided image or video path\r\n * @param {String} src\r\n * @returns {object} {width, height}\r\n */\r\nexport async function loadImageVideoDimensions(src) {\r\n  let width, height;\r\n\r\n  try {\r\n    const baseTexture = (await loadTexture(src)).baseTexture;\r\n    width = baseTexture.width;\r\n    height = baseTexture.height;\r\n  } catch (e) {}\r\n\r\n  return { width, height };\r\n}\r\n\r\nexport async function spawnSceneAsPreset(scene) {\r\n  const attached = [];\r\n\r\n  SUPPORTED_PLACEABLES.forEach((name) => {\r\n    scene.getEmbeddedCollection(name).forEach((embed) => {\r\n      attached.push({ documentName: name, data: embed.toObject() });\r\n    });\r\n  });\r\n\r\n  let presetData;\r\n  if (scene.background.src) {\r\n    let { x, y, width, height } = scene.dimensions.sceneRect;\r\n\r\n    const tiles = attached.filter((att) => att.documentName === 'Tile');\r\n    let minSort = tiles.length\r\n      ? Math.min.apply(\r\n          Math,\r\n          tiles.map((t) => t.data.sort ?? 0)\r\n        )\r\n      : 0;\r\n    let minElevation = tiles.length\r\n      ? Math.min.apply(\r\n          Math,\r\n          tiles.map((t) => t.data.elevation ?? 0)\r\n        )\r\n      : 0;\r\n\r\n    presetData = {\r\n      documentName: 'Tile',\r\n      data: {\r\n        texture: {\r\n          src: scene.background.src,\r\n        },\r\n        width,\r\n        height,\r\n        x,\r\n        y,\r\n        sort: minSort - 1,\r\n        elevation: minElevation,\r\n      },\r\n    };\r\n  } else {\r\n    presetData = attached.findSplice((att) => att.documentName === 'Token');\r\n    if (!presetData) presetData = attached.findSplice((att) => att.documentName === 'Tile');\r\n    if (!presetData) presetData = attached.shift();\r\n  }\r\n\r\n  const preset = new Preset({ documentName: presetData.documentName, data: [presetData.data], attached });\r\n\r\n  const documents = await Spawner.spawnPreset({\r\n    preset,\r\n    preview: true,\r\n    previewRestrictedDocuments: preset.documentName === 'AmbientLight' ? null : ['AmbientLight'],\r\n    pivot: MassEdit.PIVOTS.CENTER,\r\n  });\r\n\r\n  // const linkId = foundry.utils.randomID();\r\n  // documents.forEach((d) => {\r\n  //   LinkerAPI.addLink(d, linkId);\r\n  // });\r\n}\r\n","module.exports = jQuery;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.f = {};\n// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = (chunkId) => {\n\treturn Promise.all(Object.keys(__webpack_require__.f).reduce((promises, key) => {\n\t\t__webpack_require__.f[key](chunkId, promises);\n\t\treturn promises;\n\t}, []));\n};","// This function allow to reference async chunks\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".mass-edit.js\";\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.p = \"modules/multi-token-edit/bundle/\";","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t792: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {\n\t\t// JSONP chunk loading for javascript\n\t\tvar installedChunkData = __webpack_require__.o(installedChunks, chunkId) ? installedChunks[chunkId] : undefined;\n\t\tif(installedChunkData !== 0) { // 0 means \"already installed\".\n\n\t\t\t// a Promise means \"currently loading\".\n\t\t\tif(installedChunkData) {\n\t\t\t\tpromises.push(installedChunkData[2]);\n\t\t\t} else {\n\t\t\t\tif(true) { // all chunks have JS\n\t\t\t\t\t// setup Promise in chunk cache\n\t\t\t\t\tvar promise = new Promise((resolve, reject) => (installedChunkData = installedChunks[chunkId] = [resolve, reject]));\n\t\t\t\t\tpromises.push(installedChunkData[2] = promise);\n\n\t\t\t\t\t// start chunk loading\n\t\t\t\t\tvar url = __webpack_require__.p + __webpack_require__.u(chunkId);\n\t\t\t\t\t// create error before stack unwound to get useful stacktrace later\n\t\t\t\t\tvar error = new Error();\n\t\t\t\t\tvar loadingEnded = (event) => {\n\t\t\t\t\t\tif(__webpack_require__.o(installedChunks, chunkId)) {\n\t\t\t\t\t\t\tinstalledChunkData = installedChunks[chunkId];\n\t\t\t\t\t\t\tif(installedChunkData !== 0) installedChunks[chunkId] = undefined;\n\t\t\t\t\t\t\tif(installedChunkData) {\n\t\t\t\t\t\t\t\tvar errorType = event && (event.type === 'load' ? 'missing' : event.type);\n\t\t\t\t\t\t\t\tvar realSrc = event && event.target && event.target.src;\n\t\t\t\t\t\t\t\terror.message = 'Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')';\n\t\t\t\t\t\t\t\terror.name = 'ChunkLoadError';\n\t\t\t\t\t\t\t\terror.type = errorType;\n\t\t\t\t\t\t\t\terror.request = realSrc;\n\t\t\t\t\t\t\t\tinstalledChunkData[1](error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t__webpack_require__.l(url, loadingEnded, \"chunk-\" + chunkId, chunkId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n};\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n// no on chunks loaded\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunkmulti_token_edit\"] = self[\"webpackChunkmulti_token_edit\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","import { MODULE_ID } from '../constants.js';\r\nimport { META_INDEX_FIELDS, META_INDEX_ID, PresetCollection, PresetTree } from './collection.js';\r\nimport { PresetBrowser } from './browser/browserApp.js';\r\nimport { PRESET_FIELDS } from './preset.js';\r\n\r\nexport class V12Migrator {\r\n  static async migrateAllPacks({ migrateFunc = null, transformFunc = null, coreMigration = false } = {}) {\r\n    if (!migrateFunc && !transformFunc && !coreMigration) {\r\n      ui.notifications.warn('Specify either a `migrateFunc`, `transformFunc`, or enable `coreMigration` flag.');\r\n      return;\r\n    }\r\n\r\n    if (transformFunc && (migrateFunc || coreMigration)) {\r\n      ui.notifications.warn('`transformFunc` cannot be executed alongside `migrateFunc` or `coreMigration` flag.');\r\n      return;\r\n    }\r\n\r\n    for (const pack of game.packs) {\r\n      if (pack.documentName !== 'JournalEntry') continue;\r\n      if (!pack.index.get(META_INDEX_ID)) continue;\r\n      else if (pack.locked) {\r\n        console.warn(`Mass Edit - Unable to migrate a locked compendium. ${pack.metadata.label}`);\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        this.migratePack({ pack, migrateFunc, transformFunc, coreMigration });\r\n      } catch (e) {\r\n        console.warn(`Mass Edit - Ran into an issue while migrating ${pack.metadata.label}`);\r\n        console.error(e);\r\n      }\r\n    }\r\n  }\r\n\r\n  static async migratePack({\r\n    pack = PresetCollection.workingPack,\r\n    migrateFunc = null,\r\n    transformFunc = null,\r\n    coreMigration = false,\r\n  } = {}) {\r\n    if (foundry.utils.getType(pack) === 'string') {\r\n      let fPack = game.packs.get(pack) || game.packs.find((p) => p.metadata.label === pack);\r\n      if (!fPack) {\r\n        console.warn('Invalid pack: ' + pack);\r\n        return;\r\n      }\r\n      pack = fPack;\r\n    }\r\n\r\n    if (!pack.index.get(META_INDEX_ID)) {\r\n      console.warn(`Mass Edit - This is not a preset compendium. ${pack.metadata.label}`);\r\n      return;\r\n    }\r\n\r\n    if (pack.locked) {\r\n      console.warn(`Mass Edit - Unable to migrate a locked compendium. ${pack.metadata.label}`);\r\n      return;\r\n    }\r\n\r\n    if (!migrateFunc && !transformFunc && !coreMigration) {\r\n      ui.notifications.warn('Specify either a `migrateFunc`, `transformFunc`, or enable `coreMigration` flag.');\r\n      return;\r\n    }\r\n\r\n    if (transformFunc && (migrateFunc || coreMigration)) {\r\n      ui.notifications.warn('`transformFunc` cannot be executed alongside `migrateFunc` or `coreMigration` flag.');\r\n      return;\r\n    }\r\n\r\n    const updates = [];\r\n    const documents = await pack.getDocuments();\r\n    const metaIndexUpdate = {};\r\n\r\n    if (migrateFunc || coreMigration) {\r\n      for (const document of documents) {\r\n        const preset = document.getFlag(MODULE_ID, 'preset');\r\n        if (!preset) continue;\r\n\r\n        let update = {};\r\n\r\n        // Migrate Preset data\r\n        if (preset.data?.length) {\r\n          this._migrateData(preset.data, preset.documentName, coreMigration, migrateFunc);\r\n          foundry.utils.setProperty(update, `flags.${MODULE_ID}.preset.data`, preset.data);\r\n        }\r\n\r\n        // Convert attached Preset data\r\n        if (preset.attached?.length) {\r\n          for (const attached of preset.attached) {\r\n            this._migrateData([attached.data], attached.documentName, coreMigration, migrateFunc);\r\n          }\r\n          foundry.utils.setProperty(update, `flags.${MODULE_ID}.preset.attached`, preset.attached);\r\n        }\r\n\r\n        if (!foundry.utils.isEmpty(update)) {\r\n          update._id = document.id;\r\n          updates.push(update);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (transformFunc) {\r\n      for (const document of documents) {\r\n        let preset = document.getFlag(MODULE_ID, 'preset');\r\n        if (!preset) continue;\r\n\r\n        const original = preset;\r\n        preset = foundry.utils.deepClone(original);\r\n\r\n        await transformFunc(preset, document);\r\n\r\n        const diff = foundry.utils.diffObject(original, preset);\r\n        Object.keys(diff).forEach((field) => {\r\n          if (!PRESET_FIELDS.includes(field)) delete diff[field];\r\n        });\r\n\r\n        if (!foundry.utils.isEmpty(diff)) {\r\n          let update = {};\r\n          update._id = document.id;\r\n\r\n          foundry.utils.setProperty(update, `flags.${MODULE_ID}.preset`, diff);\r\n          updates.push(update);\r\n\r\n          const indexUpdate = {};\r\n          META_INDEX_FIELDS.forEach((field) => {\r\n            if (field in diff) indexUpdate[field] = diff[field];\r\n          });\r\n\r\n          if (!foundry.utils.isEmpty(indexUpdate)) metaIndexUpdate[document.id] = indexUpdate;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (updates.length <= 0) {\r\n      ui.notifications.info('Mass Edit - No data to migrate: ' + pack.metadata.label);\r\n    } else {\r\n      await JournalEntry.updateDocuments(updates, { pack: pack.collection });\r\n      if (!foundry.utils.isEmpty(metaIndexUpdate)) {\r\n        const index = await pack.getDocument(META_INDEX_ID);\r\n        if (index) index.setFlag(MODULE_ID, 'index', metaIndexUpdate);\r\n      }\r\n\r\n      ui.notifications.notify('Mass Edit - Migrated ' + updates.length + ' presets within \"' + pack.metadata.label);\r\n\r\n      setTimeout(() => {\r\n        delete PresetTree._packTrees[pack.metadata.name];\r\n        Object.values(ui.windows)\r\n          .find((app) => app instanceof PresetBrowser)\r\n          ?.render(true);\r\n      }, 500);\r\n    }\r\n\r\n    return pack;\r\n  }\r\n\r\n  static _migrateData(dataArr, documentName, coreMigration = true, migrateFunc = null) {\r\n    const cls = getDocumentClass(documentName);\r\n\r\n    for (const data of dataArr) {\r\n      if (coreMigration) cls?.migrateData(data); // Core Foundry migration\r\n      if (migrateFunc) migrateFunc(data, documentName); // Custom migration function\r\n\r\n      // Token Attacher data traversal\r\n      const prototypeAttached = data.flags?.['token-attacher']?.prototypeAttached;\r\n      if (prototypeAttached) this._migratePrototypeAttached(prototypeAttached, coreMigration, migrateFunc);\r\n    }\r\n  }\r\n\r\n  static _migratePrototypeAttached(prototypeAttached, coreMigration = true, migrateFunc = null) {\r\n    for (const [documentName, attached] of Object.entries(prototypeAttached)) {\r\n      this._migrateData(attached, documentName, coreMigration, migrateFunc);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Field Type for referencing Mass Edit presets\r\n * Both virtual and JournalEntry\r\n */\r\nexport class PresetField extends foundry.data.fields.SetField {\r\n  constructor(...args) {\r\n    super(new foundry.data.fields.StringField({}), ...args);\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get _defaults() {\r\n    return Object.assign(super._defaults, {\r\n      required: false,\r\n      blank: true,\r\n      nullable: true,\r\n      initial: null,\r\n      type: null,\r\n      embedded: undefined,\r\n    });\r\n  }\r\n\r\n  /** @override */\r\n  _toInput(config) {\r\n    return CustomStringElement.create(config);\r\n  }\r\n}\r\n\r\nclass CustomStringElement extends foundry.applications.elements.HTMLStringTagsElement {\r\n  /** @override */\r\n  static tagName = 'preset-tags';\r\n\r\n  /** @override */\r\n  static labels = {\r\n    add: 'ELEMENTS.TAGS.Add',\r\n    remove: 'ELEMENTS.TAGS.Remove',\r\n    placeholder: 'Enter UUID',\r\n  };\r\n\r\n  /** @override */\r\n  static renderTag(tag, label, editable = true) {\r\n    if (tag.startsWith('virtual@')) {\r\n      label = tag.split('\\\\').pop().split('/').pop();\r\n    } else {\r\n      const record = fromUuidSync(tag);\r\n      if (record) label = record.name ?? tag;\r\n    }\r\n\r\n    return super.renderTag(tag, label, editable);\r\n  }\r\n}\r\n\r\nwindow.customElements.define(CustomStringElement.tagName, CustomStringElement);\r\n","import { MODULE_ID, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { PresetField } from './fields.js';\r\n\r\n/**\r\n * Region behavior to de-spawn presets.\r\n */\r\nexport class DeSpawnPresetBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType {\r\n  static defineSchema() {\r\n    return {\r\n      events: this._createEventsField({\r\n        events: [\r\n          CONST.REGION_EVENTS.TOKEN_ENTER,\r\n          CONST.REGION_EVENTS.TOKEN_EXIT,\r\n          CONST.REGION_EVENTS.TOKEN_MOVE_IN,\r\n          CONST.REGION_EVENTS.TOKEN_MOVE_OUT,\r\n          CONST.REGION_EVENTS.TOKEN_TURN_START,\r\n          CONST.REGION_EVENTS.TOKEN_TURN_END,\r\n        ],\r\n      }),\r\n      presetUuids: new PresetField({\r\n        label: 'Presets',\r\n        hint: 'Select specific presets to be removed.',\r\n      }),\r\n      all: new foundry.data.fields.BooleanField({\r\n        label: 'All',\r\n        hint: 'If enabled all spawned presets will be removed.',\r\n        initial: false,\r\n      }),\r\n      originRegionOnly: new foundry.data.fields.BooleanField({\r\n        label: 'This Region Only',\r\n        hint: 'If enabled only presets spawned by this region will be removed.',\r\n        initial: true,\r\n      }),\r\n    };\r\n  }\r\n\r\n  /** @override */\r\n  async _handleRegionEvent(event) {\r\n    if (!(this.presetUuids || this.all)) return;\r\n\r\n    const token = event.data.token;\r\n    if (token.object) {\r\n      const animation = CanvasAnimation.getAnimation(token.object.animationName);\r\n      if (animation) await animation.promise;\r\n    }\r\n\r\n    if (this.all) {\r\n      DeSpawnPresetBehaviorType.deSpawnAllPresets(this.parent.scene, this.originRegionOnly ? this.region.id : null);\r\n    } else {\r\n      if (!this.presetUuids?.size) return;\r\n      const uuids = Array.from(this.presetUuids);\r\n      DeSpawnPresetBehaviorType.deSpawnPresets(uuids, this.parent.scene, this.originRegionOnly ? this.region.id : null);\r\n    }\r\n    return;\r\n  }\r\n\r\n  /**\r\n   * Removes embedded documents with uuids matching spawnPreset flag\r\n   * @param {Array[String]} uuids\r\n   * @param {Scene} scene\r\n   * @param {String|null} originRegionId\r\n   * @returns\r\n   */\r\n  static deSpawnPresets(uuids, scene, originRegionId) {\r\n    SUPPORTED_PLACEABLES.forEach((embedName) => {\r\n      const ids = [];\r\n      scene.getEmbeddedCollection(embedName).forEach((d) => {\r\n        const uuid = d.flags[MODULE_ID]?.spawnPreset?.uuid;\r\n        if (uuid && uuids.some((u) => u === uuid)) {\r\n          if (!originRegionId) ids.push(d.id);\r\n          else if (d.flags[MODULE_ID].spawnPreset.regionId === originRegionId) ids.push(d.id);\r\n        }\r\n      });\r\n      if (ids.length) DeSpawnPresetBehaviorType.deleteEmbeddedDocuments(scene, embedName, ids);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Removed embedded documents with 'spawnPreset' flags that match the provided region id.\r\n   * A null region ID will match all regionId flags.\r\n   * @param {String|null} originRegionId\r\n   */\r\n  static deSpawnAllPresets(scene, originRegionId) {\r\n    SUPPORTED_PLACEABLES.forEach((embedName) => {\r\n      const ids = [];\r\n      scene.getEmbeddedCollection(embedName).forEach((d) => {\r\n        const regionId = d.flags[MODULE_ID]?.spawnPreset?.regionId;\r\n        if (regionId && (!originRegionId || regionId === originRegionId)) ids.push(d.id);\r\n      });\r\n      if (ids.length) DeSpawnPresetBehaviorType.deleteEmbeddedDocuments(scene, embedName, ids);\r\n    });\r\n  }\r\n\r\n  static deleteEmbeddedDocuments(scene, embedName, ids) {\r\n    if (game.user.isGM) {\r\n      scene.deleteEmbeddedDocuments(embedName, ids);\r\n    } else {\r\n      const message = {\r\n        handlerName: 'document',\r\n        args: { sceneId: scene.id, embedName, ids },\r\n        type: 'DELETE',\r\n      };\r\n      game.socket.emit(`module.${MODULE_ID}`, message);\r\n    }\r\n  }\r\n}\r\n","import { LINK_TYPES, LinkerAPI } from '../linker/linker.js';\r\nimport { isResponsibleGM, localize } from '../utils.js';\r\n\r\n/**\r\n * Region behavior to Link token to the region.\r\n */\r\nexport class LinkTokenRegionBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType {\r\n  static defineSchema() {\r\n    return {\r\n      linkId: new foundry.data.fields.StringField({\r\n        label: localize('behavior.linkToken.linkId.label'),\r\n        hint: localize('behavior.linkToken.linkId.hint'),\r\n        initial: 'LinkTokenBehavior - ' + foundry.utils.randomID(8),\r\n      }),\r\n      // linkType: new foundry.data.fields.NumberField({\r\n      //   choices: Object.keys(LINK_TYPES).reduce((obj, t) => {\r\n      //     obj[LINK_TYPES[t]] = t;\r\n      //     return obj;\r\n      //   }, {}),\r\n      //   label: `Link Type`,\r\n      //   hint: `One-way links will not transfer Token updates back to the region.`,\r\n      //   initial: LINK_TYPES.RECEIVE,\r\n      // }),\r\n    };\r\n  }\r\n\r\n  /** @override */\r\n  static events = {\r\n    [CONST.REGION_EVENTS.TOKEN_MOVE_IN]: this._onTokenMoveIn,\r\n    [CONST.REGION_EVENTS.TOKEN_MOVE_OUT]: this._onTokenMoveOut,\r\n  };\r\n\r\n  static async _onTokenMoveIn(event) {\r\n    if (!isResponsibleGM()) return;\r\n\r\n    if (LinkerAPI.areLinked(this.region, event.data.token)) return;\r\n\r\n    if (!LinkerAPI.hasLink(this.region, this.linkId))\r\n      LinkerAPI.addLink(this.region, this.linkId, LINK_TYPES.TWO_WAY, 'LinkTokenBehavior');\r\n\r\n    LinkerAPI.addLink(event.data.token, this.linkId, LINK_TYPES.RECEIVE, 'LinkTokenBehavior');\r\n    return;\r\n  }\r\n\r\n  static async _onTokenMoveOut(event) {\r\n    if (!isResponsibleGM()) return;\r\n    if (event.data.teleport || !event.data.forced) LinkerAPI.removeLink(event.data.token, this.linkId);\r\n  }\r\n}\r\n","import { MODULE_ID, PIVOTS, SUPPORTED_PLACEABLES } from '../constants.js';\r\nimport { PresetAPI } from '../presets/collection.js';\r\nimport { Spawner } from '../presets/spawner.js';\r\nimport { getDataBounds } from '../presets/utils.js';\r\nimport { PresetField } from './fields.js';\r\n\r\n/**\r\n * Region behavior to spawn presets\r\n */\r\nexport class SpawnPresetBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType {\r\n  static defineSchema() {\r\n    const schema = {\r\n      events: this._createEventsField({\r\n        events: [\r\n          CONST.REGION_EVENTS.TOKEN_ENTER,\r\n          CONST.REGION_EVENTS.TOKEN_EXIT,\r\n          CONST.REGION_EVENTS.TOKEN_MOVE_IN,\r\n          CONST.REGION_EVENTS.TOKEN_MOVE_OUT,\r\n          CONST.REGION_EVENTS.TOKEN_TURN_START,\r\n          CONST.REGION_EVENTS.TOKEN_TURN_END,\r\n        ],\r\n      }),\r\n      once: new foundry.data.fields.BooleanField({\r\n        label: 'Once',\r\n        hint: \"Disable the behavior after the first time it's triggered\",\r\n        initial: false,\r\n      }),\r\n      presetUuids: new PresetField({\r\n        label: 'Presets',\r\n      }),\r\n      destination: new foundry.data.fields.DocumentUUIDField({ label: 'Target Region UUID', type: 'Region' }),\r\n    };\r\n\r\n    if (game.modules.get('tagger')?.active) {\r\n      schema.destinationTags = new foundry.data.fields.SetField(new foundry.data.fields.StringField({}), {\r\n        label: 'Target Region Tags',\r\n        hint: '',\r\n      });\r\n    }\r\n\r\n    schema.destinationSpawnInAll = new foundry.data.fields.BooleanField({\r\n      label: 'All Regions',\r\n      hint: 'When enabled the preset will be spawned in all regions if multiple have been found as valid destinations.',\r\n      initial: true,\r\n    });\r\n\r\n    schema.random = new foundry.data.fields.BooleanField({\r\n      label: 'Randomize Position',\r\n      hint: 'Randomized position will be chosen within the bounds of the target region.',\r\n      initial: false,\r\n    });\r\n\r\n    return schema;\r\n  }\r\n\r\n  /** @override */\r\n  async _handleRegionEvent(event) {\r\n    if (!event.user.isSelf) return;\r\n\r\n    if (this.once) this.parent.update({ disabled: true });\r\n\r\n    if (!event.data.teleport && event.data.forced) return;\r\n\r\n    let destinations = [];\r\n\r\n    // Get destination by UUID\r\n    const destination = fromUuidSync(this.destination);\r\n    if (destination instanceof RegionDocument) destinations.push(destination);\r\n\r\n    // Get destinations by tags\r\n    if (this.destinationTags?.size && game.modules.get('tagger')?.active) {\r\n      const taggedDestinations = Tagger.getByTag(Array.from(this.destinationTags), {\r\n        matchAny: true,\r\n        allScenes: false,\r\n      }).filter((d) => d instanceof RegionDocument);\r\n      if (taggedDestinations.length) destinations = destinations.concat(taggedDestinations);\r\n    }\r\n\r\n    if (!destinations.length) return;\r\n\r\n    // Check if presets are already spawned on destination scenes\r\n    const scenes = new Map();\r\n    destinations.forEach((d) => {\r\n      if (!scenes.get(d.parent.id)) scenes.set(d.parent.id, [d]);\r\n      else scenes.get(d.parent.id).push(d);\r\n    });\r\n\r\n    scenes.forEach((destinations, sceneId) => {\r\n      if (SpawnPresetBehaviorType.isSpawned(this.behavior.id, sceneId)) scenes.delete(sceneId);\r\n    });\r\n\r\n    if (!scenes.size) return;\r\n\r\n    // Wait for token animation to stop\r\n    const token = event.data.token;\r\n    if (token.object) {\r\n      const animation = CanvasAnimation.getAnimation(token.object.animationName);\r\n      if (animation) await animation.promise;\r\n    }\r\n\r\n    // Pick random preset\r\n    if (!this.presetUuids?.size) return;\r\n\r\n    const uuids = Array.from(this.presetUuids);\r\n    const presetUuid = uuids[Math.floor(Math.random() * uuids.length)];\r\n\r\n    const preset = await PresetAPI.getPreset({ uuid: presetUuid });\r\n    if (!preset) {\r\n      console.error(`UUID (${this.presetUuid}) Name (${this.presetName}) does not exist`);\r\n      return;\r\n    }\r\n\r\n    destinations = [];\r\n    scenes.forEach((ds) => (destinations = destinations.concat(ds)));\r\n\r\n    if (!this.destinationSpawnInAll) {\r\n      destinations = [destinations[Math.floor(Math.random() * destinations.length)]];\r\n    }\r\n\r\n    for (const destination of destinations) {\r\n      const destinationRegionObject = destination.object ?? new CONFIG.Region.objectClass(destination);\r\n      SpawnPresetBehaviorType.spawnPreset(\r\n        this.region.id,\r\n        this.behavior.id,\r\n        preset,\r\n        destinationRegionObject,\r\n        this.random\r\n      ).then(() => {\r\n        if (!destination.object) destinationRegionObject.destroy({ children: true });\r\n      });\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  /**\r\n   * Check if a preset has already been spawned on the scene by this behavior\r\n   * @param {String} behaviorId\r\n   * @param {Scene} sceneId\r\n   * @returns\r\n   */\r\n  static isSpawned(behaviorId, sceneId) {\r\n    const scene = game.scenes.get(sceneId);\r\n    return SUPPORTED_PLACEABLES.some((embedName) =>\r\n      scene.getEmbeddedCollection(embedName).some((d) => d.flags[MODULE_ID]?.spawnPreset?.behaviorId === behaviorId)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Spawn given preset within the bounds of the region.\r\n   * @param {String} regionId\r\n   * @param {String} behaviorId\r\n   * @param {Preset} preset\r\n   * @param {Region} region\r\n   * @param {object} center\r\n   */\r\n  static async spawnPreset(regionId, behaviorId, preset, region, random = true) {\r\n    const position = random ? getRandomPosition(region) : SpawnPresetBehaviorType.getCenterPosition(region);\r\n    if (position) {\r\n      // Tracker flags for 'isSpawned' check and preset de-spawn behavior\r\n      const flags = {\r\n        [MODULE_ID]: {\r\n          spawnPreset: { uuid: preset.uuid, behaviorId, regionId },\r\n        },\r\n      };\r\n\r\n      Spawner.spawnPreset({\r\n        preset,\r\n        x: position.x,\r\n        y: position.y,\r\n        scaleToGrid: true,\r\n        pivot: PIVOTS.CENTER,\r\n        flags,\r\n        sceneId: region.parent.id,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return center position off the given region\r\n   * @param {Region|RegionDocument} region\r\n   * @returns {Object} {x, y}\r\n   */\r\n  static getCenterPosition(region) {\r\n    const { x1, y1, x2, y2 } = getDataBounds('Region', region.document ?? region);\r\n    return { x: x1 + (x2 - x1) / 2, y: y1 + (y2 - y1) / 2 };\r\n  }\r\n}\r\n\r\n/**\r\n * Code taken from Foundry VTT Teleport Token Region Behavior.\r\n * TeleportTokenRegionBehaviorType.#getDestination(region, token)\r\n * Foundry Virtual Tabletop  Copyright 2024, Foundry Gaming, LLC\r\n * https://foundryvtt.com/\r\n * @param {Region} region\r\n * @returns\r\n */\r\nfunction getRandomPosition(region) {\r\n  let pivot = { x: 0, y: 0 };\r\n\r\n  // Calculate the areas of each triangle of the triangulation\r\n  const { vertices, indices } = region.triangulation;\r\n  const areas = [];\r\n  let totalArea = 0;\r\n  for (let k = 0; k < indices.length; k += 3) {\r\n    const i0 = indices[k] * 2;\r\n    const i1 = indices[k + 1] * 2;\r\n    const i2 = indices[k + 2] * 2;\r\n    const x0 = vertices[i0];\r\n    const y0 = vertices[i0 + 1];\r\n    const x1 = vertices[i1];\r\n    const y1 = vertices[i1 + 1];\r\n    const x2 = vertices[i2];\r\n    const y2 = vertices[i2 + 1];\r\n    const area = Math.abs((x1 - x0) * (y2 - y0) - (x2 - x0) * (y1 - y0)) / 2;\r\n    totalArea += area;\r\n    areas.push(area);\r\n  }\r\n\r\n  let position;\r\n  // Try to find a position that places the token inside the region\r\n  for (let n = 0; n < 10; n++) {\r\n    position = undefined;\r\n\r\n    // Choose a triangle randomly weighted by area\r\n    let j;\r\n    let a = totalArea * Math.random();\r\n    for (j = 0; j < areas.length - 1; j++) {\r\n      a -= areas[j];\r\n      if (a < 0) break;\r\n    }\r\n    const k = 3 * j;\r\n    const i0 = indices[k] * 2;\r\n    const i1 = indices[k + 1] * 2;\r\n    const i2 = indices[k + 2] * 2;\r\n    const x0 = vertices[i0];\r\n    const y0 = vertices[i0 + 1];\r\n    const x1 = vertices[i1];\r\n    const y1 = vertices[i1 + 1];\r\n    const x2 = vertices[i2];\r\n    const y2 = vertices[i2 + 1];\r\n\r\n    // Select a random point within the triangle\r\n    const r1 = Math.sqrt(Math.random());\r\n    const r2 = Math.random();\r\n    const s = r1 * (1 - r2);\r\n    const t = r1 * r2;\r\n    const x = Math.round(x0 + (x1 - x0) * s + (x2 - x0) * t - pivot.x);\r\n    const y = Math.round(y0 + (y1 - y0) * s + (y2 - y0) * t - pivot.y);\r\n    position = { x, y };\r\n\r\n    // The center point of the token must be inside the region\r\n    if (!region.polygonTree.testPoint(position)) continue;\r\n  }\r\n  return position;\r\n}\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { PresetBrowser } from './browser/browserApp.js';\r\nimport { PresetAPI } from './collection.js';\r\nimport { PresetContainer } from './containerApp.js';\r\n\r\n/**\r\n * Constructs and opens a menu for browsing through Mass Edit presets\r\n * @param {object} menu    Application's menu structure\r\n * @param {object} options\r\n * @returns\r\n */\r\nexport async function openCategoryBrowser(\r\n  menu,\r\n  { retainState = false, name = 'Category Browser', alignment = 'left', searchBar = false, globalSearch = false } = {}\r\n) {\r\n  // // If category browser is already open close it\r\n  const app = Object.values(ui.windows).find((w) => w._browserId === name);\r\n  if (app) {\r\n    app.close(true);\r\n    return;\r\n  }\r\n\r\n  new CategoryBrowserApplication(menu, { name, retainState, alignment, searchBar, globalSearch }).render(true);\r\n}\r\n\r\n/**\r\n * Representation of a menu button\r\n */\r\nclass Category {\r\n  menu = null; // CategoryList this category is part of\r\n  submenu = null; // CategoryList to be displayed when this category is active\r\n\r\n  constructor({ title, fa, img, query, menu }) {\r\n    this.title = title; // Hover text\r\n    this.fa = fa; // Font Awesome icon\r\n    this.img = img; // Image icon\r\n    this.query = query; // Search query to be ran when active\r\n    this.menu = menu; // CategoryList this category is part of\r\n    this.id = foundry.utils.randomID(); // Unique identifier\r\n  }\r\n}\r\n\r\n/**\r\n * Representation of a single menu (column) within the app\r\n */\r\nclass CategoryList {\r\n  parentCategory = null; // Category\r\n  categories = [];\r\n\r\n  constructor(parentCategory) {\r\n    this.parentCategory = parentCategory;\r\n    this.id = foundry.utils.randomID();\r\n    this.active = false;\r\n  }\r\n\r\n  set active(val) {\r\n    this._active = val;\r\n  }\r\n\r\n  get active() {\r\n    return this._active || this._topMenu;\r\n  }\r\n}\r\n\r\nclass CategoryBrowserApplication extends PresetContainer {\r\n  static oldMenuStates = {};\r\n\r\n  _menus = [];\r\n  _categories = new Map();\r\n\r\n  // Track positions of previously opened apps\r\n  static previousPositions = {};\r\n\r\n  constructor(menu, options = {}) {\r\n    const id = options.name ?? foundry.utils.randomID();\r\n    let positionOpts = CategoryBrowserApplication.previousPositions[id] ?? {};\r\n    super({}, { ...options, disableDelete: true, ...positionOpts });\r\n    this._browserId = id;\r\n\r\n    // If the state of the window was set to be retained we retrieve it now\r\n    // and run the necessary queries to get the results\r\n    if (options.retainState && CategoryBrowserApplication.oldMenuStates[this._browserId]) {\r\n      const { menus, categories, lastSearch, globalSearch } = CategoryBrowserApplication.oldMenuStates[this._browserId];\r\n      this._menus = menus;\r\n      this._categories = categories;\r\n      this._lastSearch = lastSearch;\r\n      this.options.globalSearch = globalSearch;\r\n      this._runQueryTree();\r\n    } else {\r\n      // Otherwise we process the fed in JSON menu structure\r\n      this._processMenu(menu)._topMenu = true;\r\n    }\r\n  }\r\n\r\n  /** @inheritdoc */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sheet', 'mass-edit-dark-window', 'mass-edit-category-browser'],\r\n      template: `modules/${MODULE_ID}/templates/preset/categoryBrowser.html`,\r\n      width: 450,\r\n      height: 450,\r\n      resizable: true,\r\n      minimizable: true,\r\n      scrollY: ['.item-list', '.category-list'],\r\n    });\r\n  }\r\n\r\n  /* -------------------------------------------- */\r\n\r\n  /** @override */\r\n  get id() {\r\n    return 'mass-edit-category-browser-' + this._browserId;\r\n  }\r\n\r\n  get title() {\r\n    return this.options.name ?? 'Category Browser';\r\n  }\r\n\r\n  async getData(options) {\r\n    return {\r\n      menus: this._menus.filter((menu) => menu.active),\r\n      presets: this._presetResults,\r\n      alignment: options.alignment,\r\n      searchBar: options.searchBar,\r\n      globalSearch: options.globalSearch,\r\n      lastSearch: this._lastSearch,\r\n    };\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    html.find('.category').on('click', this._onClickCategory.bind(this));\r\n    html.find('.header-search input').on('input', this._onSearchInput.bind(this));\r\n    html.find('.globalSearchToggle').on('click', this._onGlobalSearchToggle.bind(this));\r\n    this._setHeaderButtonColors();\r\n  }\r\n\r\n  async _onSearchInput(event) {\r\n    clearTimeout(this._searchTimer);\r\n    this._searchTimer = setTimeout(() => this._onSearch(event.target.value), 250);\r\n  }\r\n\r\n  async _onSearch(search) {\r\n    this._lastSearch = search.length >= 3 ? search : null;\r\n    if (this._lastSearch || !search) this._runQueryTree();\r\n  }\r\n\r\n  _onGlobalSearchToggle(event) {\r\n    this.options.globalSearch = !this.options.globalSearch;\r\n\r\n    if (this.options.globalSearch) $(event.currentTarget).addClass('active');\r\n    else $(event.currentTarget).removeClass('active');\r\n\r\n    this._runQueryTree();\r\n  }\r\n\r\n  /**\r\n   * Hack to set the Preset header button colours\r\n   */\r\n  _setHeaderButtonColors() {\r\n    const windowHeader = this.element.find('.window-header');\r\n\r\n    const activeColor = 'darkorange';\r\n    const inactiveColor = 'var(--color-text-light-highlight)';\r\n\r\n    windowHeader\r\n      .find('.mass-edit-category-browser-external')\r\n      .css('color', PresetBrowser.CONFIG.externalCompendiums ? activeColor : inactiveColor);\r\n\r\n    windowHeader\r\n      .find('.mass-edit-category-browser-virtual')\r\n      .css('color', PresetBrowser.CONFIG.virtualDirectory ? activeColor : inactiveColor);\r\n\r\n    windowHeader\r\n      .find('.mass-edit-category-browser-scale')\r\n      .css('color', PresetBrowser.CONFIG.autoScale ? activeColor : inactiveColor);\r\n\r\n    windowHeader\r\n      .find('.mass-edit-category-browser-switch')\r\n      .css('color', PresetBrowser.CONFIG.switchLayer ? activeColor : inactiveColor);\r\n  }\r\n\r\n  /**\r\n   * Process JSON menu structure into Category and CategoryList instances usable by the application\r\n   * @param {object} submenu                An array of JSON objects representing a `Category`\r\n   * @param {Category|null} parentCategory  A `Category` instance that is the parent of the provided submenu\r\n   * @returns\r\n   */\r\n  _processMenu(submenu, parentCategory = null) {\r\n    const categoryList = new CategoryList(parentCategory);\r\n    this._menus.push(categoryList);\r\n\r\n    submenu.forEach((category) => {\r\n      const { title, fa, img, submenu, query } = category;\r\n      const cat = new Category({ title, fa, img, menu: categoryList, query });\r\n      if (submenu?.length) cat.submenu = this._processMenu(submenu, cat);\r\n      categoryList.categories.push(cat);\r\n      this._categories.set(cat.id, cat);\r\n    });\r\n\r\n    return categoryList;\r\n  }\r\n\r\n  /**\r\n   * Handle category click event\r\n   * @param {*} event\r\n   */\r\n  async _onClickCategory(event) {\r\n    const category = this._categories.get($(event.currentTarget).data('id'));\r\n\r\n    this._menus.forEach((menu) => (menu.active = false));\r\n    if (category.active) this._setCategoryInactive(category);\r\n    else this._setCategoryActive(category);\r\n\r\n    this._presetResults = null;\r\n    await this.render(true);\r\n    this._runQueryTree();\r\n  }\r\n\r\n  /**\r\n   * Set provided category as active, turning on/off relevant menus and categories\r\n   * @param {Category} category\r\n   */\r\n  _setCategoryActive(category) {\r\n    category.menu.active = true;\r\n    category.menu.categories.forEach((cat) => (cat.active = false));\r\n    category.active = true;\r\n\r\n    let parentCategory = category.menu.parentCategory;\r\n    while (parentCategory) {\r\n      parentCategory.menu.active = true;\r\n      parentCategory = parentCategory.menu.parentCategory;\r\n    }\r\n\r\n    let submenu = category.submenu;\r\n    while (submenu) {\r\n      submenu.active = true;\r\n      submenu = submenu.categories.find((category) => category.active)?.submenu;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set provided category as inactive, turning off relevant menus and categories\r\n   * @param {Category} category\r\n   */\r\n  _setCategoryInactive(category) {\r\n    category.active = false;\r\n    category.menu.active = true;\r\n\r\n    let parentCategory = category.menu.parentCategory;\r\n    while (parentCategory) {\r\n      parentCategory.menu.active = true;\r\n      parentCategory = parentCategory.menu.parentCategory;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run queries for active categories and renders the results\r\n   * @param {String} search\r\n   * @param {Boolean} global\r\n   * @returns\r\n   */\r\n  async _runQueryTree() {\r\n    const runTime = new Date().getTime();\r\n    this._queryRunTime = runTime;\r\n    this._presetResults = null;\r\n\r\n    await this._renderContent(true);\r\n\r\n    const queries = [];\r\n\r\n    if (this._lastSearch && this.options.globalSearch) {\r\n      queries.push(this._lastSearch);\r\n    } else {\r\n      for (const menu of this._menus) {\r\n        if (!menu.active) continue;\r\n        const category = menu.categories.find((category) => category.active);\r\n        if (category?.query?.trim()) queries.push(category.query);\r\n      }\r\n      if (this._lastSearch && queries.length) queries.push(this._lastSearch);\r\n    }\r\n\r\n    let results;\r\n    if (queries.length) {\r\n      for (const query of queries) {\r\n        if (this._queryRunTime !== runTime) return;\r\n        results = await this._runQuery(query, false, results);\r\n      }\r\n    }\r\n\r\n    if (this._queryRunTime !== runTime) return;\r\n    this._presetResults = results;\r\n\r\n    return this._renderContent();\r\n  }\r\n\r\n  /**\r\n   * Render query results\r\n   * @param {Boolean} loading if true a rotating spinner will be rendered instead of query results\r\n   * @returns\r\n   */\r\n  async _renderContent(loading = false) {\r\n    if (loading) {\r\n      this.element.find('.item-list').html(\r\n        `<div style=\"width: 100%; height: 100%; text-align: center; font-size: xxx-large;\">\r\n            <i class=\"fa-duotone fa-solid fa-spinner fa-spin-pulse\" style=\"position: relative; top: 30%;\"></i>\r\n           </div>`\r\n      );\r\n    } else {\r\n      return super._renderContent({ presets: this._presetResults });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run a search query and returns the results\r\n   * @param {String} query                Query to be ran\r\n   * @param {Boolean} matchAny            Should any tag match be returned?\r\n   * @param {Array[Presets]|null} presets If provided search will be carried out on this preset array instead of all presets\r\n   * @returns {Array[Presets]|null}       Query results\r\n   */\r\n  async _runQuery(query, matchAny = false, presets) {\r\n    return PresetAPI.getPresets({\r\n      query,\r\n      matchAny,\r\n      virtualDirectory: PresetBrowser.CONFIG.virtualDirectory,\r\n      externalCompendiums: PresetBrowser.CONFIG.externalCompendiums,\r\n      full: false,\r\n      presets,\r\n    });\r\n  }\r\n\r\n  /** @override */\r\n  setPosition(...args) {\r\n    super.setPosition(...args);\r\n\r\n    const { left, top, width, height } = this.position;\r\n    CategoryBrowserApplication.previousPositions[this._browserId] = { left, top, width, height };\r\n  }\r\n\r\n  async close(options = {}) {\r\n    if (this.options.retainState) {\r\n      CategoryBrowserApplication.oldMenuStates[this._browserId] = {\r\n        menus: this._menus,\r\n        categories: this._categories,\r\n        lastSearch: this._lastSearch,\r\n        globalSearch: this.options.globalSearch,\r\n      };\r\n    }\r\n\r\n    return super.close(options);\r\n  }\r\n\r\n  async _toggleSetting(setting, runQueryTree = false) {\r\n    await PresetBrowser.setSetting(setting, !PresetBrowser.CONFIG[setting]);\r\n    this._setHeaderButtonColors();\r\n    if (runQueryTree) return this._runQueryTree();\r\n  }\r\n\r\n  _getHeaderButtons() {\r\n    const buttons = super._getHeaderButtons();\r\n\r\n    if (game.user.isGM) {\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-category-browser-virtual',\r\n        icon: 'fas fa-file-search',\r\n        onclick: () => this._toggleSetting('virtualDirectory', true),\r\n      });\r\n\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-category-browser-external',\r\n        icon: 'fa-solid fa-books',\r\n        onclick: () => this._toggleSetting('externalCompendiums', true),\r\n      });\r\n\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-category-browser-scale',\r\n        icon: 'fa-solid fa-arrow-down-big-small',\r\n        onclick: () => this._toggleSetting('autoScale'),\r\n      });\r\n\r\n      buttons.unshift({\r\n        label: '',\r\n        class: 'mass-edit-category-browser-switch',\r\n        icon: 'fa-solid fa-arrows-cross',\r\n        onclick: () => this._toggleSetting('switchLayer'),\r\n      });\r\n    }\r\n\r\n    return buttons;\r\n  }\r\n}\r\n","import { pasteData, showMassEdit, showGenericForm, getMassEditForm } from './applications/multiConfig.js';\r\nimport {\r\n  activeEffectPresetSelect,\r\n  createDocuments,\r\n  isResponsibleGM,\r\n  resolveCreateDocumentRequest,\r\n  TagInput,\r\n} from './scripts/utils.js';\r\nimport { libWrapper } from './scripts/shim/shim.js';\r\nimport { enableUniversalSelectTool } from './scripts/tools/selectTool.js';\r\nimport { META_INDEX_ID, PresetAPI, PresetCollection } from './scripts/presets/collection.js';\r\nimport { openPresetBrowser, registerPresetBrowserHooks } from './scripts/presets/browser/browserApp.js';\r\nimport { registerKeybinds, registerSettings } from './scripts/settings.js';\r\nimport { Picker } from './scripts/picker.js';\r\nimport { BrushMenu, activateBrush, deactivateBush, openBrushMenu } from './scripts/brush.js';\r\nimport { V12Migrator } from './scripts/presets/migration.js';\r\nimport { deleteFromClipboard, performMassSearch, performMassUpdate } from './applications/formUtils.js';\r\nimport { importSceneCompendium, registerSideBarPresetDropListener } from './scripts/presets/utils.js';\r\nimport { LinkerAPI, registerLinkerHooks } from './scripts/linker/linker.js';\r\nimport { MODULE_ID, PIVOTS } from './scripts/constants.js';\r\nimport { registerScenescapeHooks, Scenescape } from './scripts/scenescape/scenescape.js';\r\nimport { Spawner } from './scripts/presets/spawner.js';\r\nimport { registerBehaviors } from './scripts/behaviors/behaviors.js';\r\nimport { openBag } from './scripts/presets/bagApp.js';\r\nimport { openCategoryBrowser } from './scripts/presets/categoryBrowserApp.js';\r\nimport { PresetContainer, registerPresetHandlebarPartials } from './scripts/presets/containerApp.js';\r\nimport { FileIndexerAPI } from './scripts/presets/fileIndexer.js';\r\n\r\n// Initialize module\r\nHooks.once('init', () => {\r\n  //Register region behaviors\r\n  registerBehaviors();\r\n\r\n  // Allow users to drop AmbientSound presets onto playlists\r\n  registerSideBarPresetDropListener();\r\n\r\n  // Linker related hooks\r\n  registerLinkerHooks();\r\n\r\n  // TODO: Replace with core v12 implementation of tag HTML element\r\n  TagInput.registerHandlebarsHelper();\r\n\r\n  // Partials used for Preset rendering\r\n  registerPresetHandlebarPartials();\r\n\r\n  // Enable select tool for all layers\r\n  enableUniversalSelectTool();\r\n\r\n  // Settings/Keybindings\r\n  registerSettings();\r\n  registerKeybinds();\r\n\r\n  // Scenescapes\r\n  registerScenescapeHooks();\r\n\r\n  // Register copy-paste wrappers\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onCopy',\r\n    function (wrapped, ...args) {\r\n      if (window.getSelection().toString() === '') {\r\n        // Check if a Mass Config form is open and if so copy data from there\r\n        const meForm = getMassEditForm();\r\n        if (meForm?.performMassCopy()) return true;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      // Clear Mass Edit clipboard to allows core pasting again\r\n      if (result) deleteFromClipboard(canvas.activeLayer.constructor.documentName);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'ClientKeybindings._onPaste',\r\n    function (wrapped, ...args) {\r\n      if (pasteData()) return true;\r\n      return wrapped(...args);\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Register mouse wheel wrapper to scale/rotate preset previews\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'MouseManager.prototype._onWheel',\r\n    function (wrapped, ...args) {\r\n      const event = args[0];\r\n\r\n      if (\r\n        (Picker.isActive() || BrushMenu.isActive()) &&\r\n        (event.ctrlKey ||\r\n          event.shiftKey ||\r\n          event.metaKey ||\r\n          event.altKey ||\r\n          game.keyboard.downKeys.has('KeyZ') ||\r\n          game.keyboard.downKeys.has('Space'))\r\n      ) {\r\n        // Prevent zooming the entire browser window\r\n        if (event.ctrlKey || event.altKey) event.preventDefault();\r\n\r\n        let dy = (event.delta = event.deltaY);\r\n        if (event.shiftKey && dy === 0) {\r\n          dy = event.delta = event.deltaX;\r\n        }\r\n        if (dy === 0) return;\r\n\r\n        if (event.altKey || game.keyboard.downKeys.has('Space')) Picker.addScaling(event.delta < 0 ? 0.05 : -0.05);\r\n        else if ((event.ctrlKey || event.metaKey) && event.shiftKey) BrushMenu.iterate(event.delta >= 0, true);\r\n        else if (event.ctrlKey || event.metaKey) Picker.addRotation(event.delta < 0 ? 2.5 : -2.5);\r\n        else if (event.shiftKey) Picker.addRotation(event.delta < 0 ? 15 : -15);\r\n        else if (game.keyboard.downKeys.has('KeyZ')) {\r\n          let delta = event.delta < 0 ? 1 : -1;\r\n          if (Scenescape.active) delta = delta * Scenescape.depth * 0.01;\r\n          Picker.addElevation(delta);\r\n        }\r\n        return;\r\n      }\r\n\r\n      const result = wrapped(...args);\r\n      return result;\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Prevent placeable highlighting if a preview is active either via a Picker or BrushMenu\r\n  libWrapper.register(\r\n    MODULE_ID,\r\n    'Canvas.prototype.highlightObjects',\r\n    function (wrapped, ...args) {\r\n      if (Picker.isActive() || BrushMenu.isActive()) return;\r\n      return wrapped(...args);\r\n    },\r\n    'MIXED'\r\n  );\r\n\r\n  // Add SceneControl option to open Mass Edit form\r\n  if (game.settings.get(MODULE_ID, 'presetSceneControl')) {\r\n    libWrapper.register(\r\n      MODULE_ID,\r\n      'SceneNavigation.prototype._getContextMenuOptions',\r\n      function (wrapped, ...args) {\r\n        const options = wrapped(...args);\r\n        options.push({\r\n          name: 'Mass Edit',\r\n          icon: '<i class=\"fa-solid fa-pen-to-square\"></i>',\r\n          condition: game.user.isGM,\r\n          callback: (li) => {\r\n            const sceneId = li.attr('data-scene-id');\r\n            showMassEdit(game.scenes.get(sceneId));\r\n          },\r\n        });\r\n        return options;\r\n      },\r\n      'WRAPPER'\r\n    );\r\n  }\r\n\r\n  registerPresetBrowserHooks();\r\n\r\n  // Handle broadcasts\r\n  // Needed to allow players to spawn Presets by delegating create document request to GMs\r\n  game.socket?.on(`module.${MODULE_ID}`, async (message) => {\r\n    const args = message.args;\r\n\r\n    if (message.handlerName === 'document' && message.type === 'UPDATE') {\r\n      if (!isResponsibleGM()) return;\r\n\r\n      game.scenes.get(args.sceneID).updateEmbeddedDocuments(args.documentName, args.updates, args.context);\r\n    } else if (message.handlerName === 'document' && message.type === 'CREATE') {\r\n      if (!isResponsibleGM()) return;\r\n\r\n      const documents = await createDocuments(args.documentName, args.data, args.sceneID, args.options);\r\n      const documentIDs = documents.map((d) => d.id);\r\n\r\n      const message = {\r\n        handlerName: 'document',\r\n        args: {\r\n          requestID: args.requestID,\r\n          sceneID: args.sceneID,\r\n          documentName: args.documentName,\r\n          documentIDs,\r\n        },\r\n        type: 'RESOLVE',\r\n      };\r\n      game.socket.emit(`module.${MODULE_ID}`, message);\r\n    } else if (message.handlerName === 'document' && message.type === 'DELETE') {\r\n      if (!isResponsibleGM()) return;\r\n      game.scenes.get(args.sceneId).deleteEmbeddedDocuments(args.embedName, args.ids);\r\n    } else if (message.handlerName === 'document' && message.type === 'RESOLVE') {\r\n      resolveCreateDocumentRequest(args);\r\n    }\r\n  });\r\n\r\n  // 'Spotlight Omnisearch' support\r\n  Hooks.on('spotlightOmnisearch.indexBuilt', (INDEX, promises) => {\r\n    if (!game.user.isGM) return;\r\n    // First turn-off preset compendium from being included in omnisearch indexing\r\n    const old = game.settings.get('spotlight-omnisearch', 'compendiumConfig');\r\n    game.packs\r\n      .filter((p) => p.documentName === 'JournalEntry' && p.index.get(META_INDEX_ID))\r\n      .forEach((p) => (old[p.collection] = false));\r\n    game.settings.set('spotlight-omnisearch', 'compendiumConfig', old);\r\n\r\n    // Insert preset index\r\n    const promise = PresetCollection.buildSpotlightOmnisearchIndex(INDEX);\r\n    promises.push(promise);\r\n  });\r\n\r\n  globalThis.MassEdit = {\r\n    showGenericForm,\r\n    performMassUpdate,\r\n    performMassSearch,\r\n    showMassEdit,\r\n    getPreset: PresetAPI.getPreset,\r\n    getPresets: PresetAPI.getPresets,\r\n    createPreset: PresetAPI.createPreset,\r\n    spawnPreset: Spawner.spawnPreset,\r\n    activateBrush: activateBrush,\r\n    openBag,\r\n    openCategoryBrowser,\r\n    deactivateBrush: deactivateBush,\r\n    openBrushMenu: openBrushMenu,\r\n    migratePack: (pack, options = {}) => V12Migrator.migratePack(pack, options),\r\n    migrateAllPacks: (options = {}) => V12Migrator.migrateAllPacks(options),\r\n    linker: LinkerAPI,\r\n    PIVOTS: PIVOTS,\r\n    PresetContainer,\r\n    importSceneCompendium,\r\n    openPresetBrowser,\r\n    FileIndexerAPI,\r\n  };\r\n\r\n  game.modules.get(MODULE_ID).api = {\r\n    ...globalThis.MassEdit,\r\n  };\r\n});\r\n\r\n// Deactivate brush/picker on scene change\r\n\r\nHooks.on('canvasReady', () => {\r\n  if (BrushMenu.isActive()) BrushMenu.close();\r\n  else if (Picker.isActive()) Picker.destroy();\r\n});\r\n\r\n// Attach Mass Config buttons to Token and Tile HUDs\r\nHooks.on('renderTokenHUD', (hud, html, tokenData) => {\r\n  if (canvas.tokens.controlled.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"config\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\nHooks.on('renderTileHUD', (hud, html, tileData) => {\r\n  const controlledTiles = canvas.background\r\n    ? canvas.background.controlled.concat(canvas.foreground.controlled)\r\n    : canvas.tiles.controlled;\r\n\r\n  if (controlledTiles.length >= 2) {\r\n    $(html)\r\n      .find('.control-icon[data-action=\"underfoot\"]')\r\n      .after(\r\n        `<div class=\"control-icon\" data-action=\"massConfig\">\r\n          <i class=\"fas fa-cogs\"></i>\r\n        </div>`\r\n      );\r\n    $(html).on('click', '[data-action=\"massConfig\"]', () => {\r\n      showMassEdit();\r\n    });\r\n  }\r\n});\r\n\r\nHooks.on('renderActiveEffectConfig', (app) => {\r\n  const el = $(app.form).find('.effects-header .key');\r\n  if (el.length) {\r\n    const me = $('<i title=\"Apply \\'Mass Edit\\' preset\" style=\"font-size:smaller;color:brown;\"> <a>[ME]</a></i>');\r\n    me.on('click', () => activeEffectPresetSelect(app));\r\n    el.append(me);\r\n  }\r\n});\r\n","import { MODULE_ID } from '../constants.js';\r\nimport { DeSpawnPresetBehaviorType } from './DeSpawnPresetRegionBehaviorType.js';\r\nimport { LinkTokenRegionBehaviorType } from './LinkTokenRegionBehaviorType.js';\r\nimport { SpawnPresetBehaviorType } from './SpawnPresetRegionBehaviorType.js';\r\n\r\n/**\r\n * Register custom behaviors\r\n */\r\nexport function registerBehaviors() {\r\n  Object.assign(CONFIG.RegionBehavior.dataModels, {\r\n    [`${MODULE_ID}.linkToken`]: LinkTokenRegionBehaviorType,\r\n    [`${MODULE_ID}.spawnPreset`]: SpawnPresetBehaviorType,\r\n    [`${MODULE_ID}.deSpawnPreset`]: DeSpawnPresetBehaviorType,\r\n  });\r\n\r\n  Object.assign(CONFIG.RegionBehavior.typeIcons, {\r\n    [`${MODULE_ID}.linkToken`]: 'fas fa-link',\r\n    [`${MODULE_ID}.spawnPreset`]: 'fa-solid fa-books',\r\n    [`${MODULE_ID}.deSpawnPreset`]: 'fa-duotone fa-books',\r\n  });\r\n}\r\n","import CSSEdit, { STYLES } from '../applications/cssEdit.js';\r\nimport { copyToClipboard } from '../applications/formUtils.js';\r\nimport { MassEditGenericForm } from '../applications/generic/genericForm.js';\r\nimport {\r\n  getMassEditForm,\r\n  getSelected,\r\n  pasteData,\r\n  showMassActorForm,\r\n  showMassEdit,\r\n  showMassSelect,\r\n} from '../applications/multiConfig.js';\r\nimport { MODULE_ID, SUPPORTED_COLLECTIONS, SUPPORTED_PLACEABLES, THRESHOLDS } from './constants.js';\r\nimport { LinkerAPI } from './linker/linker.js';\r\nimport { editPreviewPlaceables, Picker } from './picker.js';\r\nimport { PresetCollection } from './presets/collection.js';\r\nimport { openPresetBrowser, PresetBrowser } from './presets/browser/browserApp.js';\r\nimport { Preset } from './presets/preset.js';\r\nimport { Scenescape } from './scenescape/scenescape.js';\r\nimport { enablePixelPerfectSelect } from './tools/selectTool.js';\r\nimport { activeEffectPresetSelect, getDocumentName, localize, TagInput } from './utils.js';\r\n\r\nexport function registerSettings() {\r\n  // Register Settings\r\n\r\n  game.settings.register(MODULE_ID, 'debug', {\r\n    scope: 'client',\r\n    config: false,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'cssStyle', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'Default',\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'cssCustom', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: STYLES.Default,\r\n  });\r\n\r\n  game.settings.registerMenu(MODULE_ID, 'cssEdit', {\r\n    name: localize('settings.cssEdit.name'),\r\n    hint: localize('settings.cssEdit.hint'),\r\n    label: '',\r\n    scope: 'world',\r\n    icon: 'fas fa-cog',\r\n    type: CSSEdit,\r\n    restricted: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'singleDocDefaultConfig', {\r\n    name: localize('settings.singleDocDefaultConfig.name'),\r\n    hint: localize('settings.singleDocDefaultConfig.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'rangeToTextbox', {\r\n    name: localize('settings.rangeToTextbox.name'),\r\n    hint: localize('settings.rangeToTextbox.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'indexer', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      indexDirs: [\r\n        { target: 'modules', source: 'data' },\r\n        { target: 'sounds', source: 'public' },\r\n      ],\r\n      cacheDir: { target: '', source: 'data' },\r\n      overrideTags: false,\r\n      ignoreExternal: false,\r\n      fileFilters: ['Thumb', '-thumb', 'Thumbnail', 'thumbnail'],\r\n      folderFilters: ['Thumb', 'thumb'],\r\n    },\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'pixelPerfectAlpha', {\r\n    name: 'Pixel Perfect Hover: Alpha Threshold',\r\n    hint: 'The lower the value the more transparent a pixel can be while still being recognised as hovered over.',\r\n    scope: 'world',\r\n    config: true,\r\n    type: new foundry.data.fields.NumberField({\r\n      required: true,\r\n      min: 0.0,\r\n      max: 1,\r\n      step: 0.01,\r\n      initial: THRESHOLDS.PIXEL_PERFECT_ALPHA,\r\n    }),\r\n    onChange: (val) => {\r\n      THRESHOLDS.PIXEL_PERFECT_ALPHA = val;\r\n    },\r\n  });\r\n  THRESHOLDS.PIXEL_PERFECT_ALPHA = game.settings.get(MODULE_ID, 'pixelPerfectAlpha');\r\n\r\n  ['pixelPerfectTile', 'pixelPerfectToken'].forEach((setting) => {\r\n    game.settings.register(MODULE_ID, setting, {\r\n      scope: 'client',\r\n      config: false,\r\n      type: Boolean,\r\n      default: false,\r\n      onChange: enablePixelPerfectSelect,\r\n    });\r\n  });\r\n\r\n  // ===============\r\n  // Preset Settings\r\n\r\n  game.settings.register(MODULE_ID, 'workingPack', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: String,\r\n    default: 'world.mass-edit-presets-main',\r\n    onChange: (val) => {\r\n      PresetCollection.workingPack = val;\r\n    },\r\n  });\r\n  PresetCollection.workingPack = game.settings.get(MODULE_ID, 'workingPack');\r\n\r\n  game.settings.register(MODULE_ID, 'presetSceneControl', {\r\n    name: 'Scene Controls: Preset Button',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n    onChange: () => {\r\n      ui.controls.render();\r\n    },\r\n  });\r\n\r\n  // Consolidated preset browser settings\r\n  game.settings.register(MODULE_ID, 'presetBrowser', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      dropdownDocuments: [],\r\n      persistentSearch: true,\r\n      searchMode: 'pf', // p = preset only | pf = preset & folder\r\n      sortMode: 'manual', // manual | alphabetical\r\n      autoScale: true,\r\n      virtualDirectory: true,\r\n      externalCompendiums: true,\r\n      switchLayer: true,\r\n      documentLock: '',\r\n      dropdownDocuments: ['MeasuredTemplate', 'Note', 'Region'],\r\n    },\r\n    onChange: (val) => {\r\n      PresetBrowser.CONFIG = val;\r\n    },\r\n  });\r\n  PresetBrowser.CONFIG = game.settings.get(MODULE_ID, 'presetBrowser');\r\n\r\n  /**\r\n   * Preset bags\r\n   */\r\n  game.settings.register(MODULE_ID, 'bags', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'presetFavorites', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // Convert settings based bags to Preset Bags\r\n  // TODO: Remove after sufficient time has passed for users to have run this\r\n  // 25/11/2024\r\n  const favorites = game.settings.get(MODULE_ID, 'presetFavorites');\r\n  const bags = game.settings.get(MODULE_ID, 'bags');\r\n  if (!foundry.utils.isEmpty(favorites)) {\r\n    let sort = -1;\r\n    const presets = Object.keys(favorites).map((uuid) => {\r\n      sort++;\r\n      return { uuid, sort };\r\n    });\r\n\r\n    bags['FAVORITES'] = { presets, name: 'FAVORITES' };\r\n  }\r\n\r\n  if (!foundry.utils.isEmpty(bags)) {\r\n    const presets = [];\r\n    for (let [id, bag] of Object.entries(bags)) {\r\n      let searchesInclusive = [];\r\n      if (bag.tags?.length) {\r\n        searchesInclusive.push({\r\n          terms: '#' + bag.tags.join(' #'),\r\n          matchAll: false,\r\n        });\r\n      }\r\n\r\n      presets.push(\r\n        new Preset({\r\n          name: 'Bag: ' + bag.name ?? id,\r\n          tags: ['id-' + TagInput.simplifyString(id)],\r\n          documentName: 'Bag',\r\n          img: `icons/containers/bags/pack-engraved-leather-tan.webp`,\r\n          data: [\r\n            {\r\n              uuids: bag.presets,\r\n              searches: {\r\n                inclusive: searchesInclusive,\r\n                exclusive: [],\r\n              },\r\n              virtualDirectory: true,\r\n            },\r\n          ],\r\n        })\r\n      );\r\n    }\r\n\r\n    if (presets.length) {\r\n      setTimeout(() => {\r\n        if (game.user?.isGM) {\r\n          PresetCollection.set(presets);\r\n          game.settings.set(MODULE_ID, 'bags', {});\r\n          game.settings.set(MODULE_ID, 'presetFavorites', {});\r\n        }\r\n      }, 10000);\r\n    }\r\n  }\r\n\r\n  // end of Preset Settings\r\n  // ======================\r\n\r\n  game.settings.register(MODULE_ID, 'pinnedFields', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'customControls', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {},\r\n  });\r\n\r\n  // Disable until duplicate flag value bug is fixed\r\n  // game.settings.register(MODULE_ID, 'enableFlagsTab', {\r\n  //   name: localize('settings.enableFlagsTab.name'),\r\n  //   hint: localize('settings.enableFlagsTab.hint'),\r\n  //   scope: 'world',\r\n  //   config: true,\r\n  //   type: Boolean,\r\n  //   default: true,\r\n  // });\r\n\r\n  game.settings.register(MODULE_ID, 'autoSnap', {\r\n    name: localize('settings.autoSnap.name'),\r\n    hint: localize('settings.autoSnap.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'panToSearch', {\r\n    name: localize('settings.panToSearch.name'),\r\n    hint: localize('settings.panToSearch.hint'),\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: true,\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'preSelectAutoApply', {\r\n    name: 'Pre-Select Auto-apply',\r\n    hint: 'Should the auto-apply button be ticked by default on Mass Edit forms.',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n  });\r\n\r\n  if (game.modules.get('tokenmagic')?.active) {\r\n    game.settings.register(MODULE_ID, 'tmfxFieldsEnable', {\r\n      name: localize('settings.tmfxFieldsEnable.name'),\r\n      hint: localize('settings.tmfxFieldsEnable.hint'),\r\n      scope: 'world',\r\n      config: true,\r\n      type: Boolean,\r\n      default: true,\r\n    });\r\n  }\r\n\r\n  game.settings.register(MODULE_ID, 'disablePixelPerfectHoverButton', {\r\n    name: `Pixel Perfect Hover: Remove Button`,\r\n    hint: 'When enabled `Pixel Perfect Hover` toggle will be removed from Token and Tile layer controls.',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Boolean,\r\n    default: false,\r\n    onChange: () => {\r\n      ui.controls.controls = ui.controls._getControlButtons();\r\n      ui.controls.render(true);\r\n    },\r\n  });\r\n\r\n  game.settings.register(MODULE_ID, 'brush', {\r\n    scope: 'world',\r\n    config: false,\r\n    type: Object,\r\n    default: {\r\n      scale: [1, 1],\r\n      rotation: [0, 0],\r\n      random: true,\r\n      group: false,\r\n      spawner: true,\r\n      eraser: false,\r\n      lock: false,\r\n      snap: false,\r\n      scaleToGrid: true,\r\n    },\r\n  });\r\n}\r\n\r\nexport function registerKeybinds() {\r\n  game.keybindings.register(MODULE_ID, 'linker', {\r\n    name: localize('keybindings.linkerMenu.name'),\r\n    hint: localize('keybindings.linkerMenu.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyQ',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.openMenu();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'smartLink', {\r\n    name: 'Smart Link',\r\n    hint: 'Initiate smart document linking.',\r\n    editable: [\r\n      {\r\n        key: 'KeyL',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.smartLink({ multiLayer: !Boolean(LinkerAPI._getSelected().length) });\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'smartUnlink', {\r\n    name: 'Smart Un-Link',\r\n    hint: 'Initiate smart document un-linking.',\r\n    editable: [\r\n      {\r\n        key: 'KeyU',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      LinkerAPI.removeLinksFromSelected({ notification: true, multiLayer: !Boolean(LinkerAPI._getSelected().length) });\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'deleteAllLinked', {\r\n    name: 'Delete Selected: Ignore Links',\r\n    hint: 'Deletes currently selected placeable without removing any placeables linked to it via the `Linker Menu`',\r\n    editable: [\r\n      {\r\n        key: 'Delete',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const selected = LinkerAPI._getSelected().map((s) => s.document);\r\n      canvas.scene.deleteEmbeddedDocuments(\r\n        selected[0].documentName,\r\n        selected.map((s) => s.id),\r\n        { linkerDelete: true }\r\n      );\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'placeablePreviewEdit', {\r\n    name: localize('keybindings.placeableEdit.name'),\r\n    hint: localize('keybindings.placeableEdit.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyD',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: async (event) => {\r\n      let editing = false;\r\n\r\n      if (game.user.isGM) editing = await editPreviewPlaceables();\r\n      else {\r\n        // Move That For You module support\r\n        if (\r\n          canvas.tiles.controlled.length &&\r\n          canvas.tiles.controlled.every((t) => t.document.allowPlayerMove?.() && t.document.allowPlayerRotate?.())\r\n        ) {\r\n          editing = await editPreviewPlaceables(canvas.tiles.controlled);\r\n        }\r\n      }\r\n      if (editing) event.event.preventDefault();\r\n    },\r\n    restricted: false,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.PRIORITY,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'mirrorX', {\r\n    name: 'Mirror Preview Horizontally',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyH',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => Picker.mirrorX(),\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'mirrorY', {\r\n    name: 'Mirror Preview Vertically',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyV',\r\n        modifiers: [],\r\n      },\r\n    ],\r\n    onDown: () => Picker.mirrorY(),\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'editKey', {\r\n    name: localize('keybindings.editKey.name'),\r\n    hint: localize('keybindings.editKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyE',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = getMassEditForm();\r\n      if (app) {\r\n        app.close();\r\n        return;\r\n      }\r\n      showMassEdit();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'copyKey', {\r\n    name: localize('common.copy'),\r\n    hint: 'Copy data from within an opened Mass Edit form OR the selected and all linked placeables.',\r\n    editable: [\r\n      {\r\n        key: 'KeyC',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      // Check if a Mass Config form is open and if so copy data from there\r\n      if (window.getSelection().toString() === '') {\r\n        const app = Object.values(ui.windows).find((app) => app.meObjects != null);\r\n        if (app) return app.performMassCopy();\r\n      }\r\n\r\n      // If no form is open attempt to copy the selected placeable and its linked placeables\r\n      const selected = LinkerAPI._getSelected().map((s) => s.document);\r\n      if (selected.length) {\r\n        const linked = Array.from(\r\n          LinkerAPI.getHardLinkedDocuments(selected).filter((l) => !selected.find((s) => s.id === l.id))\r\n        );\r\n\r\n        const preset = new Preset({\r\n          documentName: selected[0].documentName,\r\n          data: selected.map((s) => s.toObject()),\r\n          attached: linked.map((l) => {\r\n            return { documentName: l.documentName, data: l.toObject() };\r\n          }),\r\n        });\r\n        copyToClipboard(preset);\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'pasteKey', {\r\n    name: localize('common.paste'),\r\n    hint: 'Paste data onto selected placeables or spawn it as a new placeable.',\r\n    editable: [\r\n      {\r\n        key: 'KeyV',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      pasteData();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'selectKey', {\r\n    name: localize('keybindings.selectKey.name'),\r\n    hint: localize('keybindings.selectKey.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyF',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      showMassSelect();\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApply', {\r\n    name: localize('keybindings.presetApply.name'),\r\n    hint: localize('keybindings.presetApply.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyX',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof PresetBrowser);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n\r\n      // Special logic for populating Active Effect\r\n      const aeConfig = Object.values(ui.windows).find((x) => x instanceof ActiveEffectConfig);\r\n      if (aeConfig) {\r\n        activeEffectPresetSelect(aeConfig);\r\n        return;\r\n      }\r\n\r\n      const documentName = canvas.activeLayer.constructor.documentName;\r\n      if (!SUPPORTED_PLACEABLES.includes(documentName)) return;\r\n      openPresetBrowser(documentName);\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'presetApplyScene', {\r\n    name: localize('keybindings.presetApplyScene.name'),\r\n    hint: localize('keybindings.presetApplyScene.hint'),\r\n    editable: [],\r\n    onDown: () => {\r\n      const app = Object.values(ui.windows).find((w) => w instanceof PresetBrowser);\r\n      if (app) {\r\n        app.close(true);\r\n        return;\r\n      }\r\n      openPresetBrowser('Scene');\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'genericFormKey', {\r\n    name: localize('keybindings.genericForm.name'),\r\n    hint: localize('keybindings.genericForm.hint'),\r\n    editable: [\r\n      {\r\n        key: 'KeyR',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      let [target, selected] = getSelected(null, false);\r\n      if (!target) return;\r\n      const documentName = getDocumentName(target);\r\n      if (![...SUPPORTED_COLLECTIONS, 'Token'].includes(documentName)) return;\r\n\r\n      if (documentName === 'Token') {\r\n        showMassActorForm(selected, { massEdit: true });\r\n      } else {\r\n        new MassEditGenericForm(selected, { massEdit: true, documentName }).render(true);\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n\r\n  game.keybindings.register(MODULE_ID, 'autoScale', {\r\n    name: 'Scenescape: Toggle Auto-scaling',\r\n    hint: '',\r\n    editable: [\r\n      {\r\n        key: 'KeyZ',\r\n        modifiers: ['Shift'],\r\n      },\r\n    ],\r\n    onDown: () => {\r\n      if (Picker.isActive()) {\r\n        Scenescape.autoScale = !Scenescape.autoScale;\r\n        ui.notifications.info('Scenescape: Autoscale => ' + (Scenescape.autoScale ? 'ON' : 'OFF'));\r\n      }\r\n    },\r\n    restricted: true,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL,\r\n  });\r\n}\r\n"],"names":["leafPrototypes","getProto","inProgress","dataWebpackPrefix","getInUseStyle","styleInUse","game","settings","get","STYLES","CSSEdit","FormApplication","constructor","super","defaultOptions","foundry","utils","mergeObject","id","classes","template","resizable","minimizable","title","width","height","getData","options","data","css","styles","Object","keys","push","disableCSS","activateListeners","html","$","on","event","target","value","find","val","prop","_updateObject","formData","selectedStyle","set","Default","performMassSearch","command","documentName","selectedFields","scope","selected","control","pan","found","performDocSearch","includes","Array","from","collections","scenes","canvas","scene","performMassSearchScene","activeLayer","controlled","map","c","forEach","release","setTimeout","f","obj","object","releaseOthers","length","docs","matches","flattenObject","toObject","dataToForm","k","v","entries","startsWith","modes","values","expandObject","detectionModes","detectionModeMatch","async","performMassUpdate","objects","applyType","this","simplified","callback","isEmpty","callbackOnUpdate","updates","context","total","o","document","i","update","deepClone","_id","randomizeFields","addSubtractFields","field","ctrl","currentTags","isArray","split","s","trim","modTags","tag","method","index","indexOf","splice","filter","t","join","type","toAdd","replace","min","max","applyAddSubtract","formToData","checkApplySpecialFields","tokens","actor","Scene","updateDocuments","splitUpdates","parent","sceneUpdate","updateEmbeddedDocuments","isPrototype","sceneId","actorUpdates","prototypeToken","Actor","hasOwnProperty","TokenMagic","scale","flags","depth","onInputChange","className","checked","deselectTabs","meChk","closest","selectTabs","massEdit","_performOnInputChangeUpdate","modUpdate","tab","siblings","attr","addClass","removeClass","getCommonDocData","d","getObjFormData","pasteDataUpdate","preset","suppressNotif","excludePosition","transform","getClipboardData","meObjects","randomize","addSubtract","ogData","Math","floor","random","apply","x","y","insertKeys","inplace","elevation","call","ui","notifications","info","count","CLIPBOARD","copyToClipboard","clipboard","copyPlainText","JSON","stringify","deleteFromClipboard","injectVisibility","app","form","hidden","newHtml","tabs","first","append","last","after","genAction","toggle","genToggleUtil","objToString","fields","hasMassEditUpdateDependency","context2","genUpdateWithMassEditDep","macroTracking","macro","genUpdate","genDelete","genTargets","p","genIDTargets","genSelected","genSearch","opts","matchAny","tagger","match","allScenes","tags","genTaggerTargets","genAllTargets","Error","modules","active","mdsClasses","JournalEntry","Playlist","Item","RollTable","Cards","generateMacro","placeables","dep","depWarning","module","hasSpecialField","hasMassEditDependency","genMacroDependencies","select","name","genRunMacro","Macro","create","sheet","render","specialFields","sf","MacroForm","mainObject","selectable","selectScopeEnabled","targetingOptions","label","hasAddSubtract","hasRandom","hasMEControls","hiddenControl","macros","m","_onShowReturnJson","store","parse","content","Dialog","buttons","Ok","hide","setPosition","e","warn","_onRemoveJson","click","contextmenu","toggleFields","update2","change","show","WithBaseMassEditForm","cls","BaseMassEditForm","doc","massSelect","randomizerEnabled","commonData","_setMEActions","isNewerVersion","version","meForm","rangeSpanToTextbox","baseDocument","massUpdateObject","getSelectedFields","correctDetectionModeOrder","presetEdit","modUpdateType","_getSubmitData","getFlag","abs","mirrorX","mirrorY","element","each","_","me_checkbox","is","limits","undefined","removeFlag","getType","input","hasClass","performMassCopy","_setStyle","styleName","prepend","_injectGlobalDeleteButton","buttonA","delete","close","no","default","_activateAutoSelectListeners","bind","_processFormGroup","formGroup","typeOverride","insertRNGControl","fieldType","span","replaceWith","defaultValue","removeAttr","randomControl","checkbox","before","_processAllFormGroups","processFormGroup","_processPreset","timeoutRequired","setFlag","modifyPresetData","_applyPreset","customMerge","obj1","obj2","key","el","trigger","refreshPreset","_registerRandomizerListeners","then","showRandomizeDialog","_registerBrushRefreshListeners","_registerNumericalInputListeners","parseFloat","_registerInputChangeCallback","inputChangeCallback","_registerNavigationTabMassSelect","dataset","group","meCheckboxes","selecting","not","_insertModuleSpecificFields","_createAction","chk","insertBefore","Levels3DPreview","_insertSpecialFields","getPresets","currentDDTint","scaleInput","_active","hiddenInput","_insertModUpdateCheckboxes","preSelectAutoApply","button","modButton","stopPropagation","isChecked","insertAfter","_registerMutateObserver","MutationObserver","mutations","mutation","addedNodes","node","observe","characterData","attributes","childList","subtree","_onClose","force","deactivate","linkedPresetForm","_openMacroForm","_activateBrushTool","activate","_openEditPermissions","ids","Set","entry","has","add","WithMassPermissions","_openPresetBrowser","left","position","top","preventPositionOverride","_openViewApplyJSON","selFields","json","console","log","_showMassActorForm","actions","action","meMacroGen","meBrush","meEditPermissions","mePresetBrowser","meJSON","meTokenActor","setProperty","_meGetSubmitButtons","icon","n","_getMeControls","class","visible","WithMassEditFormApplicationV2","MassEditForm","_attachFrameListeners","_onRender","FormDataExtended","_prepareSubmitData","_getHeaderControls","concat","_preparePartContext","partId","_prepareContext","b","_options","renderContext","WithMassEditFormApplication","preview","clone","_removeFooterButtons","_insertSubmitButtons","style","wrap","htmlButtons","_meSubmitInserted","footer","_onChangeInput","edit","_onChangeColorPicker","_onChangeRange","meApply","submitter","_resetPreview","_getHeaderButtons","controls","onclick","remove","WithMassEditForm","base","applications","api","ApplicationV2","BASE_APPLICATION","WithMassConfig","sheets","CONFIG","sheetClasses","pop","MEF","MassConfig","constructorName","defineProperty","prototype","DocumentOwnershipConfig","MassPermissions","ownership","metaLevels","CONST","DOCUMENT_META_OWNERSHIP_LEVELS","addMissingPerms","perms","users","u","DEFAULT","flatData","diff","diffObject","massPermissions","user","level","recursive","noHook","CUSTOM_CONTROLS","shieldType","range","step","blend","radius","intensity","lightAlpha","gridPadding","lightSize","animated","time","speed","fire","fireBlend","animType","val2","val1","loopDuration","amplitude","electric","xglow","auraType","auraIntensity","subAuraIntensity","threshold","thickness","glow","outerStrength","innerStrength","padding","alpha","zapshadow","alphaTolerance","sprite","blendMode","scaleX","scaleY","translationX","translationY","rotation","xfire","dispersion","ascii","size","dot","angle","godray","rgbSplit","redX","redY","greenX","greenY","blueX","blueY","polymorph","shadow","blur","flood","billowy","tintIntensity","glint","constructNav","allData","customControls","pins","nav","dataGroup","items","tabSelectors","navSelector","contentSelector","initial","pinned","_constructControls","pinned_groups","flatObject","genControl","dataTab","groups","unshift","containsNav","name2","_hasNonNullKeys","_genLabel","newNav","toUpperCase","charAt","slice","IMAGE_FIELDS","COLOR_FIELDS","isColorField","toLowerCase","editableLabel","allowedArrayElTypes","getProperty","number","colorPickerNumber","colorValue","Color","toString","text","varName","filePicker","colorPicker","boolean","every","array","jsonArray","disabled","WMC","MassEditGenericForm","a","noTabs","editableLabels","pinnedFields","closeCallback","getTemplate","star","editNumber","col","Number","fromString","allControls","docControls","unsetCustomControl","save","defineRangeControl","defineSelectControl","LAYER_MAPPINGS","Token","Tile","Drawing","Wall","AmbientLight","AmbientSound","MeasuredTemplate","Note","SCENE_DOC_MAPPINGS","getControlled","getHover","hover","getSelectedDocuments","placeableSelect","supportedDocs","playlistId","sounds","soundId","documentId","notes","eid","entryId","getSelected","placeable","sort","p1","p2","showMassSelect","basePlaceable","showMassEdit","forceForm","showMassActorForm","selectedTokens","actors","pasteData","spawnPreset","showGenericForm","Promise","resolve","getMassEditForm","windows","instances","Brush","static","Map","_checkDensity","pos","grid","spawnDensity","spawnPoints","sqrt","_performBrushDocumentUpdate","callPostSpawnHooks","documents","updatedPlaceables","BrushMenu","iterate","_performBrushDocumentCreate","now","Date","getTime","lastSpawnTime","Picker","_performBrushDocumentDelete","hoveredPlaceable","_brushDelete","_hitTestWall","point","wall","line","hitArea","contains","_hitTestRegion","region","bounds","_hitTestControlIcon","between","controlIcon","_hitTestTile","foreground","overhead","_hoverTestArea","hBounds","pBounds","_hitTestArea","_onBrushMove","getLocalPosition","brushOverlay","layer","getLayerByEmbeddedName","_clearHover","hitTest","hoverTest","_onHoverOut","_onHoverIn","_onBrushClickMove","spawner","eraser","_on3DBrushClick","z","clear","genPreview","previewOnly","pivot","CENTER","snapToGrid","snap","scaleToGrid","deactivateCallback","refresh","ready","destroy","interaction","renderer","events","cursorStyles","_activate3d","PIXI","Container","dimensions","rect","cursor","interactive","zIndex","Infinity","feedPos","mDownWithinCanvas","nativeEvent","which","stage","addChild","mouseInteractionManager","permissions","clickLeft","mouseMoveCallback","mouseClickCallback","mouseWheelClickCallback","removeChild","addPresets","presets","_instance","isActive","Boolean","removePreset","forward","scrollY","window","innerHeight","_settings","_it","_createIndex","pI","dI","_index","_activateBrush","_applyColor","_applyTmfxPresets","tmfxPreset","_applyTaggerTags","_deactivateCallback","_getTransform","density","randomColor","color","pPath","ddTint","_applyDDTint","filters","tmFilters","filterId","tmFilterId","tmFilterInternalId","randomID","tmFilterType","filterOwner","userId","tmParams","tint","hex2rgb","updateId","rank","enabled","addPostSpawnHook","Tagger","addTags","deleteFilters","presetName","getPreset","addUpdateFilters","activePreset","tmfxActive","taggerActive","rotationRangeLabel","slider","slide","_updateBrushSettings","scaleRangeLabel","densityRangeLabel","_toggleSetting","_resetToDefaults","_onClickPreset","_onRightClickPreset","_onRandomizeColor","_onColorChange","_onColorMenu","_onEditTaglikeField","simplifyTags","listId","listEntries","subMenu","_toggleSubMenu","Handlebars","compile","allowProtoMethodsByDefault","allowProtoPropertiesByDefault","cString","currentTarget","isNaN","valueOf","presetIndex","findIndex","colorTemp","renderTemplate","lockMethod","space","hue","colorSlider","dialog","colors","getColors","ColorSlider","hex","offset","uuid","wasActivePreset","lock","accumulatedTransform","getTransformAccumulator","stepsInRange","_generateBrushMacro","genMacro","img","uuids","resetTransformAccumulator","activateBrush","mode","deactivateBush","openBrushMenu","batchLoadPresets","MODULE_ID","SUPPORTED_PLACEABLES","UI_DOCS","SUPPORTED_SHEET_CONFIGS","SUPPORTED_COLLECTIONS","IMAGE_EXTENSIONS","VIDEO_EXTENSIONS","AUDIO_EXTENSIONS","FILE_EXTENSIONS","LINKER_DOC_ICONS","Region","LINKER_DOC_COLORS","PIVOTS","TOP_LEFT","TOP","TOP_RIGHT","LEFT","RIGHT","BOTTOM_LEFT","BOTTOM","BOTTOM_RIGHT","THRESHOLDS","PIXEL_PERFECT_ALPHA","TokenDataAdapter","updateToForm","token","texture","correctDetectionModes","indexMap","comps","newKey","rVal","searchModes","tokenModes","m1","m2","mergedModes","dm","tdm","pModes","dataClone","modCustomFields","j","startingModeLength","_previewChanges","ADAPTERS","PlaylistSound","PlaylistSoundDataAdapter","AudioHelper","inputToVolume","note","volume","volumeToInput","NoteDataAdapter","src","GeneralDataAdapter","adapter","DataTransformer","origin","_3dActive","transformWall","transformTile","transformNote","transformToken","transformMeasuredTemplate","transformAmbientLight","transformAmbientSound","transformDrawing","transformRegion","applyToMap","docToData","dataArr","shapes","shape","points","radiusX","radiusY","isNumeric","bottom","dr","toRadians","rotatePoint","rectCenter","docShape","dataShape","PolygonShapeData","gridScale","distance","direction","toDegrees","config","dim","bright","_l3dPreview","ruler","posCanvasTo3d","mesh","multiplyScalar","THREE","MathUtils","degToRad","sizeX","sizeY","x2","y2","rot","dx","dy","cos","sin","showPlaceableTypeSelectDialog","importPresetFromJSONDialog","reject","import","readTextFromFile","files","PROCESSED_UPDATES","LINK_TYPES","TWO_WAY","RECEIVE","SEND","registerLinkerHooks","Hooks","preUpdate","_delete","register","wrapped","args","history","undone","LinkerAPI","h","createEmbeddedDocuments","isUndo","keepId","processLinks","links","docUpdates","processedLinks","sourceId","linked","getEmbeddedCollection","some","l1","l2","_source","dLinks","l","updateQueue","PromiseQueue","queue","operation","catch","ignoreLinks","positionUpdate","rotationUpdate","keyboard","isModifierActive","KeyboardManager","MODIFIER_KEYS","ALT","puLinks","modifiedTime","previousSource","linkSources","currentSource","previousBounds","currentBounds","x1","y1","dRotation","meRotation","dElevation","calculateTransform","animate","RidingMovement","forced","linkerDelete","getHardLinkedDocuments","toDelete","deleteEmbeddedDocuments","shift","openMenu","openLinkerMenu","smartLink","multiLayer","_getSelected","_smartLink","link","getLinks","openSmartLinkMenu","numUpdates","addLink","getLinkedDocuments","allLinked","_findLinked","_findHardLinked","hasLink","linkId","areLinked","placeable1","placeable2","links1","links2","removeLink","unsetFlag","removeLinks","removed","removeLinksFromSelected","notification","numRemoved","w","unlink","removeAllLinksOnCurrentScene","updateLinkLabelOnCurrentScene","updated","removeLinkFromScene","fLinks","objectClass","embeddedName","_getLinkedDocumentsUsingLink","_highlightDocuments","dg","debug","lineStyle","drawRect","_clearHighlight","Mouse3D","_boundOn3DMouseDown","_on3DMouseDown","_boundOn3dMouseMove","_on3dMouseMove","_boundOn3dMouseWheel","_on3dMouseWheel","_createTracker","_activate3DListeners","tracker","deactivate3DListeners","Mesh","SphereGeometry","MeshBasicMaterial","opacity","transparent","wireframe","userData","ignoreHover","mPos","interactionManager","canvas3dMousePosition","domElement","addEventListener","removeEventListener","posVec","pos3DToCanvas","currentHover","delayMoveTimer","cPos","camera","intersects","computeSightCollisionFrom3DPositions","intersect","ctrlKey","shiftKey","metaKey","altKey","preventDefault","delta","deltaY","deltaX","addScaling","addRotation","pickerOverlay","_rotation","setPositions","mousePosition","_transformAccumulator","_scale","addElevation","_elevation","_mirrorX","_mirrorY","PreciseText","canvasTextStyle","_fontSize","anchor","autoScale","previewData","_paraScale","getParallaxParameters","previews","previewDocuments","_genPreviews","walls","SHIFT","postTransformPos","snapped","getSnappedPoint","params","getTokenSize","tSize","currHeight","toFixed","previewContainer","renderFlags","_meSort","_meElevation","collision","_onUpdate","initializeLightSource","initializeSoundSource","lastX","lastY","client","off","boundStart","boundEnd","confirmOnRelease","minX","maxX","minY","maxY","start","end","children","clearPreviewContainer","_createPreview","createData","getDocumentClass","_object","eventMode","occlusion","draw","tooltip","renderable","_overridePlaceableVisibility","createTile","l3dPreview","tiles","castShadow","addToken","addLight","lights","toCreate","_genTAPreviews","restrict","attached","ratio","dataList","xy","editPreviewPlaceables","mainDocumentName","tokenAttacher","generatePrototypeAttached","prototypeAttached","originalDocToData","coords","originalData","preventParallaxScaling","openBag","journal","fromUuidSync","simplifyString","presetBag","BagApplication","forceAllowDelete","previousPositions","bag","containedPresets","full","searchedPresets","completedSearch","displayLabels","searchBar","setAppearance","_onSearchInput","search","item","appearance","hColor","header","toRGBA","bColor","background","_dropUuids","droppedUuids","isGM","bagUuids","_onDeleteSelectedPresets","_getSelectedPresets","editableOnly","isEditable","BagConfig","_onCreateMacro","_onRefreshSearch","confirm","yes","defaultYes","notify","refreshing","searches","virtualDirectory","inclusive","query","terms","matchAll","exclusive","parentForm","_originalPreset","_onAddSearchTerm","_onRemoveSearchTerm","_onAppearanceFieldChange","_saveState","clearEmptySearch","_getFolderContextOptions","TrackerDialog","cancelCallback","incrementCount","stop","_state","Application","RENDER_STATES","RENDERED","RENDERING","trackProgress","cancel","_render","countFolderItems","folder","reduce","sum","contents","SortingHelpersFixed","performIntegerSort","source","sortKey","sortBefore","defaultIdx","idx","sib","_sortBefore","_sortAfter","SORT_INTEGER_DENSITY","isFinite","round","performIntegerSortMulti","sources","increment","TagSelector","presetsApp","_tagSelector","tagMap","getTagsOfRendered","searchedTagsArr","getSearchedTags","activeTags","t1","t2","_onClickTag","tree","folders","_getFolderTags","extFolders","_getPresetTags","PresetBrowser","lastSearch","substring","searchInput","endsWith","PresetBrowserSettings","browser","dropdownDocuments","toggleClass","SORT_MODES","manual","alphabetical","SEARCH_MODES","pf","openPresetBrowser","setSetting","setting","_lastSearch","configApp","previousPosition","sortable","duplicatable","documentLock","persistentSearch","getTree","externalCompendiums","setFormVisibility","_onSearch","createEnabled","isPlaceable","allowDocumentSwap","docLockActive","layerSwitchActive","switchLayer","sortMode","searchMode","displayDragDropMessage","docsDropdown","currentDocument","hoverOverlay","_original","isDragging","objectHover","dropPlaceable","_createNewBag","_onToggleSort","_onToggleLock","_onToggleSetting","_onDocumentChange","_onCreateFolder","_onPresetCreate","_onPresetUpdate","_onApplyPreset","_onToggleTagSelector","headerSearch","_onToggleSearch","_foundryDrop","TextEditor","getDragEventData","originalEvent","_importTracker","_importActorFolder","createPresetFromActorUuid","parentFolder","nFolder","Folder","implementation","sorting","types","pack","workingPack","child","_onExportFolder","getCompendiumDialog","exportTo","keepIdSelect","allFolders","_onCopyFolder","parentId","folderDoc","fromUuid","_onExportSelectedPresetsToComp","_onCopySelectedPresets","_onCopyPresetToClipboard","_onExportSelectedPresets","defaultName","PresetFolderConfig","_onFolderEdit","pFolder","_onFolderDelete","deleteAll","traverseFolder","countWarning","deleteFolder","clearTimeout","_searchTimer","previousSearch","_resetSearchState","_renderContent","_searchFoundPresets","_searchFolder","_searchPreset","forceRender","folderName","childFolderMatch","presetMatch","containsMatch","expanded","_visible","matched","_resetSearchStateFolder","_resetSearchStatePreset","_onFolderSort","sourceUuid","targetUuid","inside","folderUuid","result","_onItemSort","sourceUuids","sourceUuidsSet","allPresets","updatePresets","searchControl","newMode","lockControl","newLock","newDocumentName","_endPreview","ActiveEffectConfig","_getActiveEffectFields","_editPresets","isCreate","createPreset","actorToPreset","changes","_onSettingConfig","_onWorkingPackChange","_onOpenIndexer","_onExport","_onImport","ev","packs","_buildingIndex","getDocuments","importCount","_pages","pages","FolderConfig","submitOnClose","metadata","folderDocs","displayTypes","newName","safeColor","sortingModes","submitText","virtualPackFolder","visibleTypes","updateSource","excludePack","message","buttonLabel","locked","collection","export","registerPresetBrowserHooks","dragDropHandler","_onDragLeftCancel","libWrapper","sceneControls","presetControl","presetForm","condition","li","getDocument","packId","DEFAULT_PACK","META_INDEX_ID","META_INDEX_FIELDS","PresetCollection","mainTree","MassEdit","_initCompendium","PresetTree","init","forceLoad","hasVisible","topFolder","PresetPackFolder","vTree","getVirtualDirectoryTree","VirtualFileFolder","_groupExtFolders","timeEnd","f1","f2","localeCompare","groupless","newExtFolders","groupFolder","PresetVirtualFolder","draggable","_cleanIndex","metaDoc","metaIndex","_packTrees","_sortFolders","_sortPresets","numeric","packToPresets","mIndex","compendium","updateDoc","toJSON","_initMetaDocument","toCreatePresets","createDocuments","load","metaFields","_constructVirtualFilePreset","documentType","embedded","parseUuid","getBatch","collectionToPreset","virtual","_id__in","sorted","metaUpdate","deleteIds","deleteDocuments","CompendiumCollection","createCompendium","GAMEMASTER","PLAYER","ASSISTANT","packageType","deleteSubfolders","deleteContents","_searchPresetTree","_searchPresetList","_searchPresetFolder","_searchPresets","results","toSearch","buildSpotlightOmnisearchIndex","soIndex","SearchTerm","SpotlightOmnisearch","onClick","spotlightOmnisearch","setDraggingState","onDragEnd","canvasCoordinatesFromClient","clientX","clientY","getActions","openJournal","buildTerm","description","keywords","PresetAPI","createPresetFromActor","presetData","gridSize","defPreset","taggerTag","PresetFolder","bucket","subtext","indexable","packFolderData","setVisibility","topLevelFolders","folderContents","topLevelPresets","_updateIndex","sortedFolders","sortedPresets","_setChildAndParentFoldersVisible","registerPresetHandlebarPartials","PresetContainer","opts1","opts2","dragType","dragData","draggedElements","presetsSortable","presetsDuplicatable","presetsForceAllowDelete","presetsDisableDelete","disableDelete","itemList","itemSelect","_playPreview","dataTransfer","clearData","setData","targetItem","domRect","getBoundingClientRect","prc","offsetY","reverse","inWindow","sidebar","_coordOverElement","pageX","pageY","checkMouseInWindow","_onPresetDragOut","_folderToggle","targetFolder","presetItems","_onDoubleClickPreset","_contextMenu","_onOpenBag","_setInteractivityState","_onSpawnPreset","layerSwitch","eventTarget","state","itemOptions","_getItemContextOptions","o1","o2","ContextMenu","hookName","onOpen","folderOptions","_onImportFauxScene","_onSpawnScene","_onEditSelectedPresets","_onActivateBrush","_onOpenJournal","_onApplyToSelected","keepFolder","_onCopyUUID","importFromCompendium","renderSheet","saveFolderToCache","randomizeChildrenFolderColors","virtualOnly","selector","_previewTimeout","_renderPlayPreview","audio","playing","_mePreview","_previewElement","addClearPreviewElement","empty","body","path","play","thumbnail","visualViewport","hoverForm","mouseX","mouseY","mouseZ","forms","_onMouseMove","canvas2dMousePosition","worldTransform","tx","ty","folderElement","_folderCollapse","_folderExpand","setExpanded","i18n","format","popOut","currentPosition","getComputedStyle","tarW","offsetWidth","minW","parseInt","minWidth","MIN_WINDOW_WIDTH","maxW","maxWidth","innerWidth","clamp","clamped","tarH","offsetHeight","minH","minHeight","MIN_WINDOW_HEIGHT","maxH","maxHeight","leftT","topT","posSet","scaledWidth","tarL","maxL","scaledHeight","tarT","maxT","lastSelected","itemIndex","lastSelectedIndex","itemArr","toArray","appX","appY","appW","appH","PresetConfig","prefix","fileName","displayFieldDelete","at","multiEdit","_submitData","minlength","tva","modifyDisabled","deleteDisabled","documentEdit","_onEditDocument","_onAssignDocument","_onDeleteFields","_onSpawnFields","onAttachedRemove","tvaButton","showArtSelect","imgSrc","searchType","updateData","preSpawnScript","postSpawnScript","removeTags","PresetFieldModify","modifyOnSpawn","PresetFieldDelete","documentClass","tempDoc","_updatePresets","spawnRandom","preserveLinks","processBatchUpdates","_renderOuter","_createDocumentIdLink","idLink","createElement","classList","setAttribute","tooltipDirection","innerHTML","PresetFieldSelect","isObject","_onFieldClick","singleData","reorganizedData","CACHE_NAME","FileIndexer","_loadedTree","cache","loadMainIndexCache","prePend","ForgeVTT","usingTheForge","ForgeAPI","getUserId","s3","buckets","endpoint","host","_indexToVirtualFolder","sFolder","buildIndex","scannedSources","foundCaches","dir","indexDirs","_buildFauxForgeBrowser","iDir","generateIndex","sPath","dirs","mergeIndex","cacheFile","loadIndexCache","mergeCaches","currentCache","tagsOnly","overrideNullTagsOnly","overrideTags","_writeIndexToCache","cacheTo","cacheFrom","indexSourceFrom","indexSourceTo","indexTo","indexFrom","dirFrom","dirTo","fileFrom","fileTo","saveIndexToCache","sourceFolder","sourceCache","_cacheFolder","str","tFile","StringCompress","compress","FilePicker","upload","wFolder","fDic","_cachePreset","pDic","decompressCache","error","parentDirPath","fullPath","fileFolder","childFolder","file","noscan","_browse","indexerFile","folderFilters","fileFilters","ignoreExternal","author","_getAuthorFromModule","cacheDir","ext","_fauxForgeBrowser","browse","paths","replaceAll","insertFile","pDirPath","chDirPath","pDir","components","URL","pathname","moduleFile","authors","compressedStream","Blob","stream","pipeThrough","CompressionStream","chunks","chunk","streamAsyncIterator","blob","File","filePath","response","fetch","ok","decompress","decompressedStream","DecompressionStream","stringBytes","concatUint8Arrays","TextDecoder","decode","uint8arrays","buffer","arrayBuffer","Uint8Array","reader","getReader","done","read","releaseLock","IndexerForm","_onAddDirectory","_onDeleteDirectory","_onFileFiltersChange","_onFolderFiltersChange","_onToggleCheckbox","chkBox","_updateIndexerSettings","_onInputTimeOut","selectFolder","selection","directory","activeSource","current","fp","FileIndexerAPI","readCacheFile","DOCUMENT_FIELDS","PRESET_FIELDS","DOC_ICONS","ALL","Bag","FauxScene","Preset","fromEntries","DEFAULT_TOKEN","_data","hook","_postSpawnHooks","scenescapeSizeOverride","regex","RegExp","actorId","_getActorSize","attach","batchUpdate","_updateBatch","batch","flagUpdate","docUpdate","VirtualFilePreset","_storedReference","_updateTimeout","Spawner","previewLabel","previewRestrictedDocuments","modifyPrompt","modifySpawnData","presetAttached","_autoModifyData","_determineSpawnPosition","posTransform","allDocuments","_regenerateLinks","newLinkId","oldId","behaviors","system","pos3d","destinationTags","maxSort","toModify","modified","tmpData","FolderState","_expanded","placeableToData","applyTaggerTagRules","rules","regx","findTag","existingDocuments","getByTag","numbers","existingDocument","getTags","temporaryIds","tagRules","_validateTags","applicableTagRules","mergePresetDataToDefaultDoc","strokeWidth","strokeAlpha","hole","getTransformToOrigin","next","getDataBounds","z1","getPresetDataBounds","MAX_SAFE_INTEGER","MIN_SAFE_INTEGER","z2","isVideo","extension","decodeURIComponentSafely","uri","decodeURIComponent","encodeURIComponentSafely","encodeURIComponent","readJSONFile","url","jQuery","getJSON","registerSideBarPresetDropListener","playlist","playlists","channel","repeat","fade","pausedTime","getPivotOffset","exportPresets","saveDataToFile","parseSearchQuery","parsedQuery","toLocaleLowerCase","importSceneCompendium","getName","workingPackTree","alreadyImportedCount","thumb","selectField","deselectField","allRandomizedRemoved","selectRandomizerFields","applyRandomization","requiresCoordRandomization","isInteger","color1","color2","rOffset","rnOffset","hexColor","outputSpace","images","maintainAspect","tex","loadTexture","tileRatio","texRatio","shuffled","shuffleArray","strings","coordCtrl","pUpdates","pUpdate","freeId","boundingBox","freeRectangles","stepX","stepY","randomPlace","nearestStep","num","randomNum","temp","rec","fittingRecs","_canFit","rec1","rec2","overlaps","_intersectRec","overlap","_addAndMergeFreeRectangle","ScenescapeControls","registerMainHooks","Scenescape","loadFlags","_checkActivateControls","ScenescapeConfig","_register","displayBlackBars","blackBars","pixelPerfect","_unregister","_registerLibWrappers","_registerHooks","_wrapperIds","unregister","_hooks","getSize","textureDimensions","updatedWidth","r","border","isSecret","_moveMany","_getTokenDimensions","changed","refreshSize","controllableObjects","_canDrag","draggedObject","_meDragging","refreshState","interactionData","clones","rotate","includeLocked","_getMovableObjects","hud","incrementScale","nBottom","moveCoordinate","nParams","fixedSize","deltaScale","teleport","display","bars","primary","getChildByName","sortLayer","PrimaryCanvasGroup","SORT_LAYERS","DRAWINGS","restrictsLight","graphics","Graphics","beginFill","endFill","beginHole","sceneX","sceneY","sceneWidth","sceneHeight","endHole","TEMPLATES","dataUpdate","_createReferenceMarkers","markerTemplates","scaleDistance","speedY","_onClickMarker","_onSelectLimit","_onAutoSelectLimits","_onClearLimits","ys","marker","movementLimits","_onLockInScale","markers","foregroundElevation","processReferenceMarkers","GRID_TYPES","GRIDLESS","tokenVision","_onMinimize","LineSelector","_onMaximize","scenescape","_deleteReferenceMarkers","minimize","maximize","lines","overlay","_save","_exit","_drawLine","moveTo","lineTo","registerScenescapeHooks","distanceRatio","_distanceRatio","stepDistanceX","_stepDistanceX","stepDistanceY","_stepDistanceY","_movementLimits","_markers","_getBoundingMarkers","realHeight","scale1","param","ignoreLimits","nX","nY","nElevation","arr","scale2","lastM","heightString","feet","parseHeightString","details","TGT_SPLIT_RE","TGT_CLEANUP_RE","once","globalThis","is_fallback","WRAPPER","MIXED","OVERRIDE","package_id","fn","chain","is_setter","root_nm","fn_name","_eval","eval","iObj","descriptor","getOwnPropertyDescriptor","getPrototypeOf","configurable","original","wrapper","applyDDTint","toNumber","string2hex","_string2hex","PlaceableObject","filterType","getDDTint","_TMFXgetSprite","rgb2hex","uniforms","toHex","hex2string","_hex2string","applyTMFXPreset","pixelPerfectTileWrapper","pixelPerfectTokenWrapper","enablePixelPerfectSelect","tileWrapperChanged","tokenWrapperChanged","frame","_originalContains","_mesh","containsCanvasPoint","redraw","refreshShape","enableUniversalSelectTool","missingLayers","_placeableRefresh","regions","rotatableObjects","tools","activeTool","_getControlButtons","defer","_onDragCanvasPan","destination","paused","localize","isPreview","sign","isImage","isAudio","recursiveTraverse","flagCompare","flag","flagVal","falseyFlagVal","falseyDataVal","compTags","wildcardStringMatch","hasFlagRemove","comp","tempFlag","selectAddSubtractFields","getCommonData","mergeObjectPreserveDot","other","nestedKey","fullKey","panToFitPlaceables","center","animatePan","duration","topLeft","bottomRight","tlc","_viewPosition","screenDimensions","escapeRegex","string","sw","s2","test","wildcardStringReplace","re","regexStringReplace","activeEffectPresetSelect","aeConfig","showPresetGeneric","nChanges","ACTIVE_EFFECT_MODES","priority","nc","activeEffect","getDocumentName","DOCUMENT_CREATE_REQUESTS","sceneID","requestID","handlerName","socket","emit","resolveCreateDocumentRequest","documentIDs","docID","getEmbeddedDocument","updateEmbeddedDocumentsViaGM","isResponsibleGM","role","compare","isSelf","moduleLocalization","localFormat","insert","applyPresetToScene","randomizer","executeScript","speaker","ChatMessage","getSpeaker","character","argNames","argValues","AsyncFunction","err","SeededRandom","seed","cyrb128","sfc32","chars","h1","h2","h3","h4","charCodeAt","imul","TagInput","registerHandlebarsHelper","registerHelper","hash","Utils","tagHtml","_tagField","listAttr","le","SafeString","meTags","newTags","tagValue","pickerSelectMultiLayerDocuments","selectionRect","Rectangle","loadImageVideoDimensions","baseTexture","spawnSceneAsPreset","embed","sceneRect","att","minSort","minElevation","findSplice","exports","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","__esModule","ns","def","getOwnPropertyNames","definition","enumerable","chunkId","all","promises","script","needAttach","scripts","getElementsByTagName","getAttribute","charset","timeout","onScriptComplete","prev","onerror","onload","doneFns","parentNode","head","appendChild","Symbol","toStringTag","installedChunks","installedChunkData","promise","errorType","realSrc","request","webpackJsonpCallback","parentChunkLoadingFunction","chunkIds","moreModules","runtime","chunkLoadingGlobal","self","V12Migrator","migrateAllPacks","migrateFunc","transformFunc","coreMigration","migratePack","fPack","metaIndexUpdate","_migrateData","indexUpdate","migrateData","_migratePrototypeAttached","PresetField","SetField","StringField","_defaults","assign","required","blank","nullable","_toInput","CustomStringElement","elements","HTMLStringTagsElement","placeholder","renderTag","editable","record","customElements","define","tagName","DeSpawnPresetBehaviorType","regionBehaviors","RegionBehaviorType","defineSchema","_createEventsField","REGION_EVENTS","TOKEN_ENTER","TOKEN_EXIT","TOKEN_MOVE_IN","TOKEN_MOVE_OUT","TOKEN_TURN_START","TOKEN_TURN_END","presetUuids","hint","BooleanField","originRegionOnly","_handleRegionEvent","animation","CanvasAnimation","getAnimation","animationName","deSpawnAllPresets","deSpawnPresets","originRegionId","embedName","regionId","LinkTokenRegionBehaviorType","_onTokenMoveIn","_onTokenMoveOut","SpawnPresetBehaviorType","schema","DocumentUUIDField","destinationSpawnInAll","destinations","RegionDocument","taggedDestinations","isSpawned","behavior","presetUuid","ds","destinationRegionObject","behaviorId","vertices","indices","triangulation","areas","totalArea","i0","i1","i2","x0","y0","area","r1","r2","polygonTree","testPoint","getRandomPosition","getCenterPosition","openCategoryBrowser","menu","retainState","alignment","globalSearch","_browserId","CategoryBrowserApplication","Category","submenu","fa","CategoryList","parentCategory","categories","_topMenu","_menus","_categories","positionOpts","oldMenuStates","menus","_runQueryTree","_processMenu","_presetResults","_onClickCategory","_onGlobalSearchToggle","_setHeaderButtonColors","windowHeader","activeColor","inactiveColor","categoryList","category","cat","_setCategoryInactive","_setCategoryActive","runTime","_queryRunTime","queries","_runQuery","loading","runQueryTree","RegionBehavior","dataModels","typeIcons","String","registerMenu","restricted","NumberField","onChange","favorites","bags","searchesInclusive","registerSettings","keybindings","modifiers","onDown","precedence","KEYBINDING_PRECEDENCE","NORMAL","editing","allowPlayerMove","allowPlayerRotate","PRIORITY","getSelection","downKeys","INDEX","old","deactivateBrush","linker","tokenData","tileData","me"],"sourceRoot":""}