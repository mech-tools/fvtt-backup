"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[894],{894:(e,t,o)=>{o.r(t),o.d(t,{openLinkerMenu:()=>L});var i=o(638),n=o(120),s=o(934),d=o.n(s),r=o(390),l=o(903),c=o.n(l),a=o(85),h=o.n(a),k=o(748),g=o(859),u=o(596);function L(){const e=Object.values(ui.windows).find((e=>e instanceof LinkerMenu));e?e.close():(new LinkerMenu).render(!0)}const p={color:"white",colorSelected:"#7FFF00",pictoColor:"red",size:15},m={color:"yellow",colorSelected:"#7FFF00",pictoColor:"red",image:"modules/multi-token-edit/images/linker/link-45deg.svg",size:15},N={arrow:"orange",line:"white",hover:"#7FFF00",size:4};class LinkerMenu extends FormApplication{static registeredHooks=[];static onControl(e,t){const o=e.document;this._graph.hasNode(o.id)&&this._graph.setNodeAttribute(o.id,"highlighted",t)}static onDelete(e){e.parent.id===canvas.scene.id&&LinkerMenu.removeNode.call(this,e.id)}static onCreate(e){e.object&&this._processDocument(e)}static addLink(e,t,o,n,s){const d=this._graph;if(d.hasNode(o)||this._addLinkNode(o,{x:.5,y:.5},s),!d.hasNode(t)){const i={x:d.getNodeAttribute(o,"x"),y:d.getNodeAttribute(o,"y")};i.x+=.1*Math.random()-.05,i.y+=.01*Math.random()-.005,this._addDocumentNode(e,t,null,i)}let r=d.edges(t).find((e=>d.source(e)===o||d.target(e)===o));if(!r)return this._addEdge(t,o,n);n===i.rm.TWO_WAY?(d.setEdgeAttribute(r,"type","line"),d.setEdgeAttribute(r,"color",N.line)):(d.dropEdge(r),this._addEdge(t,o,n))}static removeLink(e,t){const o=this._graph;if(!o.hasNode(e)&&!o.hasNode(t))return;const n=o.edges(e).find((e=>o.source(e)===t||o.target(e)===t));if(!n)return;o.neighbors(e).length<2?LinkerMenu.removeNode.call(this,e):(o.dropEdge(n),i.sy._clearHighlight(),this._refreshControlState())}static removeNode(e){const t=this._graph;t.hasNode(e)&&(t.getNodeAttribute(e,"isLink")?(t.forEachNeighbor(e,(e=>{1===t.edges(e).length&&t.dropNode(e)})),t.dropNode(e),e===this._selectedLinkNode&&(this._selectedLinkNode=null)):(t.neighbors(e).forEach((e=>{1===t.edges(e).length&&(t.dropNode(e),e===this._selectedLinkNode&&(this._selectedLinkNode=null))})),t.dropNode(e),this._selectedNodes=this._selectedNodes.filter((t=>t!==e))),i.sy._clearHighlight(),this._refreshControlState())}static onCanvasReady(){this.close(!0)}static linkLabelChange(e,t){this._graph.hasNode(e)&&this._graph.setNodeAttribute(e,"label",t??"LINK")}static registerHooks(e){LinkerMenu.unregisterHooks(),u.Me.forEach((t=>{LinkerMenu.registeredHooks.push({hook:`control${t}`,id:Hooks.on(`control${t}`,LinkerMenu.onControl.bind(e))}),LinkerMenu.registeredHooks.push({hook:`delete${t}`,id:Hooks.on(`delete${t}`,LinkerMenu.onDelete.bind(e))}),LinkerMenu.registeredHooks.push({hook:`create${t}`,id:Hooks.on(`create${t}`,LinkerMenu.onCreate.bind(e))})})),LinkerMenu.registeredHooks.push({hook:`${u.Do}.removeLink`,id:Hooks.on(`${u.Do}.removeLink`,LinkerMenu.removeLink.bind(e))}),LinkerMenu.registeredHooks.push({hook:`${u.Do}.removeNode`,id:Hooks.on(`${u.Do}.removeNode`,LinkerMenu.removeNode.bind(e))}),LinkerMenu.registeredHooks.push({hook:`${u.Do}.addLink`,id:Hooks.on(`${u.Do}.addLink`,LinkerMenu.addLink.bind(e))}),LinkerMenu.registeredHooks.push({hook:`${u.Do}.linkLabelChange`,id:Hooks.on(`${u.Do}.linkLabelChange`,LinkerMenu.linkLabelChange.bind(e))}),LinkerMenu.registeredHooks.push({hook:"canvasReady",id:Hooks.on("canvasReady",LinkerMenu.onCanvasReady.bind(e))})}static unregisterHooks(){LinkerMenu.registeredHooks.forEach((e=>Hooks.off(e.hook,e.id))),LinkerMenu.registeredHooks=[]}constructor(){const e=ui.controls.element.find('[data-control="me-presets"]').position();super({},{left:e.left+50,top:e.top});const t=[];u.Me.forEach((e=>{canvas.scene.getEmbeddedCollection(e).forEach((e=>{e.flags[u.Do]?.links?.forEach((e=>{t.find((t=>e.id===t.id&&e.type===t.type))||t.push(foundry.utils.deepClone(e))}))}))})),t.sort(((e,t)=>e.id.localeCompare(t.id))),this.links=t,this._selectedNodes=[],LinkerMenu.registerHooks(this)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-linker-menu",template:`modules/${u.Do}/templates/linker.html`,classes:["mass-edit-linker","mass-edit-dark-window","mass-edit-window-fill"],resizable:!0,minimizable:!1,width:325,height:325})}_addDocumentNode(e,t,o=null,i=null){const n=o??canvas.scene.getEmbeddedDocument(e,t);if(!n)return;const s=i??{x:n.object.bounds.x,y:-n.object.bounds.y};return this._graph.addNode(t,{size:p.size,label:e,color:p.color,pictoColor:p.pictoColor,image:u.SV[e],type:"pictogram",document:n,...s}),s}_addLinkNode(e,t,o=null){this._graph.addNode(e,{size:m.size,label:o??"LINK",color:m.color,pictoColor:m.pictoColor,image:m.image,type:"pictogram",isLink:!0,...t})}_addEdge(e,t,o){let n,s;return o===i.rm.RECEIVE?(n=t,s=e):(n=e,s=t),this._graph.addEdge(n,s,{size:N.size,color:o===i.rm.TWO_WAY?N.line:N.arrow,type:o===i.rm.TWO_WAY?"line":"arrow"})}_processDocument(e){if(e.flags[u.Do]?.links?.length){const t=this._addDocumentNode(e.documentName,e.id,e);e.flags[u.Do].links.forEach((o=>{this._graph.hasNode(o.id)||this._addLinkNode(o.id,{x:t.x+40,y:t.y+40},o.label),this._addEdge(e.id,o.id,o.type)}))}}async activateGraph(e){const t=new(d());this._graph=t;const o=i.sy._getSelected().map((e=>e.document));o.length?(o.forEach((e=>this._processDocument(e))),i.sy.getLinkedDocuments(o).forEach((e=>this._processDocument(e)))):u.Me.forEach((e=>{canvas.scene.getEmbeddedCollection(e).forEach((e=>{this._processDocument(e)}))}));const n=c().inferSettings(t),s=new(h())(t,{settings:n});this._graphLayout=s,s.start();const l=(0,k.af)({padding:.15,size:{mode:"force",value:256},drawingMode:"color",colorAttribute:"pictoColor"}),a=(0,g.E3)([g.VH,l]),L=new r.UT(t,e.find(".graph")[0],{defaultNodeType:"pictogram",enableEdgeEvents:!0,nodeProgramClasses:{pictogram:a}});this._sigmaInstance=L,L.on("doubleClickStage",(({event:e})=>{const o=foundry.utils.randomID(),i=L.viewportToGraph({x:e.x,y:e.y});t.addNode(o,{size:m.size,label:"LINK",color:m.color,pictoColor:m.pictoColor,image:m.image,type:"pictogram",isLink:!0,x:i.x,y:i.y}),e.preventSigmaDefault(),e.original.preventDefault(),e.original.stopPropagation(),this.onClickNode(o)})),L.on("enterNode",(({node:e})=>{const o=t.getNodeAttribute(e,"document");o?i.sy._highlightDocuments([o]):i.sy._highlightDocuments(i.sy._getLinkedDocumentsUsingLink(e))})),L.on("leaveNode",i.sy._clearHighlight),L.on("clickNode",(({node:e})=>this.onClickNode(e))),L.on("rightClickNode",(({node:e})=>this.removeNode(e))),L.on("doubleClickNode",(({event:e,node:t})=>{e.preventSigmaDefault(),e.original.preventDefault(),e.original.stopPropagation(),this.editLinkLabel(t)})),L.on("enterEdge",(({edge:e})=>{t.setEdgeAttribute(e,"color",N.hover)})),L.on("leaveEdge",(({edge:e})=>{t.setEdgeAttribute(e,"color","line"===t.getEdgeAttribute(e,"type")?N.line:N.arrow)})),L.on("clickEdge",(({edge:e})=>this.cycleEdgeType(e))),L.on("rightClickEdge",(({edge:e})=>this.removeEdge(e)))}editLinkLabel(e){const t=this._graph;if(!t.getNodeAttribute(e,"isLink"))return;const o=t.getNodeAttribute(e,"label");new Dialog({title:"Edit: Link Label",content:`<input class="label" type="text" value="${o}"></input>`,buttons:{save:{label:(0,n.kg)("Save",!1),callback:n=>{if(!t.hasNode(e))return;const s=n.find(".label").val();s&&s!=o&&i.sy.updateLinkLabelOnCurrentScene(e,s)}}}}).render(!0)}removeEdge(e){const t=this._graph;let o,n,s=t.source(e),d=t.target(e);t.getNodeAttribute(s,"isLink")?(o=s,n=d):(o=d,n=s),i.sy.removeLink(t.getNodeAttribute(n,"document"),o)}cycleEdgeType(e){const t=this._graph;let o,n=t.source(e),s=t.target(e);o="line"===t.getEdgeAttribute(e,"type")?i.rm.TWO_WAY:t.getNodeAttribute(s,"isLink")?i.rm.SEND:i.rm.RECEIVE,o=(o+1)%Object.keys(i.rm).length,i.sy.addLink(t.getNodeAttribute(n,"document")??t.getNodeAttribute(s,"document"),t.getNodeAttribute(n,"isLink")?n:s,o)}onClickNode(e){const t=this._graph;t.getNodeAttribute(e,"isLink")?this._selectedLinkNode===e?(this._selectedLinkNode=null,t.setNodeAttribute(e,"color",m.color)):(this._selectedLinkNode&&t.setNodeAttribute(this._selectedLinkNode,"color",m.color),this._selectedLinkNode=e,t.setNodeAttribute(this._selectedLinkNode,"color",m.colorSelected)):this._selectedNodes.includes(e)?(this._selectedNodes=this._selectedNodes.filter((t=>t!==e)),t.setNodeAttribute(e,"color",p.color)):(this._selectedNodes.push(e),t.setNodeAttribute(e,"color",p.colorSelected)),this._sigmaInstance.refresh(),this._refreshControlState()}removeNode(e){const t=this._graph;if(t.getNodeAttribute(e,"isLink"))i.sy.removeLinkFromScene(e);else{const o=t.getNodeAttribute(e,"document");o&&i.sy.removeLinks(o)}}async getData(e={}){return{}}get title(){return"Mass Edit: Linker"}activateListeners(e){super.activateListeners(e),this._conditionalControls=[{element:e.find(".selectedToLink").on("click",this._onSelectedToLinkControlClick.bind(this)),condition:()=>this._selectedLinkNode},{element:e.find(".pickerSelectToLink").on("click",this._onPickerSelectToLink.bind(this)),condition:()=>this._selectedLinkNode&&!game.Levels3DPreview?._active},{element:e.find(".nodeToLink").on("click",this._onNodeToLinkControlClick.bind(this)),condition:()=>this._selectedLinkNode&&this._selectedNodes.length},{element:e.find(".cycleLinkType").on("click",this._onCycleLinkType.bind(this)),condition:()=>this._selectedLinkNode}],e.find(".removeLinksSelected").on("click",i.sy.removeLinksFromSelected),e.find(".removeSelectedAndLinked").on("click",i.sy.deleteSelectedLinkedPlaceables),this.activateGraph(e)}_onCycleLinkType(){if(!this._selectedLinkNode)return;const e=this._graph,t=e.edges(this._selectedLinkNode);if(!t.length)return;const o=t[0],n=e.target(o);let s;s="line"===e.getEdgeAttribute(o,"type")?i.rm.TWO_WAY:e.getNodeAttribute(n,"isLink")?i.rm.SEND:i.rm.RECEIVE,s=(s+1)%Object.keys(i.rm).length,e.neighbors(this._selectedLinkNode).forEach((t=>{const o=e.getNodeAttribute(t,"document");o&&i.sy.addLink(o,this._selectedLinkNode,s)}))}async _onPickerSelectToLink(){if(!this._selectedLinkNode)return;const e=this._graph.neighbors(this._selectedLinkNode);(await(0,n.rH)()).filter((t=>!e.includes(t.id))).forEach((e=>i.sy.addLink(e,this._selectedLinkNode,i.rm.TWO_WAY)))}_onSelectedToLinkControlClick(){if(!this._selectedLinkNode)return;const e=this._graph.neighbors(this._selectedLinkNode);i.sy._getSelected().map((e=>e.document)).filter((t=>!e.includes(t.id))).forEach((e=>i.sy.addLink(e,this._selectedLinkNode,i.rm.TWO_WAY)))}_onNodeToLinkControlClick(){if(!this._selectedLinkNode||!this._selectedNodes.length)return;const e=this._graph;this._selectedNodes.filter((t=>!e.neighbors(t).includes(this._selectedLinkNode))).forEach((t=>{i.sy.addLink(e.getNodeAttribute(t,"document"),this._selectedLinkNode,i.rm.TWO_WAY)}))}_refreshControlState(){this._conditionalControls.forEach((e=>{e.condition()?e.element.removeAttr("disabled"):e.element.attr("disabled","disabled")}))}async close(e={}){return this._graphLayout?.kill(),this._sigmaInstance?.kill(),i.sy._clearHighlight(),LinkerMenu.unregisterHooks(),super.close(e)}}}}]);
//# sourceMappingURL=894.bundle.js.map