(()=>{"use strict";var e,t,s,a={867:(e,t,s)=>{s.d(t,{Ay:()=>CSSEdit,QD:()=>i,rY:()=>n});var a=s(120);function i(){const e=game.settings.get(a.Do,"cssStyle");return e in n?[e,n[e]]:["CUSTOM",game.settings.get(a.Do,"cssCustom")||""]}class CSSEdit extends FormApplication{constructor(){super({},{})}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-css",classes:["sheet"],template:`modules/${a.Do}/templates/cssEdit.html`,resizable:!0,minimizable:!1,title:"Edit CSS",width:490,height:730})}async getData(e){const t=super.getData(e),[s,a]=i();return t.styleInUse=s,t.css=a,t.styles=Object.keys(n),t.styles.push("CUSTOM"),t.disableCSS="CUSTOM"!==s,t}activateListeners(e){super.activateListeners(e),$(e).on("change",".selectStyle",(t=>{let s;s="CUSTOM"===t.target.value?game.settings.get(a.Do,"cssCustom"):n[t.target.value],$(e).find(".cssTextArea").val(s).prop("disabled","CUSTOM"!==t.target.value),$(e).find(".previewStyle").html(s)})),$(e).on("input",".cssTextArea",(t=>{$(e).find(".previewStyle").html(t.target.value)}))}async _updateObject(e,t){"CUSTOM"===t.selectedStyle&&game.settings.set(a.Do,"cssCustom",t.css),game.settings.set(a.Do,"cssStyle",t.selectedStyle)}}const n={Default:".form-group.meCommon {\n  outline: green dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {\n  outline: rgb(255, 204, 110) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  outline: rgb(246, 175, 255) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  outline: rgb(118, 242, 255) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}\n","No Outline":".form-group.meCommon {}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}\n","Striped Background":".form-group.meCommon {\n  background: repeating-linear-gradient(\n  45deg,\n  rgba(155, 233, 155, 0.8),\n  rgba(155, 233, 155, 0.8) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {\n  background: repeating-linear-gradient(\n  135deg,\n  rgba(255, 207, 118, 0.5),\n  rgba(255, 207, 118, 0.5) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  background: repeating-linear-gradient(\n  70deg,\n  rgba(237, 149, 255, 0.3),\n  rgba(237, 149, 255, 0.3) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  background: repeating-linear-gradient(\n  70deg,\n  rgba(118, 242, 255, 0.5),\n  rgba(118, 242, 255, 0.5) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n","Solid Background":".form-group.meCommon {\n  background: rgba(155, 233, 155, 0.8)\n}\n\n.mass-edit-checkbox.meCommon {\noutline: green solid 2px;\n}\n\n.form-group.meDiff {\n  background: rgba(255, 207, 118, 0.5)\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  background: rgba(237, 149, 255, 0.3)\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  background: rgba(118, 242, 255, 0.5)\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}"}},998:(e,t,s)=>{s.d(t,{A:()=>GeneralDataAdapter,f:()=>TokenDataAdapter});class TokenDataAdapter{static updateToForm(e){"texture.scaleX"in e&&(e.mirrorX=e["texture.scaleX"]<0,e.scale=Math.abs(e["texture.scaleX"])),"texture.scaleY"in e&&(e.mirrorY=e["texture.scaleY"]<0,e.scale=Math.abs(e["texture.scaleY"]))}static dataToForm(e,t){const s=e.document??e;null!=s.texture?.scaleX&&(t.scale=Math.abs(s.texture.scaleX)),null!=s.texture?.scaleX&&(t.mirrorX=s.texture.scaleX<0),null!=s.texture?.scaleY&&(t.mirrorY=s.texture.scaleY<0)}static formToData(e,t){const s=e.document??e;("scale"in t||"mirrorX"in t||"mirrorY"in t)&&("scale"in t||(t.scale=Math.abs(s.texture.scaleX)),"mirrorX"in t||(t.mirrorX=s.texture.scaleX<0),"mirrorY"in t||(t.mirrorY=s.texture.scaleY<0),t["texture.scaleX"]=t.scale*(t.mirrorX?-1:1),t["texture.scaleY"]=t.scale*(t.mirrorY?-1:1),["scale","mirrorX","mirrorY"].forEach((e=>delete t[e]))),TokenDataAdapter.correctDetectionModes(s,t)}static correctDetectionModeOrder(e,t){const s={};let a=0;for(const[i,n]of Object.entries(e))if(i.startsWith("detectionModes")){const o=i.split(".");o[1]in s||(s[o[1]]=a,a++);const r=`detectionModes.${s[o[1]]}.${o[2]}`;if(delete e[i],e[r]=n,t&&i in t){const e=t[i];delete t[i],t[r]=e}}}static detectionModeMatch(e,t){for(const s of e)if("id"in s)for(const e of t)if(s.id===e.id){if("enabled"in s&&s.enabled!==e.enabled)return!1;if("range"in s&&s.range!==e.range)return!1;break}return!0}static correctDetectionModes(e,t){const s=[],a={};let i=0;for(const[e,n]of Object.entries(t))if(e.startsWith("detectionModes")){const o=e.split(".");o[1]in a||(a[o[1]]=i,s.push({}),i++);s[a[o[1]]][o[2]]=n,delete t[e]}if(!s.length)return;const n=foundry.utils.deepClone(e.detectionModes).filter((e=>e.id));for(const e of s){if(null==e.id)continue;let t=!1;for(const s of n)if(s.id===e.id){foundry.utils.mergeObject(s,e),t=!0;break}t||n.push(foundry.utils.mergeObject({id:"",range:0,enabled:!0},e))}t.detectionModes=n}static modifyPresetData(e,t){const s=Object.values(foundry.utils.expandObject(t)?.detectionModes||{});if(!s.length)return;const a=Object.values(foundry.utils.expandObject(e._getSubmitData())?.detectionModes||{}),i=foundry.utils.deepClone(t),n=t["mass-edit-randomize"]??{},o=t["mass-edit-addSubtract"]??{},r=function(e,t,s,a,i){`detectionModes.${s}.${a}`in e&&(delete e[`detectionModes.${s}.${a}`],e[`detectionModes.${j}.${a}`]=i[t][`detectionModes.${s}.${a}`])},l=a.length;for(let e=0;e<s.length;e++){if(!("id"in s[e]))continue;let c=!1;for(let d=0;d<l;d++)s[e].id===a[d].id&&(c=!0,Object.keys(s[e]).forEach((s=>{delete t[`detectionModes.${e}.${s}`],t[`detectionModes.${d}.${s}`]=i[`detectionModes.${e}.${s}`],r(n,"mass-edit-randomize",e,s,i),r(o,"mass-edit-addSubtract",e,s,i)})));c||(a.push({id:"",range:0,enabled:!0}),Object.keys(s[e]).forEach((s=>{delete t[`detectionModes.${e}.${s}`],t[`detectionModes.${a.length-1}.${s}`]=i[`detectionModes.${e}.${s}`],`detectionModes.${e}.${s}`in n&&(delete n[`detectionModes.${e}.${s}`],n[`detectionModes.${a.length-1}.${s}`]=i["mass-edit-randomize"][`detectionModes.${e}.${s}`]),`detectionModes.${e}.${s}`in o&&(delete o[`detectionModes.${e}.${s}`],o[`detectionModes.${a.length-1}.${s}`]=i["mass-edit-addSubtract"][`detectionModes.${e}.${s}`])})))}return l!==a.length?(e._previewChanges({detectionModes:a}),e.render(),!0):void 0}}const a={Token:TokenDataAdapter,PlaylistSound:class PlaylistSoundDataAdapter{static formToData(e,t){"lvolume"in t&&(t.volume=AudioHelper.inputToVolume(t.lvolume),delete t.lvolume)}static dataToForm(e,t){t.lvolume=(e.document??e).volume}static updateToForm(e){"volume"in e&&(e.lvolume=AudioHelper.volumeToInput(e.volume),delete e.volume)}},Note:class NoteDataAdapter{static formToData(e,t){("icon.selected"in t||"icon.custom"in t)&&(t["texture.src"]=t["icon.selected"]||t["icon.custom"],delete t["icon.selected"],delete t["icon.custom"])}static dataToForm(e,t){const s=e.document??e;null!=s.texture?.src&&(t["icon.selected"]=s.texture.src,t["icon.custom"]=s.texture.src)}}};class GeneralDataAdapter{static formToData(e,t,s){const i=a[e];i&&i.formToData&&i.formToData(t,s)}static dataToForm(e,t,s){const i=a[e];i&&i.dataToForm&&i.dataToForm(t,s)}static updateToForm(e,t){const s=a[e];s&&s.updateToForm&&s.updateToForm(t)}}},439:(e,t,s)=>{s.d(t,{B0:()=>b,GS:()=>y,Yp:()=>g,bE:()=>k,fP:()=>m,lW:()=>w,ms:()=>x,pt:()=>h,qn:()=>c});var a=s(971),i=s(465),n=s(892),o=s(120),r=s(998),l=s(739);function c(e,t,s,{scope:a=null,selected:i=null,control:n=!0,pan:r=!0}={}){const c=[];if("selected"===a)u(i,t,s,c);else if(o.lv.includes(t))u(Array.from(game.collections.get(t)),t,s,c);else{let e=[];"world"===a?e=Array.from(game.scenes):canvas.scene&&(e=[canvas.scene]);for(const a of e)d(a,t,s,c)}return n&&(canvas.activeLayer.controlled.map((e=>e)).forEach((e=>e.release())),setTimeout((()=>{c.forEach((e=>{let t=e.object??e;t.control&&t.control({releaseOthers:!1})})),r&&c.length&&game.settings.get(o.Do,"panToSearch")&&(0,o.w$)(c)}),100)),"meSearchAndEdit"===e&&setTimeout((()=>{(0,l.gx)(c,t)}),500),c}function d(e,t,s,a){u(Array.from(e[l.QH[t]]),t,s,a)}function u(e,t,s,a){for(const i of e){let e=!0;const n=foundry.utils.flattenObject((0,o.bQ)(i).toObject());r.A.dataToForm(t,i,n);for(const[a,i]of Object.entries(s))if(a.startsWith("flags.")){if(!(0,o.uv)(n,a,i)){e=!1;break}}else if(""!==i&&null!=i||""===n[a]&&null==n[a]){if("string"==typeof i&&i.includes("*")&&(0,o.dT)(i,n[a]));else if(n[a]!=i){if("Token"===t&&a.startsWith("detectionModes"))continue;e=!1;break}}else;if(e){if("Token"===t){const e=Object.values(foundry.utils.expandObject(s)?.detectionModes||{});if(!r.f.detectionModeMatch(e,i.detectionModes))continue}a.push(i)}}}async function h(e,t,s,a){if(this.options?.simplified)return void(this.options.callback&&this.options.callback(e));if(foundry.utils.isEmpty(e))return void(this.callbackOnUpdate&&this.callbackOnUpdate(t));const n=[],l={},c=(t=t.map((e=>e.document??e))).length;for(let s=0;s<c;s++){const a=foundry.utils.deepClone(e);a._id=t[s].id,n.push(a)}this&&await(0,i.of)(n,t,this.randomizeFields),this&&(0,o.YY)(n,t,s,this.addSubtractFields);for(let e=0;e<c;e++)r.A.formToData(s,t[e],n[e]);if(await m(s,n,t),"Actor"===s)for(let e=0;e<n.length;e++){const s=n[e];delete s._id,this.options?.tokens?this.options.tokens[e].actor.update(s):t[e].update(s)}else if("Scene"===s)Scene.updateDocuments(n,l);else if("PlaylistSound"===s)for(let e=0;e<t.length;e++)delete n[e]._id,t[e].update(n[e],l);else if("Note"===s){const e={};for(let s=0;s<n.length;s++){const i=t[s].scene??t[s].parent;"meApplyCurrentScene"===a&&i.id!==canvas.scene.id||(i.id in e||(e[i.id]={scene:i,updates:[]}),e[i.id].updates.push(n[s]))}for(const t of Object.values(e))t.scene.updateEmbeddedDocuments(s,t.updates,l)}else if(!this.isPrototype&&o.Me.includes(s)){const e={};for(let s=0;s<n.length;s++){const a=t[s].parent;e[a.id]||(e[a.id]=[]),e[a.id].push(n[s])}for(const t of Object.keys(e))game.scenes.get(t)?.updateEmbeddedDocuments(s,e[t],l)}else if(o.lv.includes(s))t[0].constructor?.updateDocuments(n,l);else{for(let e=0;e<n.length;e++){const s=n[e];delete s._id,(0,o.ht)(t[e],foundry.utils.mergeObject(t[e],s))}this.callbackOnUpdate&&this.callbackOnUpdate(t)}if(("meApplyToPrototype"===a||this.isPrototype)&&"Token"===s){const e={};for(let s=0;s<t.length;s++){const a=t[s].actor;a&&(e[a.id]={_id:a.id,prototypeToken:n[s]})}if(!foundry.utils.isEmpty(e)){const t=[];for(const s of Object.keys(e))t.push(e[s]);Actor.updateDocuments(t)}}}async function m(e,t,s){for(let a=0;a<t.length;a++){const i=t[a],o=s[a];if(i.hasOwnProperty("tokenmagic.ddTint")&&"undefined"!=typeof TokenMagic&&await(0,n.gs)(o,i["tokenmagic.ddTint"]),i.hasOwnProperty("tokenmagic.preset")&&"undefined"!=typeof TokenMagic&&await(0,n.VC)(o,i["tokenmagic.preset"],"subtract"===this?.addSubtractFields?.["tokenmagic.preset"]?.method),"Tile"===e){if(i.hasOwnProperty("massedit.scale")){const e=i["massedit.scale"];i.width=o.width*e,i.height=o.height*e,null!=o.flags?.["levels-3d-preview"]?.depth?i["flags.levels-3d-preview.depth"]=o.flags["levels-3d-preview"].depth*=e:null!=o["flags.levels-3d-preview.depth"]&&(i["flags.levels-3d-preview.depth"]=o["flags.levels-3d-preview.depth"]*e)}i.hasOwnProperty("massedit.texture.scale")&&(i["texture.scaleX"]=i["massedit.texture.scale"],i["texture.scaleY"]=i["massedit.texture.scale"],delete i["massedit.texture.scale"])}}}async function g(e){if("mass-edit-control"===e.target.className&&!e.target.checked)return void f(e.target);const t=$(e.target).closest(".form-group").find(".mass-edit-checkbox input");t.prop("checked",!0),p(t[0]),this?.options.massEdit&&this._performOnInputChangeUpdate&&this.modUpdate&&this._performOnInputChangeUpdate()}function p(e){const t=$(e).parent().closest("div.tab, div.matt-tab");t.length&&(t.siblings("nav.tabs").find(`[data-tab="${t.attr("data-tab")}"]`).addClass("mass-edit-tab-selected"),p(t[0]))}function f(e){const t=$(e).parent().closest("div.tab, div.matt-tab");t.length&&0===t.find(".mass-edit-checkbox input:checked").length&&(t.siblings("nav.tabs").find(`[data-tab="${t.attr("data-tab")}"]`).removeClass("mass-edit-tab-selected"),f(t[0]))}function y(e,t){t||(0,o.Ng)(e[0]);const s=e.map((e=>function(e,t){const s=foundry.utils.flattenObject((0,o.bQ)(e).toObject());return r.A.dataToForm(t,e,s),s}(e,t)));return(0,o.m1)(s)}function b(e,t,s=!1,i=!1,n=null){if(!e||!e.length)return!1;let r,l=e[0].document?e[0].document.documentName:e[0].documentName;if((t=t??k(l))||"Token"===l&&(t||(t=k("TokenProto"),r="meApplyToPrototype"),t||(t=k("Actor"),l="Actor",e=e.filter((e=>e.actor)).map((e=>e.actor)))),t){if(t.documentName!==l)return;const c={meObjects:e};foundry.utils.isEmpty(t.randomize)||(c.randomizeFields=t.randomize),foundry.utils.isEmpty(t.addSubtract)||(c.addSubtractFields=t.addSubtract);let d=foundry.utils.deepClone(t.data[Math.floor(Math.random()*t.data.length)]);return n&&a.DataTransform.apply(l,d,{x:0,y:0},n),i&&(delete d.x,delete d.y,delete d.c),h.call(c,foundry.utils.flattenObject(d),e,t.documentName,r),s||ui.notifications.info((0,o.zS)("clipboard.paste",{document:t.documentName,count:e.length})),!0}return!1}const v={};function w(e,t,s){v[e.documentName]=e,"Token"===e.documentName&&s?v.TokenProto=e:"Token"===e.documentName&&"copyProto"===t&&(delete v.Token,v.TokenProto=e),game.clipboard.copyPlainText(JSON.stringify(foundry.utils.deepClone(1===e.data.length?e.data[0]:e.data),null,2)),ui.notifications.info((0,o.zS)("clipboard.copy",{document:e.documentName}))}function k(e){return v[e]}function x(e){delete v[e],"Token"===e&&delete v.TokenProto}},622:(e,t,s)=>{s.d(t,{dN:()=>P,fQ:()=>D});var a=s(120),i=s(241);function n(e){const t=(0,a.Ng)(e.meObjects[0]);if(!["AmbientLight","AmbientSound"].includes(t))return;const s=$(e.form);if(s.find('input[name="hidden"]').length)return;const i=e.meObjects[0].hidden,n=`\n  <div class="form-group">\n    <label>${(0,a.kg)("Hidden",!1)}</label>\n    <div class="form-fields">\n        <input type="checkbox" name="hidden" ${i?"checked":""}>\n    </div>\n  </div>\n`,o=s.find("div.tab");o.length?o.first().append(n):s.find(".form-group").last().after(n)}var o=s(624),r=s(671),l=s(465),c=s(892),d=s(867),u=s(998),h=s(439);function m(e,t){if("update"===e.method||"toggle"===e.method){let s="";return"toggle"===e.method&&(s+=function(e){let t="\n// Toggle; Helper function";"field"===e.toggle.method?t+="\nconst toggleOn = function (obj, fields) {\n  const data = foundry.utils.flattenObject(obj.toObject());\n  fields = foundry.utils.flattenObject(fields);\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\n};\n  ":t+="\nconst macro = this;\nconst toggleOn = function (obj) {\n  if (obj.getFlag('world', `macro-${macro.id}-toggleOn`)) {\n    obj.unsetFlag('world', `macro-${macro.id}-toggleOn`);\n    return true;\n  } else {\n    obj.setFlag('world', `macro-${macro.id}-toggleOn`, true);\n    return false;\n  }\n};\n";return t}(e)),s+=`\n// Updates to be applied\nconst update = ${f(e.fields)};\n`,"toggle"===e.method&&(s+=`const update2 = ${f(e.toggle.fields)};\n\n`),b(e)&&(s+="\n// Mass Edit control objects\n",e.randomize&&(s+=`const randomizeFields = ${f(e.randomize)};\n`),e.addSubtract&&(s+=`const addSubtractFields = ${f(e.addSubtract)};\n`),e.toggle&&(e.toggle.randomize&&(s+=`const randomizeFieldsToggleOff = ${f(e.toggle?.randomize)};\n`),e.toggle.addSubtract&&(s+=`const addSubtractFieldsToggleOff = ${f(e.toggle?.addSubtract)};\n`))),b(e)?s+function(e,t){let s=[];e.randomize&&s.push("randomizeFields");e.addSubtract&&s.push("addSubtractFields");if(s=s.join(", "),"toggle"===e.method){let a=[];return e.toggle?.randomize&&a.push("randomizeFields: randomizeFieldsToggleOff"),e.toggle?.addSubtract&&a.push("addSubtractFields: addSubtractFieldsToggleOff"),a=a.join(", "),`\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n  \ntargets.forEach((t) => {\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\n  else toggleOnTargets.push(t);\n});\n  \nawait MassEdit.api.performMassUpdate.call({${s}}, update, toggleOnTargets, '${t}');\nawait MassEdit.api.performMassUpdate.call({${a}}, update2, toggleOffTargets, '${t}');\n`}return`await MassEdit.api.performMassUpdate.call({${s}}, update, targets, '${t}');\n`}(e,t):s+function(e,t){let s="";if(foundry.utils.isEmpty(e.fields)&&!e.toggle)return"";if(e.toggle&&foundry.utils.isEmpty(e.toggle.fields)&&foundry.utils.isEmpty(e.fields))return"\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n\ntargets.forEach((t) => {\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\n  else toggleOnTargets.push(t);\n});\n    ";const i=(e.macro||e.toggle?.macro)&&e.toggle;i&&(s+="\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n  ");a.Me.includes(t)?(s+="\nconst updates = {};","toggle"===e.method?s+=`\ntargets.forEach((t) => {\n  const sceneId = t.parent.id;\n  if(!updates[sceneId]) updates[sceneId] = [];\n\n  let u;\n  if(toggleOn(t, update)) {\n    u = foundry.utils.deepClone(update2);${i?"\ntoggleOffTargets.push(t);":""}\n  } else {\n    u = foundry.utils.deepClone(update);${i?"\ntoggleOnTargets.push(t);":""}\n  }\n  u._id = t.id;\n\n  updates[sceneId].push(u);\n});\n  `:s+="\ntargets.forEach((t) => {\n  const sceneId = t.parent.id;\n  if(!updates[sceneId]) updates[sceneId] = [];\n  \n  let u = foundry.utils.deepClone(update);\n  u._id = t.id;\n    updates[sceneId].push(u);\n});\n  "):(s+="\nconst updates = [];","toggle"===e.method?s+=`\ntargets.forEach((t) => {\n  let u;\n  if(toggleOn(t, update)) {\n    u = foundry.utils.deepClone(update2);${i?"\ntoggleOffTargets.push(t);":""}\n  } else {\n    u = foundry.utils.deepClone(update);${i?"\ntoggleOnTargets.push(t);":""}\n  }\n  u._id = t.id;\n  updates.push(u);\n});\n  `:s+="\ntargets.forEach((t) => {\n  let u = foundry.utils.deepClone(update);\n  u._id = t.id;\n  updates.push(u);\n});\n  ");a.Me.includes(t)?s+=`\nfor(const sceneId of Object.keys(updates)) {\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${t}', updates[sceneId]);\n}\n  `:s+="PlaylistSound"===t?"\nfor (let i = 0; i < targets.length; i++) {\n  delete updates[i]._id;\n  targets[i].document.update(updates[i]);\n}\n  ":`\n${t}.updateDocuments(updates);\n`;return s}(e,t)}return"massEdit"===e.method?`\n// Open Mass Edit Form\nawait MassEdit.api.showMassEdit(targets, '${t}');`:"delete"===e.method?function(e,t){let s=`\n// Delete ${t}s`;a.Me.includes(t)?"selected"===e.target.scope||"scene"===e.target.scope?s+=`\ncanvas.scene.deleteEmbeddedDocuments('${t}', targets.map(t => t.id));`:s+=`\nconst toDelete = {};\ntargets.forEach( t => {\n  const sceneID = t.parent.id;\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\n  toDelete[sceneID].push(t.id);\n});\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${t}', toDelete[sceneID]));\n      `:s+=`\n${t}.deleteDocuments(targets.map( t => t.id ));`;return s}(e,t):void 0}function g(e,t,s){const i=e.target;if("ids"===i.method)return function(e,t,s){let i=`const ids = [${s.map((e=>`"${e.id}"`)).join(",")}];\n`;i+="const targets = [];",a.Me.includes(t)?i+=`\nids.forEach( id => {\n  Array.from(game.scenes).forEach( scene => {\n    let embed = scene.getEmbeddedDocument('${t}', id);\n    if(embed) targets.push(embed)\n  });\n});\n`:i+=`\nids.forEach(id => { \n  const doc = ${t}.get(id);\n  if(doc) targets.push(doc);\n});`;return i}(0,t,s);if("search"===i.method)return function(e,t){let s=f(e.fields);if("selected"===e.scope){let e=p(t);return e+=`\ntargets = await MassEdit.api.performMassSearch('meSearch', '${t}' , ${s}, { scope: 'selected', selected: targets, control: false, pan: false });`,e}if("scene"===e.scope)return`const targets = await MassEdit.api.performMassSearch('meSearch', '${t}' , ${s}, { scope: 'scene', control: false, pan: false });`;if("world"===e.scope)return`const targets = await MassEdit.api.performMassSearch('meSearch', '${t}' , ${s}, { scope: 'world', control: false, pan: false });`}(i,t);if("tagger"===i.method)return function(e,t){let s="";const a={matchAny:"any"===e.tagger.match,allScenes:"world"===e.scope};"selected"===e.scope?(s+=p(t),s+=`targets = Tagger.getByTag('${e.tagger.tags}', { matchAny: ${"any"===e.tagger.match}, objects: targets }).filter(t => t.documentName === '${t}');\n\n`):"scene"===e.scope?s+=`const targets = Tagger.getByTag('${e.tagger.tags}', ${f(a)}).filter(t => t.documentName === '${t}');\n\n`:"world"===e.scope&&(s+="const targets = [];",s+=`Object.values(Tagger.getByTag('${e.tagger.tags}', ${f(a)})).forEach(item => item.forEach(t => { if(t.documentName === '${t}') targets.push(t) }));`);return s}(i,t);if("all"===i.method)return function(e,t){if("selected"===e.scope)return p(t);if(!a.Me.includes(t))return`const targets = Array.from(game.collections.get('${t}'));`;if("scene"===e.scope)return`const targets = canvas.getLayerByEmbeddedName('${t}').placeables.map(o => o.document);\n\n`;if("world"===e.scope)return`const targets = [];\nArray.from(game.scenes).forEach( scene => {\n  Array.from( scene.getEmbeddedCollection('${t}') ).forEach(embed => targets.push(embed));\n});\n  `}(i,t);throw new Error("Invalid target method: "+i.method)}function p(e){let t="";if(a.Me.includes(e))return`let targets = canvas.getLayerByEmbeddedName('${e}').controlled.map(o => o.document);\n\n`;if(game.modules.get("multiple-document-selection")?.active){const s={Actor:"actor",Scene:"scene",JournalEntry:"journalentry",Playlist:"sound",Item:"item",RollTable:"RollTable",Cards:"cards"};return t+="let targets = [];\n",t+="Playlist"===e?`\n$(\`.directory-list .\${'${s[e]}'}.selected\`).each(function (_) {\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\n  if (d) targets.push(d);\n});\n`:`\n$(\`.directory-list .\${'${s[e]}'}.selected\`).each(function (_) {\n  let d = game.collections.get('${e}').get(this.dataset.documentId);\n  if (d) targets.push(d);\n});\n  `,t}throw new Error(`'Selected' is not a supported options for ${e}s`)}function f(e){return e?JSON.stringify(e,null,2):null}async function y(e,t,s){let i="";if(i+=function(e,t){let s="";const i=e=>`ui.notifications.warn('${(0,a.zS)("macro.dependency-warning",{module:e})}');`;"tagger"===e.target.method&&(s+=`\nif (!game.modules.get('tagger')?.active) {\n  ${i("Tagger")}\n  return;\n}\n\n`);(function(e){return e.randomize||e.addSubtract||e.toggle?.randomize||e.toggle?.addSubtract||"search"===e.target.method||"massEdit"===e.method||w(e.fields)})(e)&&(s+=`\nconst MassEdit = game.modules.get('${a.Do}');\nif(!MassEdit?.active){\n  ${i("Mass Edit")}\n  return;\n}\n\n`);a.lv.includes(t)&&"select"===e.target.scope&&(s+=`\nif (!game.modules.get('multiple-document-selection')?.active) {\n  ${i("Multiple Document Selection")}\n  return;\n}\n\n`);return s}(s,e),i+=g(s,e,t),i+=m(s,e),(s.macro||s.toggle?.macro)&&(i+=function(e,t){let s=`\n\n// ===================\n// = Macro Execution =\n// ===================\n\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\nconst layer = canvas.getLayerByEmbeddedName('${t}');\n`;e.macro&&(s+=`\n// Apply macro\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${e.macro.name}')\nif (applyMacro && ${e.toggle?"toggleOnTargets":"targets"}.length) {\n  ${e.macro.select?`layer.activate();\n  layer.releaseAll();\n  ${e.toggle?"toggleOnTargets":"targets"}.forEach(t => t.object?.control({ releaseOthers: false }));\n`:""}\n  if (advancedMacro) applyMacro.execute(${e.toggle?"toggleOnTargets":"targets"});\n  else applyMacro.execute({token, actor});\n  ${e.macro.select?"\n  layer.releaseAll();":""}\n}\n`);e.toggle?.macro&&(s+=`\n// Apply macro on toggle off\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${e.toggle.macro.name}')\nif (offMacro && toggleOffTargets.length) {\n  ${e.toggle.macro.select?"layer.activate();\n  layer.releaseAll();\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\n":""}\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\n  else offMacro.execute({token, actor});\n  ${e.toggle.macro.select?"\n  layer.releaseAll();":""}\n}\n`);return s}(s,e)),i){(await Macro.create({name:s.name,type:"script",scope:"global",command:i})).sheet.render(!0)}}function b(e){return e.randomize||e.addSubtract||e.toggle?.randomize||e.toggle?.addSubtract||w(e.fields)}function w(e){const t=["tokenmagic.ddTint","tokenmagic.preset","massedit.scale","massedit.texture.scale"];for(const s of t)if(s in e)return!0;return!1}class MacroForm extends FormApplication{constructor(e,t,s,a,i,n){super({},{}),this.mainObject=e,this.placeables=t,this.documentName=s,this.fields=a,this.randomizeFields=i,this.addSubtractFields=n,i&&!foundry.utils.isEmpty(i)||n&&!foundry.utils.isEmpty(n)||u.A.formToData(this.documentName,this.mainObject,this.fields)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-macro",classes:["sheet"],template:`modules/${a.Do}/templates/macro.html`,resizable:!0,minimizable:!1,title:"Generate Macro",width:400,height:"auto"})}async getData(e){const t=super.getData(e);t.documentName=this.documentName,t.fields=JSON.stringify(this.fields,null,2),t.selectable=a.Me.includes(this.documentName),t.selectScopeEnabled=t.selectable||a.lv.includes(this.documentName)&&game.modules.get("multiple-document-selection")?.active;const s=[{value:"all",title:(0,a.zS)("macro.target-all-title",{document:this.documentName}),label:(0,a.kg)("common.all")},{value:"ids",title:(0,a.kg)("macro.target-ids-title"),label:(0,a.kg)("macro.target-ids")},{value:"search",title:(0,a.zS)("macro.target-search-title",{document:this.documentName}),label:(0,a.kg)("FILES.Search",!1)}];return a.Me.includes(this.documentName)&&game.modules.get("tagger")?.active&&s.push({value:"tagger",title:(0,a.kg)("macro.target-tagger-title"),label:"Tagger"}),t.targetingOptions=s,this.addSubtractFields&&!foundry.utils.isEmpty(this.addSubtractFields)&&(t.hasAddSubtract=!0,t.addSubtract=JSON.stringify(this.addSubtractFields)),this.randomizeFields&&!foundry.utils.isEmpty(this.randomizeFields)&&(t.hasRandom=!0,t.randomize=JSON.stringify(this.randomizeFields)),t.hasMEControls=t.hasAddSubtract||t.hasRandom||w(this.fields),t.hiddenControl=["Token","Tile","Drawing","AmbientLight","AmbientSound","MeasuredTemplate"].includes(this.documentName),t.macros=game.collections.get("Macro").map((e=>e.name)),t}_onShowReturnJson(e,t){const s=e.siblings(`[name="${t}"]`),i=JSON.parse(s.val());let n=`<textarea name="json" style="width:100%; height: 300px;">${JSON.stringify(i,null,2)}</textarea>`;new Dialog({title:"JSON",content:n,buttons:{Ok:{label:(0,a.kg)("Save",!1),callback:t=>{try{const a=JSON.parse(t.find('[name="json"]').val()||"{}");foundry.utils.isEmpty(a)?(e.hide(),s.prop("disabled",!0),this.setPosition({height:"auto"})):s.val(JSON.stringify(a))}catch(e){ui.notifications.warn("Invalid data. Failed to save.")}}}}}).render(!0)}_onRemoveJson(e,t){const s=e.siblings(`[name="${t}"]`);e.hide(),s.prop("disabled",!0),this.setPosition({height:"auto"})}activateListeners(e){super.activateListeners(e),["randomize","addSubtract","toggle.randomize","toggle.addSubtract"].forEach((t=>{const s=t.replace(".","");e.find(`.${s}`).click((e=>{this._onShowReturnJson($(e.target).parent(),t)})),e.find(`.${s}`).contextmenu((e=>{this._onRemoveJson($(e.target).parent(),t)}))})),e.find(".toggleVisibility").click((t=>{const s=e.find('[name="fields"]'),a=e.find('[name="toggle.fields"]');let i,n={};try{i=JSON.parse(s.val()),i.hidden=!i.hidden,s.val(JSON.stringify(i,null,2)),n=JSON.parse(a.val()),n.hidden=!i.hidden,a.val(JSON.stringify(n,null,2))}catch(e){}})),e.find('[name="target.method"]').change((t=>{"tagger"===t.target.value?(e.find(".taggerControl").show(),e.find('[name="tags"').attr("required",!0)):(e.find(".taggerControl").hide(),e.find('[name="tags"').attr("required",!1)),"ids"===t.target.value?e.find('[name="target.scope"]').closest(".form-group").hide():e.find('[name="target.scope"]').closest(".form-group").show(),"search"===t.target.value?e.find('[name="target.fields"]').closest("div").show():e.find('[name="target.fields"]').closest("div").hide(),this.setPosition({height:"auto"})})),e.find('[name="method"]').on("change",(t=>{if("toggle"===t.target.value){let t=foundry.utils.flattenObject((s=this.mainObject,s.document?s.document:s).toObject());const a={};Object.keys(this.fields).forEach((e=>a[e]=t[e])),e.find('[name="toggle.fields"]').val(JSON.stringify(a,null,2)),e.find(".toggleControl").show(),this.setPosition({height:"auto"})}else e.find(".toggleControl").hide(),this.setPosition({height:"auto"});var s;"massEdit"===t.target.value||"delete"===t.target.value?(e.find(".fields").hide(),this.setPosition({height:"auto"})):(e.find(".fields").show(),this.setPosition({height:"auto"}))}))}async _updateObject(e,t){(t=expandObject(t)).fields=JSON.parse(t.fields),"toggle"!==t.method?delete t.toggle:t.toggle.fields=JSON.parse(t.toggle.fields),t.macro.name||delete t.macro,t.toggle?.macro&&!t.toggle.macro.name&&delete t.toggle.macro,"tagger"!==t.target.method&&delete t.target.tagger,"search"!==t.target.method?delete t.target.fields:t.target.fields=JSON.parse(t.target.fields),t.randomize&&(t.randomize=JSON.parse(t.randomize)),t.toggle?.randomize&&(t.toggle.randomize=JSON.parse(t.toggle.randomize)),t.addSubtract&&(t.addSubtract=JSON.parse(t.addSubtract)),t.toggle?.addSubtract&&(t.toggle.addSubtract=JSON.parse(t.toggle.addSubtract)),y(this.documentName,this.placeables,t)}}var k=s(739);const x=e=>{class BaseMassEditForm extends e{constructor(e,t,s){s.massSelect&&(s.randomizerEnabled=!1);const i=s.documentName??(0,a.Ng)(e);s.commonData||(s.commonData=(0,h.GS)(t,i)),BaseMassEditForm._setMEActions(s),"AmbientSound"===i||"AmbientLight"===i?(s.document=e,super(s)):super(e,s),this.meObjects=t,this.documentName=i,this.commonData=foundry.utils.flattenObject(s.commonData||{}),this.randomizerEnabled=s.massEdit,this.randomizeFields={},this.addSubtractFields={},this.meForm=!0,this.rangeSpanToTextbox=game.settings.get(a.Do,"rangeToTextbox")}get baseDocument(){throw Error("The getBaseDocument() method must be defined by a subclass.")}get title(){return this.options.massSelect?(0,a.zS)("form.mass-search-title",{document:this.documentName}):(0,a.zS)("form.mass-edit-title",{document:this.documentName,count:this.meObjects.length})}static async massUpdateObject(e,t){if(!(t=$(t)).data("action"))return;const s=this.getSelectedFields();if("Token"===this.documentName&&u.f.correctDetectionModeOrder(s,this.randomizeFields),!this.options.presetEdit)return this.options.massSelect?(0,h.qn)(t.data("action"),this.documentName,s,{scope:this.modUpdate?this.modUpdateType:null}):h.pt.call(this,s,this.meObjects,this.documentName,t.data("action"));this.options.callback?.({data:s,addSubtract:this.addSubtractFields,randomize:this.randomizeFields})}getSelectedFields(e){e||(e=this._getSubmitData()),"flags.levels-3d-preview.shaders"in(e=foundry.utils.flattenObject(e))&&(e["flags.levels-3d-preview.shaders"]=this.baseDocument.getFlag("levels-3d-preview","shaders")),"Token"===this.documentName?e["texture.scaleX"]&&(e.scale=Math.abs(e["texture.scaleX"]),e.mirrorX=e["texture.scaleX"]<0,e.mirrorY=e["texture.scaleY"]<0):"Note"===this.documentName&&e["texture.src"]&&(e["icon.selected"]=e["texture.src"],e["icon.custom"]=e["texture.src"]);const t={},s=$(this.element),i=this.addSubtractFields,n=this;return s.find(".form-group").each((function(s){const o=$(this).find(".mass-edit-checkbox > input");o.length&&o.is(":checked")&&$(this).find("[name]").each((function(s){const o=$(this).attr("name");if("flags.limits"===o){const e=foundry.utils.flattenObject(n.meObjects[0].toObject().flags.limits??{});for(const[s,a]of Object.entries(e))t["flags.limits."+s]=a}if(void 0===e[o]&&o.startsWith("flags.")){const s=(0,a.p)(o,e);s&&(t[s]=null)}else t[o]=e[o],o in i&&(i[o].value=e[o]);if("string"===foundry.utils.getType(t[o])){const e=$(this);if(e.hasClass("tva-array"))v.trim()?t[o]=t[o].trim().split(",").map((e=>e.trim())):t[o]=[];else if(e.hasClass("tva-jsonArray"))try{t[o]=JSON.parse(t[o])}catch(e){t[o]=[]}}}))})),t}performMassCopy({command:e="",selectedFields:t=null}={}){if(t||(t=this.getSelectedFields(),"Token"===this.documentName&&u.f.correctDetectionModeOrder(t,this.randomizeFields)),foundry.utils.isEmpty(t))return!1;const s=new r.k({documentName:this.documentName,data:t,randomize:this.randomizeFields,addSubtract:this.addSubtractFields});return(0,h.lW)(s,e,this.isPrototype),!0}_setStyle(e){const[t,s]=(0,d.QD)();e.prepend(`<style>${s}</style>`)}_injectGlobalDeleteButton(e){if(!a.Me.includes(this.documentName)&&!a.lv.includes(this.documentName))return;const t=$(`<div class="me-global-delete"><a title="${(0,a.kg)("form.global-delete-title")}"><i class="far fa-times-octagon fa-2x"></i></a></div>`);t.click((e=>{new Dialog({title:"Confirm",content:`\n                <h2 style="color: red; text-align: center;">${(0,a.zS)("form.delete-warning",{count:this.meObjects.length,document:this.documentName})}</h2>\n                <p>${(0,a.kg)("form.proceed")}</p>`,buttons:{buttonA:{label:(0,a.kg)("Yes",!1),callback:()=>{this.meObjects.forEach((e=>{let t=e.document??e;t.delete&&t.delete()})),this.close()}},no:{label:(0,a.kg)("No",!1)}},default:"buttonA"}).render(!0)})),e.closest("form").append(t)}_activateAutoSelectListeners(e){e.on("input",'textarea, input[type="text"], input[type="number"], range-picker, color-picker',h.Yp.bind(this)),e.on("change","textarea, input, select",h.Yp.bind(this)),e.on("paste","input",h.Yp.bind(this)),e.on("click","button",h.Yp.bind(this))}_processFormGroup(e,t=null){if(!$(e).find("[name]").length)return;if($(e).find(".mass-edit-checkbox").length)return;const s=this.commonData,a=this.rangeSpanToTextbox,i=this.randomizerEnabled;let n="meCommon";s&&$(e).find("[name]").each((function(){const t=$(this).attr("name");if(a&&"range"===$(this).attr("type")){const s=$(e).find("span.range-value");s.length&&(s.replaceWith($(`<input name="${t}" class="range-value" type="number" step="any" value="${this.defaultValue}" min="${this.min}" max="${this.max}"></input>`)),$(this).removeAttr("name"))}t.startsWith("flags.")?n="meFlag":t in s||"invert-radius"===t||(n="meDiff")}));let o="";i&&(o='<div class="mass-edit-randomize"></div>'),n=t??n;const r=$(`<div class="mass-edit-checkbox ${n}">${o}<input class="mass-edit-control" type="checkbox" data-dtype="Boolean"}></div>`);$(e).find("p.hint, p.notes").length?$(e).find("p.hint, p.notes").first().before(r):$(e).append(r),$(e).addClass(n)}_processAllFormGroups(e){const t=this._processFormGroup.bind(this);e.find(".form-group").each((function(e){t(this)}))}async _processPreset(e){let t=!1;const s=foundry.utils.flattenObject(e.data[0]);"flags.monks-active-tiles.actions"in s&&(t=!0,await this.baseDocument.setFlag("monks-active-tiles","actions",s["flags.monks-active-tiles.actions"])),"flags.monks-active-tiles.files"in s&&(t=!0,await this.baseDocument.setFlag("monks-active-tiles","files",s["flags.monks-active-tiles.files"])),"flags.levels-3d-preview.shaders"in s&&(t=!0,await this.baseDocument.setFlag("levels-3d-preview","shaders",s["flags.levels-3d-preview.shaders"])),"flags.limits.light.enabled"in s&&(t=!0,await this.baseDocument.update({flags:{limits:foundry.utils.expandObject(s).flags.limits}})),"Token"===this.documentName&&(t=u.f.modifyPresetData(this,s)),t?setTimeout((()=>{this._applyPreset(e)}),250):this._applyPreset(e)}_applyPreset(e){const t=$(this.form),s=(e,t)=>{if(!t)return e;for(const[s,a]of Object.entries(t))e[s]=a;return e};this.randomizeFields=s(this.randomizeFields,e.randomize),this.addSubtractFields=s(this.addSubtractFields,e.addSubtract),(0,l.RZ)(t,this.randomizeFields),(0,a.Tx)(t,this.addSubtractFields);const n=foundry.utils.flattenObject(e.data[0]);u.A.dataToForm(this.documentName,e.data[0],n);for(const e of Object.keys(n)){const s=t.find(`[name="${e}"]`);s.is(":checkbox")?s.prop("checked",n[e]):s.val(n[e]),s.trigger("change")}i.vM.refreshPreset()}_registerRandomizerListeners(e){const t=this;this.randomizerEnabled&&e.on("contextmenu",".mass-edit-checkbox",(e=>{s.e(816).then(s.bind(s,816)).then((s=>{s.showRandomizeDialog($(e.target).closest(".form-group"),t)}))}))}_registerBrushRefreshListeners(e){e.on("input",'textarea, input[type="text"], input[type="number"]',(()=>i.vM.refreshPreset())),e.on("change","textarea, input, select",(()=>i.vM.refreshPreset())),e.on("paste","input",(()=>i.vM.refreshPreset())),e.on("click","button",(()=>i.vM.refreshPreset()))}_registerNumericalInputListeners(e){e.on("contextmenu",'input[type=range], input[type=number], input[name="flags.tagger.tags"], input[type="text"], input[name="tokenmagic.preset"]',(e=>{const t=e.target.name;if(!t)return;const s=$(e.target);if(t in this.addSubtractFields)if("add"===this.addSubtractFields[t].method){this.addSubtractFields[t].method="subtract",s.removeClass("me-add").addClass("me-subtract"),s.attr("title","- Subtracting");const a={method:"subtract"};e.target.min&&(a.min=parseFloat(e.target.min)),a.type=s.attr("type"),this.addSubtractFields[t]=a}else delete this.addSubtractFields[t],s.removeClass("me-subtract"),s.attr("title","");else{s.addClass("me-add"),s.attr("title","+ Adding");const a={method:"add"};e.target.max&&(a.max=parseFloat(e.target.max)),a.type=s.attr("type"),this.addSubtractFields[t]=a}(0,h.Yp)(e),i.vM.refreshPreset()}))}_registerInputChangeCallback(e){this.options.inputChangeCallback&&e.on("change","input, select",(async e=>{setTimeout((()=>this.options.inputChangeCallback(this.getSelectedFields())),100)}))}_registerNavigationTabMassSelect(e){e.on("contextmenu","nav > .item",(e=>{const t=e.target.dataset?.tab;if(t){const s=$(e.target).closest("nav").attr("data-group");let a;s&&(a=$(e.target).closest("form").find(`.tab[data-tab="${t}"][data-group="${s}"], .matt-tab[data-tab="${t}"][data-group="${s}"]`).find(".mass-edit-control")),a&&0!==a.length||(a=$(e.target).closest("form").find(`.tab[data-tab="${t}"], .matt-tab[data-tab="${t}"]`).find(".mass-edit-control"));let i=!0;0===a.not(":checked").length&&(i=!1),a.prop("checked",i),a.each((function(){i?selectTabs(this):deselectTabs(this)})),a.first().trigger("change")}}))}_insertModuleSpecificFields(e){if("Tile"===this.documentName&&this._createAction){let t=$(`\n              <div class="form-group">\n                <label>Mass Edit: ${(0,a.kg)("form.actions")}</label>\n                <div class="form-fields">\n                    <input type="hidden" name="flags.monks-active-tiles.actions">\n                </div>\n              `);$(e).find('.matt-tab[data-tab="trigger-actions"]').prepend(t),this._processFormGroup(t,"meInsert"),t=$(`\n              <div class="form-group">\n                <label>Mass Edit: ${(0,a.kg)("form.images")}</label>\n                <div class="form-fields">\n                    <input type="hidden" name="flags.monks-active-tiles.files">\n                </div>\n              `),t.insertBefore('.matt-tab[data-tab="trigger-images"] .files-list'),this._processFormGroup(t,"meInsert")}if(("Tile"===this.documentName||"Token"===this.documentName)&&game.Levels3DPreview){let t=$(`\n              <div class="form-group">\n                <label>Mass Edit: ${(0,a.kg)("form.shaders")}</label>\n                <div class="form-fields">\n                    <input type="hidden" name="flags.levels-3d-preview.shaders">\n                </div>\n              `);$(e).find("#shader-config").after(t),this._processFormGroup(t,"meInsert")}}_insertSpecialFields(e){if(("Tile"===this.documentName||"Token"===this.documentName)&&!this.options?.simplified&&game.modules.get("tokenmagic")?.active&&game.settings.get(a.Do,"tmfxFieldsEnable")){let t='<datalist id="tmfxPresets"><option value="DELETE ALL">';TokenMagic.getPresets().forEach((e=>t+=`<option value="${e.name}">`)),t+='</datalist><input list="tmfxPresets" name="tokenmagic.preset">';let s=$(`\n              <div class="form-group">\n                <label>${(0,a.kg)("common.preset")} <span class="units">(TMFX)</span></label>\n                <div class="form-fields">\n                  ${t}\n                </div>\n              `);$(e).find('[name="texture.tint"]').closest(".form-group").after(s),this._processFormGroup(s,"meInsert");const i=(0,c.qT)(this.baseDocument.object??this.baseDocument);s=$(`\n              <div class="form-group">\n                <label>DungeonDraft <span class="units">(TMFX)</span></label>\n                <div class="form-fields">\n                  <input class="color" type="text" name="tokenmagic.ddTint" value="${i}">\n                  <input type="color" value="${i}" data-edit="tokenmagic.ddTint">\n                </div>\n              `),$(e).find('[name="texture.tint"]').closest(".form-group").after(s),this._processFormGroup(s,"meInsert")}if("Tile"===this.documentName){let t=$(`\n            <div class="form-group slim">\n              <label>${(0,a.kg)("Scale",!1)} <span class="units">(${(0,a.kg)("common.ratio")})</span></label>\n              <div class="form-fields">\n                <label>${(0,a.kg)("Width",!1)} | ${(0,a.kg)("Height",!1)} ${game.Levels3DPreview?._active?"| Depth":""}</label>\n                <input type="number" value="1" step="any" name="massedit.scale" min="0">\n              </div>\n            </div>`);$(e).find('[name="width"]').closest(".form-group").before(t),this._processFormGroup(t,"meInsert"),t=$(`\n              <div class="form-group slim">\n                <label>${(0,a.kg)("TILE.Scale",!1)} <span class="units">(${(0,a.kg)("common.ratio")})</span></label>\n                <div class="form-fields">\n                  <label>${(0,a.kg)("TILE.ScaleX",!1)} | ${(0,a.kg)("TILE.ScaleY",!1)}</label>\n                  <input type="number" value="1" step="any" name="massedit.texture.scale" min="0">\n                </div>\n              </div>`),$(e).find('[name="texture.scaleX"]').closest(".form-group").before(t),this._processFormGroup(t,"meInsert")}}_insertModUpdateCheckboxes(e){if(this.options.massEdit&&!this.options.simplified&&!this.options.presetEdit){const t=this;e.find('button[type="submit"]').each((function(){const s=$(this),i=$(`<div class="me-mod-update" title="${(0,a.kg)("form.immediate-update-title")}"><input type="checkbox" data-submit="${s.data("action")}"><i class="fas fa-cogs"></i></div>`);i.on("change",(s=>{s.stopPropagation();const a=s.target.checked;e.find(".me-mod-update > input").not(this).prop("checked",!1),$(s.target).prop("checked",a),t.modUpdate=a,t.modUpdateType=$(s.target).data("submit")})),i.insertAfter(s)}))}}_performOnInputChangeUpdate(){const e=this.getSelectedFields();h.pt.call(this,e,this.meObjects,this.documentName,this.modUpdateType)}_registerMutateObserver(e){const t=this._processFormGroup.bind(this);new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{$(e).hasClass("form-group")?t(e):$(e).find(".form-group").each((function(){$(this).find(".mass-edit-checkbox").length||t(this)}))}))}))})).observe(e[0],{characterData:!1,attributes:!1,childList:!0,subtree:!0})}_onClose(e={}){return e.force=!0,i.vM.deactivate(),this.linkedPresetForm&&this.linkedPresetForm.close(),super._onClose?.(e)}static _openMacroForm(){const e=this.getSelectedFields();new MacroForm(this.baseDocument,this.meObjects,this.documentName,e,this.randomizeFields,this.addSubtractFields).render(!0)}static _activateBrushTool(){i.vM.activate({app:this})}static _openEditPermissions(){let e=[];const t=new Set;for(const s of this.meObjects){let a;"Actor"===this.documentName||"JournalEntry"===this.documentName?a=s:"Token"===this.documentName&&s.actor?a=s.actor:"Note"===this.documentName&&s.entry&&(a=s.entry),a&&!t.has(a.id)&&(e.push(a),t.add(a.id))}new(D())(e[0],e).render(!0)}static _openPresetBrowser(){this.linkedPresetForm=new o.P(this,null,this.documentName,{left:this.position.left-370,top:this.position.top,preventPositionOverride:!0}),this.linkedPresetForm.render(!0)}static _openViewApplyJSON(){let e=foundry.utils.expandObject(this.getSelectedFields());e=foundry.utils.isEmpty(e)?"":JSON.stringify(e,null,2);let t=`<textarea class="json" style="width:100%; height: 300px;">${e}</textarea>`;new Dialog({title:(0,a.kg)("form.apply-json"),content:t,buttons:{apply:{label:(0,a.kg)("common.apply"),callback:e=>{let t={};try{t=JSON.parse(e.find(".json").val())}catch(e){}if(!foundry.utils.isEmpty(t)){const e=new r.k({documentName:this.documentName,data:foundry.utils.flattenObject(t)});this._processPreset(e)}}}}}).render(!0)}static _showMassActorForm(){(0,k.Pw)(this.meObjects,{massEdit:this.options.massEdit})&&this.close()}static _setMEActions(e){const t=e.action??{};t.meMacroGen=this._openMacroForm,t.meBrush=this._activateBrushTool,t.meEditPermissions=this._openEditPermissions,t.mePresetBrowser=this._openPresetBrowser,t.meJSON=this._openViewApplyJSON,t.meTokenActor=this._showMassActorForm,["meSearch","meSearchAndEdit","meApplyCurrentScene","meApplyAllScenes","meApply","meApplyToPrototype"].forEach((e=>{t[e]=this.massUpdateObject})),e.actions=t}_meGetSubmitButtons(){const e=[];return this.options.massSelect?(e.push({type:"submit",icon:"fas fa-search",label:(0,a.kg)("FILES.Search",!1),action:"meSearch"}),e.push({type:"submit",icon:"fas fa-search",label:(0,a.kg)("form.search-and-edit"),action:"meSearchAndEdit"})):"Note"!==this.documentName||this.options.presetEdit?(e.push({type:"submit",label:(0,a.kg)("common.apply"),icon:"far fa-save",action:"meApply"}),"Token"!==this.documentName||this.options.simplified||this.meObjects[0].constructor?.name?.startsWith("PrototypeToken")||this.options.presetEdit||e.push({type:"submit",label:(0,a.kg)("form.apply-update-proto"),icon:"far fa-save",action:"meApplyToPrototype"})):(this.meObjects.filter((e=>(e.scene??e.parent).id===canvas.scene.id)).length&&e.push({type:"submit",icon:"far fa-save",label:(0,a.kg)("form.apply-on-current-scene"),action:"meApplyCurrentScene"}),this.meObjects.filter((e=>(e.scene??e.parent).id!==canvas.scene.id)).length&&e.push({type:"submit",label:(0,a.kg)("form.apply-on-all-scenes"),icon:"fas fa-globe",action:"meApplyAllScenes"})),e}_getMeControls(){return[{label:"Generate Macro",class:"mass-edit-macro",icon:"fas fa-terminal",action:"meMacroGen",visible:a.Me.includes(this.documentName)||a.lv.includes(this.documentName)},{label:"Brush",class:"mass-edit-brush",icon:"fas fa-paint-brush",action:"meBrush",visible:a.Me.includes(this.documentName)},{label:"Permissions",class:"mass-edit-permissions",icon:"fas fa-lock fa-fw",action:"meEditPermissions",visible:["Token","Note","Actor"].includes(this.documentName)},{label:"Presets",class:"mass-edit-presets",icon:"fas fa-box",action:"mePresetBrowser",visible:!this.options.simplified},{label:"JSON",class:"mass-edit-apply",icon:"far fa-money-check-edit",action:"meJSON",visible:!0},{label:"Switch",class:"mass-edit-actors",icon:"fas fa-user",action:"meTokenActor",visible:"Token"===this.documentName&&this.meObjects.filter((e=>e.actor)).length}]}}return BaseMassEditForm},_=e=>class MassEditForm extends e{_attachFrameListeners(){super._attachFrameListeners()}_onRender(){super._onRender(),n(this);const e=$(this.element);this._injectGlobalDeleteButton(e),this._setStyle(e),this._activateAutoSelectListeners(e),this._processAllFormGroups(e),this._registerRandomizerListeners(e),this._registerBrushRefreshListeners(e),this._registerNumericalInputListeners(e),this._registerInputChangeCallback(e),this._registerNavigationTabMassSelect(e),this._insertModUpdateCheckboxes(e),this._insertModuleSpecificFields(e),this._insertSpecialFields(e),this._registerMutateObserver(e)}get baseDocument(){return this.document}_getSubmitData(){const e=this.element,t=new FormDataExtended(e);return this._prepareSubmitData(null,e,t)}_getHeaderControls(){return[].concat(super._getHeaderControls()).concat(this._getMeControls())}async _prepareContext(e){const t=await super._prepareContext(e);return t.buttons=(t.buttons??[]).filter((e=>"submit"!==e.type)),t.buttons=t.buttons.concat(this._meGetSubmitButtons()),t}async render(e={},t={}){if(!t.renderContext?.startsWith("update"))return super.render(e,t)}},T=e=>class MassEditForm extends e{async getData(e){"AmbientLight"!==this.documentName||this.preview||(this.preview=this.baseDocument.clone());return super.getData(e)}get baseDocument(){return this.object}async activateListeners(e){await super.activateListeners(e),n(this),this._injectGlobalDeleteButton(e),this._setStyle(e),this._activateAutoSelectListeners(e),this._processAllFormGroups(e),this._registerRandomizerListeners(e),this._registerBrushRefreshListeners(e),this._registerNumericalInputListeners(e),this._registerInputChangeCallback(e),this._registerNavigationTabMassSelect(e),this._removeFooterButtons(e),this._insertSubmitButtons(e),this._insertModUpdateCheckboxes(e),this._insertModuleSpecificFields(e),this._insertSpecialFields(e),this._registerMutateObserver(e),this.setPosition(),this.element[0].style.height="","Token"===this.documentName&&$(e).find("fieldset.detection-mode").each((function(e){$(this).wrap('<div class="form-group"></div>')}))}_insertSubmitButtons(e){const t=this._meGetSubmitButtons();let s="";if(!this._meSubmitInserted){this._meSubmitInserted=!0;for(const e of t)s+=`<button class="me-submit" type="submit" data-action="${e.action}"><i class="${e.icon}"></i> ${e.label}</button>`;this.options.massSelect&&a.Me.includes(this.documentName)&&(s+=`<div class="me-mod-update" title="${(0,a.kg)("form.global-search-title")}"><input type="checkbox" data-submit="world"><i class="far fa-globe"></i></div>`);let i=$(e).find(".sheet-footer").last();i.length?i.append(s):(i=$(`<footer class="sheet-footer flexrow">${s}</footer>`),$(e).closest("form").append(i))}}async _onChangeInput(e){if(!["AmbientLight","Tile","Token"].includes(this.documentName))return void super._onChangeInput(e);const t=e.target;"color"===t.type&&t.dataset.edit?this._onChangeColorPicker(e):"range"===t.type&&this._onChangeRange(e)}async _updateObject(e,t){await this.options.actions.meApply.call(this,e,e.submitter),["Token","AmbientLight"].includes(this.documentName)&&this.preview?.object&&this._resetPreview()}_getHeaderButtons(){let e=super._getHeaderButtons().filter((e=>"configure-sheet"!==e.class));const t=foundry.utils.deepClone(this._getMeControls());return t.forEach((e=>{e.onclick=this.options.actions[e.action].bind(this),e.label=""})),t.concat(e)}_removeFooterButtons(e){e.find(".sheet-footer > button").remove(),e.find('button[type="submit"]').remove()}render(e,t={}){if("update"===t.action||t.renderContext?.startsWith("update"))return;if(!this.form)return super.render(e,t);const s=this.getSelectedFields(),a=this.randomizeFields,i=this.addSubtractFields;super.render(e,t),setTimeout((()=>{this.form&&this._applyPreset(new r.k({data:s,randomize:a,addSubtract:i}))}),1e3)}async close(e={}){return super._onClose(e),["Token","AmbientLight"].includes(this.documentName)&&this.preview?.object&&this._resetPreview(),super.close(e)}},S=e=>{const t=x(e);return foundry.applications?.api?.ApplicationV2&&e.BASE_APPLICATION===foundry.applications.api.ApplicationV2?_(t):T(t)},P=(e="NONE")=>{let t;const s=CONFIG[e]?.sheetClasses;t=s&&"Actor"!==e?Object.values(Object.values(s).pop()??{}).pop()?.cls:FormApplication;const a=S(t);class MassConfig extends a{constructor(e,t,s){super(e.document?e.document:e,t,s)}}const i=`Mass${e}Config`;return Object.defineProperty(MassConfig.prototype.constructor,"name",{value:i}),MassConfig},D=()=>{let e=S(DocumentOwnershipConfig);return class MassPermissions extends e{constructor(e,t,s={}){const i=(0,a.bQ)(t[0]),n=foundry.utils.flattenObject(i.ownership),o=CONST.DOCUMENT_META_OWNERSHIP_LEVELS,r=function(e){game.users.forEach((t=>{t.id in e||(e[t.id]=o.DEFAULT)})),"default"in e||(e.default=o.DEFAULT)};r(n);for(let e=1;e<t.length;e++){const s=(0,a.bQ)(t[e]),i=foundry.utils.flattenObject(s.ownership);r(i);const o=foundry.utils.flattenObject(foundry.utils.diffObject(n,i));for(const e of Object.keys(o))delete n[e]}s.commonData=n,s.massPermissions=!0,super(e,t,s)}async _updateObject(e,t){const s=this.getSelectedFields(t),i=CONST.DOCUMENT_META_OWNERSHIP_LEVELS;if(foundry.utils.isEmpty(s))return;const n=new Set,o=[];for(const e of this.meObjects)if(!n.has(e.id)){const t=(0,a.bQ)(e),r=foundry.utils.deepClone(t.ownership);for(let[e,t]of Object.entries(s))t===i.DEFAULT?delete r[e]:r[e]=t;n.add(e.id),o.push({_id:e.id,ownership:r})}this.meObjects[0].constructor.updateDocuments(o,{diff:!1,recursive:!1,noHook:!0})}get title(){return`Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`}}}},338:(e,t,s)=>{s.d(t,{s:()=>MassEditGenericForm});const a={field:{shieldType:{range:!0,min:"0",max:"13",step:"1"},blend:{range:!0,min:"0",max:"16",step:"1"},scale:{range:!0,min:"0",max:"5",step:"0.01"},radius:{range:!0,min:"0",max:"5",step:"0.01"},intensity:{range:!0,min:"0",max:"5",step:"0.01"},lightAlpha:{range:!0,min:"0",max:"50",step:"0.1"},gridPadding:{range:!0,min:"0",max:"5",step:"0.01"},lightSize:{range:!0,min:"0",max:"20",step:"0.1"},animated:{time:{speed:{range:!0,min:"0",max:"0.05",step:"0.0001"}}}},fire:{fireBlend:{range:!0,min:"0",max:"13",step:"1"},blend:{range:!0,min:"0",max:"13",step:"1"},animated:{intensity:{animType:{select:!0,options:["syncChaoticOscillation","syncSinOscillation","syncCosOscillation","chaoticOscillation","halfSinOscillation","sinOscillation","halfCosOscillation","cosOscillation","syncColorOscillation","halfColorOscillation","colorOscillation"]},val2:{range:!0,min:"0",max:"5",step:"0.1"},val1:{range:!0,min:"0",max:"5",step:"0.1"},loopDuration:{range:!0,min:"0",max:"50000",step:"100"}},amplitude:{animType:{select:!0,options:["syncChaoticOscillation","syncSinOscillation","syncCosOscillation","chaoticOscillation","halfSinOscillation","sinOscillation","halfCosOscillation","cosOscillation","syncColorOscillation","halfColorOscillation","colorOscillation"]},loopDuration:{range:!0,min:"0",max:"50000",step:"100"},val1:{range:!0,min:"0",max:"5",step:"0.1"},val2:{range:!0,min:"0",max:"5",step:"0.1"}}},intensity:{range:!0,min:"0",max:"100",step:"0.1"}},electric:{blend:{range:!0,min:"0",max:"13",step:"1"}},xglow:{auraType:{range:!0,min:"0",max:"2",step:"1"},scale:{range:!0,min:"0",max:"30",step:"0.1"},auraIntensity:{range:!0,min:"0",max:"20",step:"0.1"},subAuraIntensity:{range:!0,min:"0",max:"20",step:"0.1"},threshold:{range:!0,min:"0",max:"2",step:"0.01"},thickness:{range:!0,min:"0",max:"20",step:"0.1"}},glow:{outerStrength:{range:!0,min:"0",max:"50",step:"0.1"},innerStrength:{range:!0,min:"0",max:"50",step:"0.1"},padding:{range:!0,min:"0",max:"100",step:"1"},alpha:{range:!0,min:"0",max:"1",step:"0.01"}},zapshadow:{alphaTolerance:{range:!0,min:"0",max:"1",step:"0.01"}},sprite:{blendMode:{range:!0,min:"0",max:"16",step:"1"},gridPadding:{range:!0,min:"0",max:"5",step:"0.1"},scaleX:{range:!0,min:"0",max:"3",step:"0.01"},scaleY:{range:!0,min:"0",max:"3",step:"0.01"},translationX:{range:!0,min:"-1",max:"1",step:"0.001"},translationY:{range:!0,min:"-1",max:"1",step:"0.001"},rotation:{range:!0,min:"0",max:"360",step:"1"},alpha:{range:!0,min:"0",max:"1",step:"0.01"}},xfire:{blend:{range:!0,min:"0",max:"16",step:"1"},amplitude:{range:!0,min:"0",max:"10",step:"0.01"},dispersion:{range:!0,min:"0",max:"20",step:"0.1"},scaleX:{range:!0,min:"0",max:"5",step:"0.01"},scaleY:{range:!0,min:"0",max:"5",step:"0.01"},animated:{time:{speed:{range:!0,min:"-0.0050",max:"0.0050",step:"0.0001"}}}},transform:{gridPadding:{range:!0,min:"0",max:"50",step:"0.1"},scaleX:{range:!0,min:"0",max:"5",step:"0.1"},scaleY:{range:!0,min:"0",max:"5",step:"0.1"}},ascii:{animated:{size:{val1:{range:!0,min:"-5",max:"5",step:"0.01"},val2:{range:!0,min:"-5",max:"5",step:"0.01"}}},size:{range:!0,min:"1",max:"64",step:"1"}},dot:{scale:{range:!0,min:"0",max:"10",step:"0.1"},angle:{range:!0,min:"0",max:"360",step:"1"}},godray:{blendMode:{range:!0,min:"0",max:"20",step:"1"},padding:{range:!0,min:"-5",max:"50",step:"0.1"}},rgbSplit:{redX:{range:!0,min:"-50",max:"50",step:"1"},redY:{range:!0,min:"-50",max:"50",step:"1"},greenX:{range:!0,min:"-50",max:"50",step:"1"},greenY:{range:!0,min:"-50",max:"50",step:"1"},blueX:{range:!0,min:"-50",max:"50",step:"1"},blueY:{range:!0,min:"-50",max:"50",step:"1"}},polymorph:{type:{range:!0,min:"0",max:"9",step:"1"}},shadow:{blur:{range:!0,min:"0",max:"20",step:"1"}},flood:{billowy:{range:!0,min:"0",max:"5",step:"0.01"},tintIntensity:{range:!0,min:"0.0",max:"1",step:"0.01"},glint:{range:!0,min:"0",max:"1",step:"0.01"},scale:{range:!0,min:"5",max:"500",step:"1"},animated:{time:{speed:{range:!0,min:"0.00001",max:"0.001",step:"0.00001"}}}}};var i=s(120),n=s(622),o=s(739);function r(e,t,s,a=!0){const n={dataGroup:"main",items:[],tabs:[]},o=[{navSelector:'.tabs[data-group="main"]',contentSelector:"form",initial:"me-pinned"}];let r={};r=e;const c=t&&game.settings.get(i.Do,"pinnedFields")[t]||{};l(n,r,o,"",c,s,a);const d=[],u=foundry.utils.flattenObject(r);for(const[e,t]of Object.entries(c)){const i=e in u?u[e]:t.value;let n=g(foundry.utils.getType(i),t.label,i,e,{},!0,s,a);n.pinned=!0,d.push(n)}return d.length&&(n.items.length||(n.items.push({dataTab:"main-me-main",label:"Main"}),n.tabs.push({dataTab:"main-me-main",groups:n.groups}),delete n.groups),n.items.unshift({dataTab:"me-pinned",dataTab:"me-pinned",label:(0,i.kg)("generic-form.pinned")}),n.tabs.unshift({dataTab:"me-pinned",groups:d})),[n,o]}function l(e,t,s,a,i,n,o){const r=[];let u=!1;for(const[h,m]of Object.entries(t)){const t=a?a+"."+h:h;if(null!==m){let a,p=foundry.utils.getType(m);if("Object"===p){if(c(m)){e.items.push({dataTab:t,label:d(h)});const a={dataGroup:t,items:[],tabs:[]};e.tabs.push({dataTab:t,nav:a}),s.push({navSelector:`.tabs[data-group="${t}"]`,contentSelector:`.tab[data-tab="${t}"]`,initial:h+"-me-main"}),l(a,m,s,t,i,n,o),u=!0}}else a=g(p,d(h),m,t,i,!1,n,o);a&&r.push(a)}}r.length&&(u?(e.items.unshift({dataTab:e.dataGroup+"-me-main",label:"Main"}),e.tabs.unshift({dataTab:e.dataGroup+"-me-main",groups:r})):e.groups=r)}function c(e){if(foundry.utils.isEmpty(e))return!1;for(const[t,s]of Object.entries(e))if("Object"===foundry.utils.getType(s)){if(c(s))return!0}else if(null!=s)return!0;return!1}function d(e){return e.length<=3?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)}const u=["img","image","src","texture"],h=["tint"];function m(e){return e=e.split(".").pop(),h.includes(e)||e.toLowerCase().includes("color")}function g(e,t,s,a,i,n=!1,o={},r){const l=["number","string"];let c={label:t,value:s,name:a,editableLabel:n,pins:r};if(foundry.utils.getProperty(o,a))c=foundry.utils.mergeObject(c,foundry.utils.getProperty(o,a));else if("number"===e){c.number=!0;if(m(a.split(".").pop())){c.colorPickerNumber=!0;try{c.colorValue=new Color(s).toString()}catch(e){}}}else if("string"===e){c.text=!0;const e=a.split(".").pop();u.includes(e)||e.toLowerCase().includes("image")||e.toLowerCase().includes("path")?c.filePicker=!0:m(e)&&(c.colorPicker=!0)}else"boolean"===e?c.boolean=!0:"Array"===e&&s.every((e=>l.includes(foundry.utils.getType(e))))?(c.value=s.join(", "),c.array=!0):"Array"===e?(c.jsonArray=!0,c.value=JSON.stringify(s,null,2)):(c.disabled=!0,c.text=!0,c.editableLabel=!1);return c&&a in i&&(c.pinned=!0,c.disabled=!0,c.name=null),c}const p=(0,n.dN)();class MassEditGenericForm extends p{constructor(e,t={}){const s=e.map((e=>e.toObject?e.toObject():e));let n={};for(let e=s.length;e>=0;e--)foundry.utils.mergeObject(n,s[e]);t.noTabs&&(n=foundry.utils.flattenObject(n));let o=t.documentName??"NONE",l=foundry.utils.mergeObject(a[o]??{},game.settings.get(i.Do,"customControls")[o]??{});l=foundry.utils.mergeObject(l,t.customControls?.[o]??{});const[c,d]=r(n,o,l,!t.noTabs),u=(0,i.m1)(s);super(e[0],e,{tabs:d,commonData:u,...t}),this.allData=n,this.nav=c,this.editableLabels={},this.pinnedFields=game.settings.get(i.Do,"pinnedFields")[this.documentName]??{},this.customControls=l,t.callback&&(this.callbackOnUpdate=t.callback)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-generic-form",classes:["sheet"],template:`modules/${i.Do}/templates/generic/genericForm.html`,resizable:!0,minimizable:!1,title:"Generic",width:500,height:"auto"})}_getHeaderButtons(){const e=super._getHeaderButtons();return this.options.tokens&&e.unshift({label:"",class:"mass-edit-tokens",icon:"fas fa-user-circle",onclick:()=>{(0,o.gx)(this.options.tokens,"Token"),this.close()}}),e}async getData(e){const t=await super.getData(e);return await getTemplate(`modules/${i.Do}/templates/generic/navHeaderPartial.html`,"me-navHeaderPartial"),await getTemplate(`modules/${i.Do}/templates/generic/form-group.html`,"me-form-group"),t.nav=this.nav,t}activateListeners(e){super.activateListeners(e),e.find(".me-pinned").click((e=>{const t=$(e.target).parent(),s=t.closest(".form-group").find("[name]").attr("name");t.hasClass("active")?(t.removeClass("active"),delete this.pinnedFields[s]):(t.addClass("active"),this.pinnedFields[s]={label:s})})),e.find(".me-editable-label").on("input",(e=>{const t=$(e.target).closest(".form-group").find("[name]").attr("name");this.editableLabels[t]=e.target.value})),e.find(".color-number").on("change",(e=>{if(e.target.dataset?.editNumber){let t=0;try{t=Number(Color.fromString(e.target.value))}catch(e){}$(e.target).siblings(`[name="${e.target.dataset.editNumber}"]`).val(t).trigger("input")}})),e.find(".me-editable-label, label").on("contextmenu",(e=>{const t=$(e.target).closest(".form-group");if(!t.length)return;const s=t.find("[name]"),a=s.attr("name");if(a){if(m(a))return;const e=s.attr("type");if("range"===e)return void function(e,t){const s=game.settings.get(i.Do,"customControls");let a=s[t]||{};setProperty(a,e,null),game.settings.set(i.Do,"customControls",s)}(a,this.documentName);"number"===e?function(e,t,s,a,{min:n=null,max:o=null,step:r=null}={}){let l=`\n<div class="form-group slim">\n  <label>Range</label>\n  <div class="form-fields">\n    <label>${(0,i.kg)("Minimum",!1)}</label>\n    <input type="number" value="${n??t}" name="min" step="any">\n    <label>${(0,i.kg)("Maximum",!1)}</label>\n    <input type="number" value="${o??t}" name="max" step="any">\n    <label>${(0,i.kg)("generic-form.step-size")}</label>\n    <input type="number" value="${r??1}" name="step" step="any">\n  </div>\n</div>\n  `;new Dialog({title:(0,i.kg)("generic-form.define-range"),content:l,buttons:{save:{label:(0,i.kg)("Save",!1),callback:async n=>{const o=n.find('[name="min"]').val()||t,r=n.find('[name="max"]').val()||t,l=n.find('[name="step"]').val()||1;setProperty(s,e,{range:!0,min:o,max:r,step:l});const c=game.settings.get(i.Do,"customControls");c[a]=s,game.settings.set(i.Do,"customControls",c)}}}}).render(!0)}(a,s.val(),this.customControls,this.documentName):"text"===e&&function(e,t,s,a,{options:n=null}={}){let o=`\n<div class="form-group slim">\n  <label>${(0,i.kg)("common.options")}</label>\n  <textarea name="options">${n?n.join("\n"):t}</textarea>\n</div>\n  `;new Dialog({title:(0,i.kg)("generic-form.define-dropdown"),content:o,buttons:{save:{label:(0,i.kg)("Save",!1),callback:async t=>{const n=t.find('[name="options"]').val().trim();if(n){setProperty(s,e,{select:!0,options:n.split("\n").filter((e=>e))});const t=game.settings.get(i.Do,"customControls");t[a]=s,game.settings.set(i.Do,"customControls",t)}}}}}).render(!0)}(a,s.val(),this.customControls,this.documentName)}})),this.options.inputChangeCallback&&e.on("change","input, select",(async e=>{setTimeout((()=>this.options.inputChangeCallback(this.getSelectedFields())),100)}))}async _updateObject(e,t){super._updateObject(e,t);const s=game.settings.get(i.Do,"pinnedFields");s[this.documentName]=this.pinnedFields;for(const e of Object.keys(this.pinnedFields))this.pinnedFields[e].value=t[e];if(!foundry.utils.isEmpty(this.editableLabels)){for(const[e,s]of Object.entries(this.editableLabels))e in this.pinnedFields&&(this.pinnedFields[e].label=s,this.pinnedFields[e].value=t[e]);this.editableLabels={}}game.settings.set(i.Do,"pinnedFields",s)}async close(e={}){return this.callbackOnUpdate&&this.callbackOnUpdate(null),super.close(e)}}},739:(e,t,s)=>{s.d(t,{CM:()=>b,G_:()=>p,Ls:()=>v,Pw:()=>y,QH:()=>d,ef:()=>g,gx:()=>f,i2:()=>c});var a=s(860),i=s(652),n=s(120),o=s(439),r=s(622),l=s(338);const c={Token:"tokens",Tile:"tiles",Drawing:"drawings",Wall:"walls",AmbientLight:"lighting",AmbientSound:"sounds",MeasuredTemplate:"templates",Note:"notes"},d={Token:"tokens",Tile:"tiles",Drawing:"drawings",Wall:"walls",AmbientLight:"lights",AmbientSound:"sounds",MeasuredTemplate:"templates",Note:"notes"};function u(){return canvas.activeLayer.controlled.length?canvas.activeLayer.controlled:null}function h(){let e=canvas.activeLayer.constructor.documentName;return!["Wall"].includes(e)&&canvas.activeLayer.hover?[canvas.activeLayer.hover]:null}function m(e){const t=[{name:"Actor",class:"actor"},{name:"Scene",class:"scene"},{name:"JournalEntry",class:"journalentry"},{name:"Playlist",class:"sound"},{name:"Item",class:"item"},{name:"RollTable",class:"rolltable"},{name:"Cards",class:"cards"}];for(const s of t){const t=[];if($(`.directory-list .${s.class}.selected`).each((function(a){let i;i="Playlist"===s.name?game.collections.get(s.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId):game.collections.get(s.name).get(this.dataset.documentId),i&&(e&&"JournalEntry"===s.name?game.collections.get("Scene").forEach((e=>e.notes.forEach((e=>{const s=e.entryId??e.data.entryId;i.id===s&&t.push(e)})))):i&&t.push(i))})),t.length)return t}return null}function g(e,t=!0){let s;e&&(s=Array.isArray(e)?e:[e]),s||(s=m(t)),s||(s=u()),s&&s.length>1&&null!=s[0].x&&null!=s[0].y&&s.sort(((e,t)=>{const s=e.y-t.y;return 0===s?e.x-t.x:s}));let a=h();return a=a?a[0]:a,!s&&a&&(s=[a]),!a&&s&&(a=s[0]),a||s?(a&&(0,n.Ng)(a)!==(0,n.Ng)(s[0])&&(a=s[0]),[a,s]):[null,null]}function p(e){let[t,s]=g(e);if(!t)return void(0,a.R)();const i=(0,n.Ng)(t),o={commonData:foundry.utils.flattenObject((0,n.bQ)(t).toObject()),massSelect:!0,documentName:i};if(n.qE.includes(i)&&"Actor"!==i){new((0,r.dN)(i))(t,s,o).render(!0,{})}else n.lv.includes(i)&&new l.s(s,o).render(!0)}async function f(e=null,t,s={}){let[a,i]=g(e);if(i&&i.length){if(s.forceForm||!game.settings.get(n.Do,"singleDocDefaultConfig")||1!==i.length){if(t||(t=(0,n.Ng)(a)),s={...s,massEdit:!0,documentName:t},n.qE.includes(t)){"Actor"===t&&(a=a.prototypeToken,i=i.map((e=>e.prototypeToken)),s.documentName="Token");return new((0,r.dN)(s.documentName))(a,i,s).render(!0,{})}return new l.s(i,s).render(!0)}i[0].sheet&&i[0].sheet.render(!0,{})}}function y(e,t){const s=[],a=[];return e.forEach((e=>{e.actor&&(s.push(e),a.push(e.actor))})),!!a.length&&(new l.s(a,{tokens:s,documentName:"Actor",...t}).render(!0),!0)}function b(){let e;if(e||(e=m()),e||(e=u()),e||(e=h()),e)return(0,o.B0)(e,null,!1,!0);{let e=canvas.activeLayer.constructor.documentName;const t=(0,o.bE)(e);if(t)return i.af.spawnPreset({preset:t}),!0}return!1}function v(e,t="GenericData",s){return new Promise((a=>{new l.s(Array.isArray(e)?e:[e],{documentName:t,callback:()=>a(),...s}).render(!0)}))}},241:(e,t,s)=>{s.d(t,{Oy:()=>u,Xt:()=>d,Yv:()=>c,_8:()=>BrushMenu,vM:()=>Brush});var a=s(439),i=s(971),n=s(652),o=s(671),r=s(465),l=s(120);class Brush{static app;static deactivateCallback;static spawner;static eraser;static lastSpawnTime;static preset;static brushOverlay;static updatedPlaceables=new Map;static hoveredPlaceables=new Set;static spawnPoints=[];static hoveredPlaceable;static documentName;static active=!1;static hitTest;static registered3dListener=!1;static{this._boundOn3DBrushClick=this._on3DBrushClick.bind(this),this._boundOn3dMouseMove=this._on3dMouseMove.bind(this)}static _checkDensity(e){const t=canvas.grid.size*this.spawnDensity;return this.spawnPoints.every((s=>Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2)>=t))}static _performBrushDocumentUpdate(e){this.preset.callPostSpawnHooks({objects:[e],documents:[e.document]}),this.preset.isEmpty||(0,a.B0)([e],this.preset,!0,!0,this.transform),this.updatedPlaceables.set(e.id,e),BrushMenu.iterate()}static _performBrushDocumentCreate(e){const t=(new Date).getTime();if(!this.lastSpawnTime||t-this.lastSpawnTime>100){if(this.lastSpawnTime=t,null==e.z){if(!this._checkDensity(e))return;i.Picker.resolve(e),this.spawnPoints.push(e)}else n.af.spawnPreset({preset:this.preset,...e,center:!0,snapToGrid:this.snap,scaleToGrid:this.scaleToGrid});BrushMenu.iterate()}}static _performBrushDocumentDelete(e){this.hoveredPlaceable=null,e._brushDelete||e.document?.delete(),e._brushDelete=!0}static _hitTestWall(e,t){return t.line.hitArea.contains(e.x,e.y)}static _hitTestControlIcon(e,t){return Number.between(e.x,t.x-t.controlIcon.width/2,t.x+t.controlIcon.width/2)&&Number.between(e.y,t.y-t.controlIcon.height/2,t.y+t.controlIcon.height/2)}static _hitTestTile(e,t){const s=ui.controls.control.foreground??!1;return t.document.overhead===s&&this._hitTestArea(e,t)}static _hoverTestArea(e){return this.hoveredPlaceable&&this.hoveredPlaceable.hitArea.width*this.hoveredPlaceable.hitArea.height>e.hitArea.width*e.hitArea.height}static _hitTestArea(e,t){return Number.between(e.x,t.x,t.x+t.hitArea.width)&&Number.between(e.y,t.y,t.y+t.hitArea.height)}static _onBrushMove(e){const t=e.data.getLocalPosition(this.brushOverlay),s=canvas.getLayerByEmbeddedName(this.documentName);this._clearHover(e,t);for(const a of s.placeables)a.visible&&this.hitTest(t,a)&&!this.updatedPlaceables.has(a.id)&&this.hoveredPlaceable!==a&&(this.hoverTest?.(a)||!this.hoverTest&&this.hoveredPlaceable&&this.hoveredPlaceable!==a?(this.hoveredPlaceable._onHoverOut(e),this.hoveredPlaceable=a):this.hoveredPlaceable||(this.hoveredPlaceable=a),this.hoveredPlaceable._onHoverIn(e))}static _clearHover(e,t,s=!1){this.hoveredPlaceable&&(!s&&this.hoveredPlaceable.visible&&this.hitTest(t,this.hoveredPlaceable)||(this.hoveredPlaceable._onHoverOut(e),this.hoveredPlaceable=null))}static _onBrushClickMove(e){this.spawner?this._performBrushDocumentCreate(e.data.getLocalPosition(this.brushOverlay)):this.hoveredPlaceable&&this.hoveredPlaceable.visible&&!this.updatedPlaceables.has(this.hoveredPlaceable.id)&&(this.eraser?this._performBrushDocumentDelete(this.hoveredPlaceable):this._performBrushDocumentUpdate(this.hoveredPlaceable))}static _on3DBrushClick(e){if(this.brush3d)if(this.spawner){if(this.brush3d?.position){const e=game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.brush3d.position);this._performBrushDocumentCreate({x:e.x,y:e.y,z:e.z})}}else{const e=game.Levels3DPreview.interactionManager.currentHover?.placeable;e&&e.document.documentName===this.documentName&&(game.Levels3DPreview.interactionManager._downCameraPosition.set(0,0,0),this.eraser?this._performBrushDocumentDelete(e):this._performBrushDocumentUpdate(e)),this.updatedPlaceables.clear()}}static refreshPreset(){this.active&&this.app&&(this.preset=new o.k({documentName:this.documentName,data:this.app.getSelectedFields(),randomize:this.app.randomizeFields,addSubtract:this.app.addSubtractFields}))}static async genPreview(){game.Levels3DPreview?._active||n.af.spawnPreset({preset:this.preset,coordPicker:!0,previewOnly:!0,center:!0,taPreview:"ALL",transform:this.transform,snapToGrid:this.snap,scaleToGrid:this.scaleToGrid})}static activate({app:e=null,preset:t=null,deactivateCallback:s=null,spawner:a=!1,spawnDensity:n=.01,eraser:o=!1,refresh:r=!1,transform:c={},snap:d=!0,scaleToGrid:u=!0}={}){if(this.deactivate(r),!canvas.ready)return!1;if(!e&&!t)return!1;this.brushOverlay&&this.brushOverlay.destroy(!0),this.app=e,this.preset=t,this.transform=c,this.deactivateCallback=s,this.spawner=a,this.eraser=o,this.snap=d,this.spawnDensity=n,this.scaleToGrid=u,this.app?this.documentName=this.app.documentName:this.documentName=this.preset.documentName,r||(this.updatedPlaceables.clear(),this.spawnPoints=[]);const h=canvas.app.renderer.events;if(h.cursorStyles.brush||(h.cursorStyles.brush=`url('modules/${l.Do}/images/brush_icon.png'), auto`,h.cursorStyles.brush_spawn=`url('modules/${l.Do}/images/brush_icon_spawn.png'), auto`,h.cursorStyles.eraser=`url('modules/${l.Do}/images/brush_icon_eraser.png'), auto`),this.active=!0,this.refreshPreset(),game.Levels3DPreview?._active)return this._activate3d();if(this.spawner)this.hitTest=()=>!1,this.genPreview();else switch(this.documentName){case"Wall":this.hitTest=this._hitTestWall;break;case"AmbientLight":case"MeasuredTemplate":case"AmbientSound":case"Note":this.hitTest=this._hitTestControlIcon;break;case"Tile":this.hitTest=this._hitTestTile,this.hoverTest=this._hoverTestArea;break;default:this.hitTest=this._hitTestArea,this.hoverTest=this._hoverTestArea}this.brushOverlay=new PIXI.Container,this.brushOverlay.hitArea=canvas.dimensions.rect;let m="brush";return a?m="brush_spawn":o&&(m="eraser"),this.brushOverlay.cursor=m,this.brushOverlay.interactive=!0,this.brushOverlay.zIndex=1/0,this.brushOverlay.on("mousemove",(e=>{i.Picker.feedPos(e.data.getLocalPosition(this.brushOverlay)),this._onBrushMove(e),this.mDownWithinCanvas&&1===e.buttons&&this._onBrushClickMove(e)})),this.brushOverlay.on("mouseup",(e=>{this.mDownWithinCanvas=!1,2!==e.nativeEvent.which&&this._onBrushClickMove(e),this.updatedPlaceables.clear(),this.spawnPoints=[]})),this.brushOverlay.on("mousedown",(e=>{this.mDownWithinCanvas=!0})),this.brushOverlay.on("click",(e=>{2==e.nativeEvent.which&&this.deactivate()})),canvas.stage.addChild(this.brushOverlay),canvas.mouseInteractionManager.permissions.clickLeft=!1,!0}static brush3dDelayMoveTimer;static _on3dMouseMove(){if(!this.brush3d||this.brush3dDelayMoveTimer)return;const e=this;this.brush3dDelayMoveTimer=setTimeout((function(){const t=game.Levels3DPreview.interactionManager.canvas3dMousePosition,s=game.Levels3DPreview.interactionManager.camera.position,a=game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(s,t,"collision",!1,!1,!1,!0);if(a[0]){const t=a[0];e.brush3d.position.set(t.point.x,t.point.y,t.point.z)}e.brush3dDelayMoveTimer=null}),100)}static deactivate3DListeners(){game.Levels3DPreview.renderer.domElement.removeEventListener("click",this._boundOn3DBrushClick,!1),game.Levels3DPreview.renderer.domElement.removeEventListener("mousemove",this._boundOn3dMouseMove,!1)}static _activate3DListeners(){this.deactivate3DListeners(),game.Levels3DPreview.renderer.domElement.addEventListener("click",this._boundOn3DBrushClick,!1),game.Levels3DPreview.renderer.domElement.addEventListener("mousemove",this._boundOn3dMouseMove,!1)}static _activate3d(){const e=game.Levels3DPreview.THREE;if(!this.brush3d){this.brush3d=new e.Mesh(new e.SphereGeometry(.01,8,8),new e.MeshBasicMaterial({opacity:.5,transparent:!0,color:65280,wireframe:!0})),this.brush3d.userData.interactive=!1,this.brush3d.userData.ignoreHover=!0;const t=game.Levels3DPreview.interactionManager.canvas3dMousePosition;this.brush3d.position.set(t.x,t.y,t.z),game.Levels3DPreview.scene.add(this.brush3d),this.spawner&&this.genPreview()}return this._activate3DListeners(),!0}static deactivate(e=!1){if(this.active)return canvas.mouseInteractionManager.permissions.clickLeft=!0,this.brushOverlay&&this.brushOverlay.parent?.removeChild(this.brushOverlay),this.brush3d&&game.Levels3DPreview?._active&&(game.Levels3DPreview.scene.remove(this.brush3d),this.brush3d=null,this.deactivate3DListeners()),this.active=!1,e||(this.updatedPlaceables.clear(),this.spawnPoints=[],this._clearHover(null,null,!0)),this.hoverTest=null,e||this.deactivateCallback?.(),this.spawner&&i.Picker.destroy(),this.spawner=!1,this.eraser=!1,this.deactivateCallback=null,this.app=null,this.preset=null,this.transform=null,!0}}class BrushMenu extends FormApplication{static addPresets(e=[]){if(!this._instance)return this.render(e);this._instance.addPresets(e)}static isActive(){return Boolean(this._instance)}static removePreset(e){this._instance&&this._instance.removePreset(e)}static iterate(e=!0){this._instance&&this._instance.iterate(e)}static render(e,t={}){this._instance?this.addPresets(e):(this._instance=new BrushMenu(e,t),this._instance.render(!0))}static async close(){return this._instance?.close(!0)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-brush-menu",template:`modules/${l.Do}/templates/preset/brush/menu.html`,classes:["mass-edit-dark-window","mass-edit-window-fill"],resizable:!1,minimizable:!1,width:200,height:"auto",scrollY:[".presets"]})}constructor(e,t={}){super({},{left:10,top:window.innerHeight/2}),this.presets=e??[],this.preset=this.presets[0].clone(),this.preset.data=this.preset.data[0],this._settings=foundry.utils.mergeObject(game.settings.get(l.Do,"brush"),t),this._it=-1,this._createIndex(),this.iterate()}_createIndex(){const e=[];if(this._settings.group)for(let t=0;t<this.presets.length;t++)e.push({pI:t});else for(let t=0;t<this.presets.length;t++){const s=this.presets[t];for(let a=0;a<s.data.length;a++)e.push({pI:t,dI:a})}this._index=e,this._it>=this._index.length&&(this._it=this._index.length-1)}async _activateBrush(e=!0){const t=this._index[this._it],s=this.presets[t.pI];if(this.preset=s.clone(),t.hasOwnProperty("dI")&&(this.preset.data=[this.preset.data[t.dI]]),"Tile"===this.preset.documentName&&canvas.tiles.placeables.length){const e=Math.max(...canvas.tiles.placeables.map((e=>e.document.z)));this.preset.data.forEach((t=>{t.z=e}))}await this._applyColor(),this._applyTmfxPresets(this.preset,this._settings.tmfxPreset),this._applyTaggerTags(this.preset,this._settings.tagger),Brush.activate({preset:this.preset,deactivateCallback:this._deactivateCallback.bind(this),spawner:this._settings.spawner,eraser:this._settings.eraser,transform:this._getTransform(),refresh:e,snap:this._settings.snap,scaleToGrid:this._settings.scaleToGrid,spawnDensity:this._settings.density})}async _applyColor(){if(this._settings.randomColor||this._settings.color){let e;const t=this.preset.documentName;if("Token"===t||"Tile"===t?e="texture.tint":"AmbientLight"===t&&(e="config.color"),e)if(this._settings.randomColor){const t=this.preset.data.map((()=>({color:""})));await(0,r.of)(t,null,{color:{type:"color",...this._settings.randomColor}}),this.preset.data.forEach(((s,a)=>{this._settings.ddTint?this._applyDDTint(s,t[a].color):foundry.utils.setProperty(s,e,t[a].color)}))}else this.preset.data.forEach((t=>{this._settings.ddTint?this._applyDDTint(t,this._settings.color):foundry.utils.setProperty(t,e,this._settings.color)}))}}_applyDDTint(e,t){let s=foundry.utils.getProperty(e,"flags.tokenmagic.filters");t?(s=(s??[]).filter((e=>"DDTint"!==e.tmFilters.filterId)),s.push({tmFilters:{tmFilterId:"DDTint",tmFilterInternalId:randomID(),tmFilterType:"ddTint",filterOwner:game.data.userId,tmParams:{tmFilterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t),updateId:randomID(),rank:1e4,enabled:!0,filterOwner:game.data.userId}}}),foundry.utils.setProperty(e,"flags.tokenmagic.filters",s)):s&&foundry.utils.setProperty(e,"flags.tokenmagic.filters",s.filter((e=>"DDTint"!==e.tmFilters.filterId)))}_applyTaggerTags(e,t){t&&t.length&&game.modules.get("tagger")?.active&&e.addPostSpawnHook((({objects:e}={})=>{Tagger.addTags(e,t)}))}_applyTmfxPresets(e,t){if(!t)return;if(!game.modules.get("tokenmagic")?.active)return;if(!["Token","Tile","Drawing","MeasuredTemplate"].includes(e.documentName))return;if(Array.isArray(t)||(t=[t]),t.includes("DELETE ALL"))return void this.preset.addPostSpawnHook((({objects:e}={})=>e.forEach((e=>TokenMagic.deleteFilters(e)))));if(t.includes("DELETE"))return void this.preset.addPostSpawnHook((({objects:e}={})=>e.forEach((async e=>{for(const s of t)await TokenMagic.deleteFilters(e,s)}))));const s=[];t.forEach((e=>TokenMagic.getPreset(e)?.forEach((e=>s.push(e))))),s.length&&this.preset.addPostSpawnHook((({objects:e}={})=>e.forEach((e=>TokenMagic.addUpdateFilters(e,s)))))}get title(){return"Brush"}async getData(e={}){return{presets:this.presets,activePreset:this.preset,...this._settings,tmfxActive:game.modules.get("tokenmagic")?.active,taggerActive:game.modules.get("tagger")?.active}}activateListeners(e){super.activateListeners(e);const t=this._settings,a=this;s.e(470).then(s.t.bind(s,470,23)).then((s=>{const i=e.find(".rotation-range-label");e.find(".rotation-slider").slider({range:!0,min:-180,max:180,values:t.rotation,slide:function(e,t){i.text(`${t.values[0]}° - ${t.values[1]}°`)},change:function(e,t){a._updateBrushSettings({rotation:t.values})}});const n=e.find(".scale-range-label");e.find(".scale-slider").slider({range:!0,min:.1,max:4,step:.01,values:t.scale,slide:function(e,t){n.text(`${t.values[0]} - ${t.values[1]}`)},change:function(e,t){a._updateBrushSettings({scale:t.values})}});const o=e.find(".density-range-label");e.find(".density-slider").slider({range:!1,min:.01,max:4,step:.01,value:t.density??.01,slide:function(e,t){o.text(`${t.value}`)},change:function(e,t){a._updateBrushSettings({density:t.value})}}),this.setPosition({height:"auto"})})),e.on("click",".toggle-button",this._toggleSetting.bind(this)),e.find(".reset").on("click",this._resetToDefaults.bind(this)),e.on("click",".preset",this._onClickPreset.bind(this)),e.on("contextmenu",".preset",this._onRightClickPreset.bind(this)),e.on("click",".randomize-color",this._onRandomizeColor.bind(this)),e.on("change",'input[type="color"]',this._onColorChange.bind(this)),e.on("input paste",".color",this._onColorChange.bind(this)),e.find(".colorizeControl").on("click",this._onColorMenu.bind(this)),e.find(".tmfxPresetControl").on("click",(()=>{this._onEditTaglikeField({label:"TMFX",name:"tmfxPreset",tags:this._settings.tmfxPreset,simplifyTags:!1,listId:"tmfxPresets",listEntries:TokenMagic.getPresets().map((e=>e.name))})})),e.find(".taggerControl").on("click",(()=>{this._onEditTaglikeField({label:"Tagger",name:"tagger",tags:this._settings.tagger,simplifyTags:!1})}))}async _onEditTaglikeField({label:e,name:t,tags:s,simplifyTags:a=!0,listId:i,listEntries:n}={}){const o=this._toggleSubMenu(t);if(!o)return;s&&!Array.isArray(s)&&(s=[s]);let r=Handlebars.compile("{{tagInput name=name label=label tags=tags listId=listId listEntries=listEntries}}")({name:t,label:e,tags:s,listId:i,listEntries:n},{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0});o.html(r),this.setPosition({height:"auto"}),l.Fo.activateListeners(o,{change:e=>{this.setPosition({height:"auto"}),this._updateBrushSettings({[t]:e.length?e:null})},simplifyTags:a})}_toggleSubMenu(e){const t=this.element.find(".sub-menu");return t.attr("data-control")===e?(t.html("").attr("data-control",null),this.setPosition({height:"auto"}),null):(t.attr("data-control",e),t)}async _onColorMenu(e){const t=this._toggleSubMenu("colorize");if(!t)return;let s=(await getTemplate(`modules/${l.Do}/templates/preset/brush/colorize.html`))(await this.getData({}),{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0});t.html(s),this.setPosition({height:"auto"})}async _onColorChange(e){let t=$(e.currentTarget).val();if(t){let e=Color.fromString(t);Number.isNaN(e.valueOf())||this._updateBrushSettings({color:t})}else this._updateBrushSettings({color:""})}async _onClickPreset(e){const t=$(e.currentTarget).data("index");null!=t&&(this._it=this._index.findIndex((e=>e.pI===t)),await this._activateBrush(),this.render(!0))}async _onRandomizeColor(){const e=this._settings.randomColor??{},t=await renderTemplate(`modules/${l.Do}/templates/randomizer/color.html`,{method:"random",lockMethod:!0,space:e.space,hue:e.hue});let a,i=new Dialog({title:"Pick Range",content:`<form>${t}</form>`,buttons:{save:{label:"Apply",callback:async e=>{await this._updateBrushSettings({randomColor:{method:"random",space:e.find('[name="space"]').val(),hue:e.find('[name="hue"]').val(),colors:a.getColors()}}),this.render(!0)}},remove:{label:"Remove",callback:async e=>{await this._updateBrushSettings({randomColor:null}),this.render(!0)}}},render:t=>{Promise.all([s.e(646),s.e(470),s.e(236)]).then(s.bind(s,236)).then((s=>{a=new s.ColorSlider(t,e.colors??[{hex:"#ff0000",offset:0},{hex:"#ff0000",offset:100}]),setTimeout((()=>i.setPosition({height:"auto"})),100)}))}});i.render(!0)}async _onRightClickPreset(e){const t=$(e.currentTarget).data("index"),s=this.presets[t];s&&this.removePreset(s.id)}async _resetToDefaults(){await this._updateBrushSettings({scale:[1,1],rotation:[0,0],density:1,color:null,randomColor:null,tmfxPreset:null,tagger:null}),this.render(!0)}async _toggleSetting(e){const t=$(e.target).closest(".toggle-button"),s={[t.data("name")]:!t.hasClass("active")};s.spawner&&(s.eraser=!1),s.eraser&&(s.spawner=!1),await this._updateBrushSettings(s),s.random?await this.iterate():this.render(!0)}async _updateBrushSettings(e){foundry.utils.mergeObject(this._settings,e),await game.settings.set(l.Do,"brush",this._settings),e.hasOwnProperty("group")&&this._createIndex(),await this._activateBrush()}addPresets(e=[]){for(const t of e)this.presets.find((e=>e.uuid===t.uuid))||this.presets.push(t);this._createIndex(),this.render(!0)}removePreset(e){const t=this.presets.findIndex((t=>t.id===e));if(-1===t)return;const s=this._index[this._it]?.pI===t;if(this.presets=this.presets.filter((t=>t.id!==e)),0===this.presets.length)return this.close(!0);this._createIndex(),s?this.iterate():this.render(!0)}async iterate(e=!0){this._settings.lock?-1===this._it&&(this._it=0):this._settings.random?this._it=Math.floor(Math.random()*this._index.length):(this._it+=e?1:-1,this._it<0?this._it=this._index.length-1:this._it%=this._index.length),await this._activateBrush(),this.render(!0)}_getTransform(){const e=this._settings,t={};if(e.scale[0]===e.scale[1])t.scale=e.scale[0];else{const s=(e.scale[1]-e.scale[0])/.01;t.scale=.01*Math.floor(Math.random()*s)+e.scale[0]}if(e.rotation[0]===e.rotation[1])t.rotation=e.rotation[0];else{const s=(e.rotation[1]-e.rotation[0]+1)/1;t.rotation=1*Math.floor(Math.random()*s)+e.rotation[0]}return t}_deactivateCallback(){this.close(!0)}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-brush-macro",icon:"fa-solid fa-code",onclick:this._generateBrushMacro.bind(this)}),e}async _generateBrushMacro(){const e=async function(e){(await Macro.create({name:"Brush Macro",type:"script",scope:"global",command:e,img:`modules/${l.Do}/images/brush_icon.png`})).sheet.render(!0)};new Dialog({title:"Generate Macro",content:"",buttons:{uuids:{label:"UUIDs",callback:function(){const t=this.presets.map((e=>e.uuid)).filter(Boolean);if(!t.length)return;const s=`MassEdit.openBrushMenu({ \n    uuid: ${JSON.stringify(t,null,4)}\n  },\n  ${JSON.stringify(this._settings,null,2)}\n  );`;e(s)}.bind(this)},name:{label:"Names",callback:function(){const t=this.presets.map((e=>({name:e.name,type:e.documentName}))),s=`MassEdit.openBrushMenu(\n    ${JSON.stringify(t,null,4)}\n  ,\n  ${JSON.stringify(this._settings,null,2)}\n  );`;e(s)}.bind(this)}}}).render(!0)}async close(e={}){return Brush.deactivate(),BrushMenu._instance=null,i.Picker.destroy(),super.close(e)}}async function c(e,t="spawner"){const s=await n.af.getPreset(e);s&&Brush.activate({preset:s,spawner:"spawner"===t})}function d(){Brush.deactivate()}async function u(e,t={}){if(BrushMenu.isActive())return BrushMenu.close();let s=[];if(Array.isArray(e))for(const t of e){let e=await n.af.getPreset(t);e&&s.push(e)}else s=await n.af.getPresets(e);if(s?.length){for(const e of s)await e.load();BrushMenu.render(s,t)}}},860:(e,t,s)=>{s.d(t,{R:()=>n,h:()=>o});var a=s(739),i=s(120);function n(){let e="";for(const t of i.Me.concat(i.lv))e+=`<option value="${t}">${t}</option>`;e=`<label>${(0,i.kg)("dialog.search-document")}</label>\n    <select style="width: 100%;" name="documentName">${e}</select>`,new Dialog({title:"Document SEARCH",content:e,buttons:{select:{icon:'<i class="fas fa-check"></i>',label:"Select",callback:e=>{const t=e.find("select[name='documentName']").val();let s=[];if(i.Me.includes(t)){const e=a.i2[t];e&&canvas[e].placeables.length&&(s=canvas[e].placeables)}else s=Array.from(game.collections.get(t));s.length?(0,a.G_)(s[0]):ui.notifications.warn((0,i.zS)("dialog.document-not-found",{document:t}))}}}}).render(!0)}async function o(){const e=`\n  <div class="form-group">\n      <label for="data">${(0,i.kg)("FILES.SelectFile",!1)} </label>\n      <input type="file" name="data">\n  </div>\n  `;let t=new Promise(((t,s)=>{new Dialog({title:(0,i.kg)("presets.import"),content:e,buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:(0,i.kg)("common.import"),callback:async e=>{let s;readTextFromFile(e.find('[name="data"]')[0].files[0]).then((e=>{try{s=JSON.parse(e)}catch(e){}t(s)}))}},no:{icon:'<i class="fas fa-times"></i>',label:(0,i.kg)("Cancel",!1),callback:()=>t(!1)}},default:"no"},{width:400}).render(!0)}));return await t}},971:(e,t,s)=>{s.r(t),s.d(t,{DataTransform:()=>DataTransform,Picker:()=>Picker,editPreviewPlaceables:()=>n});var a=s(575),i=s(120);class Picker{static pickerOverlay;static boundStart;static boundEnd;static callback;static isActive(){return Boolean(this.pickerOverlay)}static addRotation(e){this._rotation+=e,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static addScaling(e){this._scale+=e,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static async activate(e,t){this.destroy();const s=new PIXI.Container;if(this.callback=e,t){let e;t.label&&(e=new PreciseText(t.label,{...CONFIG.canvasTextStyle,_fontSize:24}),e.anchor.set(.5,1),s.addChild(e));let{previews:i,layer:n,previewDocuments:o}=await this._genPreviews(t);this._rotation=t.rotation??0,this._scale=t.scale??1;const r=()=>t.center&&!("TokenLayer"===n.name&&1===t.previewData.size);let l;l=r()?(0,a.Ym)(t.previewData):{x:0,y:0};const c=function(d){if(!d)return;r()&&(l=(0,a.Ym)(t.previewData)),t.snap&&n&&!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)&&(d=n.getSnappedPoint?n.getSnappedPoint(d):canvas.grid.getSnappedPosition(d.x,d.y,n.gridPrecision));const u="Wall"===i[0].document.documentName?i[0].document.c[0]:i[0].document.x,h="Wall"===i[0].document.documentName?i[0].document.c[1]:i[0].document.y;let m={x:d.x-u-l.x,y:d.y-h-l.y};0!=Picker._rotation&&(m.rotation=Picker._rotation,Picker._rotation=0),1!=Picker._scale&&(m.scale=Picker._scale,Picker._scale=1);for(const e of i){const t=e.document;DataTransform.apply(t.documentName,e._pData??t,d,m,e),e.document.alpha=.4,e.renderFlags.set({refresh:!0}),e.visible=!0,!e._meVInsert&&e instanceof Region?(Object.defineProperty(e,"visible",{get:function(){return!0},set:function(){}}),e._meVInsert=!0):e instanceof Region&&e._onUpdate({shapes:null}),foundry.utils.isNewerVersion(game.version,12)?null!=e.document.sort&&(e.sort||(e.sort=e.document.sort),e.sort&&(e.document.sort=e.sort+9999999)):(e.z||(e.z=e.document.z),e.z&&(e.document.z=e.z+9999999)),e.initializeLightSource?e.initializeLightSource():e.initializeSoundSource?e.initializeSoundSource():e.source&&e.updateSource(),e.controlIcon&&!e.controlIcon._meVInsert&&(e.controlIcon.alpha=.4,Object.defineProperty(e.controlIcon,"visible",{get:function(){return!0},set:function(){}}),e.controlIcon._meVInsert=!0)}e&&(e.x=d.x,e.y=d.y-38),s.previewDocuments=o,t.center&&null!=m.scale&&c(d)};s.on("pointermove",(e=>{c(e.data.getLocalPosition(s))})),c(canvas.mousePosition),c(canvas.mousePosition),s.setPositions=c}t?.previewOnly||(s.hitArea=canvas.dimensions.rect,s.cursor="crosshair",s.interactive=!0,s.zIndex=5,s.on("remove",(()=>s.off("pick"))),s.on("mousedown",(e=>{Picker.boundStart=e.data.getLocalPosition(s)})),s.on("mouseup",(e=>{Picker.boundEnd=e.data.getLocalPosition(s)})),s.on("click",(e=>{if(2==e.nativeEvent.which)this.callback?.(null);else{const e=Math.min(this.boundStart.x,this.boundEnd.x),t=Math.max(this.boundStart.x,this.boundEnd.x),s=Math.min(this.boundStart.y,this.boundEnd.y),a=Math.max(this.boundStart.y,this.boundEnd.y);this.callback?.({start:{x:e,y:s},end:{x:t,y:a}})}this.destroy()})),canvas.stage.addChild(s)),this.pickerOverlay=s}static feedPos(e){this.pickerOverlay?.setPositions?.(e)}static resolve(e){this.callback&&(null==e?this.callback(null):this.callback?.({start:{x:e.x,y:e.y,z:e.z},end:{x:e.x,y:e.y,z:e.z}})),this.destroy()}static destroy(){this.pickerOverlay&&(this.pickerOverlay.parent?.removeChild(this.pickerOverlay),this.pickerOverlay.previewDocuments&&this.pickerOverlay.previewDocuments.forEach((e=>{const t=canvas.getLayerByEmbeddedName(e);t&&t.clearPreviewContainer()})),this.pickerOverlay.destroy(!0),this.pickerOverlay.children?.forEach((e=>e.destroy(!0))),this.callback?.(null),this.pickerOverlay=null),this.callback=null}static async _createPreview(e){const t=this.constructor.documentName,s=getDocumentClass(t);e._id=foundry.utils.randomID();const a=new s(e,{parent:canvas.scene}),i=new CONFIG[t].objectClass(a);return this.preview.addChild(i),await i.draw(),i}static async _genPreviews(e){if(!e.previewData)return{previews:[]};const t={},s=[];for(const[a,i]of e.previewData.entries())for(const n of i)null==t.x&&("Wall"===a?(t.x=-n.c?.[0]??0,t.y=-n.c?.[1]??0):(t.x=-n.x??0,t.y=-n.y??0)),s.push({documentName:a,data:n}),e.taPreview&&"Token"===a&&this._genTAPreviews(n,e.taPreview,n,s);const a=new Set,i=[];for(const{documentName:e,data:n}of s){DataTransform.apply(e,n,{x:0,y:0},t);const s=await this._createPreview.call(canvas.getLayerByEmbeddedName(e),foundry.utils.deepClone(n));s._pData=n,i.push(s),a.add(e)}return{previews:i,layer:canvas.getLayerByEmbeddedName(e.documentName),previewDocuments:a}}static _genTAPreviews(e,t,s,a){if(!game.modules.get("token-attacher")?.active)return;const i=foundry.utils.getProperty(e,"flags.token-attacher.prototypeAttached"),n=foundry.utils.getProperty(e,"flags.token-attacher.pos"),o=foundry.utils.getProperty(e,"flags.token-attacher.grid");if(!(i&&n&&o))return;const r=canvas.grid.size/o.size,l=this._parseTAPreview(t,i);for(const[e,t]of Object.entries(l))for(let i of t)["Token","Tile","Drawing"].includes(e)&&(i.width*=r,i.height*=r),"Wall"===e?(i.c[0]=s.x+(i.c[0]-n.xy.x)*r,i.c[1]=s.y+(i.c[1]-n.xy.y)*r,i.c[2]=s.x+(i.c[2]-n.xy.x)*r,i.c[3]=s.y+(i.c[3]-n.xy.y)*r):"Region"===e?i.shapes?.forEach((e=>{if("polygon"===e.type)for(let t=0;t<e.points.length;t+=2)e.points[t]=s.x+(e.points[t]-n.xy.x)*r,e.points[t+1]=s.y+(e.points[t+1]-n.xy.y)*r;else e.x=s.x+(e.x-n.xy.x)*r,e.y=s.y+(e.y-n.xy.y)*r,"ellipse"===e.type?(e.radiusX*=r,e.radiusY*=r):"rectangle"===e.type&&(e.width*=r,e.height*=r)})):(i.x=s.x+(i.x-n.xy.x)*r,i.y=s.y+(i.y-n.xy.y)*r),a.push({documentName:e,data:i})}static _parseTAPreview(e,t){if("ALL"===e)return t;const s={};e=e.split(",");for(const a of e){let[e,i]=a.trim().split(".");t[e]&&(null==i?s[e]=t[e]:t[e][i]&&(s[e]||(s[e]=[]),s[e].push(t[e][i])))}return s}}class DataTransform{static apply(e,t,s,a,i){null==a.x&&(a.x=0),null==a.y&&(a.y=0),"Wall"===e?this.transformWall(t,s,a,i):"Tile"===e?this.transformTile(t,s,a,i):"Note"==e?this.transformNote(t,s,a,i):"Token"===e?this.transformToken(t,s,a,i):"MeasuredTemplate"===e?this.transformMeasuredTemplate(t,s,a,i):"AmbientLight"===e?this.transformAmbientLight(t,s,a,i):"AmbientSound"===e?this.transformAmbientSound(t,s,a,i):"Drawing"===e?this.transformDrawing(t,s,a,i):"Region"===e?this.transformRegion(t,s,a,i):(t.x+=a.x,t.y+=a.y,null!=t.elevation&&(t.elevation+=a.z??0),i&&(i.document.x=t.x,i.document.y=t.y,t.elevation&&(i.document.elevation=t.elevation)))}static transformRegion(e,t,s,a){if(null!=s.scale&&e.shapes){const t=s.scale;for(const s of e.shapes)if("polygon"===s.type)for(let e=0;e<s.points.length;e++)s.points[e]*=t;else s.x*=t,s.y*=t,"ellipse"===s.type?(s.radiusX*=t,s.radiusY*=t):"rectangle"===s.type&&(s.height*=t,s.width*=t)}if(e.shapes&&e.shapes.forEach((e=>{if("polygon"===e.type)for(let t=0;t<e.points.length;t+=2)try{e.points[t]+=s.x,e.points[t+1]+=s.y}catch(t){console.log(e,s)}else e.x+=s.x,e.y+=s.y})),s.z&&(Number.isNumeric(e.elevation?.bottom)&&(e.elevation.bottom+=s.z),Number.isNumeric(e.elevation?.top)&&(e.elevation.top+=s.z)),null!=s.rotation&&e.shapes)for(const a of e.shapes)if("polygon"===a.type){const e=Math.toRadians(s.rotation%360);for(let s=0;s<a.points.length;s+=2)[a.points[s],a.points[s+1]]=this.rotatePoint(t.x,t.y,a.points[s],a.points[s+1],e)}else{const e=Math.toRadians(s.rotation%360);let i={x:a.x+(a.radiusX??a.width)/2,y:a.y+(a.radiusY??a.height)/2};[i.x,i.y]=this.rotatePoint(t.x,t.y,i.x,i.y,e),a.x=i.x-(a.radiusX??a.width)/2,a.y=i.y-(a.radiusY??a.height)/2,a.rotation+=Math.toDegrees(e)}if(a){const t=a.document;if(e.elevation&&(t.elevation=e.elevation),e.shapes)for(let s=0;s<e.shapes.length;s++){const a=t.shapes[s],i=e.shapes[s];if(a.type!==i.type)break;"polygon"===a.type?a.points=i.points:(a.x=i.x,a.y=i.y,"rectangle"===a.type?(a.width=i.width,a.height=i.height):"ellipse"===a.type&&(a.radiusX=i.radiusX,a.radiusY=i.radiusY))}}}static transformNote(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a)}a&&(a.document.x=e.x,a.document.y=e.y,e.elevation&&(a.document.elevation=e.elevation))}static transformAmbientSound(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.radius*=t),null!=e.elevation&&(e.elevation*=t,e.elevation*=t)}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.z&&(e.elevation=(e.elevation??0)+s.z),null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.radius=e.radius,e.elevation&&(t.elevation=e.elevation)}}static transformWall(e,t,s,a){const i=foundry.utils.deepClone(e.c);if(null!=s.scale){const e=s.scale;i[0]*=e,i[1]*=e,i[2]*=e,i[3]*=e}if(i[0]+=s.x,i[1]+=s.y,i[2]+=s.x,i[3]+=s.y,null!=s.rotation){const e=Math.toRadians(s.rotation%360);[i[0],i[1]]=this.rotatePoint(t.x,t.y,i[0],i[1],e),[i[2],i[3]]=this.rotatePoint(t.x,t.y,i[2],i[3],e)}e.c=i,a&&(a.document.c=i)}static transformMeasuredTemplate(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.distance*=t,e.width&&(e.width*=t))}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a),e.direction+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.direction=e.direction,t.distance=e.distance,t.width=e.width,e.elevation&&(t.elevation=e.elevation)}}static transformAmbientLight(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.config.dim*=t,e.config.bright*=t),null!=e.elevation&&(e.elevation*=t)}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.z&&(e.elevation=(e.elevation??0)+s.z),null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a),e.rotation+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.rotation=e.rotation,t.config.dim=e.config.dim,t.config.bright=e.config.bright,e.elevation&&(t.elevation=e.elevation)}}static transformTile(e,t,s,a){const i=e.flags?.["levels-3d-preview"]?.depth;if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,e.width*=t,e.height*=t,null!=i&&""!=i&&(e.flags["levels-3d-preview"].depth*=t),null!=e.elevation&&(e.elevation*=t)}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.z&&(e.elevation=(e.elevation??0)+s.z),null!=s.rotation){const a=Math.toRadians(s.rotation%360);let i={x:e.x+e.width/2,y:e.y+e.height/2};[i.x,i.y]=this.rotatePoint(t.x,t.y,i.x,i.y,a),e.x=i.x-e.width/2,e.y=i.y-e.height/2,e.rotation+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.rotation=e.rotation,e.elevation&&(t.elevation=e.elevation)}}static transformDrawing(e,t,s,a){if(null!=s.scale){const t=s.scale;if(e.x*=t,e.y*=t,e.shape.width*=t,e.shape.height*=t,e.shape.points){const s=e.shape.points;for(let e=0;e<s.length;e++)s[e]*=t}}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const a=Math.toRadians(s.rotation%360);let i={x:e.x+e.shape.width/2,y:e.y+e.shape.height/2};[i.x,i.y]=this.rotatePoint(t.x,t.y,i.x,i.y,a),e.x=i.x-e.shape.width/2,e.y=i.y-e.shape.height/2,e.rotation+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.shape.width=e.shape.width,t.shape.height=e.shape.height,t.shape.points=e.shape.points,t.rotation=e.rotation,e.elevation&&(t.elevation=e.elevation)}}static transformToken(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.width*=t,e.height*=t,e.elevation*=t)}e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0);const i=canvas.grid;if(null!=s.rotation){const a=Math.toRadians(s.rotation%360);let n={x:e.x+e.width*(i.sizeX??i.w)/2,y:e.y+e.height*(i.sizeY??i.h)/2};[n.x,n.y]=this.rotatePoint(t.x,t.y,n.x,n.y,a),e.x=n.x-e.width*(i.sizeX??i.w)/2,e.y=n.y-e.height*(i.sizeY??i.h)/2,e.rotation=(e.rotation+Math.toDegrees(a))%360}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.elevation=e.elevation,t.rotation=e.rotation,t.width=e.width,t.height=e.height,e.elevation&&(t.elevation=e.elevation)}}static rotatePoint(e,t,s,a,i){const n=s-e,o=a-t;return[e+Math.cos(i)*n-Math.sin(i)*o,t+Math.sin(i)*n+Math.cos(i)*o]}}async function n(){const e=new Map;if(i.Me.forEach((t=>{const s=canvas.getLayerByEmbeddedName(t).controlled;s.length&&e.set(t,s.map((e=>e)))})),!e.size){const t=await new Promise((async e=>{Picker.activate(e)}));if(!t)return;const s=new PIXI.Rectangle(t.start.x,t.start.y,t.end.x-t.start.x,t.end.y-t.start.y);i.Me.forEach((t=>{let a=[];canvas.getLayerByEmbeddedName(t).placeables.forEach((e=>{const t=e.center;s.contains(t.x,t.y)&&a.push(e)})),a.length&&e.set(t,a)}))}if(!e.size)return;const t=new Map,s=new Map;let a;e.forEach(((e,n)=>{if(i.Me.includes(n)){let i=e.map((e=>e.document.toCompendium(null,{keepId:!0})));if("Token"===n&&game.modules.get("token-attacher")?.active&&tokenAttacher?.generatePrototypeAttached)for(const e of i){const t=e.flags?.["token-attacher"]?.attached||{};if(!foundry.utils.isEmpty(t)){const s=tokenAttacher.generatePrototypeAttached(e,t);foundry.utils.setProperty(e,"flags.token-attacher.attached",null),foundry.utils.setProperty(e,"flags.token-attacher.prototypeAttached",s),foundry.utils.setProperty(e,"flags.token-attacher.grid",{size:canvas.grid.size,w:canvas.grid.sizeX??canvas.grid.w,h:canvas.grid.sizeY??canvas.grid.h})}}t.set(n,i),s.set(n,foundry.utils.deepClone(i)),a||(a=n)}})),t.size&&Picker.activate((async e=>{null!=e&&t.forEach(((e,t)=>{let a=[];const i=s.get(t);for(let t=0;t<i.length;t++){const s=foundry.utils.diffObject(i[t],e[t]);foundry.utils.isEmpty(s)||(s._id=i[t]._id,delete s.flags,a.push(s))}a.length&&canvas.scene.updateEmbeddedDocuments(t,a)}))}),{documentName:a,previewData:t,snap:!0,taPreview:"ALL",center:!0})}},652:(e,t,s)=>{s.d(t,{A0:()=>PresetCollection,A6:()=>PresetTree,XF:()=>m,Xd:()=>h,_P:()=>PresetFolder,af:()=>PresetAPI,dH:()=>PresetPackFolder,y1:()=>VirtualFileFolder});var a=s(439),i=s(241),n=s(971),o=s(465),r=s(120),l=s(627),c=s(671),d=s(575);const u="world.mass-edit-presets-main",h="MassEditMetaData",m=["id","img","documentName","tags"];class PresetCollection{static presets;static workingPack;static async getTree(e,{externalCompendiums:t=!0,virtualDirectory:s=!0,setFormVisibility:a=!1}={}){let i,n;CONFIG.debug.MassEdit&&console.time("getTree");try{i=await this._initCompendium(this.workingPack),n=await PresetTree.init(i,e,{forceLoad:!0,setFormVisibility:a})}catch(t){console.log(t),console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`),console.log("RETURNING TO DEFAULT"),await game.settings.set(r.Do,"workingPack",u),this.workingPack=u,i=await this._initCompendium(this.workingPack),n=await PresetTree.init(i,e,{forceLoad:!0,setFormVisibility:a})}const o=[];if(t)for(const t of game.packs)if(t.collection!==this.workingPack&&t.index.get(h)){const s=await PresetTree.init(t,e,{setFormVisibility:a});if(!s.hasVisible)continue;const i=new PresetPackFolder({pack:t,tree:s});o.push(i),n.allFolders.set(i.uuid,i);for(const[e,t]of s.allFolders)n.allFolders.set(e,t)}if(s){const t=await l.WX.getVirtualDirectoryTree(e,{setFormVisibility:a});if(t?.hasVisible){const e=new VirtualFileFolder({name:"VIRTUAL DIRECTORY",children:t.folders,uuid:"virtual_directory",color:"#1c5fa385"});o.push(e),n.allFolders.set(e.uuid,e);for(const[e,s]of t.allFolders)n.allFolders.set(e,s)}}return n.extFolders=this._groupExtFolders(o,n.allFolders),CONFIG.debug.MassEdit&&console.timeEnd("getTree"),n}static _groupExtFolders(e,t){e=e.sort(((e,t)=>e.name.localeCompare(t.name)));const s={},a=[];e.forEach((e=>{e.group?(e.group in s||(s[e.group]=[]),s[e.group].push(e)):a.push(e)}));const i=[];for(const[e,a]of Object.entries(s)){const s=r.AU.randomID(e),n="virtual@"+e,o=new PresetVirtualFolder({id:s,uuid:n,name:e,children:a,draggable:!1});t.set(n,o),i.push(o)}return i.concat(a).sort(((e,t)=>e.name.localeCompare(t.name)))}static async _cleanIndex(e,t,s){if(e.locked||!t||foundry.utils.isEmpty(s))return;const a=e.index,i={};for(const e of Object.keys(s))a.has(e)||(i["-="+e]=null);foundry.utils.isEmpty(i)||(CONFIG.debug.MassEdit&&console.log("Mass Edit - Index Cleanup",i),t.setFlag(r.Do,"index",i),delete PresetTree._packTrees[e.metadata.name])}static _sortFolders(e,t="a"){for(const t of e)t.children=this._sortFolders(t.children,t.sorting),t.presets=this._sortPresets(t.presets,t.sorting);return"a"===t?e.sort(((e,t)=>e.name.localeCompare(t.name,"en",{numeric:!0}))):e.sort(((e,t)=>e.sort-t.sort))}static _sortPresets(e,t="a"){return"a"===t?e.sort(((e,t)=>e.name.localeCompare(t.name,"en",{numeric:!0}))):e.sort(((e,t)=>e.sort-t.sort))}static async packToPresets(e){if(!e)return[];const t=[];let s=(await e.getDocument(h))?.getFlag(r.Do,"index");const a=e.index.contents;for(const i of a){if(i._id===h)continue;const a=s[i._id],n=new c.k({...i,...a,pack:e.collection});t.push(n)}return t}static async update(e){const t=await this._initCompendium(this.workingPack),s=await t.getDocument(e.id),a={name:e.name,flags:{[r.Do]:{preset:e.toJSON()}}},i=e.pages;i&&(a.pages=i),await s.update(a);const n=await this._initMetaDocument(this.workingPack),o={};m.forEach((t=>{o[t]=e[t]})),await n.setFlag(r.Do,"index",{[e.id]:o}),delete PresetTree._packTrees[t.metadata.name]}static async updatePresets(e){await JournalEntry.updateDocuments(e,{pack:this.workingPack})}static async set(e,t){if(t||(t=this.workingPack),e instanceof Array){for(const s of e)await PresetCollection.set(s,t);return}if((await this._initCompendium(t)).index.get(e.id))return void await this.update(e);const s=await JournalEntry.createDocuments([{_id:e.id,name:e.name,pages:e.pages??[],folder:e.folder,flags:{[r.Do]:{preset:e.toJSON()}}}],{pack:t,keepId:!0});e.uuid=s[0].uuid,e.document=s[0];const a=await this._initMetaDocument(t),i={};m.forEach((t=>{i[t]=e[t]})),await a.setFlag(r.Do,"index",{[e.id]:i}),delete PresetTree._packTrees[t]}static async get(e,{full:t=!0}={}){if(e.startsWith("virtual@"))return this._constructVirtualFilePreset(e,{full:t});let{collection:s,documentId:a,documentType:i,embedded:n,doc:o}=foundry.utils.parseUuid(e);const l=s.index.get(a);if(l){const e=(await s.getDocument(h))?.getFlag(r.Do,"index"),a=e[l._id],i=new c.k({...l,...a,pack:s.collection});return t&&await i.load(),i}return null}static async _constructVirtualFilePreset(e,{full:t=!0}={}){const s=e.substring(8),a=new c.JG({src:s});return t&&await a.load(),a}static async delete(e){if(!e)return;e instanceof Array||(e=[e]);const t={};for(const s of e){let{collection:e}=foundry.utils.parseUuid(s.uuid);e&&(e=e.collection,t[e]?t[e].push(s):t[e]=[s])}for(const e of Object.keys(t)){const s=await game.packs.get(e);if(!s)continue;const a=await this._initMetaDocument(e),i={},n=[];for(const s of t[e])n.push(s.id),i["-="+s.id]=null;const o={pack:e};o.ids=n,await JournalEntry.deleteDocuments(n,o),await a.setFlag(r.Do,"index",i),delete PresetTree._packTrees[s.metadata.name]}}static async _initCompendium(e){let t=game.packs.get(e);return t||e!==u||(t=await CompendiumCollection.createCompendium({label:"Mass Edit: Presets (MAIN)",type:"JournalEntry",ownership:{GAMEMASTER:"NONE",PLAYER:"NONE",ASSISTANT:"NONE"},packageType:"world"}),await this._initMetaDocument(e)),t}static async _initMetaDocument(e){const t=game.packs.get(e),s=await t.getDocument(h);if(s)return s;return(await JournalEntry.createDocuments([{_id:h,name:"!!! METADATA: DO NOT DELETE !!!",flags:{[r.Do]:{index:{}}}}],{pack:e,keepId:!0}))[0]}static async deleteFolder(e,t=!1){const s=await fromUuid(e);if(!s.compendium.locked){if(t){const e=s.compendium.get(h);if(!e)return;const t={},a=function(e){e.contents.forEach((e=>t["-="+e._id]=null)),e.children.forEach((e=>a(e.folder)))};a(s),e.setFlag(r.Do,"index",t)}return delete PresetTree._packTrees[s.compendium.metadata.name],await s.delete({deleteSubfolders:t,deleteContents:t})}}static _searchPresetTree(e,t){const s=[];return t.folder||this._searchPresetList(e.allPresets,s,t),e.allFolders.forEach((e=>this._searchPresetFolder(e,s,t))),s}static _searchPresetFolder(e,t,s){s.folder&&e.name!==s.folder||this._searchPresetList(e.presets,t,s,e.name)}static _searchPresetList(e,t,{name:s,type:a,tags:i}={},n){for(const n of e){let e=!0;s&&s!==n.name&&(e=!1),a&&a!==n.documentName&&(e=!1),e&&i&&(e=i.matchAny?i.tags.some((e=>n.tags.includes(e))):i.tags.every((e=>n.tags.includes(e)))),e&&t.push(n)}}static async buildSpotlightOmnisearchIndex(e){const t=await PresetCollection.getTree(null,{externalCompendiums:!0}),s=CONFIG.SpotlightOmnisearch.SearchTerm,a=async function(){r.Me.includes(this.data.documentName)&&(ui.spotlightOmnisearch?.setDraggingState(!0),await PresetAPI.spawnPreset({preset:this.data,coordPicker:!0,taPreview:"ALL",scaleToGrid:game.settings.get(r.Do,"presetScaling")}),ui.spotlightOmnisearch?.setDraggingState(!1))},n=function(e){if(r.Me.includes(this.data.documentName)){const{x:t,y:s}=canvas.canvasCoordinatesFromClient({x:e.clientX,y:e.clientY});PresetAPI.spawnPreset({preset:this.data,x:t,y:s,scaleToGrid:game.settings.get(r.Do,"presetScaling")})}else"Scene"===this.data.documentName&&(0,r.XK)(this.data)},o=function(){ui.spotlightOmnisearch?.setDraggingState(!1)},l=function(){const e=[{name:"MassEdit.presets.open-journal",icon:'<i class="fas fa-book-open fa-fw"></i>',callback:()=>{this.data.openJournal()}}];return r.Me.includes(this.data.documentName)&&e.push({name:"MassEdit.presets.controls.activate-brush",icon:'<i class="fas fa-paint-brush"></i>',callback:async()=>{canvas.getLayerByEmbeddedName(this.data.documentName)?.activate(),i.vM.activate({preset:await this.data.load(),deactivateCallback:o})&&ui.spotlightOmnisearch.setDraggingState(!0)}}),e},c=function(t){e.push(new s({name:t.name,description:"Mass Edit: Preset",type:t.documentName+" preset",img:t.img,icon:["fa-solid fa-books",t.icon],keywords:t.tags,onClick:a,onDragEnd:n,data:t,actions:l}))};t.presets.forEach(c),t.allFolders.forEach((e=>e.presets.forEach(c)))}}class PresetAPI{static name="PresetAPI";static async getPreset({uuid:e,name:t,type:s,folder:a,tags:i,random:n=!1}={}){if(e)return await PresetCollection.get(e);if(!(t||s||a||i))throw Error("UUID, Name, Type, and/or Folder required to retrieve a Preset.");i&&(Array.isArray(i)?i={tags:i,matchAny:!0}:"string"==typeof i&&(i={tags:i.split(","),matchAny:!0}));const o=PresetCollection._searchPresetTree(await PresetCollection.getTree(s,{externalCompendiums:!0,virtualDirectory:!0}),{name:t,type:s,folder:a,tags:i}),r=n?o[Math.floor(Math.random()*o.length)]:o[0];return r?.clone().load()}static async getPresets({uuid:e,name:t,type:s,folder:a,format:i="preset",tags:n}={}){let o;if(e){o=[];const t=Array.isArray(e)?e:[e];for(const e of t){const t=await PresetCollection.get(e);t&&o.push(t)}}else{if(!(t||s||a||n))throw Error("UUID, Name, Type, Folder and/or Tags required to retrieve a Preset.");n&&(Array.isArray(n)?n={tags:n,matchAny:!0}:"string"==typeof n&&(n={tags:n.split(","),matchAny:!0})),o=PresetCollection._searchPresetTree(await PresetCollection.getTree(s,{externalCompendiums:!0,virtualDirectory:!0}),{name:t,type:s,folder:a,tags:n})}return"name"===i?o.map((e=>e.name)):"nameAndFolder"===i?o.map((e=>({name:e.name,folder:e._folderName}))):o}static async createPresetFromActor(e,{keepId:t=!1,folder:s}={}){if(!e||"Actor"!==e.documentName)return;const a={id:t?e.id:null,name:e.name,documentName:"Token",img:e.img,data:[e.prototypeToken.toJSON()],folder:s};a.gridSize=canvas.scene.grid.size;const i=new c.k(a);return await PresetCollection.set(i),i}static async createPresetFromActorUuid(e,t={}){const s=await fromUuid(e);if("Actor"!==!s.documentName)return await this.createPresetFromActor(s,t)}static async createPreset(e,t={}){if(!e)return;e instanceof Array||(e=[e]);const s={};for(const t of e){const e=t.document.documentName;s.hasOwnProperty(e)||(s[e]=[]),s[e].push(t)}const a=[];for(const[e,i]of Object.entries(s)){const s=[];for(const e of i)s.push((0,d.h)(e));const n={name:(0,r.kg)("presets.default-name"),documentName:e,data:s};switch(n.documentName){case"Token":case"Tile":case"Note":n.img=s[0].texture.src;break;case"AmbientSound":n.img="icons/svg/sound.svg";break;case"AmbientLight":n.img="icons/svg/light.svg";break;case"Drawing":n.img="icons/svg/acid.svg";break;case"MeasuredTemplate":n.img="icons/svg/circle.svg"}if("Token"===n.documentName)n.name=s[0].name;else{const e=s[0].flags?.tagger?.tags?.[0];e&&(n.name=e)}n.gridSize=i[0].document.parent.grid.size,foundry.utils.mergeObject(n,t,{inplace:!0});const o=new c.k(n);await PresetCollection.set(o),a.push(o)}return a}static async spawnPreset({uuid:e,preset:t,name:s,type:i,folder:l,tags:c,random:u=!1,x:h,y:m,z:g,coordPicker:p=!1,pickerLabel:f,taPreview:y,snapToGrid:b=!0,hidden:v=!1,layerSwitch:w=!1,scaleToGrid:k=!1,modifyPrompt:x=!0,center:_=!1,transform:T={},previewOnly:S=!1,sceneId:P}={}){if(!canvas.ready)throw Error("Canvas need to be 'ready' for a preset to be spawned.");if(!(e||t||s||i||l||c))throw Error("ID, Name, Folder, Tags, or Preset is needed to spawn it.");if(!p&&(null==h&&null!=m||null!=h&&null==m))throw Error("Need both X and Y coordinates to spawn a preset.");if(t&&await t.load(),!(t=t??await PresetAPI.getPreset({uuid:e,name:s,type:i,folder:l,tags:c,random:u})))throw Error(`No preset could be found matching: { uuid: "${e}", name: "${s}", type: "${i}"}`);let D=foundry.utils.deepClone(t.data);if(t.spawnRandom&&D.length&&(D=[D[Math.floor(Math.random()*D.length)]]),x&&t.modifyOnSpawn?.length&&(D=await(0,d.e9)(D,t.modifyOnSpawn),null==D))return;D=D.map((e=>(0,d.Go)(t,e))),D=D.map((e=>foundry.utils.flattenObject(e))),foundry.utils.isEmpty(t.randomize)||await(0,o.of)(D,null,t.randomize),await(0,a.fP)(t.documentName,D,D),D=D.map((e=>foundry.utils.expandObject(e))),t.preSpawnScript&&await(0,r.HG)(t.preSpawnScript,{data:D});const E=new Map;if(E.set(t.documentName,D),t.attached)for(const e of t.attached){E.get(e.documentName)||E.set(e.documentName,[]);const t=foundry.utils.deepClone(e.data);E.get(e.documentName).push(t)}if(k){const e=canvas.grid.size/(t.gridSize||100);E.forEach(((t,s)=>{t.forEach((t=>n.DataTransform.apply(s,t,{x:0,y:0},{scale:e,gridScale:!0})))}))}if(p){const e=await new Promise((async e=>{n.Picker.activate(e,{documentName:t.documentName,previewData:E,snap:b,label:f,taPreview:y,center:_,previewOnly:S,...T})}));if(null==e)return[];h=e.end.x,m=e.end.y,null!=e.end.z&&(g=e.end.z)}else if(null==h||null==m)if(game.Levels3DPreview?._active){const e=game.Levels3DPreview.interactionManager.canvas2dMousePosition;h=e.x,m=e.y,g=e.z}else h=canvas.mousePosition.x,m=canvas.mousePosition.y,"Token"!==t.documentName&&"Tile"!==t.documentName||(h-=canvas.dimensions.size/2,m-=canvas.dimensions.size/2);if(!p){if(_){const e=(0,d.Ym)(E);h-=e.x,m-=e.y}let e={x:h,y:m};b&&!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)&&(e=canvas.grid.getSnappedPoint?canvas.getLayerByEmbeddedName(t.documentName).getSnappedPoint(e):canvas.grid.getSnappedPosition(e.x,e.y,canvas.getLayerByEmbeddedName(t.documentName).gridPrecision)),e.z=g;const s=(0,d.Q2)(E);s.x+=e.x,s.y+=e.y,game.Levels3DPreview?._active&&(null==e.z?s.z=0:s.z+=e.z),E.forEach(((e,t)=>{e.forEach((e=>{n.DataTransform.apply(t,e,{x:0,y:0},s)}))}))}E.forEach(((e,t)=>{e.forEach((e=>{["Drawing","MeasuredTemplate"].includes(t)&&("Drawing"===t?e.author=game.user.id:"MeasuredTemplate"===t&&(e.user=game.user.id)),(v||game.keyboard.downKeys.has("AltLeft"))&&(e.hidden=!0)}))})),w&&(game.user.isGM||["Token","MeasuredTemplate","Note"].includes(t.documentName))&&canvas.getLayerByEmbeddedName(t.documentName)?.activate();const O=[];for(const[e,t]of E.entries()){(await(0,r.VS)(e,t,P??canvas.scene.id)).forEach((e=>O.push(e)))}return t.postSpawnScript&&await(0,r.HG)(t.postSpawnScript,{documents:O,objects:O.map((e=>e.object)).filter(Boolean)}),await t.callPostSpawnHooks({documents:O,objects:O.map((e=>e.object)).filter(Boolean)}),O}}class PresetFolder{static isEditable(e){const{collection:t}=foundry.utils.parseUuid(e);return t&&!t.locked}constructor({id:e,uuid:t,name:s,sorting:a="m",color:i="#000000",sort:n=0,children:o=[],presets:r=[],draggable:l=!0,folder:c=null,visible:u=!0,render:h=!0,types:m=[]}={}){this.id=e,this.uuid=t,this.name=s,this.sorting=a,this.color=i,this.sort=n,this.children=o,this.children.forEach((e=>{e.folder=this.id})),this.presets=r,this.draggable=l,this.folder=c,this.visible=u,this.render=h,this.expanded=d.cm.expanded(this.uuid),this.types=m}async update(e){const t=await fromUuid(this.uuid);t&&(foundry.utils.mergeObject(this,e),await t.update(e))}}class PresetVirtualFolder extends PresetFolder{constructor(e){super(e),this.virtual=!0,this.draggable=!1}async update(e){}}class VirtualFileFolder extends PresetVirtualFolder{constructor(e){super(e),this.id=foundry.utils.randomID(),e.types||(this.types=["ALL"]),this.bucket=e.bucket,this.source=e.source,this.name=(0,d.e6)(this.name),this.icon=e.icon,this.subtext=e.subtext,e.source&&["data","forgevtt"].includes(e.source)&&(this.indexable=!0)}}class PresetPackFolder extends PresetVirtualFolder{constructor(e){const t=e.tree,s=e.pack,a=t.metaDoc.getFlag(r.Do,"folder")??{},i=s.collection;super({uuid:i,id:r.AU.randomID(i),name:a.name??s.title,children:t.folders,presets:t.presets,draggable:!1,color:a.color??"#000000"}),this.group=a.group}get pack(){return this.uuid}async update(e={}){const t=game.packs.get(this.pack);if(t.locked)return;if(e.hasOwnProperty("name")&&e.name===t.title&&delete e.name,foundry.utils.isEmpty(e))return;const s=await PresetCollection._initMetaDocument(this.pack);await s.setFlag(r.Do,"folder",e),foundry.utils.mergeObject(this,e)}}class PresetTree{static _packTrees={};static async init(e,t,{forceLoad:s=!1,setFormVisibility:a=!1}={}){if(!e)return null;if(CONFIG.debug.MassEdit&&console.time(e.title),!s&&PresetTree._packTrees[e.metadata.name]){const s=PresetTree._packTrees[e.metadata.name];return a&&s.setVisibility(t),CONFIG.debug.MassEdit&&console.timeEnd(e.title),s}const i=new Map,n=new Map,o=e.folders.contents;for(const e of o){const t=new PresetFolder({id:e._id,uuid:e.uuid,name:e.name,sorting:e.sorting,color:e.color,sort:e.sort,draggable:e.pack===PresetCollection.workingPack,folder:e.folder?.uuid,types:e.flags[r.Do]?.types||["ALL"]});i.set(t.uuid,t),n.set(e.uuid,t)}for(const e of o)if(e.folder){i.get(e.folder.uuid).children.push(i.get(e.uuid)),n.delete(e.uuid)}const l=[],d=[];let u=!1;const m=await e.getDocument(h);let g=m?.getFlag(r.Do,"index");const p=e.index.contents;PresetCollection._cleanIndex(e,m,g);for(const t of p){if(t._id===h)continue;const s=g[t._id],a=new c.k({...t,...s,pack:e.collection});if(!a.documentName){if(console.log(`Missing MetaData. Attempting document load: ${a.id} | ${a.name}`),await a.load(!0),!a.documentName)continue;console.log(`MetaData. Found for: ${a.id} | ${a.name}`),e.locked||await a._updateIndex(a)}if(a.folder){let e=!1;for(const[t,s]of i)if(s.id===a.folder){s.presets.push(a),e=!0;break}e||d.push(a)}else d.push(a);l.push(a),u|=a._visible}const f="manual"===game.settings.get(r.Do,"presetSortMode")?"m":"a",y=PresetCollection._sortFolders(Array.from(n.values()),f),b=PresetCollection._sortPresets(d,f);CONFIG.debug.MassEdit&&console.timeEnd(e.title);const v=new PresetTree({folders:y,presets:b,allPresets:l,allFolders:i,hasVisible:u,metaDoc:m,pack:e});return a&&v.setVisibility(t),PresetTree._packTrees[e.metadata.name]=v,v}constructor({folders:e,presets:t,allPresets:s,allFolders:a,hasVisible:i,metaDoc:n,pack:o}={}){this.folders=e,this.presets=t,this.allPresets=s,this.allFolders=a,this.hasVisible=i,this.metaDoc=n,this.pack=o}setVisibility(e){this.allFolders.forEach((t=>{t.render=!0,t.visible=!e||t.types.includes(e)})),this.hasVisible=!1;for(const t of this.allPresets){if(t._visible=!0,t._render=!0,e&&("ALL"===e?r.TA.includes(t.documentName)||(t._visible=!1):"FAVORITES"===e?t.isFavorite||(t._visible=!1):t.documentName!==e&&(t._visible=!1)),"FAVORITES"===e&&t.folder&&t.isFavorite)for(const[e,s]of this.allFolders)if(s.id===t.folder){this._setChildAndParentFoldersVisible(s);break}this.hasVisible=this.hasVisible||t._visible}}_setChildAndParentFoldersVisible(e){if(e.visible=!0,e.folder)for(const[t,s]of this.allFolders.entries())if(s.id===e.folder)return this._setChildAndParentFoldersVisible(s)}}},627:(e,t,s)=>{s.d(t,{ME:()=>IndexerForm,WX:()=>FileIndexer,u9:()=>FileIndexerAPI});var a=s(120),i=s(652),n=s(671),o=s(575);const r="mass_edit_cache.json";class FileIndexer{static _loadedTree;static _buildingIndex=!1;static async getVirtualDirectoryTree(e,{setFormVisibility:t=!1}={}){if(CONFIG.debug.MassEdit&&console.time("Virtual File Directory"),this._loadedTree)return CONFIG.debug.MassEdit&&console.timeEnd("Virtual File Directory"),t&&this._loadedTree.setVisibility(e),this._loadedTree;const s=new Map,a=[],n=[],o=await this.loadMainIndexCache();if(!o)return CONFIG.debug.MassEdit&&console.timeEnd("Virtual File Directory"),null;for(const e of o){let t="";if("forge-bazaar"===e.source)t="https://assets.forge-vtt.com/bazaar/";else if("forgevtt"===e.source){if("undefined"==typeof ForgeVTT||!ForgeVTT.usingTheForge)continue;const e=await ForgeAPI.getUserId();if(!e)continue;t=`https://assets.forge-vtt.com/${e}/`}else if("s3"===e.source){const s=game.data.files.s3;if(!s||!s.buckets.includes(e.bucket))continue;t=`https://${e.bucket}.${s.endpoint.host}`}const o=e.index.map((i=>this._indexToVirtualFolder(i,"",s,a,{prePend:t,source:e.source,bucket:e.bucket})));if(o?.length){const t=new i.y1({uuid:"virtual@source@"+e.source,name:e.source,children:o,types:["ALL"],bucket:e.bucket});o.some((e=>e.types.includes("Tile")))&&t.types.push("Tile"),o.some((e=>e.types.includes("AmbientSound")))&&t.types.push("AmbientSound"),o.forEach((e=>{e.folder=t.id})),s.set(t.uuid,t),n.push(t)}}let r;return n.length&&(r=new i.A6({folders:n,presets:[],allPresets:a,allFolders:s,hasVisible:a.some((e=>e._visible)),metaDoc:null,pack:null}),t&&r.setVisibility(e)),this._loadedTree=r,CONFIG.debug.MassEdit&&console.timeEnd("Virtual File Directory"),r}static async buildIndex(){if(this._buildingIndex)return void ui.notifications.warn("Index Build In-Progress. Wait for it to finish before attempting it again.");this._buildingIndex=!0,ui.notifications.info("Building Mass Edit directory index.");const e=game.settings.get(a.Do,"indexer");try{const t=[],s=[];for(const a of e.indexDirs){"forge-bazaar"!==a.source&&"forgevtt"!==a.source||await this._buildFauxForgeBrowser(a.source,a.target);let i=await this.generateIndex(a.target,s,a.source,a.bucket,e);if(i){const e=a.target.split("/").filter(Boolean);for(let t=e.length-2;t>=0;t--)i={dir:e[t],dirs:[i]};let s=t.find((e=>e.source===a.source&&e.bucket==a.bucket));s?this.mergeIndex(s.index,[i]):(s={source:a.source,index:[i]},a.bucket&&(s.bucket=a.bucket),t.push(s))}}for(const e of s){const s=await this.loadIndexCache(e);s&&this.mergeCaches(t,s)}const a=await this.loadIndexCache("/"+r);a&&this.mergeCaches(t,a,{tagsOnly:!0,overrideNullTagsOnly:e.overrideTags}),t.length&&await this._writeIndexToCache(t),this._loadedTree=null,ui.notifications.info("MassEdit Index build finished.")}catch(e){console.log(e)}this._buildingIndex=!1}static mergeCaches(e,t,{tagsOnly:s=!1,overrideNullTagsOnly:a=!1}={}){for(const i of t){const t=e.find((e=>e.source===i.source&&e.bucket==i.bucket));t?this.mergeIndex(t.index,i.index,{tagsOnly:s,overrideNullTagsOnly:a}):s||e.push(i)}}static mergeIndex(e,t,{tagsOnly:s=!1,overrideNullTagsOnly:a=!1}={}){for(const i of t){const t=e.find((e=>e.dir===i.dir));if(t){if(s||(t.icon=i.icon,t.subtext=i.subtext),i.dirs&&(t.dirs?this.mergeIndex(t.dirs,i.dirs,{tagsOnly:s,overrideNullTagsOnly:a}):s||(t.dirs=i.dirs)),i.files)if(t.files)for(const e of i.files){const i=t.files?.find((t=>t.name===e.name));i?a&&null!=i.tags||(i.tags=e.tags):s||(t.files||(t.files=[]),t.files.push(e))}else s||(t.files=i.files)}else s||e.push(i)}}static async getPreset(e){return this._loadedTree||await FileIndexer.getVirtualDirectoryTree(),this._loadedTree?this._loadedTree.allPresets.find((t=>t.uuid===e)):null}static async saveIndexToCache(e=this._loadedTree?.folders,{path:t="",notify:s=!0,source:a="data"}={}){if(e){const i=[];for(const t of e){const e={source:t.name,index:t.children.map((e=>this._cacheFolder(e)))};t.bucket&&(e.bucket=t.bucket),i.push(e)}this._writeIndexToCache(i,{path:t,notify:s,source:a})}}static async _writeIndexToCache(e,{path:t="",notify:s=!0,source:a="data"}={}){const i=JSON.stringify(e),n=await StringCompress.compress(i);await FilePicker.upload(a,t,n,{},{notify:s})}static async saveFolderToCache(e){if(!(this._loadedTree||e.indexable||e.source))return;const t=this._loadedTree.allFolders;let s=e;for(;s.folder;){let e;for(const[a,i]of t)if(i.id===s.folder){e=i;break}if(!e)return;e=new i.y1({name:e.name,folder:e.folder}),s&&(e.children=[s]),s=e}this.saveIndexToCache([s],{path:e.uuid.replace("virtual@",""),source:e.source})}static _cacheFolder(e){const t={dir:(0,o.CY)(e.name)};return e.presets.length&&(t.files=e.presets.map((e=>this._cachePreset(e)))),e.children.length&&(t.dirs=e.children.map((e=>this._cacheFolder(e)))),t}static _cachePreset(e){const t={name:(0,o.CY)(e.name)};return e.tags?.length&&(t.tags=e.tags),t}static async loadIndexCache(e){let t;try{t=await StringCompress.decompressCache(e)}catch(t){ui.notifications.warn("Failed to load cache: "+e)}return t}static async loadMainIndexCache(){let e;if("undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge){e=`https://assets.forge-vtt.com/${await ForgeAPI.getUserId()}/${r}`}else e="/"+r;return await this.loadIndexCache(e)}static _indexToVirtualFolder(e,t,s,a,o){const r=t+"/"+e.dir,l="virtual@"+o.prePend+r,c=new i.y1({uuid:l,name:e.dir,subtext:e.subtext,icon:e.icon,color:e.color,source:o.source,bucket:o.bucket});if(e.dirs){for(const t of e.dirs){const e=this._indexToVirtualFolder(t,r,s,a,o);e&&(e.folder=c.id,c.children.push(e))}c.children.sort(((e,t)=>e.name.localeCompare(t.name)))}if(e.files)for(const t of e.files){const e=new n.JG({name:t.name,src:o.prePend+r+"/"+t.name,tags:t.tags,folder:c.id});a.push(e),c.presets.push(e)}return["Tile","AmbientSound"].forEach((e=>{(c.presets.some((t=>t.documentName===e))||c.children.some((t=>t.types.includes(e))))&&c.types.push(e)})),s.set(l,c),c}static async generateIndex(e,t=[],s="data",i=null,n,l={},c=[]){let d,u=l[e]??{};if(u.noscan)return null;try{d=await this._browse(s,e,{bucket:i})}catch(e){return null}const h=d.files.find((e=>e.endsWith("indexer.json")));if(h&&(l=await(0,o.$J)(h)??{},u=l[e]??{},u.noscan))return null;u.tags&&(c=u.tags.map((e=>a.Fo.simplifyString(e))).filter(Boolean).concat(c));const m={dir:e.split("/").filter(Boolean).pop(),dirs:[],files:[]};if(n.folderFilters.some((e=>m.dir.includes(e))))return null;foundry.utils.isEmpty(u)||["color","icon","subtext"].forEach((e=>{u[e]&&(m[e]=u[e])}));for(let o of d.files){const l=o.split("\\").pop().split("/").pop();if(n.fileFilters.some((e=>l.includes(e))))continue;if("noscan.txt"===l)return null;if(l!==r||n.ignoreExternal){if("module.json"===l){const e=await this._getAuthorFromModule(o);if(e){m.subtext=u.subtext??e;const t=a.Fo.simplifyString(e.split(/[ ,\-_@]+/)[0]??"");t&&t.length>=3&&(c=[...c,t],m.files.forEach((e=>{e.tags=c})))}}}else{const a=n.cacheDir;if(a.target!==e.target||a.source!==s||a.bucket!==i)return t.push(o),null}let d=l.split(".");if(d=d[d.length-1].toLowerCase(),a.Y0.includes(d)){const e={name:l};c.length&&(e.tags=c),m.files.push(e)}}for(let e of d.dirs)e=await this.generateIndex(e,t,s,i,n,l,c),e&&m.dirs.push(e);return m.dirs.length||delete m.dirs,m.files.length||delete m.files,m.dirs||m.files?m:null}static async _browse(e,t,s){return"forge-bazaar"===e||"forgevtt"===e?this._fauxForgeBrowser?.get(t)??{dirs:[],files:[]}:await FilePicker.browse(e,t,s)}static async _buildFauxForgeBrowser(e,t){if(this._fauxForgeBrowser=new Map,"undefined"==typeof ForgeVTT||!ForgeVTT.usingTheForge)return;let s;if("forgevtt"!==e&&["modules","systems","worlds","assets"].includes(t.replaceAll(/[\/\\]/g,""))){s=(await FilePicker.browse(e,t,{recursive:!1})).dirs}else s=[t];const a=(e,t)=>{for(let s=1;s<e.length+1;s++){const a=e.slice(0,s).join("/"),i=e.slice(0,s+1).join("/");let n=this._fauxForgeBrowser.get(a);n||(n={dirs:[],files:[]},this._fauxForgeBrowser.set(a,n)),a===i?n.files.push(t):n.dirs.includes(i)||n.dirs.push(i)}};for(const t of s){const s=await FilePicker.browse(e,t,{recursive:!0});for(const e of s.files){const t=new URL(e).pathname.split("/");a(t.slice(2,t.length-1),t.slice(2).join("/"))}}}static async _getAuthorFromModule(e){const t=await(0,o.$J)(e);if(t){const e=t.author??t.authors?.[0]?.name;if("string"==typeof e)return e}return null}}class StringCompress{static async compress(e){const t=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip")),s=[];for await(const e of this.streamAsyncIterator(t))s.push(e);const a=new Blob(s);return new File([a],r)}static async decompressCache(e){let t;try{const s=await fetch(e);if(s.ok){const e=await this.decompress(s.body);t=JSON.parse(e)}}catch(e){}return t}static async decompress(e){const t=e.pipeThrough(new DecompressionStream("gzip")),s=[];for await(const e of this.streamAsyncIterator(t))s.push(e);const a=await this.concatUint8Arrays(s);return(new TextDecoder).decode(a)}static async concatUint8Arrays(e){const t=new Blob(e),s=await t.arrayBuffer();return new Uint8Array(s)}static async*streamAsyncIterator(e){const t=e.getReader();try{for(;;){const{done:e,value:s}=await t.read();if(e)return;yield s}}finally{t.releaseLock()}}}class IndexerForm extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","mass-edit-dark-window"],template:`modules/${a.Do}/templates/preset/indexer.html`,width:500,height:"auto"})}get title(){return"Directory Indexer"}async getData(e={}){const t=foundry.utils.deepClone(game.settings.get(a.Do,"indexer"));return t.fileFilters=t.fileFilters.join(", "),t.folderFilters=t.folderFilters.join(", "),t}activateListeners(e){super.activateListeners(e),e.on("click",".addDirectory",this._onAddDirectory.bind(this)),e.on("click",".deleteDirectory",this._onDeleteDirectory.bind(this)),e.on("input",'[name="fileFilters"]',this._onFileFiltersChange.bind(this)),e.on("input",'[name="folderFilters"]',this._onFolderFiltersChange.bind(this)),e.find('input[type="checkbox"]').on("change",this._onToggleCheckbox.bind(this))}_onToggleCheckbox(e){const t=$(e.currentTarget),s=t.attr("name");this._updateIndexerSettings({[s]:t.is(":checked")},!1)}_onFileFiltersChange(e){clearTimeout(this._onInputTimeOut),this._onInputTimeOut=setTimeout((()=>{const t=$(e.currentTarget).val().split(",").map((e=>e.trim())).filter(Boolean);this._updateIndexerSettings({fileFilters:t},!1)}),500)}_onFolderFiltersChange(e){clearTimeout(this._onInputTimeOut),this._onInputTimeOut=setTimeout((()=>{const t=$(e.currentTarget).val().split(",").map((e=>e.trim())).filter(Boolean);this._updateIndexerSettings({folderFilters:t},!1)}),500)}async _onAddDirectory(){this.selectFolder((async e=>{if(!e)return;if(e.bucket||delete e.bucket,!["data","public","forge-bazaar","forgevtt","s3"].includes(e.source))return void ui.notifications.warn(`${e.source} is not a supported source.`);const t=game.settings.get(a.Do,"indexer").indexDirs;t.find((t=>t.source===e.source&&t.target===e.target&&t.bucket==e.bucket))||(t.push(e),this._updateIndexerSettings({indexDirs:t}))}))}async _onDeleteDirectory(e){const t=$(e.target).closest(".directory"),s=t.find(".source").val(),i=t.find(".target").val(),n=t.find(".bucket").val()||null,o=game.settings.get(a.Do,"indexer").indexDirs.filter((e=>!(e.source===s&&e.target===i&&e.bucket==n)));this._updateIndexerSettings({indexDirs:o})}async _updateIndexerSettings(e={},t=!0){const s=game.settings.get(a.Do,"indexer");foundry.utils.mergeObject(s,e),await game.settings.set(a.Do,"indexer",s),t&&await this.render()}async selectFolder(e){new FilePicker({type:"folder",activeSource:"data",current:"",callback:(t,s)=>{const a={target:s.result.target,source:s.activeSource,bucket:s.result.bucket};a.bucket||delete a.bucket,e(a)}}).render(!0)}async _updateObject(e,t){FileIndexer.buildIndex()}}class FileIndexerAPI{static async readCacheFile(e){return FileIndexer.loadIndexCache(e)}}},624:(e,t,s)=>{s.d(t,{P:()=>MassEditPresets,Q:()=>PresetConfig});var a=s(998),i=s(439),n=s(739);class TrackerDialog extends Dialog{constructor(e,{total:t,cancelCallback:s,left:a,top:i}){super(e,{left:a,top:i}),this.count=0,this.total=t,this.cancelCallback=s}incrementCount(){this.count++,this.element?.find(".count").html(this.count)}stop(){this.close(!0)}get active(){return this._state===Application.RENDER_STATES.RENDERED||this._state===Application.RENDER_STATES.RENDERING}}async function o({title:e="Progress",cancelCallback:t,total:s}={}){if(!s)return;const a=new TrackerDialog({title:e,content:`\n<div>\n<div  style="display: block; text-align: center; padding: 5px;"><i class="fas fa-circle-notch fa-spin fa-3x"></i></div>\n    <p style="text-align: center;"><span class="count">count</span>/${s}</p>\n</div>`,buttons:{cancel:{icon:'<i class="fas fa-stop"></i>',label:"Stop/Cancel",callback:()=>{t?.()}}},default:"cancel"},{total:s,cancelCallback:t,left:50,top:50});return await a._render(!0),a}function r(e){return e.presets?e.presets.length+e.children.reduce((function(e,t){return e+r(t)}),0):e.contents.length+e.children.reduce((function(e,t){return e+r(t.folder)}),0)}var l=s(241),c=s(860);class SortingHelpersFixed{static performIntegerSort(e,{target:t=null,siblings:s=[],sortKey:a="sort",sortBefore:i}={}){void 0===i&&(i=(e[a]||0)>(t?.[a]||0)),(s=Array.from(s)).sort(((e,t)=>e[a]-t[a]));let n,o,r=i?s.length:0,l=t?s.findIndex((e=>e===t)):r;return[n,o]=i?this._sortBefore(s,l,a):this._sortAfter(s,l,a),0===s.length?[{target:e,update:{[a]:CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(o)&&null===n?[{target:e,update:{[a]:o-CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(n)&&null===o?[{target:e,update:{[a]:n+CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(n)&&Number.isFinite(o)&&Math.abs(o-n)>1?[{target:e,update:{[a]:Math.round(.5*(n+o))}}]:(s.splice(l+(i?0:1),0,e),s.map(((e,t)=>({target:e,update:{[a]:(t+1)*CONST.SORT_INTEGER_DENSITY}}))))}static performIntegerSortMulti(e,{target:t=null,siblings:s=[],sortKey:a="sort",sortBefore:i}={}){let n=e[0];void 0===i&&(i=(n[a]||0)>(t?.[a]||0)),(s=Array.from(s)).sort(((e,t)=>e[a]-t[a]));let o,r,l=i?s.length:0,c=t?s.findIndex((e=>e===t)):l;if([o,r]=i?this._sortBefore(s,c,a):this._sortAfter(s,c,a),0===s.length)return e.map(((e,t)=>({target:e,update:{[a]:CONST.SORT_INTEGER_DENSITY*(t+1)}})));if(Number.isFinite(r)&&null===o)return e.map(((t,s)=>({target:t,update:{[a]:r-CONST.SORT_INTEGER_DENSITY*(e.length-s+1)}})));if(Number.isFinite(o)&&null===r)return e.map(((e,t)=>({target:e,update:{[a]:o+CONST.SORT_INTEGER_DENSITY*(t+1)}})));if(Number.isFinite(o)&&Number.isFinite(r)&&Math.abs(r-o)>e.length){let t=Math.floor(1/(e.length+1)*Math.abs(r-o));return 0===t&&(t=1),o=Math.min(r,o),e.map(((e,s)=>({target:e,update:{[a]:o+t*(s+1)}})))}return s.splice(c+(i?0:1),0,...e),s.map(((e,t)=>({target:e,update:{[a]:(t+1)*CONST.SORT_INTEGER_DENSITY}})))}static _sortBefore(e,t,s){let a=e[t]?e[t][s]:null;return[e[t-1]?e[t-1][s]:null,a]}static _sortAfter(e,t,s){return[e[t]?e[t][s]:null,e[t+1]?e[t+1][s]:null]}}var d=s(120),u=s(652),h=s(627),m=s(671);class TagSelector extends FormApplication{constructor(e){const t=TagSelector.defaultOptions;super({},{left:e.position.left-t.width-5,top:e.position.top}),this.presetsApp=e}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"tag-selector",classes:["mass-edit-dark-window","mass-edit-window-fill"],template:`modules/${d.Do}/templates/preset/tagSelector.html`,resizable:!0,minimizable:!0,width:200,height:500})}get title(){return"Tag Selector"}async close(e={}){return this.presetsApp._tagSelector=null,super.close(e)}async getData(e={}){const t=this.getTagsOfRendered(),s=this.getSearchedTags();let a=[],i=[];return t.forEach(((e,t)=>{const n={name:t,count:e};s.includes(t)?i.push(n):a.push(n)})),a=a.sort(((e,t)=>t.count-e.count)),i=i.sort(((e,t)=>t.count-e.count)),{tags:a,activeTags:i}}activateListeners(e){super.activateListeners(e),e.on("click",".tag",this._onClickTag.bind(this))}getTagsOfRendered(){const e=new Map;return this.presetsApp.tree.folders.forEach((t=>this._getFolderTags(t,e))),this.presetsApp.tree.extFolders.forEach((t=>this._getFolderTags(t,e))),this.presetsApp.tree.presets.forEach((t=>this._getPresetTags(t,e))),e}getSearchedTags(){return(MassEditPresets.lastSearch??"").split(" ").filter((e=>e.startsWith("#"))).map((e=>e.substring(1)))}_getFolderTags(e,t){if(e.render){for(const s of e.children)this._getFolderTags(s,t);for(const s of e.presets)this._getPresetTags(s,t)}}_getPresetTags(e,t){if(e.visible)for(const s of e.tags)t.set(s,(t.get(s)??0)+1)}_onClickTag(e){const t="#"+$(e.currentTarget).find("span").first().text(),s=this.presetsApp.element.find(".header-search input");let a=s.val();$(e.currentTarget).hasClass("active")?a=a.split(" ").filter((e=>e!==t)).filter(Boolean).join(" "):(!a.endsWith(" ")&&a.length&&(a+=" "),a+=t),s.val(a).trigger("input")}}var g=s(575);const p={manual:{get tooltip(){return(0,d.kg)("SIDEBAR.SortModeManual",!1)},icon:'<i class="fa-solid fa-arrow-down-short-wide"></i>'},alphabetical:{get tooltip(){return(0,d.kg)("SIDEBAR.SortModeAlpha",!1)},icon:'<i class="fa-solid fa-arrow-down-a-z"></i>'}},f={p:{get tooltip(){return(0,d.kg)("presets.search-presets")},icon:'<i class="fas fa-search"></i>'},pf:{get tooltip(){return(0,d.kg)("presets.search-presets-folders")},icon:'<i class="fa-solid fa-folder-magnifying-glass"></i>'}};class MassEditPresets extends FormApplication{static objectHover=!1;static lastSearch;constructor(e,t,s,a={}){if(!a.preventPositionOverride&&MassEditPresets.previousPosition&&(a={...a,...MassEditPresets.previousPosition}),super({},a),this.callback=t,this.dragType=null,this.dragData=null,this.draggedElements=null,!e&&d.TA.includes(s)){const e=game.settings.get(d.Do,"presetDocLock");this.documentName=e||s}else this.configApp=e,this.documentName=s||this.configApp.documentName}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-presets",classes:["sheet","mass-edit-dark-window","mass-edit-window-fill"],template:`modules/${d.Do}/templates/preset/presets.html`,resizable:!0,minimizable:!0,width:360,height:900,scrollY:[".item-list"]})}get title(){let e=(0,d.kg)("common.presets");return d.TA.includes(this.documentName)?e+=` [${(0,d.kg)("common.placeable")}]`:e+=` [${this.documentName}]`,e}async getData(e){const t=super.getData(e);await getTemplate(`modules/${d.Do}/templates/preset/preset.html`,"me-preset"),await getTemplate(`modules/${d.Do}/templates/preset/presetFolder.html`,"me-preset-folder"),await getTemplate(`modules/${d.Do}/templates/preset/presetsContent.html`,"me-presets-content");const s=game.settings.get(d.Do,"presetExtComp"),a=game.settings.get(d.Do,"presetVirtualDir");return this.tree=await u.A0.getTree(this.documentName,{externalCompendiums:s,virtualDirectory:a,setFormVisibility:!0}),this._tagSelector?.render(!0),t.presets=this.tree.presets,t.folders=this.tree.folders,t.extFolders=this.tree.extFolders.length?this.tree.extFolders:null,t.createEnabled=Boolean(this.configApp),t.isPlaceable=d.Me.includes(this.documentName)||"ALL"===this.documentName||"FAVORITES"===this.documentName,t.allowDocumentSwap=d.TA.includes(this.documentName)&&!this.configApp,t.docLockActive=game.settings.get(d.Do,"presetDocLock")===this.documentName,t.layerSwitchActive=game.settings.get(d.Do,"presetLayerSwitch"),t.scaling=game.settings.get(d.Do,"presetScaling"),t.extCompActive=s,t.virtDirActive=a,t.sortMode=p[game.settings.get(d.Do,"presetSortMode")],t.searchMode=f[game.settings.get(d.Do,"presetSearchMode")],t.displayDragDropMessage=t.allowDocumentSwap&&!(this.tree.presets.length||this.tree.folders.length||t.extFolders),t.canvas3dActive=Boolean(game.Levels3DPreview?._active),t.lastSearch=MassEditPresets.lastSearch,t.docs=d.TA.reduce(((e,t)=>({...e,[t]:m.aK[t]})),{}),t.documents=d.TA,t.currentDocument=this.documentName,t.callback=Boolean(this.callback),t}activateListeners(e){super.activateListeners(e);const t=e.closest(".window-content").find(".drag-drop-overlay");e.closest(".window-content").on("mouseover",(e=>{canvas.activeLayer?.preview?.children.some((e=>e._original?.mouseInteractionManager?.isDragging))?(t.show(),MassEditPresets.objectHover=!0):(t.hide(),MassEditPresets.objectHover=!1)})).on("mouseout",(()=>{t.hide(),MassEditPresets.objectHover=!1})),e.find(".create-preset").on("click",(()=>{const e=canvas.activeLayer.controlled;e.length&&d.Me.includes(e[0].document.documentName)&&this.dropPlaceable(e)}));const s=e.find(".item-list");e.on("click",".item",(e=>{v(e,s),this._activeBrush&&this._toggleBrush(e)})),e.on("mouseenter",".item",(e=>{$(e.currentTarget).find(".tags, .display-hover").addClass("show"),this._playPreview(e)})),e.on("mouseleave",".item",(e=>{$(e.currentTarget).find(".tags, .display-hover").removeClass("show"),this._endPreview(e)})),e.on("dragstart",".item",(e=>{this.dragType="item";const t=$(e.target).closest(".item");t.hasClass("selected")||(s.find(".item.selected").removeClass("selected").removeClass("last-selected"),t.addClass("selected").addClass("last-selected"));const a=[];s.find(".item.selected").each((function(){a.push($(this).data("uuid"))})),this.dragData=a,this.draggedElements=s.find(".item.selected")})),e.on("dragleave",".item.sortable",(e=>{$(e.target).closest(".item").removeClass("drag-bot").removeClass("drag-top")})),e.on("dragover",".item.sortable",(e=>{if("item"!==this.dragType)return;if(!this.draggedElements.hasClass("sortable"))return;const t=$(e.target).closest(".item");if(t.hasClass("selected"))return;var s=e.currentTarget.getBoundingClientRect();let a=e.offsetY/s.height;a<.2?t.removeClass("drag-bot").addClass("drag-top"):a>.8&&t.removeClass("drag-top").addClass("drag-bot")})),e.on("drop",".item.sortable",(e=>{if(MassEditPresets.lastSearch?.length)return;if("item"!==this.dragType)return;if(!this.draggedElements.hasClass("sortable"))return;const t=$(e.target).closest(".item"),a=t.hasClass("drag-top");t.removeClass("drag-bot").removeClass("drag-top");const i=this.dragData;i&&(t.hasClass("selected")||((a?i:i.reverse()).forEach((e=>{const i=s.find(`.item[data-uuid="${e}"]`);i&&(a?i.insertBefore(t):i.insertAfter(t))})),this._onItemSort(i,t.data("uuid"),{before:a,folderUuid:t.closest(".folder").data("uuid")}))),this.dragType=null,this.dragData=null,this.draggedElements=null})),e.on("dragend",".item",(e=>{(function(e){let t=$(e.target).closest(".window-app");var s=t.offset();let a=s.left,i=s.top,n=t.width(),o=t.height();var r=e.pageX,l=e.pageY;if(r>a&&r<a+n&&l>i&&l<i+o)return!0;return!1})(e)||this._onPresetDragOut(e)})),e.on("click",".folder > header",(e=>this._folderToggle($(e.target).closest(".folder")))),e.on("dragstart",".folder.sortable",(e=>{if("item"==this.dragType)return;this.dragType="folder";const t=[$(e.target).closest(".folder").data("uuid")];$(e.target).find(".folder").each((function(){t.push($(this).data("uuid"))})),this.dragData=t})),e.on("dragleave",".folder.sortable header",(e=>{$(e.target).closest(".folder").removeClass("drag-mid").removeClass("drag-top")})),e.on("dragover",".folder.sortable header",(e=>{const t=$(e.target).closest(".folder");if("folder"===this.dragType){if(this.dragData.includes(t.data("uuid")))return;var s=e.currentTarget.getBoundingClientRect();e.offsetY/s.height<.2?t.removeClass("drag-mid").addClass("drag-top"):t.removeClass("drag-top").addClass("drag-mid")}else"item"===this.dragType&&this.draggedElements.hasClass("sortable")&&t.addClass("drag-mid")})),e.on("drop",".folder.sortable header",(t=>{if(this._foundryDrop(t))return;if(MassEditPresets.lastSearch?.length)return;const a=$(t.target).closest(".folder");if("folder"===this.dragType){const t=a.hasClass("drag-top");a.removeClass("drag-mid").removeClass("drag-top");const s=this.dragData;if(s){if(s.includes(a.data("uuid")))return;const i=s[0],n=e.find(`.folder[data-uuid="${i}"]`);n&&(t?n.insertBefore(a):a.find(".folder-items").first().append(n),t?this._onFolderSort(i,a.data("uuid"),{inside:!1,folderUuid:a.parent().closest(".folder").data("uuid")??null}):this._onFolderSort(i,null,{inside:!0,folderUuid:a.data("uuid")}))}}else if("item"===this.dragType&&this.draggedElements.hasClass("sortable")){a.removeClass("drag-mid");const e=this.dragData,t=a.children(".preset-items");e?.forEach((e=>{const a=s.find(`.item[data-uuid="${e}"]`);a.length&&t.append(a)})),this._onItemSort(e,null,{folderUuid:a.data("uuid")})}this.dragType=null,this.dragData=null,this.draggedElements=null})),e.on("drop",".top-level-preset-items",(t=>{if(!this._foundryDrop(t)&&!MassEditPresets.lastSearch?.length){if("folder"===this.dragType){const t=e.find(".top-level-folder-items"),s=e.find(`.folder[data-uuid="${this.dragData[0]}"]`);t.append(s),this._onFolderSort(this.dragData[0],null)}else if("item"===this.dragType&&this.draggedElements.hasClass("sortable")){const t=this.dragData,a=e.find(".top-level-preset-items");t?.forEach((e=>{const t=s.find(`.item[data-uuid="${e}"]`);t.length&&a.append(t)})),this._onItemSort(t,null)}this.dragType=null,this.dragData=null,this.draggedElements=null}})),e.on("click",".toggle-sort",this._onToggleSort.bind(this)),e.on("click",".toggle-doc-lock",this._onToggleLock.bind(this)),e.on("click",".toggle-ext-comp",this._onToggleExtComp.bind(this)),e.on("click",".toggle-virtual-dir",this._onToggleVirtDir.bind(this)),e.on("click",".toggle-scaling",this._onToggleScaling.bind(this)),e.on("click",".toggle-layer-switch",this._onToggleLayerSwitch.bind(this)),e.on("click",".document-select",this._onDocumentChange.bind(this)),e.on("dblclick",".item",this._onDoubleClickPreset.bind(this)),e.on("click",".create-folder",this._onCreateFolder.bind(this)),e.on("click",".preset-create",this._onPresetCreate.bind(this)),e.on("click",".preset-update a",this._onPresetUpdate.bind(this)),e.on("click",".preset-favorite",this._onToggleFavorite.bind(this)),e.on("click",".preset-callback",this._onApplyPreset.bind(this)),e.on("click",".tagSelector",this._onToggleTagSelector.bind(this));const a=e.find(".header-search input");a.on("input",(e=>this._onSearchInput(e))),(MassEditPresets.lastSearch?.length??0)>=2&&a.trigger("input"),e.on("click",".toggle-search-mode",(e=>{this._onToggleSearch(e,a)})),this._contextMenu(e.find(".item-list"))}async _playPreview(e){clearTimeout(this._previewTimeout),this._previewTimeout=setTimeout((()=>this._renderPlayPreview(e)),200)}async _renderPlayPreview(e){await this._endPreview();const t=$(e.currentTarget).data("uuid");if(!t)return;const s=await u.A0.get(t,{full:!1});if("AmbientSound"===s.documentName){const e=(0,d.JK)(s.img)?s.img:(await s.load()).data[0]?.path;if(!e)return;(await game.audio.play(e))._mePreview=!0}else if("Tile"===s.documentName&&"icons/svg/video.svg"===s.thumbnail){await s.load();const e=s.data[0].texture?.src;if(e&&(0,g.cZ)(e)){this._videoPreviewElement?this._videoPreviewElement.empty():(this._videoPreviewElement=$('<div class="meVideoPreview"></div>'),$(document.body).append(this._videoPreviewElement));const t=visualViewport.width/1024;this._videoPreviewElement.append(`<video width="${320*t}" height="${240*t}" autoplay loop><source src="${e}" type="video/${e.split(".").pop().toLowerCase()}"></video>`)}}}async _endPreview(){clearTimeout(this._previewTimeout),game.audio.playing.forEach((e=>{e._mePreview&&e.stop()})),this._videoPreviewElement&&(this._videoPreviewElement.remove(),this._videoPreviewElement=null)}_folderToggle(e){const t=e.data("uuid"),s=this.tree.allFolders.get(t);s.expanded?this._folderCollapse(e,s):this._folderExpand(e,s)}async _folderExpand(e,t){if(g.cm.setExpanded(t.uuid,!0),t.expanded=!0,e.find(".folder-items").length)e.removeClass("collapsed"),e.find("header .folder-icon").first().removeClass("fa-folder-closed").addClass("fa-folder-open");else{let s=await renderTemplate(`modules/${d.Do}/templates/preset/presetFolder.html`,{folder:t,createEnabled:Boolean(this.configApp),callback:Boolean(this.callback),sortable:fromUuidSync(t.uuid)?.pack===u.A0.workingPack});e.replaceWith(s)}}_folderCollapse(e,t){e.addClass("collapsed"),e.find("header .folder-icon").first().removeClass("fa-folder-open").addClass("fa-folder-closed"),g.cm.setExpanded(t.uuid,!1),t.expanded=!1}_foundryDrop(e){const t=TextEditor.getDragEventData(e.originalEvent);if(!isEmpty(t)){if("Folder"===t.type){const e=fromUuidSync(t.uuid);return"Actor"===e.type&&(!this._importTracker?.active&&(o({title:"Converting Actors",total:r(e)}).then((async t=>{this._importTracker=t,await this._importActorFolder(e,null,{keepId:!0}),this._importTracker?.stop()})),!0))}return"Actor"===t.type&&(u.af.createPresetFromActorUuid(t.uuid,{keepId:!0}).then((e=>{e&&this.render(!0)})),!0)}return!1}async _importActorFolder(e,t=null,s={}){let a=new Folder.implementation({_id:s.keepId?e.id:null,name:e.name,type:"JournalEntry",sorting:e.sorting,folder:t,color:e.color??"#000000",flags:{[d.Do]:{types:["ALL","Token"]}}},{pack:u.A0.workingPack});a=await Folder.create(a,{pack:a.pack,keepId:s.keepId});for(const t of e.children){if(!this._importTracker?.active)break;await this._importActorFolder(t.folder,a.id,s)}for(const t of e.contents){if(!this._importTracker?.active)break;await u.af.createPresetFromActorUuid(t.uuid,{folder:a.id,keepId:s.keepId}),this._importTracker.incrementCount()}this.render(!0)}async _onDoubleClickPreset(e){if(l._8.close(),game.Levels3DPreview?._active)return;const t=$(e.target).closest(".item").data("uuid");if(!t)return;let s=await u.af.getPreset({uuid:t});s&&("Scene"===s.documentName&&(ui.notifications.info(`Mass Edit: ${(0,d.kg)("common.apply")} [${s.name}]`),(0,d.XK)(s)),d.Me.includes(s.documentName)&&(ui.notifications.info(`Mass Edit: ${(0,d.kg)("presets.spawning")} [${s.name}]`),this._setInteractivityState(!1),await u.af.spawnPreset({preset:s,coordPicker:!0,taPreview:"ALL",layerSwitch:game.settings.get(d.Do,"presetLayerSwitch"),scaleToGrid:game.settings.get(d.Do,"presetScaling"),center:!0}),this._setInteractivityState(!0)))}_setInteractivityState(e){e?this.element.removeClass("inactive"):this.element.addClass("inactive")}_contextMenu(e){ContextMenu.create(this,e,".item",this._getItemContextOptions(),{hookName:"MassEditPresetContext",onOpen:this._onRightClickPreset.bind(this)}),ContextMenu.create(this,e,".folder header",this._getFolderContextOptions(),{hookName:"MassEditFolderContext"})}_getItemContextOptions(){return[{name:(0,d.kg)("CONTROLS.CommonEdit",!1),icon:'<i class="fas fa-edit"></i>',condition:e=>m.k.isEditable(e.data("uuid")),callback:e=>this._onEditSelectedPresets(e)},{name:"Brush",icon:'<i class="fa-solid fa-paintbrush"></i>',condition:e=>d.Me.includes(e.data("doc-name")),callback:e=>this._onActivateBrush(e)},{name:(0,d.kg)("presets.open-journal"),icon:'<i class="fas fa-book-open"></i>',condition:e=>!e.hasClass("virtual"),callback:e=>this._onOpenJournal(e)},{name:(0,d.kg)("presets.apply-to-selected"),icon:'<i class="fas fa-arrow-circle-right"></i>',condition:e=>d.Me.includes(e.data("doc-name"))&&canvas.getLayerByEmbeddedName(e.data("doc-name")).controlled.length,callback:e=>this._onApplyToSelected(e)},{name:(0,d.kg)("Duplicate",!1),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>m.k.isEditable(e.data("uuid"))&&!e.hasClass("virtual"),callback:e=>this._onCopySelectedPresets(null,{keepFolder:!0,keepId:!1})},{name:(0,d.kg)("presets.copy-source-to-clipboard"),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>e.data("uuid").startsWith("virtual@"),callback:e=>game.clipboard.copyPlainText(e.data("uuid").substring(8))},{name:(0,d.kg)("presets.copy-to-clipboard"),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>1===$(this.form).find(".item-list").find(".item.selected").length,callback:e=>this._onCopyPresetToClipboard()},{name:(0,d.kg)("presets.export-as-json"),icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportSelectedPresets()},{name:(0,d.kg)("presets.export-to-compendium"),icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportSelectedPresetsToComp()},{name:(0,d.kg)("CONTROLS.CommonDelete",!1),icon:'<i class="fas fa-trash fa-fw"></i>',condition:e=>m.k.isEditable(e.data("uuid"))&&!e.hasClass("virtual"),callback:e=>this._onDeleteSelectedPresets(e)}]}_getFolderContextOptions(){return[{name:"Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>{const t=this.tree.allFolders.get(e.closest(".folder").data("uuid"));return!t.virtual||t instanceof u.dH},callback:e=>this._onFolderEdit(e)},{name:"Save Index",icon:'<i class="fas fa-file-search"></i>',condition:e=>this.tree.allFolders.get(e.closest(".folder").data("uuid")).indexable,callback:e=>{h.WX.saveFolderToCache(this.tree.allFolders.get(e.closest(".folder").data("uuid")))}},{name:"Export to Compendium",icon:'<i class="fas fa-file-export fa-fw"></i>',condition:e=>!(this.tree.allFolders.get(e.closest(".folder").data("uuid"))instanceof u.y1),callback:e=>{this._onExportFolder(e.closest(".folder").data("uuid"))}},{name:(0,d.kg)("FOLDER.Remove",!1),icon:'<i class="fas fa-trash fa-fw"></i>',condition:e=>u._P.isEditable(e.closest(".folder").data("uuid")),callback:e=>this._onFolderDelete(e.closest(".folder").data("uuid"))},{name:(0,d.kg)("FOLDER.Delete",!1),icon:'<i class="fas fa-dumpster"></i>',condition:e=>u._P.isEditable(e.closest(".folder").data("uuid")),callback:e=>this._onFolderDelete(e.closest(".folder").data("uuid"),{deleteAll:!0})},{name:"Randomize Child Folder Colors",icon:'<i class="fas fa-dice"></i>',condition:()=>CONFIG.debug.MassEdit,callback:e=>(0,g.Li)(e.closest(".folder").data("uuid"),this.tree,(()=>this.render(!0)))}]}async _onExportFolder(e){let{pack:t,keepId:s}=await new Promise((e=>b(e,{exportTo:!0,keepIdSelect:!0})));if(t&&!this._importTracker?.active){this.tree.allFolders.get(e)&&(this._importTracker=await o({title:"Exporting Folder",total:r(this.tree.allFolders.get(e))}),await this._onCopyFolder(e,null,t,!0,s),this._importTracker?.stop())}}async _onCopyFolder(e,t=null,s,a=!0,i=!0){s||(s=u.A0.workingPack);const n=this.tree.allFolders.get(e),o=await fromUuid(e);if(n){let e;e=o?o.flags[d.Do]?.types??["ALL"]:["ALL"];const r={_id:i?n.id:null,name:n.name,color:n.color,sorting:n.sorting,folder:t,flags:{[d.Do]:{types:e}},type:"JournalEntry"},l=await Folder.create(r,{pack:s,keepId:i});for(const e of n.presets){if(!this._importTracker?.active)break;const t=(await e.load()).clone();t.folder=l.id,i||(t.id=foundry.utils.randomID()),await u.A0.set(t,s),this._importTracker?.incrementCount()}for(const e of n.children){if(!this._importTracker?.active)break;await this._onCopyFolder(e.uuid,l.id,s,!1,i)}a&&this.render(!0)}}async _onExportSelectedPresetsToComp(){let{pack:e,keepId:t}=await new Promise((e=>b(e,{exportTo:!0,keepIdSelect:!0})));e&&this._onCopySelectedPresets(e,{keepId:t})}async _onCopySelectedPresets(e,{keepFolder:t=!1,keepId:s=!0}={}){const[a,i]=await this._getSelectedPresets();for(const i of a){const a=i.clone();t||(a.folder=null),s||(a.id=foundry.utils.randomID()),await u.A0.set(a,e)}a.length&&this.render(!0)}async _onCopyPresetToClipboard(){const[e,t]=await this._getSelectedPresets();e.length&&(0,i.lW)(e[0])}async _getSelectedPresets({editableOnly:e=!1,virtualOnly:t=!1,full:s=!0}={}){const a=[];let i=".item.selected";t&&(i+=".virtual");let n=this.element.find(".item-list").find(i);e&&(n=n.filter((function(){return m.k.isEditable($(this).data("uuid"))}))),n.each((function(){const e=$(this).data("uuid");a.push(e)}));const o=[];for(const e of a){const t=await u.A0.get(e,{full:s});t&&o.push(t)}return[o,n]}async _onExportSelectedPresets(){const[e,t]=await this._getSelectedPresets();y(e)}async _onEditSelectedPresets(e){const[t,s]=await this._getSelectedPresets({virtualOnly:e.hasClass("virtual"),editableOnly:!0});if(t.length){const s=e.offset();s.top+=e.height(),this._editPresets(t,s)}}async _onDeleteSelectedPresets(e){const[t,s]=await this._getSelectedPresets({editableOnly:!0,full:!1});if(t.length){(0===t.length||await Dialog.confirm({title:`${(0,d.kg)("common.delete")} [ ${t.length} ]`,content:`<p>${(0,d.kg)("AreYouSure",!1)}</p><p>${(0,d.zS)("presets.delete-presets-warn",{count:t.length})}</p>`}))&&(await u.A0.delete(t),s.remove())}}async _onOpenJournal(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});t.forEach((e=>e.openJournal()))}async _onApplyToSelected(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});if(!t.length)return;const a=new Set;for(const e of t)if(a.add(e.documentName),a.size>1)return void ui.notifications.warn((0,d.kg)("presets.apply-to-selected-warn"));const n=canvas.getLayerByEmbeddedName(t[0].documentName).controlled;if(n.length)for(const e of t)(0,i.B0)(n,e,!1,!0)}async _onCreateFolder(e){const t=[];"ALL"===this.documentName?t.push("ALL"):d.TA.includes(this.documentName)?t.push("ALL",this.documentName):t.push(this.documentName);const s=new Folder.implementation({name:Folder.defaultName(),type:"JournalEntry",sorting:"m",flags:{[d.Do]:{types:t}}},{pack:u.A0.workingPack});await new Promise((e=>{new PresetFolderConfig(s,{resolve:e}).render(!0)})),this.render(!0)}async _onFolderEdit(e){const t=$(e).closest(".folder").data("uuid"),s=this.tree.allFolders.get(t);let a;a=s instanceof u.dH?new Folder.implementation({_id:s.id,name:s.name,type:"JournalEntry",color:s.color,sorting:s.sorting},{pack:s.uuid}):await fromUuid($(e).closest(".folder").data("uuid")),new Promise((t=>{const i={resolve:t,...e.offset(),folder:s};i.top+=e.height(),new PresetFolderConfig(a,i).render(!0)})).then((()=>this.render(!0)))}async _onFolderDelete(e,{render:t=!0,deleteAll:s=!1}={}){const a=this.tree.allFolders.get(e);if(a){let i;i=s?await Dialog.confirm({title:`${(0,d.kg)("FOLDER.Delete",!1)}: ${a.name}`,content:`<div style="color:red;"><h4>${(0,d.kg)("AreYouSure",!1)}</h4><p>${(0,d.kg)("FOLDER.DeleteWarning",!1)}</p></div>`}):await Dialog.confirm({title:`${(0,d.kg)("FOLDER.Remove",!1)}: ${a.name}`,content:`<h4>${(0,d.kg)("AreYouSure",!1)}</h4><p>${(0,d.kg)("FOLDER.RemoveWarning",!1)}</p>`}),i&&(await u.A0.deleteFolder(e,s),t&&this.render(!0))}}_onSearchInput(e){clearTimeout(this._searchTimer),this._searchTimer=setTimeout((()=>this._onSearch(e)),250)}async _onSearch(e){let t=e.target.value,s=MassEditPresets.lastSearch||"";if(MassEditPresets.lastSearch=t,s.length>=2&&t.length<2)return $(e.target).removeClass("active"),this._resetSearchState(),void this._renderContent();if(t.length<2)return;let a=e.target.value.trim().toLowerCase().split(" ").filter((e=>e.length>=2));if(!a.length)return;$(e.target).addClass("active");const i=a.filter((e=>e.startsWith("#"))).map((e=>e.substring(1)));a=a.filter((e=>!e.startsWith("#"))),this._searchFoundPresets=[],this.tree.folders.forEach((e=>this._searchFolder(a,i,e))),this.tree.extFolders.forEach((e=>this._searchFolder(a,i,e))),this.tree.presets.forEach((e=>this._searchPreset(a,i,e))),this._renderContent()}_searchFolder(e,t,s,a=!1){const i=s.name.toLowerCase();let n=!t.length&&e.every((e=>i.includes(e))),o=!1;for(const i of s.children)this._searchFolder(e,t,i,n||a)&&(o=!0);let r=!1;for(const i of s.presets)this._searchPreset(e,t,i,n||a)&&(r=!0);const l=n||o||r;return s.expanded=o||r,s.render=l||a,l}_searchPreset(e,t,s,a=!1){if(!s._visible)return!1;const i=s.name.toLowerCase();return this._searchFoundPresets.length<1001&&e.every((e=>i.includes(e)||s.tags.includes(e)))&&t.every((e=>s.tags.includes(e)))?(s._render=!0,this._searchFoundPresets.push(s),s._render):(s._render=a,!1)}_resetSearchState(){this._searchFoundPresets=[],this.tree.folders.forEach((e=>this._resetSearchStateFolder(e))),this.tree.extFolders.forEach((e=>this._resetSearchStateFolder(e))),this.tree.presets.forEach((e=>this._resetSearchStatePreset(e)))}_resetSearchStateFolder(e){e.expanded=g.cm.expanded(e.uuid),e.render=!0,e.children.forEach((e=>this._resetSearchStateFolder(e))),e.presets.forEach((e=>this._resetSearchStatePreset(e)))}_resetSearchStatePreset(e){e._render=!0}async _renderContent(){let e;e="p"===game.settings.get(d.Do,"presetSearchMode")?{callback:Boolean(this.callback),presets:this._searchFoundPresets,folders:[],createEnabled:Boolean(this.configApp),extFolders:null}:{callback:Boolean(this.callback),presets:this.tree.presets,folders:this.tree.folders,createEnabled:Boolean(this.configApp),extFolders:this.tree.extFolders.length?this.tree.extFolders:null};const t=await renderTemplate(`modules/${d.Do}/templates/preset/presetsContent.html`,e);this.element.find(".item-list").html(t),this._tagSelector?.render(!0)}async _onFolderSort(e,t,{inside:s=!0,folderUuid:a=null}={}){let i,n=this.tree.allFolders.get(e),o=this.tree.allFolders.get(t);i=a?this.tree.allFolders.get(a).children:this.tree.folders;const r=[];for(const t of i)t.uuid!==e&&r.push(t);const l=SortingHelpersFixed.performIntegerSort(n,{target:o,siblings:r,sortBefore:!0});if(l.length){const e=[];l.forEach((t=>{const s=t.update;s._id=t.target.id,s.folder=this.tree.allFolders.get(a)?.id??null,e.push(s),t.target.sort=s.sort})),await Folder.updateDocuments(e,{pack:u.A0.workingPack})}this.render(!0)}async _onItemSort(e,t,{before:s=!0,folderUuid:a=null}={}){const i=new Set(e),n=this.tree.allPresets.filter((e=>i.has(e.uuid)));let o,r=this.tree.allPresets.find((e=>e.uuid===t));o=a?this.tree.allFolders.get(a).presets:this.tree.presets;const l=[];for(const e of o)i.has(e.uuid)||l.push(e);const c=SortingHelpersFixed.performIntegerSortMulti(n,{target:r,siblings:l,sortBefore:s});if(c.length){const e=[];c.forEach((t=>{const s=t.update;s._id=t.target.id,s.folder=this.tree.allFolders.get(a)?.id??null,e.push(s);const i=o.find((e=>e.id===s._id));i&&(i.folder=s.folder,i.sort=s.sort),t.target.sort=s.sort})),await u.A0.updatePresets(e)}this.render(!0)}async _onToggleSort(e){const t="manual"===game.settings.get(d.Do,"presetSortMode")?"alphabetical":"manual";await game.settings.set(d.Do,"presetSortMode",t),this.render(!0)}async _onToggleSearch(e,t){const s=$(e.target).closest(".toggle-search-mode"),a="p"===game.settings.get(d.Do,"presetSearchMode")?"pf":"p";await game.settings.set(d.Do,"presetSearchMode",a);const i=f[a];s.attr("data-tooltip",i.tooltip).html(i.icon),MassEditPresets.lastSearch&&t.trigger("input")}_onToggleLock(e){const t=$(e.target).closest(".toggle-doc-lock");let s=game.settings.get(d.Do,"presetDocLock"),a=this.documentName;a!==s?t.addClass("active"):(t.removeClass("active"),a=""),game.settings.set(d.Do,"presetDocLock",a)}_onToggleLayerSwitch(e){const t=$(e.currentTarget),s=!game.settings.get(d.Do,"presetLayerSwitch");s?t.addClass("active"):t.removeClass("active"),game.settings.set(d.Do,"presetLayerSwitch",s)}async _onToggleVirtDir(e){const t=$(e.currentTarget),s=!game.settings.get(d.Do,"presetVirtualDir");s?t.addClass("active"):t.removeClass("active"),await game.settings.set(d.Do,"presetVirtualDir",s),this.render(!0)}async _onToggleExtComp(e){const t=$(e.currentTarget),s=!game.settings.get(d.Do,"presetExtComp");s?t.addClass("active"):t.removeClass("active"),await game.settings.set(d.Do,"presetExtComp",s),this.render(!0)}async _onToggleScaling(e){const t=$(e.target).closest(".toggle-scaling"),s=!game.settings.get(d.Do,"presetScaling");s?t.addClass("active"):t.removeClass("active"),game.settings.set(d.Do,"presetScaling",s)}_onDocumentChange(e){const t=$(e.target).closest(".document-select").data("name");t!=this.documentName&&(this.documentName=t,game.settings.get(d.Do,"presetLayerSwitch")&&canvas.getLayerByEmbeddedName("Actor"===this.documentName?"Token":this.documentName)?.activate(),MassEditPresets.lastSearch&&(MassEditPresets.lastSearch="",this._resetSearchState()),this.render(!0))}async _onRightClickPreset(e){const t=$(e).closest(".item");t.hasClass("selected")||(t.closest(".item-list").find(".item.selected").removeClass("selected").removeClass("last-selected"),t.addClass("selected").addClass("last-selected"))}_editPresets(e,t={},s){t.callback=()=>this.render(!0),!("left"in t)&&s&&(t.left=s.originalEvent.x-PresetConfig.defaultOptions.width/2,t.top=s.originalEvent.y),new PresetConfig(e,t).render(!0)}async _onApplyPreset(e){if(this.callback){const t=$(e.target).closest(".item").data("uuid");this.callback(await u.A0.get(t))}}async _onToggleTagSelector(e){this._tagSelector?(this._tagSelector.close(!0),this._tagSelector=null):(this._tagSelector=new TagSelector(this),this._tagSelector.render(!0))}async _onPresetDragOut(e){const t=$(e.originalEvent.target).closest(".item").data("uuid"),s=await u.A0.get(t);if(!s)return;const a=function(e,t,s){const a=function(s){const a=s.position,i=a.left,n=a.top,o=Number.isNumeric(a.height)?a.height:$(s.element).height(),r=Number.isNumeric(a.width)?a.width:$(s.element).width();return e>i&&e<i+r&&t>n&&t<n+o};return Object.values(ui.windows).find((e=>e.meForm&&e.documentName===s&&a(e)))}(e.pageX,e.pageY,s.documentName);if(a)return void a._applyPreset(s);if("Scene"===s.documentName)return void(0,d.XK)(s);if(!d.Me.includes(s.documentName))return;let i,n,o;if(game.Levels3DPreview?._active){game.Levels3DPreview.interactionManager._onMouseMove(e,!0);const{x:t,y:s,z:a}=game.Levels3DPreview.interactionManager.canvas2dMousePosition;i=t,n=s,o=a}else{const[t,a]=[e.clientX,e.clientY],o=canvas.stage.worldTransform;i=(t-o.tx)/canvas.stage.scale.x,n=(a-o.ty)/canvas.stage.scale.y,"Token"!==s.documentName&&"Tile"!==s.documentName||(i-=canvas.dimensions.size/2,n-=canvas.dimensions.size/2)}u.af.spawnPreset({preset:s,x:i,y:n,z:o,mousePosition:!1,layerSwitch:game.settings.get(d.Do,"presetLayerSwitch"),scaleToGrid:game.settings.get(d.Do,"presetScaling")})}async _onToggleFavorite(e){const t=$(e.target).closest(".item"),s=t.data("uuid"),a=t.find(".preset-favorite i");if(s){const e=game.settings.get(d.Do,"presetFavorites");a.hasClass("fa-regular")?(a.removeClass("fa-regular").addClass("fa-solid"),e[s]=!0):(a.removeClass("fa-solid").addClass("fa-regular"),delete e[s]),game.settings.set(d.Do,"presetFavorites",e),m.k.favorites=e}}async _onActivateBrush(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});l._8.addPresets(t)}setPosition({left:e,top:t,width:s,height:a,scale:i}={}){if(!this.popOut&&!this.options.resizable)return;const n=this.element[0],o=this.position,r=this.popOut,l=window.getComputedStyle(n);if(null===i&&(i=1),i=i??o.scale??1,"auto"!==a&&"auto"!==this.options.height||(n.style.height="",a=null),!n.style.width||s){const t=s||n.offsetWidth,a=parseInt(l.minWidth)||(r?MIN_WINDOW_WIDTH:0),c=n.style.maxWidth||window.innerWidth/i;o.width=s=Math.clamp?Math.clamp(t,a,c):Math.clamped(t,a,c),n.style.width=`${s}px`,s*i+o.left>window.innerWidth&&(e=o.left)}if(s=n.offsetWidth,!n.style.height||a){const e=a||n.offsetHeight+1,s=parseInt(l.minHeight)||(r?MIN_WINDOW_HEIGHT:0),c=n.style.maxHeight||window.innerHeight/i;o.height=a=Math.clamp?Math.clamp(e,s,c):Math.clamped(e,s,c),n.style.height=`${a}px`,a*i+o.top>window.innerHeight+1&&(t=o.top-1)}let c,d;if(a=n.offsetHeight,r&&!this.posSet||Number.isFinite(e)){const t=s*i,a=Number.isFinite(e)?e:(window.innerWidth-t)/2,n=Math.max(window.innerWidth-t,0);o.left=e=Math.clamp?Math.clamp(a,0,n):Math.clamped(a,0,n),c=e}if(r&&!this.posSet||Number.isFinite(t)){const e=a*i,s=Number.isFinite(t)?t:(window.innerHeight-e)/2,n=Math.max(window.innerHeight-e,0);o.top=Math.clamp?Math.clamp(s,0,n):Math.clamped(s,0,n),d=o.top}let u="";if(i&&(o.scale=Math.max(i,0),u+=1===i?"":`scale(${i})`),(c||d)&&(this.posSet=!0,u+="translate("+c+"px,"+d+"px)"),u&&(n.style.transform=u),!this.options.preventPositionOverride){const{left:e,top:t,width:s,height:a}=this.position;MassEditPresets.previousPosition={left:e,top:t,width:s,height:a}}return o}async close(e={}){return MassEditPresets.objectHover=!1,this._tagSelector?.close(),this._endPreview(),super.close(e)}async _onPresetUpdate(e){const t=await u.A0.get($(e.target).closest(".item").data("uuid"));if(!t)return;const s=this.configApp instanceof ActiveEffectConfig?this._getActiveEffectFields():this.configApp.getSelectedFields();if(!s||foundry.utils.isEmpty(s))return void ui.notifications.warn((0,d.kg)("presets.warn-no-fields"));const i=foundry.utils.deepClone(this.configApp.randomizeFields||{}),n=foundry.utils.deepClone(this.configApp.addSubtractFields||{});"Token"===this.documentName&&a.f.correctDetectionModeOrder(s,i),t.update({data:s,randomize:i,addSubtract:n}),ui.notifications.info(`Preset "${t.name}" updated`)}async _onPresetCreate(e){const t=this.configApp instanceof ActiveEffectConfig?this._getActiveEffectFields():this.configApp.getSelectedFields();if(!t||foundry.utils.isEmpty(t))return void ui.notifications.warn((0,d.kg)("presets.warn-no-fields"));const s=new m.k({name:(0,d.kg)("presets.default-name"),documentName:this.documentName,data:t,addSubtract:this.configApp.addSubtractFields,randomize:this.configApp.randomizeFields});await u.A0.set(s),this.render(!0),this._editPresets([s],{isCreate:!0},e)}async dropPlaceable(e,t){const s=await u.af.createPreset(e),a=e[0].document.documentName;"ALL"!==this.documentName&&this.documentName!==a&&(this.documentName=a);const i={isCreate:!0};i.left=this.position.left+this.position.width+20,i.top=this.position.top,this._editPresets(s,i,t),this.render(!0)}async actorToPreset(e){await u.af.createPreset(placeables)}_getActiveEffectFields(){return{changes:foundry.utils.deepClone(this.configApp.object.changes??[])}}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-change-compendium",icon:"fa-solid fa-gear",onclick:e=>this._onWorkingPackChange()}),e.unshift({label:"",class:"mass-edit-indexer",icon:"fas fa-archive",onclick:e=>this._onOpenIndexer()}),e.unshift({label:"",class:"mass-edit-export",icon:"fas fa-file-export",onclick:e=>this._onExport(e)}),e.unshift({label:"",class:"mass-edit-import",icon:"fas fa-file-import",onclick:e=>this._onImport(e)}),CONFIG.debug.MassEdit&&e.unshift({label:"Debug",class:"mass-edit-debug",icon:"fas fa-bug",onclick:e=>{console.log({index:game.packs.get(u.A0.workingPack).get(u.Xd)?.flags[d.Do]?.index,tree:this.tree})}}),e}async _onWorkingPackChange(){let e=await new Promise((e=>b(e,{})));e&&e!==u.A0.workingPack&&(await game.settings.set(d.Do,"workingPack",e),this.render(!0))}async _onOpenIndexer(){h.WX._buildingIndex?ui.notifications.warn("Index Build In-Progress. Wait for it to finish before attempting it again."):(new h.ME).render(!0)}async _onExport(){y((await u.A0.getTree()).allPresets)}async _onImport(){const e=await(0,c.h)();if(!e)return;let t=0;if("Array"===foundry.utils.getType(e))for(const s of e){if(!("documentName"in s))continue;if(!("data"in s)||foundry.utils.isEmpty(s.data))continue;const e=new m.k(s);e._pages=s.pages,await u.A0.set(e),t++}ui.notifications.info(`Mass Edit: ${(0,d.zS)("presets.imported",{count:t})}`),t&&this.render(!0)}async _updateObject(e,t){this.callback&&this.callback(await u.A0.get(e.submitter.data.id))}}async function y(e,t){if(e.length){for(const t of e)await t.load();e=e.map((e=>{const t=e.clone();return t.folder=null,t.uuid=null,t})),saveDataToFile(JSON.stringify(e,null,2),"text/json",(t??"mass-edit-presets")+".json")}}class PresetConfig extends FormApplication{static name="PresetConfig";constructor(e,t={}){super({},t),this.presets=e,this.callback=t.callback,this.isCreate=t.isCreate}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","mass-edit-dark-window"],template:`modules/${d.Do}/templates/preset/presetEdit.html`,width:360})}get id(){return"mass-edit-preset-edit"}get title(){const e=this.presets[0]instanceof m.JG?"File":"Preset";return this.presets.length>1?`${e}s [${this.presets.length}]`:`${e}: ${this.presets[0].name.substring(0,20)}${this.presets[0].name.length>20?"...":""}`}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-export",icon:"fas fa-file-export",onclick:e=>this._onExport(e)}),e}_onExport(){let e;1===this.presets.length&&(e="mass-edit-preset-"+this.presets[0].name.replace(" ","_").replace(/\W/g,"")),y(this.presets,e)}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t={};t.advancedOpen=this.advancedOpen,t.virtual=this.presets[0]instanceof m.JG,t.preset={},1===this.presets.length?(t.preset=foundry.utils.deepClone(this.presets[0].toJSON()),t.displayFieldDelete=!0,t.displayFieldModify=!0,t.attached=this.attached||t.preset.attached,t.attached&&(t.attached=t.attached.map((e=>{let t=e.documentName;return"Token"===e.documentName&&e.data.name&&(t+=": "+e.data.name),{icon:m.aK[e.documentName]??m.aK.DEFAULT,tooltip:t}})))):(t.multiEdit=!0,t.preset={}),this._submitData&&foundry.utils.mergeObject(t.preset,this._submitData),t.minlength=this.presets.length>1?0:1,t.tva=game.modules.get("token-variants")?.active,(this.data&&!(this.data instanceof Array)||!this.data&&this.presets[0].isEmpty)&&(t.modifyDisabled=!0,t.deleteDisabled=!0);const s=this.presets[0].documentName;return"Actor"!==s&&this.presets.every((e=>e.documentName===s))&&(t.documentEdit=s,t.isPlaceable=d.Me.includes(s)),t}activateListeners(e){super.activateListeners(e),e.find('[name="name"]').select(),e.find(".edit-document").on("click",this._onEditDocument.bind(this)),e.find(".assign-document").on("click",this._onAssignDocument.bind(this)),e.find(".delete-fields").on("click",this._onDeleteFields.bind(this)),e.find(".spawn-fields").on("click",this._onSpawnFields.bind(this)),e.find("summary").on("click",(()=>setTimeout((()=>this.setPosition({height:"auto"})),30))),e.find(".attached").on("click",this.onAttachedRemove.bind(this)),e.find(".attach-selected").on("click",(()=>{const e=canvas.activeLayer.controlled;e.length&&d.Me.includes(e[0].document.documentName)&&this.dropPlaceable(e)}));const t=e.find(".token-variants-image-select-button");t.on("click",(e=>{game.modules.get("token-variants").api.showArtSelect("Preset",{callback:(e,s)=>{t.siblings(`[name="${t.data("target")}"]`).val(e)},searchType:"Item"})})),e.find("details").on("toggle",(e=>{this.advancedOpen=Boolean($(e.target).attr("open"))}));const s=e.closest(".window-content").find(".drag-drop-overlay");e.closest(".window-content").on("mouseover",(e=>{1===this.presets.length&&(canvas.activeLayer?.preview?.children.some((e=>e._original?.mouseInteractionManager?.isDragging))?(s.show(),PresetConfig.objectHover=!0):(s.hide(),PresetConfig.objectHover=!1))})).on("mouseout",(()=>{1===this.presets.length&&(s.hide(),PresetConfig.objectHover=!1)})),d.Fo.activateListeners(e,{change:()=>this.setPosition({height:"auto"})})}_getSubmitData(e={}){const t=super._getSubmitData(e);return t.name=t.name?.trim(),t.img=t.img?.trim()||null,t.preSpawnScript=t.preSpawnScript?.trim(),t.postSpawnScript=t.postSpawnScript?.trim(),t.tags=t.tags?t.tags.split(","):[],t.addTags=t.addTags?t.addTags.split(","):[],t.removeTags=t.removeTags?t.removeTags.split(","):[],t}async render(e=!1){return this.form&&(this._submitData=this._getSubmitData()),await super.render(e)}async dropPlaceable(e,t){this.advancedOpen=!0,this.attached||(this.attached=foundry.utils.deepClone(this.presets[0].attached??[])),e.forEach((e=>this.attached.push({documentName:e.document.documentName,data:(0,g.h)(e)}))),await this.render(!0),setTimeout((()=>this.setPosition({height:"auto"})),30)}async onAttachedRemove(e){const t=$(e.target).closest(".attached").data("index");this.attached=this.attached||foundry.utils.deepClone(this.presets[0].attached),this.attached.splice(t,1),await this.render(!0),setTimeout((()=>this.setPosition({height:"auto"})),30)}async _onSpawnFields(){new PresetFieldModify(this.data??this.presets[0].data,(e=>{this.modifyOnSpawn=e}),this.modifyOnSpawn??this.presets[0].modifyOnSpawn).render(!0)}async _onDeleteFields(){new PresetFieldDelete(this.data??this.presets[0].data,(e=>{this.data=e})).render(!0)}async _onAssignDocument(){const e=canvas.getLayerByEmbeddedName(this.presets[0].documentName);if(!e)return;const t=e.controlled.map((e=>(0,g.h)(e)));t.length&&(this.data=t,ui.notifications.info((0,d.zS)("presets.assign",{count:t.length,document:this.presets[0].documentName})),this.gridSize=canvas.grid.size,this.modifyOnSpawn=[],this.render(!0))}async _onEditDocument(){const e=[],t=CONFIG[this.presets[0].documentName].documentClass;for(const s of this.presets)s.data.forEach((a=>{const i=new t((0,g.Go)(s,a),{parent:canvas.scene});e.push(i)}));const s=await(0,n.gx)(e,null,{presetEdit:!0,callback:e=>{this.addSubtract={},this.randomize={};for(const t of Object.keys(e.data))t in e.randomize&&(this.randomize[t]=e.randomize[t]),t in e.addSubtract&&(this.addSubtract[t]=e.addSubtract[t]);this.data=e.data,this.render(!0)},forceForm:!0}),a=new m.k({data:{},randomize:this.presets[0].randomize,addSubtract:this.presets[0].addSubtract});setTimeout((()=>{s._applyPreset(a)}),400)}async _updatePresets(e){for(const t of this.presets){let s;if(s=this.isCreate?{name:e.name||t.name||(0,d.kg)("presets.default-name"),img:e.img??t.img}:{name:e.name||t.name,img:e.img||t.img},this.data&&(s.data=this.data),this.addSubtract&&(s.addSubtract=this.addSubtract),this.randomize&&(s.randomize=this.randomize),this.modifyOnSpawn&&(s.modifyOnSpawn=this.modifyOnSpawn),this.gridSize&&(s.gridSize=this.gridSize),this.attached&&(s.attached=this.attached),null!=e.preSpawnScript&&(s.preSpawnScript=e.preSpawnScript),null!=e.postSpawnScript&&(s.postSpawnScript=e.postSpawnScript),null!=e.spawnRandom&&(s.spawnRandom=e.spawnRandom),1===this.presets.length)s.tags=e.tags;else if(e.addTags.length||e.removeTags.length){let a=t.tags??[];e.addTags.length&&(a=Array.from(new Set(a.concat(e.addTags)))),e.removeTags.length&&(a=a.filter((t=>!e.removeTags.includes(t)))),s.tags=a}await t.update(s)}}async _updateObject(e,t){return await this._updatePresets(t),this.callback&&this.callback(this.presets),this.presets}async _renderOuter(){const e=await super._renderOuter();return this._createDocumentIdLink(e),e}_createDocumentIdLink(e){const t=e.find(".window-title"),s=(0,d.kg)("DOCUMENT.JournalEntry",!1),a=document.createElement("a");a.classList.add("document-id-link"),a.setAttribute("alt","Copy document id"),a.dataset.tooltip=`${s}: ${this.presets.map((e=>e.id)).join(", ")}`,a.dataset.tooltipDirection="UP",a.innerHTML='<i class="fa-solid fa-passport"></i>',a.addEventListener("click",(e=>{e.preventDefault(),game.clipboard.copyPlainText(this.presets.map((e=>e.id)).join(", ")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"id",id:this.presets.map((e=>e.id)).join(", ")}))})),a.addEventListener("contextmenu",(e=>{e.preventDefault(),game.clipboard.copyPlainText(this.presets.map((e=>e.uuid)).join(", ")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"uuid",id:this.presets.map((e=>e.uuid)).join(", ")}))})),t.append(a)}}class PresetFieldSelect extends FormApplication{static name="PresetFieldSelect";constructor(e,t){super(),this.presetData=e,this.isObject=!(e instanceof Array),this.callback=t}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","preset-field-select","mass-edit-dark-window","mass-edit-window-fill"],template:`modules/${d.Do}/templates/preset/presetFieldSelect.html`,width:600,resizable:!1})}activateListeners(e){super.activateListeners(e),e.find(".item").on("click",this._onFieldClick)}_onFieldClick(e){v(e,$(e.target).closest(".preset-field-list"))}async getData(e={}){let t=foundry.utils.flattenObject(this.presetData);const s=!this.isObject&&1===this.presetData.length;let a,i=[];for(const[e,n]of Object.entries(t)){if(!s){const t=e.split(".")[0];a?t!==a&&i.push({header:!0,index:t}):i.push({header:!0,index:0}),a=t}let t,o=e;s&&(o=o.substring(o.indexOf(".")+1));const r=foundry.utils.getType(n);t="Object"===r||"Array"===r||"null"===r?JSON.stringify(n):n,i.push({name:e,label:o,value:t,selected:!1})}return{fields:i}}}class PresetFieldDelete extends PresetFieldSelect{static name="PresetFieldDelete";get title(){return(0,d.kg)("presets.select-delete")}async getData(e={}){const t=await super.getData(e);return t.button={icon:'<i class="fas fa-trash"></i>',text:(0,d.kg)("common.delete")},t}async _updateObject(e,t){let s=foundry.utils.flattenObject(this.presetData);if($(e.target).closest("form").find(".item.selected").each((function(){const e=$(this).attr("name");delete s[e]})),s=expandObject(s),!this.isObject){let e=[];for(let t=0;t<this.presetData.length;t++)s[t]&&e.push(s[t]);s=e}this.callback(s)}}class PresetFieldModify extends PresetFieldSelect{static name="PresetFieldModify";constructor(e,t,s){super(e,t),this.modifyOnSpawn=s??[]}get title(){return(0,d.kg)("presets.select-modify")}async getData(e={}){const t=await super.getData(e);t.button={icon:'<i class="fas fa-check"></i>',text:(0,d.kg)("CONTROLS.CommonSelect",!1)};for(const e of t.fields)this.modifyOnSpawn.includes(e.name)&&(e.selected=!0);return t}async _updateObject(e,t){const s=$(e.target).closest("form"),a=[];s.find(".item.selected").each((function(){let e=$(this).attr("name");a.push(e)})),this.callback(a)}}class PresetFolderConfig extends FolderConfig{static name="PresetFolderConfig";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","folder-edit"],template:`modules/${d.Do}/templates/preset/presetFolderEdit.html`,width:360})}get id(){return this.object.id?super.id:"folder-create"}get title(){return this.object.id?`${(0,d.kg)("FOLDER.Update",!1)}: ${this.object.name}`:(0,d.kg)("FOLDER.Create",!1)}activateListeners(e){super.activateListeners(e),e.find(".document-select").on("click",this._onDocumentChange.bind(this))}_onDocumentChange(e){$(e.target).closest(".document-select").toggleClass("active")}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t=this.document.toObject(),s=(0,d.kg)(Folder.implementation.metadata.label,!1);let a,i=t.flags[d.Do]?.types??["ALL"];return this.options?.folder instanceof u.dH||1===i.length&&!d.TA.includes(i[0])?this.displayTypes=!1:(this.displayTypes=!0,a=[],d.TA.forEach((e=>{"FAVORITES"!=e&&a.push({name:e,icon:m.aK[e],active:i.includes(e)})}))),{folder:t,name:t._id?t.name:"",newName:(0,d.zS)("DOCUMENT.New",{type:s},!1),safeColor:t.color??"#000000",sortingModes:{a:"FOLDER.SortAlphabetical",m:"FOLDER.SortManual"},submitText:(0,d.kg)(t._id?"FOLDER.Update":"FOLDER.Create",!1),docs:a,virtualPackFolder:this.options.folder instanceof u.dH,group:this.options.folder?.group}}async _updateObject(e,t){if(this.displayTypes){let e=[];$(this.form).find(".document-select.active").each((function(){e.push($(this).data("name"))})),e.length||e.push("ALL"),t[`flags.${d.Do}.types`]=e}let s=this.object;if(this.options.folder instanceof u.dH){let e={};["name","color","group"].forEach((s=>{t[s]?.trim()?e[s]=t[s].trim():e["-="+s]=null})),await this.options.folder.update(e)}else t.name?.trim()||(t.name=Folder.implementation.defaultName()),this.object.id?await this.object.update(t):(this.object.updateSource(t),s=await Folder.create(this.object,{pack:this.object.pack}));return this.options.resolve?.(s),s}}function b(e,{excludePack:t,exportTo:s=!1,keepIdSelect:a=!1}={}){let i;i=s?{title:(0,d.kg)("presets.select-compendium"),message:(0,d.kg)("presets.export-directory-message"),buttonLabel:(0,d.kg)("FOLDER.Export",!1)}:{title:(0,d.kg)("presets.select-compendium"),message:(0,d.kg)("presets.working-directory-message"),buttonLabel:(0,d.kg)("common.swap")};let n="";for(const e of game.packs)if(!e.locked&&"JournalEntry"===e.documentName){if(e.collection===t)continue;const s=e.collection===u.A0.workingPack;n+=`<option value="${e.collection}" ${s?'selected="selected"':""}>${e.title}</option>`}let o=`\n  <p style="color: orangered;">${i.message}</p>\n  <div class="form-group">\n    <label>${(0,d.kg)("PACKAGE.TagCompendium",!1)}</label>\n    <div class="form-fields">\n      <select style="width: 100%; margin-bottom: 10px;">${n}</select>\n    </div>\n  </div>`;a&&(o+=`\n<div class="form-group">\n    <label>${(0,d.kg)("presets.keep-ids")}</label>\n    <input type="checkbox" name="keepId" checked>\n    <p style="font-size: smaller;">${(0,d.kg)("presets.keep-ids-hint")}</p>\n</div>`),new Dialog({title:i.title,content:o,buttons:{export:{label:i.buttonLabel,callback:t=>{const s=$(t).find("select").val();e(a?{pack:s,keepId:$(t).find('[name="keepId"]').is(":checked")}:s)}},cancel:{label:(0,d.kg)("Cancel",!1),callback:()=>e(a?{}:null)}},close:()=>e(a?{}:null),default:"cancel"}).render(!0)}function v(e,t){const s=$(e.target).closest(".item"),a=t.find(".item"),i=a.filter(".last-selected");if(e.ctrlKey||e.metaKey||e.shiftKey){if(e.ctrlKey||e.metaKey)s.toggleClass("selected"),s.hasClass("selected")?(i.removeClass("last-selected"),s.addClass("last-selected")):s.removeClass("last-index");else if(e.shiftKey)if(i.length){let e=a.index(s),t=a.index(i);if(e===t)s.toggleClass("selected"),s.hasClass("selected")?s.addClass("last-selected"):i.removeClass("last-selected");else{let s=a.toArray();if(e>t)for(let a=t;a<=e;a++)$(s[a]).addClass("selected");else for(let a=t;a>=e;a--)$(s[a]).addClass("selected")}}else i.removeClass("last-selected"),s.toggleClass("selected"),s.hasClass("selected")&&s.addClass("last-selected")}else i.removeClass("last-selected"),a.removeClass("selected"),s.addClass("selected").addClass("last-selected")}},671:(e,t,s)=>{s.d(t,{JG:()=>VirtualFilePreset,aK:()=>c,k:()=>Preset});var a=s(120),i=s(652),n=s(627),o=s(575);const r=["id","name","sort","folder"],l=["id","name","data","sort","folder","uuid","documentName","addSubtract","randomize","img","gridSize","modifyOnSpawn","preSpawnScript","postSpawnScript","spawnRandom","attached","tags"],c={ALL:"fas fa-globe",FAVORITES:"fas fa-star",Token:"fas fa-user-circle",MeasuredTemplate:"fas fa-ruler-combined",Tile:"fa-solid fa-cubes",Drawing:"fa-solid fa-pencil-alt",Wall:"fa-solid fa-block-brick",AmbientLight:"fa-regular fa-lightbulb",AmbientSound:"fa-solid fa-music",Note:"fa-solid fa-bookmark",Actor:"fas fa-user-alt",Scene:"fas fa-map",DEFAULT:"fa-solid fa-question"};class Preset{static isEditable(e){if(e.startsWith("virtual@"))return!0;let{collection:t}=foundry.utils.parseUuid(e);return!!t&&!t.locked}constructor(e){this.id=e.id??e._id??foundry.utils.randomID(),this.name=e.name??"Mass Edit Preset",this.documentName=e.documentName,this.sort=e.sort??0,this.tags=e.tags??[],this.addSubtract=e.addSubtract instanceof Array?Object.fromEntries(e.addSubtract):foundry.utils.deepClone(e.addSubtract??{}),this.randomize=e.randomize instanceof Array?Object.fromEntries(e.randomize):foundry.utils.deepClone(e.randomize??{}),this.data=foundry.utils.deepClone(e.data),this.img=e.img,this.folder=e.folder,this.uuid=e.uuid,this.gridSize=e.gridSize,this.modifyOnSpawn=e.modifyOnSpawn,this.preSpawnScript=e.preSpawnScript,this.postSpawnScript=e.postSpawnScript,this.attached=e.attached,this.spawnRandom=e.spawnRandom,this._visible=!0,this._render=!0}get visible(){return this._visible&&this._render}get icon(){return c[this.documentName]??c.DEFAULT}get thumbnail(){return this.img?(0,a.JK)(this.img)?"icons/svg/sound.svg":(0,o.cZ)(this.img)?"icons/svg/video.svg":this.img:CONST.DEFAULT_TOKEN}get pages(){return this.document?.pages.size?this.document.toJSON().pages:this._pages?this._pages:null}set data(e){this._data=e instanceof Array?e.length?e:[{}]:null==e?[{}]:[e]}get data(){return this._data}get isPlaceable(){return a.Me.includes(this.documentName)}get isFavorite(){return Preset.favorites||(Preset.favorites=game.settings.get(a.Do,"presetFavorites")),Boolean(Preset.favorites[this.uuid])}get isEmpty(){return foundry.utils.isEmpty(this.data[0])}addPostSpawnHook(e){this._postSpawnHooks||(this._postSpawnHooks=[]),this._postSpawnHooks.push(e)}async callPostSpawnHooks(e){if(this._postSpawnHooks)for(const t of this._postSpawnHooks)await t(e)}async load(e=!1){if(this.document&&!e)return this;if(!this.document&&this.uuid&&(this.document=await fromUuid(this.uuid)),this.document){const e=this.document.getFlag(a.Do,"preset")??{};this.documentName=e.documentName,this.img=e.img,this.data=e.data,this.randomize="Object"===foundry.utils.getType(e.randomize)?e.randomize:Object.fromEntries(e.randomize??[]),this.addSubtract="Object"===foundry.utils.getType(e.addSubtract)?e.addSubtract:Object.fromEntries(e.addSubtract??[]),this.gridSize=e.gridSize,this.modifyOnSpawn=e.modifyOnSpawn,this.preSpawnScript=e.preSpawnScript,this.postSpawnScript=e.postSpawnScript,this.attached=e.attached,this.spawnRandom=e.spawnRandom,this.tags=e.tags??[]}return this}async openJournal(){this.document||await this.load(),this.document&&this.document.sheet.render(!0)}async attach(e){if(e){e instanceof Array||(e=[e]),this.attached||(this.attached=[]);for(const t of e)this.attached.push({documentName:t.document.documentName,data:(0,o.h)(t)});await this.update({attached:this.attached})}}async update(e){if(this.document){const t={};if(Object.keys(e).forEach((s=>{"randomize"===s||"addSubtract"===s?(t[s]=Object.entries(e[s]),this[s]=e[s]):"data"!==s||e.data instanceof Array?l.includes(s)&&e[s]!==this[s]&&(t[s]=e[s],this[s]=e[s]):(t.data=this.data.map((t=>foundry.utils.mergeObject(t,e.data))),this.data=t.data)})),!foundry.utils.isEmpty(t)){const e={flags:{[a.Do]:{preset:t}}};r.forEach((s=>{s in t&&this.document[s]!==t[s]&&(e[s]=t[s])})),await this.document.update(e)}await this._updateIndex(t)}else console.warn("Updating preset without document",this.id,this.uuid,this.name)}async _updateIndex(e){const t={};if(i.XF.forEach((s=>{s in e&&(t[s]=e[s])})),!foundry.utils.isEmpty(t)){const e=game.packs.get(this.document.pack),s=await e.getDocument(i.Xd);if(!s)return void console.warn(`META INDEX missing in ${this.document.pack}`);{let n={};n[this.id]=t,await s.setFlag(a.Do,"index",n),delete i.A6._packTrees[e.metadata.name]}}}toJSON(){let e={};l.forEach((t=>{e[t]=this[t]})),e.randomize=Object.entries(e.randomize??{}),e.addSubtract=Object.entries(e.addSubtract??{});const t=this.pages;return t&&(e.pages=t),e}clone(){const e=new Preset(this.toJSON());return e.document=this.document,e}}class VirtualFilePreset extends Preset{constructor(e){e.name||(e.name=e.src.split("/").pop()),e.name=(0,o.e6)(e.name),e.uuid="virtual@"+e.src,e.documentName=(0,a.JK)(e.src)?"AmbientSound":"Tile","Tile"===e.documentName?(e.data=[{texture:{src:e.src},x:0,y:0,rotation:0}],e.img=e.src):(e.data=[{path:e.src,radius:20,x:0,y:0}],e.img=e.src),e.gridSize=150,super(e)}get virtual(){return!0}async load(e=!1){if(this._storedReference)return this;const t=await n.WX.getPreset(this.uuid);if(t&&(this.tags=t.tags),this._storedReference=t,this.data[0].path)return this;const s=this.data[0].texture?.src;let i,o,r;if((0,a.wu)(s)){const e=new Image;if(r=new Promise((t=>{e.onload=t,e.src=s})),await Promise.race([r,(async()=>{await new Promise((e=>setTimeout(e,1e3)))})()]),!e.complete||0===e.naturalWidth)return console.log("Image Load failed",s),null;i=e.naturalWidth,o=e.naturalHeight}else{const e=document.createElement("video");r=new Promise((t=>{e.onloadedmetadata=t,e.src=s,e.load()})),await Promise.race([r,(async()=>{await new Promise((e=>setTimeout(e,1e3)))})()]),i=e.videoWidth,o=e.videoHeight}return this.data[0].width=i,this.data[0].height=o,this}async update(e){e.hasOwnProperty("tags")&&this._storedReference&&(this._storedReference.tags=e.tags,clearTimeout(VirtualFilePreset._updateTimeout),VirtualFilePreset._updateTimeout=setTimeout((()=>n.WX.saveIndexToCache()),3e3))}toJSON(){return super.toJSON()}clone(){return new VirtualFilePreset(this.toJSON())}}},575:(e,t,s)=>{s.d(t,{$J:()=>f,CY:()=>p,Go:()=>l,Li:()=>c,Q2:()=>u,Ym:()=>d,cZ:()=>m,cm:()=>FolderState,e6:()=>g,e9:()=>r,h:()=>o});var a=s(739),i=s(465),n=s(120);s(671);class FolderState{static expanded(e){return game.folders._expanded[e]}static setExpanded(e,t){game.folders._expanded[e]=t}}function o(e){const t=e.document.toCompendium();if("Token"===e.document.documentName&&game.modules.get("token-attacher")?.active&&tokenAttacher?.generatePrototypeAttached){const e=t.flags?.["token-attacher"]?.attached||{};if(!foundry.utils.isEmpty(e)){const s=tokenAttacher.generatePrototypeAttached(t,e);foundry.utils.setProperty(t,"flags.token-attacher.attached",null),foundry.utils.setProperty(t,"flags.token-attacher.prototypeAttached",s),foundry.utils.setProperty(t,"flags.token-attacher.grid",{size:canvas.grid.size,w:canvas.grid.sizeX??canvas.grid.w,h:canvas.grid.sizeY??canvas.grid.h})}}return t}async function r(e,t){const s={},i=foundry.utils.flattenObject(e);for(const e of t)e in i&&(null==i[e]?s[e]="":s[e]=i[e]);return foundry.utils.isEmpty(s)||await new Promise((t=>{(0,a.Ls)(s,"PresetFieldModify",{callback:s=>{if(foundry.utils.isEmpty(s))return null==s&&(e=null),void t();for(const[e,t]of Object.entries(s))i[e]=t;const a=foundry.utils.expandObject(i),n=[];for(let t=0;t<e.length;t++)n.push(a[t]);e=n,t()},simplified:!0,noTabs:!0})})),e}function l(e,t){let s;switch(e.documentName){case"Token":s={name:e.name,elevation:0,x:0,y:0,rotation:0,width:1,height:1};break;case"Tile":s={width:canvas.grid.sizeX??canvas.grid.w,height:canvas.grid.sizeY??canvas.grid.h,x:0,y:0,rotation:0,elevation:0};break;case"AmbientSound":s={radius:20,x:0,y:0};break;case"Drawing":s={shape:{width:2*(canvas.grid.sizeX??canvas.grid.w),height:2*(canvas.grid.sizeY??canvas.grid.h),strokeWidth:8,strokeAlpha:1},x:0,y:0,rotation:0};break;case"MeasuredTemplate":s={distance:10,x:0,y:0};break;case"AmbientLight":s={config:{dim:20,bright:20},x:0,y:0};break;case"Scene":s={name:e.name};break;case"Wall":s={c:[0,0,canvas.grid.size,0]};break;default:s={x:0,y:0}}return foundry.utils.mergeObject(s,t)}async function c(e,t,a){const o=t.allFolders.get(e).children;if(!o.length)return;const r=await renderTemplate(`modules/${n.Do}/templates/randomizer/color.html`,{method:"interpolateReverse",space:"srgb",hue:"longer"});let l;let c=new Dialog({title:"Pick Range",content:`<form>${r}</form>`,buttons:{save:{label:"Apply",callback:async e=>{!async function(e,t,s){const n=o.map((e=>({color:"#000000"}))),r={color:{type:"color",method:e,space:t,hue:s,colors:l.getColors()}};await(0,i.of)(n,o,r);for(let e=0;e<o.length;e++)await o[e].update(n[e]);a?.()}(e.find('[name="method"]').val(),e.find('[name="space"]').val(),e.find('[name="hue"]').val())}}},render:e=>{Promise.all([s.e(646),s.e(470),s.e(236)]).then(s.bind(s,236)).then((t=>{l=new t.ColorSlider(e,[{hex:"#663600",offset:0},{hex:"#944f00",offset:100}]),setTimeout((()=>c.setPosition({height:"auto"})),100)}))}});c.render(!0)}function d(e){const t=function(e){let t=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER;return e.forEach(((e,n)=>{for(const o of e){const e=h(n,o);e.x1<t&&(t=e.x1),e.y1<s&&(s=e.y1),e.x2>a&&(a=e.x2),e.y2>i&&(i=e.y2)}})),{x:t,y:s,width:a-t,height:i-s}}(e),s=t.x+t.width/2,a=t.y+t.height/2,i=u(e);return{x:s+i.x,y:a+i.y}}function u(e){const[t,s]=e.entries().next().value,a={};if("Wall"===t){const e=s[0].c;a.x=-e[0],a.y=-e[1]}else if("Region"===t)a.x=0,a.y=0,s.shapes?.forEach((e=>{if(e.points)for(let t=0;t<e.points.length;t+=2)a.x=Math.min(a.x,e.points[t]),a.y=Math.min(a.y,e.points[t+1]);else a.x=Math.min(a.x,e.x),a.y=Math.min(a.y,e.y)})),a.x=-a.x,a.y=-a.y;else if(a.x=-s[0].x,a.y=-s[0].y,game.Levels3DPreview?._active){const e=s[0].elevation??s[0].flags?.levels?.rangeBottom??0;a.z=-e}return a}function h(e,t){let s,a,i,n;if("Wall"===e)s=Math.min(t.c[0],t.c[2]),a=Math.min(t.c[1],t.c[3]),i=Math.max(t.c[0],t.c[2]),n=Math.max(t.c[1],t.c[3]);else{let o,r;s=t.x||0,a=t.y||0,"Tile"===e?(o=t.width,r=t.height):"Drawing"===e?(o=t.shape.width,r=t.shape.height):"Token"===e?(o=t.width*canvas.dimensions.size,r=t.height*canvas.dimensions.size):"Region"===e?t.shapes?.forEach((e=>{if(e.points)for(let t=0;t<e.points.length;t+=2){let t=e.points[0],o=e.points[1];s=Math.min(s,t),a=Math.min(a,o),i=Math.max(i,t),n=Math.max(n,o)}else s=Math.min(s,e.x),a=Math.min(a,e.y),i=Math.max(i,e.x+(e.radiusX??e.width)),n=Math.max(n,e.y+(e.radiusY??e.height))})):(o=0,r=0),i=s+(o||0),n=a+(r||0)}return{x1:s,y1:a,x2:i,y2:n}}function m(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),["mp4","ogg","webm","m4v"].includes(t)}function g(e){try{return decodeURIComponent(e)}catch(t){return console.warn("URI Component not decodable: "+e),e}}function p(e){try{return encodeURIComponent(e)}catch(t){return console.warn("URI Component not encodable: "+e),e}}async function f(e){try{return await jQuery.getJSON(e)}catch(e){}return null}},465:(e,t,s)=>{s.d(t,{Bd:()=>i,RZ:()=>o,Rn:()=>l,_j:()=>n,of:()=>r});var a=s(120);function i(e){const t=e.closest(".form-group");t.find(".mass-edit-checkbox input").prop("checked",!0).trigger("change"),t.find(".mass-edit-randomize").addClass("active")}function n(e,t){const s=e.closest(".form-group");let a=!0;t&&s.find("[name]").each((function(){a&&(a=!Boolean(t.randomizeFields[this.name]))})),a&&(s.find(".mass-edit-checkbox input").prop("checked",!1).trigger("change"),s.find(".mass-edit-randomize").removeClass("active"))}function o(e,t){if(t)for(const s of Object.keys(t))i(e.find(`[name="${s}"]`))}async function r(e,t,i){if(!i||foundry.utils.isEmpty(i))return;let n=!1;for(let o=0;o<e.length;o++){const r=e[o];for(const l of Object.keys(r))if(l in i){const c=i[l];if("select"===c.type)r[l]=c.selection[Math.floor(Math.random()*c.selection.length)];else if("number"===c.type)if(c.step="any"===c.step?1:Number(c.step),Number.isNaN(c.step)&&(c.step=1),"interpolate"===c.method){const e=(c.max-c.min)/c.step+1;r[l]=o%e*c.step+c.min}else if("interpolateReverse"===c.method){const e=(c.max-c.min)/c.step;r[l]=(e-o%(e+1))*c.step+c.min}else{const e=(c.max-c.min+(Number.isInteger(c.step)?1:0))/c.step;r[l]=Math.floor(Math.random()*e)*c.step+c.min}else if("boolean"===c.type)r[l]=Math.random()<.5;else if("color"===c.type){if(c.color1&&(c.colors=[{hex:c.color1,offset:0},{hex:c.color2,offset:100}]),"discrete"===c.space){"interpolate"===c.method?r[l]=c.colors[o%c.colors.length].hex:"interpolateReverse"===c.method?r[l]=c.colors[c.colors.length-1-o%c.colors.length].hex:r[l]=c.colors[Math.floor(Math.random()*c.colors.length)].hex;continue}let t,a=c.colors.map((e=>e));a[0].offset>0&&a.unshift({hex:a[0].hex,offset:0}),a[a.length-1].offset<100&&a.push({hex:a[a.length-1].hex,offset:100}),t="interpolate"===c.method?1-(o+1)/e.length:"interpolateReverse"===c.method?(o+1)/e.length:Math.random(),t*=100;let i,n,d=0;for(;d<a.length-1&&a[d+1].offset<t;)d++;d===a.length-1?(i=a[d-1],n=a[d]):(i=a[d],n=a[d+1]);let u=t-i.offset;u/=n.offset-i.offset;const h=(await s.e(646).then(s.bind(s,646))).default;i=new h(i.hex),n=new h(n.hex);const m=c.space||"srgb",g=c.hue||"shorter";let p=i.range(n,{space:m,hue:g,outputSpace:"srgb"})(u).toString({format:"hex"});p.length<7&&(p="#"+p[1]+p[1]+p[2]+p[2]+p[3]+p[3]),r[l]=p}else if("image"===c.type){if("sequential"===c.method?r[l]=c.images[o%c.images.length]:r[l]=c.images[Math.floor(Math.random()*c.images.length)],c.maintainAspect){const e=t?.[o]?.width??r.width,s=t?.[o]?.height??r.height;if(null!=s&&null!=e)try{const t=await loadTexture(r[l]);if(t){const a=e/s,i=t.width/t.height;i!==a&&(i>a?(r["texture.scaleX"]=1,r["texture.scaleY"]=a):(r["texture.scaleX"]=s/e,r["texture.scaleY"]=1))}}catch(e){}}}else if("text"===c.type)if("findAndReplace"===c.method||"findAndReplaceRegex"===c.method){if(t){const e=foundry.utils.flattenObject((0,a.bQ)(t[o]).toObject());e[l]||c.find?e[l]&&("flags.tagger.tags"===l&&(e[l]=e[l].join(",")),"findAndReplaceRegex"===c.method?r[l]=(0,a.H6)(c.find,c.replace,e[l]):r[l]=(0,a.OV)(c.find,c.replace,e[l])):r[l]=c.replace}}else"unique"===c.method?(c.shuffled||(d(c.strings),c.shuffled=!0,c.i=-1),c.i++,r[l]=c.strings[c.i%c.strings.length]):r[l]=c.strings[Math.floor(Math.random()*c.strings.length)];else"coordinate"===c.type&&(n=!0)}}if(n){let s,a=[];for(let s=0;s<t.length;s++)a.push({p:t[s],update:e[s]});a.sort(((e,t)=>(t.p.w??t.p.width??0)+(t.p.h??t.p.height??0)-(e.p.w??e.p.width??0)-(e.p.h??e.p.height??0)));for(const e of a){const t=i.x??i.y;if("noOverlap"===t.method){s||(s={freeId:0,boundingBox:t.boundingBox,freeRectangles:{0:t.boundingBox},stepX:t.stepX,stepY:t.stepY});const[a,i]=u(e.p,s);e.update.x=a,e.update.y=i}}}}function l(e,t){return e%t<=t/2?e-e%t:e-e%t+t}function c(e,t,s){const a=(t-e)/(s="any"===s?1:Number(s));return Math.floor(Math.random()*(a+(Number.isInteger(s)?1:0)))*s+e}function d(e){for(var t,s=e.length,a=0;s--;)a=Math.floor(Math.random()*(s+1)),t=e[s],e[s]=e[a],e[a]=t;return e}function u(e,t){const s={x:0,y:0,width:l(e.w??e.width,t.stepX),height:l(e.h??e.height,t.stepY)},a=t.freeRectangles;let i=Object.keys(a).filter((e=>{return t=a[e],(i=s).width<=t.width&&i.height<=t.height;var t,i}));if(i.length){const e=i[Math.floor(Math.random()*i.length)];s.x=c(a[e].x,Math.max(a[e].x+a[e].width-s.width,0),t.stepX),s.y=c(a[e].y,Math.max(a[e].y+a[e].height-s.height,0),t.stepY)}else s.x=c(t.boundingBox.x,Math.max(t.boundingBox.x+t.boundingBox.width-s.width,t.boundingBox.x),t.stepX),s.y=c(t.boundingBox.y,Math.max(t.boundingBox.y+t.boundingBox.height-s.height,t.boundingBox.y),t.stepY);let n=Object.keys(a).filter((e=>{return t=a[e],i=s,t.x<i.x+i.width&&i.x<t.x+t.width&&t.y<i.y+i.height&&i.y<t.y+t.height;var t,i}));for(const e of n){const i=a[e];delete a[e],i.x<s.x&&h(a,{x:i.x,y:i.y,width:s.x-i.x,height:i.height},t),i.x+i.width>s.x+s.width&&h(a,{x:s.x+s.width,y:i.y,width:i.x+i.width-(s.x+s.width),height:i.height},t),i.y<s.y&&h(a,{x:i.x,y:i.y,width:i.width,height:s.y-i.y},t),i.y+i.height>s.y+s.height&&h(a,{x:i.x,y:s.y+s.height,width:i.width,height:i.y+i.height-(s.y+s.height)},t)}return[s.x,s.y]}function h(e,t,s){const a=Object.keys(e);for(const s of a)if(i=e[s],n=t,i.x<=n.x&&i.x+i.width>=n.x+n.width&&i.y<=n.y&&i.y+i.height>=n.y+n.height)return;var i,n;s.freeId++,e[s.freeId]=t}},892:(e,t,s)=>{async function a(e,t){if(e=e.object??e,t=function(e){return PIXI.Color?new PIXI.Color(e).toNumber():PIXI.utils.string2hex(e)}(t),e instanceof PlaceableObject)isNaN(t)?await TokenMagic.deleteFilters(e,"DDTint"):await TokenMagic.addUpdateFilters(e,[{filterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t)}]);else{let s=e["flags.tokenmagic.filters"];isNaN(t)?s&&(e["flags.tokenmagic.filters"]=s.filter((e=>"DDTint"!==e.tmFilters.filterId))):(s=(s??[]).filter((e=>"DDTint"!==e.tmFilters.filterId)),s.push({tmFilters:{tmFilterId:"DDTint",tmFilterInternalId:randomID(),tmFilterType:"ddTint",filterOwner:game.data.userId,tmParams:{tmFilterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t),updateId:randomID(),rank:1e4,enabled:!0,filterOwner:game.data.userId}}}),e["flags.tokenmagic.filters"]=s)}}function i(e){let t=16711680,s=e.object??e;if(s._TMFXgetSprite){const e=s._TMFXgetSprite()?.filters?.find((e=>"DDTint"===e.filterId));e&&(t=PIXI.utils.rgb2hex(e.uniforms.tint))}return function(e){return PIXI.Color?new PIXI.Color(e).toHex():PIXI.utils.hex2string(e)}(t)}async function n(e,t,s=!1){if((e=e.object??e)instanceof PlaceableObject)if("DELETE ALL"===t)await TokenMagic.deleteFilters(e);else if(s)await TokenMagic.deleteFilters(e,t);else{const s=TokenMagic.getPreset(t);s&&await TokenMagic.addUpdateFilters(e,foundry.utils.deepClone(s))}}s.d(t,{VC:()=>n,gs:()=>a,qT:()=>i})},120:(e,t,s)=>{s.d(t,{AU:()=>SeededRandom,Do:()=>o,Fo:()=>TagInput,H6:()=>C,HG:()=>B,JK:()=>y,Me:()=>r,Ng:()=>M,OV:()=>O,TA:()=>l,Tx:()=>x,VS:()=>A,XK:()=>z,Y0:()=>g,YY:()=>_,bQ:()=>v,cZ:()=>f,dS:()=>F,dT:()=>E,f6:()=>I,ht:()=>S,jz:()=>b,kg:()=>j,lv:()=>d,m1:()=>T,p:()=>k,qE:()=>c,uv:()=>w,w$:()=>P,wu:()=>p,zS:()=>L});var a=s(998),i=s(624),n=s(465);const o="multi-token-edit",r=["Token","MeasuredTemplate","Tile","Drawing","Wall","AmbientLight","AmbientSound","Note"],l=["FAVORITES","ALL",...r],c=[...r,"Actor","PlaylistSound","Scene"],d=["Item","Cards","RollTable","Actor","JournalEntry","Scene"],u=["webp","jpg","jpeg","png","svg","apng","avif","bmp","gif","tif"],h=["mp4","ogv","webm","m4v"],m=["aac","flac","m4a","mid","mp3","ogg","opus","wav"],g=[...u,...h,...m];function p(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),u.includes(t)}function f(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),h.includes(t)}function y(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),m.includes(t)}async function b(e,t,s,a=[]){const i=await FilePicker.browse(t,e,{bucket:s});if(i){for(const e of i.files)a.push(e);for(const e of i.dirs)await b(e,t,s,a)}return a}function v(e){return e.document?e.document:e}function w(e,t,s){if(e[t]==s)return!0;const a=null==s||!1===s||""===s||"Object"===foundry.utils.getType(s)&&foundry.utils.isEmpty(s),i=null==e[t]||!1===e[t]||""===e[t]||"Object"===foundry.utils.getType(e[t])&&foundry.utils.isEmpty(e[t]);if(a&&i)return!0;if("flags.tagger.tags"===t){const a=e[t]||[];let i=s;Array.isArray(i)||(i=s?s.split(",").map((e=>e.trim())):[]);for(const e of i)if(!a.includes(e))return!1;return!0}return!(!s||"string"!=typeof s||!s.includes("*"))&&E(s,e[t])}function k(e,t){const s=e.split(".");for(let e=s.length-1;e>=1;e--){const a=s.slice(0,e).join(".")+".-="+s[e];if(a in t)return a}return null}function x(e,t){if(t)for(const s of Object.keys(t))e.find(`[name="${s}"]`).removeClass("me-add").removeClass("me-subtract").addClass("add"===t[s].method?"me-add":"me-subtract").attr("title","add"===t[s].method?`+ ${j("form.adding")}`:`- ${j("form.subtracting")}`)}function _(e,t,s,i){if(i&&!foundry.utils.isEmpty(i))for(let n=0;n<e.length;n++){const o=e[n],r=foundry.utils.flattenObject(v(t[n]).toObject());a.A.dataToForm(s,t[n],r);for(const e of Object.keys(o))if(e in i&&e in r){const t=i[e];let s=r[e];if("flags.tagger.tags"===e){const a=Array.isArray(s)?s:(s??"").split(",").map((e=>e.trim())),i=(o[e]??"").split(",").map((e=>e.trim()));for(const e of i)if("add"===t.method)a.includes(e)||a.push(e);else if("subtract"===t.method){const t=a.indexOf(e);t>-1&&a.splice(t,1)}o[e]=a.filter((e=>e)).join(",");continue}if("text"===t.type){if("add"===t.method){const a="value"in t?t.value:o[e];a.startsWith(">>")?s=a.replace(">>","")+s:s+=a}else s=s.replace("value"in t?t.value:o[e],"");o[e]=s;continue}"add"===t.method?s+="value"in t?t.value:o[e]:s-="value"in t?t.value:o[e],"min"in t&&s<t.min?s=t.min:"max"in t&&s>t.max&&(s=t.max),o[e]=s}}}function T(e){if(!e||!e.length)return{};const t=foundry.utils.flattenObject(e[0]);for(let s=1;s<e.length;s++){const a=foundry.utils.flattenObject(foundry.utils.diffObject(t,foundry.utils.flattenObject(e[s])));for(const e of Object.keys(a))(""!==a[e]&&null!=a[e]||""!==t[e]&&null!=t[e])&&delete t[e]}return t}function S(e,t={},s=""){if(t)for(const[a,i]of Object.entries(e)){const n=s?s+"."+a:a;if("Object"===foundry.utils.getType(i))S(i,t,n);else{const s=foundry.utils.getProperty(t,n);void 0!==s&&(e[a]=s)}}}function P(e){if((e=e.map((e=>e.object??e)).filter((e=>e.center))).length)if(1===e.length)e[0].center?.x&&canvas.animatePan({x:e[0].center.x,y:e[0].center.y,duration:250});else{const t={x:999999999,y:999999999},s={x:-999999999,y:-999999999};for(let a of e){let e=a;a instanceof Wall&&(e={x:a.center.x-a.width/2,y:a.center.y-a.height/2}),e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.x+a.width>s.x&&(s.x=e.x+a.width),e.y+a.height>s.y&&(s.y=e.y+a.height)}let a=canvas.scene._viewPosition.scale;const i=100;s.x-t.x+i>canvas.screenDimensions[0]/a&&(a=canvas.screenDimensions[0]/(s.x-t.x+i)),s.y-t.y+i>canvas.screenDimensions[1]/a&&(a=canvas.screenDimensions[1]/(s.y-t.y+i)),canvas.animatePan({duration:250,scale:a,x:(s.x-t.x)/2+t.x,y:(s.y-t.y)/2+t.y})}}function D(e){return e.replace(/[/\-\\^$+?.()|[\]{}]/g,"\\$&")}function E(e,t){return new RegExp("^"+D(e).replaceAll("*",".*")+"$").test(t)}function O(e,t,s){let a=new RegExp(D(e).replaceAll("*",".*"),"g");return s.replaceAll(a,t)}function C(e,t,s){try{let a=new RegExp(e,"g");return s.replaceAll(a,t)}catch(e){}return s}function F(e){const t=function(t){new i.P(e,(async s=>{foundry.utils.isEmpty(s.randomize)||await(0,n.of)(s.data,null,s.randomize);const a=e.object.changes??[];let i=[];Object.keys(s.data[0]).forEach((e=>{let a;a="string"===foundry.utils.getType(s.data[0][e])?s.data[0][e]:JSON.stringify(s.data[0][e]),i.push({key:"Token"===t?"ATL."+e:e,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE,priority:20,value:a})}));for(let e=a.length-1;e>=0;e--)i.find((t=>t.key===a[e].key))||i.unshift(a[e]);e.object.update({changes:i})}),t).render(!0)};new Dialog({title:j("common.presets"),content:"",buttons:{activeEffect:{label:"ActiveEffect",callback:()=>{new i.P(e,(t=>{const s=e.object.changes??[];let a=[];t.data[0].changes?.forEach((e=>{e.key&&a.push(foundry.utils.mergeObject({mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE,priority:20},e))}));for(let e=s.length-1;e>=0;e--)a.find((t=>t.key===s[e].key))||a.unshift(s[e]);e.object.update({changes:a})}),"ActiveEffect").render(!0)}},token:{label:"Token",callback:()=>t("Token")},actor:{label:"Actor",callback:()=>t("Actor")}}}).render(!0)}function M(e){return(e.document?e.document.documentName:e.documentName)??"NONE"}const N={};async function A(e,t,s){if(game.user.isGM)return game.scenes.get(s).createEmbeddedDocuments(e,t);const a=foundry.utils.randomID(),i={handlerName:"document",args:{sceneID:s,documentName:e,data:t,requestID:a},type:"CREATE"};return game.socket.emit(`module.${o}`,i),setTimeout((()=>{N[a]?.([])}),4e3),new Promise((e=>{N[a]=e}))}function I({requestID:e,sceneID:t,documentName:s,documentIDs:a}={}){if(!N.hasOwnProperty(e))return;const i=game.scenes.get(t),n=[];for(const e of a)n.push(i.getEmbeddedDocument(s,e));N[e](n),delete N[e]}function j(e,t=!0){return t?game.i18n.localize(`MassEdit.${e}`):game.i18n.localize(e)}function L(e,t,s=!0){return s?game.i18n.format(`MassEdit.${e}`,t):game.i18n.format(e,t)}async function z(e){if(e&&canvas.scene){await e.load();const t=foundry.utils.flattenObject(e.data[0]),s=e.randomize;foundry.utils.isEmpty(s)||await(0,n.of)([t],null,s),await canvas.scene.update(t),("grid.color"in t||"grid.alpha"in t)&&canvas.grid.grid.draw({color:(t["grid.color"]??canvas.scene.grid.color).replace("#","0x"),alpha:Number(t["grid.alpha"]??canvas.scene.grid.alpha)})}}async function B(e,{actor:t,token:s,...a}={}){const i=ChatMessage.implementation.getSpeaker({actor:t,token:s}),n=game.user.character;s=s||(canvas.ready?canvas.tokens.get(i.token):null),t=t||s?.actor||game.actors.get(i.actor);const o=Object.keys(a);if(o.some((e=>Number.isNumeric(e))))throw new Error("Illegal numeric Macro parameter passed to execution scope.");const r=Object.values(a),l=new(0,async function(){}.constructor)("speaker","actor","token","character","scope",...o,`{${e}\n}`);try{return await l.call(this,i,t,s,n,a,...r)}catch(e){ui.notifications.error("MACRO.Error",{localize:!0})}}class SeededRandom{static randomID(e,t=16){e=this.cyrb128(e);const s=this.sfc32(e[0],e[1],e[2],e[3]),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array.from({length:t},(()=>62*s()|0)).map((e=>a[e])).join("")}static cyrb128(e){let t=1779033703,s=3144134277,a=1013904242,i=2773480762;for(let n,o=0;o<e.length;o++)n=e.charCodeAt(o),t=s^Math.imul(t^n,597399067),s=a^Math.imul(s^n,2869860233),a=i^Math.imul(a^n,951274213),i=t^Math.imul(i^n,2716044179);return t=Math.imul(a^t>>>18,597399067),s=Math.imul(i^s>>>22,2869860233),a=Math.imul(t^a>>>17,951274213),i=Math.imul(s^i>>>19,2716044179),t^=s^a^i,s^=t,a^=t,i^=t,[t>>>0,s>>>0,a>>>0,i>>>0]}static sfc32(e,t,s,a){return function(){var i=((e|=0)+(t|=0)|0)+(a|=0)|0;return a=a+1|0,e=t^t>>>9,t=(s|=0)+(s<<3)|0,s=(s=s<<21|s>>>11)+i|0,(i>>>0)/4294967296}}}class TagInput{static simplifyString(e){return e.replace(/[^0-9a-zA-Z_\- ]/gi,"").toLowerCase()}static registerHandlebarsHelper(){Handlebars.registerHelper("tagInput",(e=>{const t=e.hash.name,s=e.hash.label??"Tags",a=e.hash.listId,i=e.hash.listEntries;let n=e.hash.tags;Handlebars.Utils.isArray(n)||(n=[]);let o="";n.forEach((e=>{o+=this._tagField(e)}));let r="",l="";return a&&i&&(r=`list="${a}"`,l=`<datalist id="${a}"><option value="DELETE"><option value="DELETE ALL">`,i.forEach((e=>{l+=`<option value="${e}">`})),l+="</datalist>"),new Handlebars.SafeString(`\n      ${l}\n      <fieldset>\n        <legend>${s}</legend>\n        <div class="form-group me-tags">\n            <input type="text" ${r} class="tag-input">  \n            <input type="text" class="tag-hidden-input" name="${t}" value="${n.join(",")}" hidden>\n            <button type="button" class="add-tag"><i class="fas fa-save" style="margin: auto;"></i></button>\n            <div class="tag-container">${o}</div>\n        </div>\n      </fieldset>\n    `)}))}static _tagField(e){return`<div class="tag"><span>${e}</span> <a class="delete-tag"><i class="fa-solid fa-x fa-xs"></i></a></div>`}static activateListeners(e,{change:t,simplifyTags:s=!0}={}){e.find(".me-tags .add-tag").on("click",(e=>{const a=$(e.target).closest(".me-tags"),i=a.find(".tag-input"),n=i.val().split(",").map((e=>(e=e.trim(),s&&(e=this.simplifyString(e)),e))).filter(Boolean);if(n.length){i.val("");const e=a.find(".tag-hidden-input"),s=e.val().split(",").filter(Boolean);for(const e of n)s.includes(e)||(s.push(e),a.find(".tag-container").append(this._tagField(e)));e.attr("value",s.join(",")),t?.(s)}})),e.find(".me-tags").on("click",".delete-tag",(e=>{const s=$(e.target).closest(".tag"),a=s.find("span").text(),i=s.closest(".me-tags").find(".tag-hidden-input"),n=i.val().split(",").filter((e=>e!==a));i.attr("value",n.join(",")),s.remove(),t?.(n)}))}}},669:e=>{e.exports=jQuery}},i={};function n(e){var t=i[e];if(void 0!==t)return t.exports;var s=i[e]={exports:{}};return a[e](s,s.exports,n),s.exports}n.m=a,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(s,a){if(1&a&&(s=this(s)),8&a)return s;if("object"==typeof s&&s){if(4&a&&s.__esModule)return s;if(16&a&&"function"==typeof s.then)return s}var i=Object.create(null);n.r(i);var o={};e=e||[null,t({}),t([]),t(t)];for(var r=2&a&&s;"object"==typeof r&&!~e.indexOf(r);r=t(r))Object.getOwnPropertyNames(r).forEach((e=>o[e]=()=>s[e]));return o.default=()=>s,n.d(i,o),i},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,s)=>(n.f[s](e,t),t)),[])),n.u=e=>e+".bundle.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},n.l=(e,t,a,i)=>{if(s[e])s[e].push(t);else{var o,r;if(void 0!==a)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var d=l[c];if(d.getAttribute("src")==e){o=d;break}}o||(r=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,n.nc&&o.setAttribute("nonce",n.nc),o.src=e),s[e]=[t];var u=(t,a)=>{o.onerror=o.onload=null,clearTimeout(h);var i=s[e];if(delete s[e],o.parentNode&&o.parentNode.removeChild(o),i&&i.forEach((e=>e(a))),t)return t(a)},h=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),r&&document.head.appendChild(o)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="modules/multi-token-edit/",(()=>{var e={792:0};n.f.j=(t,s)=>{var a=n.o(e,t)?e[t]:void 0;if(0!==a)if(a)s.push(a[2]);else{var i=new Promise(((s,i)=>a=e[t]=[s,i]));s.push(a[2]=i);var o=n.p+n.u(t),r=new Error;n.l(o,(s=>{if(n.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a)){var i=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+i+": "+o+")",r.name="ChunkLoadError",r.type=i,r.request=o,a[1](r)}}),"chunk-"+t,t)}};var t=(t,s)=>{var a,i,[o,r,l]=s,c=0;if(o.some((t=>0!==e[t]))){for(a in r)n.o(r,a)&&(n.m[a]=r[a]);if(l)l(n)}for(t&&t(s);c<o.length;c++)i=o[c],n.o(e,i)&&e[i]&&e[i][0](),e[i]=0},s=self.webpackChunk=self.webpackChunk||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),(()=>{var e=n(739),t=n(338),s=n(120),a=n(998),i=n(465);let o;const r=new RegExp("([^.[]+|\\[('([^'\\\\]|\\\\.)+?'|\"([^\"\\\\]|\\\\.)+?\")\\])","g"),l=new RegExp("(^\\['|'\\]$|^\\[\"|\"\\]$)","g");function c(e){e.controlled&&(e.controlIcon.border.visible=!0)}Hooks.once("init",(()=>{o=!globalThis.libWrapper||(globalThis.libWrapper.is_fallback??1)?class{static get is_fallback(){return!0}static get WRAPPER(){return"WRAPPER"}static get MIXED(){return"MIXED"}static get OVERRIDE(){return"OVERRIDE"}static register(e,t,s,a="MIXED",{chain:i,bind:n=[]}={}){const o=t.endsWith("#set"),c=(t=o?t.slice(0,-4):t).match(r).map((e=>e.replace(/\\(.)/g,"$1").replace(l,""))),d=c.splice(0,1)[0];let u,h;if(0==c.length)u=globalThis,h=d;else{const e=eval;h=c.pop(),u=c.reduce(((e,t)=>e[t]),globalThis[d]??e(d))}let m=u,g=null;for(;m&&(g=Object.getOwnPropertyDescriptor(m,h),!g);)m=Object.getPrototypeOf(m);if(!g||!1===g?.configurable)throw new Error(`libWrapper Shim: '${t}' does not exist, could not be found, or has a non-configurable descriptor.`);let p=null;const f=i??("OVERRIDE"!=a.toUpperCase?.()&&3!=a)?function(...e){return s.call(this,p.bind(this),...n,...e)}:function(...e){return s.call(this,...n,...e)};if(o){if(!g.set)throw new Error(`libWrapper Shim: '${t}' does not have a setter`);p=g.set,g.set=f}else g.value?(p=g.value,g.value=f):(p=g.get,g.get=f);g.configurable=!0,Object.defineProperty(u,h,g)}}:globalThis.libWrapper}));var d=n(652),u=n(624),h=n(867),m=n(971);var g=n(241),p=n(627);class V12Migrator{static async migrateAllPacks({migrateFunc:e=null,coreMigration:t=!1}={}){if(e||t)for(const s of game.packs)"JournalEntry"===s.documentName&&s.index.get(d.Xd)&&(s.locked?console.warn(`Mass Edit - Unable to migrate a locked compendium. ${s.metadata.label}`):this.migratePack({pack:s,migrateFunc:e,coreMigration:t}));else ui.notifications.warn("Specify either a `migrateFunc` or enable `coreMigration` flag.")}static async migratePack({pack:e=d.A0.workingPack,migrateFunc:t=null,coreMigration:a=!1}={}){if("string"===foundry.utils.getType(e)){let t=game.packs.get(e)||game.packs.find((t=>t.metadata.label===e));if(!t)return void console.warn("Invalid pack: "+e);e=t}if(!e.index.get(d.Xd))return void console.warn(`Mass Edit - This is not a preset compendium. ${e.metadata.label}`);if(e.locked)return void console.warn(`Mass Edit - Unable to migrate a locked compendium. ${e.metadata.label}`);if(!t&&!a)return void ui.notifications.warn("Specify either a `migrateFunc` or enable `coreMigration` flag.");const i=[],n=await e.getDocuments();for(const e of n){const n=e.getFlag(s.Do,"preset");if(!n)continue;let o={};if(n.data?.length&&(this._migrateData(n.data,n.documentName,a,t),foundry.utils.setProperty(o,`flags.${s.Do}.preset.data`,n.data)),n.attached?.length){for(const e of n.attached)this._migrateData([e.data],e.documentName,a,t);foundry.utils.setProperty(o,`flags.${s.Do}.preset.attached`,n.attached)}foundry.utils.isEmpty(o)||(o._id=e.id,i.push(o))}i.length<=0?ui.notifications.info("Mass Edit - No data to migrate: "+e.metadata.label):(await JournalEntry.updateDocuments(i,{pack:e.collection}),ui.notifications.notify("Mass Edit - Migrated "+i.length+' presets within "'+e.metadata.label))}static _migrateData(e,t,s=!0,a=null){const i=getDocumentClass(t);for(const n of e){s&&i.migrateData(n),a&&a(n,t);const e=n.flags?.["token-attacher"]?.prototypeAttached;e&&this._migratePrototypeAttached(e,s,a)}}static _migratePrototypeAttached(e,t=!0,s=null){for(const[a,i]of Object.entries(e))this._migrateData(i,a,t,s)}}var f=n(439);Hooks.once("init",(()=>{s.Fo.registerHandlebarsHelper(),game.settings.register(s.Do,"cssStyle",{scope:"world",config:!1,type:String,default:"Solid Background"}),game.settings.register(s.Do,"cssCustom",{scope:"world",config:!1,type:String,default:h.rY.Default}),game.settings.registerMenu(s.Do,"cssEdit",{name:(0,s.kg)("settings.cssEdit.name"),hint:(0,s.kg)("settings.cssEdit.hint"),label:"",scope:"world",icon:"fas fa-cog",type:h.Ay,restricted:!0}),game.settings.register(s.Do,"singleDocDefaultConfig",{name:(0,s.kg)("settings.singleDocDefaultConfig.name"),hint:(0,s.kg)("settings.singleDocDefaultConfig.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(s.Do,"rangeToTextbox",{name:(0,s.kg)("settings.rangeToTextbox.name"),hint:(0,s.kg)("settings.rangeToTextbox.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(s.Do,"indexer",{scope:"world",config:!1,type:Object,default:{indexDirs:[{target:"modules",source:"data"},{target:"sounds",source:"public"}],cacheDir:{target:"",source:"data"},overrideTags:!1,ignoreExternal:!1,fileFilters:["Thumb","-thumb","Thumbnail","thumbnail"],folderFilters:["Thumb","thumb"]}}),game.settings.register(s.Do,"workingPack",{scope:"world",config:!1,type:String,default:"world.mass-edit-presets-main",onChange:e=>{d.A0.workingPack=e}}),d.A0.workingPack=game.settings.get(s.Do,"workingPack"),game.settings.register(s.Do,"docPresets",{scope:"world",config:!1,type:Array,default:[]}),game.settings.register(s.Do,"presetsMigrated",{scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(s.Do,"presetsCompMigrated",{scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(s.Do,"presetDocLock",{scope:"world",config:!1,type:String,default:""}),game.settings.register(s.Do,"presetLayerSwitch",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(s.Do,"presetExtComp",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(s.Do,"presetVirtualDir",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(s.Do,"presetScaling",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(s.Do,"presetSortMode",{scope:"world",config:!1,type:String,default:"manual"}),game.settings.register(s.Do,"presetSearchMode",{scope:"world",config:!1,type:String,default:"pf"}),game.settings.register(s.Do,"presetSceneControl",{name:"Scene Controls: Preset Button",scope:"world",config:!0,type:Boolean,default:!0,onChange:()=>{ui.controls.render()}}),game.settings.register(s.Do,"presetFavorites",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(s.Do,"pinnedFields",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(s.Do,"customControls",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(s.Do,"autoSnap",{name:(0,s.kg)("settings.autoSnap.name"),hint:(0,s.kg)("settings.autoSnap.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(s.Do,"panToSearch",{name:(0,s.kg)("settings.panToSearch.name"),hint:(0,s.kg)("settings.panToSearch.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.modules.get("tokenmagic")?.active&&game.settings.register(s.Do,"tmfxFieldsEnable",{name:(0,s.kg)("settings.tmfxFieldsEnable.name"),hint:(0,s.kg)("settings.tmfxFieldsEnable.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(s.Do,"brush",{scope:"world",config:!1,type:Object,default:{scale:[1,1],rotation:[0,0],random:!0,group:!1,spawner:!0,eraser:!1,lock:!1,snap:!1,scaleToGrid:!0}}),game.keybindings.register(s.Do,"placeablePreviewEdit",{name:"Select Edit Placeables",hint:"",editable:[{key:"KeyD",modifiers:["Shift"]}],onDown:m.editPreviewPlaceables,restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"editKey",{name:(0,s.kg)("keybindings.editKey.name"),hint:(0,s.kg)("keybindings.editKey.hint"),editable:[{key:"KeyE",modifiers:["Shift"]}],onDown:()=>{const t=Object.values(ui.windows).find((e=>e.meObjects));t?t.close():(0,e.gx)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"copyKey",{name:"Copy",hint:"",editable:[{key:"KeyC",modifiers:["Shift"]}],onDown:()=>{""===window.getSelection().toString()&&Object.values(ui.windows).find((e=>null!=e.meObjects))?.performMassCopy()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"pasteKey",{name:"Paste",hint:"",editable:[{key:"KeyV",modifiers:["Shift"]}],onDown:()=>{(0,e.CM)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"selectKey",{name:(0,s.kg)("keybindings.selectKey.name"),hint:(0,s.kg)("keybindings.selectKey.hint"),editable:[{key:"KeyF",modifiers:["Shift"]}],onDown:()=>{(0,e.G_)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"presetApply",{name:(0,s.kg)("keybindings.presetApply.name"),hint:(0,s.kg)("keybindings.presetApply.hint"),editable:[{key:"KeyX",modifiers:["Shift"]}],onDown:()=>{const e=Object.values(ui.windows).find((e=>e instanceof u.P));if(e)return void e.close(!0);const t=Object.values(ui.windows).find((e=>e instanceof ActiveEffectConfig));if(t)return void(0,s.dS)(t);const a=canvas.activeLayer.constructor.documentName;s.Me.includes(a)&&new u.P(null,null,a).render(!0)},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"presetApplyScene",{name:(0,s.kg)("keybindings.presetApplyScene.name"),hint:(0,s.kg)("keybindings.presetApplyScene.hint"),editable:[],onDown:()=>{const e=Object.values(ui.windows).find((e=>e instanceof u.P));e?e.close(!0):new u.P(null,null,"Scene").render(!0)},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(s.Do,"genericFormKey",{name:(0,s.kg)("keybindings.genericForm.name"),hint:(0,s.kg)("keybindings.genericForm.hint"),editable:[{key:"KeyR",modifiers:["Shift"]}],onDown:()=>{let[a,i]=(0,e.ef)(null,!1);if(!a)return;const n=(0,s.Ng)(a);[...s.lv,"Token"].includes(n)&&("Token"===n?(0,e.Pw)(i,{massEdit:!0}):new t.s(i,{massEdit:!0,documentName:n}).render(!0))},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),function(){if(game.modules.get("select-tool-everywhere")?.active)return;const e=["AmbientLight","AmbientSound","MeasuredTemplate","Note"];e.forEach((e=>{Hooks.on(`refresh${e}`,c)})),Hooks.on("canvasReady",(()=>e.forEach((e=>canvas.getLayerByEmbeddedName(e).options.controllableObjects=!0)))),Hooks.on("getSceneControlButtons",(e=>function(e){for(const t of e)["lighting","sounds","measure"].includes(t.name)&&(t.tools.find((e=>"select"===e.name))||(t.tools.unshift({name:"select",title:"CONTROLS.CommonSelect",icon:"fas fa-expand"}),t.activeTool="select"))}(e))),Hooks.on("drawNote",(e=>{setTimeout((()=>c(e)),10)})),libWrapper.register(s.Do,"AmbientLight.prototype._onDragLeftCancel",(function(...e){Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this,e),this.initializeLightSource?this.initializeLightSource({defer:!0}):this.updateSource({defer:!0})}),"OVERRIDE")}(),o.register(s.Do,"ClientKeybindings._onCopy",(function(e,...t){if(""===window.getSelection().toString()){const e=Object.values(ui.windows).find((e=>null!=e.meObjects));if(e?.performMassCopy())return!0}const s=e(...t);return s&&(0,f.ms)(canvas.activeLayer.constructor.documentName),s}),"MIXED"),o.register(s.Do,"ClientKeybindings._onPaste",(function(t,...s){return!!(0,e.CM)()||t(...s)}),"MIXED"),o.register(s.Do,"MouseManager.prototype._onWheel",(function(e,...t){const s=t[0];if((m.Picker.isActive()||g._8.isActive())&&(s.ctrlKey||s.shiftKey||s.metaKey||s.altKey)){s.ctrlKey&&s.preventDefault();let e=s.delta=s.deltaY;if(s.shiftKey&&0===e&&(e=s.delta=s.deltaX),0===e)return;return void(s.altKey?m.Picker.addScaling(s.delta<0?.05:-.05):(s.ctrlKey||s.metaKey)&&s.shiftKey?g._8.iterate(s.delta>=0):s.ctrlKey||s.metaKey?m.Picker.addRotation(s.delta<0?2.5:-2.5):s.shiftKey&&m.Picker.addRotation(s.delta<0?15:-15))}return e(...t)}),"MIXED"),game.settings.get(s.Do,"presetSceneControl")&&o.register(s.Do,"SceneNavigation.prototype._getContextMenuOptions",(function(t,...s){const a=t(...s);return a.push({name:"Mass Edit",icon:'<i class="fa-solid fa-pen-to-square"></i>',condition:game.user.isGM,callback:t=>{const s=t.attr("data-scene-id");(0,e.gx)(game.scenes.get(s))}}),a}),"WRAPPER");const n=function(e,...t){if(!u.P.objectHover&&!u.Q.objectHover)return e(...t);{this.mouseInteractionManager.cancel(...t);const e=Object.values(ui.windows).find((e=>u.P.objectHover&&e instanceof u.P||u.Q.objectHover&&e instanceof u.Q));if(e){const s=canvas.activeLayer.controlled.length?[...canvas.activeLayer.controlled]:[this];e.dropPlaceable(s,...t)}this._onDragLeftCancel(...t)}};s.Me.forEach((e=>{o.register(s.Do,`${e}.prototype._onDragLeftDrop`,n,"MIXED")})),game.socket?.on(`module.${s.Do}`,(async e=>{const t=e.args;if("document"===e.handlerName&&"CREATE"===e.type){if(!!game.users.filter((e=>e.isGM&&(e.active||e.isActive))).some((e=>e.id<game.user.id)))return;const e=(await(0,s.VS)(t.documentName,t.data,t.sceneID)).map((e=>e.id)),a={handlerName:"document",args:{requestID:t.requestID,sceneID:t.sceneID,documentName:t.documentName,documentIDs:e},type:"RESOLVE"};game.socket.emit(`module.${s.Do}`,a)}else"document"===e.handlerName&&"RESOLVE"===e.type&&(0,s.f6)(t)})),Hooks.on("spotlightOmnisearch.indexBuilt",((e,t)=>{if(!game.user.isGM)return;const s=game.settings.get("spotlight-omnisearch","compendiumConfig");game.packs.filter((e=>"JournalEntry"===e.documentName&&e.index.get(d.Xd))).forEach((e=>s[e.collection]=!1)),game.settings.set("spotlight-omnisearch","compendiumConfig",s);const a=d.A0.buildSpotlightOmnisearchIndex(e);t.push(a)})),globalThis.MassEdit={GeneralDataAdapter:a.A,MassEditGenericForm:t.s,showGenericForm:e.Ls,performMassUpdate:f.pt,performMassSearch:f.qn,showMassEdit:e.gx,getPreset:d.af.getPreset,getPresets:d.af.getPresets,createPreset:d.af.createPreset,spawnPreset:d.af.spawnPreset,activateBrush:g.Yv,deactivateBrush:g.Xt,openBrushMenu:g.Oy,buildDirectoryIndex:e=>p.WX.buildIndex(e),readCacheFile:p.u9.readCacheFile,migratePack:(e,t={})=>V12Migrator.migratePack(e,t),migrateAllPacks:(e={})=>V12Migrator.migrateAllPacks(e)},game.modules.get(s.Do).api={...globalThis.MassEdit,applyRandomization:i.of,applyAddSubtract:s.YY,checkApplySpecialFields:f.fP}})),Hooks.on("canvasReady",(()=>{g._8.isActive()?g._8.close():m.Picker.isActive()&&m.Picker.destroy()})),Hooks.on("renderSceneControls",((e,t,a)=>{if(!game.user.isGM)return;if(!game.settings.get(s.Do,"presetSceneControl"))return;const i=$('\n<li class="scene-control mass-edit-scene-control" data-control="me-presets" aria-label="Mass Edit: Presets" role="tab" data-tooltip="Mass Edit: Presets">\n  <i class="fa-solid fa-books"></i>\n</li>\n  ');i.on("click",(()=>{let e=canvas.activeLayer.constructor.documentName;s.Me.includes(e)||(e="ALL");const t=Object.values(ui.windows).find((e=>e instanceof u.P));t?t.close():new u.P(null,null,e,{left:i.position().left+i.width()+40}).render(!0)})),t.find(".control-tools").find(".scene-control").last().after(i)})),Hooks.on("renderTokenHUD",((t,s,a)=>{canvas.tokens.controlled.length>=2&&($(s).find('.control-icon[data-action="config"]').after('<div class="control-icon" data-action="massConfig">\n          <i class="fas fa-cogs"></i>\n        </div>'),$(s).on("click",'[data-action="massConfig"]',(()=>{(0,e.gx)()})))})),Hooks.on("renderTileHUD",((t,s,a)=>{(canvas.background?canvas.background.controlled.concat(canvas.foreground.controlled):canvas.tiles.controlled).length>=2&&($(s).find('.control-icon[data-action="underfoot"]').after('<div class="control-icon" data-action="massConfig">\n          <i class="fas fa-cogs"></i>\n        </div>'),$(s).on("click",'[data-action="massConfig"]',(()=>{(0,e.gx)()})))})),Hooks.on("renderActiveEffectConfig",(e=>{const t=$(e.form).find(".effects-header .key");if(t.length){const a=$('<i title="Apply \'Mass Edit\' preset" style="font-size:smaller;color:brown;"> <a>[ME]</a></i>');a.on("click",(()=>(0,s.dS)(e))),t.append(a)}}))})()})();
//# sourceMappingURL=bundle.js.map