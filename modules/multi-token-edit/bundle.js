(()=>{"use strict";var e,t={867:(e,t,s)=>{s.d(t,{Ay:()=>CSSEdit,QD:()=>n,rY:()=>i});var a=s(120);function n(){const e=game.settings.get(a.Do,"cssStyle");return e in i?[e,i[e]]:["CUSTOM",game.settings.get(a.Do,"cssCustom")||""]}class CSSEdit extends FormApplication{constructor(){super({},{})}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-css",classes:["sheet"],template:`modules/${a.Do}/templates/cssEdit.html`,resizable:!0,minimizable:!1,title:"Edit CSS",width:490,height:730})}async getData(e){const t=super.getData(e),[s,a]=n();return t.styleInUse=s,t.css=a,t.styles=Object.keys(i),t.styles.push("CUSTOM"),t.disableCSS="CUSTOM"!==s,t}activateListeners(e){super.activateListeners(e),$(e).on("change",".selectStyle",(t=>{let s;s="CUSTOM"===t.target.value?game.settings.get(a.Do,"cssCustom"):i[t.target.value],$(e).find(".cssTextArea").val(s).prop("disabled","CUSTOM"!==t.target.value),$(e).find(".previewStyle").html(s)})),$(e).on("input",".cssTextArea",(t=>{$(e).find(".previewStyle").html(t.target.value)}))}async _updateObject(e,t){"CUSTOM"===t.selectedStyle&&game.settings.set(a.Do,"cssCustom",t.css),game.settings.set(a.Do,"cssStyle",t.selectedStyle)}}const i={Default:".form-group.meCommon {\n  outline: green dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {\n  outline: rgb(255, 204, 110) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  outline: rgb(246, 175, 255) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  outline: rgb(118, 242, 255) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}\n","No Outline":".form-group.meCommon {}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}\n","Striped Background":".form-group.meCommon {\n  background: repeating-linear-gradient(\n  45deg,\n  rgba(155, 233, 155, 0.8),\n  rgba(155, 233, 155, 0.8) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {\n  background: repeating-linear-gradient(\n  135deg,\n  rgba(255, 207, 118, 0.5),\n  rgba(255, 207, 118, 0.5) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  background: repeating-linear-gradient(\n  70deg,\n  rgba(237, 149, 255, 0.3),\n  rgba(237, 149, 255, 0.3) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  background: repeating-linear-gradient(\n  70deg,\n  rgba(118, 242, 255, 0.5),\n  rgba(118, 242, 255, 0.5) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n","Solid Background":".form-group.meCommon {\n  background: rgba(155, 233, 155, 0.8)\n}\n\n.mass-edit-checkbox.meCommon {\noutline: green solid 2px;\n}\n\n.form-group.meDiff {\n  background: rgba(255, 207, 118, 0.5)\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  background: rgba(237, 149, 255, 0.3)\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  background: rgba(118, 242, 255, 0.5)\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}"}},998:(e,t,s)=>{s.d(t,{A:()=>GeneralDataAdapter,f:()=>TokenDataAdapter});class TokenDataAdapter{static updateToForm(e){"texture.scaleX"in e&&(e.mirrorX=e["texture.scaleX"]<0,e.scale=Math.abs(e["texture.scaleX"])),"texture.scaleY"in e&&(e.mirrorY=e["texture.scaleY"]<0,e.scale=Math.abs(e["texture.scaleY"]))}static dataToForm(e,t){const s=e.document??e;null!=s.texture?.scaleX&&(t.scale=Math.abs(s.texture.scaleX)),null!=s.texture?.scaleX&&(t.mirrorX=s.texture.scaleX<0),null!=s.texture?.scaleY&&(t.mirrorY=s.texture.scaleY<0)}static formToData(e,t){const s=e.document??e;("scale"in t||"mirrorX"in t||"mirrorY"in t)&&("scale"in t||(t.scale=Math.abs(s.texture.scaleX)),"mirrorX"in t||(t.mirrorX=s.texture.scaleX<0),"mirrorY"in t||(t.mirrorY=s.texture.scaleY<0),t["texture.scaleX"]=t.scale*(t.mirrorX?-1:1),t["texture.scaleY"]=t.scale*(t.mirrorY?-1:1),["scale","mirrorX","mirrorY"].forEach((e=>delete t[e]))),TokenDataAdapter.correctDetectionModes(s,t)}static correctDetectionModeOrder(e,t){const s={};let a=0;for(const[n,i]of Object.entries(e))if(n.startsWith("detectionModes")){const o=n.split(".");o[1]in s||(s[o[1]]=a,a++);const r=`detectionModes.${s[o[1]]}.${o[2]}`;if(delete e[n],e[r]=i,t&&n in t){const e=t[n];delete t[n],t[r]=e}}}static detectionModeMatch(e,t){for(const s of e)if("id"in s)for(const e of t)if(s.id===e.id){if("enabled"in s&&s.enabled!==e.enabled)return!1;if("range"in s&&s.range!==e.range)return!1;break}return!0}static correctDetectionModes(e,t){const s=[],a={};let n=0;for(const[e,i]of Object.entries(t))if(e.startsWith("detectionModes")){const o=e.split(".");o[1]in a||(a[o[1]]=n,s.push({}),n++);s[a[o[1]]][o[2]]=i,delete t[e]}if(!s.length)return;const i=foundry.utils.deepClone(e.detectionModes).filter((e=>e.id));for(const e of s){if(null==e.id)continue;let t=!1;for(const s of i)if(s.id===e.id){foundry.utils.mergeObject(s,e),t=!0;break}t||i.push(foundry.utils.mergeObject({id:"",range:0,enabled:!0},e))}t.detectionModes=i}static modifyPresetData(e,t){const s=Object.values(foundry.utils.expandObject(t)?.detectionModes||{});if(!s.length)return;const a=Object.values(foundry.utils.expandObject(e._getSubmitData())?.detectionModes||{}),n=foundry.utils.deepClone(t),i=t["mass-edit-randomize"]??{},o=t["mass-edit-addSubtract"]??{},r=function(e,t,s,a,n){`detectionModes.${s}.${a}`in e&&(delete e[`detectionModes.${s}.${a}`],e[`detectionModes.${j}.${a}`]=n[t][`detectionModes.${s}.${a}`])},l=a.length;for(let e=0;e<s.length;e++){if(!("id"in s[e]))continue;let c=!1;for(let d=0;d<l;d++)s[e].id===a[d].id&&(c=!0,Object.keys(s[e]).forEach((s=>{delete t[`detectionModes.${e}.${s}`],t[`detectionModes.${d}.${s}`]=n[`detectionModes.${e}.${s}`],r(i,"mass-edit-randomize",e,s,n),r(o,"mass-edit-addSubtract",e,s,n)})));c||(a.push({id:"",range:0,enabled:!0}),Object.keys(s[e]).forEach((s=>{delete t[`detectionModes.${e}.${s}`],t[`detectionModes.${a.length-1}.${s}`]=n[`detectionModes.${e}.${s}`],`detectionModes.${e}.${s}`in i&&(delete i[`detectionModes.${e}.${s}`],i[`detectionModes.${a.length-1}.${s}`]=n["mass-edit-randomize"][`detectionModes.${e}.${s}`]),`detectionModes.${e}.${s}`in o&&(delete o[`detectionModes.${e}.${s}`],o[`detectionModes.${a.length-1}.${s}`]=n["mass-edit-addSubtract"][`detectionModes.${e}.${s}`])})))}return l!==a.length?(e._previewChanges({detectionModes:a}),e.render(),!0):void 0}}const a={Token:TokenDataAdapter,PlaylistSound:class PlaylistSoundDataAdapter{static formToData(e,t){"lvolume"in t&&(t.volume=AudioHelper.inputToVolume(t.lvolume),delete t.lvolume)}static dataToForm(e,t){t.lvolume=(e.document??e).volume}static updateToForm(e){"volume"in e&&(e.lvolume=AudioHelper.volumeToInput(e.volume),delete e.volume)}},Note:class NoteDataAdapter{static formToData(e,t){("icon.selected"in t||"icon.custom"in t)&&(t["texture.src"]=t["icon.selected"]||t["icon.custom"],delete t["icon.selected"],delete t["icon.custom"])}static dataToForm(e,t){const s=e.document??e;null!=s.texture?.src&&(t["icon.selected"]=s.texture.src,t["icon.custom"]=s.texture.src)}}};class GeneralDataAdapter{static formToData(e,t,s){const n=a[e];n&&n.formToData&&n.formToData(t,s)}static dataToForm(e,t,s){const n=a[e];n&&n.dataToForm&&n.dataToForm(t,s)}static updateToForm(e,t){const s=a[e];s&&s.updateToForm&&s.updateToForm(t)}}},208:(e,t,s)=>{s.d(t,{dN:()=>D,fP:()=>N,lW:()=>L,ms:()=>z,bE:()=>R,cc:()=>F,B0:()=>T,qn:()=>E,pt:()=>C});var a=s(241),n=(s(30),s(120));var i=s(294),o=s(671),r=s(465);async function l(e,t){if(e=e.object??e,t=function(e){return PIXI.Color?new PIXI.Color(e).toNumber():PIXI.utils.string2hex(e)}(t),e instanceof PlaceableObject)isNaN(t)?await TokenMagic.deleteFilters(e,"DDTint"):await TokenMagic.addUpdateFilters(e,[{filterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t)}]);else{let s=e["flags.tokenmagic.filters"];isNaN(t)?s&&(e["flags.tokenmagic.filters"]=s.filter((e=>"DDTint"!==e.tmFilters.filterId))):(s=(s??[]).filter((e=>"DDTint"!==e.tmFilters.filterId)),s.push({tmFilters:{tmFilterId:"DDTint",tmFilterInternalId:randomID(),tmFilterType:"ddTint",filterOwner:game.data.userId,tmParams:{tmFilterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t),updateId:randomID(),rank:1e4,enabled:!0,filterOwner:game.data.userId}}}),e["flags.tokenmagic.filters"]=s)}}function c(e){let t=16711680,s=e.object??e;if(s._TMFXgetSprite){const e=s._TMFXgetSprite()?.filters?.find((e=>"DDTint"===e.filterId));e&&(t=PIXI.utils.rgb2hex(e.uniforms.tint))}return function(e){return PIXI.Color?new PIXI.Color(e).toHex():PIXI.utils.hex2string(e)}(t)}async function d(e,t,s=!1){if((e=e.object??e)instanceof PlaceableObject)if("DELETE ALL"===t)await TokenMagic.deleteFilters(e);else if(s)await TokenMagic.deleteFilters(e,t);else{const s=TokenMagic.getPreset(t);s&&await TokenMagic.addUpdateFilters(e,foundry.utils.deepClone(s))}}var u=s(867),m=s(998),h=s(165),g=s(739);class MassEditHistory extends FormApplication{constructor(e,t){super({},{}),this.callback=t,this.docName=e,this.history=foundry.utils.deepClone(h.V)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-history",classes:["sheet"],template:`modules/${n.Do}/templates/history.html`,resizable:!1,minimizable:!1,title:"History",width:400,height:"auto"})}get title(){return`[${this.docName}] ${(0,n.kg)("common.history")}`}async getData(e){const t=super.getData(e),s=(this.history[this.docName]??[]).reverse();t.updates=[];let a=!1;const n=function(e,t,s){let a="";for(const n of Object.keys(e))if(!["_id","mass-edit-randomize","mass-edit-addSubtract"].includes(n))if(n in t)a+=`${n}: {{randomized}}\n`;else if(n in s){const t="value"in s[n]?s[n].value:e[n];a+=`${n}: ${"add"===s[n].method?"+":"-"}${t}\n`}else a+=`${n}: ${e[n]}\n`;return a};for(const e of s){const s=e.ctrl["mass-edit-randomize"]||{},i=e.ctrl["mass-edit-addSubtract"]||{},o=n(foundry.utils.deepClone(e.update),s,i),r=n(foundry.utils.deepClone(e.diff),s,i),l=o!==r;l&&(a=!0),t.updates.push({label:e.timestamp,title:r,fullTitle:o,id:e._id,hasDifferences:l})}return t.includeDiff=a,t}activateListeners(e){super.activateListeners(e),e.on("click",".doc-id",(e=>{const t=$(e.target).closest("div").find("button")[0].dataset.id,s=g.i2[this.docName];if(s){let e=canvas[s].placeables.find((e=>e.id===t))||null;e&&canvas.animatePan({x:e.center.x,y:e.center.y,duration:250})}}));const t=function(e,t,s,a){const n=$(e.target).closest("li")[0].dataset.index,i=(s[a]??[])[n];if(i){L(new o.k({documentName:a,data:foundry.utils.deepClone(i[t]),randomize:i.ctrl["mass-edit-randomize"],addSubtract:i.ctrl["mass-edit-addSubtract"]}))}};e.on("click",".doc-copy-update",(e=>{t(e,"update",this.history,this.docName)})),e.on("click",".doc-copy-diff",(e=>{t(e,"diff",this.history,this.docName)}))}async _updateObject(e,t){const s=$(e.submitter).closest("li")[0].dataset.index,a=(this.history[this.docName]??[])[s];if(a){const t=foundry.utils.deepClone(a[e.submitter.name]);m.A.updateToForm(this.docName,t);const s=new o.k({documentName:this.docName,data:t,randomize:a.ctrl["mass-edit-randomize"],addSubtract:a.ctrl["mass-edit-addSubtract"]});this.callback(s)}}}function p(e,t){if("update"===e.method||"toggle"===e.method){let s="";return"toggle"===e.method&&(s+=function(e){let t="\n// Toggle; Helper function";"field"===e.toggle.method?t+="\nconst toggleOn = function (obj, fields) {\n  const data = foundry.utils.flattenObject(obj.toObject());\n  fields = foundry.utils.flattenObject(fields);\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\n};\n  ":t+="\nconst macro = this;\nconst toggleOn = function (obj) {\n  if (obj.getFlag('world', `macro-${macro.id}-toggleOn`)) {\n    obj.unsetFlag('world', `macro-${macro.id}-toggleOn`);\n    return true;\n  } else {\n    obj.setFlag('world', `macro-${macro.id}-toggleOn`, true);\n    return false;\n  }\n};\n";return t}(e)),s+=`\n// Updates to be applied\nconst update = ${b(e.fields)};\n`,"toggle"===e.method&&(s+=`const update2 = ${b(e.toggle.fields)};\n\n`),w(e)&&(s+="\n// Mass Edit control objects\n",e.randomize&&(s+=`const randomizeFields = ${b(e.randomize)};\n`),e.addSubtract&&(s+=`const addSubtractFields = ${b(e.addSubtract)};\n`),e.toggle&&(e.toggle.randomize&&(s+=`const randomizeFieldsToggleOff = ${b(e.toggle?.randomize)};\n`),e.toggle.addSubtract&&(s+=`const addSubtractFieldsToggleOff = ${b(e.toggle?.addSubtract)};\n`))),w(e)?s+function(e,t){let s=[];e.randomize&&s.push("randomizeFields");e.addSubtract&&s.push("addSubtractFields");if(s=s.join(", "),"toggle"===e.method){let a=[];return e.toggle?.randomize&&a.push("randomizeFields: randomizeFieldsToggleOff"),e.toggle?.addSubtract&&a.push("addSubtractFields: addSubtractFieldsToggleOff"),a=a.join(", "),`\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n  \ntargets.forEach((t) => {\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\n  else toggleOnTargets.push(t);\n});\n  \nawait MassEdit.api.performMassUpdate.call({${s}}, update, toggleOnTargets, '${t}');\nawait MassEdit.api.performMassUpdate.call({${a}}, update2, toggleOffTargets, '${t}');\n`}return`await MassEdit.api.performMassUpdate.call({${s}}, update, targets, '${t}');\n`}(e,t):s+function(e,t){let s="";if(foundry.utils.isEmpty(e.fields)&&!e.toggle)return"";if(e.toggle&&foundry.utils.isEmpty(e.toggle.fields)&&foundry.utils.isEmpty(e.fields))return"\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n\ntargets.forEach((t) => {\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\n  else toggleOnTargets.push(t);\n});\n    ";const a=(e.macro||e.toggle?.macro)&&e.toggle;a&&(s+="\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n  ");n.Me.includes(t)?(s+="\nconst updates = {};","toggle"===e.method?s+=`\ntargets.forEach((t) => {\n  const sceneId = t.parent.id;\n  if(!updates[sceneId]) updates[sceneId] = [];\n\n  let u;\n  if(toggleOn(t, update)) {\n    u = foundry.utils.deepClone(update2);${a?"\ntoggleOffTargets.push(t);":""}\n  } else {\n    u = foundry.utils.deepClone(update);${a?"\ntoggleOnTargets.push(t);":""}\n  }\n  u._id = t.id;\n\n  updates[sceneId].push(u);\n});\n  `:s+="\ntargets.forEach((t) => {\n  const sceneId = t.parent.id;\n  if(!updates[sceneId]) updates[sceneId] = [];\n  \n  let u = foundry.utils.deepClone(update);\n  u._id = t.id;\n    updates[sceneId].push(u);\n});\n  "):(s+="\nconst updates = [];","toggle"===e.method?s+=`\ntargets.forEach((t) => {\n  let u;\n  if(toggleOn(t, update)) {\n    u = foundry.utils.deepClone(update2);${a?"\ntoggleOffTargets.push(t);":""}\n  } else {\n    u = foundry.utils.deepClone(update);${a?"\ntoggleOnTargets.push(t);":""}\n  }\n  u._id = t.id;\n  updates.push(u);\n});\n  `:s+="\ntargets.forEach((t) => {\n  let u = foundry.utils.deepClone(update);\n  u._id = t.id;\n  updates.push(u);\n});\n  ");n.Me.includes(t)?s+=`\nfor(const sceneId of Object.keys(updates)) {\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${t}', updates[sceneId]);\n}\n  `:s+="PlaylistSound"===t?"\nfor (let i = 0; i < targets.length; i++) {\n  delete updates[i]._id;\n  targets[i].document.update(updates[i]);\n}\n  ":`\n${t}.updateDocuments(updates);\n`;return s}(e,t)}return"massEdit"===e.method?`\n// Open Mass Edit Form\nawait MassEdit.api.showMassEdit(targets, '${t}');`:"delete"===e.method?function(e,t){let s=`\n// Delete ${t}s`;n.Me.includes(t)?"selected"===e.target.scope||"scene"===e.target.scope?s+=`\ncanvas.scene.deleteEmbeddedDocuments('${t}', targets.map(t => t.id));`:s+=`\nconst toDelete = {};\ntargets.forEach( t => {\n  const sceneID = t.parent.id;\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\n  toDelete[sceneID].push(t.id);\n});\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${t}', toDelete[sceneID]));\n      `:s+=`\n${t}.deleteDocuments(targets.map( t => t.id ));`;return s}(e,t):void 0}function f(e,t,s){const a=e.target;if("ids"===a.method)return function(e,t,s){let a=`const ids = [${s.map((e=>`"${e.id}"`)).join(",")}];\n`;a+="const targets = [];",n.Me.includes(t)?a+=`\nids.forEach( id => {\n  Array.from(game.scenes).forEach( scene => {\n    let embed = scene.getEmbeddedDocument('${t}', id);\n    if(embed) targets.push(embed)\n  });\n});\n`:a+=`\nids.forEach(id => { \n  const doc = ${t}.get(id);\n  if(doc) targets.push(doc);\n});`;return a}(0,t,s);if("search"===a.method)return function(e,t){let s=b(e.fields);if("selected"===e.scope){let e=y(t);return e+=`\ntargets = await MassEdit.api.performMassSearch('search', '${t}' , ${s}, { scope: 'selected', selected: targets, control: false, pan: false });`,e}if("scene"===e.scope)return`const targets = await MassEdit.api.performMassSearch('search', '${t}' , ${s}, { scope: 'scene', control: false, pan: false });`;if("world"===e.scope)return`const targets = await MassEdit.api.performMassSearch('search', '${t}' , ${s}, { scope: 'world', control: false, pan: false });`}(a,t);if("tagger"===a.method)return function(e,t){let s="";const a={matchAny:"any"===e.tagger.match,allScenes:"world"===e.scope};"selected"===e.scope?(s+=y(t),s+=`targets = Tagger.getByTag('${e.tagger.tags}', { matchAny: ${"any"===e.tagger.match}, objects: targets }).filter(t => t.documentName === '${t}');\n\n`):"scene"===e.scope?s+=`const targets = Tagger.getByTag('${e.tagger.tags}', ${b(a)}).filter(t => t.documentName === '${t}');\n\n`:"world"===e.scope&&(s+="const targets = [];",s+=`Object.values(Tagger.getByTag('${e.tagger.tags}', ${b(a)})).forEach(item => item.forEach(t => { if(t.documentName === '${t}') targets.push(t) }));`);return s}(a,t);if("all"===a.method)return function(e,t){if("selected"===e.scope)return y(t);if(!n.Me.includes(t))return`const targets = Array.from(game.collections.get('${t}'));`;if("scene"===e.scope)return`const targets = canvas.getLayerByEmbeddedName('${t}').placeables.map(o => o.document);\n\n`;if("world"===e.scope)return`const targets = [];\nArray.from(game.scenes).forEach( scene => {\n  Array.from( scene.getEmbeddedCollection('${t}') ).forEach(embed => targets.push(embed));\n});\n  `}(a,t);throw new Error("Invalid target method: "+a.method)}function y(e){let t="";if(n.Me.includes(e))return`let targets = canvas.getLayerByEmbeddedName('${e}').controlled.map(o => o.document);\n\n`;if(game.modules.get("multiple-document-selection")?.active){const s={Actor:"actor",Scene:"scene",JournalEntry:"journalentry",Playlist:"sound",Item:"item",RollTable:"RollTable",Cards:"cards"};return t+="let targets = [];\n",t+="Playlist"===e?`\n$(\`.directory-list .\${'${s[e]}'}.selected\`).each(function (_) {\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\n  if (d) targets.push(d);\n});\n`:`\n$(\`.directory-list .\${'${s[e]}'}.selected\`).each(function (_) {\n  let d = game.collections.get('${e}').get(this.dataset.documentId);\n  if (d) targets.push(d);\n});\n  `,t}throw new Error(`'Selected' is not a supported options for ${e}s`)}function b(e){return e?JSON.stringify(e,null,2):null}async function k(e,t,s){let a="";if(a+=function(e,t){let s="";const a=e=>`ui.notifications.warn('${(0,n.zS)("macro.dependency-warning",{module:e})}');`;"tagger"===e.target.method&&(s+=`\nif (!game.modules.get('tagger')?.active) {\n  ${a("Tagger")}\n  return;\n}\n\n`);(function(e){return e.randomize||e.addSubtract||e.toggle?.randomize||e.toggle?.addSubtract||"search"===e.target.method||"massEdit"===e.method||x(e.fields)})(e)&&(s+=`\nconst MassEdit = game.modules.get('${n.Do}');\nif(!MassEdit?.active){\n  ${a("Mass Edit")}\n  return;\n}\n\n`);n.lv.includes(t)&&"select"===e.target.scope&&(s+=`\nif (!game.modules.get('multiple-document-selection')?.active) {\n  ${a("Multiple Document Selection")}\n  return;\n}\n\n`);return s}(s,e),a+=f(s,e,t),a+=p(s,e),(s.macro||s.toggle?.macro)&&(a+=function(e,t){let s=`\n\n// ===================\n// = Macro Execution =\n// ===================\n\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\nconst layer = canvas.getLayerByEmbeddedName('${t}');\n`;e.macro&&(s+=`\n// Apply macro\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${e.macro.name}')\nif (applyMacro && ${e.toggle?"toggleOnTargets":"targets"}.length) {\n  ${e.macro.select?`layer.activate();\n  layer.releaseAll();\n  ${e.toggle?"toggleOnTargets":"targets"}.forEach(t => t.object?.control({ releaseOthers: false }));\n`:""}\n  if (advancedMacro) applyMacro.execute(${e.toggle?"toggleOnTargets":"targets"});\n  else applyMacro.execute({token, actor});\n  ${e.macro.select?"\n  layer.releaseAll();":""}\n}\n`);e.toggle?.macro&&(s+=`\n// Apply macro on toggle off\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${e.toggle.macro.name}')\nif (offMacro && toggleOffTargets.length) {\n  ${e.toggle.macro.select?"layer.activate();\n  layer.releaseAll();\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\n":""}\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\n  else offMacro.execute({token, actor});\n  ${e.toggle.macro.select?"\n  layer.releaseAll();":""}\n}\n`);return s}(s,e)),a){(await Macro.create({name:s.name,type:"script",scope:"global",command:a})).sheet.render(!0)}}function w(e){return e.randomize||e.addSubtract||e.toggle?.randomize||e.toggle?.addSubtract||x(e.fields)}function x(e){const t=["tokenmagic.ddTint","tokenmagic.preset","massedit.scale","massedit.texture.scale"];for(const s of t)if(s in e)return!0;return!1}class MacroForm extends FormApplication{constructor(e,t,s,a,n,i){super({},{}),this.mainObject=e,this.placeables=t,this.docName=s,this.fields=a,this.randomizeFields=n,this.addSubtractFields=i,n&&!foundry.utils.isEmpty(n)||i&&!foundry.utils.isEmpty(i)||m.A.formToData(this.docName,this.mainObject,this.fields)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-macro",classes:["sheet"],template:`modules/${n.Do}/templates/macro.html`,resizable:!0,minimizable:!1,title:"Generate Macro",width:400,height:"auto"})}async getData(e){const t=super.getData(e);t.docName=this.docName,t.fields=JSON.stringify(this.fields,null,2),t.selectable=n.Me.includes(this.docName),t.selectScopeEnabled=t.selectable||n.lv.includes(this.docName)&&game.modules.get("multiple-document-selection")?.active;const s=[{value:"all",title:(0,n.zS)("macro.target-all-title",{document:this.docName}),label:(0,n.kg)("common.all")},{value:"ids",title:(0,n.kg)("macro.target-ids-title"),label:(0,n.kg)("macro.target-ids")},{value:"search",title:(0,n.zS)("macro.target-search-title",{document:this.docName}),label:(0,n.kg)("FILES.Search",!1)}];return n.Me.includes(this.docName)&&game.modules.get("tagger")?.active&&s.push({value:"tagger",title:(0,n.kg)("macro.target-tagger-title"),label:"Tagger"}),t.targetingOptions=s,this.addSubtractFields&&!foundry.utils.isEmpty(this.addSubtractFields)&&(t.hasAddSubtract=!0,t.addSubtract=JSON.stringify(this.addSubtractFields)),this.randomizeFields&&!foundry.utils.isEmpty(this.randomizeFields)&&(t.hasRandom=!0,t.randomize=JSON.stringify(this.randomizeFields)),t.hasMEControls=t.hasAddSubtract||t.hasRandom||x(this.fields),t.hiddenControl=["Token","Tile","Drawing","AmbientLight","AmbientSound","MeasuredTemplate"].includes(this.docName),t.macros=game.collections.get("Macro").map((e=>e.name)),t}_onShowReturnJson(e,t){const s=e.siblings(`[name="${t}"]`),a=JSON.parse(s.val());let i=`<textarea name="json" style="width:100%; height: 300px;">${JSON.stringify(a,null,2)}</textarea>`;new Dialog({title:"JSON",content:i,buttons:{Ok:{label:(0,n.kg)("Save",!1),callback:t=>{try{const a=JSON.parse(t.find('[name="json"]').val()||"{}");foundry.utils.isEmpty(a)?(e.hide(),s.prop("disabled",!0),this.setPosition({height:"auto"})):s.val(JSON.stringify(a))}catch(e){ui.notifications.warn("Invalid data. Failed to save.")}}}}}).render(!0)}_onRemoveJson(e,t){const s=e.siblings(`[name="${t}"]`);e.hide(),s.prop("disabled",!0),this.setPosition({height:"auto"})}activateListeners(e){super.activateListeners(e),["randomize","addSubtract","toggle.randomize","toggle.addSubtract"].forEach((t=>{const s=t.replace(".","");e.find(`.${s}`).click((e=>{this._onShowReturnJson($(e.target).parent(),t)})),e.find(`.${s}`).contextmenu((e=>{this._onRemoveJson($(e.target).parent(),t)}))})),e.find(".toggleVisibility").click((t=>{const s=e.find('[name="fields"]'),a=e.find('[name="toggle.fields"]');let n,i={};try{n=JSON.parse(s.val()),n.hidden=!n.hidden,s.val(JSON.stringify(n,null,2)),i=JSON.parse(a.val()),i.hidden=!n.hidden,a.val(JSON.stringify(i,null,2))}catch(e){}})),e.find('[name="target.method"]').change((t=>{"tagger"===t.target.value?(e.find(".taggerControl").show(),e.find('[name="tags"').attr("required",!0)):(e.find(".taggerControl").hide(),e.find('[name="tags"').attr("required",!1)),"ids"===t.target.value?e.find('[name="target.scope"]').closest(".form-group").hide():e.find('[name="target.scope"]').closest(".form-group").show(),"search"===t.target.value?e.find('[name="target.fields"]').closest("div").show():e.find('[name="target.fields"]').closest("div").hide(),this.setPosition({height:"auto"})})),e.find('[name="method"]').on("change",(t=>{if("toggle"===t.target.value){let t=foundry.utils.flattenObject((s=this.mainObject,s.document?s.document:s).toObject());const a={};Object.keys(this.fields).forEach((e=>a[e]=t[e])),e.find('[name="toggle.fields"]').val(JSON.stringify(a,null,2)),e.find(".toggleControl").show(),this.setPosition({height:"auto"})}else e.find(".toggleControl").hide(),this.setPosition({height:"auto"});var s;"massEdit"===t.target.value||"delete"===t.target.value?(e.find(".fields").hide(),this.setPosition({height:"auto"})):(e.find(".fields").show(),this.setPosition({height:"auto"}))}))}async _updateObject(e,t){(t=expandObject(t)).fields=JSON.parse(t.fields),"toggle"!==t.method?delete t.toggle:t.toggle.fields=JSON.parse(t.toggle.fields),t.macro.name||delete t.macro,t.toggle?.macro&&!t.toggle.macro.name&&delete t.toggle.macro,"tagger"!==t.target.method&&delete t.target.tagger,"search"!==t.target.method?delete t.target.fields:t.target.fields=JSON.parse(t.target.fields),t.randomize&&(t.randomize=JSON.parse(t.randomize)),t.toggle?.randomize&&(t.toggle.randomize=JSON.parse(t.toggle.randomize)),t.addSubtract&&(t.addSubtract=JSON.parse(t.addSubtract)),t.toggle?.addSubtract&&(t.toggle.addSubtract=JSON.parse(t.toggle.addSubtract)),k(this.docName,this.placeables,t)}}const S=e=>class MassEditForm extends e{constructor(e,t,s){super(e,s),this.meObjects=t,this.documentName=s.documentName??e.document?.documentName??e.documentName??"NONE",this.commonData=s.commonData||{},this.randomizerEnabled=s.massEdit,this.massFormButtons=[{title:(0,n.kg)("common.apply"),value:"permissions",icon:"far fa-save"}],this.randomizeFields={},this.addSubtractFields={},this.meForm=!0}async getData(e){"AmbientLight"!==this.documentName||this.preview||(this.preview=this.meObjects[0].clone());return super.getData(e)}async activateListeners(e){await super.activateListeners(e),function(e){const t=(0,n.Ng)(e.meObjects[0]);if(!["AmbientLight","AmbientSound"].includes(t))return;const s=$(e.form);if(s.find('input[name="hidden"]').length)return;const a=e.object.hidden,i=`\n  <div class="form-group">\n    <label>${(0,n.kg)("Hidden",!1)}</label>\n    <div class="form-fields">\n        <input type="checkbox" name="hidden" ${a?"checked":""}>\n    </div>\n  </div>\n`,o=s.find("div.tab");o.length?o.first().append(i):s.find(".form-group").last().after(i),e.setPosition({height:"auto"})}(this),(n.Me.includes(this.documentName)||n.lv.includes(this.documentName))&&this._injectGlobalDeleteButton(e);const[t,i]=(0,u.QD)();$(e).prepend(`<style>${i}</style>`),e.on("input",'textarea, input[type="text"], input[type="number"]',_.bind(this)),e.on("change","textarea, input, select",_.bind(this)),e.on("paste","input",_.bind(this)),e.on("click","button",_.bind(this));const o=game.settings.get(n.Do,"rangeToTextbox"),r=foundry.utils.flattenObject(this.commonData||{}),l=this.randomizerEnabled,d=function(e,t=null){if(!$(e).find("[name]").length)return;if($(e).find(".mass-edit-checkbox").length)return;let s="meCommon";r&&$(e).find("[name]").each((function(){const t=$(this).attr("name");if(o&&"range"===$(this).attr("type")){const s=$(e).find("span.range-value");s.length&&(s.replaceWith($(`<input name="${t}" class="range-value" type="number" step="any" value="${this.defaultValue}" min="${this.min}" max="${this.max}"></input>`)),$(this).removeAttr("name"))}t.startsWith("flags.")?s="meFlag":t in r||"invert-radius"===t||(s="meDiff")}));let a="";l&&(a='<div class="mass-edit-randomize"></div>'),s=t??s;const n=$(`<div class="mass-edit-checkbox ${s}">${a}<input class="mass-edit-control" type="checkbox" data-dtype="Boolean"}></div>`);$(e).find("p.hint, p.notes").length?$(e).find("p.hint, p.notes").first().before(n):$(e).append(n),$(e).addClass(s)};$(e).find(".form-group").each((function(e){d(this)}));const m=this;this.randomizerEnabled&&$(e).on("contextmenu",".mass-edit-checkbox",(e=>{s.e(816).then(s.bind(s,816)).then((t=>{t.showRandomizeDialog($(e.target).closest(".form-group"),m)}))})),$(e).on("contextmenu",'input[type=range], input[type=number], input[name="flags.tagger.tags"], input[type="text"], input[name="tokenmagic.preset"]',(e=>{const t=e.target.name;if(!t)return;const s=$(e.target);if(t in this.addSubtractFields)if("add"===this.addSubtractFields[t].method){this.addSubtractFields[t].method="subtract",s.removeClass("me-add").addClass("me-subtract"),s.attr("title","- Subtracting");const a={method:"subtract"};e.target.min&&(a.min=parseFloat(e.target.min)),a.type=s.attr("type"),this.addSubtractFields[t]=a}else delete this.addSubtractFields[t],s.removeClass("me-subtract"),s.attr("title","");else{s.addClass("me-add"),s.attr("title","+ Adding");const a={method:"add"};e.target.max&&(a.max=parseFloat(e.target.max)),a.type=s.attr("type"),this.addSubtractFields[t]=a}_(e),a.vM.refreshPreset()})),$(e).find(".sheet-footer > button").remove(),$(e).find('button[type="submit"]').remove();let h="";if(!this._meSubmitInserted){this._meSubmitInserted=!0;for(const e of this.massFormButtons)h+=`<button class="me-submit" type="submit" value="${e.value}"><i class="${e.icon}"></i> ${e.title}</button>`,!this.options.massEdit||this.options.simplified||this.options.presetEdit||(h+=`<div class="me-mod-update" title="${(0,n.kg)("form.immediate-update-title")}"><input type="checkbox" data-submit="${e.value}"><i class="fas fa-cogs"></i></div>`);this.options.massSelect&&n.Me.includes(this.documentName)&&(h+=`<div class="me-mod-update" title="${(0,n.kg)("form.global-search-title")}"><input type="checkbox" data-submit="world"><i class="far fa-globe"></i></div>`);let t=$(e).find(".sheet-footer").last();t.length?t.append(h):(t=$(`<footer class="sheet-footer flexrow">${h}</footer>`),$(e).closest("form").append(t)),t.find(".me-mod-update > input").on("change",(e=>{e.stopPropagation();const s=e.target.checked;t.find(".me-mod-update > input").not(this).prop("checked",!1),$(e.target).prop("checked",s),this.modUpdate=s,this.modUpdateType=e.target.dataset?.submit}))}if(this.options.inputChangeCallback&&e.on("change","input, select",(async e=>{setTimeout((()=>this.options.inputChangeCallback(this.getSelectedFields())),100)})),e.on("contextmenu","nav > .item",(e=>{const t=e.target.dataset?.tab;if(t){const s=$(e.target).closest("nav").attr("data-group");let a;s&&(a=$(e.target).closest("form").find(`.tab[data-tab="${t}"][data-group="${s}"], .matt-tab[data-tab="${t}"][data-group="${s}"]`).find(".mass-edit-control")),a&&0!==a.length||(a=$(e.target).closest("form").find(`.tab[data-tab="${t}"], .matt-tab[data-tab="${t}"]`).find(".mass-edit-control"));let n=!0;0===a.not(":checked").length&&(n=!1),a.prop("checked",n),a.each((function(){n?M(this):A(this)})),a.first().trigger("change")}})),"Tile"===this.documentName&&this._createAction){let t=$(`\n          <div class="form-group">\n            <label>Mass Edit: ${(0,n.kg)("form.actions")}</label>\n            <div class="form-fields">\n                <input type="hidden" name="flags.monks-active-tiles.actions">\n            </div>\n          `);$(e).find('.matt-tab[data-tab="trigger-actions"]').prepend(t),d(t,"meInsert"),t=$(`\n          <div class="form-group">\n            <label>Mass Edit: ${(0,n.kg)("form.images")}</label>\n            <div class="form-fields">\n                <input type="hidden" name="flags.monks-active-tiles.files">\n            </div>\n          `),t.insertBefore('.matt-tab[data-tab="trigger-images"] .files-list'),d(t,"meInsert")}if(("Tile"===this.documentName||"Token"===this.documentName)&&game.Levels3DPreview){let t=$(`\n          <div class="form-group">\n            <label>Mass Edit: ${(0,n.kg)("form.shaders")}</label>\n            <div class="form-fields">\n                <input type="hidden" name="flags.levels-3d-preview.shaders">\n            </div>\n          `);$(e).find("#shader-config").after(t),d(t,"meInsert")}if(("Tile"===this.documentName||"Token"===this.documentName)&&!this.options?.simplified&&game.modules.get("tokenmagic")?.active&&game.settings.get(n.Do,"tmfxFieldsEnable")){let t='<datalist id="tmfxPresets"><option value="DELETE ALL">';TokenMagic.getPresets().forEach((e=>t+=`<option value="${e.name}">`)),t+='</datalist><input list="tmfxPresets" name="tokenmagic.preset">';let s=$(`\n          <div class="form-group">\n            <label>${(0,n.kg)("common.preset")} <span class="units">(TMFX)</span></label>\n            <div class="form-fields">\n              ${t}\n            </div>\n          `);$(e).find('[name="texture.tint"]').closest(".form-group").after(s),d(s,"meInsert");const a=c(this.object.object??this.object);s=$(`\n          <div class="form-group">\n            <label>DungeonDraft <span class="units">(TMFX)</span></label>\n            <div class="form-fields">\n              <input class="color" type="text" name="tokenmagic.ddTint" value="${a}">\n              <input type="color" value="${a}" data-edit="tokenmagic.ddTint">\n            </div>\n          `),$(e).find('[name="texture.tint"]').closest(".form-group").after(s),d(s,"meInsert")}if("Tile"===this.documentName){let t=$(`\n        <div class="form-group slim">\n          <label>${(0,n.kg)("Scale",!1)} <span class="units">(${(0,n.kg)("common.ratio")})</span></label>\n          <div class="form-fields">\n            <label>${(0,n.kg)("Width",!1)} | ${(0,n.kg)("Height",!1)} ${game.Levels3DPreview?._active?"| Depth":""}</label>\n            <input type="number" value="1" step="any" name="massedit.scale" min="0">\n          </div>\n        </div>`);$(e).find('[name="width"]').closest(".form-group").before(t),d(t,"meInsert"),t=$(`\n          <div class="form-group slim">\n            <label>${(0,n.kg)("TILE.Scale",!1)} <span class="units">(${(0,n.kg)("common.ratio")})</span></label>\n            <div class="form-fields">\n              <label>${(0,n.kg)("TILE.ScaleX",!1)} | ${(0,n.kg)("TILE.ScaleY",!1)}</label>\n              <input type="number" value="1" step="any" name="massedit.texture.scale" min="0">\n            </div>\n          </div>`),$(e).find('[name="texture.scaleX"]').closest(".form-group").before(t),d(t,"meInsert")}this.setPosition(),this.element[0].style.height="";new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{$(e).hasClass("form-group")?d(e):$(e).find(".form-group").each((function(){$(this).find(".mass-edit-checkbox").length||d(this)}))}))}))})).observe(e[0],{characterData:!1,attributes:!1,childList:!0,subtree:!0}),"Token"===this.documentName&&$(e).find("fieldset.detection-mode").each((function(e){$(this).wrap('<div class="form-group"></div>')})),async function(e){}()}getSelectedFields(e){e||(e=this._getSubmitData()),"flags.levels-3d-preview.shaders"in(e=foundry.utils.flattenObject(e))&&(e["flags.levels-3d-preview.shaders"]=this.object.getFlag("levels-3d-preview","shaders")),"Token"===this.documentName?e["texture.scaleX"]&&(e.scale=Math.abs(e["texture.scaleX"]),e.mirrorX=e["texture.scaleX"]<0,e.mirrorY=e["texture.scaleY"]<0):"Note"===this.documentName&&e["texture.src"]&&(e["icon.selected"]=e["texture.src"],e["icon.custom"]=e["texture.src"]);const t={},s=$(this.form),a=this.addSubtractFields,i=this;return s.find(".form-group").each((function(s){const o=$(this).find(".mass-edit-checkbox > input");o.length&&o.is(":checked")&&$(this).find("[name]").each((function(s){const o=$(this).attr("name");if("flags.limits"===o){const e=foundry.utils.flattenObject(i.object.toObject().flags.limits??{});for(const[s,a]of Object.entries(e))t["flags.limits."+s]=a}if(void 0===e[o]&&o.startsWith("flags.")){const s=(0,n.p)(o,e);s&&(t[s]=null)}else t[o]=e[o],o in a&&(a[o].value=e[o]);if("string"===foundry.utils.getType(t[o])){const e=$(this);if(e.hasClass("tva-array"))v.trim()?t[o]=t[o].trim().split(",").map((e=>e.trim())):t[o]=[];else if(e.hasClass("tva-jsonArray"))try{t[o]=JSON.parse(t[o])}catch(e){t[o]=[]}}}))})),t}async _onChangeInput(e){if(!["AmbientLight","Tile","Token"].includes(this.documentName))return void super._onChangeInput(e);const t=e.target;"color"===t.type&&t.dataset.edit?this._onChangeColorPicker(e):"range"===t.type&&this._onChangeRange(e)}_getHeaderButtons(){return super._getHeaderButtons().filter((e=>"configure-sheet"!==e.class))}_injectGlobalDeleteButton(e){const t=$(`<div class="me-global-delete"><a title="${(0,n.kg)("form.global-delete-title")}"><i class="far fa-times-octagon fa-2x"></i></a></div>`);t.click((e=>{new Dialog({title:"Confirm",content:`\n          <h2 style="color: red; text-align: center;">${(0,n.zS)("form.delete-warning",{count:this.meObjects.length,document:this.documentName})}</h2>\n          <p>${(0,n.kg)("form.proceed")}</p>`,buttons:{buttonA:{label:(0,n.kg)("Yes",!1),callback:()=>{this.meObjects.forEach((e=>{let t=e.document??e;t.delete&&t.delete()})),this.close()}},no:{label:(0,n.kg)("No",!1)}},default:"buttonA"}).render(!0)})),e.closest("form").append(t)}},D=(e="NONE")=>{let t;const s=CONFIG[e]?.sheetClasses;s&&"Actor"!==e?t=Object.values(Object.values(s).pop()??{}).pop()?.cls:(t=FormApplication,t=FormApplication);const l=S(t);class MassConfig extends l{constructor(e,t,s){s.massSelect&&(s.randomizerEnabled=!1);const a=s.documentName??(0,n.Ng)(e);s.commonData||(s.commonData=function(e,t){t||(0,n.Ng)(e[0]);const s=e.map((e=>F(e,t)));return(0,n.m1)(s)}(t,a)),super(e.document?e.document:e,t,s),this.docName=a;let i=[];this.options.massSelect?i=[{title:(0,n.kg)("FILES.Search",!1),value:"search",icon:"fas fa-search"},{title:(0,n.kg)("form.search-and-edit"),value:"searchAndEdit",icon:"fas fa-search"}]:"Note"!==this.documentName||this.options.presetEdit?(i=[{title:(0,n.kg)("common.apply"),value:"apply",icon:"far fa-save"}],"Token"!==this.documentName||this.options.simplified||this.meObjects[0].constructor?.name?.startsWith("PrototypeToken")||this.options.presetEdit||i.push({title:(0,n.kg)("form.apply-update-proto"),value:"applyToPrototype",icon:"far fa-save"})):(this.meObjects.filter((e=>(e.scene??e.parent).id===canvas.scene.id)).length&&i.push({title:(0,n.kg)("form.apply-on-current-scene"),value:"currentScene",icon:"far fa-save"}),this.meObjects.filter((e=>(e.scene??e.parent).id!==canvas.scene.id)).length&&i.push({title:(0,n.kg)("form.apply-on-all-scenes"),value:"allScenes",icon:"fas fa-globe"})),this.massFormButtons=i}async _updateObject(e,t){await this.massUpdateObject(e,t),["Token","AmbientLight"].includes(this.docName)&&this.preview?.object&&this._resetPreview()}async massUpdateObject(e,t){if(!e.submitter?.value)return;const s=this.getSelectedFields(t);if("Token"===this.docName&&m.f.correctDetectionModeOrder(s,this.randomizeFields),!this.options.presetEdit)return this.options.massSelect?E(e.submitter.value,this.docName,s,{scope:this.modUpdate?this.modUpdateType:null}):C.call(this,s,this.meObjects,this.docName,e.submitter.value);this.options.callback?.({data:s,addSubtract:this.addSubtractFields,randomize:this.randomizeFields})}_performOnInputChangeUpdate(){const e=this.getSelectedFields();C.call(this,e,this.meObjects,this.docName,this.modUpdateType)}performMassCopy({command:e="",selectedFields:t=null}={}){if(t||(t=this.getSelectedFields(),"Token"===this.documentName&&m.f.correctDetectionModeOrder(t,this.randomizeFields)),foundry.utils.isEmpty(t))return!1;return L(new o.k({documentName:this.documentName,data:t,randomize:this.randomizeFields,addSubtract:this.addSubtractFields}),e,this.isPrototype),!0}_getHeaderButtons(){const e=super._getHeaderButtons();if(this.options.presetEdit)return e;if((n.Me.includes(this.docName)||n.lv.includes(this.docName))&&e.unshift({label:"",class:"mass-edit-macro",icon:"fas fa-terminal",onclick:()=>{const e=this.getSelectedFields();new MacroForm(this.object,this.meObjects,this.docName,e,this.randomizeFields,this.addSubtractFields).render(!0)}}),n.Me.includes(this.docName)&&e.unshift({label:"",class:"mass-edit-brush",icon:"fas fa-paint-brush",onclick:()=>{a.vM.activate({app:this})}}),["Token","Note","Actor"].includes(this.docName)){let t=[];const s=new Set;for(const e of this.meObjects){let a;"Actor"===this.docName||"JournalEntry"===this.docName?a=e:"Token"===this.docName&&e.actor?a=e.actor:"Note"===this.docName&&e.entry&&(a=e.entry),a&&!s.has(a.id)&&(t.push(a),s.add(a.id))}t.length&&e.unshift({label:"",class:"mass-edit-permissions",icon:"fas fa-lock fa-fw",onclick:()=>{new(j())(t[0],t).render(!0)}})}return this.options.simplified||e.unshift({label:"",class:"mass-edit-presets",icon:"fas fa-box",onclick:()=>{this.linkedPresetForm=new i.P(this,null,this.docName,{left:this.position.left-370,top:this.position.top,preventPositionOverride:!0}),this.linkedPresetForm.render(!0)}}),e.unshift({label:"",class:"mass-edit-apply",icon:"far fa-money-check-edit",onclick:e=>{let t=expandObject(this.getSelectedFields());t=foundry.utils.isEmpty(t)?"":JSON.stringify(t,null,2);let s=`<textarea class="json" style="width:100%; height: 300px;">${t}</textarea>`;new Dialog({title:(0,n.kg)("form.apply-json"),content:s,buttons:{apply:{label:(0,n.kg)("common.apply"),callback:e=>{let t={};try{t=JSON.parse(e.find(".json").val())}catch(e){}if(!foundry.utils.isEmpty(t)){const e=new o.k({documentName:this.docName,data:foundry.utils.flattenObject(t)});this._processPreset(e)}}}}}).render(!0)}}),game.settings.get(n.Do,"enableHistory")&&n.O8.includes(this.docName)&&e.unshift({label:"",class:"mass-edit-history",icon:"fas fa-history",onclick:()=>{new MassEditHistory(this.docName,(async e=>this._processPreset(e))).render(!0)}}),"Token"===this.documentName&&this.meObjects.filter((e=>e.actor)).length&&e.unshift({label:"",class:"mass-edit-actors",icon:"fas fa-user",onclick:()=>{(0,g.Pw)(this.meObjects,{massEdit:this.options.massEdit})&&this.close()}}),e}async activateListeners(e){await super.activateListeners(e),e.on("input",'textarea, input[type="text"], input[type="number"]',(()=>a.vM.refreshPreset())),e.on("change","textarea, input, select",(()=>a.vM.refreshPreset())),e.on("paste","input",(()=>a.vM.refreshPreset())),e.on("click","button",(()=>a.vM.refreshPreset()))}async close(e={}){return a.vM.deactivate(),e.force=!0,["Token","AmbientLight"].includes(this.docName)&&this.preview?.object&&this._resetPreview(),this.linkedPresetForm&&this.linkedPresetForm.close(),super.close(e)}render(e,t={}){if("update"===t.action)return;if(!this.form)return super.render(e,t);const s=this.getSelectedFields(),a=this.randomizeFields,n=this.addSubtractFields;super.render(e,t),setTimeout((()=>{this.form&&this._applyPreset(new o.k({data:s,randomize:a,addSubtract:n}))}),1e3)}async _processPreset(e){let t=!1;const s=foundry.utils.flattenObject(e.data[0]);"flags.monks-active-tiles.actions"in s&&(t=!0,await this.object.setFlag("monks-active-tiles","actions",s["flags.monks-active-tiles.actions"])),"flags.monks-active-tiles.files"in s&&(t=!0,await this.object.setFlag("monks-active-tiles","files",s["flags.monks-active-tiles.files"])),"flags.levels-3d-preview.shaders"in s&&(t=!0,await this.object.setFlag("levels-3d-preview","shaders",s["flags.levels-3d-preview.shaders"])),"flags.limits.light.enabled"in s&&(t=!0,await this.object.update({flags:{limits:expandObject(s).flags.limits}})),"Token"===this.documentName&&(t=m.f.modifyPresetData(this,s)),t?setTimeout((()=>{this._applyPreset(e)}),250):this._applyPreset(e)}_applyPreset(e){const t=$(this.form),s=(e,t)=>{if(!t)return e;for(const[s,a]of Object.entries(t))e[s]=a;return e};this.randomizeFields=s(this.randomizeFields,e.randomize),this.addSubtractFields=s(this.addSubtractFields,e.addSubtract),(0,r.RZ)(t,this.randomizeFields),(0,n.Tx)(t,this.addSubtractFields);const i=foundry.utils.flattenObject(e.data[0]);m.A.dataToForm(this.documentName,e.data[0],i);for(const e of Object.keys(i)){const s=t.find(`[name="${e}"]`);s.is(":checkbox")?s.prop("checked",i[e]):s.val(i[e]),s.trigger("change")}a.vM.refreshPreset()}get title(){return this.options.massSelect?(0,n.zS)("form.mass-search-title",{document:this.documentName}):(0,n.zS)("form.mass-edit-title",{document:this.documentName,count:this.meObjects.length})}}const c=`Mass${e}Config`;return Object.defineProperty(MassConfig.prototype.constructor,"name",{value:c}),MassConfig};function T(e,t,s=!1,a=!1){if(!e||!e.length)return!1;let i,o=e[0].document?e[0].document.documentName:e[0].documentName;if((t=t??R(o))||"Token"===o&&(t||(t=R("TokenProto"),i="applyToPrototype"),t||(t=R("Actor"),o="Actor",e=e.filter((e=>e.actor)).map((e=>e.actor)))),t){if(t.documentName!==o)return;const r={meObjects:e};foundry.utils.isEmpty(t.randomize)||(r.randomizeFields=t.randomize),foundry.utils.isEmpty(t.addSubtract)||(r.addSubtractFields=t.addSubtract);let l=foundry.utils.deepClone(t.data[Math.floor(Math.random()*t.data.length)]);return a&&(delete l.x,delete l.y,delete l.c),C.call(r,foundry.utils.flattenObject(l),e,t.documentName,i),s||ui.notifications.info((0,n.zS)("clipboard.paste",{document:t.documentName,count:e.length})),!0}return!1}function E(e,t,s,{scope:a=null,selected:i=null,control:o=!0,pan:r=!0}={}){const l=[];if("selected"===a)O(i,t,s,l);else if(n.lv.includes(t))O(Array.from(game.collections.get(t)),t,s,l);else{let e=[];"world"===a?e=Array.from(game.scenes):canvas.scene&&(e=[canvas.scene]);for(const a of e)P(a,t,s,l)}return o&&(canvas.activeLayer.controlled.map((e=>e)).forEach((e=>e.release())),setTimeout((()=>{l.forEach((e=>{let t=e.object??e;t.control&&t.control({releaseOthers:!1})})),r&&l.length&&game.settings.get(n.Do,"panToSearch")&&(0,n.w$)(l)}),100)),"searchAndEdit"===e&&setTimeout((()=>{(0,g.gx)(l,t)}),500),l}function P(e,t,s,a){O(Array.from(e[g.QH[t]]),t,s,a)}function O(e,t,s,a){for(const i of e){let e=!0;const o=foundry.utils.flattenObject((0,n.bQ)(i).toObject());m.A.dataToForm(t,i,o);for(const[a,i]of Object.entries(s))if(a.startsWith("flags.")){if(!(0,n.uv)(o,a,i)){e=!1;break}}else if(""!==i&&null!=i||""===o[a]&&null==o[a]){if("string"==typeof i&&i.includes("*")&&(0,n.dT)(i,o[a]));else if(o[a]!=i){if("Token"===t&&a.startsWith("detectionModes"))continue;e=!1;break}}else;if(e){if("Token"===t){const e=Object.values(foundry.utils.expandObject(s)?.detectionModes||{});if(!m.f.detectionModeMatch(e,i.detectionModes))continue}a.push(i)}}}async function C(e,t,s,a){if(this.options?.simplified)return void(this.options.callback&&this.options.callback(e));if(foundry.utils.isEmpty(e))return void(this.callbackOnUpdate&&this.callbackOnUpdate(t));const i=[],o={},l=(t=t.map((e=>e.document??e))).length;for(let s=0;s<l;s++){const a=foundry.utils.deepClone(e);a._id=t[s].id,i.push(a)}game.settings.get(n.Do,"enableHistory")&&(o["mass-edit-randomize"]=[foundry.utils.deepClone(this.randomizeFields)],o["mass-edit-addSubtract"]=[foundry.utils.deepClone(this.addSubtractFields)]),this&&await(0,r.of)(i,t,this.randomizeFields),this&&(0,n.YY)(i,t,s,this.addSubtractFields);for(let e=0;e<l;e++)m.A.formToData(s,t[e],i[e]);if(await N(s,i,t),"Actor"===s)for(let e=0;e<i.length;e++){const s=i[e];delete s._id,this.options?.tokens?this.options.tokens[e].actor.update(s):t[e].update(s)}else if("Scene"===s)Scene.updateDocuments(i,o);else if("PlaylistSound"===s)for(let e=0;e<t.length;e++)delete i[e]._id,t[e].update(i[e],o);else if("Note"===s){const e={};for(let s=0;s<i.length;s++){const n=t[s].scene??t[s].parent;"currentScene"===a&&n.id!==canvas.scene.id||(n.id in e||(e[n.id]={scene:n,updates:[]}),e[n.id].updates.push(i[s]))}for(const t of Object.values(e))t.scene.updateEmbeddedDocuments(s,t.updates,o)}else if(!this.isPrototype&&n.Me.includes(s)){const e={};for(let s=0;s<i.length;s++){const a=t[s].parent;e[a.id]||(e[a.id]=[]),e[a.id].push(i[s])}for(const t of Object.keys(e))game.scenes.get(t)?.updateEmbeddedDocuments(s,e[t],o)}else if(n.lv.includes(s))t[0].constructor?.updateDocuments(i,o);else{for(let e=0;e<i.length;e++){const s=i[e];delete s._id,(0,n.ht)(t[e],foundry.utils.mergeObject(t[e],s))}this.callbackOnUpdate&&this.callbackOnUpdate(t)}if(("applyToPrototype"===a||this.isPrototype)&&"Token"===s){const e={};for(let s=0;s<t.length;s++){const a=t[s].actor;a&&(e[a.id]={_id:a.id,prototypeToken:i[s]})}if(!foundry.utils.isEmpty(e)){const t=[];for(const s of Object.keys(e))t.push(e[s]);Actor.updateDocuments(t)}}}async function N(e,t,s){for(let a=0;a<t.length;a++){const n=t[a],i=s[a];if(n.hasOwnProperty("tokenmagic.ddTint")&&"undefined"!=typeof TokenMagic&&await l(i,n["tokenmagic.ddTint"]),n.hasOwnProperty("tokenmagic.preset")&&"undefined"!=typeof TokenMagic&&await d(i,n["tokenmagic.preset"],"subtract"===this?.addSubtractFields?.["tokenmagic.preset"]?.method),"Tile"===e){if(n.hasOwnProperty("massedit.scale")){const e=n["massedit.scale"];n.width=i.width*e,n.height=i.height*e,null!=i.flags?.["levels-3d-preview"]?.depth?n["flags.levels-3d-preview.depth"]=i.flags["levels-3d-preview"].depth*=e:null!=i["flags.levels-3d-preview.depth"]&&(n["flags.levels-3d-preview.depth"]=i["flags.levels-3d-preview.depth"]*e)}n.hasOwnProperty("massedit.texture.scale")&&(n["texture.scaleX"]=n["massedit.texture.scale"],n["texture.scaleY"]=n["massedit.texture.scale"],delete n["massedit.texture.scale"])}}}async function _(e){if("mass-edit-control"===e.target.className&&!e.target.checked)return void A(e.target);const t=$(e.target).closest(".form-group").find(".mass-edit-checkbox input");t.prop("checked",!0),M(t[0]),this&&this.options.massEdit&&this._performOnInputChangeUpdate&&this.modUpdate&&this._performOnInputChangeUpdate()}function M(e){const t=$(e).parent().closest("div.tab, div.matt-tab");t.length&&(t.siblings("nav.tabs").find(`[data-tab="${t.attr("data-tab")}"]`).addClass("mass-edit-tab-selected"),M(t[0]))}function A(e){const t=$(e).parent().closest("div.tab, div.matt-tab");t.length&&0===t.find(".mass-edit-checkbox input:checked").length&&(t.siblings("nav.tabs").find(`[data-tab="${t.attr("data-tab")}"]`).removeClass("mass-edit-tab-selected"),A(t[0]))}function F(e,t){const s=foundry.utils.flattenObject((0,n.bQ)(e).toObject());return m.A.dataToForm(t,e,s),s}const j=()=>{let e=S(DocumentOwnershipConfig);return class MassPermissions extends e{constructor(e,t,s={}){const a=(0,n.bQ)(t[0]),i=foundry.utils.flattenObject(a.ownership),o=CONST.DOCUMENT_META_OWNERSHIP_LEVELS,r=function(e){game.users.forEach((t=>{t.id in e||(e[t.id]=o.DEFAULT)})),"default"in e||(e.default=o.DEFAULT)};r(i);for(let e=1;e<t.length;e++){const s=(0,n.bQ)(t[e]),a=foundry.utils.flattenObject(s.ownership);r(a);const o=foundry.utils.flattenObject(foundry.utils.diffObject(i,a));for(const e of Object.keys(o))delete i[e]}s.commonData=i,s.massPermissions=!0,super(e,t,s)}async _updateObject(e,t){const s=this.getSelectedFields(t),a=CONST.DOCUMENT_META_OWNERSHIP_LEVELS;if(foundry.utils.isEmpty(s))return;const i=new Set,o=[];for(const e of this.meObjects)if(!i.has(e.id)){const t=(0,n.bQ)(e),r=foundry.utils.deepClone(t.ownership);for(let[e,t]of Object.entries(s))t===a.DEFAULT?delete r[e]:r[e]=t;i.add(e.id),o.push({_id:e.id,ownership:r})}this.meObjects[0].constructor.updateDocuments(o,{diff:!1,recursive:!1,noHook:!0})}get title(){return`Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`}}},I={};function L(e,t,s){I[e.documentName]=e,"Token"===e.documentName&&s?I.TokenProto=e:"Token"===e.documentName&&"copyProto"===t&&(delete I.Token,I.TokenProto=e),game.clipboard.copyPlainText(JSON.stringify(foundry.utils.deepClone(1===e.data.length?e.data[0]:e.data),null,2)),ui.notifications.info((0,n.zS)("clipboard.copy",{document:e.documentName}))}function z(e){delete I[e],"Token"===e&&delete I.TokenProto}function R(e){return I[e]}},789:(e,t,s)=>{s.d(t,{s:()=>MassEditGenericForm});const a={field:{shieldType:{range:!0,min:"0",max:"13",step:"1"},blend:{range:!0,min:"0",max:"16",step:"1"},scale:{range:!0,min:"0",max:"5",step:"0.01"},radius:{range:!0,min:"0",max:"5",step:"0.01"},intensity:{range:!0,min:"0",max:"5",step:"0.01"},lightAlpha:{range:!0,min:"0",max:"50",step:"0.1"},gridPadding:{range:!0,min:"0",max:"5",step:"0.01"},lightSize:{range:!0,min:"0",max:"20",step:"0.1"},animated:{time:{speed:{range:!0,min:"0",max:"0.05",step:"0.0001"}}}},fire:{fireBlend:{range:!0,min:"0",max:"13",step:"1"},blend:{range:!0,min:"0",max:"13",step:"1"},animated:{intensity:{animType:{select:!0,options:["syncChaoticOscillation","syncSinOscillation","syncCosOscillation","chaoticOscillation","halfSinOscillation","sinOscillation","halfCosOscillation","cosOscillation","syncColorOscillation","halfColorOscillation","colorOscillation"]},val2:{range:!0,min:"0",max:"5",step:"0.1"},val1:{range:!0,min:"0",max:"5",step:"0.1"},loopDuration:{range:!0,min:"0",max:"50000",step:"100"}},amplitude:{animType:{select:!0,options:["syncChaoticOscillation","syncSinOscillation","syncCosOscillation","chaoticOscillation","halfSinOscillation","sinOscillation","halfCosOscillation","cosOscillation","syncColorOscillation","halfColorOscillation","colorOscillation"]},loopDuration:{range:!0,min:"0",max:"50000",step:"100"},val1:{range:!0,min:"0",max:"5",step:"0.1"},val2:{range:!0,min:"0",max:"5",step:"0.1"}}},intensity:{range:!0,min:"0",max:"100",step:"0.1"}},electric:{blend:{range:!0,min:"0",max:"13",step:"1"}},xglow:{auraType:{range:!0,min:"0",max:"2",step:"1"},scale:{range:!0,min:"0",max:"30",step:"0.1"},auraIntensity:{range:!0,min:"0",max:"20",step:"0.1"},subAuraIntensity:{range:!0,min:"0",max:"20",step:"0.1"},threshold:{range:!0,min:"0",max:"2",step:"0.01"},thickness:{range:!0,min:"0",max:"20",step:"0.1"}},glow:{outerStrength:{range:!0,min:"0",max:"50",step:"0.1"},innerStrength:{range:!0,min:"0",max:"50",step:"0.1"},padding:{range:!0,min:"0",max:"100",step:"1"},alpha:{range:!0,min:"0",max:"1",step:"0.01"}},zapshadow:{alphaTolerance:{range:!0,min:"0",max:"1",step:"0.01"}},sprite:{blendMode:{range:!0,min:"0",max:"16",step:"1"},gridPadding:{range:!0,min:"0",max:"5",step:"0.1"},scaleX:{range:!0,min:"0",max:"3",step:"0.01"},scaleY:{range:!0,min:"0",max:"3",step:"0.01"},translationX:{range:!0,min:"-1",max:"1",step:"0.001"},translationY:{range:!0,min:"-1",max:"1",step:"0.001"},rotation:{range:!0,min:"0",max:"360",step:"1"},alpha:{range:!0,min:"0",max:"1",step:"0.01"}},xfire:{blend:{range:!0,min:"0",max:"16",step:"1"},amplitude:{range:!0,min:"0",max:"10",step:"0.01"},dispersion:{range:!0,min:"0",max:"20",step:"0.1"},scaleX:{range:!0,min:"0",max:"5",step:"0.01"},scaleY:{range:!0,min:"0",max:"5",step:"0.01"},animated:{time:{speed:{range:!0,min:"-0.0050",max:"0.0050",step:"0.0001"}}}},transform:{gridPadding:{range:!0,min:"0",max:"50",step:"0.1"},scaleX:{range:!0,min:"0",max:"5",step:"0.1"},scaleY:{range:!0,min:"0",max:"5",step:"0.1"}},ascii:{animated:{size:{val1:{range:!0,min:"-5",max:"5",step:"0.01"},val2:{range:!0,min:"-5",max:"5",step:"0.01"}}},size:{range:!0,min:"1",max:"64",step:"1"}},dot:{scale:{range:!0,min:"0",max:"10",step:"0.1"},angle:{range:!0,min:"0",max:"360",step:"1"}},godray:{blendMode:{range:!0,min:"0",max:"20",step:"1"},padding:{range:!0,min:"-5",max:"50",step:"0.1"}},rgbSplit:{redX:{range:!0,min:"-50",max:"50",step:"1"},redY:{range:!0,min:"-50",max:"50",step:"1"},greenX:{range:!0,min:"-50",max:"50",step:"1"},greenY:{range:!0,min:"-50",max:"50",step:"1"},blueX:{range:!0,min:"-50",max:"50",step:"1"},blueY:{range:!0,min:"-50",max:"50",step:"1"}},polymorph:{type:{range:!0,min:"0",max:"9",step:"1"}},shadow:{blur:{range:!0,min:"0",max:"20",step:"1"}},flood:{billowy:{range:!0,min:"0",max:"5",step:"0.01"},tintIntensity:{range:!0,min:"0.0",max:"1",step:"0.01"},glint:{range:!0,min:"0",max:"1",step:"0.01"},scale:{range:!0,min:"5",max:"500",step:"1"},animated:{time:{speed:{range:!0,min:"0.00001",max:"0.001",step:"0.00001"}}}}};var n=s(120),i=s(208),o=s(739),r=s(30);const l=(0,i.dN)();class MassEditGenericForm extends l{constructor(e,t={}){const s=e.map((e=>e.toObject?e.toObject():e));let i={};for(let e=s.length;e>=0;e--)foundry.utils.mergeObject(i,s[e]);t.noTabs&&(i=foundry.utils.flattenObject(i));let o=t.documentName??"NONE",l=foundry.utils.mergeObject(a[o]??{},game.settings.get(n.Do,"customControls")[o]??{});l=foundry.utils.mergeObject(l,t.customControls?.[o]??{});const[c,d]=(0,r.R)(i,o,l,!t.noTabs),u=(0,n.m1)(s);super(e[0],e,{tabs:d,commonData:u,...t}),this.allData=i,this.nav=c,this.editableLabels={},this.pinnedFields=game.settings.get(n.Do,"pinnedFields")[this.documentName]??{},this.customControls=l,t.callback&&(this.callbackOnUpdate=t.callback)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-generic-form",classes:["sheet"],template:`modules/${n.Do}/templates/generic/genericForm.html`,resizable:!0,minimizable:!1,title:"Generic",width:500,height:"auto"})}_getHeaderButtons(){const e=super._getHeaderButtons();return this.options.tokens&&e.unshift({label:"",class:"mass-edit-tokens",icon:"fas fa-user-circle",onclick:()=>{(0,o.gx)(this.options.tokens,"Token"),this.close()}}),e}async getData(e){const t=await super.getData(e);return await getTemplate(`modules/${n.Do}/templates/generic/navHeaderPartial.html`,"me-navHeaderPartial"),await getTemplate(`modules/${n.Do}/templates/generic/form-group.html`,"me-form-group"),t.nav=this.nav,t}activateListeners(e){super.activateListeners(e),e.find(".me-pinned").click((e=>{const t=$(e.target).parent(),s=t.closest(".form-group").find("[name]").attr("name");t.hasClass("active")?(t.removeClass("active"),delete this.pinnedFields[s]):(t.addClass("active"),this.pinnedFields[s]={label:s})})),e.find(".me-editable-label").on("input",(e=>{const t=$(e.target).closest(".form-group").find("[name]").attr("name");this.editableLabels[t]=e.target.value})),e.find(".color-number").on("change",(e=>{if(e.target.dataset?.editNumber){let t=0;try{t=Number(Color.fromString(e.target.value))}catch(e){}$(e.target).siblings(`[name="${e.target.dataset.editNumber}"]`).val(t).trigger("input")}})),e.find(".me-editable-label, label").on("contextmenu",(e=>{const t=$(e.target).closest(".form-group");if(!t.length)return;const s=t.find("[name]"),a=s.attr("name");if(a){if((0,r._)(a))return;const e=s.attr("type");if("range"===e)return void function(e,t){const s=game.settings.get(n.Do,"customControls");let a=s[t]||{};setProperty(a,e,null),game.settings.set(n.Do,"customControls",s)}(a,this.documentName);"number"===e?function(e,t,s,a,{min:i=null,max:o=null,step:r=null}={}){let l=`\n<div class="form-group slim">\n  <label>Range</label>\n  <div class="form-fields">\n    <label>${(0,n.kg)("Minimum",!1)}</label>\n    <input type="number" value="${i??t}" name="min" step="any">\n    <label>${(0,n.kg)("Maximum",!1)}</label>\n    <input type="number" value="${o??t}" name="max" step="any">\n    <label>${(0,n.kg)("generic-form.step-size")}</label>\n    <input type="number" value="${r??1}" name="step" step="any">\n  </div>\n</div>\n  `;new Dialog({title:(0,n.kg)("generic-form.define-range"),content:l,buttons:{save:{label:(0,n.kg)("Save",!1),callback:async i=>{const o=i.find('[name="min"]').val()||t,r=i.find('[name="max"]').val()||t,l=i.find('[name="step"]').val()||1;setProperty(s,e,{range:!0,min:o,max:r,step:l});const c=game.settings.get(n.Do,"customControls");c[a]=s,game.settings.set(n.Do,"customControls",c)}}}}).render(!0)}(a,s.val(),this.customControls,this.documentName):"text"===e&&function(e,t,s,a,{options:i=null}={}){let o=`\n<div class="form-group slim">\n  <label>${(0,n.kg)("common.options")}</label>\n  <textarea name="options">${i?i.join("\n"):t}</textarea>\n</div>\n  `;new Dialog({title:(0,n.kg)("generic-form.define-dropdown"),content:o,buttons:{save:{label:(0,n.kg)("Save",!1),callback:async t=>{const i=t.find('[name="options"]').val().trim();if(i){setProperty(s,e,{select:!0,options:i.split("\n").filter((e=>e))});const t=game.settings.get(n.Do,"customControls");t[a]=s,game.settings.set(n.Do,"customControls",t)}}}}}).render(!0)}(a,s.val(),this.customControls,this.documentName)}})),this.options.inputChangeCallback&&e.on("change","input, select",(async e=>{setTimeout((()=>this.options.inputChangeCallback(this.getSelectedFields())),100)}))}async _updateObject(e,t){super._updateObject(e,t);const s=game.settings.get(n.Do,"pinnedFields");s[this.documentName]=this.pinnedFields;for(const e of Object.keys(this.pinnedFields))this.pinnedFields[e].value=t[e];if(!foundry.utils.isEmpty(this.editableLabels)){for(const[e,s]of Object.entries(this.editableLabels))e in this.pinnedFields&&(this.pinnedFields[e].label=s,this.pinnedFields[e].value=t[e]);this.editableLabels={}}game.settings.set(n.Do,"pinnedFields",s)}async close(e={}){return this.callbackOnUpdate&&this.callbackOnUpdate(null),super.close(e)}}},30:(e,t,s)=>{s.d(t,{R:()=>n,_:()=>d});var a=s(120);function n(e,t,s,n=!0){const o={dataGroup:"main",items:[],tabs:[]},r=[{navSelector:'.tabs[data-group="main"]',contentSelector:"form",initial:"me-pinned"}];let l={};l=e;const c=t&&game.settings.get(a.Do,"pinnedFields")[t]||{};i(o,l,r,"",c,s,n);const d=[],m=foundry.utils.flattenObject(l);for(const[e,t]of Object.entries(c)){const a=e in m?m[e]:t.value;let i=u(foundry.utils.getType(a),t.label,a,e,{},!0,s,n);i.pinned=!0,d.push(i)}return d.length&&(o.items.length||(o.items.push({dataTab:"main-me-main",label:"Main"}),o.tabs.push({dataTab:"main-me-main",groups:o.groups}),delete o.groups),o.items.unshift({dataTab:"me-pinned",dataTab:"me-pinned",label:(0,a.kg)("generic-form.pinned")}),o.tabs.unshift({dataTab:"me-pinned",groups:d})),[o,r]}function i(e,t,s,a,n,l,c){const d=[];let m=!1;for(const[h,g]of Object.entries(t)){const t=a?a+"."+h:h;if(null!==g){let a,p=foundry.utils.getType(g);if("Object"===p){if(o(g)){e.items.push({dataTab:t,label:r(h)});const a={dataGroup:t,items:[],tabs:[]};e.tabs.push({dataTab:t,nav:a}),s.push({navSelector:`.tabs[data-group="${t}"]`,contentSelector:`.tab[data-tab="${t}"]`,initial:h+"-me-main"}),i(a,g,s,t,n,l,c),m=!0}}else a=u(p,r(h),g,t,n,!1,l,c);a&&d.push(a)}}d.length&&(m?(e.items.unshift({dataTab:e.dataGroup+"-me-main",label:"Main"}),e.tabs.unshift({dataTab:e.dataGroup+"-me-main",groups:d})):e.groups=d)}function o(e){if(foundry.utils.isEmpty(e))return!1;for(const[t,s]of Object.entries(e))if("Object"===foundry.utils.getType(s)){if(o(s))return!0}else if(null!=s)return!0;return!1}function r(e){return e.length<=3?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)}const l=["img","image","src","texture"],c=["tint"];function d(e){return e=e.split(".").pop(),c.includes(e)||e.toLowerCase().includes("color")}function u(e,t,s,a,n,i=!1,o={},r){const c=["number","string"];let u={label:t,value:s,name:a,editableLabel:i,pins:r};if(getProperty(o,a))u=foundry.utils.mergeObject(u,getProperty(o,a));else if("number"===e){u.number=!0;if(d(a.split(".").pop())){u.colorPickerNumber=!0;try{u.colorValue=new Color(s).toString()}catch(e){}}}else if("string"===e){u.text=!0;const e=a.split(".").pop();l.includes(e)||e.toLowerCase().includes("image")||e.toLowerCase().includes("path")?u.filePicker=!0:d(e)&&(u.colorPicker=!0)}else"boolean"===e?u.boolean=!0:"Array"===e&&s.every((e=>c.includes(foundry.utils.getType(e))))?(u.value=s.join(", "),u.array=!0):"Array"===e?(u.jsonArray=!0,u.value=JSON.stringify(s,null,2)):(u.disabled=!0,u.text=!0,u.editableLabel=!1);return u&&a in n&&(u.pinned=!0,u.disabled=!0,u.name=null),u}},739:(e,t,s)=>{s.d(t,{CM:()=>y,G_:()=>g,Ls:()=>b,Pw:()=>f,QH:()=>c,ef:()=>h,gx:()=>p,i2:()=>l});var a=s(860),n=s(652),i=s(120),o=s(208),r=s(789);const l={Token:"tokens",Tile:"tiles",Drawing:"drawings",Wall:"walls",AmbientLight:"lighting",AmbientSound:"sounds",MeasuredTemplate:"templates",Note:"notes"},c={Token:"tokens",Tile:"tiles",Drawing:"drawings",Wall:"walls",AmbientLight:"lights",AmbientSound:"sounds",MeasuredTemplate:"templates",Note:"notes"};function d(){return canvas.activeLayer.controlled.length?canvas.activeLayer.controlled:null}function u(){let e=canvas.activeLayer.constructor.documentName;return!["Wall"].includes(e)&&canvas.activeLayer.hover?[canvas.activeLayer.hover]:null}function m(e){const t=[{name:"Actor",class:"actor"},{name:"Scene",class:"scene"},{name:"JournalEntry",class:"journalentry"},{name:"Playlist",class:"sound"},{name:"Item",class:"item"},{name:"RollTable",class:"rolltable"},{name:"Cards",class:"cards"}];for(const s of t){const t=[];if($(`.directory-list .${s.class}.selected`).each((function(a){let n;n="Playlist"===s.name?game.collections.get(s.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId):game.collections.get(s.name).get(this.dataset.documentId),n&&(e&&"JournalEntry"===s.name?game.collections.get("Scene").forEach((e=>e.notes.forEach((e=>{const s=e.entryId??e.data.entryId;n.id===s&&t.push(e)})))):n&&t.push(n))})),t.length)return t}return null}function h(e,t=!0){let s;e&&(s=Array.isArray(e)?e:[e]),s||(s=m(t)),s||(s=d()),s&&s.length>1&&null!=s[0].x&&null!=s[0].y&&s.sort(((e,t)=>{const s=e.y-t.y;return 0===s?e.x-t.x:s}));let a=u();return a=a?a[0]:a,!s&&a&&(s=[a]),!a&&s&&(a=s[0]),a||s?(a&&(0,i.Ng)(a)!==(0,i.Ng)(s[0])&&(a=s[0]),[a,s]):[null,null]}function g(e){let[t,s]=h(e);if(!t)return void(0,a.R)();const n=(0,i.Ng)(t),l={commonData:foundry.utils.flattenObject((0,i.bQ)(t).toObject()),massSelect:!0,documentName:n};if(i.qE.includes(n)&&"Actor"!==n){new((0,o.dN)(n))(t,s,l).render(!0,{})}else i.lv.includes(n)&&new r.s(s,l).render(!0)}async function p(e=null,t,s={}){let[a,n]=h(e);if(n&&n.length){if(s.forceForm||!game.settings.get(i.Do,"singleDocDefaultConfig")||1!==n.length){if(t||(t=(0,i.Ng)(a)),s={...s,massEdit:!0,documentName:t},i.qE.includes(t)){"Actor"===t&&(a=a.prototypeToken,n=n.map((e=>e.prototypeToken)),s.documentName="Token");return new((0,o.dN)(s.documentName))(a,n,s).render(!0,{})}return new r.s(n,s).render(!0)}n[0].sheet&&n[0].sheet.render(!0,{})}}function f(e,t){const s=[],a=[];return e.forEach((e=>{e.actor&&(s.push(e),a.push(e.actor))})),!!a.length&&(new r.s(a,{tokens:s,documentName:"Actor",...t}).render(!0),!0)}function y(){let e;if(e||(e=m()),e||(e=d()),e||(e=u()),e)return(0,o.B0)(e);{let e=canvas.activeLayer.constructor.documentName;const t=(0,o.bE)(e);if(t)return n.af.spawnPreset({preset:t}),!0}return!1}function b(e,t="GenericData",s){return new Promise((a=>{new r.s(Array.isArray(e)?e:[e],{documentName:t,callback:()=>a(),...s}).render(!0)}))}},241:(e,t,s)=>{s.d(t,{Xt:()=>l,Yv:()=>r,vM:()=>Brush});var a=s(208),n=s(652),i=s(671),o=s(120);class Brush{static app;static deactivateCallback;static spawner;static lastSpawnTime;static preset;static brushOverlay;static updatedPlaceables=new Map;static hoveredPlaceables=new Set;static hoveredPlaceable;static documentName;static active=!1;static hitTest;static registered3dListener=!1;static{this._boundOn3DBrushClick=this._on3DBrushClick.bind(this),this._boundOn3dMouseMove=this._on3dMouseMove.bind(this)}static _performBrushDocumentUpdate(e,t){e&&this._animateCrossTranslate(e.x,e.y),(0,a.B0)([t],this.preset,!0,!0),this.updatedPlaceables.set(t.id,t)}static _performBrushDocumentCreate(e){const t=(new Date).getTime();(!this.lastSpawnTime||t-this.lastSpawnTime>100)&&(this.lastSpawnTime=t,n.af.spawnPreset({preset:this.preset,...e,center:!0}))}static _hitTestWall(e,t){return t.line.hitArea.contains(e.x,e.y)}static _hitTestControlIcon(e,t){return Number.between(e.x,t.x-t.controlIcon.width/2,t.x+t.controlIcon.width/2)&&Number.between(e.y,t.y-t.controlIcon.height/2,t.y+t.controlIcon.height/2)}static _hitTestTile(e,t){const s=ui.controls.control.foreground??!1;return t.document.overhead===s&&this._hitTestArea(e,t)}static _hoverTestArea(e){return this.hoveredPlaceable&&this.hoveredPlaceable.hitArea.width*this.hoveredPlaceable.hitArea.height>e.hitArea.width*e.hitArea.height}static _hitTestArea(e,t){return Number.between(e.x,t.x,t.x+t.hitArea.width)&&Number.between(e.y,t.y,t.y+t.hitArea.height)}static _onBrushMove(e){const t=e.data.getLocalPosition(this.brushOverlay),s=canvas.getLayerByEmbeddedName(this.documentName);this._clearHover(e,t);for(const a of s.placeables)a.visible&&this.hitTest(t,a)&&!this.updatedPlaceables.has(a.id)&&this.hoveredPlaceable!==a&&(this.hoverTest?.(a)||!this.hoverTest&&this.hoveredPlaceable&&this.hoveredPlaceable!==a?(this.hoveredPlaceable._onHoverOut(e),this.hoveredPlaceable=a):this.hoveredPlaceable||(this.hoveredPlaceable=a),this.hoveredPlaceable._onHoverIn(e))}static _clearHover(e,t,s=!1){this.hoveredPlaceable&&(!s&&this.hoveredPlaceable.visible&&this.hitTest(t,this.hoveredPlaceable)||(this.hoveredPlaceable._onHoverOut(e),this.hoveredPlaceable=null))}static _onBrushClickMove(e){this.spawner?this._performBrushDocumentCreate(e.data.getLocalPosition(this.brushOverlay)):this.hoveredPlaceable&&this.hoveredPlaceable.visible&&!this.updatedPlaceables.has(this.hoveredPlaceable.id)&&this._performBrushDocumentUpdate(e.data.getLocalPosition(this.brushOverlay),this.hoveredPlaceable)}static _on3DBrushClick(e){if(this.brush3d)if(this.spawner){if(this.brush3d?.position){const e=game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.brush3d.position);this._performBrushDocumentCreate({x:e.x,y:e.y,z:e.z})}}else{const e=game.Levels3DPreview.interactionManager.currentHover?.placeable;e&&e.document.documentName===this.documentName&&(game.Levels3DPreview.interactionManager._downCameraPosition.set(0,0,0),this._performBrushDocumentUpdate(null,e)),this.updatedPlaceables.clear()}}static refreshPreset(){this.active&&this.app&&(this.preset=new i.k({documentName:this.documentName,data:this.app.getSelectedFields(),randomize:this.app.randomizeFields,addSubtract:this.app.addSubtractFields}))}static activate({app:e=null,preset:t=null,deactivateCallback:s=null,spawner:a=!1}={}){if(this.deactivate()||!canvas.ready)return!1;if(!e&&!t)return!1;this.brushOverlay&&this.brushOverlay.destroy(!0),this.app=e,this.preset=t,this.deactivateCallback=s,this.spawner=a,this.app?this.documentName=this.app.documentName:this.documentName=this.preset.documentName,this.updatedPlaceables.clear();const n=canvas.app.renderer.events;if(n.cursorStyles.brush||(n.cursorStyles.brush=`url('modules/${o.Do}/images/brush_icon.png'), auto`,n.cursorStyles.brush_spawn=`url('modules/${o.Do}/images/brush_icon_spawn.png'), auto`),this.active=!0,this.refreshPreset(),game.Levels3DPreview?._active)return this._activate3d();if(this.spawner)this.hitTest=()=>!1;else switch(this.documentName){case"Wall":this.hitTest=this._hitTestWall;break;case"AmbientLight":case"MeasuredTemplate":case"AmbientSound":case"Note":this.hitTest=this._hitTestControlIcon;break;case"Tile":this.hitTest=this._hitTestTile,this.hoverTest=this._hoverTestArea;break;default:this.hitTest=this._hitTestArea,this.hoverTest=this._hoverTestArea}return this.brushOverlay=new PIXI.Container,this.brushOverlay.hitArea=canvas.dimensions.rect,this.brushOverlay.cursor=a?"brush_spawn":"brush",this.brushOverlay.interactive=!0,this.brushOverlay.zIndex=1/0,this.brushOverlay.on("mousemove",(e=>{this._onBrushMove(e),1===e.buttons&&this._onBrushClickMove(e)})),this.brushOverlay.on("mouseup",(e=>{2!==e.nativeEvent.which&&this._onBrushClickMove(e),this.updatedPlaceables.clear()})),this.brushOverlay.on("click",(e=>{2==e.nativeEvent.which&&this.deactivate()})),canvas.stage.addChild(this.brushOverlay),canvas.mouseInteractionManager.permissions.clickLeft=!1,!0}static brush3dDelayMoveTimer;static _on3dMouseMove(){if(!this.brush3d||this.brush3dDelayMoveTimer)return;const e=this;this.brush3dDelayMoveTimer=setTimeout((function(){const t=game.Levels3DPreview.interactionManager.canvas3dMousePosition,s=game.Levels3DPreview.interactionManager.camera.position,a=game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(s,t,"collision",!1,!1,!1,!0);if(a[0]){const t=a[0];e.brush3d.position.set(t.point.x,t.point.y,t.point.z)}e.brush3dDelayMoveTimer=null}),100)}static deactivate3DListeners(){game.Levels3DPreview.renderer.domElement.removeEventListener("click",this._boundOn3DBrushClick,!1),game.Levels3DPreview.renderer.domElement.removeEventListener("mousemove",this._boundOn3dMouseMove,!1)}static _activate3DListeners(){this.deactivate3DListeners(),game.Levels3DPreview.renderer.domElement.addEventListener("click",this._boundOn3DBrushClick,!1),game.Levels3DPreview.renderer.domElement.addEventListener("mousemove",this._boundOn3dMouseMove,!1)}static _activate3d(){const e=game.Levels3DPreview.THREE;if(!this.brush3d){this.brush3d=new e.Mesh(new e.SphereGeometry(.01,8,8),new e.MeshBasicMaterial({opacity:.5,transparent:!0,color:65280,wireframe:!0})),this.brush3d.userData.interactive=!1,this.brush3d.userData.ignoreHover=!0;const t=game.Levels3DPreview.interactionManager.canvas3dMousePosition;this.brush3d.position.set(t.x,t.y,t.z),game.Levels3DPreview.scene.add(this.brush3d)}return this._activate3DListeners(),!0}static deactivate(){if(this.active)return canvas.mouseInteractionManager.permissions.clickLeft=!0,this.brushOverlay&&this.brushOverlay.parent?.removeChild(this.brushOverlay),this.brush3d&&game.Levels3DPreview?._active&&(game.Levels3DPreview.scene.remove(this.brush3d),this.brush3d=null,this.deactivate3DListeners()),this.active=!1,this.updatedPlaceables.clear(),this._clearHover(null,null,!0),this.hoverTest=null,this.deactivateCallback?.(),this.spawner=!1,this.deactivateCallback=null,this.app=null,this.preset=null,!0}static async _animateCrossTranslate(e,t){let s=new PIXI.Text("+",{fontFamily:"Arial",fontSize:11,fill:65297,align:"center"});s=this.brushOverlay.addChild(s),s.x=e+16*Math.random()-8,s.y=t;const a=[{parent:s,attribute:"y",to:t-50}];await CanvasAnimation.animate(a,{duration:700,name:foundry.utils.randomID(5)})&&this.brushOverlay.removeChild(s).destroy()}}async function r(e,t="spawn"){const s=await n.af.getPreset(e);s&&Brush.activate({preset:s,spawner:"spawner"===t})}function l(){Brush.deactivate()}},860:(e,t,s)=>{s.d(t,{R:()=>i,h:()=>o});var a=s(739),n=s(120);function i(){let e="";for(const t of n.Me.concat(n.lv))e+=`<option value="${t}">${t}</option>`;e=`<label>${(0,n.kg)("dialog.search-document")}</label>\n    <select style="width: 100%;" name="documentName">${e}</select>`,new Dialog({title:"Document SEARCH",content:e,buttons:{select:{icon:'<i class="fas fa-check"></i>',label:"Select",callback:e=>{const t=e.find("select[name='documentName']").val();let s=[];if(n.Me.includes(t)){const e=a.i2[t];e&&canvas[e].placeables.length&&(s=canvas[e].placeables)}else s=Array.from(game.collections.get(t));s.length?(0,a.G_)(s[0]):ui.notifications.warn((0,n.zS)("dialog.document-not-found",{document:t}))}}}}).render(!0)}async function o(){const e=`\n  <div class="form-group">\n      <label for="data">${(0,n.kg)("FILES.SelectFile",!1)} </label>\n      <input type="file" name="data">\n  </div>\n  `;let t=new Promise(((t,s)=>{new Dialog({title:(0,n.kg)("presets.import"),content:e,buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:(0,n.kg)("common.import"),callback:async e=>{let s;readTextFromFile(e.find('[name="data"]')[0].files[0]).then((e=>{try{s=JSON.parse(e)}catch(e){}t(s)}))}},no:{icon:'<i class="fas fa-times"></i>',label:(0,n.kg)("Cancel",!1),callback:()=>t(!1)}},default:"no"},{width:400}).render(!0)}));return await t}},971:(e,t,s)=>{s.r(t),s.d(t,{DataTransform:()=>DataTransform,Picker:()=>Picker,editPreviewPlaceables:()=>i});var a=s(575),n=s(120);class Picker{static pickerOverlay;static boundStart;static boundEnd;static callback;static isActive(){return Boolean(this.pickerOverlay)}static addRotation(e){this._rotation+=e,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static addScaling(e){this._scale+=e,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static async activate(e,t){this.destroy();const s=new PIXI.Container;if(this.callback=e,t){let e;t.label&&(e=new PreciseText(t.label,{...CONFIG.canvasTextStyle,_fontSize:24}),e.anchor.set(.5,1),s.addChild(e));let n,{previews:i,layer:o,previewDocuments:r}=await this._genPreviews(t);this._rotation=0,this._scale=1,n=t.center?(0,a.Ym)(t.previewData):{x:0,y:0};const l=function(c){if(!c)return;t.center&&(n=(0,a.Ym)(t.previewData)),t.snap&&o&&!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)&&(c=canvas.grid.getSnappedPosition(c.x,c.y,o.gridPrecision));const d="Wall"===i[0].document.documentName?i[0].document.c[0]:i[0].document.x,u="Wall"===i[0].document.documentName?i[0].document.c[1]:i[0].document.y;let m={x:c.x-d-n.x,y:c.y-u-n.y};0!=Picker._rotation&&(m.rotation=Picker._rotation,Picker._rotation=0),1!=Picker._scale&&(m.scale=Picker._scale,Picker._scale=1);for(const e of i){const t=e.document;DataTransform.apply(t.documentName,e._pData??t,c,m,e),e.document.alpha=.4,e.renderFlags.set({refresh:!0}),e.visible=!0,e.z||(e.z=e.document.z),e.z&&(e.document.z=e.z+9999999),e.controlIcon&&!e.controlIcon._meVInsert&&(e.controlIcon.alpha=.4,Object.defineProperty(e.controlIcon,"visible",{get:function(){return!0},set:function(){}}),e.controlIcon._meVInsert=!0)}e&&(e.x=c.x,e.y=c.y-38),s.previewDocuments=r,t.center&&null!=m.scale&&l(c)};s.on("pointermove",(e=>{l(e.data.getLocalPosition(s))})),l(canvas.mousePosition),l(canvas.mousePosition),s.setPositions=l}s.hitArea=canvas.dimensions.rect,s.cursor="crosshair",s.interactive=!0,s.zIndex=1/0,s.on("remove",(()=>s.off("pick"))),s.on("mousedown",(e=>{Picker.boundStart=e.data.getLocalPosition(s)})),s.on("mouseup",(e=>{Picker.boundEnd=e.data.getLocalPosition(s)})),s.on("click",(e=>{if(2==e.nativeEvent.which)this.callback?.(null);else{const e=Math.min(this.boundStart.x,this.boundEnd.x),t=Math.max(this.boundStart.x,this.boundEnd.x),s=Math.min(this.boundStart.y,this.boundEnd.y),a=Math.max(this.boundStart.y,this.boundEnd.y);this.callback?.({start:{x:e,y:s},end:{x:t,y:a}})}s.parent?.removeChild(s),s.previewDocuments&&s.previewDocuments.forEach((e=>canvas.getLayerByEmbeddedName(e)?.clearPreviewContainer())),this.destroy()})),this.pickerOverlay=s,canvas.stage.addChild(this.pickerOverlay)}static destroy(){this.pickerOverlay&&(canvas.stage.removeChild(this.pickerOverlay),this.pickerOverlay.destroy(!0),this.pickerOverlay.children?.forEach((e=>e.destroy(!0))),this.callback?.(null),this.pickerOverlay=null,this.callback=null)}static async _createPreview(e){const t=this.constructor.documentName,s=getDocumentClass(t);e._id=foundry.utils.randomID();const a=new s(e,{parent:canvas.scene}),n=new CONFIG[t].objectClass(a);return this.preview.addChild(n),await n.draw(),n}static async _genPreviews(e){if(!e.previewData)return{previews:[]};const t=new Set,s=[],a={};for(const[n,i]of e.previewData.entries()){const o=canvas.getLayerByEmbeddedName(n);for(const r of i){const i=await this._createPreview.call(o,deepClone(r));if(i._pData=r,s.push(i),t.add(n),null==a.x&&("Wall"===n?(a.x=-i.document.c[0],a.y=-i.document.c[1]):(a.x=-i.document.x,a.y=-i.document.y)),e.taPreview&&"Token"===n){(await this._genTAPreviews(r,e.taPreview,i,s)).forEach((e=>t.add(e)))}}}for(const e of s){const t=e.document;DataTransform.apply(t.documentName,e._pData??t,{x:0,y:0},a,e)}return{previews:s,layer:canvas.getLayerByEmbeddedName(e.documentName),previewDocuments:t}}static _parseTAPreview(e,t){if("ALL"===e)return t;const s={};e=e.split(",");for(const a of e){let[e,n]=a.trim().split(".");t[e]&&(null==n?s[e]=t[e]:t[e][n]&&(s[e]||(s[e]=[]),s[e].push(t[e][n])))}return s}static async _genTAPreviews(e,t,s,a){if(!game.modules.get("token-attacher")?.active)return[];const n=getProperty(e,"flags.token-attacher.prototypeAttached"),i=getProperty(e,"flags.token-attacher.pos"),o=getProperty(e,"flags.token-attacher.grid");if(!(n&&i&&o))return[];const r=new Set,l=canvas.grid.size/o.size,c=this._parseTAPreview(t,n);for(const[e,t]of Object.entries(c))for(let n of t){["Token","Tile","Drawing"].includes(e)&&(n.width*=l,n.height*=l);const t=await this._createPreview.call(canvas.getLayerByEmbeddedName(e),n);r.add(e),a.push(t);const o=t.document;"Wall"===e?(o.c[0]=s.document.x+(n.c[0]-i.xy.x)*l,o.c[1]=s.document.y+(n.c[1]-i.xy.y)*l,o.c[2]=s.document.x+(n.c[2]-i.xy.x)*l,o.c[3]=s.document.y+(n.c[3]-i.xy.y)*l):(o.x=s.document.x+(n.x-i.xy.x)*l,o.y=s.document.y+(n.y-i.xy.y)*l)}return r}}class DataTransform{static apply(e,t,s,a,n){null==a.x&&(a.x=0),null==a.y&&(a.y=0),"Wall"===e?this.transformWall(t,s,a,n):"Tile"===e?this.transformTile(t,s,a,n):"Note"==e?this.transformNote(t,s,a,n):"Token"===e?this.transformToken(t,s,a,n):"MeasuredTemplate"===e?this.transformMeasuredTemplate(t,s,a,n):"AmbientLight"===e?this.transformAmbientLight(t,s,a,n):"AmbientSound"===e?this.transformAmbientSound(t,s,a,n):"Drawing"===e?this.transformDrawing(t,s,a,n):(t.x+=a.x,t.y+=a.y,n&&(n.document.x=t.x,n.document.y=t.y))}static transformNote(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t}if(e.x+=s.x,e.y+=s.y,null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a)}a&&(a.document.x=e.x,a.document.y=e.y)}static transformAmbientSound(e,t,s,a){const n=e.flags?.levels?.rangeBottom;if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.radius*=t),null!=n&&""!=n&&(e.flags.levels.rangeBottom*=t,e.flags.levels.rangeTop*=t)}if(e.x+=s.x,e.y+=s.y,null!=s.z&&(setProperty(e,"flags.levels.rangeBottom",(n??0)+s.z),setProperty(e,"flags.levels.rangeTop",(n??0)+s.z)),null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.radius=e.radius}}static transformWall(e,t,s,a){const n=deepClone(e.c);if(null!=s.scale){const e=s.scale;n[0]*=e,n[1]*=e,n[2]*=e,n[3]*=e}if(n[0]+=s.x,n[1]+=s.y,n[2]+=s.x,n[3]+=s.y,null!=s.rotation){const e=Math.toRadians(s.rotation%360);[n[0],n[1]]=this.rotatePoint(t.x,t.y,n[0],n[1],e),[n[2],n[3]]=this.rotatePoint(t.x,t.y,n[2],n[3],e)}e.c=n,a&&(a.document.c=n)}static transformMeasuredTemplate(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.distance*=t,e.width&&(e.width*=t))}if(e.x+=s.x,e.y+=s.y,null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a),e.direction+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.direction=e.direction,t.distance=e.distance,t.width=e.width}}static transformAmbientLight(e,t,s,a){const n=e.flags?.levels?.rangeBottom;if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.config.dim*=t,e.config.bright*=t),null!=n&&""!=n&&(e.flags.levels.rangeBottom*=t,e.flags.levels.rangeTop*=t)}if(e.x+=s.x,e.y+=s.y,null!=s.z&&(setProperty(e,"flags.levels.rangeBottom",(n??0)+s.z),setProperty(e,"flags.levels.rangeTop",(n??0)+s.z)),null!=s.rotation){const a=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,a),e.rotation+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.rotation=e.rotation,t.config.dim=e.config.dim,t.config.bright=e.config.bright}}static transformTile(e,t,s,a){const n=e.flags?.["levels-3d-preview"]?.depth,i=e.flags?.levels?.rangeBottom;if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,e.width*=t,e.height*=t,null!=n&&""!=n&&(e.flags["levels-3d-preview"].depth*=t),null!=i&&""!=i&&(e.flags.levels.rangeBottom*=t,e.flags.levels.rangeTop*=t)}if(e.x+=s.x,e.y+=s.y,null!=s.z&&(setProperty(e,"flags.levels.rangeBottom",(i??0)+s.z),setProperty(e,"flags.levels.rangeTop",(i??0)+s.z)),null!=s.rotation){const a=Math.toRadians(s.rotation%360);let n={x:e.x+e.width/2,y:e.y+e.height/2};[n.x,n.y]=this.rotatePoint(t.x,t.y,n.x,n.y,a),e.x=n.x-e.width/2,e.y=n.y-e.height/2,e.rotation+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.rotation=e.rotation}}static transformDrawing(e,t,s,a){if(null!=s.scale){const t=s.scale;if(e.x*=t,e.y*=t,e.shape.width*=t,e.shape.height*=t,e.shape.points){const s=e.shape.points;for(let e=0;e<s.length;e++)s[e]*=t}}if(e.x+=s.x,e.y+=s.y,null!=s.rotation){const a=Math.toRadians(s.rotation%360);let n={x:e.x+e.shape.width/2,y:e.y+e.shape.height/2};[n.x,n.y]=this.rotatePoint(t.x,t.y,n.x,n.y,a),e.x=n.x-e.shape.width/2,e.y=n.y-e.shape.height/2,e.rotation+=Math.toDegrees(a)}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.shape.width=e.shape.width,t.shape.height=e.shape.height,t.shape.points=e.shape.points,t.rotation=e.rotation}}static transformToken(e,t,s,a){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.width*=t,e.height*=t,e.elevation*=t)}e.x+=s.x,e.y+=s.y,e.elevation+=s.z??0;const n=canvas.grid;if(null!=s.rotation){const a=Math.toRadians(s.rotation%360);let i={x:e.x+e.width*n.w/2,y:e.y+e.height*n.h/2};[i.x,i.y]=this.rotatePoint(t.x,t.y,i.x,i.y,a),e.x=i.x-e.width*n.w/2,e.y=i.y-e.height*n.h/2,e.rotation=(e.rotation+Math.toDegrees(a))%360}if(a){const t=a.document;t.x=e.x,t.y=e.y,t.elevation=e.elevation,t.rotation=e.rotation,t.width=e.width,t.height=e.height}}static rotatePoint(e,t,s,a,n){const i=s-e,o=a-t;return[e+Math.cos(n)*i-Math.sin(n)*o,t+Math.sin(n)*i+Math.cos(n)*o]}}async function i(){const e=new Map;if(n.Me.forEach((t=>{const s=canvas.getLayerByEmbeddedName(t).controlled;s.length&&e.set(t,s.map((e=>e)))})),!e.size){const t=await new Promise((async e=>{Picker.activate(e)}));if(!t)return;const s=new PIXI.Rectangle(t.start.x,t.start.y,t.end.x-t.start.x,t.end.y-t.start.y);n.Me.forEach((t=>{let a=[];canvas.getLayerByEmbeddedName(t).placeables.forEach((e=>{const t=e.center;s.contains(t.x,t.y)&&a.push(e)})),a.length&&e.set(t,a)}))}if(!e.size)return;const t=new Map,s=new Map;let a;e.forEach(((e,i)=>{if(n.Me.includes(i)){let n=e.map((e=>e.document.toCompendium(null,{keepId:!0})));if("Token"===i&&game.modules.get("token-attacher")?.active&&tokenAttacher?.generatePrototypeAttached)for(const e of n){const t=e.flags?.["token-attacher"]?.attached||{};if(!foundry.utils.isEmpty(t)){const s=tokenAttacher.generatePrototypeAttached(e,t);setProperty(e,"flags.token-attacher.attached",null),setProperty(e,"flags.token-attacher.prototypeAttached",s),setProperty(e,"flags.token-attacher.grid",{size:canvas.grid.size,w:canvas.grid.w,h:canvas.grid.h})}}t.set(i,n),s.set(i,deepClone(n)),a||(a=i)}})),t.size&&Picker.activate((async e=>{null!=e&&t.forEach(((e,t)=>{let a=[];const n=s.get(t);for(let t=0;t<n.length;t++){const s=foundry.utils.diffObject(n[t],e[t]);foundry.utils.isEmpty(s)||(s._id=n[t]._id,delete s.flags,a.push(s))}a.length&&canvas.scene.updateEmbeddedDocuments(t,a)}))}),{documentName:a,previewData:t,snap:!0,taPreview:"ALL",center:!0})}},652:(e,t,s)=>{s.d(t,{A0:()=>PresetCollection,XF:()=>m,Xd:()=>u,aN:()=>d,af:()=>PresetAPI,dH:()=>PresetPackFolder,fF:()=>PresetVirtualFolder});var a=s(208),n=s(241),i=s(971),o=s(465),r=s(120),l=s(671),c=s(575);const d="world.mass-edit-presets-main",u="MassEditMetaData",m=["id","img","documentName","tags"];class PresetCollection{static presets;static workingPack;static async getTree(e,t=!1){let s,a;try{s=await this._initCompendium(this.workingPack),a=await this.packToTree(s,e)}catch(t){console.log(t),console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`),console.log("RETURNING TO DEFAULT"),await game.settings.set(r.Do,"workingPack",d),this.workingPack=d,s=await this._initCompendium(this.workingPack),a=await this.packToTree(s,e)}const n=[];if(!t)for(const t of game.packs)if(t.collection!==this.workingPack&&t.index.get(u)){const s=await this.packToTree(t,e);if(!s.hasVisible)continue;const i=new PresetPackFolder({pack:t,tree:s});n.push(i),a.allFolders.set(i.uuid,i);for(const[e,t]of s.allFolders)a.allFolders.set(e,t)}return a.extFolders=this._groupExtFolders(n,a.allFolders),a}static async packToTree(e,t){if(!e)return null;const s=new Map,a=new Map,n=e.folders.contents;for(const e of n){const n=new PresetFolder({id:e._id,uuid:e.uuid,name:e.name,sorting:e.sorting,color:e.color,sort:e.sort,draggable:e.pack===this.workingPack,folder:e.folder?.uuid,visible:!t||(e.flags[r.Do]?.types||["ALL"]).includes(t)});s.set(n.uuid,n),a.set(e.uuid,n)}for(const e of n)if(e.folder){s.get(e.folder.uuid).children.push(s.get(e.uuid)),a.delete(e.uuid)}const i=[],o=[];let c=!1;const d=await e.getDocument(u);let m=d?.getFlag(r.Do,"index");const h=e.index.contents;PresetCollection._cleanIndex(e,d,m);for(const a of h){if(a._id===u)continue;const n=m[a._id],d=new l.k({...a,...n,pack:e.collection});if(!d.documentName){if(console.log(`Missing MetaData. Attempting document load: ${d.id} | ${d.name}`),await d.load(),!d.documentName)continue;e.locked||d._updateIndex(d)}if(d.folder){let e=!1;for(const[t,a]of s)if(a.id===d.folder){a.presets.push(d),e=!0;break}e||o.push(d)}else o.push(d);t&&("ALL"===t?r.TA.includes(d.documentName)||(d._visible=!1):d.documentName!==t&&(d._visible=!1)),i.push(d),c|=d._visible}const g="manual"===game.settings.get(r.Do,"presetSortMode")?"m":"a";return{folders:this._sortFolders(Array.from(a.values()),g),presets:this._sortPresets(o,g),allPresets:i,allFolders:s,hasVisible:c,metaDoc:d}}static _groupExtFolders(e,t){e=e.sort(((e,t)=>e.name.localeCompare(t.name)));const s={},a=[];e.forEach((e=>{e.group?(e.group in s||(s[e.group]=[]),s[e.group].push(e)):a.push(e)}));const n=[];for(const[e,a]of Object.entries(s)){const s=r.AU.randomID(e),i="virtual."+e,o=new PresetVirtualFolder({id:s,uuid:i,name:e,children:a,draggable:!1});t.set(i,o),n.push(o)}return n.concat(a).sort(((e,t)=>e.name.localeCompare(t.name)))}static async _cleanIndex(e,t,s){if(e.locked||!t||foundry.utils.isEmpty(s))return;const a=e.index,n={};for(const e of Object.keys(s))a.has(e)||(n["-="+e]=null);foundry.utils.isEmpty(n)||t.setFlag(r.Do,"index",n)}static _sortFolders(e,t="a"){for(const t of e)t.children=this._sortFolders(t.children,t.sorting),t.presets=this._sortPresets(t.presets,t.sorting);return"a"===t?e.sort(((e,t)=>e.name.localeCompare(t.name,"en",{numeric:!0}))):e.sort(((e,t)=>e.sort-t.sort))}static _sortPresets(e,t="a"){return"a"===t?e.sort(((e,t)=>e.name.localeCompare(t.name,"en",{numeric:!0}))):e.sort(((e,t)=>e.sort-t.sort))}static async packToPresets(e){if(!e)return[];const t=[];let s=(await e.getDocument(u))?.getFlag(r.Do,"index");const a=e.index.contents;for(const n of a){if(n._id===u)continue;const a=s[n._id],i=new l.k({...n,...a,pack:e.collection});t.push(i)}return t}static async update(e){const t=await this._initCompendium(this.workingPack),s=await t.getDocument(e.id),a={name:e.name,flags:{[r.Do]:{preset:e.toJSON()}}},n=e.pages;n&&(a.pages=n),await s.update(a);const i=await this._initMetaDocument(this.workingPack),o={};m.forEach((t=>{o[t]=e[t]})),await i.setFlag(r.Do,"index",{[e.id]:o})}static async updatePresets(e){await JournalEntry.updateDocuments(e,{pack:this.workingPack})}static async set(e,t){if(t||(t=this.workingPack),e instanceof Array){for(const s of e)await PresetCollection.set(s,t);return}if((await this._initCompendium(t)).index.get(e.id))return void await this.update(e);const s=await JournalEntry.createDocuments([{_id:e.id,name:e.name,pages:e.pages??[],folder:e.folder,flags:{[r.Do]:{preset:e.toJSON()}}}],{pack:t,keepId:!0});e.uuid=s[0].uuid,e.document=s[0];const a=await this._initMetaDocument(t),n={};m.forEach((t=>{n[t]=e[t]})),await a.setFlag(r.Do,"index",{[e.id]:n})}static async get(e,{full:t=!0}={}){let{collection:s,documentId:a,documentType:n,embedded:i,doc:o}=foundry.utils.parseUuid(e);const c=s.index.get(a);if(c){const e=(await s.getDocument(u))?.getFlag(r.Do,"index"),a=e[c._id],n=new l.k({...c,...a,pack:s.collection});return t&&await n.load(),n}return null}static async delete(e){if(!e)return;e instanceof Array||(e=[e]);const t={};for(const s of e){let{collection:e}=foundry.utils.parseUuid(s.uuid);e=e.collection,t[e]?t[e].push(s):t[e]=[s]}for(const e of Object.keys(t)){if(!await game.packs.get(e))continue;const s=await this._initMetaDocument(e),a={},n=[];for(const s of t[e])n.push(s.id),a["-="+s.id]=null;await JournalEntry.deleteDocuments(n,{pack:e}),s.setFlag(r.Do,"index",a)}}static async _initCompendium(e){let t=game.packs.get(e);return t||e!==d||(t=await CompendiumCollection.createCompendium({label:"Mass Edit: Presets (MAIN)",type:"JournalEntry",ownership:{GAMEMASTER:"NONE",PLAYER:"NONE",ASSISTANT:"NONE"},packageType:"world"}),await this._initMetaDocument(e)),t}static async _initMetaDocument(e){const t=game.packs.get(e),s=await t.getDocument(u);if(s)return s;return(await JournalEntry.createDocuments([{_id:u,name:"!!! METADATA: DO NOT DELETE !!!",flags:{[r.Do]:{index:{}}}}],{pack:e,keepId:!0}))[0]}static async deleteFolder(e,t=!1){const s=await fromUuid(e);if(!s.compendium.locked){if(t){const e=s.compendium.get(u);if(!e)return;const t={},a=function(e){e.contents.forEach((e=>t["-="+e._id]=null)),e.children.forEach((e=>a(e.folder)))};a(s),e.setFlag(r.Do,"index",t)}return await s.delete({deleteSubfolders:t,deleteContents:t})}}static _searchPresetTree(e,t){const s=[];return t.folder||this._searchPresetList(e.allPresets,s,t),e.allFolders.forEach((e=>this._searchPresetFolder(e,s,t))),s}static _searchPresetFolder(e,t,s){s.folder&&e.name!==s.folder||this._searchPresetList(e.presets,t,s,e.name)}static _searchPresetList(e,t,{name:s,type:a,tags:n}={},i){for(const i of e){let e=!0;s&&s!==i.name&&(e=!1),a&&a!==i.documentName&&(e=!1),e&&n&&(e=n.matchAny?n.tags.some((e=>i.tags.includes(e))):n.tags.every((e=>i.tags.includes(e)))),e&&t.push(i)}}static async buildSpotlightOmnisearchIndex(e){const t=await PresetCollection.getTree(),s=CONFIG.SpotlightOmnisearch.SearchTerm,a=async function(){r.Me.includes(this.data.documentName)&&(ui.spotlightOmnisearch?.setDraggingState(!0),await PresetAPI.spawnPreset({preset:this.data,coordPicker:!0,taPreview:"ALL",scaleToGrid:game.settings.get(r.Do,"presetScaling")}),ui.spotlightOmnisearch?.setDraggingState(!1))},i=function(e){if(r.Me.includes(this.data.documentName)){const{x:t,y:s}=canvas.canvasCoordinatesFromClient({x:e.clientX,y:e.clientY});PresetAPI.spawnPreset({preset:this.data,x:t,y:s,scaleToGrid:game.settings.get(r.Do,"presetScaling")})}else"Scene"===this.data.documentName&&(0,r.XK)(this.data)},o=function(){ui.spotlightOmnisearch?.setDraggingState(!1)},l=function(){const e=[{name:"MassEdit.presets.open-journal",icon:'<i class="fas fa-book-open fa-fw"></i>',callback:()=>{this.data.openJournal()}}];return r.Me.includes(this.data.documentName)&&e.push({name:"MassEdit.presets.controls.activate-brush",icon:'<i class="fas fa-paint-brush"></i>',callback:async()=>{canvas.getLayerByEmbeddedName(this.data.documentName)?.activate(),n.vM.activate({preset:await this.data.load(),deactivateCallback:o})&&ui.spotlightOmnisearch.setDraggingState(!0)}}),e},c=function(t){e.push(new s({name:t.name,description:"Mass Edit: Preset",type:t.documentName+" preset",img:t.img,icon:["fa-solid fa-books",t.icon],keywords:t.tags,onClick:a,onDragEnd:i,data:t,actions:l}))};t.presets.forEach(c),t.allFolders.forEach((e=>e.presets.forEach(c)))}}class PresetAPI{static name="PresetAPI";static async getPreset({uuid:e,name:t,type:s,folder:a,tags:n,random:i=!1}={}){if(e)return await PresetCollection.get(e);if(!(t||s||a||n))throw Error("UUID, Name, Type, and/or Folder required to retrieve a Preset.");n&&(Array.isArray(n)?n={tags:n,matchAny:!0}:"string"==typeof n&&(n={tags:n.split(","),matchAny:!0}));const o=PresetCollection._searchPresetTree(await PresetCollection.getTree(),{name:t,type:s,folder:a,tags:n}),r=i?o[Math.floor(Math.random()*o.length)]:o[0];return r?.clone().load()}static async getPresets({uuid:e,name:t,type:s,folder:a,format:n="preset",tags:i}={}){if(e)return await PresetCollection.get(e);if(!(t||s||a||i))throw Error("UUID, Name, Type, Folder and/or Tags required to retrieve a Preset.");i&&(Array.isArray(i)?i={tags:i,matchAny:!0}:"string"==typeof i&&(i={tags:i.split(","),matchAny:!0}));const o=PresetCollection._searchPresetTree(await PresetCollection.getTree(),{name:t,type:s,folder:a,tags:i});return"name"===n?o.map((e=>e.name)):"nameAndFolder"===n?o.map((e=>({name:e.name,folder:e._folderName}))):o}static async createPresetFromActor(e,{keepId:t=!1,folder:s}={}){if(!e||"Actor"!==e.documentName)return;const a={id:t?e.id:null,name:e.name,documentName:"Token",img:e.img,data:[e.prototypeToken.toJSON()],folder:s};a.gridSize=canvas.scene.grid.size;const n=new l.k(a);return await PresetCollection.set(n),n}static async createPresetFromActorUuid(e,t={}){const s=await fromUuid(e);if("Actor"!==!s.documentName)return await this.createPresetFromActor(s,t)}static async createPreset(e,t={}){if(!e)return;e instanceof Array||(e=[e]);const s={};for(const t of e){const e=t.document.documentName;s.hasOwnProperty(e)||(s[e]=[]),s[e].push(t)}const a=[];for(const[e,n]of Object.entries(s)){const s=[];for(const e of n)s.push((0,c.h)(e));const i={name:(0,r.kg)("presets.default-name"),documentName:e,data:s};switch(i.documentName){case"Token":case"Tile":case"Note":i.img=s[0].texture.src;break;case"AmbientSound":i.img="icons/svg/sound.svg";break;case"AmbientLight":i.img="icons/svg/light.svg";break;case"Drawing":i.img="icons/svg/acid.svg";break;case"MeasuredTemplate":i.img="icons/svg/circle.svg"}if("Token"===i.documentName)i.name=s[0].name;else{const e=s[0].flags?.tagger?.tags?.[0];e&&(i.name=e)}i.gridSize=n[0].document.parent.grid.size,foundry.utils.mergeObject(i,t,{inplace:!0});const o=new l.k(i);await PresetCollection.set(o),a.push(o)}return a}static async spawnPreset({uuid:e,preset:t,name:s,type:n,folder:l,tags:d,random:u=!1,x:m,y:h,z:g,coordPicker:p=!1,pickerLabel:f,taPreview:y,snapToGrid:b=!0,hidden:v=!1,layerSwitch:k=!1,scaleToGrid:w=!1,modifyPrompt:x=!0,center:S=!1,sceneId:D}={}){if(!canvas.ready)throw Error("Canvas need to be 'ready' for a preset to be spawned.");if(!(e||t||s||n||l||d))throw Error("ID, Name, Folder, Tags, or Preset is needed to spawn it.");if(!p&&(null==m&&null!=h||null!=m&&null==h))throw Error("Need both X and Y coordinates to spawn a preset.");if(t&&await t.load(),!(t=t??await PresetAPI.getPreset({uuid:e,name:s,type:n,folder:l,tags:d,random:u})))throw Error(`No preset could be found matching: { uuid: "${e}", name: "${s}", type: "${n}"}`);let T=deepClone(t.data);if(t.spawnRandom&&T.length&&(T=[T[Math.floor(Math.random()*T.length)]]),x&&t.modifyOnSpawn?.length&&(T=await(0,c.e9)(T,t.modifyOnSpawn),null==T))return;T=T.map((e=>(0,c.Go)(t,e))),T=T.map((e=>foundry.utils.flattenObject(e))),foundry.utils.isEmpty(t.randomize)||await(0,o.of)(T,null,t.randomize),await(0,a.fP)(t.documentName,T,T),T=T.map((e=>foundry.utils.expandObject(e))),t.preSpawnScript&&await(0,r.HG)(t.preSpawnScript,{data:T});const E=new Map;if(E.set(t.documentName,T),t.attached)for(const e of t.attached){E.get(e.documentName)||E.set(e.documentName,[]);const t=deepClone(e.data);E.get(e.documentName).push(t)}if(w){const e=canvas.grid.size/(t.gridSize||100);E.forEach(((t,s)=>{t.forEach((t=>i.DataTransform.apply(s,t,{x:0,y:0},{scale:e,gridScale:!0})))}))}if(p){const e=await new Promise((async e=>{i.Picker.activate(e,{documentName:t.documentName,previewData:E,snap:b,label:f,taPreview:y,center:S})}));if(null==e)return[];m=e.end.x,h=e.end.y}else if(null==m||null==h)if(game.Levels3DPreview?._active){const e=game.Levels3DPreview.interactionManager.canvas2dMousePosition;m=e.x,h=e.y,g=e.z}else m=canvas.mousePosition.x,h=canvas.mousePosition.y,"Token"!==t.documentName&&"Tile"!==t.documentName||(m-=canvas.dimensions.size/2,h-=canvas.dimensions.size/2);if(S){const e=(0,c.Ym)(E);m-=e.x,h-=e.y}let P={x:m,y:h};b&&!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)&&(P=canvas.grid.getSnappedPosition(P.x,P.y,canvas.getLayerByEmbeddedName(t.documentName).gridPrecision)),P.z=g;const O=(0,c.Q2)(E);O.x+=P.x,O.y+=P.y,null==P.z?O.z=0:O.z+=P.z,E.forEach(((e,t)=>{e.forEach((e=>{i.DataTransform.apply(t,e,{x:0,y:0},O),["Drawing","MeasuredTemplate"].includes(t)&&("Drawing"===t?e.author=game.user.id:"MeasuredTemplate"===t&&(e.user=game.user.id)),(v||game.keyboard.downKeys.has("AltLeft"))&&(e.hidden=!0)}))})),k&&(game.user.isGM||["Token","MeasuredTemplate","Note"].includes(t.documentName))&&canvas.getLayerByEmbeddedName(t.documentName)?.activate();const C=[];for(const[e,t]of E.entries()){(await(0,r.VS)(e,t,D??canvas.scene.id)).forEach((e=>C.push(e)))}return t.postSpawnScript&&await(0,r.HG)(t.postSpawnScript,{documents:C,objects:C.map((e=>e.object)).filter(Boolean)}),C}}class PresetFolder{constructor({id:e,uuid:t,name:s,sorting:a="m",color:n="#000000",sort:i=0,children:o=[],presets:r=[],draggable:l=!0,folder:d=null,visible:u=!0,render:m=!0}={}){this.id=e,this.uuid=t,this.name=s,this.sorting=a,this.color=n,this.sort=i,this.children=o,this.children.forEach((e=>{e.folder=this.id})),this.presets=r,this.draggable=l,this.folder=d,this.visible=u,this.render=m,this.expanded=c.cm.expanded(this.uuid)}async update(e){const t=await fromUuid(this.uuid);t&&await t.update(e)}}class PresetVirtualFolder extends PresetFolder{constructor(e){super(e),this.virtual=!0}async update(e){}}class PresetPackFolder extends PresetVirtualFolder{constructor(e){const t=e.tree,s=e.pack,a=t.metaDoc.getFlag(r.Do,"folder")??{},n=s.collection;super({uuid:n,id:r.AU.randomID(n),name:a.name??s.title,children:t.folders,presets:t.presets,draggable:!1,color:a.color??"#000000"}),this.group=a.group}get pack(){return this.uuid}async update(e={}){const t=game.packs.get(this.pack);if(t.locked)return;if(e.hasOwnProperty("name")&&e.name===t.title&&delete e.name,foundry.utils.isEmpty(e))return;const s=await PresetCollection._initMetaDocument(this.pack);await s.setFlag(r.Do,"folder",e)}}},294:(e,t,s)=>{s.d(t,{P:()=>MassEditPresets,Q:()=>PresetConfig});var a=s(998),n=s(208),i=s(739);class TrackerDialog extends Dialog{constructor(e,{total:t,cancelCallback:s,left:a,top:n}){super(e,{left:a,top:n}),this.count=0,this.total=t,this.cancelCallback=s}incrementCount(){this.count++,this.element?.find(".count").html(this.count)}stop(){this.close(!0)}get active(){return this._state===Application.RENDER_STATES.RENDERED||this._state===Application.RENDER_STATES.RENDERING}}async function o({title:e="Progress",cancelCallback:t,total:s}={}){if(!s)return;const a=new TrackerDialog({title:e,content:`\n<div>\n<div  style="display: block; text-align: center; padding: 5px;"><i class="fas fa-circle-notch fa-spin fa-3x"></i></div>\n    <p style="text-align: center;"><span class="count">count</span>/${s}</p>\n</div>`,buttons:{cancel:{icon:'<i class="fas fa-stop"></i>',label:"Stop/Cancel",callback:()=>{t?.()}}},default:"cancel"},{total:s,cancelCallback:t,left:50,top:50});return await a._render(!0),a}function r(e){return e.presets?e.presets.length+e.children.reduce((function(e,t){return e+r(t)}),0):e.contents.length+e.children.reduce((function(e,t){return e+r(t.folder)}),0)}var l=s(241),c=s(860);class SortingHelpersFixed{static performIntegerSort(e,{target:t=null,siblings:s=[],sortKey:a="sort",sortBefore:n}={}){void 0===n&&(n=(e[a]||0)>(t?.[a]||0)),(s=Array.from(s)).sort(((e,t)=>e[a]-t[a]));let i,o,r=n?s.length:0,l=t?s.findIndex((e=>e===t)):r;return[i,o]=n?this._sortBefore(s,l,a):this._sortAfter(s,l,a),0===s.length?[{target:e,update:{[a]:CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(o)&&null===i?[{target:e,update:{[a]:o-CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(i)&&null===o?[{target:e,update:{[a]:i+CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(i)&&Number.isFinite(o)&&Math.abs(o-i)>1?[{target:e,update:{[a]:Math.round(.5*(i+o))}}]:(s.splice(l+(n?0:1),0,e),s.map(((e,t)=>({target:e,update:{[a]:(t+1)*CONST.SORT_INTEGER_DENSITY}}))))}static performIntegerSortMulti(e,{target:t=null,siblings:s=[],sortKey:a="sort",sortBefore:n}={}){let i=e[0];void 0===n&&(n=(i[a]||0)>(t?.[a]||0)),(s=Array.from(s)).sort(((e,t)=>e[a]-t[a]));let o,r,l=n?s.length:0,c=t?s.findIndex((e=>e===t)):l;if([o,r]=n?this._sortBefore(s,c,a):this._sortAfter(s,c,a),0===s.length)return e.map(((e,t)=>({target:e,update:{[a]:CONST.SORT_INTEGER_DENSITY*(t+1)}})));if(Number.isFinite(r)&&null===o)return e.map(((t,s)=>({target:t,update:{[a]:r-CONST.SORT_INTEGER_DENSITY*(e.length-s+1)}})));if(Number.isFinite(o)&&null===r)return e.map(((e,t)=>({target:e,update:{[a]:o+CONST.SORT_INTEGER_DENSITY*(t+1)}})));if(Number.isFinite(o)&&Number.isFinite(r)&&Math.abs(r-o)>e.length){let t=Math.floor(1/(e.length+1)*Math.abs(r-o));return 0===t&&(t=1),o=Math.min(r,o),e.map(((e,s)=>({target:e,update:{[a]:o+t*(s+1)}})))}return s.splice(c+(n?0:1),0,...e),s.map(((e,t)=>({target:e,update:{[a]:(t+1)*CONST.SORT_INTEGER_DENSITY}})))}static _sortBefore(e,t,s){let a=e[t]?e[t][s]:null;return[e[t-1]?e[t-1][s]:null,a]}static _sortAfter(e,t,s){return[e[t]?e[t][s]:null,e[t+1]?e[t+1][s]:null]}}var d=s(120),u=s(652),m=s(671),h=s(575);const g={manual:{get tooltip(){return(0,d.kg)("SIDEBAR.SortModeManual",!1)},icon:'<i class="fa-solid fa-arrow-down-short-wide"></i>'},alphabetical:{get tooltip(){return(0,d.kg)("SIDEBAR.SortModeAlpha",!1)},icon:'<i class="fa-solid fa-arrow-down-a-z"></i>'}},p={p:{get tooltip(){return(0,d.kg)("presets.search-presets")},icon:'<i class="fas fa-search"></i>'},pf:{get tooltip(){return(0,d.kg)("presets.search-presets-folders")},icon:'<i class="fa-solid fa-folder-magnifying-glass"></i>'}};class MassEditPresets extends FormApplication{static objectHover=!1;static lastSearch;constructor(e,t,s,a={}){if(!a.preventPositionOverride&&MassEditPresets.previousPosition&&(a={...a,...MassEditPresets.previousPosition}),super({},a),this.callback=t,this.dragType=null,this.dragData=null,this.draggedElements=null,!e&&d.TA.includes(s)){const e=game.settings.get(d.Do,"presetDocLock");this.docName=e||s}else this.configApp=e,this.docName=s||this.configApp.documentName}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-presets",classes:["sheet"],template:`modules/${d.Do}/templates/preset/presets.html`,resizable:!0,minimizable:!0,width:350,height:900,scrollY:["ol.item-list"]})}get title(){let e=(0,d.kg)("common.presets");return d.TA.includes(this.docName)?e+=` [${(0,d.kg)("common.placeable")}]`:e+=` [${this.docName}]`,e}async getData(e){const t=super.getData(e);this._activeBrush&&(l.vM.deactivate(),this._onPresetBrushDeactivate()),await getTemplate(`modules/${d.Do}/templates/preset/preset.html`,"me-preset"),await getTemplate(`modules/${d.Do}/templates/preset/presetFolder.html`,"me-preset-folder"),await getTemplate(`modules/${d.Do}/templates/preset/presetsContent.html`,"me-presets-content");const s=game.settings.get(d.Do,"presetExtComp");return this.tree=await u.A0.getTree(this.docName,!s),t.presets=this.tree.presets,t.folders=this.tree.folders,t.extFolders=this.tree.extFolders.length?this.tree.extFolders:null,t.createEnabled=Boolean(this.configApp),t.isPlaceable=d.Me.includes(this.docName)||"ALL"===this.docName,t.allowDocumentSwap=d.TA.includes(this.docName)&&!this.configApp,t.docLockActive=game.settings.get(d.Do,"presetDocLock")===this.docName,t.layerSwitchActive=game.settings.get(d.Do,"presetLayerSwitch"),t.scaling=game.settings.get(d.Do,"presetScaling"),t.extCompActive=s,t.sortMode=g[game.settings.get(d.Do,"presetSortMode")],t.searchMode=p[game.settings.get(d.Do,"presetSearchMode")],t.displayDragDropMessage=t.allowDocumentSwap&&!(this.tree.presets.length||this.tree.folders.length),t.canvas3dActive=Boolean(game.Levels3DPreview?._active),t.lastSearch=MassEditPresets.lastSearch,t.docs=d.TA.reduce(((e,t)=>({...e,[t]:m.a[t]})),{}),t.documents=d.TA,t.currentDocument=this.docName,t.callback=Boolean(this.callback),t}activateListeners(e){super.activateListeners(e);const t=e.closest(".window-content").find(".drag-drop-overlay");e.closest(".window-content").on("mouseover",(e=>{canvas.activeLayer?.preview?.children.some((e=>e._original?.mouseInteractionManager?.isDragging))?(t.show(),MassEditPresets.objectHover=!0):(t.hide(),MassEditPresets.objectHover=!1)})).on("mouseout",(()=>{t.hide(),MassEditPresets.objectHover=!1})),e.find(".create-preset").on("click",(()=>{const e=canvas.activeLayer.controlled;e.length&&d.Me.includes(e[0].document.documentName)&&this.dropPlaceable(e)}));const s=e.find(".item-list");e.on("click",".item",(e=>{b(e,s),this._activeBrush&&this._toggleBrush(e)})),e.on("mouseenter",".item",(e=>{$(e.currentTarget).find(".tags").addClass("show")})),e.on("mouseleave",".item",(e=>{$(e.currentTarget).find(".tags").removeClass("show")})),e.on("dragstart",".item",(e=>{this.dragType="item";const t=$(e.target).closest(".item");t.hasClass("selected")||(s.find(".item.selected").removeClass("selected").removeClass("last-selected"),t.addClass("selected").addClass("last-selected"));const a=[];s.find(".item.selected").each((function(){a.push($(this).data("uuid"))})),this.dragData=a,this.draggedElements=s.find(".item.selected")})),e.on("dragleave",".item.editable",(e=>{$(e.target).closest(".item").removeClass("drag-bot").removeClass("drag-top")})),e.on("dragover",".item.editable",(e=>{if("item"!==this.dragType)return;if(!this.draggedElements.hasClass("editable"))return;const t=$(e.target).closest(".item");if(t.hasClass("selected"))return;var s=e.currentTarget.getBoundingClientRect();let a=e.offsetY/s.height;a<.2?t.removeClass("drag-bot").addClass("drag-top"):a>.8&&t.removeClass("drag-top").addClass("drag-bot")})),e.on("drop",".item.editable",(e=>{if("item"!==this.dragType)return;if(!this.draggedElements.hasClass("editable"))return;const t=$(e.target).closest(".item"),a=t.hasClass("drag-top");t.removeClass("drag-bot").removeClass("drag-top");const n=this.dragData;n&&(t.hasClass("selected")||((a?n:n.reverse()).forEach((e=>{const n=s.find(`.item[data-uuid="${e}"]`);n&&(a?n.insertBefore(t):n.insertAfter(t))})),this._onItemSort(n,t.data("uuid"),{before:a,folderUuid:t.closest(".folder").data("uuid")}))),this.dragType=null,this.dragData=null,this.draggedElements=null})),e.on("dragend",".item",(e=>{(function(e){let t=$(e.target).closest(".window-app");var s=t.offset();let a=s.left,n=s.top,i=t.width(),o=t.height();var r=e.pageX,l=e.pageY;if(r>a&&r<a+i&&l>n&&l<n+o)return!0;return!1})(e)||this._onPresetDragOut(e)})),e.on("click",".folder > header",(e=>this._folderToggle($(e.target).closest(".folder")))),e.on("dragstart",".folder.editable",(e=>{if("item"==this.dragType)return;this.dragType="folder";const t=[$(e.target).closest(".folder").data("uuid")];$(e.target).find(".folder").each((function(){t.push($(this).data("uuid"))})),this.dragData=t})),e.on("dragleave",".folder.editable header",(e=>{$(e.target).closest(".folder").removeClass("drag-mid").removeClass("drag-top")})),e.on("dragover",".folder.editable header",(e=>{const t=$(e.target).closest(".folder");if("folder"===this.dragType){if(this.dragData.includes(t.data("uuid")))return;var s=e.currentTarget.getBoundingClientRect();e.offsetY/s.height<.2?t.removeClass("drag-mid").addClass("drag-top"):t.removeClass("drag-top").addClass("drag-mid")}else"item"===this.dragType&&this.draggedElements.hasClass("editable")&&t.addClass("drag-mid")})),e.on("drop",".folder.editable header",(t=>{if(this._foundryDrop(t))return;const a=$(t.target).closest(".folder");if("folder"===this.dragType){const t=a.hasClass("drag-top");a.removeClass("drag-mid").removeClass("drag-top");const s=this.dragData;if(s){if(s.includes(a.data("uuid")))return;const n=s[0],i=e.find(`.folder[data-uuid="${n}"]`);i&&(t?i.insertBefore(a):a.find(".folder-items").first().append(i),t?this._onFolderSort(n,a.data("uuid"),{inside:!1,folderUuid:a.parent().closest(".folder").data("uuid")??null}):this._onFolderSort(n,null,{inside:!0,folderUuid:a.data("uuid")}))}}else if("item"===this.dragType&&this.draggedElements.hasClass("editable")){a.removeClass("drag-mid");const e=this.dragData,t=a.children(".preset-items");e?.forEach((e=>{const a=s.find(`.item[data-uuid="${e}"]`);a.length&&t.append(a)})),this._onItemSort(e,null,{folderUuid:a.data("uuid")})}this.dragType=null,this.dragData=null,this.draggedElements=null})),e.on("drop",".top-level-preset-items",(t=>{if(!this._foundryDrop(t)){if("folder"===this.dragType){const t=e.find(".top-level-folder-items"),s=e.find(`.folder[data-uuid="${this.dragData[0]}"]`);t.append(s),this._onFolderSort(this.dragData[0],null)}else if("item"===this.dragType&&this.draggedElements.hasClass("editable")){const t=this.dragData,a=e.find(".top-level-preset-items");t?.forEach((e=>{const t=s.find(`.item[data-uuid="${e}"]`);t.length&&a.append(t)})),this._onItemSort(t,null)}this.dragType=null,this.dragData=null,this.draggedElements=null}})),e.on("click",".toggle-sort",this._onToggleSort.bind(this)),e.on("click",".toggle-search-mode",this._onToggleSearch.bind(this)),e.on("click",".toggle-doc-lock",this._onToggleLock.bind(this)),e.on("click",".toggle-ext-comp",this._onToggleExtComp.bind(this)),e.on("click",".toggle-scaling",this._onToggleScaling.bind(this)),e.on("click",".toggle-layer-switch",this._onToggleLayerSwitch.bind(this)),e.on("click",".document-select",this._onDocumentChange.bind(this)),e.on("dblclick",".item",this._onDoubleClickPreset.bind(this)),e.on("click",".create-folder",this._onCreateFolder.bind(this)),e.on("click",".preset-create",this._onPresetCreate.bind(this)),e.on("click",".preset-update a",this._onPresetUpdate.bind(this)),e.on("click",".preset-brush",this._toggleBrush.bind(this)),e.on("click",".preset-callback",this._onApplyPreset.bind(this));const a=e.find(".header-search input");a.on("input",(e=>this._onSearchInput(e))),(MassEditPresets.lastSearch?.length??0)>=2&&a.trigger("input"),this._contextMenu(e.find(".item-list"))}_folderToggle(e){const t=e.data("uuid"),s=this.tree.allFolders.get(t);s.expanded?this._folderCollapse(e,s):this._folderExpand(e,s)}async _folderExpand(e,t){if(h.cm.setExpanded(t.uuid,!0),t.expanded=!0,e.find(".folder-items").length)e.removeClass("collapsed"),e.find("header h3 i").first().removeClass("fa-folder-closed").addClass("fa-folder-open");else{let s=await renderTemplate(`modules/${d.Do}/templates/preset/presetFolder.html`,{folder:t,createEnabled:Boolean(this.configApp),callback:Boolean(this.callback),editable:fromUuidSync(t.uuid)?.pack===u.A0.workingPack});e.replaceWith(s)}}_folderCollapse(e,t){e.addClass("collapsed"),e.find("header h3 i").first().removeClass("fa-folder-open").addClass("fa-folder-closed"),h.cm.setExpanded(t.uuid,!1),t.expanded=!1}_foundryDrop(e){const t=TextEditor.getDragEventData(e.originalEvent);if(!isEmpty(t)){if("Folder"===t.type){const e=fromUuidSync(t.uuid);return"Actor"===e.type&&(!this._importTracker?.active&&(o({title:"Converting Actors",total:r(e)}).then((async t=>{this._importTracker=t,await this._importActorFolder(e,null,{keepId:!0}),this._importTracker?.stop()})),!0))}return"Actor"===t.type&&(u.af.createPresetFromActorUuid(t.uuid,{keepId:!0}).then((e=>{e&&this.render(!0)})),!0)}return!1}async _importActorFolder(e,t=null,s={}){let a=new Folder.implementation({_id:s.keepId?e.id:null,name:e.name,type:"JournalEntry",sorting:e.sorting,folder:t,color:e.color??"#000000",flags:{[d.Do]:{types:["ALL","Token"]}}},{pack:u.A0.workingPack});a=await Folder.create(a,{pack:a.pack,keepId:s.keepId});for(const t of e.children){if(!this._importTracker?.active)break;await this._importActorFolder(t.folder,a.id,s)}for(const t of e.contents){if(!this._importTracker?.active)break;await u.af.createPresetFromActorUuid(t.uuid,{folder:a.id,keepId:s.keepId}),this._importTracker.incrementCount()}this.render(!0)}async _onDoubleClickPreset(e){if(this._onPresetBrushDeactivate(),game.Levels3DPreview?._active)return;const t=$(e.target).closest(".item").data("uuid");if(!t)return;const s=await u.af.getPreset({uuid:t});s&&("Scene"===s.documentName&&(ui.notifications.info(`Mass Edit: ${(0,d.kg)("common.apply")} [${s.name}]`),(0,d.XK)(s)),d.Me.includes(s.documentName)&&(ui.notifications.info(`Mass Edit: ${(0,d.kg)("presets.spawning")} [${s.name}]`),this._setInteractivityState(!1),await u.af.spawnPreset({preset:s,coordPicker:!0,taPreview:"ALL",layerSwitch:game.settings.get(d.Do,"presetLayerSwitch"),scaleToGrid:game.settings.get(d.Do,"presetScaling"),center:!0}),this._setInteractivityState(!0)))}_setInteractivityState(e){e?this.element.removeClass("inactive"):this.element.addClass("inactive")}_contextMenu(e){ContextMenu.create(this,e,".item",this._getItemContextOptions(),{hookName:"MassEditPresetContext",onOpen:this._onRightClickPreset.bind(this)}),ContextMenu.create(this,e,".folder header",this._getFolderContextOptions(),{hookName:"MassEditFolderContext"})}_getItemContextOptions(){return[{name:(0,d.kg)("CONTROLS.CommonEdit",!1),icon:'<i class="fas fa-edit"></i>',condition:e=>e.hasClass("editable"),callback:e=>this._onEditSelectedPresets(e)},{name:(0,d.kg)("presets.open-journal"),icon:'<i class="fas fa-book-open"></i>',callback:e=>this._onOpenJournal(e)},{name:(0,d.kg)("presets.apply-to-selected"),icon:'<i class="fas fa-arrow-circle-right"></i>',condition:e=>d.Me.includes(e.data("doc-name"))&&canvas.getLayerByEmbeddedName(e.data("doc-name")).controlled.length,callback:e=>this._onApplyToSelected(e)},{name:(0,d.kg)("Duplicate",!1),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>e.hasClass("editable"),callback:e=>this._onCopySelectedPresets(null,{keepFolder:!0,keepId:!1})},{name:(0,d.kg)("presets.copy-to-clipboard"),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>1===$(this.form).find(".item-list").find(".item.selected").length,callback:e=>this._onCopyPresetToClipboard()},{name:(0,d.kg)("presets.export-as-json"),icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportSelectedPresets()},{name:(0,d.kg)("presets.export-to-compendium"),icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportSelectedPresetsToComp()},{name:(0,d.kg)("CONTROLS.CommonDelete",!1),icon:'<i class="fas fa-trash fa-fw"></i>',condition:e=>e.hasClass("editable"),callback:e=>this._onDeleteSelectedPresets(e)}]}_getFolderContextOptions(){return[{name:"Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>{const t=this.tree.allFolders.get(e.closest(".folder").data("uuid"));return!(t instanceof u.fF)||t instanceof u.dH},callback:e=>this._onFolderEdit(e)},{name:"Export to Compendium",icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportFolder(e.closest(".folder").data("uuid"))},{name:(0,d.kg)("FOLDER.Remove",!1),icon:'<i class="fas fa-trash fa-fw"></i>',condition:e=>e.closest(".folder").hasClass("editable"),callback:e=>this._onFolderDelete(e.closest(".folder").data("uuid"))},{name:(0,d.kg)("FOLDER.Delete",!1),icon:'<i class="fas fa-dumpster"></i>',condition:e=>e.closest(".folder").hasClass("editable"),callback:e=>this._onFolderDelete(e.closest(".folder").data("uuid"),{deleteAll:!0})},{name:"Randomize Child Folder Colors",icon:'<i class="fas fa-dice"></i>',condition:()=>CONFIG.debug.MassEdit,callback:e=>(0,h.Li)(e.closest(".folder").data("uuid"),this.tree,(()=>this.render(!0)))}]}async _onExportFolder(e){let{pack:t,keepId:s}=await new Promise((e=>y(e,{exportTo:!0,keepIdSelect:!0})));if(t&&!this._importTracker?.active){this.tree.allFolders.get(e)&&(this._importTracker=await o({title:"Exporting Folder",total:r(this.tree.allFolders.get(e))}),await this._onCopyFolder(e,null,t,!0,s),this._importTracker?.stop())}}async _onCopyFolder(e,t=null,s,a=!0,n=!0){s||(s=u.A0.workingPack);const i=this.tree.allFolders.get(e),o=await fromUuid(e);if(i){let e;e=o?o.flags[d.Do]?.types??["ALL"]:["ALL"];const r={_id:n?i.id:null,name:i.name,color:i.color,sorting:i.sorting,folder:t,flags:{[d.Do]:{types:e}},type:"JournalEntry"},l=await Folder.create(r,{pack:s,keepId:n});for(const e of i.presets){if(!this._importTracker?.active)break;const t=(await e.load()).clone();t.folder=l.id,n||(t.id=foundry.utils.randomID()),await u.A0.set(t,s),this._importTracker?.incrementCount()}for(const e of i.children){if(!this._importTracker?.active)break;await this._onCopyFolder(e.uuid,l.id,s,!1,n)}a&&this.render(!0)}}async _onExportSelectedPresetsToComp(){let{pack:e,keepId:t}=await new Promise((e=>y(e,{exportTo:!0,keepIdSelect:!0})));e&&this._onCopySelectedPresets(e,{keepId:t})}async _onCopySelectedPresets(e,{keepFolder:t=!1,keepId:s=!0}={}){const[a,n]=await this._getSelectedPresets();for(const n of a){const a=n.clone();t||(a.folder=null),s||(a.id=foundry.utils.randomID()),await u.A0.set(a,e)}a.length&&this.render(!0)}async _onCopyPresetToClipboard(){const[e,t]=await this._getSelectedPresets();e.length&&(0,n.lW)(e[0])}async _getSelectedPresets({editableOnly:e=!1,full:t=!0}={}){const s=[],a=this.element.find(".item-list").find(".item.selected"+(e?".editable":""));a.each((function(){const e=$(this).data("uuid");s.push(e)}));const n=[];for(const e of s){const s=await u.A0.get(e,{full:t});s&&n.push(s)}return[n,a]}async _onExportSelectedPresets(){const[e,t]=await this._getSelectedPresets();f(e)}async _onEditSelectedPresets(e){const[t,s]=await this._getSelectedPresets({editableOnly:!0});if(t.length){const s=e.offset();s.top+=e.height(),this._editPresets(t,s)}}async _onDeleteSelectedPresets(e){const[t,s]=await this._getSelectedPresets({editableOnly:!0,full:!1});if(t.length){(0===t.length||await Dialog.confirm({title:`${(0,d.kg)("common.delete")} [ ${t.length} ]`,content:`<p>${(0,d.kg)("AreYouSure",!1)}</p><p>${(0,d.zS)("presets.delete-presets-warn",{count:t.length})}</p>`}))&&(await u.A0.delete(t),s.remove())}}async _onOpenJournal(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});t.forEach((e=>e.openJournal()))}async _onApplyToSelected(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});if(!t.length)return;const a=new Set;for(const e of t)if(a.add(e.documentName),a.size>1)return void ui.notifications.warn((0,d.kg)("presets.apply-to-selected-warn"));const i=canvas.getLayerByEmbeddedName(t[0].documentName).controlled;if(i.length)for(const e of t)(0,n.B0)(i,e,!1,!0)}async _onCreateFolder(e){const t=[];"ALL"===this.docName?t.push("ALL"):d.TA.includes(this.docName)?t.push("ALL",this.docName):t.push(this.docName);const s=new Folder.implementation({name:Folder.defaultName(),type:"JournalEntry",sorting:"m",flags:{[d.Do]:{types:t}}},{pack:u.A0.workingPack});await new Promise((e=>{new PresetFolderConfig(s,{resolve:e}).render(!0)})),this.render(!0)}async _onFolderEdit(e){const t=$(e).closest(".folder").data("uuid"),s=this.tree.allFolders.get(t);let a;a=s instanceof u.dH?new Folder.implementation({_id:s.id,name:s.name,type:"JournalEntry",color:s.color,sorting:s.sorting},{pack:s.uuid}):await fromUuid($(e).closest(".folder").data("uuid")),new Promise((t=>{const n={resolve:t,...e.offset(),folder:s};n.top+=e.height(),new PresetFolderConfig(a,n).render(!0)})).then((()=>this.render(!0)))}async _onFolderDelete(e,{render:t=!0,deleteAll:s=!1}={}){const a=this.tree.allFolders.get(e);if(a){let n;n=s?await Dialog.confirm({title:`${(0,d.kg)("FOLDER.Delete",!1)}: ${a.name}`,content:`<div style="color:red;"><h4>${(0,d.kg)("AreYouSure",!1)}</h4><p>${(0,d.kg)("FOLDER.DeleteWarning",!1)}</p></div>`}):await Dialog.confirm({title:`${(0,d.kg)("FOLDER.Remove",!1)}: ${a.name}`,content:`<h4>${(0,d.kg)("AreYouSure",!1)}</h4><p>${(0,d.kg)("FOLDER.RemoveWarning",!1)}</p>`}),n&&(await u.A0.deleteFolder(e,s),t&&this.render(!0))}}_onSearchInput(e){clearTimeout(this._searchTimer),this._searchTimer=setTimeout((()=>this._onSearch(e)),250)}async _onSearch(e){let t=e.target.value,s=MassEditPresets.lastSearch||"";if(MassEditPresets.lastSearch=t,s.length>=2&&t.length<2)return $(e.target).removeClass("active"),this._resetSearchState(),void this._renderContent();if(t.length<2)return;const a=e.target.value.trim().toLowerCase().split(" ").filter((e=>e.length>=2));a.length&&($(e.target).addClass("active"),this.tree.folders.forEach((e=>this._searchFolder(a,e))),this.tree.extFolders.forEach((e=>this._searchFolder(a,e))),this.tree.presets.forEach((e=>this._searchPreset(a,e))),this._renderContent())}_searchFolder(e,t,s=!1){const a=t.name.toLowerCase();let n=e.every((e=>a.includes(e))),i=!1;for(const a of t.children)this._searchFolder(e,a,n||s)&&(i=!0);let o=!1;for(const a of t.presets)this._searchPreset(e,a,n||s)&&(o=!0);const r=n||i||o;return t.expanded=i||o,t.render=r||s,r}_searchPreset(e,t,s=!1){const a=t.name.toLowerCase();return e.every((e=>a.includes(e)))||e.every((e=>t.tags.includes(e)))?(t._render=!0,!0):(t._render=s,!1)}_resetSearchState(){this.tree.folders.forEach((e=>this._resetSearchStateFolder(e))),this.tree.extFolders.forEach((e=>this._resetSearchStateFolder(e))),this.tree.presets.forEach((e=>this._resetSearchStatePreset(e)))}_resetSearchStateFolder(e){e.expanded=h.cm.expanded(e.uuid),e.render=!0,e.children.forEach((e=>this._resetSearchStateFolder(e))),e.presets.forEach((e=>this._resetSearchStatePreset(e)))}_resetSearchStatePreset(e){e._render=!0}async _renderContent(){const e=await renderTemplate(`modules/${d.Do}/templates/preset/presetsContent.html`,{callback:Boolean(this.callback),presets:this.tree.presets,folders:this.tree.folders,createEnabled:Boolean(this.configApp),extFolders:this.tree.extFolders.length?this.tree.extFolders:null});this.element.find(".item-list").html(e)}async _onFolderSort(e,t,{inside:s=!0,folderUuid:a=null}={}){let n,i=this.tree.allFolders.get(e),o=this.tree.allFolders.get(t);n=a?this.tree.allFolders.get(a).children:this.tree.folders;const r=[];for(const t of n)t.uuid!==e&&r.push(t);const l=SortingHelpersFixed.performIntegerSort(i,{target:o,siblings:r,sortBefore:!0});if(l.length){const e=[];l.forEach((t=>{const s=t.update;s._id=t.target.id,s.folder=this.tree.allFolders.get(a)?.id??null,e.push(s),t.target.sort=s.sort})),await Folder.updateDocuments(e,{pack:u.A0.workingPack})}this.render(!0)}async _onItemSort(e,t,{before:s=!0,folderUuid:a=null}={}){const n=new Set(e),i=this.tree.allPresets.filter((e=>n.has(e.uuid)));let o,r=this.tree.allPresets.find((e=>e.uuid===t));o=a?this.tree.allFolders.get(a).presets:this.tree.presets;const l=[];for(const e of o)n.has(e.uuid)||l.push(e);const c=SortingHelpersFixed.performIntegerSortMulti(i,{target:r,siblings:l,sortBefore:s});if(c.length){const e=[];c.forEach((t=>{const s=t.update;s._id=t.target.id,s.folder=this.tree.allFolders.get(a)?.id??null,e.push(s),t.target.sort=s.sort})),await u.A0.updatePresets(e)}this.render(!0)}async _onToggleSort(e){const t="manual"===game.settings.get(d.Do,"presetSortMode")?"alphabetical":"manual";await game.settings.set(d.Do,"presetSortMode",t),this.render(!0)}async _onToggleSearch(e){const t=$(e.target).closest(".toggle-search-mode"),s="p"===game.settings.get(d.Do,"presetSearchMode")?"pf":"p";await game.settings.set(d.Do,"presetSearchMode",s);const a=p[s];t.attr("data-tooltip",a.tooltip).html(a.icon),$(this.form).find(".header-search input").trigger("input")}_onToggleLock(e){const t=$(e.target).closest(".toggle-doc-lock");let s=game.settings.get(d.Do,"presetDocLock"),a=this.docName;a!==s?t.addClass("active"):(t.removeClass("active"),a=""),game.settings.set(d.Do,"presetDocLock",a)}_onToggleLayerSwitch(e){const t=$(e.target).closest(".toggle-layer-switch"),s=!game.settings.get(d.Do,"presetLayerSwitch");s?t.addClass("active"):t.removeClass("active"),game.settings.set(d.Do,"presetLayerSwitch",s)}async _onToggleExtComp(e){const t=$(e.target).closest(".toggle-ext-comp"),s=!game.settings.get(d.Do,"presetExtComp");s?t.addClass("active"):t.removeClass("active"),await game.settings.set(d.Do,"presetExtComp",s),this.render(!0)}async _onToggleScaling(e){const t=$(e.target).closest(".toggle-scaling"),s=!game.settings.get(d.Do,"presetScaling");s?t.addClass("active"):t.removeClass("active"),game.settings.set(d.Do,"presetScaling",s)}_onDocumentChange(e){const t=$(e.target).closest(".document-select").data("name");t!=this.docName&&(this.docName=t,"ALL"!==this.docName&&game.settings.get(d.Do,"presetLayerSwitch")&&canvas.getLayerByEmbeddedName("Actor"===this.docName?"Token":this.docName)?.activate(),this.render(!0))}async _onRightClickPreset(e){const t=$(e).closest(".item");t.hasClass("selected")||(t.closest(".item-list").find(".item.selected").removeClass("selected").removeClass("last-selected"),t.addClass("selected").addClass("last-selected"))}_editPresets(e,t={},s){t.callback=()=>this.render(!0),!("left"in t)&&s&&(t.left=s.originalEvent.x-PresetConfig.defaultOptions.width/2,t.top=s.originalEvent.y),new PresetConfig(e,t).render(!0)}async _onApplyPreset(e){if(this.callback){const t=$(e.target).closest(".item").data("uuid");this.callback(await u.A0.get(t))}}async _onPresetDragOut(e){const t=$(e.originalEvent.target).closest(".item").data("uuid"),s=await u.A0.get(t);if(!s)return;const a=function(e,t,s){const a=function(s){const a=s.position,n=a.left,i=a.top;return e>n&&e<n+a.width&&t>i&&t<i+a.height};return Object.values(ui.windows).find((e=>e.meForm&&e.documentName===s&&a(e)))}(e.pageX,e.pageY,s.documentName);if(a)return void a._applyPreset(s);if("Scene"===s.documentName)return void(0,d.XK)(s);if(!d.Me.includes(s.documentName))return;let n,i,o;if(game.Levels3DPreview?._active){game.Levels3DPreview.interactionManager._onMouseMove(e,!0);const{x:t,y:s,z:a}=game.Levels3DPreview.interactionManager.canvas2dMousePosition;n=t,i=s,o=a}else{const[t,a]=[e.clientX,e.clientY],o=canvas.stage.worldTransform;n=(t-o.tx)/canvas.stage.scale.x,i=(a-o.ty)/canvas.stage.scale.y,"Token"!==s.documentName&&"Tile"!==s.documentName||(n-=canvas.dimensions.size/2,i-=canvas.dimensions.size/2)}u.af.spawnPreset({preset:s,x:n,y:i,z:o,mousePosition:!1,layerSwitch:game.settings.get(d.Do,"presetLayerSwitch"),scaleToGrid:game.settings.get(d.Do,"presetScaling")})}async _toggleBrush(e){const t=$(e.target).closest(".item"),s=t.find(".preset-brush");let a=!1;if(this._activeBrush)if(s.is(this._activeBrush)){if(s.hasClass("spawner"))return l.vM.deactivate(),void this._onPresetBrushDeactivate();a=!0}else a=this._activeBrush.hasClass("spawner"),this._onPresetBrushDeactivate();l.vM.deactivate();const n=t.data("uuid"),i=await u.A0.get(n);if(!i)return void this._onPresetBrushDeactivate();l.vM.activate({preset:i,deactivateCallback:this._onPresetBrushDeactivate.bind(this),spawner:a})?(a&&s.addClass("spawner"),s.addClass("active").addClass("fa-bounce"),this._activeBrush=s):this._onPresetBrushDeactivate()}_onPresetBrushDeactivate(){this._activeBrush&&(this._activeBrush.removeClass("active").removeClass("fa-bounce").removeClass("spawner"),this._activeBrush=null),l.vM.deactivate()}setPosition({left:e,top:t,width:s,height:a,scale:n}={}){if(!this.popOut&&!this.options.resizable)return;const i=this.element[0],o=this.position,r=this.popOut,l=window.getComputedStyle(i);if(null===n&&(n=1),n=n??o.scale??1,"auto"!==a&&"auto"!==this.options.height||(i.style.height="",a=null),!i.style.width||s){const t=s||i.offsetWidth,a=parseInt(l.minWidth)||(r?MIN_WINDOW_WIDTH:0),c=i.style.maxWidth||window.innerWidth/n;o.width=s=Math.clamped(t,a,c),i.style.width=`${s}px`,s*n+o.left>window.innerWidth&&(e=o.left)}if(s=i.offsetWidth,!i.style.height||a){const e=a||i.offsetHeight+1,s=parseInt(l.minHeight)||(r?MIN_WINDOW_HEIGHT:0),c=i.style.maxHeight||window.innerHeight/n;o.height=a=Math.clamped(e,s,c),i.style.height=`${a}px`,a*n+o.top>window.innerHeight+1&&(t=o.top-1)}let c,d;if(a=i.offsetHeight,r&&!this.posSet||Number.isFinite(e)){const t=s*n,a=Number.isFinite(e)?e:(window.innerWidth-t)/2,i=Math.max(window.innerWidth-t,0);o.left=e=Math.clamped(a,0,i),c=e}if(r&&!this.posSet||Number.isFinite(t)){const e=a*n,s=Number.isFinite(t)?t:(window.innerHeight-e)/2,i=Math.max(window.innerHeight-e,0);o.top=Math.clamped(s,0,i),d=o.top}let u="";if(n&&(o.scale=Math.max(n,0),u+=1===n?"":`scale(${n})`),(c||d)&&(this.posSet=!0,u+="translate("+c+"px,"+d+"px)"),u&&(i.style.transform=u),!this.options.preventPositionOverride){const{left:e,top:t,width:s,height:a}=this.position;MassEditPresets.previousPosition={left:e,top:t,width:s,height:a}}return o}async close(e={}){return Boolean(this.configApp)||l.vM.deactivate(),MassEditPresets.objectHover=!1,super.close(e)}async _onPresetUpdate(e){const t=await u.A0.get($(e.target).closest(".item").data("uuid"));if(!t)return;const s=this.configApp instanceof ActiveEffectConfig?this._getActiveEffectFields():this.configApp.getSelectedFields();if(!s||foundry.utils.isEmpty(s))return void ui.notifications.warn((0,d.kg)("presets.warn-no-fields"));const n=foundry.utils.deepClone(this.configApp.randomizeFields||{}),i=foundry.utils.deepClone(this.configApp.addSubtractFields||{});"Token"===this.docName&&a.f.correctDetectionModeOrder(s,n),t.update({data:s,randomize:n,addSubtract:i}),ui.notifications.info(`Preset "${t.name}" updated`),this.render(!0)}async _onPresetCreate(e){const t=this.configApp instanceof ActiveEffectConfig?this._getActiveEffectFields():this.configApp.getSelectedFields();if(!t||foundry.utils.isEmpty(t))return void ui.notifications.warn((0,d.kg)("presets.warn-no-fields"));const s=new m.k({name:(0,d.kg)("presets.default-name"),documentName:this.docName,data:t,addSubtract:this.configApp.addSubtractFields,randomize:this.configApp.randomizeFields});await u.A0.set(s),this.render(!0),this._editPresets([s],{isCreate:!0},e)}async dropPlaceable(e,t){const s=await u.af.createPreset(e),a=e[0].document.documentName;"ALL"!==this.docName&&this.docName!==a&&(this.docName=a);const n={isCreate:!0};n.left=this.position.left+this.position.width+20,n.top=this.position.top,this._editPresets(s,n,t),this.render(!0)}async actorToPreset(e){await u.af.createPreset(placeables)}_getActiveEffectFields(){return{changes:foundry.utils.deepClone(this.configApp.object.changes??[])}}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-change-compendium",icon:"fa-solid fa-gear",onclick:e=>this._onWorkingPackChange()}),e.unshift({label:"",class:"mass-edit-export",icon:"fas fa-file-export",onclick:e=>this._onExport(e)}),e.unshift({label:"",class:"mass-edit-import",icon:"fas fa-file-import",onclick:e=>this._onImport(e)}),CONFIG.debug.MassEdit&&e.unshift({label:"Debug",class:"mass-edit-debug",icon:"fas fa-bug",onclick:e=>{console.log({index:game.packs.get(u.A0.workingPack).get(u.Xd)?.flags[d.Do]?.index,tree:this.tree})}}),e}async _onWorkingPackChange(){let e=await new Promise((e=>y(e,{})));e&&e!==u.A0.workingPack&&(await game.settings.set(d.Do,"workingPack",e),this.render(!0))}async _onExport(){f((await u.A0.getTree(null,!0)).allPresets)}async _onImport(){const e=await(0,c.h)();if(!e)return;let t=0;if("Array"===foundry.utils.getType(e))for(const s of e){if(!("documentName"in s))continue;if(!("data"in s)||foundry.utils.isEmpty(s.data))continue;const e=new m.k(s);e._pages=s.pages,await u.A0.set(e),t++}ui.notifications.info(`Mass Edit: ${(0,d.zS)("presets.imported",{count:t})}`),t&&this.render(!0)}async _updateObject(e,t){this.callback&&this.callback(await u.A0.get(e.submitter.data.id))}}async function f(e,t){if(e.length){for(const t of e)await t.load();e=e.map((e=>{const t=e.clone();return t.folder=null,t.uuid=null,t})),saveDataToFile(JSON.stringify(e,null,2),"text/json",(t??"mass-edit-presets")+".json")}}class PresetConfig extends FormApplication{static name="PresetConfig";constructor(e,t={}){super({},t),this.presets=e,this.callback=t.callback,this.isCreate=t.isCreate}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet"],template:`modules/${d.Do}/templates/preset/presetEdit.html`,width:360})}get id(){return"mass-edit-preset-edit"}get title(){return this.presets.length>1?`Presets [${this.presets.length}]`:`Preset: ${this.presets[0].name.substring(0,20)}${this.presets[0].name.length>20?"...":""}`}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-export",icon:"fas fa-file-export",onclick:e=>this._onExport(e)}),e}_onExport(){let e;1===this.presets.length&&(e="mass-edit-preset-"+this.presets[0].name.replace(" ","_").replace(/\W/g,"")),f(this.presets,e)}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t={};t.advancedOpen=this.advancedOpen,t.preset={},1===this.presets.length?(t.preset=deepClone(this.presets[0].toJSON()),t.displayFieldDelete=!0,t.displayFieldModify=!0,t.attached=this.attached||t.preset.attached,t.attached&&(t.attached=t.attached.map((e=>{let t=e.documentName;return"Token"===e.documentName&&e.data.name&&(t+=": "+e.data.name),{icon:m.a[e.documentName]??m.a.DEFAULT,tooltip:t}})))):(t.multiEdit=!0,t.preset={}),this._submitData&&foundry.utils.mergeObject(t.preset,this._submitData),t.minlength=this.presets.length>1?0:1,t.tva=game.modules.get("token-variants")?.active,!this.data||this.data instanceof Array||(t.modifyDisabled=!0,t.deleteDisabled=!0);const s=this.presets[0].documentName;return"Actor"!==s&&this.presets.every((e=>e.documentName===s))&&(t.documentEdit=s,t.isPlaceable=d.Me.includes(s)),t}activateListeners(e){super.activateListeners(e),e.find('[name="name"]').select(),e.find(".edit-document").on("click",this._onEditDocument.bind(this)),e.find(".assign-document").on("click",this._onAssignDocument.bind(this)),e.find(".delete-fields").on("click",this._onDeleteFields.bind(this)),e.find(".spawn-fields").on("click",this._onSpawnFields.bind(this)),e.find("summary").on("click",(()=>setTimeout((()=>this.setPosition({height:"auto"})),30))),e.find(".attached").on("click",this.onAttachedRemove.bind(this)),e.find(".attach-selected").on("click",(()=>{const e=canvas.activeLayer.controlled;e.length&&d.Me.includes(e[0].document.documentName)&&this.dropPlaceable(e)}));const t=e.find(".token-variants-image-select-button");t.on("click",(e=>{game.modules.get("token-variants").api.showArtSelect("Preset",{callback:(e,s)=>{t.siblings(`[name="${t.data("target")}"]`).val(e)},searchType:"Item"})})),e.find("details").on("toggle",(e=>{this.advancedOpen=Boolean($(e.target).attr("open"))}));const s=e.closest(".window-content").find(".drag-drop-overlay");e.closest(".window-content").on("mouseover",(e=>{1===this.presets.length&&(canvas.activeLayer?.preview?.children.some((e=>e._original?.mouseInteractionManager?.isDragging))?(s.show(),PresetConfig.objectHover=!0):(s.hide(),PresetConfig.objectHover=!1))})).on("mouseout",(()=>{1===this.presets.length&&(s.hide(),PresetConfig.objectHover=!1)})),d.Fo.activateListeners(e,(()=>this.setPosition({height:"auto"})))}_getSubmitData(e={}){const t=super._getSubmitData(e);return t.name=t.name.trim(),t.img=t.img.trim()||null,t.preSpawnScript=t.preSpawnScript?.trim(),t.postSpawnScript=t.postSpawnScript?.trim(),t.tags=t.tags?t.tags.split(","):[],t.addTags=t.addTags?t.addTags.split(","):[],t.removeTags=t.removeTags?t.removeTags.split(","):[],t}async render(e=!1){return this.form&&(this._submitData=this._getSubmitData()),await super.render(e)}async dropPlaceable(e,t){this.advancedOpen=!0,this.attached||(this.attached=deepClone(this.presets[0].attached??[])),e.forEach((e=>this.attached.push({documentName:e.document.documentName,data:(0,h.h)(e)}))),await this.render(!0),setTimeout((()=>this.setPosition({height:"auto"})),30)}async onAttachedRemove(e){const t=$(e.target).closest(".attached").data("index");this.attached=this.attached||deepClone(this.presets[0].attached),this.attached.splice(t,1),await this.render(!0),setTimeout((()=>this.setPosition({height:"auto"})),30)}async _onSpawnFields(){new PresetFieldModify(this.data??this.presets[0].data,(e=>{this.modifyOnSpawn=e}),this.modifyOnSpawn??this.presets[0].modifyOnSpawn).render(!0)}async _onDeleteFields(){new PresetFieldDelete(this.data??this.presets[0].data,(e=>{this.data=e})).render(!0)}async _onAssignDocument(){const e=canvas.getLayerByEmbeddedName(this.presets[0].documentName);if(!e)return;const t=e.controlled.map((e=>(0,h.h)(e)));t.length&&(this.data=t,ui.notifications.info((0,d.zS)("presets.assign",{count:t.length,document:this.presets[0].documentName})),this.gridSize=canvas.grid.size,this.modifyOnSpawn=[],this.render(!0))}async _onEditDocument(){const e=[],t=CONFIG[this.presets[0].documentName].documentClass;for(const s of this.presets)s.data.forEach((a=>e.push(new t((0,h.Go)(s,a)))));const s=await(0,i.gx)(e,null,{presetEdit:!0,callback:e=>{this.addSubtract={},this.randomize={};for(const t of Object.keys(e.data))t in e.randomize&&(this.randomize[t]=e.randomize[t]),t in e.addSubtract&&(this.addSubtract[t]=e.addSubtract[t]);this.data=e.data,this.render(!0)},forceForm:!0}),a=new m.k({data:{},randomize:this.presets[0].randomize,addSubtract:this.presets[0].addSubtract});setTimeout((()=>{s._applyPreset(a)}),400)}async _updatePresets(e){for(const t of this.presets){let s;if(s=this.isCreate?{name:e.name||t.name||(0,d.kg)("presets.default-name"),img:e.img??t.img}:{name:e.name||t.name,img:e.img||t.img},this.data&&(s.data=this.data),this.addSubtract&&(s.addSubtract=this.addSubtract),this.randomize&&(s.randomize=this.randomize),this.modifyOnSpawn&&(s.modifyOnSpawn=this.modifyOnSpawn),this.gridSize&&(s.gridSize=this.gridSize),this.attached&&(s.attached=this.attached),null!=e.preSpawnScript&&(s.preSpawnScript=e.preSpawnScript),null!=e.postSpawnScript&&(s.postSpawnScript=e.postSpawnScript),null!=e.spawnRandom&&(s.spawnRandom=e.spawnRandom),1===this.presets.length)s.tags=e.tags;else if(e.addTags.length||e.removeTags.length){let a=t.tags??[];e.addTags.length&&(a=Array.from(new Set(a.concat(e.addTags)))),e.removeTags.length&&(a=a.filter((t=>!e.removeTags.includes(t)))),s.tags=a}await t.update(s)}}async _updateObject(e,t){return await this._updatePresets(t),this.callback&&this.callback(this.presets),this.presets}async _renderOuter(){const e=await super._renderOuter();return this._createDocumentIdLink(e),e}_createDocumentIdLink(e){const t=e.find(".window-title"),s=(0,d.kg)("DOCUMENT.JournalEntry",!1),a=document.createElement("a");a.classList.add("document-id-link"),a.setAttribute("alt","Copy document id"),a.dataset.tooltip=`${s}: ${this.presets.map((e=>e.id)).join(", ")}`,a.dataset.tooltipDirection="UP",a.innerHTML='<i class="fa-solid fa-passport"></i>',a.addEventListener("click",(e=>{e.preventDefault(),game.clipboard.copyPlainText(this.presets.map((e=>e.id)).join(", ")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"id",id:this.presets.map((e=>e.id)).join(", ")}))})),a.addEventListener("contextmenu",(e=>{e.preventDefault(),game.clipboard.copyPlainText(this.presets.map((e=>e.uuid)).join(", ")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"uuid",id:this.presets.map((e=>e.uuid)).join(", ")}))})),t.append(a)}}class PresetFieldSelect extends FormApplication{static name="PresetFieldSelect";constructor(e,t){super(),this.presetData=e,this.isObject=!(e instanceof Array),this.callback=t}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","preset-field-select"],template:`modules/${d.Do}/templates/preset/presetFieldSelect.html`,width:600,resizable:!1})}activateListeners(e){super.activateListeners(e),e.find(".item").on("click",this._onFieldClick)}_onFieldClick(e){b(e,$(e.target).closest(".preset-field-list"))}async getData(e={}){let t=foundry.utils.flattenObject(this.presetData);const s=!this.isObject&&1===this.presetData.length;let a,n=[];for(const[e,i]of Object.entries(t)){if(!s){const t=e.split(".")[0];a?t!==a&&n.push({header:!0,index:t}):n.push({header:!0,index:0}),a=t}let t,o=e;s&&(o=o.substring(o.indexOf(".")+1));const r=foundry.utils.getType(i);t="Object"===r||"Array"===r||"null"===r?JSON.stringify(i):i,n.push({name:e,label:o,value:t,selected:!1})}return{fields:n}}}class PresetFieldDelete extends PresetFieldSelect{static name="PresetFieldDelete";get title(){return(0,d.kg)("presets.select-delete")}async getData(e={}){const t=await super.getData(e);return t.button={icon:'<i class="fas fa-trash"></i>',text:(0,d.kg)("common.delete")},t}async _updateObject(e,t){let s=foundry.utils.flattenObject(this.presetData);if($(e.target).closest("form").find(".item.selected").each((function(){const e=$(this).attr("name");delete s[e]})),s=expandObject(s),!this.isObject){let e=[];for(let t=0;t<this.presetData.length;t++)s[t]&&e.push(s[t]);s=e}this.callback(s)}}class PresetFieldModify extends PresetFieldSelect{static name="PresetFieldModify";constructor(e,t,s){super(e,t),this.modifyOnSpawn=s??[]}get title(){return(0,d.kg)("presets.select-modify")}async getData(e={}){const t=await super.getData(e);t.button={icon:'<i class="fas fa-check"></i>',text:(0,d.kg)("CONTROLS.CommonSelect",!1)};for(const e of t.fields)this.modifyOnSpawn.includes(e.name)&&(e.selected=!0);return t}async _updateObject(e,t){const s=$(e.target).closest("form"),a=[];s.find(".item.selected").each((function(){let e=$(this).attr("name");a.push(e)})),this.callback(a)}}class PresetFolderConfig extends FolderConfig{static name="PresetFolderConfig";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","folder-edit"],template:`modules/${d.Do}/templates/preset/presetFolderEdit.html`,width:360})}get id(){return this.object.id?super.id:"folder-create"}get title(){return this.object.id?`${(0,d.kg)("FOLDER.Update",!1)}: ${this.object.name}`:(0,d.kg)("FOLDER.Create",!1)}activateListeners(e){super.activateListeners(e),e.find(".document-select").on("click",this._onDocumentChange.bind(this))}_onDocumentChange(e){$(e.target).closest(".document-select").toggleClass("active")}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t=this.document.toObject(),s=(0,d.kg)(Folder.implementation.metadata.label,!1);let a,n=t.flags[d.Do]?.types??["ALL"];return this.options?.folder instanceof u.dH||1===n.length&&!d.TA.includes(n[0])?this.displayTypes=!1:(this.displayTypes=!0,a=[],d.TA.forEach((e=>{a.push({name:e,icon:m.a[e],active:n.includes(e)})}))),{folder:t,name:t._id?t.name:"",newName:(0,d.zS)("DOCUMENT.New",{type:s},!1),safeColor:t.color??"#000000",sortingModes:{a:"FOLDER.SortAlphabetical",m:"FOLDER.SortManual"},submitText:(0,d.kg)(t._id?"FOLDER.Update":"FOLDER.Create",!1),docs:a,virtualPackFolder:this.options.folder instanceof u.dH,group:this.options.folder?.group}}async _updateObject(e,t){if(this.displayTypes){let e=[];$(this.form).find(".document-select.active").each((function(){e.push($(this).data("name"))})),e.length||e.push("ALL"),t[`flags.${d.Do}.types`]=e}let s=this.object;if(this.options.folder instanceof u.dH){let e={};["name","color","group"].forEach((s=>{t[s]?.trim()?e[s]=t[s].trim():e["-="+s]=null})),await this.options.folder.update(e)}else t.name?.trim()||(t.name=Folder.implementation.defaultName()),this.object.id?await this.object.update(t):(this.object.updateSource(t),s=await Folder.create(this.object,{pack:this.object.pack}));return this.options.resolve?.(s),s}}function y(e,{excludePack:t,exportTo:s=!1,keepIdSelect:a=!1}={}){let n;n=s?{title:(0,d.kg)("presets.select-compendium"),message:(0,d.kg)("presets.export-directory-message"),buttonLabel:(0,d.kg)("FOLDER.Export",!1)}:{title:(0,d.kg)("presets.select-compendium"),message:(0,d.kg)("presets.working-directory-message"),buttonLabel:(0,d.kg)("common.swap")};let i="";for(const e of game.packs)if(!e.locked&&"JournalEntry"===e.documentName){if(e.collection===t)continue;const s=e.collection===u.A0.workingPack;i+=`<option value="${e.collection}" ${s?'selected="selected"':""}>${e.title}</option>`}let o=`\n  <p style="color: orangered;">${n.message}</p>\n  <div class="form-group">\n    <label>${(0,d.kg)("PACKAGE.TagCompendium",!1)}</label>\n    <div class="form-fields">\n      <select style="width: 100%; margin-bottom: 10px;">${i}</select>\n    </div>\n  </div>`;a&&(o+=`\n<div class="form-group">\n    <label>${(0,d.kg)("presets.keep-ids")}</label>\n    <input type="checkbox" name="keepId" checked>\n    <p style="font-size: smaller;">${(0,d.kg)("presets.keep-ids-hint")}</p>\n</div>`),new Dialog({title:n.title,content:o,buttons:{export:{label:n.buttonLabel,callback:t=>{const s=$(t).find("select").val();e(a?{pack:s,keepId:$(t).find('[name="keepId"]').is(":checked")}:s)}},cancel:{label:(0,d.kg)("Cancel",!1),callback:()=>e(a?{}:null)}},close:()=>e(a?{}:null),default:"cancel"}).render(!0)}function b(e,t){const s=$(e.target).closest(".item"),a=t.find(".item"),n=a.filter(".last-selected");if(e.ctrlKey||e.metaKey||e.shiftKey){if(e.ctrlKey||e.metaKey)s.toggleClass("selected"),s.hasClass("selected")?(n.removeClass("last-selected"),s.addClass("last-selected")):s.removeClass("last-index");else if(e.shiftKey)if(n.length){let e=a.index(s),t=a.index(n);if(e===t)s.toggleClass("selected"),s.hasClass("selected")?s.addClass("last-selected"):n.removeClass("last-selected");else{let s=a.toArray();if(e>t)for(let a=t;a<=e;a++)$(s[a]).addClass("selected");else for(let a=t;a>=e;a--)$(s[a]).addClass("selected")}}else n.removeClass("last-selected"),s.toggleClass("selected"),s.hasClass("selected")&&s.addClass("last-selected")}else n.removeClass("last-selected"),a.removeClass("selected"),s.addClass("selected").addClass("last-selected")}},671:(e,t,s)=>{s.d(t,{a:()=>l,k:()=>Preset});var a=s(120),n=s(652),i=s(575);const o=["id","name","sort","folder"],r=["id","name","data","sort","folder","uuid","documentName","addSubtract","randomize","img","gridSize","modifyOnSpawn","preSpawnScript","postSpawnScript","spawnRandom","attached","tags"],l={ALL:"fas fa-globe",Token:"fas fa-user-circle",MeasuredTemplate:"fas fa-ruler-combined",Tile:"fa-solid fa-cubes",Drawing:"fa-solid fa-pencil-alt",Wall:"fa-solid fa-block-brick",AmbientLight:"fa-regular fa-lightbulb",AmbientSound:"fa-solid fa-music",Note:"fa-solid fa-bookmark",Actor:"fas fa-user-alt",Scene:"fas fa-map",DEFAULT:"fa-solid fa-question"};class Preset{static name="Preset";document;constructor(e){this.id=e.id??e._id??foundry.utils.randomID(),this.name=e.name??"Mass Edit Preset",this.documentName=e.documentName,this.sort=e.sort??0,this.tags=e.tags??[],this.addSubtract=e.addSubtract instanceof Array?Object.fromEntries(e.addSubtract):foundry.utils.deepClone(e.addSubtract??{}),this.randomize=e.randomize instanceof Array?Object.fromEntries(e.randomize):foundry.utils.deepClone(e.randomize??{}),this.data=foundry.utils.deepClone(e.data),this.img=e.img,this.folder=e.folder,this.uuid=e.uuid,this.gridSize=e.gridSize,this.modifyOnSpawn=e.modifyOnSpawn,this.preSpawnScript=e.preSpawnScript,this.postSpawnScript=e.postSpawnScript,this.attached=e.attached,this.spawnRandom=e.spawnRandom,this._visible=!0,this._render=!0}get visible(){return this._visible&&this._render}get icon(){return l[this.documentName]??l.DEFAULT}get thumbnail(){return this.img||CONST.DEFAULT_TOKEN}get pages(){return this.document?.pages.size?this.document.toJSON().pages:this._pages?this._pages:null}set data(e){this._data=e instanceof Array?e:null==e?null:[e]}get isPlaceable(){return a.Me.includes(this.documentName)}get data(){return this._data}async load(){if(!this.document&&this.uuid&&(this.document=await fromUuid(this.uuid),this.document)){const e=this.document.getFlag(a.Do,"preset")??{};this.documentName=e.documentName,this.img=e.img,this.data=e.data,this.randomize="Object"===foundry.utils.getType(e.randomize)?e.randomize:Object.fromEntries(e.randomize??[]),this.addSubtract="Object"===foundry.utils.getType(e.addSubtract)?e.addSubtract:Object.fromEntries(e.addSubtract??[]),this.gridSize=e.gridSize,this.modifyOnSpawn=e.modifyOnSpawn,this.preSpawnScript=e.preSpawnScript,this.postSpawnScript=e.postSpawnScript,this.attached=e.attached,this.spawnRandom=e.spawnRandom,this.tags=e.tags??[]}return this}async openJournal(){this.document||await this.load(),this.document&&this.document.sheet.render(!0)}async attach(e){if(e){e instanceof Array||(e=[e]),this.attached||(this.attached=[]);for(const t of e)this.attached.push({documentName:t.document.documentName,data:(0,i.h)(t)});await this.update({attached:this.attached})}}async update(e){if(this.document){const t={};if(Object.keys(e).forEach((s=>{"randomize"===s||"addSubtract"===s?(t[s]=Object.entries(e[s]),this[s]=e[s]):"data"!==s||e.data instanceof Array?r.includes(s)&&e[s]!==this[s]&&(t[s]=e[s],this[s]=e[s]):(t.data=this.data.map((t=>foundry.utils.mergeObject(t,e.data))),this.data=t.data)})),!foundry.utils.isEmpty(t)){const e={flags:{[a.Do]:{preset:t}}};o.forEach((s=>{s in t&&this.document[s]!==t[s]&&(e[s]=t[s])})),await this.document.update(e)}await this._updateIndex(t)}else console.warn("Updating preset without document",this.id,this.uuid,this.name)}async _updateIndex(e){const t={};if(n.XF.forEach((s=>{s in e&&(t[s]=e[s])})),!foundry.utils.isEmpty(t)){const e=game.packs.get(this.document.pack),s=await e.getDocument(n.Xd);if(!s)return void console.warn(`META INDEX missing in ${this.document.pack}`);{let e={};e[this.id]=t,await s.setFlag(a.Do,"index",e)}}}toJSON(){let e={};r.forEach((t=>{e[t]=this[t]})),e.randomize=Object.entries(e.randomize??{}),e.addSubtract=Object.entries(e.addSubtract??{});const t=this.pages;return t&&(e.pages=t),e}clone(){const e=new Preset(this.toJSON());return e.document=this.document,e}}},575:(e,t,s)=>{s.d(t,{Go:()=>l,Li:()=>c,Q2:()=>u,Ym:()=>d,cm:()=>FolderState,e9:()=>r,h:()=>o});var a=s(739),n=s(465),i=s(120);s(671);class FolderState{static expanded(e){return game.folders._expanded[e]}static setExpanded(e,t){game.folders._expanded[e]=t}}function o(e){const t=e.document.toCompendium();if("Token"===e.document.documentName&&game.modules.get("token-attacher")?.active&&tokenAttacher?.generatePrototypeAttached){const e=t.flags?.["token-attacher"]?.attached||{};if(!foundry.utils.isEmpty(e)){const s=tokenAttacher.generatePrototypeAttached(t,e);setProperty(t,"flags.token-attacher.attached",null),setProperty(t,"flags.token-attacher.prototypeAttached",s),setProperty(t,"flags.token-attacher.grid",{size:canvas.grid.size,w:canvas.grid.w,h:canvas.grid.h})}}return t}async function r(e,t){const s={},n=foundry.utils.flattenObject(e);for(const e of t)e in n&&(null==n[e]?s[e]="":s[e]=n[e]);return foundry.utils.isEmpty(s)||await new Promise((t=>{(0,a.Ls)(s,"PresetFieldModify",{callback:s=>{if(foundry.utils.isEmpty(s))return null==s&&(e=null),void t();for(const[e,t]of Object.entries(s))n[e]=t;const a=foundry.utils.expandObject(n),i=[];for(let t=0;t<e.length;t++)i.push(a[t]);e=i,t()},simplified:!0,noTabs:!0})})),e}function l(e,t){let s;switch(e.documentName){case"Token":s={name:e.name,elevation:0,x:0,y:0};break;case"Tile":s={width:canvas.grid.w,height:canvas.grid.h,x:0,y:0};break;case"AmbientSound":s={radius:20,x:0,y:0};break;case"Drawing":s={shape:{width:2*canvas.grid.w,height:2*canvas.grid.h,strokeWidth:8,strokeAlpha:1},x:0,y:0};break;case"MeasuredTemplate":s={distance:10,x:0,y:0};break;case"AmbientLight":if(null==t.config?.dim&&null==t.config?.bright){s={config:{dim:20,bright:20},x:0,y:0};break}case"Scene":s={name:e.name};break;default:s={x:0,y:0}}return foundry.utils.mergeObject(s,t)}async function c(e,t,a){const o=t.allFolders.get(e).children;if(!o.length)return;const r=await renderTemplate(`modules/${i.Do}/templates/randomizer/color.html`,{method:"interpolateReverse",space:"srgb",hue:"longer"});let l;let c=new Dialog({title:"Pick Range",content:`<form>${r}</form>`,buttons:{save:{label:"Apply",callback:async e=>{!async function(e,t,s){const i=o.map((e=>({color:"#000000"}))),r={color:{type:"color",method:e,space:t,hue:s,colors:l.getColors()}};await(0,n.of)(i,o,r);for(let e=0;e<o.length;e++)await o[e].update(i[e]);a?.()}(e.find('[name="method"]').val(),e.find('[name="space"]').val(),e.find('[name="hue"]').val())}}},render:e=>{Promise.all([s.e(646),s.e(236)]).then(s.bind(s,236)).then((t=>{l=new t.ColorSlider(e,[{hex:"#663600",offset:0},{hex:"#944f00",offset:100}]),setTimeout((()=>c.setPosition({height:"auto"})),100)}))}});c.render(!0)}function d(e){const t=function(e){let t=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER;return e.forEach(((e,i)=>{for(const o of e){const e=m(i,o);e.x1<t&&(t=e.x1),e.y1<s&&(s=e.y1),e.x2>a&&(a=e.x2),e.y2>n&&(n=e.y2)}})),{x:t,y:s,width:a-t,height:n-s}}(e),s=t.x+t.width/2,a=t.y+t.height/2,n=u(e);return{x:s+n.x,y:a+n.y}}function u(e){const[t,s]=e.entries().next().value,a={};if("Wall"===t){const e=s[0].c;a.x=-e[0],a.y=-e[1]}else{a.x=-s[0].x,a.y=-s[0].y;const e=s[0].elevation??s[0].flags?.levels?.rangeBottom??0;a.z=-e}return a}function m(e,t){let s,a,n,i;if("Wall"===e)s=Math.min(t.c[0],t.c[2]),a=Math.min(t.c[1],t.c[3]),n=Math.max(t.c[0],t.c[2]),i=Math.max(t.c[1],t.c[3]);else{let o,r;s=t.x||0,a=t.y||0,"Tile"===e?(o=t.width,r=t.height):"Drawing"===e?(o=t.shape.width,r=t.shape.height):"Token"===e?(o=t.width*canvas.dimensions.size,r=t.height*canvas.dimensions.size):(o=0,r=0),n=s+(o||0),i=a+(r||0)}return{x1:s,y1:a,x2:n,y2:i}}},465:(e,t,s)=>{s.d(t,{Bd:()=>n,RZ:()=>o,Rn:()=>l,_j:()=>i,of:()=>r});var a=s(120);function n(e){const t=e.closest(".form-group");t.find(".mass-edit-checkbox input").prop("checked",!0).trigger("change"),t.find(".mass-edit-randomize").addClass("active")}function i(e,t){const s=e.closest(".form-group");let a=!0;t&&s.find("[name]").each((function(){a&&(a=!Boolean(t.randomizeFields[this.name]))})),a&&(s.find(".mass-edit-checkbox input").prop("checked",!1).trigger("change"),s.find(".mass-edit-randomize").removeClass("active"))}function o(e,t){if(t)for(const s of Object.keys(t))n(e.find(`[name="${s}"]`))}async function r(e,t,n){if(!n||foundry.utils.isEmpty(n))return;let i=!1;for(let o=0;o<e.length;o++){const r=e[o];for(const l of Object.keys(r))if(l in n){const c=n[l];if("select"===c.type)r[l]=c.selection[Math.floor(Math.random()*c.selection.length)];else if("number"===c.type)if(c.step="any"===c.step?1:Number(c.step),Number.isNaN(c.step)&&(c.step=1),"interpolate"===c.method){const e=(c.max-c.min)/c.step+1;r[l]=o%e*c.step+c.min}else if("interpolateReverse"===c.method){const e=(c.max-c.min)/c.step;r[l]=(e-o%(e+1))*c.step+c.min}else{const e=(c.max-c.min+(Number.isInteger(c.step)?1:0))/c.step;r[l]=Math.floor(Math.random()*e)*c.step+c.min}else if("boolean"===c.type)r[l]=Math.random()<.5;else if("color"===c.type){if(c.color1&&(c.colors=[{hex:c.color1,offset:0},{hex:c.color2,offset:100}]),"discrete"===c.space){"interpolate"===c.method?r[l]=c.colors[o%c.colors.length].hex:"interpolateReverse"===c.method?r[l]=c.colors[c.colors.length-1-o%c.colors.length].hex:r[l]=c.colors[Math.floor(Math.random()*c.colors.length)].hex;continue}let t,a=c.colors.map((e=>e));a[0].offset>0&&a.unshift({hex:a[0].hex,offset:0}),a[a.length-1].offset<100&&a.push({hex:a[a.length-1].hex,offset:100}),t="interpolate"===c.method?1-(o+1)/e.length:"interpolateReverse"===c.method?(o+1)/e.length:Math.random(),t*=100;let n,i,d=0;for(;d<a.length-1&&a[d+1].offset<t;)d++;d===a.length-1?(n=a[d-1],i=a[d]):(n=a[d],i=a[d+1]);let u=t-n.offset;u/=i.offset-n.offset;const m=(await s.e(646).then(s.bind(s,646))).default;n=new m(n.hex),i=new m(i.hex);const h=c.space||"srgb",g=c.hue||"shorter";let p=n.range(i,{space:h,hue:g,outputSpace:"srgb"})(u).toString({format:"hex"});p.length<7&&(p="#"+p[1]+p[1]+p[2]+p[2]+p[3]+p[3]),r[l]=p}else if("image"===c.type){if("sequential"===c.method?r[l]=c.images[o%c.images.length]:r[l]=c.images[Math.floor(Math.random()*c.images.length)],c.maintainAspect){const e=t?.[o]?.width??r.width,s=t?.[o]?.height??r.height;if(null!=s&&null!=e)try{const t=await loadTexture(r[l]);if(t){const a=e/s,n=t.width/t.height;n!==a&&(n>a?(r["texture.scaleX"]=1,r["texture.scaleY"]=a):(r["texture.scaleX"]=s/e,r["texture.scaleY"]=1))}}catch(e){}}}else if("text"===c.type)if("findAndReplace"===c.method||"findAndReplaceRegex"===c.method){if(t){const e=foundry.utils.flattenObject((0,a.bQ)(t[o]).toObject());e[l]||c.find?e[l]&&("flags.tagger.tags"===l&&(e[l]=e[l].join(",")),"findAndReplaceRegex"===c.method?r[l]=(0,a.H6)(c.find,c.replace,e[l]):r[l]=(0,a.OV)(c.find,c.replace,e[l])):r[l]=c.replace}}else"unique"===c.method?(c.shuffled||(d(c.strings),c.shuffled=!0,c.i=-1),c.i++,r[l]=c.strings[c.i%c.strings.length]):r[l]=c.strings[Math.floor(Math.random()*c.strings.length)];else"coordinate"===c.type&&(i=!0)}}if(i){let s,a=[];for(let s=0;s<t.length;s++)a.push({p:t[s],update:e[s]});a.sort(((e,t)=>(t.p.w??t.p.width??0)+(t.p.h??t.p.height??0)-(e.p.w??e.p.width??0)-(e.p.h??e.p.height??0)));for(const e of a){const t=n.x??n.y;if("noOverlap"===t.method){s||(s={freeId:0,boundingBox:t.boundingBox,freeRectangles:{0:t.boundingBox},stepX:t.stepX,stepY:t.stepY});const[a,n]=u(e.p,s);e.update.x=a,e.update.y=n}}}}function l(e,t){return e%t<=t/2?e-e%t:e-e%t+t}function c(e,t,s){const a=(t-e)/(s="any"===s?1:Number(s));return Math.floor(Math.random()*(a+(Number.isInteger(s)?1:0)))*s+e}function d(e){for(var t,s=e.length,a=0;s--;)a=Math.floor(Math.random()*(s+1)),t=e[s],e[s]=e[a],e[a]=t;return e}function u(e,t){const s={x:0,y:0,width:l(e.w??e.width,t.stepX),height:l(e.h??e.height,t.stepY)},a=t.freeRectangles;let n=Object.keys(a).filter((e=>{return t=a[e],(n=s).width<=t.width&&n.height<=t.height;var t,n}));if(n.length){const e=n[Math.floor(Math.random()*n.length)];s.x=c(a[e].x,Math.max(a[e].x+a[e].width-s.width,0),t.stepX),s.y=c(a[e].y,Math.max(a[e].y+a[e].height-s.height,0),t.stepY)}else s.x=c(t.boundingBox.x,Math.max(t.boundingBox.x+t.boundingBox.width-s.width,t.boundingBox.x),t.stepX),s.y=c(t.boundingBox.y,Math.max(t.boundingBox.y+t.boundingBox.height-s.height,t.boundingBox.y),t.stepY);let i=Object.keys(a).filter((e=>{return t=a[e],n=s,t.x<n.x+n.width&&n.x<t.x+t.width&&t.y<n.y+n.height&&n.y<t.y+t.height;var t,n}));for(const e of i){const n=a[e];delete a[e],n.x<s.x&&m(a,{x:n.x,y:n.y,width:s.x-n.x,height:n.height},t),n.x+n.width>s.x+s.width&&m(a,{x:s.x+s.width,y:n.y,width:n.x+n.width-(s.x+s.width),height:n.height},t),n.y<s.y&&m(a,{x:n.x,y:n.y,width:n.width,height:s.y-n.y},t),n.y+n.height>s.y+s.height&&m(a,{x:n.x,y:s.y+s.height,width:n.width,height:n.y+n.height-(s.y+s.height)},t)}return[s.x,s.y]}function m(e,t,s){const a=Object.keys(e);for(const s of a)if(n=e[s],i=t,n.x<=i.x&&n.x+n.width>=i.x+i.width&&n.y<=i.y&&n.y+n.height>=i.y+i.height)return;var n,i;s.freeId++,e[s.freeId]=t}},120:(e,t,s)=>{s.d(t,{AU:()=>SeededRandom,Do:()=>u,Fo:()=>TagInput,H6:()=>E,HG:()=>j,Me:()=>o,Ng:()=>O,O8:()=>c,OV:()=>T,TA:()=>r,Tx:()=>b,VS:()=>N,XK:()=>F,YY:()=>v,bQ:()=>p,cZ:()=>h,dS:()=>P,dT:()=>D,f6:()=>_,ht:()=>w,jz:()=>g,kg:()=>M,lv:()=>d,m1:()=>k,p:()=>y,qE:()=>l,uv:()=>f,w$:()=>x,wu:()=>m,zS:()=>A});var a=s(998),n=s(294),i=s(465);const o=["Token","MeasuredTemplate","Tile","Drawing","Wall","AmbientLight","AmbientSound","Note"],r=["ALL",...o],l=[...o,"Actor","PlaylistSound","Scene"],c=[...o,"Scene","Actor","PlaylistSound"],d=["Item","Cards","RollTable","Actor","JournalEntry","Scene"];const u="multi-token-edit";function m(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),["jpg","jpeg","png","svg","webp","gif"].includes(t)}function h(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),["mp4","ogg","webm","m4v"].includes(t)}async function g(e,t,s,a=[]){const n=await FilePicker.browse(t,e,{bucket:s});if(n){for(const e of n.files)a.push(e);for(const e of n.dirs)await g(e,t,s,a)}return a}function p(e){return e.document?e.document:e}function f(e,t,s){if(e[t]==s)return!0;const a=null==s||!1===s||""===s||"Object"===foundry.utils.getType(s)&&foundry.utils.isEmpty(s),n=null==e[t]||!1===e[t]||""===e[t]||"Object"===foundry.utils.getType(e[t])&&foundry.utils.isEmpty(e[t]);if(a&&n)return!0;if("flags.tagger.tags"===t){const a=e[t]||[];let n=s;Array.isArray(n)||(n=s?s.split(",").map((e=>e.trim())):[]);for(const e of n)if(!a.includes(e))return!1;return!0}return!(!s||"string"!=typeof s||!s.includes("*"))&&D(s,e[t])}function y(e,t){const s=e.split(".");for(let e=s.length-1;e>=1;e--){const a=s.slice(0,e).join(".")+".-="+s[e];if(a in t)return a}return null}function b(e,t){if(t)for(const s of Object.keys(t))e.find(`[name="${s}"]`).removeClass("me-add").removeClass("me-subtract").addClass("add"===t[s].method?"me-add":"me-subtract").attr("title","add"===t[s].method?`+ ${M("form.adding")}`:`- ${M("form.subtracting")}`)}function v(e,t,s,n){if(n&&!foundry.utils.isEmpty(n))for(let i=0;i<e.length;i++){const o=e[i],r=foundry.utils.flattenObject(p(t[i]).toObject());a.A.dataToForm(s,t[i],r);for(const e of Object.keys(o))if(e in n&&e in r){const t=n[e];let s=r[e];if("flags.tagger.tags"===e){const a=Array.isArray(s)?s:(s??"").split(",").map((e=>e.trim())),n=(o[e]??"").split(",").map((e=>e.trim()));for(const e of n)if("add"===t.method)a.includes(e)||a.push(e);else if("subtract"===t.method){const t=a.indexOf(e);t>-1&&a.splice(t,1)}o[e]=a.filter((e=>e)).join(",");continue}if("text"===t.type){if("add"===t.method){const a="value"in t?t.value:o[e];a.startsWith(">>")?s=a.replace(">>","")+s:s+=a}else s=s.replace("value"in t?t.value:o[e],"");o[e]=s;continue}"add"===t.method?s+="value"in t?t.value:o[e]:s-="value"in t?t.value:o[e],"min"in t&&s<t.min?s=t.min:"max"in t&&s>t.max&&(s=t.max),o[e]=s}}}function k(e){if(!e||!e.length)return{};const t=foundry.utils.flattenObject(e[0]);for(let s=1;s<e.length;s++){const a=foundry.utils.flattenObject(foundry.utils.diffObject(t,foundry.utils.flattenObject(e[s])));for(const e of Object.keys(a))(""!==a[e]&&null!=a[e]||""!==t[e]&&null!=t[e])&&delete t[e]}return t}function w(e,t={},s=""){if(t)for(const[a,n]of Object.entries(e)){const i=s?s+"."+a:a;if("Object"===foundry.utils.getType(n))w(n,t,i);else{const s=getProperty(t,i);void 0!==s&&(e[a]=s)}}}function x(e){if((e=e.map((e=>e.object??e)).filter((e=>e.center))).length)if(1===e.length)e[0].center?.x&&canvas.animatePan({x:e[0].center.x,y:e[0].center.y,duration:250});else{const t={x:999999999,y:999999999},s={x:-999999999,y:-999999999};for(let a of e){let e=a;a instanceof Wall&&(e={x:a.center.x-a.width/2,y:a.center.y-a.height/2}),e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.x+a.width>s.x&&(s.x=e.x+a.width),e.y+a.height>s.y&&(s.y=e.y+a.height)}let a=canvas.scene._viewPosition.scale;const n=100;s.x-t.x+n>canvas.screenDimensions[0]/a&&(a=canvas.screenDimensions[0]/(s.x-t.x+n)),s.y-t.y+n>canvas.screenDimensions[1]/a&&(a=canvas.screenDimensions[1]/(s.y-t.y+n)),canvas.animatePan({duration:250,scale:a,x:(s.x-t.x)/2+t.x,y:(s.y-t.y)/2+t.y})}}function S(e){return e.replace(/[/\-\\^$+?.()|[\]{}]/g,"\\$&")}function D(e,t){return new RegExp("^"+S(e).replaceAll("*",".*")+"$").test(t)}function T(e,t,s){let a=new RegExp(S(e).replaceAll("*",".*"),"g");return s.replaceAll(a,t)}function E(e,t,s){try{let a=new RegExp(e,"g");return s.replaceAll(a,t)}catch(e){}return s}function P(e){const t=function(t){new n.P(e,(async s=>{foundry.utils.isEmpty(s.randomize)||await(0,i.of)(s.data,null,s.randomize);const a=e.object.changes??[];let n=[];Object.keys(s.data[0]).forEach((e=>{let a;a="string"===foundry.utils.getType(s.data[0][e])?s.data[0][e]:JSON.stringify(s.data[0][e]),n.push({key:"Token"===t?"ATL."+e:e,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE,priority:20,value:a})}));for(let e=a.length-1;e>=0;e--)n.find((t=>t.key===a[e].key))||n.unshift(a[e]);e.object.update({changes:n})}),t).render(!0)};new Dialog({title:M("common.presets"),content:"",buttons:{activeEffect:{label:"ActiveEffect",callback:()=>{new n.P(e,(t=>{const s=e.object.changes??[];let a=[];t.data[0].changes?.forEach((e=>{e.key&&a.push(foundry.utils.mergeObject({mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE,priority:20},e))}));for(let e=s.length-1;e>=0;e--)a.find((t=>t.key===s[e].key))||a.unshift(s[e]);e.object.update({changes:a})}),"ActiveEffect").render(!0)}},token:{label:"Token",callback:()=>t("Token")},actor:{label:"Actor",callback:()=>t("Actor")}}}).render(!0)}function O(e){return(e.document?e.document.documentName:e.documentName)??"NONE"}const C={};async function N(e,t,s){if(game.user.isGM)return game.scenes.get(s).createEmbeddedDocuments(e,t);const a=foundry.utils.randomID(),n={handlerName:"document",args:{sceneID:s,documentName:e,data:t,requestID:a},type:"CREATE"};return game.socket.emit(`module.${u}`,n),setTimeout((()=>{C[a]?.([])}),4e3),new Promise((e=>{C[a]=e}))}function _({requestID:e,sceneID:t,documentName:s,documentIDs:a}={}){if(!C.hasOwnProperty(e))return;const n=game.scenes.get(t),i=[];for(const e of a)i.push(n.getEmbeddedDocument(s,e));C[e](i),delete C[e]}function M(e,t=!0){return t?game.i18n.localize(`MassEdit.${e}`):game.i18n.localize(e)}function A(e,t,s=!0){return s?game.i18n.format(`MassEdit.${e}`,t):game.i18n.format(e,t)}async function F(e){if(e&&canvas.scene){await e.load();const t=foundry.utils.flattenObject(e.data[0]),s=e.randomize;foundry.utils.isEmpty(s)||await(0,i.of)([t],null,s),await canvas.scene.update(t),("grid.color"in t||"grid.alpha"in t)&&canvas.grid.grid.draw({color:(t["grid.color"]??canvas.scene.grid.color).replace("#","0x"),alpha:Number(t["grid.alpha"]??canvas.scene.grid.alpha)})}}async function j(e,{actor:t,token:s,...a}={}){const n=ChatMessage.implementation.getSpeaker({actor:t,token:s}),i=game.user.character;s=s||(canvas.ready?canvas.tokens.get(n.token):null),t=t||s?.actor||game.actors.get(n.actor);const o=Object.keys(a);if(o.some((e=>Number.isNumeric(e))))throw new Error("Illegal numeric Macro parameter passed to execution scope.");const r=Object.values(a),l=new(0,async function(){}.constructor)("speaker","actor","token","character","scope",...o,`{${e}\n}`);try{return await l.call(this,n,t,s,i,a,...r)}catch(e){ui.notifications.error("MACRO.Error",{localize:!0})}}class SeededRandom{static randomID(e,t=16){e=this.cyrb128(e);const s=this.sfc32(e[0],e[1],e[2],e[3]),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array.from({length:t},(()=>62*s()|0)).map((e=>a[e])).join("")}static cyrb128(e){let t=1779033703,s=3144134277,a=1013904242,n=2773480762;for(let i,o=0;o<e.length;o++)i=e.charCodeAt(o),t=s^Math.imul(t^i,597399067),s=a^Math.imul(s^i,2869860233),a=n^Math.imul(a^i,951274213),n=t^Math.imul(n^i,2716044179);return t=Math.imul(a^t>>>18,597399067),s=Math.imul(n^s>>>22,2869860233),a=Math.imul(t^a>>>17,951274213),n=Math.imul(s^n>>>19,2716044179),t^=s^a^n,s^=t,a^=t,n^=t,[t>>>0,s>>>0,a>>>0,n>>>0]}static sfc32(e,t,s,a){return function(){var n=((e|=0)+(t|=0)|0)+(a|=0)|0;return a=a+1|0,e=t^t>>>9,t=(s|=0)+(s<<3)|0,s=(s=s<<21|s>>>11)+n|0,(n>>>0)/4294967296}}}class TagInput{static registerHandlebarsHelper(){Handlebars.registerHelper("tagInput",(e=>{const t=e.hash.name,s=e.hash.label??"Tags";let a=e.hash.tags;Handlebars.Utils.isArray(a)||(a=[]);let n="";return a.forEach((e=>{n+=this._tagField(e)})),new Handlebars.SafeString(`\n      <fieldset>\n        <legend>${s}</legend>\n        <div class="form-group me-tags">\n            <input type="text" class="tag-input">  \n            <input type="text" class="tag-hidden-input" name="${t}" value="${a.join(",")}" hidden>\n            <button type="button" class="add-tag"><i class="fas fa-save"></i></button>\n            <div class="tag-container">${n}</div>\n        </div>\n      </fieldset>\n    `)}))}static _tagField(e){return`<div class="tag"><span>${e}</span> <a class="delete-tag"><i class="fa-solid fa-x fa-xs"></i></a></div>`}static activateListeners(e,t){e.find(".me-tags .add-tag").on("click",(e=>{const s=$(e.target).closest(".me-tags"),a=s.find(".tag-input"),n=a.val().split(",").map((e=>e.trim().replace(/[^0-9a-zA-Z_\- ]/gi,"").toLowerCase())).filter(Boolean);if(n.length){a.val("");const e=s.find(".tag-hidden-input"),i=e.val().split(",").filter(Boolean);for(const e of n)i.includes(e)||(i.push(e),s.find(".tag-container").append(this._tagField(e)));e.attr("value",i.join(",")),t&&t()}})),e.find(".me-tags").on("click",".delete-tag",(e=>{const s=$(e.target).closest(".tag"),a=s.find("span").text(),n=s.closest(".me-tags").find(".tag-hidden-input"),i=n.val().split(",").filter((e=>e!==a)).join(",");n.attr("value",i),s.remove(),t&&t()}))}}},669:e=>{e.exports=jQuery},165:(e,t,s)=>{s.d(t,{V:()=>v});var a=s(739),n=s(208),i=s(789),o=s(120),r=s(998),l=s(465);let c;const d=new RegExp("([^.[]+|\\[('([^'\\\\]|\\\\.)+?'|\"([^\"\\\\]|\\\\.)+?\")\\])","g"),u=new RegExp("(^\\['|'\\]$|^\\[\"|\"\\]$)","g");function m(e){e.controlled&&(e.controlIcon.border.visible=!0)}Hooks.once("init",(()=>{c=!globalThis.libWrapper||(globalThis.libWrapper.is_fallback??1)?class{static get is_fallback(){return!0}static get WRAPPER(){return"WRAPPER"}static get MIXED(){return"MIXED"}static get OVERRIDE(){return"OVERRIDE"}static register(e,t,s,a="MIXED",{chain:n,bind:i=[]}={}){const o=t.endsWith("#set"),r=(t=o?t.slice(0,-4):t).match(d).map((e=>e.replace(/\\(.)/g,"$1").replace(u,""))),l=r.splice(0,1)[0];let c,m;if(0==r.length)c=globalThis,m=l;else{const e=eval;m=r.pop(),c=r.reduce(((e,t)=>e[t]),globalThis[l]??e(l))}let h=c,g=null;for(;h&&(g=Object.getOwnPropertyDescriptor(h,m),!g);)h=Object.getPrototypeOf(h);if(!g||!1===g?.configurable)throw new Error(`libWrapper Shim: '${t}' does not exist, could not be found, or has a non-configurable descriptor.`);let p=null;const f=n??("OVERRIDE"!=a.toUpperCase?.()&&3!=a)?function(...e){return s.call(this,p.bind(this),...i,...e)}:function(...e){return s.call(this,...i,...e)};if(o){if(!g.set)throw new Error(`libWrapper Shim: '${t}' does not have a setter`);p=g.set,g.set=f}else g.value?(p=g.value,g.value=f):(p=g.get,g.get=f);g.configurable=!0,Object.defineProperty(c,m,g)}}:globalThis.libWrapper}));var h=s(671),g=s(652),p=s(294),f=s(867),y=s(971);var b=s(241);const v={};function k(e,t,s,a,i){if(!e||foundry.utils.isEmpty(t))return;s.update=foundry.utils.flattenObject(t),s.diff=function(e,t,s,a=!0){const i=foundry.utils.flattenObject(s),r=(0,n.cc)(e,t,a),l=foundry.utils.diffObject(r,i);for(const[e,s]of Object.entries(l))""!==s&&null!=s||""!==r[e]&&null!=r[e]||delete l[e],e.startsWith("flags.")&&(0,o.uv)(r,e,s)&&delete l[e],"Token"===t&&["light.angle","rotation"].includes(e)&&s%360==r[e]%360&&delete l[e];return l}(e,i,t),s._id=a;const r=game.settings.get(o.Do,"historyMaxLength")??0,l=v[i]??[];l.push(s),l.length>r&&l.splice(0,1),v[i]=l}Hooks.once("init",(()=>{o.Fo.registerHandlebarsHelper(),game.settings.register(o.Do,"cssStyle",{scope:"world",config:!1,type:String,default:"Solid Background"}),game.settings.register(o.Do,"cssCustom",{scope:"world",config:!1,type:String,default:f.rY.Default}),game.settings.registerMenu(o.Do,"cssEdit",{name:(0,o.kg)("settings.cssEdit.name"),hint:(0,o.kg)("settings.cssEdit.hint"),label:"",scope:"world",icon:"fas fa-cog",type:f.Ay,restricted:!0}),game.settings.register(o.Do,"singleDocDefaultConfig",{name:(0,o.kg)("settings.singleDocDefaultConfig.name"),hint:(0,o.kg)("settings.singleDocDefaultConfig.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(o.Do,"rangeToTextbox",{name:(0,o.kg)("settings.rangeToTextbox.name"),hint:(0,o.kg)("settings.rangeToTextbox.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(o.Do,"presets",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(o.Do,"workingPack",{scope:"world",config:!1,type:String,default:"world.mass-edit-presets-main",onChange:e=>{g.A0.workingPack=e}}),g.A0.workingPack=game.settings.get(o.Do,"workingPack"),game.settings.register(o.Do,"docPresets",{scope:"world",config:!1,type:Array,default:[]}),game.settings.register(o.Do,"presetsMigrated",{scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(o.Do,"presetsCompMigrated",{scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(o.Do,"presetDocLock",{scope:"world",config:!1,type:String,default:""}),game.settings.register(o.Do,"presetLayerSwitch",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(o.Do,"presetExtComp",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(o.Do,"presetScaling",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(o.Do,"presetSortMode",{scope:"world",config:!1,type:String,default:"manual"}),game.settings.register(o.Do,"presetSearchMode",{scope:"world",config:!1,type:String,default:"pf"}),game.settings.register(o.Do,"presetSceneControl",{name:"Scene Controls: Preset Button",scope:"world",config:!0,type:Boolean,default:!0,onChange:()=>{ui.controls.render()}}),game.settings.register(o.Do,"pinnedFields",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(o.Do,"customControls",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(o.Do,"enableHistory",{name:(0,o.kg)("settings.enableHistory.name"),hint:(0,o.kg)("settings.enableHistory.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(o.Do,"historyMaxLength",{name:(0,o.kg)("settings.historyMaxLength.name"),hint:(0,o.kg)("settings.historyMaxLength.hint"),scope:"world",config:!0,type:Number,default:10}),game.settings.register(o.Do,"autoSnap",{name:(0,o.kg)("settings.autoSnap.name"),hint:(0,o.kg)("settings.autoSnap.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(o.Do,"panToSearch",{name:(0,o.kg)("settings.panToSearch.name"),hint:(0,o.kg)("settings.panToSearch.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.modules.get("tokenmagic")?.active&&game.settings.register(o.Do,"tmfxFieldsEnable",{name:(0,o.kg)("settings.tmfxFieldsEnable.name"),hint:(0,o.kg)("settings.tmfxFieldsEnable.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.keybindings.register(o.Do,"placeablePreviewEdit",{name:"Select Edit Placeables",hint:"",editable:[{key:"KeyD",modifiers:["Shift"]}],onDown:y.editPreviewPlaceables,restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"editKey",{name:(0,o.kg)("keybindings.editKey.name"),hint:(0,o.kg)("keybindings.editKey.hint"),editable:[{key:"KeyE",modifiers:["Shift"]}],onDown:()=>{const e=Object.values(ui.windows).find((e=>e.meObjects));e?e.close():(0,a.gx)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"copyKey",{name:"Copy",hint:"",editable:[{key:"KeyC",modifiers:["Shift"]}],onDown:()=>{""===window.getSelection().toString()&&Object.values(ui.windows).find((e=>null!=e.meObjects))?.performMassCopy()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"pasteKey",{name:"Paste",hint:"",editable:[{key:"KeyV",modifiers:["Shift"]}],onDown:()=>{(0,a.CM)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"selectKey",{name:(0,o.kg)("keybindings.selectKey.name"),hint:(0,o.kg)("keybindings.selectKey.hint"),editable:[{key:"KeyF",modifiers:["Shift"]}],onDown:()=>{(0,a.G_)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"presetApply",{name:(0,o.kg)("keybindings.presetApply.name"),hint:(0,o.kg)("keybindings.presetApply.hint"),editable:[{key:"KeyX",modifiers:["Shift"]}],onDown:()=>{const e=Object.values(ui.windows).find((e=>e instanceof p.P));if(e)return void e.close(!0);const t=Object.values(ui.windows).find((e=>e instanceof ActiveEffectConfig));if(t)return void(0,o.dS)(t);const s=canvas.activeLayer.constructor.documentName;o.Me.includes(s)&&new p.P(null,null,s).render(!0)},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"presetApplyScene",{name:(0,o.kg)("keybindings.presetApplyScene.name"),hint:(0,o.kg)("keybindings.presetApplyScene.hint"),editable:[],onDown:()=>{const e=Object.values(ui.windows).find((e=>e instanceof p.P));e?e.close(!0):new p.P(null,null,"Scene").render(!0)},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(o.Do,"genericFormKey",{name:(0,o.kg)("keybindings.genericForm.name"),hint:(0,o.kg)("keybindings.genericForm.hint"),editable:[{key:"KeyR",modifiers:["Shift"]}],onDown:()=>{let[e,t]=(0,a.ef)(null,!1);if(!e)return;const s=(0,o.Ng)(e);[...o.lv,"Token"].includes(s)&&("Token"===s?(0,a.Pw)(t,{massEdit:!0}):new i.s(t,{massEdit:!0,documentName:s}).render(!0))},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),function(){if(game.modules.get("select-tool-everywhere")?.active)return;const e=["AmbientLight","AmbientSound","MeasuredTemplate","Note"];e.forEach((e=>{Hooks.on(`refresh${e}`,m)})),Hooks.on("canvasReady",(()=>e.forEach((e=>canvas.getLayerByEmbeddedName(e).options.controllableObjects=!0)))),Hooks.on("getSceneControlButtons",(e=>function(e){for(const t of e)["lighting","sounds","measure"].includes(t.name)&&(t.tools.find((e=>"select"===e.name))||(t.tools.unshift({name:"select",title:"CONTROLS.CommonSelect",icon:"fas fa-expand"}),t.activeTool="select"))}(e))),Hooks.on("drawNote",(e=>{setTimeout((()=>m(e)),10)})),libWrapper.register(o.Do,"AmbientLight.prototype._onDragLeftCancel",(function(...e){Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this,e),this.updateSource({defer:!0})}),"OVERRIDE")}(),game.settings.get(o.Do,"enableHistory")&&o.O8.forEach((e=>{Hooks.on(`preUpdate${e}`,((e,t,s,a)=>{!function(e,t,s,a){if(game.user.id!==a||!game.settings.get(o.Do,"enableHistory"))return;const n={timestamp:(new Date).toLocaleTimeString(),ctrl:{}};["mass-edit-randomize","mass-edit-addSubtract"].forEach((e=>{e in s&&(n.ctrl[e]=s[e][0])}));let i=foundry.utils.deepClone(t);delete i._id;let r=e.document?e.document.documentName:e.documentName;"Actor"===r&&(i.prototypeToken||i.token)&&k(e.prototypeToken??e.token,i.prototypeToken??i.token,foundry.utils.deepClone(n),t._id,"Token");k(e,i,n,t._id,r)}(e,t,s,a)}))})),c.register(o.Do,"ClientKeybindings._onCopy",(function(e,...t){if(""===window.getSelection().toString()){const e=Object.values(ui.windows).find((e=>null!=e.meObjects));if(e?.performMassCopy())return!0}const s=e(...t);return s&&(0,n.ms)(canvas.activeLayer.constructor.documentName),s}),"MIXED"),c.register(o.Do,"ClientKeybindings._onPaste",(function(e,...t){return!!(0,a.CM)()||e(...t)}),"MIXED"),c.register(o.Do,"MouseManager.prototype._onWheel",(function(e,...t){const s=t[0];if(y.Picker.isActive()&&(s.ctrlKey||s.shiftKey||s.metaKey||s.altKey)){s.ctrlKey&&s.preventDefault();let e=s.delta=s.deltaY;if(s.shiftKey&&0===e&&(e=s.delta=s.deltaX),0===e)return;return void(s.altKey?y.Picker.addScaling(s.delta<0?.05:-.05):s.ctrlKey||s.metaKey?y.Picker.addRotation(s.delta<0?2.5:-2.5):s.shiftKey&&y.Picker.addRotation(s.delta<0?15:-15))}return e(...t)}),"MIXED"),game.settings.get(o.Do,"presetSceneControl")&&c.register(o.Do,"SceneNavigation.prototype._getContextMenuOptions",(function(e,...t){const s=e(...t);return s.push({name:"Mass Edit",icon:'<i class="fa-solid fa-pen-to-square"></i>',condition:game.user.isGM,callback:e=>{const t=e.attr("data-scene-id");(0,a.gx)(game.scenes.get(t))}}),s}),"WRAPPER");const e=function(e,...t){if(!p.P.objectHover&&!p.Q.objectHover)return e(...t);{this.mouseInteractionManager.cancel(...t);const e=Object.values(ui.windows).find((e=>p.P.objectHover&&e instanceof p.P||p.Q.objectHover&&e instanceof p.Q));if(e){const s=canvas.activeLayer.controlled.length?[...canvas.activeLayer.controlled]:[this];e.dropPlaceable(s,...t)}this._onDragLeftCancel(...t)}};o.Me.forEach((t=>{c.register(o.Do,`${t}.prototype._onDragLeftDrop`,e,"MIXED")})),game.socket?.on(`module.${o.Do}`,(async e=>{const t=e.args;if("document"===e.handlerName&&"CREATE"===e.type){if(!!game.users.filter((e=>e.isGM&&(e.active||e.isActive))).some((e=>e.id<game.user.id)))return;const e=(await(0,o.VS)(t.documentName,t.data,t.sceneID)).map((e=>e.id)),s={handlerName:"document",args:{requestID:t.requestID,sceneID:t.sceneID,documentName:t.documentName,documentIDs:e},type:"RESOLVE"};game.socket.emit(`module.${o.Do}`,s)}else"document"===e.handlerName&&"RESOLVE"===e.type&&(0,o.f6)(t)})),Hooks.on("spotlightOmnisearch.indexBuilt",((e,t)=>{if(!game.user.isGM)return;const s=game.settings.get("spotlight-omnisearch","compendiumConfig");game.packs.filter((e=>"JournalEntry"===e.documentName&&e.index.get(g.Xd))).forEach((e=>s[e.collection]=!1)),game.settings.set("spotlight-omnisearch","compendiumConfig",s);const a=g.A0.buildSpotlightOmnisearchIndex(e);t.push(a)})),globalThis.MassEdit={GeneralDataAdapter:r.A,MassEditGenericForm:i.s,showGenericForm:a.Ls,performMassUpdate:n.pt,performMassSearch:n.qn,showMassEdit:a.gx,getPreset:g.af.getPreset,getPresets:g.af.getPresets,createPreset:g.af.createPreset,spawnPreset:g.af.spawnPreset,activateBrush:b.Yv,deactivateBrush:b.Xt},game.modules.get(o.Do).api={...globalThis.MassEdit,applyRandomization:l.of,applyAddSubtract:o.YY,checkApplySpecialFields:n.fP}})),Hooks.on("renderSceneControls",((e,t,s)=>{if(!game.user.isGM)return;if(!game.settings.get(o.Do,"presetSceneControl"))return;const a=$('\n<li class="scene-control mass-edit-scene-control" data-control="me-presets" aria-label="Mass Edit: Presets" role="tab" data-tooltip="Mass Edit: Presets">\n  <i class="fa-solid fa-books"></i>\n</li>\n  ');a.on("click",(()=>{let e=canvas.activeLayer.constructor.documentName;o.Me.includes(e)||(e="ALL");const t=Object.values(ui.windows).find((e=>e instanceof p.P));t?t.close():new p.P(null,null,e,{left:a.position().left+a.width()+40}).render(!0)})),t.find(".control-tools").find(".scene-control").last().after(a)})),Hooks.on("ready",(async()=>{if(game.packs.get(g.A0.workingPack)||game.settings.set(o.Do,"workingPack",g.aN),!game.settings.get(o.Do,"presetsMigrated")){const e=game.settings.get(o.Do,"presets");if("Object"===foundry.utils.getType(e)&&!foundry.utils.isEmpty(e)){let t=[];for(const s of Object.keys(e)){for(const a of Object.keys(e[s])){let n=e[s][a],i={id:foundry.utils.randomID()};i.name=a,i.documentName=s,i.color="#ffffff"!==n["mass-edit-preset-color"]?n["mass-edit-preset-color"]:null,i.order=n["mass-edit-preset-order"]??-1,i.addSubtract=n["mass-edit-addSubtract"]??{},i.randomize=n["mass-edit-randomize"]??{},delete n["mass-edit-preset-color"],delete n["mass-edit-preset-order"],delete n["mass-edit-addSubtract"],delete n["mass-edit-randomize"],delete n["mass-edit-keybind"],i.data=foundry.utils.deepClone(n),t.push(i)}game.settings.set(o.Do,"docPresets",t)}}game.settings.set(o.Do,"presetsMigrated",!0)}if(!game.settings.get(o.Do,"presetsCompMigrated")){const e=game.settings.get(o.Do,"docPresets").map((e=>new h.k(e)));e.length&&g.A0.set(e),game.settings.set(o.Do,"presetsCompMigrated",!0)}})),Hooks.on("renderTokenHUD",((e,t,s)=>{canvas.tokens.controlled.length>=2&&($(t).find('.control-icon[data-action="config"]').after('<div class="control-icon" data-action="massConfig">\n          <i class="fas fa-cogs"></i>\n        </div>'),$(t).on("click",'[data-action="massConfig"]',(()=>{(0,a.gx)()})))})),Hooks.on("renderTileHUD",((e,t,s)=>{(canvas.background?canvas.background.controlled.concat(canvas.foreground.controlled):canvas.tiles.controlled).length>=2&&($(t).find('.control-icon[data-action="underfoot"]').after('<div class="control-icon" data-action="massConfig">\n          <i class="fas fa-cogs"></i>\n        </div>'),$(t).on("click",'[data-action="massConfig"]',(()=>{(0,a.gx)()})))})),Hooks.on("renderActiveEffectConfig",(e=>{const t=$(e.form).find(".effects-header .key");if(t.length){const s=$('<i title="Apply \'Mass Edit\' preset" style="font-size:smaller;color:brown;"> <a>[ME]</a></i>');s.on("click",(()=>(0,o.dS)(e))),t.append(s)}}))}},s={};function a(e){var n=s[e];if(void 0!==n)return n.exports;var i=s[e]={exports:{}};return t[e](i,i.exports,a),i.exports}a.m=t,a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,s)=>(a.f[s](e,t),t)),[])),a.u=e=>e+".bundle.js",a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},a.l=(t,s,n,i)=>{if(e[t])e[t].push(s);else{var o,r;if(void 0!==n)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var d=l[c];if(d.getAttribute("src")==t){o=d;break}}o||(r=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,a.nc&&o.setAttribute("nonce",a.nc),o.src=t),e[t]=[s];var u=(s,a)=>{o.onerror=o.onload=null,clearTimeout(m);var n=e[t];if(delete e[t],o.parentNode&&o.parentNode.removeChild(o),n&&n.forEach((e=>e(a))),s)return s(a)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),r&&document.head.appendChild(o)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.p="modules/multi-token-edit/",(()=>{var e={792:0};a.f.j=(t,s)=>{var n=a.o(e,t)?e[t]:void 0;if(0!==n)if(n)s.push(n[2]);else{var i=new Promise(((s,a)=>n=e[t]=[s,a]));s.push(n[2]=i);var o=a.p+a.u(t),r=new Error;a.l(o,(s=>{if(a.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var i=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+i+": "+o+")",r.name="ChunkLoadError",r.type=i,r.request=o,n[1](r)}}),"chunk-"+t,t)}};var t=(t,s)=>{var n,i,[o,r,l]=s,c=0;if(o.some((t=>0!==e[t]))){for(n in r)a.o(r,n)&&(a.m[n]=r[n]);if(l)l(a)}for(t&&t(s);c<o.length;c++)i=o[c],a.o(e,i)&&e[i]&&e[i][0](),e[i]=0},s=self.webpackChunk=self.webpackChunk||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();a(165)})();
//# sourceMappingURL=bundle.js.map