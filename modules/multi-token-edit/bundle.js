(()=>{"use strict";var e,t,s,i={867:(e,t,s)=>{s.d(t,{Ay:()=>CSSEdit,QD:()=>a,rY:()=>n});var i=s(596);function a(){const e=game.settings.get(i.Do,"cssStyle");return e in n?[e,n[e]]:["CUSTOM",game.settings.get(i.Do,"cssCustom")||""]}class CSSEdit extends FormApplication{constructor(){super({},{})}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-css",classes:["sheet"],template:`modules/${i.Do}/templates/cssEdit.html`,resizable:!0,minimizable:!1,title:"Edit CSS",width:490,height:730})}async getData(e){const t=super.getData(e),[s,i]=a();return t.styleInUse=s,t.css=i,t.styles=Object.keys(n),t.styles.push("CUSTOM"),t.disableCSS="CUSTOM"!==s,t}activateListeners(e){super.activateListeners(e),$(e).on("change",".selectStyle",(t=>{let s;s="CUSTOM"===t.target.value?game.settings.get(i.Do,"cssCustom"):n[t.target.value],$(e).find(".cssTextArea").val(s).prop("disabled","CUSTOM"!==t.target.value),$(e).find(".previewStyle").html(s)})),$(e).on("input",".cssTextArea",(t=>{$(e).find(".previewStyle").html(t.target.value)}))}async _updateObject(e,t){"CUSTOM"===t.selectedStyle&&game.settings.set(i.Do,"cssCustom",t.css),game.settings.set(i.Do,"cssStyle",t.selectedStyle)}}const n={Default:".form-group.meCommon {\n  outline: green dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {\n  outline: rgb(255, 204, 110) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  outline: rgb(246, 175, 255) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  outline: rgb(118, 242, 255) dotted 2px;\n  margin-bottom: 5px;\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}\n","No Outline":".form-group.meCommon {}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}\n","Striped Background":".form-group.meCommon {\n  background: repeating-linear-gradient(\n  45deg,\n  rgba(155, 233, 155, 0.8),\n  rgba(155, 233, 155, 0.8) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meCommon {\n  outline: green solid 2px;\n}\n\n.form-group.meDiff {\n  background: repeating-linear-gradient(\n  135deg,\n  rgba(255, 207, 118, 0.5),\n  rgba(255, 207, 118, 0.5) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  background: repeating-linear-gradient(\n  70deg,\n  rgba(237, 149, 255, 0.3),\n  rgba(237, 149, 255, 0.3) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  background: repeating-linear-gradient(\n  70deg,\n  rgba(118, 242, 255, 0.5),\n  rgba(118, 242, 255, 0.5) 10px,\n  rgba(0, 0, 0, 0) 10px,\n  rgba(0, 0, 0, 0) 20px\n  );\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n","Solid Background":".form-group.meCommon {\n  background: rgba(155, 233, 155, 0.8)\n}\n\n.mass-edit-checkbox.meCommon {\noutline: green solid 2px;\n}\n\n.form-group.meDiff {\n  background: rgba(255, 207, 118, 0.5)\n}\n\n.mass-edit-checkbox.meDiff {\n  outline: rgb(255, 204, 110) solid 2px;\n}\n\n.form-group.meFlag {\n  background: rgba(237, 149, 255, 0.3)\n}\n\n.mass-edit-checkbox.meFlag {\n  outline: rgb(246, 175, 255) solid 2px;\n}\n\n.form-group.meInsert {\n  background: rgba(118, 242, 255, 0.5)\n}\n\n.mass-edit-checkbox.meInsert {\n  outline: rgb(118, 242, 255) solid 2px;\n}"}},998:(e,t,s)=>{s.d(t,{A:()=>GeneralDataAdapter,f:()=>TokenDataAdapter});class TokenDataAdapter{static updateToForm(e){"texture.scaleX"in e&&(e.mirrorX=e["texture.scaleX"]<0,e.scale=Math.abs(e["texture.scaleX"])),"texture.scaleY"in e&&(e.mirrorY=e["texture.scaleY"]<0,e.scale=Math.abs(e["texture.scaleY"]))}static dataToForm(e,t){const s=e.document??e;null!=s.texture?.scaleX&&(t.scale=Math.abs(s.texture.scaleX)),null!=s.texture?.scaleX&&(t.mirrorX=s.texture.scaleX<0),null!=s.texture?.scaleY&&(t.mirrorY=s.texture.scaleY<0)}static formToData(e,t){const s=e.document??e;("scale"in t||"mirrorX"in t||"mirrorY"in t)&&("scale"in t||(t.scale=Math.abs(s.texture.scaleX)),"mirrorX"in t||(t.mirrorX=s.texture.scaleX<0),"mirrorY"in t||(t.mirrorY=s.texture.scaleY<0),t["texture.scaleX"]=t.scale*(t.mirrorX?-1:1),t["texture.scaleY"]=t.scale*(t.mirrorY?-1:1),["scale","mirrorX","mirrorY"].forEach((e=>delete t[e]))),TokenDataAdapter.correctDetectionModes(s,t)}static correctDetectionModeOrder(e,t){const s={};let i=0;for(const[a,n]of Object.entries(e))if(a.startsWith("detectionModes")){const o=a.split(".");o[1]in s||(s[o[1]]=i,i++);const r=`detectionModes.${s[o[1]]}.${o[2]}`;if(delete e[a],e[r]=n,t&&a in t){const e=t[a];delete t[a],t[r]=e}}}static detectionModeMatch(e,t){for(const s of e)if("id"in s)for(const e of t)if(s.id===e.id){if("enabled"in s&&s.enabled!==e.enabled)return!1;if("range"in s&&s.range!==e.range)return!1;break}return!0}static correctDetectionModes(e,t){const s=[],i={};let a=0;for(const[e,n]of Object.entries(t))if(e.startsWith("detectionModes")){const o=e.split(".");o[1]in i||(i[o[1]]=a,s.push({}),a++);s[i[o[1]]][o[2]]=n,delete t[e]}if(!s.length)return;const n=foundry.utils.deepClone(e.detectionModes).filter((e=>e.id));for(const e of s){if(null==e.id)continue;let t=!1;for(const s of n)if(s.id===e.id){foundry.utils.mergeObject(s,e),t=!0;break}t||n.push(foundry.utils.mergeObject({id:"",range:0,enabled:!0},e))}t.detectionModes=n}static modifyPresetData(e,t){const s=Object.values(foundry.utils.expandObject(t)?.detectionModes||{});if(!s.length)return;const i=Object.values(foundry.utils.expandObject(e._getSubmitData())?.detectionModes||{}),a=foundry.utils.deepClone(t),n=t["mass-edit-randomize"]??{},o=t["mass-edit-addSubtract"]??{},r=function(e,t,s,i,a){`detectionModes.${s}.${i}`in e&&(delete e[`detectionModes.${s}.${i}`],e[`detectionModes.${j}.${i}`]=a[t][`detectionModes.${s}.${i}`])},l=i.length;for(let e=0;e<s.length;e++){if(!("id"in s[e]))continue;let c=!1;for(let d=0;d<l;d++)s[e].id===i[d].id&&(c=!0,Object.keys(s[e]).forEach((s=>{delete t[`detectionModes.${e}.${s}`],t[`detectionModes.${d}.${s}`]=a[`detectionModes.${e}.${s}`],r(n,"mass-edit-randomize",e,s,a),r(o,"mass-edit-addSubtract",e,s,a)})));c||(i.push({id:"",range:0,enabled:!0}),Object.keys(s[e]).forEach((s=>{delete t[`detectionModes.${e}.${s}`],t[`detectionModes.${i.length-1}.${s}`]=a[`detectionModes.${e}.${s}`],`detectionModes.${e}.${s}`in n&&(delete n[`detectionModes.${e}.${s}`],n[`detectionModes.${i.length-1}.${s}`]=a["mass-edit-randomize"][`detectionModes.${e}.${s}`]),`detectionModes.${e}.${s}`in o&&(delete o[`detectionModes.${e}.${s}`],o[`detectionModes.${i.length-1}.${s}`]=a["mass-edit-addSubtract"][`detectionModes.${e}.${s}`])})))}return l!==i.length?(e._previewChanges({detectionModes:i}),e.render(),!0):void 0}}const i={Token:TokenDataAdapter,PlaylistSound:class PlaylistSoundDataAdapter{static formToData(e,t){"lvolume"in t&&(t.volume=AudioHelper.inputToVolume(t.lvolume),delete t.lvolume)}static dataToForm(e,t){t.lvolume=(e.document??e).volume}static updateToForm(e){"volume"in e&&(e.lvolume=AudioHelper.volumeToInput(e.volume),delete e.volume)}},Note:class NoteDataAdapter{static formToData(e,t){("icon.selected"in t||"icon.custom"in t)&&(t["texture.src"]=t["icon.selected"]||t["icon.custom"],delete t["icon.selected"],delete t["icon.custom"])}static dataToForm(e,t){const s=e.document??e;null!=s.texture?.src&&(t["icon.selected"]=s.texture.src,t["icon.custom"]=s.texture.src)}}};class GeneralDataAdapter{static formToData(e,t,s){const a=i[e];a&&a.formToData&&a.formToData(t,s)}static dataToForm(e,t,s){const a=i[e];a&&a.dataToForm&&a.dataToForm(t,s)}static updateToForm(e,t){const s=i[e];s&&s.updateToForm&&s.updateToForm(t)}}},439:(e,t,s)=>{s.d(t,{B0:()=>v,GS:()=>b,Yp:()=>p,bE:()=>x,fP:()=>g,lW:()=>w,ms:()=>_,pt:()=>h,qn:()=>d});var i=s(596),a=s(971),n=s(465),o=s(892),r=s(120),l=s(998),c=s(739);function d(e,t,s,{scope:a=null,selected:n=null,control:o=!0,pan:l=!0}={}){const d=[];if("selected"===a)m(n,t,s,d);else if(i.lv.includes(t))m(Array.from(game.collections.get(t)),t,s,d);else{let e=[];"world"===a?e=Array.from(game.scenes):canvas.scene&&(e=[canvas.scene]);for(const i of e)u(i,t,s,d)}return o&&(canvas.activeLayer.controlled.map((e=>e)).forEach((e=>e.release())),setTimeout((()=>{d.forEach((e=>{let t=e.object??e;t.control&&t.control({releaseOthers:!1})})),l&&d.length&&game.settings.get(i.Do,"panToSearch")&&(0,r.w$)(d)}),100)),"meSearchAndEdit"===e&&setTimeout((()=>{(0,c.gx)(d,t)}),500),d}function u(e,t,s,i){m(Array.from(e[c.QH[t]]),t,s,i)}function m(e,t,s,i){for(const a of e){let e=!0;const n=foundry.utils.flattenObject((0,r.bQ)(a).toObject());l.A.dataToForm(t,a,n);for(const[i,a]of Object.entries(s))if(i.startsWith("flags.")){if(!(0,r.uv)(n,i,a)){e=!1;break}}else if(""!==a&&null!=a||""===n[i]&&null==n[i]){if("string"==typeof a&&a.includes("*")&&(0,r.dT)(a,n[i]));else if(n[i]!=a){if("Token"===t&&i.startsWith("detectionModes"))continue;e=!1;break}}else;if(e){if("Token"===t){const e=Object.values(foundry.utils.expandObject(s)?.detectionModes||{});if(!l.f.detectionModeMatch(e,a.detectionModes))continue}i.push(a)}}}async function h(e,t,s,a){if(this.options?.simplified)return void(this.options.callback&&this.options.callback(e));if(foundry.utils.isEmpty(e))return void(this.callbackOnUpdate&&this.callbackOnUpdate(t));const o=[],c={},d=(t=t.map((e=>e.document??e))).length;for(let s=0;s<d;s++){const i=foundry.utils.deepClone(e);i._id=t[s].id,o.push(i)}this&&await(0,n.of)(o,t,this.randomizeFields),this&&function(e,t,s,i){if(i&&!foundry.utils.isEmpty(i))for(let a=0;a<e.length;a++){const n=e[a],o=foundry.utils.flattenObject((0,r.bQ)(t[a]).toObject());l.A.dataToForm(s,t[a],o);for(const e of Object.keys(n))if(e in i&&e in o){const t=i[e];let s=o[e];if("flags.tagger.tags"===e){const i=Array.isArray(s)?s:(s??"").split(",").map((e=>e.trim())),a=(n[e]??"").split(",").map((e=>e.trim()));for(const e of a)if("add"===t.method)i.includes(e)||i.push(e);else if("subtract"===t.method){const t=i.indexOf(e);t>-1&&i.splice(t,1)}n[e]=i.filter((e=>e)).join(",");continue}if("text"===t.type){if("add"===t.method){const i="value"in t?t.value:n[e];i.startsWith(">>")?s=i.replace(">>","")+s:s+=i}else s=s.replace("value"in t?t.value:n[e],"");n[e]=s;continue}"add"===t.method?s+="value"in t?t.value:n[e]:s-="value"in t?t.value:n[e],"min"in t&&s<t.min?s=t.min:"max"in t&&s>t.max&&(s=t.max),n[e]=s}}}(o,t,s,this.addSubtractFields);for(let e=0;e<d;e++)l.A.formToData(s,t[e],o[e]);if(await g(s,o,t),"Actor"===s)for(let e=0;e<o.length;e++){const s=o[e];delete s._id,this.options?.tokens?this.options.tokens[e].actor.update(s):t[e].update(s)}else if("Scene"===s)Scene.updateDocuments(o,c);else if("PlaylistSound"===s)for(let e=0;e<t.length;e++)delete o[e]._id,t[e].update(o[e]);else if("Note"===s){const e={};for(let s=0;s<o.length;s++){const i=t[s].scene??t[s].parent;"meApplyCurrentScene"===a&&i.id!==canvas.scene.id||(i.id in e||(e[i.id]={scene:i,updates:[]}),e[i.id].updates.push(o[s]))}for(const t of Object.values(e))t.scene.updateEmbeddedDocuments(s,t.updates,c)}else if(!this.isPrototype&&i.Me.includes(s)){const e={};for(let s=0;s<o.length;s++){const i=t[s].parent;e[i.id]||(e[i.id]=[]),e[i.id].push(o[s])}for(const t of Object.keys(e))game.scenes.get(t)?.updateEmbeddedDocuments(s,e[t],c)}else if(i.lv.includes(s))t[0].constructor?.updateDocuments(o,c);else{for(let e=0;e<o.length;e++){const s=o[e];delete s._id,(0,r.ht)(t[e],foundry.utils.mergeObject(t[e],s))}this.callbackOnUpdate&&this.callbackOnUpdate(t)}if(("meApplyToPrototype"===a||this.isPrototype)&&"Token"===s){const e={};for(let s=0;s<t.length;s++){const i=t[s].actor;i&&(e[i.id]={_id:i.id,prototypeToken:o[s]})}if(!foundry.utils.isEmpty(e)){const t=[];for(const s of Object.keys(e))t.push(e[s]);Actor.updateDocuments(t)}}}async function g(e,t,s){for(let i=0;i<t.length;i++){const a=t[i],n=s[i];if(a.hasOwnProperty("tokenmagic.ddTint")&&"undefined"!=typeof TokenMagic&&await(0,o.gs)(n,a["tokenmagic.ddTint"]),a.hasOwnProperty("tokenmagic.preset")&&"undefined"!=typeof TokenMagic&&await(0,o.VC)(n,a["tokenmagic.preset"],"subtract"===this?.addSubtractFields?.["tokenmagic.preset"]?.method),"Tile"===e){if(a.hasOwnProperty("massedit.scale")){const e=a["massedit.scale"];a.width=n.width*e,a.height=n.height*e,null!=n.flags?.["levels-3d-preview"]?.depth?a["flags.levels-3d-preview.depth"]=n.flags["levels-3d-preview"].depth*=e:null!=n["flags.levels-3d-preview.depth"]&&(a["flags.levels-3d-preview.depth"]=n["flags.levels-3d-preview.depth"]*e)}a.hasOwnProperty("massedit.texture.scale")&&(a["texture.scaleX"]=a["massedit.texture.scale"],a["texture.scaleY"]=a["massedit.texture.scale"],delete a["massedit.texture.scale"])}}}async function p(e){if("mass-edit-control"===e.target.className&&!e.target.checked)return void y(e.target);const t=$(e.target).closest(".form-group").find(".mass-edit-checkbox input");t.prop("checked",!0),f(t[0]),this?.options.massEdit&&this._performOnInputChangeUpdate&&this.modUpdate&&this._performOnInputChangeUpdate()}function f(e){const t=$(e).parent().closest("div.tab, div.matt-tab");t.length&&(t.siblings("nav.tabs").find(`[data-tab="${t.attr("data-tab")}"]`).addClass("mass-edit-tab-selected"),f(t[0]))}function y(e){const t=$(e).parent().closest("div.tab, div.matt-tab");t.length&&0===t.find(".mass-edit-checkbox input:checked").length&&(t.siblings("nav.tabs").find(`[data-tab="${t.attr("data-tab")}"]`).removeClass("mass-edit-tab-selected"),y(t[0]))}function b(e,t){t||(0,r.Ng)(e[0]);const s=e.map((e=>function(e,t){const s=foundry.utils.flattenObject((0,r.bQ)(e).toObject());return l.A.dataToForm(t,e,s),s}(e,t)));return(0,r.m1)(s)}function v(e,t,s=!1,i=!1,n=null){if(!e||!e.length)return!1;let o,l=e[0].document?e[0].document.documentName:e[0].documentName;if((t=t??x(l))||"Token"===l&&(t||(t=x("TokenProto"),o="meApplyToPrototype"),t||(t=x("Actor"),l="Actor",e=e.filter((e=>e.actor)).map((e=>e.actor)))),t){if(t.documentName!==l)return;const c={meObjects:e};foundry.utils.isEmpty(t.randomize)||(c.randomizeFields=t.randomize),foundry.utils.isEmpty(t.addSubtract)||(c.addSubtractFields=t.addSubtract);const d=t.data[Math.floor(Math.random()*t.data.length)];let u=foundry.utils.deepClone(d);return n&&(a.DataTransform.apply(l,u,{x:0,y:0},n),u=foundry.utils.mergeObject(d,u,{insertKeys:!1,inplace:!1})),i&&(delete u.x,delete u.y,delete u.c,delete u.elevation),h.call(c,foundry.utils.flattenObject(u),e,t.documentName,o),s||ui.notifications.info((0,r.zS)("clipboard.paste",{document:t.documentName,count:e.length})),!0}return!1}const k={};function w(e,t,s){k[e.documentName]=e,"Token"===e.documentName&&s?k.TokenProto=e:"Token"===e.documentName&&"copyProto"===t&&(delete k.Token,k.TokenProto=e),game.clipboard.copyPlainText(JSON.stringify(foundry.utils.deepClone(1===e.data.length?e.data[0]:e.data),null,2)),ui.notifications.info((0,r.zS)("clipboard.copy",{document:e.documentName}))}function x(e){return k[e]}function _(e){delete k[e],"Token"===e&&delete k.TokenProto}},622:(e,t,s)=>{s.d(t,{dN:()=>E,fQ:()=>S});var i=s(120),a=s(241),n=s(596);function o(e){const t=(0,i.Ng)(e.meObjects[0]);if(!["AmbientLight","AmbientSound"].includes(t))return;const s=$(e.form);if(s.find('input[name="hidden"]').length)return;const a=e.meObjects[0].hidden,n=`\n  <div class="form-group">\n    <label>${(0,i.kg)("Hidden",!1)}</label>\n    <div class="form-fields">\n        <input type="checkbox" name="hidden" ${a?"checked":""}>\n    </div>\n  </div>\n`,o=s.find("div.tab");o.length?o.first().append(n):s.find(".form-group").last().after(n)}var r=s(624),l=s(671),c=s(465),d=s(892),u=s(867),m=s(998),h=s(439);function g(e,t){if("update"===e.method||"toggle"===e.method){let s="";return"toggle"===e.method&&(s+=function(e){let t="\n// Toggle; Helper function";"field"===e.toggle.method?t+="\nconst toggleOn = function (obj, fields) {\n  const data = foundry.utils.flattenObject(obj.toObject());\n  fields = foundry.utils.flattenObject(fields);\n  return foundry.utils.isEmpty(foundry.utils.diffObject(data, fields));\n};\n  ":t+="\nconst macro = this;\nconst toggleOn = function (obj) {\n  if (obj.getFlag('world', `macro-${macro.id}-toggleOn`)) {\n    obj.unsetFlag('world', `macro-${macro.id}-toggleOn`);\n    return true;\n  } else {\n    obj.setFlag('world', `macro-${macro.id}-toggleOn`, true);\n    return false;\n  }\n};\n";return t}(e)),s+=`\n// Updates to be applied\nconst update = ${y(e.fields)};\n`,"toggle"===e.method&&(s+=`const update2 = ${y(e.toggle.fields)};\n\n`),k(e)&&(s+="\n// Mass Edit control objects\n",e.randomize&&(s+=`const randomizeFields = ${y(e.randomize)};\n`),e.addSubtract&&(s+=`const addSubtractFields = ${y(e.addSubtract)};\n`),e.toggle&&(e.toggle.randomize&&(s+=`const randomizeFieldsToggleOff = ${y(e.toggle?.randomize)};\n`),e.toggle.addSubtract&&(s+=`const addSubtractFieldsToggleOff = ${y(e.toggle?.addSubtract)};\n`))),k(e)?s+function(e,t){let s=[];e.randomize&&s.push("randomizeFields");e.addSubtract&&s.push("addSubtractFields");if(s=s.join(", "),"toggle"===e.method){let i=[];return e.toggle?.randomize&&i.push("randomizeFields: randomizeFieldsToggleOff"),e.toggle?.addSubtract&&i.push("addSubtractFields: addSubtractFieldsToggleOff"),i=i.join(", "),`\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n  \ntargets.forEach((t) => {\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\n  else toggleOnTargets.push(t);\n});\n  \nawait MassEdit.api.performMassUpdate.call({${s}}, update, toggleOnTargets, '${t}');\nawait MassEdit.api.performMassUpdate.call({${i}}, update2, toggleOffTargets, '${t}');\n`}return`await MassEdit.api.performMassUpdate.call({${s}}, update, targets, '${t}');\n`}(e,t):s+function(e,t){let s="";if(foundry.utils.isEmpty(e.fields)&&!e.toggle)return"";if(e.toggle&&foundry.utils.isEmpty(e.toggle.fields)&&foundry.utils.isEmpty(e.fields))return"\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n\ntargets.forEach((t) => {\n  if(toggleOn(t, update)) toggleOffTargets.push(t);\n  else toggleOnTargets.push(t);\n});\n    ";const i=(e.macro||e.toggle?.macro)&&e.toggle;i&&(s+="\nconst toggleOnTargets = [];\nconst toggleOffTargets = [];\n  ");n.Me.includes(t)?(s+="\nconst updates = {};","toggle"===e.method?s+=`\ntargets.forEach((t) => {\n  const sceneId = t.parent.id;\n  if(!updates[sceneId]) updates[sceneId] = [];\n\n  let u;\n  if(toggleOn(t, update)) {\n    u = foundry.utils.deepClone(update2);${i?"\ntoggleOffTargets.push(t);":""}\n  } else {\n    u = foundry.utils.deepClone(update);${i?"\ntoggleOnTargets.push(t);":""}\n  }\n  u._id = t.id;\n\n  updates[sceneId].push(u);\n});\n  `:s+="\ntargets.forEach((t) => {\n  const sceneId = t.parent.id;\n  if(!updates[sceneId]) updates[sceneId] = [];\n  \n  let u = foundry.utils.deepClone(update);\n  u._id = t.id;\n    updates[sceneId].push(u);\n});\n  "):(s+="\nconst updates = [];","toggle"===e.method?s+=`\ntargets.forEach((t) => {\n  let u;\n  if(toggleOn(t, update)) {\n    u = foundry.utils.deepClone(update2);${i?"\ntoggleOffTargets.push(t);":""}\n  } else {\n    u = foundry.utils.deepClone(update);${i?"\ntoggleOnTargets.push(t);":""}\n  }\n  u._id = t.id;\n  updates.push(u);\n});\n  `:s+="\ntargets.forEach((t) => {\n  let u = foundry.utils.deepClone(update);\n  u._id = t.id;\n  updates.push(u);\n});\n  ");n.Me.includes(t)?s+=`\nfor(const sceneId of Object.keys(updates)) {\n  game.scenes.get(sceneId)?.updateEmbeddedDocuments('${t}', updates[sceneId]);\n}\n  `:s+="PlaylistSound"===t?"\nfor (let i = 0; i < targets.length; i++) {\n  delete updates[i]._id;\n  targets[i].document.update(updates[i]);\n}\n  ":`\n${t}.updateDocuments(updates);\n`;return s}(e,t)}return"massEdit"===e.method?`\n// Open Mass Edit Form\nawait MassEdit.api.showMassEdit(targets, '${t}');`:"delete"===e.method?function(e,t){let s=`\n// Delete ${t}s`;n.Me.includes(t)?"selected"===e.target.scope||"scene"===e.target.scope?s+=`\ncanvas.scene.deleteEmbeddedDocuments('${t}', targets.map(t => t.id));`:s+=`\nconst toDelete = {};\ntargets.forEach( t => {\n  const sceneID = t.parent.id;\n  if(!toDelete[sceneID]) toDelete[sceneID] = [];\n  toDelete[sceneID].push(t.id);\n});\nObject.keys(toDelete).forEach(sceneID => game.scenes.get(sceneID).deleteEmbeddedDocuments('${t}', toDelete[sceneID]));\n      `:s+=`\n${t}.deleteDocuments(targets.map( t => t.id ));`;return s}(e,t):void 0}function p(e,t,s){const i=e.target;if("ids"===i.method)return function(e,t,s){let i=`const ids = [${s.map((e=>`"${e.id}"`)).join(",")}];\n`;i+="const targets = [];",n.Me.includes(t)?i+=`\nids.forEach( id => {\n  Array.from(game.scenes).forEach( scene => {\n    let embed = scene.getEmbeddedDocument('${t}', id);\n    if(embed) targets.push(embed)\n  });\n});\n`:i+=`\nids.forEach(id => { \n  const doc = ${t}.get(id);\n  if(doc) targets.push(doc);\n});`;return i}(0,t,s);if("search"===i.method)return function(e,t){let s=y(e.fields);if("selected"===e.scope){let e=f(t);return e+=`\ntargets = await MassEdit.api.performMassSearch('meSearch', '${t}' , ${s}, { scope: 'selected', selected: targets, control: false, pan: false });`,e}if("scene"===e.scope)return`const targets = await MassEdit.api.performMassSearch('meSearch', '${t}' , ${s}, { scope: 'scene', control: false, pan: false });`;if("world"===e.scope)return`const targets = await MassEdit.api.performMassSearch('meSearch', '${t}' , ${s}, { scope: 'world', control: false, pan: false });`}(i,t);if("tagger"===i.method)return function(e,t){let s="";const i={matchAny:"any"===e.tagger.match,allScenes:"world"===e.scope};"selected"===e.scope?(s+=f(t),s+=`targets = Tagger.getByTag('${e.tagger.tags}', { matchAny: ${"any"===e.tagger.match}, objects: targets }).filter(t => t.documentName === '${t}');\n\n`):"scene"===e.scope?s+=`const targets = Tagger.getByTag('${e.tagger.tags}', ${y(i)}).filter(t => t.documentName === '${t}');\n\n`:"world"===e.scope&&(s+="const targets = [];",s+=`Object.values(Tagger.getByTag('${e.tagger.tags}', ${y(i)})).forEach(item => item.forEach(t => { if(t.documentName === '${t}') targets.push(t) }));`);return s}(i,t);if("all"===i.method)return function(e,t){if("selected"===e.scope)return f(t);if(!n.Me.includes(t))return`const targets = Array.from(game.collections.get('${t}'));`;if("scene"===e.scope)return`const targets = canvas.getLayerByEmbeddedName('${t}').placeables.map(o => o.document);\n\n`;if("world"===e.scope)return`const targets = [];\nArray.from(game.scenes).forEach( scene => {\n  Array.from( scene.getEmbeddedCollection('${t}') ).forEach(embed => targets.push(embed));\n});\n  `}(i,t);throw new Error("Invalid target method: "+i.method)}function f(e){let t="";if(n.Me.includes(e))return`let targets = canvas.getLayerByEmbeddedName('${e}').controlled.map(o => o.document);\n\n`;if(game.modules.get("multiple-document-selection")?.active){const s={Actor:"actor",Scene:"scene",JournalEntry:"journalentry",Playlist:"sound",Item:"item",RollTable:"RollTable",Cards:"cards"};return t+="let targets = [];\n",t+="Playlist"===e?`\n$(\`.directory-list .\${'${s[e]}'}.selected\`).each(function (_) {\n  let d = game.collections.get('Playlist').get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId);\n  if (d) targets.push(d);\n});\n`:`\n$(\`.directory-list .\${'${s[e]}'}.selected\`).each(function (_) {\n  let d = game.collections.get('${e}').get(this.dataset.documentId);\n  if (d) targets.push(d);\n});\n  `,t}throw new Error(`'Selected' is not a supported options for ${e}s`)}function y(e){return e?JSON.stringify(e,null,2):null}async function b(e,t,s){let a="";if(a+=function(e,t){let s="";const a=e=>`ui.notifications.warn('${(0,i.zS)("macro.dependency-warning",{module:e})}');`;"tagger"===e.target.method&&(s+=`\nif (!game.modules.get('tagger')?.active) {\n  ${a("Tagger")}\n  return;\n}\n\n`);(function(e){return e.randomize||e.addSubtract||e.toggle?.randomize||e.toggle?.addSubtract||"search"===e.target.method||"massEdit"===e.method||w(e.fields)})(e)&&(s+=`\nconst MassEdit = game.modules.get('${n.Do}');\nif(!MassEdit?.active){\n  ${a("Mass Edit")}\n  return;\n}\n\n`);n.lv.includes(t)&&"select"===e.target.scope&&(s+=`\nif (!game.modules.get('multiple-document-selection')?.active) {\n  ${a("Multiple Document Selection")}\n  return;\n}\n\n`);return s}(s,e),a+=p(s,e,t),a+=g(s,e),(s.macro||s.toggle?.macro)&&(a+=function(e,t){let s=`\n\n// ===================\n// = Macro Execution =\n// ===================\n\nconst advancedMacro = game.modules.get('advanced-macros')?.active;\nconst layer = canvas.getLayerByEmbeddedName('${t}');\n`;e.macro&&(s+=`\n// Apply macro\nconst applyMacro = game.collections.get('Macro').find(m => m.name === '${e.macro.name}')\nif (applyMacro && ${e.toggle?"toggleOnTargets":"targets"}.length) {\n  ${e.macro.select?`layer.activate();\n  layer.releaseAll();\n  ${e.toggle?"toggleOnTargets":"targets"}.forEach(t => t.object?.control({ releaseOthers: false }));\n`:""}\n  if (advancedMacro) applyMacro.execute(${e.toggle?"toggleOnTargets":"targets"});\n  else applyMacro.execute({token, actor});\n  ${e.macro.select?"\n  layer.releaseAll();":""}\n}\n`);e.toggle?.macro&&(s+=`\n// Apply macro on toggle off\nconst offMacro = game.collections.get('Macro').find(m => m.name === '${e.toggle.macro.name}')\nif (offMacro && toggleOffTargets.length) {\n  ${e.toggle.macro.select?"layer.activate();\n  layer.releaseAll();\n  toggleOffTargets.forEach(t => t.object?.control({ releaseOthers: false }));\n":""}\n  if (advancedMacro) offMacro.execute(toggleOffTargets);\n  else offMacro.execute({token, actor});\n  ${e.toggle.macro.select?"\n  layer.releaseAll();":""}\n}\n`);return s}(s,e)),a){(await Macro.create({name:s.name,type:"script",scope:"global",command:a})).sheet.render(!0)}}function k(e){return e.randomize||e.addSubtract||e.toggle?.randomize||e.toggle?.addSubtract||w(e.fields)}function w(e){const t=["tokenmagic.ddTint","tokenmagic.preset","massedit.scale","massedit.texture.scale"];for(const s of t)if(s in e)return!0;return!1}class MacroForm extends FormApplication{constructor(e,t,s,i,a,n){super({},{}),this.mainObject=e,this.placeables=t,this.documentName=s,this.fields=i,this.randomizeFields=a,this.addSubtractFields=n,a&&!foundry.utils.isEmpty(a)||n&&!foundry.utils.isEmpty(n)||m.A.formToData(this.documentName,this.mainObject,this.fields)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-macro",classes:["sheet"],template:`modules/${n.Do}/templates/macro.html`,resizable:!0,minimizable:!1,title:"Generate Macro",width:400,height:"auto"})}async getData(e){const t=super.getData(e);t.documentName=this.documentName,t.fields=JSON.stringify(this.fields,null,2),t.selectable=n.Me.includes(this.documentName),t.selectScopeEnabled=t.selectable||n.lv.includes(this.documentName)&&game.modules.get("multiple-document-selection")?.active;const s=[{value:"all",title:(0,i.zS)("macro.target-all-title",{document:this.documentName}),label:(0,i.kg)("common.all")},{value:"ids",title:(0,i.kg)("macro.target-ids-title"),label:(0,i.kg)("macro.target-ids")},{value:"search",title:(0,i.zS)("macro.target-search-title",{document:this.documentName}),label:(0,i.kg)("FILES.Search",!1)}];return n.Me.includes(this.documentName)&&game.modules.get("tagger")?.active&&s.push({value:"tagger",title:(0,i.kg)("macro.target-tagger-title"),label:"Tagger"}),t.targetingOptions=s,this.addSubtractFields&&!foundry.utils.isEmpty(this.addSubtractFields)&&(t.hasAddSubtract=!0,t.addSubtract=JSON.stringify(this.addSubtractFields)),this.randomizeFields&&!foundry.utils.isEmpty(this.randomizeFields)&&(t.hasRandom=!0,t.randomize=JSON.stringify(this.randomizeFields)),t.hasMEControls=t.hasAddSubtract||t.hasRandom||w(this.fields),t.hiddenControl=["Token","Tile","Drawing","AmbientLight","AmbientSound","MeasuredTemplate"].includes(this.documentName),t.macros=game.collections.get("Macro").map((e=>e.name)),t}_onShowReturnJson(e,t){const s=e.siblings(`[name="${t}"]`),a=JSON.parse(s.val());let n=`<textarea name="json" style="width:100%; height: 300px;">${JSON.stringify(a,null,2)}</textarea>`;new Dialog({title:"JSON",content:n,buttons:{Ok:{label:(0,i.kg)("Save",!1),callback:t=>{try{const i=JSON.parse(t.find('[name="json"]').val()||"{}");foundry.utils.isEmpty(i)?(e.hide(),s.prop("disabled",!0),this.setPosition({height:"auto"})):s.val(JSON.stringify(i))}catch(e){ui.notifications.warn("Invalid data. Failed to save.")}}}}}).render(!0)}_onRemoveJson(e,t){const s=e.siblings(`[name="${t}"]`);e.hide(),s.prop("disabled",!0),this.setPosition({height:"auto"})}activateListeners(e){super.activateListeners(e),["randomize","addSubtract","toggle.randomize","toggle.addSubtract"].forEach((t=>{const s=t.replace(".","");e.find(`.${s}`).click((e=>{this._onShowReturnJson($(e.target).parent(),t)})),e.find(`.${s}`).contextmenu((e=>{this._onRemoveJson($(e.target).parent(),t)}))})),e.find(".toggleVisibility").click((t=>{const s=e.find('[name="fields"]'),i=e.find('[name="toggle.fields"]');let a,n={};try{a=JSON.parse(s.val()),a.hidden=!a.hidden,s.val(JSON.stringify(a,null,2)),n=JSON.parse(i.val()),n.hidden=!a.hidden,i.val(JSON.stringify(n,null,2))}catch(e){}})),e.find('[name="target.method"]').change((t=>{"tagger"===t.target.value?(e.find(".taggerControl").show(),e.find('[name="tags"').attr("required",!0)):(e.find(".taggerControl").hide(),e.find('[name="tags"').attr("required",!1)),"ids"===t.target.value?e.find('[name="target.scope"]').closest(".form-group").hide():e.find('[name="target.scope"]').closest(".form-group").show(),"search"===t.target.value?e.find('[name="target.fields"]').closest("div").show():e.find('[name="target.fields"]').closest("div").hide(),this.setPosition({height:"auto"})})),e.find('[name="method"]').on("change",(t=>{if("toggle"===t.target.value){let t=foundry.utils.flattenObject((s=this.mainObject,s.document?s.document:s).toObject());const i={};Object.keys(this.fields).forEach((e=>i[e]=t[e])),e.find('[name="toggle.fields"]').val(JSON.stringify(i,null,2)),e.find(".toggleControl").show(),this.setPosition({height:"auto"})}else e.find(".toggleControl").hide(),this.setPosition({height:"auto"});var s;"massEdit"===t.target.value||"delete"===t.target.value?(e.find(".fields").hide(),this.setPosition({height:"auto"})):(e.find(".fields").show(),this.setPosition({height:"auto"}))}))}async _updateObject(e,t){(t=expandObject(t)).fields=JSON.parse(t.fields),"toggle"!==t.method?delete t.toggle:t.toggle.fields=JSON.parse(t.toggle.fields),t.macro.name||delete t.macro,t.toggle?.macro&&!t.toggle.macro.name&&delete t.toggle.macro,"tagger"!==t.target.method&&delete t.target.tagger,"search"!==t.target.method?delete t.target.fields:t.target.fields=JSON.parse(t.target.fields),t.randomize&&(t.randomize=JSON.parse(t.randomize)),t.toggle?.randomize&&(t.toggle.randomize=JSON.parse(t.toggle.randomize)),t.addSubtract&&(t.addSubtract=JSON.parse(t.addSubtract)),t.toggle?.addSubtract&&(t.toggle.addSubtract=JSON.parse(t.toggle.addSubtract)),b(this.documentName,this.placeables,t)}}var x=s(739);const _=e=>{class BaseMassEditForm extends e{constructor(e,t,s){s.massSelect&&(s.randomizerEnabled=!1);const a=s.documentName??(0,i.Ng)(e);s.commonData||(s.commonData=(0,h.GS)(t,a)),BaseMassEditForm._setMEActions(s),!foundry.utils.isNewerVersion(game.version,12)||"AmbientSound"!==a&&"AmbientLight"!==a&&"Region"!==a?super(e,s):(s.document=e,super(s)),this.meObjects=t,this.documentName=a,this.commonData=foundry.utils.flattenObject(s.commonData||{}),this.randomizerEnabled=s.massEdit,this.randomizeFields={},this.addSubtractFields={},this.meForm=!0,this.rangeSpanToTextbox=game.settings.get(n.Do,"rangeToTextbox")}get baseDocument(){throw Error("The getBaseDocument() method must be defined by a subclass.")}get title(){return this.options.massSelect?(0,i.zS)("form.mass-search-title",{document:this.documentName}):(0,i.zS)("form.mass-edit-title",{document:this.documentName,count:this.meObjects.length})}static async massUpdateObject(e,t){if(!(t=$(t)).data("action"))return;const s=this.getSelectedFields();if("Token"===this.documentName&&m.f.correctDetectionModeOrder(s,this.randomizeFields),!this.options.presetEdit)return this.options.massSelect?(0,h.qn)(t.data("action"),this.documentName,s,{scope:this.modUpdate?this.modUpdateType:null}):h.pt.call(this,s,this.meObjects,this.documentName,t.data("action"));this.options.callback?.({data:s,addSubtract:this.addSubtractFields,randomize:this.randomizeFields})}getSelectedFields(e){e||(e=this._getSubmitData()),"flags.levels-3d-preview.shaders"in(e=foundry.utils.flattenObject(e))&&(e["flags.levels-3d-preview.shaders"]=this.baseDocument.getFlag("levels-3d-preview","shaders")),"Token"===this.documentName?e["texture.scaleX"]&&(e.scale=Math.abs(e["texture.scaleX"]),e.mirrorX=e["texture.scaleX"]<0,e.mirrorY=e["texture.scaleY"]<0):"Note"===this.documentName&&e["texture.src"]&&(e["icon.selected"]=e["texture.src"],e["icon.custom"]=e["texture.src"]);const t={},s=$(this.element),a=this.addSubtractFields,n=this;return s.find(".form-group").each((function(s){const o=$(this).find(".mass-edit-checkbox > input");o.length&&o.is(":checked")&&$(this).find("[name]").each((function(s){const o=$(this).attr("name");if("flags.limits"===o){const e=foundry.utils.flattenObject(n.meObjects[0].toObject().flags.limits??{});for(const[s,i]of Object.entries(e))t["flags.limits."+s]=i}if(void 0===e[o]&&o.startsWith("flags.")){const s=(0,i.p)(o,e);s&&(t[s]=null)}else t[o]=e[o],o in a&&(a[o].value=e[o]);if("string"===foundry.utils.getType(t[o])){const e=$(this);if(e.hasClass("tva-array"))v.trim()?t[o]=t[o].trim().split(",").map((e=>e.trim())):t[o]=[];else if(e.hasClass("tva-jsonArray"))try{t[o]=JSON.parse(t[o])}catch(e){t[o]=[]}}}))})),t}performMassCopy({command:e="",selectedFields:t=null}={}){if(t||(t=this.getSelectedFields(),"Token"===this.documentName&&m.f.correctDetectionModeOrder(t,this.randomizeFields)),foundry.utils.isEmpty(t))return!1;const s=new l.k({documentName:this.documentName,data:t,randomize:this.randomizeFields,addSubtract:this.addSubtractFields});return(0,h.lW)(s,e,this.isPrototype),!0}_setStyle(e){const[t,s]=(0,u.QD)();e.prepend(`<style>${s}</style>`)}_injectGlobalDeleteButton(e){if(!n.Me.includes(this.documentName)&&!n.lv.includes(this.documentName))return;const t=$(`<div class="me-global-delete"><a title="${(0,i.kg)("form.global-delete-title")}"><i class="far fa-times-octagon fa-2x"></i></a></div>`);t.click((e=>{new Dialog({title:"Confirm",content:`\n                <h2 style="color: red; text-align: center;">${(0,i.zS)("form.delete-warning",{count:this.meObjects.length,document:this.documentName})}</h2>\n                <p>${(0,i.kg)("form.proceed")}</p>`,buttons:{buttonA:{label:(0,i.kg)("Yes",!1),callback:()=>{this.meObjects.forEach((e=>{let t=e.document??e;t.delete&&t.delete()})),this.close()}},no:{label:(0,i.kg)("No",!1)}},default:"buttonA"}).render(!0)})),e.closest("form").append(t)}_activateAutoSelectListeners(e){e.on("input",'textarea, input[type="text"], input[type="number"], range-picker, color-picker',h.Yp.bind(this)),e.on("change","textarea, input, select",h.Yp.bind(this)),e.on("paste","input",h.Yp.bind(this)),e.on("click","button",h.Yp.bind(this))}_processFormGroup(e,t=null){if(!$(e).find("[name]").length)return;if($(e).find(".mass-edit-checkbox").length)return;const s=this.commonData,i=this.rangeSpanToTextbox,a=this.randomizerEnabled;let n="meCommon";s&&$(e).find("[name]").each((function(){const t=$(this).attr("name");if(i&&"range"===$(this).attr("type")){const s=$(e).find("span.range-value");s.length&&(s.replaceWith($(`<input name="${t}" class="range-value" type="number" step="any" value="${this.defaultValue}" min="${this.min}" max="${this.max}"></input>`)),$(this).removeAttr("name"))}t.startsWith("flags.")?n="meFlag":t in s||"invert-radius"===t||(n="meDiff")}));let o="";a&&(o='<div class="mass-edit-randomize"></div>'),n=t??n;const r=$(`<div class="mass-edit-checkbox ${n}">${o}<input class="mass-edit-control" type="checkbox" data-dtype="Boolean"}></div>`);$(e).find("p.hint, p.notes").length?$(e).find("p.hint, p.notes").first().before(r):$(e).append(r),$(e).addClass(n)}_processAllFormGroups(e){const t=this._processFormGroup.bind(this);e.find(".form-group").each((function(e){t(this)}))}async _processPreset(e){let t=!1;const s=foundry.utils.flattenObject(e.data[0]);"flags.monks-active-tiles.actions"in s&&(t=!0,await this.baseDocument.setFlag("monks-active-tiles","actions",s["flags.monks-active-tiles.actions"])),"flags.monks-active-tiles.files"in s&&(t=!0,await this.baseDocument.setFlag("monks-active-tiles","files",s["flags.monks-active-tiles.files"])),"flags.levels-3d-preview.shaders"in s&&(t=!0,await this.baseDocument.setFlag("levels-3d-preview","shaders",s["flags.levels-3d-preview.shaders"])),"flags.limits.light.enabled"in s&&(t=!0,await this.baseDocument.update({flags:{limits:foundry.utils.expandObject(s).flags.limits}})),"Token"===this.documentName&&(t=m.f.modifyPresetData(this,s)),t?setTimeout((()=>{this._applyPreset(e)}),250):this._applyPreset(e)}_applyPreset(e){const t=$(this.form),s=(e,t)=>{if(!t)return e;for(const[s,i]of Object.entries(t))e[s]=i;return e};this.randomizeFields=s(this.randomizeFields,e.randomize),this.addSubtractFields=s(this.addSubtractFields,e.addSubtract),(0,c.RZ)(t,this.randomizeFields),(0,i.Tx)(t,this.addSubtractFields);const n=foundry.utils.flattenObject(e.data[0]);m.A.dataToForm(this.documentName,e.data[0],n);for(const e of Object.keys(n)){const s=t.find(`[name="${e}"]`);s.is(":checkbox")?s.prop("checked",n[e]):s.val(n[e]),s.trigger("change")}a.vM.refreshPreset()}_registerRandomizerListeners(e){const t=this;this.randomizerEnabled&&e.on("contextmenu",".mass-edit-checkbox",(e=>{s.e(816).then(s.bind(s,816)).then((s=>{s.showRandomizeDialog($(e.target).closest(".form-group"),t)}))}))}_registerBrushRefreshListeners(e){e.on("input",'textarea, input[type="text"], input[type="number"]',(()=>a.vM.refreshPreset())),e.on("change","textarea, input, select",(()=>a.vM.refreshPreset())),e.on("paste","input",(()=>a.vM.refreshPreset())),e.on("click","button",(()=>a.vM.refreshPreset()))}_registerNumericalInputListeners(e){e.on("contextmenu",'input[type=range], input[type=number], input[name="flags.tagger.tags"], input[type="text"], input[name="tokenmagic.preset"]',(e=>{const t=e.target.name;if(!t)return;const s=$(e.target);if(t in this.addSubtractFields)if("add"===this.addSubtractFields[t].method){this.addSubtractFields[t].method="subtract",s.removeClass("me-add").addClass("me-subtract"),s.attr("title","- Subtracting");const i={method:"subtract"};e.target.min&&(i.min=parseFloat(e.target.min)),i.type=s.attr("type"),this.addSubtractFields[t]=i}else delete this.addSubtractFields[t],s.removeClass("me-subtract"),s.attr("title","");else{s.addClass("me-add"),s.attr("title","+ Adding");const i={method:"add"};e.target.max&&(i.max=parseFloat(e.target.max)),i.type=s.attr("type"),this.addSubtractFields[t]=i}(0,h.Yp)(e),a.vM.refreshPreset()}))}_registerInputChangeCallback(e){this.options.inputChangeCallback&&e.on("change","input, select",(async e=>{setTimeout((()=>this.options.inputChangeCallback(this.getSelectedFields())),100)}))}_registerNavigationTabMassSelect(e){e.on("contextmenu","nav > .item",(e=>{const t=e.target.dataset?.tab;if(t){const s=$(e.target).closest("nav").attr("data-group");let i;s&&(i=$(e.target).closest("form").find(`.tab[data-tab="${t}"][data-group="${s}"], .matt-tab[data-tab="${t}"][data-group="${s}"]`).find(".mass-edit-control")),i&&0!==i.length||(i=$(e.target).closest("form").find(`.tab[data-tab="${t}"], .matt-tab[data-tab="${t}"]`).find(".mass-edit-control"));let a=!0;0===i.not(":checked").length&&(a=!1),i.prop("checked",a),i.each((function(){a?selectTabs(this):deselectTabs(this)})),i.first().trigger("change")}}))}_insertModuleSpecificFields(e){if("Tile"===this.documentName&&this._createAction){let t=$(`\n              <div class="form-group">\n                <label>Mass Edit: ${(0,i.kg)("form.actions")}</label>\n                <div class="form-fields">\n                    <input type="hidden" name="flags.monks-active-tiles.actions">\n                </div>\n              `);$(e).find('.matt-tab[data-tab="trigger-actions"]').prepend(t),this._processFormGroup(t,"meInsert"),t=$(`\n              <div class="form-group">\n                <label>Mass Edit: ${(0,i.kg)("form.images")}</label>\n                <div class="form-fields">\n                    <input type="hidden" name="flags.monks-active-tiles.files">\n                </div>\n              `),t.insertBefore('.matt-tab[data-tab="trigger-images"] .files-list'),this._processFormGroup(t,"meInsert")}if(("Tile"===this.documentName||"Token"===this.documentName)&&game.Levels3DPreview){let t=$(`\n              <div class="form-group">\n                <label>Mass Edit: ${(0,i.kg)("form.shaders")}</label>\n                <div class="form-fields">\n                    <input type="hidden" name="flags.levels-3d-preview.shaders">\n                </div>\n              `);$(e).find("#shader-config").after(t),this._processFormGroup(t,"meInsert")}}_insertSpecialFields(e){if(("Tile"===this.documentName||"Token"===this.documentName)&&!this.options?.simplified&&game.modules.get("tokenmagic")?.active&&game.settings.get(n.Do,"tmfxFieldsEnable")){let t='<datalist id="tmfxPresets"><option value="DELETE ALL">';TokenMagic.getPresets().forEach((e=>t+=`<option value="${e.name}">`)),t+='</datalist><input list="tmfxPresets" name="tokenmagic.preset">';let s=$(`\n              <div class="form-group">\n                <label>${(0,i.kg)("common.preset")} <span class="units">(TMFX)</span></label>\n                <div class="form-fields">\n                  ${t}\n                </div>\n              `);$(e).find('[name="texture.tint"]').closest(".form-group").after(s),this._processFormGroup(s,"meInsert");const a=(0,d.qT)(this.baseDocument.object??this.baseDocument);s=$(`\n              <div class="form-group">\n                <label>DungeonDraft <span class="units">(TMFX)</span></label>\n                <div class="form-fields">\n                  <input class="color" type="text" name="tokenmagic.ddTint" value="${a}">\n                  <input type="color" value="${a}" data-edit="tokenmagic.ddTint">\n                </div>\n              `),$(e).find('[name="texture.tint"]').closest(".form-group").after(s),this._processFormGroup(s,"meInsert")}if("Tile"===this.documentName){let t=$(`\n            <div class="form-group slim">\n              <label>${(0,i.kg)("Scale",!1)} <span class="units">(${(0,i.kg)("common.ratio")})</span></label>\n              <div class="form-fields">\n                <label>${(0,i.kg)("Width",!1)} | ${(0,i.kg)("Height",!1)} ${game.Levels3DPreview?._active?"| Depth":""}</label>\n                <input type="number" value="1" step="any" name="massedit.scale" min="0">\n              </div>\n            </div>`);$(e).find('[name="width"]').closest(".form-group").before(t),this._processFormGroup(t,"meInsert"),t=$(`\n              <div class="form-group slim">\n                <label>${(0,i.kg)("TILE.Scale",!1)} <span class="units">(${(0,i.kg)("common.ratio")})</span></label>\n                <div class="form-fields">\n                  <label>${(0,i.kg)("TILE.ScaleX",!1)} | ${(0,i.kg)("TILE.ScaleY",!1)}</label>\n                  <input type="number" value="1" step="any" name="massedit.texture.scale" min="0">\n                </div>\n              </div>`),$(e).find('[name="texture.scaleX"]').closest(".form-group").before(t),this._processFormGroup(t,"meInsert")}}_insertModUpdateCheckboxes(e){if(this.options.massEdit&&!this.options.simplified&&!this.options.presetEdit){const t=this,s=game.settings.get(n.Do,"preSelectAutoApply");e.find('button[type="submit"]').each((function(a){const n=$(this),o=$(`<div class="me-mod-update" title="${(0,i.kg)("form.immediate-update-title")}"><input type="checkbox" data-submit="${n.data("action")}"><i class="fas fa-cogs"></i></div>`);o.on("change",(s=>{s.stopPropagation();const i=s.target.checked;e.find(".me-mod-update > input").not(this).prop("checked",!1),$(s.target).prop("checked",i),t.modUpdate=i,t.modUpdateType=$(s.target).data("submit")})),0===a&&s&&o.find('input[type="checkbox"]').prop("checked",!0).trigger("change"),o.insertAfter(n)}))}}_performOnInputChangeUpdate(){const e=this.getSelectedFields();h.pt.call(this,e,this.meObjects,this.documentName,this.modUpdateType)}_registerMutateObserver(e){const t=this._processFormGroup.bind(this);new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{$(e).hasClass("form-group")?t(e):$(e).find(".form-group").each((function(){$(this).find(".mass-edit-checkbox").length||t(this)}))}))}))})).observe(e[0],{characterData:!1,attributes:!1,childList:!0,subtree:!0})}_onClose(e={}){return e.force=!0,a.vM.deactivate(),this.linkedPresetForm&&this.linkedPresetForm.close(),super._onClose?.(e)}static _openMacroForm(){const e=this.getSelectedFields();new MacroForm(this.baseDocument,this.meObjects,this.documentName,e,this.randomizeFields,this.addSubtractFields).render(!0)}static _activateBrushTool(){a.vM.activate({app:this})}static _openEditPermissions(){let e=[];const t=new Set;for(const s of this.meObjects){let i;"Actor"===this.documentName||"JournalEntry"===this.documentName?i=s:"Token"===this.documentName&&s.actor?i=s.actor:"Note"===this.documentName&&s.entry&&(i=s.entry),i&&!t.has(i.id)&&(e.push(i),t.add(i.id))}new(S())(e[0],e).render(!0)}static _openPresetBrowser(){this.linkedPresetForm=new r.P6(this,null,this.documentName,{left:this.position.left-370,top:this.position.top,preventPositionOverride:!0}),this.linkedPresetForm.render(!0)}static _openViewApplyJSON(){let e=foundry.utils.expandObject(this.getSelectedFields());e=foundry.utils.isEmpty(e)?"":JSON.stringify(e,null,2);let t=`<textarea class="json" style="width:100%; height: 300px;">${e}</textarea>`;new Dialog({title:(0,i.kg)("form.apply-json"),content:t,buttons:{apply:{label:(0,i.kg)("common.apply"),callback:e=>{let t={};try{t=JSON.parse(e.find(".json").val())}catch(e){}if(!foundry.utils.isEmpty(t)){const e=new l.k({documentName:this.documentName,data:foundry.utils.flattenObject(t)});this._processPreset(e)}}}}}).render(!0)}static _showMassActorForm(){(0,x.Pw)(this.meObjects,{massEdit:this.options.massEdit})&&this.close()}static _setMEActions(e){const t=e.action??{};t.meMacroGen=this._openMacroForm,t.meBrush=this._activateBrushTool,t.meEditPermissions=this._openEditPermissions,t.mePresetBrowser=this._openPresetBrowser,t.meJSON=this._openViewApplyJSON,t.meTokenActor=this._showMassActorForm,["meSearch","meSearchAndEdit","meApplyCurrentScene","meApplyAllScenes","meApply","meApplyToPrototype"].forEach((e=>{t[e]=this.massUpdateObject})),e.actions=t,foundry.utils.setProperty(e,"form.handler",(()=>{}))}_meGetSubmitButtons(){const e=[];return this.options.massSelect?(e.push({type:"submit",icon:"fas fa-search",label:(0,i.kg)("FILES.Search",!1),action:"meSearch"}),e.push({type:"submit",icon:"fas fa-search",label:(0,i.kg)("form.search-and-edit"),action:"meSearchAndEdit"})):"Note"!==this.documentName||this.options.presetEdit?(e.push({type:"submit",label:(0,i.kg)("common.apply"),icon:"far fa-save",action:"meApply"}),"Token"!==this.documentName||this.options.simplified||this.meObjects[0].constructor?.name?.startsWith("PrototypeToken")||this.options.presetEdit||e.push({type:"submit",label:(0,i.kg)("form.apply-update-proto"),icon:"far fa-save",action:"meApplyToPrototype"})):(this.meObjects.filter((e=>(e.scene??e.parent).id===canvas.scene.id)).length&&e.push({type:"submit",icon:"far fa-save",label:(0,i.kg)("form.apply-on-current-scene"),action:"meApplyCurrentScene"}),this.meObjects.filter((e=>(e.scene??e.parent).id!==canvas.scene.id)).length&&e.push({type:"submit",label:(0,i.kg)("form.apply-on-all-scenes"),icon:"fas fa-globe",action:"meApplyAllScenes"})),e}_getMeControls(){return[{label:"Generate Macro",class:"mass-edit-macro",icon:"fas fa-terminal",action:"meMacroGen",visible:n.Me.includes(this.documentName)||n.lv.includes(this.documentName)},{label:"Brush",class:"mass-edit-brush",icon:"fas fa-paint-brush",action:"meBrush",visible:n.Me.includes(this.documentName)},{label:"Permissions",class:"mass-edit-permissions",icon:"fas fa-lock fa-fw",action:"meEditPermissions",visible:["Token","Note","Actor"].includes(this.documentName)},{label:"Presets",class:"mass-edit-presets",icon:"fas fa-box",action:"mePresetBrowser",visible:!this.options.simplified},{label:"JSON",class:"mass-edit-apply",icon:"far fa-money-check-edit",action:"meJSON",visible:!0},{label:"Switch",class:"mass-edit-actors",icon:"fas fa-user",action:"meTokenActor",visible:"Token"===this.documentName&&this.meObjects.filter((e=>e.actor)).length}]}}return BaseMassEditForm},D=e=>class MassEditForm extends e{_attachFrameListeners(){super._attachFrameListeners()}_onRender(){super._onRender(),o(this);const e=$(this.element);this._injectGlobalDeleteButton(e),this._setStyle(e),this._activateAutoSelectListeners(e),this._processAllFormGroups(e),this._registerRandomizerListeners(e),this._registerBrushRefreshListeners(e),this._registerNumericalInputListeners(e),this._registerInputChangeCallback(e),this._registerNavigationTabMassSelect(e),this._insertModUpdateCheckboxes(e),this._insertModuleSpecificFields(e),this._insertSpecialFields(e),this._registerMutateObserver(e)}get baseDocument(){return this.document}_getSubmitData(){const e=this.element,t=new FormDataExtended(e);return this._prepareSubmitData(null,e,t)}_getHeaderControls(){return[].concat(super._getHeaderControls()).concat(this._getMeControls())}async _preparePartContext(e,t){return"footer"!==e?super._preparePartContext(e,t):t}async _prepareContext(e){const t=await super._prepareContext(e);return t.buttons=(t.buttons??[]).filter((e=>"submit"!==e.type)),t.buttons=t.buttons.concat(this._meGetSubmitButtons()),t}async render(e={},t={}){if(!t.renderContext?.startsWith("update"))return super.render(e,t)}},P=e=>class MassEditForm extends e{async getData(e){"AmbientLight"!==this.documentName||this.preview||(this.preview=this.baseDocument.clone());return super.getData(e)}get baseDocument(){return this.object}async activateListeners(e){await super.activateListeners(e),o(this),this._injectGlobalDeleteButton(e),this._setStyle(e),this._activateAutoSelectListeners(e),this._processAllFormGroups(e),this._registerRandomizerListeners(e),this._registerBrushRefreshListeners(e),this._registerNumericalInputListeners(e),this._registerInputChangeCallback(e),this._registerNavigationTabMassSelect(e),this._removeFooterButtons(e),this._insertSubmitButtons(e),this._insertModUpdateCheckboxes(e),this._insertModuleSpecificFields(e),this._insertSpecialFields(e),this._registerMutateObserver(e),this.setPosition(),this.element[0].style.height="","Token"===this.documentName&&$(e).find("fieldset.detection-mode").each((function(e){$(this).wrap('<div class="form-group"></div>')}))}_insertSubmitButtons(e){const t=this._meGetSubmitButtons();let s="";if(!this._meSubmitInserted){this._meSubmitInserted=!0;for(const e of t)s+=`<button class="me-submit" type="submit" data-action="${e.action}"><i class="${e.icon}"></i> ${e.label}</button>`;this.options.massSelect&&n.Me.includes(this.documentName)&&(s+=`<div class="me-mod-update" title="${(0,i.kg)("form.global-search-title")}"><input type="checkbox" data-submit="world"><i class="far fa-globe"></i></div>`);let a=$(e).find(".sheet-footer").last();a.length?a.append(s):(a=$(`<footer class="sheet-footer flexrow">${s}</footer>`),$(e).closest("form").append(a))}}async _onChangeInput(e){if(!["AmbientLight","Tile","Token"].includes(this.documentName))return void super._onChangeInput(e);const t=e.target;"color"===t.type&&t.dataset.edit?this._onChangeColorPicker(e):"range"===t.type&&this._onChangeRange(e)}async _updateObject(e,t){await this.options.actions.meApply.call(this,e,e.submitter),["Token","AmbientLight"].includes(this.documentName)&&this.preview?.object&&this._resetPreview()}_getHeaderButtons(){let e=super._getHeaderButtons().filter((e=>"configure-sheet"!==e.class));const t=foundry.utils.deepClone(this._getMeControls());return t.forEach((e=>{e.onclick=this.options.actions[e.action].bind(this),e.label=""})),t.concat(e)}_removeFooterButtons(e){e.find(".sheet-footer > button").remove(),e.find('button[type="submit"]').remove()}render(e,t={}){if("update"===t.action||t.renderContext?.startsWith("update"))return;if(!this.form)return super.render(e,t);const s=this.getSelectedFields(),i=this.randomizeFields,a=this.addSubtractFields;super.render(e,t),setTimeout((()=>{this.form&&this._applyPreset(new l.k({data:s,randomize:i,addSubtract:a}))}),1e3)}async close(e={}){return super._onClose(e),["Token","AmbientLight"].includes(this.documentName)&&this.preview?.object&&this._resetPreview(),super.close(e)}},T=e=>{const t=_(e);return foundry.applications?.api?.ApplicationV2&&e.BASE_APPLICATION===foundry.applications.api.ApplicationV2?D(t):P(t)},E=(e="NONE")=>{let t;const s=CONFIG[e]?.sheetClasses;t=s&&"Actor"!==e?Object.values(Object.values(s).pop()??{}).pop()?.cls:FormApplication;const i=T(t);class MassConfig extends i{constructor(e,t,s){super(e.document?e.document:e,t,s)}}const a=`Mass${e}Config`;return Object.defineProperty(MassConfig.prototype.constructor,"name",{value:a}),MassConfig},S=()=>{let e=T(DocumentOwnershipConfig);return class MassPermissions extends e{constructor(e,t,s={}){const a=(0,i.bQ)(t[0]),n=foundry.utils.flattenObject(a.ownership),o=CONST.DOCUMENT_META_OWNERSHIP_LEVELS,r=function(e){game.users.forEach((t=>{t.id in e||(e[t.id]=o.DEFAULT)})),"default"in e||(e.default=o.DEFAULT)};r(n);for(let e=1;e<t.length;e++){const s=(0,i.bQ)(t[e]),a=foundry.utils.flattenObject(s.ownership);r(a);const o=foundry.utils.flattenObject(foundry.utils.diffObject(n,a));for(const e of Object.keys(o))delete n[e]}s.commonData=n,s.massPermissions=!0,super(e,t,s)}async _updateObject(e,t){const s=this.getSelectedFields(t),a=CONST.DOCUMENT_META_OWNERSHIP_LEVELS;if(foundry.utils.isEmpty(s))return;const n=new Set,o=[];for(const e of this.meObjects)if(!n.has(e.id)){const t=(0,i.bQ)(e),r=foundry.utils.deepClone(t.ownership);for(let[e,t]of Object.entries(s))t===a.DEFAULT?delete r[e]:r[e]=t;n.add(e.id),o.push({_id:e.id,ownership:r})}this.meObjects[0].constructor.updateDocuments(o,{diff:!1,recursive:!1,noHook:!0})}get title(){return`Mass-${this.documentName} PERMISSIONS EDIT [ ${this.meObjects.length} ]`}}}},338:(e,t,s)=>{s.d(t,{s:()=>MassEditGenericForm});const i={field:{shieldType:{range:!0,min:"0",max:"13",step:"1"},blend:{range:!0,min:"0",max:"16",step:"1"},scale:{range:!0,min:"0",max:"5",step:"0.01"},radius:{range:!0,min:"0",max:"5",step:"0.01"},intensity:{range:!0,min:"0",max:"5",step:"0.01"},lightAlpha:{range:!0,min:"0",max:"50",step:"0.1"},gridPadding:{range:!0,min:"0",max:"5",step:"0.01"},lightSize:{range:!0,min:"0",max:"20",step:"0.1"},animated:{time:{speed:{range:!0,min:"0",max:"0.05",step:"0.0001"}}}},fire:{fireBlend:{range:!0,min:"0",max:"13",step:"1"},blend:{range:!0,min:"0",max:"13",step:"1"},animated:{intensity:{animType:{select:!0,options:["syncChaoticOscillation","syncSinOscillation","syncCosOscillation","chaoticOscillation","halfSinOscillation","sinOscillation","halfCosOscillation","cosOscillation","syncColorOscillation","halfColorOscillation","colorOscillation"]},val2:{range:!0,min:"0",max:"5",step:"0.1"},val1:{range:!0,min:"0",max:"5",step:"0.1"},loopDuration:{range:!0,min:"0",max:"50000",step:"100"}},amplitude:{animType:{select:!0,options:["syncChaoticOscillation","syncSinOscillation","syncCosOscillation","chaoticOscillation","halfSinOscillation","sinOscillation","halfCosOscillation","cosOscillation","syncColorOscillation","halfColorOscillation","colorOscillation"]},loopDuration:{range:!0,min:"0",max:"50000",step:"100"},val1:{range:!0,min:"0",max:"5",step:"0.1"},val2:{range:!0,min:"0",max:"5",step:"0.1"}}},intensity:{range:!0,min:"0",max:"100",step:"0.1"}},electric:{blend:{range:!0,min:"0",max:"13",step:"1"}},xglow:{auraType:{range:!0,min:"0",max:"2",step:"1"},scale:{range:!0,min:"0",max:"30",step:"0.1"},auraIntensity:{range:!0,min:"0",max:"20",step:"0.1"},subAuraIntensity:{range:!0,min:"0",max:"20",step:"0.1"},threshold:{range:!0,min:"0",max:"2",step:"0.01"},thickness:{range:!0,min:"0",max:"20",step:"0.1"}},glow:{outerStrength:{range:!0,min:"0",max:"50",step:"0.1"},innerStrength:{range:!0,min:"0",max:"50",step:"0.1"},padding:{range:!0,min:"0",max:"100",step:"1"},alpha:{range:!0,min:"0",max:"1",step:"0.01"}},zapshadow:{alphaTolerance:{range:!0,min:"0",max:"1",step:"0.01"}},sprite:{blendMode:{range:!0,min:"0",max:"16",step:"1"},gridPadding:{range:!0,min:"0",max:"5",step:"0.1"},scaleX:{range:!0,min:"0",max:"3",step:"0.01"},scaleY:{range:!0,min:"0",max:"3",step:"0.01"},translationX:{range:!0,min:"-1",max:"1",step:"0.001"},translationY:{range:!0,min:"-1",max:"1",step:"0.001"},rotation:{range:!0,min:"0",max:"360",step:"1"},alpha:{range:!0,min:"0",max:"1",step:"0.01"}},xfire:{blend:{range:!0,min:"0",max:"16",step:"1"},amplitude:{range:!0,min:"0",max:"10",step:"0.01"},dispersion:{range:!0,min:"0",max:"20",step:"0.1"},scaleX:{range:!0,min:"0",max:"5",step:"0.01"},scaleY:{range:!0,min:"0",max:"5",step:"0.01"},animated:{time:{speed:{range:!0,min:"-0.0050",max:"0.0050",step:"0.0001"}}}},transform:{gridPadding:{range:!0,min:"0",max:"50",step:"0.1"},scaleX:{range:!0,min:"0",max:"5",step:"0.1"},scaleY:{range:!0,min:"0",max:"5",step:"0.1"}},ascii:{animated:{size:{val1:{range:!0,min:"-5",max:"5",step:"0.01"},val2:{range:!0,min:"-5",max:"5",step:"0.01"}}},size:{range:!0,min:"1",max:"64",step:"1"}},dot:{scale:{range:!0,min:"0",max:"10",step:"0.1"},angle:{range:!0,min:"0",max:"360",step:"1"}},godray:{blendMode:{range:!0,min:"0",max:"20",step:"1"},padding:{range:!0,min:"-5",max:"50",step:"0.1"}},rgbSplit:{redX:{range:!0,min:"-50",max:"50",step:"1"},redY:{range:!0,min:"-50",max:"50",step:"1"},greenX:{range:!0,min:"-50",max:"50",step:"1"},greenY:{range:!0,min:"-50",max:"50",step:"1"},blueX:{range:!0,min:"-50",max:"50",step:"1"},blueY:{range:!0,min:"-50",max:"50",step:"1"}},polymorph:{type:{range:!0,min:"0",max:"9",step:"1"}},shadow:{blur:{range:!0,min:"0",max:"20",step:"1"}},flood:{billowy:{range:!0,min:"0",max:"5",step:"0.01"},tintIntensity:{range:!0,min:"0.0",max:"1",step:"0.01"},glint:{range:!0,min:"0",max:"1",step:"0.01"},scale:{range:!0,min:"5",max:"500",step:"1"},animated:{time:{speed:{range:!0,min:"0.00001",max:"0.001",step:"0.00001"}}}}};var a=s(596),n=s(120),o=s(622),r=s(739);function l(e,t,s,i=!0){const o={dataGroup:"main",items:[],tabs:[]},r=[{navSelector:'.tabs[data-group="main"]',contentSelector:"form",initial:"me-pinned"}];let l={};l=e;const d=t&&game.settings.get(a.Do,"pinnedFields")[t]||{};c(o,l,r,"",d,s,i);const u=[],m=foundry.utils.flattenObject(l);for(const[e,t]of Object.entries(d)){const a=e in m?m[e]:t.value;let n=p(foundry.utils.getType(a),t.label,a,e,{},!0,s,i);n.pinned=!0,u.push(n)}return u.length&&(o.items.length||(o.items.push({dataTab:"main-me-main",label:"Main"}),o.tabs.push({dataTab:"main-me-main",groups:o.groups}),delete o.groups),o.items.unshift({dataTab:"me-pinned",dataTab:"me-pinned",label:(0,n.kg)("generic-form.pinned")}),o.tabs.unshift({dataTab:"me-pinned",groups:u})),[o,r]}function c(e,t,s,i,a,n,o){const r=[];let l=!1;for(const[m,h]of Object.entries(t)){const t=i?i+"."+m:m;if(null!==h){let i,g=foundry.utils.getType(h);if("Object"===g){if(d(h)){e.items.push({dataTab:t,label:u(m)});const i={dataGroup:t,items:[],tabs:[]};e.tabs.push({dataTab:t,nav:i}),s.push({navSelector:`.tabs[data-group="${t}"]`,contentSelector:`.tab[data-tab="${t}"]`,initial:m+"-me-main"}),c(i,h,s,t,a,n,o),l=!0}}else i=p(g,u(m),h,t,a,!1,n,o);i&&r.push(i)}}r.length&&(l?(e.items.unshift({dataTab:e.dataGroup+"-me-main",label:"Main"}),e.tabs.unshift({dataTab:e.dataGroup+"-me-main",groups:r})):e.groups=r)}function d(e){if(foundry.utils.isEmpty(e))return!1;for(const[t,s]of Object.entries(e))if("Object"===foundry.utils.getType(s)){if(d(s))return!0}else if(null!=s)return!0;return!1}function u(e){return e.length<=3?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)}const m=["img","image","src","texture"],h=["tint"];function g(e){return e=e.split(".").pop(),h.includes(e)||e.toLowerCase().includes("color")}function p(e,t,s,i,a,n=!1,o={},r){const l=["number","string"];let c={label:t,value:s,name:i,editableLabel:n,pins:r};if(foundry.utils.getProperty(o,i))c=foundry.utils.mergeObject(c,foundry.utils.getProperty(o,i));else if("number"===e){c.number=!0;if(g(i.split(".").pop())){c.colorPickerNumber=!0;try{c.colorValue=new Color(s).toString()}catch(e){}}}else if("string"===e){c.text=!0;const e=i.split(".").pop();m.includes(e)||e.toLowerCase().includes("image")||e.toLowerCase().includes("path")?c.filePicker=!0:g(e)&&(c.colorPicker=!0)}else"boolean"===e?c.boolean=!0:"Array"===e&&s.every((e=>l.includes(foundry.utils.getType(e))))?(c.value=s.join(", "),c.array=!0):"Array"===e?(c.jsonArray=!0,c.value=JSON.stringify(s,null,2)):(c.disabled=!0,c.text=!0,c.editableLabel=!1);return c&&i in a&&(c.pinned=!0,c.disabled=!0,c.name=null),c}const f=(0,o.dN)();class MassEditGenericForm extends f{constructor(e,t={}){const s=e.map((e=>e.toObject?e.toObject():e));let o={};for(let e=s.length;e>=0;e--)foundry.utils.mergeObject(o,s[e]);t.noTabs&&(o=foundry.utils.flattenObject(o));let r=t.documentName??"NONE",c=foundry.utils.mergeObject(i[r]??{},game.settings.get(a.Do,"customControls")[r]??{});c=foundry.utils.mergeObject(c,t.customControls?.[r]??{});const[d,u]=l(o,r,c,!t.noTabs),m=(0,n.m1)(s);super(e[0],e,{tabs:u,commonData:m,...t}),this.allData=o,this.nav=d,this.editableLabels={},this.pinnedFields=game.settings.get(a.Do,"pinnedFields")[this.documentName]??{},this.customControls=c,t.callback&&(this.callbackOnUpdate=t.callback)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-generic-form",classes:["sheet"],template:`modules/${a.Do}/templates/generic/genericForm.html`,resizable:!0,minimizable:!1,title:"Generic",width:500,height:"auto"})}_getHeaderButtons(){const e=super._getHeaderButtons();return this.options.tokens&&e.unshift({label:"",class:"mass-edit-tokens",icon:"fas fa-user-circle",onclick:()=>{(0,r.gx)(this.options.tokens,"Token"),this.close()}}),e}async getData(e){const t=await super.getData(e);return await getTemplate(`modules/${a.Do}/templates/generic/navHeaderPartial.html`,"me-navHeaderPartial"),await getTemplate(`modules/${a.Do}/templates/generic/form-group.html`,"me-form-group"),t.nav=this.nav,t}activateListeners(e){super.activateListeners(e),e.find(".me-pinned").click((e=>{const t=$(e.target).parent(),s=t.closest(".form-group").find("[name]").attr("name");t.hasClass("active")?(t.removeClass("active"),delete this.pinnedFields[s]):(t.addClass("active"),this.pinnedFields[s]={label:s})})),e.find(".me-editable-label").on("input",(e=>{const t=$(e.target).closest(".form-group").find("[name]").attr("name");this.editableLabels[t]=e.target.value})),e.find(".color-number").on("change",(e=>{if(e.target.dataset?.editNumber){let t=0;try{t=Number(Color.fromString(e.target.value))}catch(e){}$(e.target).siblings(`[name="${e.target.dataset.editNumber}"]`).val(t).trigger("input")}})),e.find(".me-editable-label, label").on("contextmenu",(e=>{const t=$(e.target).closest(".form-group");if(!t.length)return;const s=t.find("[name]"),i=s.attr("name");if(i){if(g(i))return;const e=s.attr("type");if("range"===e)return void function(e,t){const s=game.settings.get(a.Do,"customControls");let i=s[t]||{};setProperty(i,e,null),game.settings.set(a.Do,"customControls",s)}(i,this.documentName);"number"===e?function(e,t,s,i,{min:o=null,max:r=null,step:l=null}={}){let c=`\n<div class="form-group slim">\n  <label>Range</label>\n  <div class="form-fields">\n    <label>${(0,n.kg)("Minimum",!1)}</label>\n    <input type="number" value="${o??t}" name="min" step="any">\n    <label>${(0,n.kg)("Maximum",!1)}</label>\n    <input type="number" value="${r??t}" name="max" step="any">\n    <label>${(0,n.kg)("generic-form.step-size")}</label>\n    <input type="number" value="${l??1}" name="step" step="any">\n  </div>\n</div>\n  `;new Dialog({title:(0,n.kg)("generic-form.define-range"),content:c,buttons:{save:{label:(0,n.kg)("Save",!1),callback:async n=>{const o=n.find('[name="min"]').val()||t,r=n.find('[name="max"]').val()||t,l=n.find('[name="step"]').val()||1;setProperty(s,e,{range:!0,min:o,max:r,step:l});const c=game.settings.get(a.Do,"customControls");c[i]=s,game.settings.set(a.Do,"customControls",c)}}}}).render(!0)}(i,s.val(),this.customControls,this.documentName):"text"===e&&function(e,t,s,i,{options:o=null}={}){let r=`\n<div class="form-group slim">\n  <label>${(0,n.kg)("common.options")}</label>\n  <textarea name="options">${o?o.join("\n"):t}</textarea>\n</div>\n  `;new Dialog({title:(0,n.kg)("generic-form.define-dropdown"),content:r,buttons:{save:{label:(0,n.kg)("Save",!1),callback:async t=>{const n=t.find('[name="options"]').val().trim();if(n){setProperty(s,e,{select:!0,options:n.split("\n").filter((e=>e))});const t=game.settings.get(a.Do,"customControls");t[i]=s,game.settings.set(a.Do,"customControls",t)}}}}}).render(!0)}(i,s.val(),this.customControls,this.documentName)}})),this.options.inputChangeCallback&&e.on("change","input, select",(async e=>{setTimeout((()=>this.options.inputChangeCallback(this.getSelectedFields())),100)}))}async _updateObject(e,t){super._updateObject(e,t);const s=game.settings.get(a.Do,"pinnedFields");s[this.documentName]=this.pinnedFields;for(const e of Object.keys(this.pinnedFields))this.pinnedFields[e].value=t[e];if(!foundry.utils.isEmpty(this.editableLabels)){for(const[e,s]of Object.entries(this.editableLabels))e in this.pinnedFields&&(this.pinnedFields[e].label=s,this.pinnedFields[e].value=t[e]);this.editableLabels={}}game.settings.set(a.Do,"pinnedFields",s)}async close(e={}){return this.callbackOnUpdate&&this.callbackOnUpdate(null),super.close(e)}}},739:(e,t,s)=>{s.d(t,{CM:()=>v,G_:()=>f,Ls:()=>k,Pw:()=>b,QH:()=>u,bj:()=>w,ef:()=>p,gx:()=>y,i2:()=>d});var i=s(596),a=s(860),n=s(652),o=s(120),r=s(439),l=s(622),c=s(338);const d={Token:"tokens",Tile:"tiles",Drawing:"drawings",Wall:"walls",AmbientLight:"lighting",AmbientSound:"sounds",MeasuredTemplate:"templates",Note:"notes"},u={Token:"tokens",Tile:"tiles",Drawing:"drawings",Wall:"walls",AmbientLight:"lights",AmbientSound:"sounds",MeasuredTemplate:"templates",Note:"notes"};function m(){return canvas.activeLayer.controlled.length?canvas.activeLayer.controlled:null}function h(){let e=canvas.activeLayer.constructor.documentName;return!["Wall"].includes(e)&&canvas.activeLayer.hover?[canvas.activeLayer.hover]:null}function g(e){const t=[{name:"Actor",class:"actor"},{name:"Scene",class:"scene"},{name:"JournalEntry",class:"journalentry"},{name:"Playlist",class:"sound"},{name:"Item",class:"item"},{name:"RollTable",class:"rolltable"},{name:"Cards",class:"cards"}];for(const s of t){const t=[];if($(`.directory-list .${s.class}.selected`).each((function(i){let a;a="Playlist"===s.name?game.collections.get(s.name).get(this.dataset.playlistId)?.sounds.get(this.dataset.soundId):game.collections.get(s.name).get(this.dataset.documentId),a&&(e&&"JournalEntry"===s.name?game.collections.get("Scene").forEach((e=>e.notes.forEach((e=>{const s=e.entryId??e.data.entryId;a.id===s&&t.push(e)})))):a&&t.push(a))})),t.length)return t}return null}function p(e,t=!0){let s;e&&(s=Array.isArray(e)?e:[e]),s||(s=g(t)),s||(s=m()),s&&s.length>1&&null!=s[0].x&&null!=s[0].y&&s.sort(((e,t)=>{const s=e.y-t.y;return 0===s?e.x-t.x:s}));let i=h();return i=i?i[0]:i,!s&&i&&(s=[i]),!i&&s&&(i=s[0]),i||s?(i&&(0,o.Ng)(i)!==(0,o.Ng)(s[0])&&(i=s[0]),[i,s]):[null,null]}function f(e){let[t,s]=p(e);if(!t)return void(0,a.R)();const n=(0,o.Ng)(t),r={commonData:foundry.utils.flattenObject((0,o.bQ)(t).toObject()),massSelect:!0,documentName:n};if(i.Dn.includes(n)&&"Actor"!==n){new((0,l.dN)(n))(t,s,r).render(!0,{})}else i.lv.includes(n)&&new c.s(s,r).render(!0)}async function y(e=null,t,s={}){let[a,n]=p(e);if(n&&n.length){if(s.forceForm||!game.settings.get(i.Do,"singleDocDefaultConfig")||1!==n.length){if(t||(t=(0,o.Ng)(a)),s={...s,massEdit:!0,documentName:t},i.Dn.includes(t)){"Actor"===t&&(a=a.prototypeToken,n=n.map((e=>e.prototypeToken)),s.documentName="Token");return new((0,l.dN)(s.documentName))(a,n,s).render(!0,{})}return new c.s(n,s).render(!0)}n[0].sheet&&n[0].sheet.render(!0,{})}}function b(e,t){const s=[],i=[];return e.forEach((e=>{e.actor&&(s.push(e),i.push(e.actor))})),!!i.length&&(new c.s(i,{tokens:s,documentName:"Actor",...t}).render(!0),!0)}function v(){let e;if(e||(e=g()),e||(e=m()),e||(e=h()),e)return(0,r.B0)(e,null,!1,!0);{let e=canvas.activeLayer.constructor.documentName;const t=(0,r.bE)(e);if(t)return n.af.spawnPreset({preset:t}),!0}return!1}function k(e,t="GenericData",s){return new Promise((i=>{new c.s(Array.isArray(e)?e:[e],{documentName:t,callback:()=>i(),...s}).render(!0)}))}function w(){return Object.values(ui.windows).find((e=>null!=e.meObjects))??Array.from(foundry.applications.instances.values()).find((e=>null!=e.meObjects))}},241:(e,t,s)=>{s.d(t,{Oy:()=>h,Xt:()=>m,Yv:()=>u,_8:()=>BrushMenu,vM:()=>Brush});var i=s(439),a=s(596),n=s(269),o=s(971),r=s(652),l=s(671),c=s(465),d=s(120);class Brush{static app;static deactivateCallback;static spawner;static eraser;static lastSpawnTime;static preset;static brushOverlay;static updatedPlaceables=new Map;static hoveredPlaceables=new Set;static spawnPoints=[];static hoveredPlaceable;static documentName;static active=!1;static hitTest;static _checkDensity(e){const t=canvas.grid.size*this.spawnDensity;return this.spawnPoints.every((s=>Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2)>=t))}static _performBrushDocumentUpdate(e){this.preset.callPostSpawnHooks({objects:[e],documents:[e.document]}),this.preset.isEmpty||(0,i.B0)([e],this.preset,!0,!0,this.transform),this.updatedPlaceables.set(e.id,e),BrushMenu.iterate()}static _performBrushDocumentCreate(e){const t=(new Date).getTime();if(!this.lastSpawnTime||t-this.lastSpawnTime>100){if(this.lastSpawnTime=t,!this._checkDensity(e))return;o.Picker.resolve(e),this.spawnPoints.push(e),BrushMenu.iterate()}}static _performBrushDocumentDelete(e){this.hoveredPlaceable=null,e._brushDelete||e.document?.delete(),e._brushDelete=!0}static _hitTestWall(e,t){return t.line.hitArea.contains(e.x,e.y)}static _hitTestRegion(e,t){return t.bounds.contains(e.x,e.y)}static _hitTestControlIcon(e,t){return Number.between(e.x,t.x-t.controlIcon.width/2,t.x+t.controlIcon.width/2)&&Number.between(e.y,t.y-t.controlIcon.height/2,t.y+t.controlIcon.height/2)}static _hitTestTile(e,t){const s=ui.controls.control.foreground??!1;if(t.document.hasOwnProperty("elevation")){if(t.document.elevation&&!s)return!1}else if(t.document.overhead!==s)return!1;return t.bounds.contains(e.x,e.y)}static _hoverTestArea(e){if(!this.hoveredPlaceable)return!1;const t=this.hoveredPlaceable.bounds,s=e.bounds;return t.width*t.height>s.width*s.height}static _hitTestArea(e,t){return Number.between(e.x,t.x,t.x+t.hitArea.width)&&Number.between(e.y,t.y,t.y+t.hitArea.height)}static _onBrushMove(e){const t=e.data.getLocalPosition(this.brushOverlay),s=canvas.getLayerByEmbeddedName(this.documentName);this._clearHover(e,t);for(const i of s.placeables)i.visible&&this.hitTest(t,i)&&!this.updatedPlaceables.has(i.id)&&this.hoveredPlaceable!==i&&(this.hoverTest?.(i)||!this.hoverTest&&this.hoveredPlaceable&&this.hoveredPlaceable!==i?(this.hoveredPlaceable._onHoverOut(e),this.hoveredPlaceable=i):this.hoveredPlaceable||(this.hoveredPlaceable=i),this.hoveredPlaceable._onHoverIn(e))}static _clearHover(e,t,s=!1){this.hoveredPlaceable&&(!s&&this.hoveredPlaceable.visible&&this.hitTest(t,this.hoveredPlaceable)||(this.hoveredPlaceable._onHoverOut(e),this.hoveredPlaceable=null))}static _onBrushClickMove(e){this.spawner?this._performBrushDocumentCreate(e.data.getLocalPosition(this.brushOverlay)):this.hoveredPlaceable&&this.hoveredPlaceable.visible&&!this.updatedPlaceables.has(this.hoveredPlaceable.id)&&(this.eraser?this._performBrushDocumentDelete(this.hoveredPlaceable):this._performBrushDocumentUpdate(this.hoveredPlaceable))}static _on3DBrushClick({x:e,y:t,z:s,placeable:i}={}){this.spawner?this._performBrushDocumentCreate({x:e,y:t,z:s}):(i&&i.document.documentName===this.documentName&&(this.eraser?this._performBrushDocumentDelete(i):this._performBrushDocumentUpdate(i)),this.updatedPlaceables.clear())}static refreshPreset(){this.active&&this.app&&(this.preset=new l.k({documentName:this.documentName,data:this.app.getSelectedFields(),randomize:this.app.randomizeFields,addSubtract:this.app.addSubtractFields}))}static async genPreview(){r.af.spawnPreset({preset:this.preset,coordPicker:!0,previewOnly:!0,center:!0,taPreview:"ALL",transform:this.transform,snapToGrid:this.snap,scaleToGrid:this.scaleToGrid})}static activate({app:e=null,preset:t=null,deactivateCallback:s=null,spawner:i=!1,spawnDensity:n=.01,eraser:r=!1,refresh:l=!1,transform:c={},snap:d=!0,scaleToGrid:u=!0}={}){if(this.deactivate(l),!canvas.ready)return!1;if(!e&&!t)return!1;this.brushOverlay&&this.brushOverlay.destroy(!0),this.app=e,this.preset=t,this.transform=c,this.deactivateCallback=s,this.spawner=i,this.eraser=r,this.snap=d,this.spawnDensity=n,this.scaleToGrid=u,this.app?this.documentName=this.app.documentName:this.documentName=this.preset.documentName,l||(this.updatedPlaceables.clear(),this.spawnPoints=[]);const m=canvas.app.renderer.events;if(m.cursorStyles.brush||(m.cursorStyles.brush=`url('modules/${a.Do}/images/brush_icon.png'), auto`,m.cursorStyles.brush_spawn=`url('modules/${a.Do}/images/brush_icon_spawn.png'), auto`,m.cursorStyles.eraser=`url('modules/${a.Do}/images/brush_icon_eraser.png'), auto`),this.active=!0,this.refreshPreset(),game.Levels3DPreview?._active)return this.spawner&&this.genPreview(),this._activate3d();if(this.spawner)this.hitTest=()=>!1,this.genPreview();else switch(this.documentName){case"Wall":this.hitTest=this._hitTestWall;break;case"Region":this.hitTest=this._hitTestRegion;break;case"AmbientLight":case"MeasuredTemplate":case"AmbientSound":case"Note":this.hitTest=this._hitTestControlIcon;break;case"Tile":this.hitTest=this._hitTestTile,this.hoverTest=this._hoverTestArea;break;default:this.hitTest=this._hitTestArea,this.hoverTest=this._hoverTestArea}this.brushOverlay=new PIXI.Container,this.brushOverlay.hitArea=canvas.dimensions.rect;let h="brush";return i?h="brush_spawn":r&&(h="eraser"),this.brushOverlay.cursor=h,this.brushOverlay.interactive=!0,this.brushOverlay.zIndex=1/0,this.brushOverlay.on("mousemove",(e=>{o.Picker.feedPos(e.data.getLocalPosition(this.brushOverlay)),this._onBrushMove(e),this.mDownWithinCanvas&&1===e.buttons&&this._onBrushClickMove(e)})),this.brushOverlay.on("mouseup",(e=>{this.mDownWithinCanvas=!1,2!==e.nativeEvent.which&&this._onBrushClickMove(e),this.updatedPlaceables.clear(),this.spawnPoints=[]})),this.brushOverlay.on("mousedown",(e=>{this.mDownWithinCanvas=!0})),this.brushOverlay.on("click",(e=>{2==e.nativeEvent.which&&this.deactivate()})),canvas.stage.addChild(this.brushOverlay),canvas.mouseInteractionManager.permissions.clickLeft=!1,!0}static _activate3d(){return n.$.activate({mouseMoveCallback:o.Picker.feedPos.bind(o.Picker),mouseClickCallback:this._on3DBrushClick.bind(this),mouseWheelClickCallback:this.deactivate.bind(this)}),!0}static deactivate(e=!1){if(this.active)return canvas.mouseInteractionManager.permissions.clickLeft=!0,this.brushOverlay&&this.brushOverlay.parent?.removeChild(this.brushOverlay),this.active=!1,e||(this.updatedPlaceables.clear(),this.spawnPoints=[],this._clearHover(null,null,!0)),this.hoverTest=null,e||this.deactivateCallback?.(),this.spawner&&o.Picker.destroy(),this.spawner=!1,this.eraser=!1,this.deactivateCallback=null,this.app=null,this.preset=null,this.transform=null,!0;n.$.deactivate()}}class BrushMenu extends FormApplication{static addPresets(e=[]){if(!this._instance)return this.render(e);this._instance.addPresets(e)}static isActive(){return Boolean(this._instance)}static removePreset(e){this._instance&&this._instance.removePreset(e)}static iterate(e=!0,t=!1){this._instance&&this._instance.iterate(e,t)}static render(e,t={}){this._instance?this.addPresets(e):(this._instance=new BrushMenu(e,t),this._instance.render(!0))}static async close(){return this._instance?.close(!0)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-brush-menu",template:`modules/${a.Do}/templates/preset/brush/menu.html`,classes:["mass-edit-dark-window","mass-edit-window-fill"],resizable:!1,minimizable:!1,width:200,height:"auto",scrollY:[".presets"]})}constructor(e,t={}){super({},{left:10,top:window.innerHeight/2}),this.presets=e??[],this.preset=this.presets[0].clone(),this.preset.data=this.preset.data[0],this._settings=foundry.utils.mergeObject(game.settings.get(a.Do,"brush"),t),this._it=-1,this._createIndex(),this.iterate()}_createIndex(){const e=[];if(this._settings.group)for(let t=0;t<this.presets.length;t++)e.push({pI:t});else for(let t=0;t<this.presets.length;t++){const s=this.presets[t];for(let i=0;i<s.data.length;i++)e.push({pI:t,dI:i})}this._index=e,this._it>=this._index.length&&(this._it=this._index.length-1)}async _activateBrush(e=!0){const t=this._index[this._it],s=this.presets[t.pI];this.preset=s.clone(),t.hasOwnProperty("dI")&&(this.preset.data=[this.preset.data[t.dI]]),await this._applyColor(),this._applyTmfxPresets(this.preset,this._settings.tmfxPreset),this._applyTaggerTags(this.preset,this._settings.tagger),Brush.activate({preset:this.preset,deactivateCallback:this._deactivateCallback.bind(this),spawner:this._settings.spawner,eraser:this._settings.eraser,transform:this._getTransform(),refresh:e,snap:this._settings.snap,scaleToGrid:this._settings.scaleToGrid,spawnDensity:this._settings.density})}async _applyColor(){if(this._settings.randomColor||this._settings.color){let e;const t=this.preset.documentName;if("Token"===t||"Tile"===t?e="texture.tint":"AmbientLight"===t&&(e="config.color"),game.Levels3DPreview?._active&&("Token"!==t&&"Tile"!==t||(e="flags.levels-3d-preview.color")),e)if(this._settings.randomColor){const t=this.preset.data.map((()=>({color:""})));await(0,c.of)(t,null,{color:{type:"color",...this._settings.randomColor}}),this.preset.data.forEach(((s,i)=>{this._settings.ddTint?this._applyDDTint(s,t[i].color):foundry.utils.setProperty(s,e,t[i].color)}))}else this.preset.data.forEach((t=>{this._settings.ddTint?this._applyDDTint(t,this._settings.color):foundry.utils.setProperty(t,e,this._settings.color)}))}}_applyDDTint(e,t){let s=foundry.utils.getProperty(e,"flags.tokenmagic.filters");t?(s=(s??[]).filter((e=>"DDTint"!==e.tmFilters.filterId)),s.push({tmFilters:{tmFilterId:"DDTint",tmFilterInternalId:randomID(),tmFilterType:"ddTint",filterOwner:game.data.userId,tmParams:{tmFilterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t),updateId:randomID(),rank:1e4,enabled:!0,filterOwner:game.data.userId}}}),foundry.utils.setProperty(e,"flags.tokenmagic.filters",s)):s&&foundry.utils.setProperty(e,"flags.tokenmagic.filters",s.filter((e=>"DDTint"!==e.tmFilters.filterId)))}_applyTaggerTags(e,t){t&&t.length&&game.modules.get("tagger")?.active&&e.addPostSpawnHook((({objects:e}={})=>{Tagger.addTags(e,t)}))}_applyTmfxPresets(e,t){if(!t)return;if(!game.modules.get("tokenmagic")?.active)return;if(!["Token","Tile","Drawing","MeasuredTemplate"].includes(e.documentName))return;if(Array.isArray(t)||(t=[t]),t.includes("DELETE ALL"))return void this.preset.addPostSpawnHook((({objects:e}={})=>e.forEach((e=>TokenMagic.deleteFilters(e)))));if(t.includes("DELETE"))return void this.preset.addPostSpawnHook((({objects:e}={})=>e.forEach((async e=>{for(const s of t)await TokenMagic.deleteFilters(e,s)}))));const s=[];t.forEach((e=>TokenMagic.getPreset(e)?.forEach((e=>s.push(e))))),s.length&&this.preset.addPostSpawnHook((({objects:e}={})=>e.forEach((e=>TokenMagic.addUpdateFilters(e,s)))))}get title(){return"Brush"}async getData(e={}){return{presets:this.presets,activePreset:this.preset,...this._settings,tmfxActive:game.modules.get("tokenmagic")?.active,taggerActive:game.modules.get("tagger")?.active}}activateListeners(e){super.activateListeners(e);const t=this._settings,i=this;s.e(470).then(s.t.bind(s,470,23)).then((s=>{const a=e.find(".rotation-range-label");e.find(".rotation-slider").slider({range:!0,min:-180,max:180,values:t.rotation,slide:function(e,t){a.text(`${t.values[0]}° - ${t.values[1]}°`)},change:function(e,t){i._updateBrushSettings({rotation:t.values})}});const n=e.find(".scale-range-label");e.find(".scale-slider").slider({range:!0,min:.1,max:4,step:.01,values:t.scale,slide:function(e,t){n.text(`${t.values[0]} - ${t.values[1]}`)},change:function(e,t){i._updateBrushSettings({scale:t.values})}});const o=e.find(".density-range-label");e.find(".density-slider").slider({range:!1,min:.01,max:4,step:.01,value:t.density??.01,slide:function(e,t){o.text(`${t.value}`)},change:function(e,t){i._updateBrushSettings({density:t.value})}}),this.setPosition({height:"auto"})})),e.on("click",".toggle-button",this._toggleSetting.bind(this)),e.find(".reset").on("click",this._resetToDefaults.bind(this)),e.on("click",".preset",this._onClickPreset.bind(this)),e.on("contextmenu",".preset",this._onRightClickPreset.bind(this)),e.on("click",".randomize-color",this._onRandomizeColor.bind(this)),e.on("change","color-picker",this._onColorChange.bind(this)),e.on("input paste",'color-picker input[type="text"]',this._onColorChange.bind(this)),e.find(".colorizeControl").on("click",this._onColorMenu.bind(this)),e.find(".tmfxPresetControl").on("click",(()=>{this._onEditTaglikeField({label:"TMFX",name:"tmfxPreset",tags:this._settings.tmfxPreset,simplifyTags:!1,listId:"tmfxPresets",listEntries:TokenMagic.getPresets().map((e=>e.name))})})),e.find(".taggerControl").on("click",(()=>{this._onEditTaglikeField({label:"Tagger",name:"tagger",tags:this._settings.tagger,simplifyTags:!1})}))}async _onEditTaglikeField({label:e,name:t,tags:s,simplifyTags:i=!0,listId:a,listEntries:n}={}){const o=this._toggleSubMenu(t);if(!o)return;s&&!Array.isArray(s)&&(s=[s]);let r=Handlebars.compile("{{tagInput name=name label=label tags=tags listId=listId listEntries=listEntries}}")({name:t,label:e,tags:s,listId:a,listEntries:n},{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0});o.html(r),this.setPosition({height:"auto"}),d.Fo.activateListeners(o,{change:e=>{this.setPosition({height:"auto"}),this._updateBrushSettings({[t]:e.length?e:null})},simplifyTags:i})}_toggleSubMenu(e){const t=this.element.find(".sub-menu");return t.attr("data-control")===e?(t.html("").attr("data-control",null),this.setPosition({height:"auto"}),null):(t.attr("data-control",e),t)}async _onColorMenu(e){const t=this._toggleSubMenu("colorize");if(!t)return;let s=(await getTemplate(`modules/${a.Do}/templates/preset/brush/colorize.html`))(await this.getData({}),{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0});t.html(s),this.setPosition({height:"auto"})}async _onColorChange(e){let t=$(e.currentTarget).val();if(t){let e=Color.fromString(t);Number.isNaN(e.valueOf())||this._updateBrushSettings({color:t})}else this._updateBrushSettings({color:""})}async _onClickPreset(e){const t=$(e.currentTarget).data("index");null!=t&&(this._it=this._index.findIndex((e=>e.pI===t)),await this._activateBrush(),this.render(!0))}async _onRandomizeColor(){const e=this._settings.randomColor??{},t=await renderTemplate(`modules/${a.Do}/templates/randomizer/color.html`,{method:"random",lockMethod:!0,space:e.space,hue:e.hue});let i,n=new Dialog({title:"Pick Range",content:`<form>${t}</form>`,buttons:{save:{label:"Apply",callback:async e=>{await this._updateBrushSettings({randomColor:{method:"random",space:e.find('[name="space"]').val(),hue:e.find('[name="hue"]').val(),colors:i.getColors()}}),this.render(!0)}},remove:{label:"Remove",callback:async e=>{await this._updateBrushSettings({randomColor:null}),this.render(!0)}}},render:t=>{Promise.all([s.e(646),s.e(470),s.e(236)]).then(s.bind(s,236)).then((s=>{i=new s.ColorSlider(t,e.colors??[{hex:"#ff0000",offset:0},{hex:"#ff0000",offset:100}]),setTimeout((()=>n.setPosition({height:"auto"})),100)}))}});n.render(!0)}async _onRightClickPreset(e){const t=$(e.currentTarget).data("index"),s=this.presets[t];s&&this.removePreset(s.id)}async _resetToDefaults(){await this._updateBrushSettings({scale:[1,1],rotation:[0,0],density:1,color:null,randomColor:null,tmfxPreset:null,tagger:null}),this.render(!0)}async _toggleSetting(e){const t=$(e.target).closest(".toggle-button"),s={[t.data("name")]:!t.hasClass("active")};s.spawner&&(s.eraser=!1),s.eraser&&(s.spawner=!1),await this._updateBrushSettings(s),s.random?await this.iterate():this.render(!0)}async _updateBrushSettings(e){foundry.utils.mergeObject(this._settings,e),await game.settings.set(a.Do,"brush",this._settings),e.hasOwnProperty("group")&&this._createIndex(),await this._activateBrush()}addPresets(e=[]){for(const t of e)this.presets.find((e=>e.uuid===t.uuid))||this.presets.push(t);this._createIndex(),this.render(!0)}removePreset(e){const t=this.presets.findIndex((t=>t.id===e));if(-1===t)return;const s=this._index[this._it]?.pI===t;if(this.presets=this.presets.filter((t=>t.id!==e)),0===this.presets.length)return this.close(!0);this._createIndex(),s?this.iterate():this.render(!0)}async iterate(e=!0,t=!1){t||!this._settings.lock?this._settings.random?this._it=Math.floor(Math.random()*this._index.length):(this._it+=e?1:-1,this._it<0?this._it=this._index.length-1:this._it%=this._index.length):-1===this._it&&(this._it=0),await this._activateBrush(),this.render(!0)}_getTransform(){const e=this._settings,t={},s=o.Picker.getTransformAccumulator();if(e.scale[0]===e.scale[1])t.scale=e.scale[0],t.scale*=s.scale;else{const i=(e.scale[1]-e.scale[0])/.01;t.scale=.01*Math.floor(Math.random()*i)+e.scale[0],t.scale*=s.scale}if(e.rotation[0]===e.rotation[1])t.rotation=e.rotation[0],t.rotation+=s.rotation;else{const s=(e.rotation[1]-e.rotation[0]+1)/1;t.rotation=1*Math.floor(Math.random()*s)+e.rotation[0]}return t}_deactivateCallback(){this.close(!0)}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-brush-macro",icon:"fa-solid fa-code",onclick:this._generateBrushMacro.bind(this)}),e}async _generateBrushMacro(){const e=async function(e){(await Macro.create({name:"Brush Macro",type:"script",scope:"global",command:e,img:`modules/${a.Do}/images/brush_icon.png`})).sheet.render(!0)};new Dialog({title:"Generate Macro",content:"",buttons:{uuids:{label:"UUIDs",callback:function(){const t=this.presets.map((e=>e.uuid)).filter(Boolean);if(!t.length)return;const s=`MassEdit.openBrushMenu({ \n    uuid: ${JSON.stringify(t,null,4)}\n  },\n  ${JSON.stringify(this._settings,null,2)}\n  );`;e(s)}.bind(this)},name:{label:"Names",callback:function(){const t=this.presets.map((e=>({name:e.name,type:e.documentName}))),s=`MassEdit.openBrushMenu(\n    ${JSON.stringify(t,null,4)}\n  ,\n  ${JSON.stringify(this._settings,null,2)}\n  );`;e(s)}.bind(this)}}}).render(!0)}async close(e={}){return Brush.deactivate(),BrushMenu._instance=null,o.Picker.destroy(),o.Picker.resetTransformAccumulator(),super.close(e)}}async function u(e,t="spawner"){const s=await r.af.getPreset(e);s&&Brush.activate({preset:s,spawner:"spawner"===t})}function m(){Brush.deactivate()}async function h(e,t={}){if(BrushMenu.isActive())return BrushMenu.close();let s=[];if(Array.isArray(e))for(const t of e){let e=await r.af.getPreset(t);e&&s.push(e)}else s=await r.af.getPresets(e);if(s?.length){for(const e of s)await e.load();BrushMenu.render(s,t)}}},596:(e,t,s)=>{s.d(t,{Dn:()=>o,Do:()=>i,In:()=>d,Me:()=>a,SV:()=>m,TA:()=>n,Vf:()=>c,Y0:()=>u,f9:()=>l,lv:()=>r});const i="multi-token-edit",a=["Token","MeasuredTemplate","Tile","Drawing","Wall","AmbientLight","AmbientSound","Note"],n=["FAVORITES","ALL",...a],o=[...a,"Actor","PlaylistSound","Scene"],r=["Item","Cards","RollTable","Actor","JournalEntry","Scene"],l=["webp","jpg","jpeg","png","svg","apng","avif","bmp","gif","tif"],c=["mp4","ogv","webm","m4v"],d=["aac","flac","m4a","mid","mp3","ogg","opus","wav"],u=[...l,...c,...d],m={Token:"modules/multi-token-edit/images/linker/person-fill.svg",MeasuredTemplate:"modules/multi-token-edit/images/linker/rulers.svg",Tile:"modules/multi-token-edit/images/linker/boxes.svg",Drawing:"modules/multi-token-edit/images/linker/pencil-fill.svg",Wall:"modules/multi-token-edit/images/linker/bricks.svg",AmbientLight:"modules/multi-token-edit/images/linker/lightbulb-fill.svg",AmbientSound:"modules/multi-token-edit/images/linker/music-note-beamed.svg",Note:"modules/multi-token-edit/images/linker/bookmark-fill.svg",Region:"modules/multi-token-edit/images/linker/border-outer.svg"}},860:(e,t,s)=>{s.d(t,{R:()=>o,h:()=>r});var i=s(739),a=s(596),n=s(120);function o(){let e="";for(const t of a.Me.concat(a.lv))e+=`<option value="${t}">${t}</option>`;e=`<label>${(0,n.kg)("dialog.search-document")}</label>\n    <select style="width: 100%;" name="documentName">${e}</select>`,new Dialog({title:"Document SEARCH",content:e,buttons:{select:{icon:'<i class="fas fa-check"></i>',label:"Select",callback:e=>{const t=e.find("select[name='documentName']").val();let s=[];if(a.Me.includes(t)){const e=i.i2[t];e&&canvas[e].placeables.length&&(s=canvas[e].placeables)}else s=Array.from(game.collections.get(t));s.length?(0,i.G_)(s[0]):ui.notifications.warn((0,n.zS)("dialog.document-not-found",{document:t}))}}}}).render(!0)}async function r(){const e=`\n  <div class="form-group">\n      <label for="data">${(0,n.kg)("FILES.SelectFile",!1)} </label>\n      <input type="file" name="data">\n  </div>\n  `;let t=new Promise(((t,s)=>{new Dialog({title:(0,n.kg)("presets.import"),content:e,buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:(0,n.kg)("common.import"),callback:async e=>{let s;readTextFromFile(e.find('[name="data"]')[0].files[0]).then((e=>{try{s=JSON.parse(e)}catch(e){}t(s)}))}},no:{icon:'<i class="fas fa-times"></i>',label:(0,n.kg)("Cancel",!1),callback:()=>t(!1)}},default:"no"},{width:400}).render(!0)}));return await t}},638:(e,t,s)=>{s.d(t,{TT:()=>d,rm:()=>c,sy:()=>LinkerAPI});var i=s(971),a=s(118),n=s(120),o=s(575),r=s(596);const l=new Map,c={TWO_WAY:0,RECEIVE:1,SEND:2};function d(){r.Me.forEach((e=>{Hooks.on(`preUpdate${e}`,h),Hooks.on(`update${e}`,g)})),a.xH.register(r.Do,"PlaceablesLayer.prototype.undoHistory",(async function(e,...t){const s=this.history[this.history.length-1]?.type,i=await e(...t);if("delete"===s&&i?.length){const e=LinkerAPI.history.find((e=>i.find((t=>t.id===e.id))));e&&(e.data.forEach(((e,t)=>{canvas.scene.createEmbeddedDocuments(t,e,{isUndo:!0,keepId:!0})})),LinkerAPI.history=LinkerAPI.history.filter((e=>!i.find((t=>t.id===e.id)))))}return i}),"WRAPPER")}function u(e,t,s,a,n,o,l){r.Me.forEach((d=>{const m=a.getEmbeddedCollection(d).filter((e=>e.flags[r.Do]?.links?.some((e=>e.type<2&&s.find((t=>t.id===e.id))))&&e.id!==l));if(m.length){const s=[];for(const l of m){const m=l._source;let h=foundry.utils.deepClone(m);i.DataTransform.apply(d,h,t,e),h=foundry.utils.diffObject(m,h),h._id=l.id,s.push(h);const g=l.flags[r.Do].links.filter((e=>!(e.type===c.RECEIVE||o.has(e.id))));g.length&&(g.forEach((e=>o.add(e.id))),u(e,t,g,a,n,o,l.id))}n.set(d,(n.get(d)??[]).concat(s))}}))}const m=new class PromiseQueue{queue=Promise.resolve();add(e){this.queue=this.queue.then(e).catch((()=>{}))}};function h(e,t,s,i){if(game.user.id!==i||s.ignoreLinks)return!0;let a=e.flags[r.Do]?.links?.filter((e=>e.type!==c.RECEIVE));if(!a?.length)return!0;const n=t.hasOwnProperty("x")||t.hasOwnProperty("y")||t.hasOwnProperty("shapes")||t.hasOwnProperty("c")||t.hasOwnProperty("elevation"),o=t.hasOwnProperty("rotation")||s.hasOwnProperty("meRotation");if(!n&&!o)return!0;if(t.c&&(t.c[0]===e.c[0]&&t.c[1]===e.c[1]||t.c[2]===e.c[2]&&t.c[3]===e.c[3]))return!0;if(game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT))return!0;const d=l.get(s.modifiedTime);return d?(a=a.filter((e=>!d.some((t=>t.id===e.id)))),!!a.length&&(a.forEach((e=>d.push(e))),!1)):(l.set(s.modifiedTime,a),setTimeout((()=>l.delete(s.modifiedTime)),2e3),foundry.utils.setProperty(s,`links.${e.id}`,a),foundry.utils.setProperty(s,`linkSources.${e.id}`,e.toObject()),!0)}async function g(e,t,s,i){if(!s.links?.[e.id]||s.ignoreLinks||game.user.id!==i)return!0;const a=t.hasOwnProperty("x")||t.hasOwnProperty("y")||t.hasOwnProperty("shapes")||t.hasOwnProperty("c")||t.hasOwnProperty("elevation"),r=t.hasOwnProperty("rotation")||s.hasOwnProperty("meRotation");if(!a&&!r)return!0;const l=foundry.utils.deepClone(s.linkSources[e.id]);foundry.utils.mergeObject(s.linkSources[e.id],t);const c=e.parent,{transform:d,origin:h}=function(e,t,s,i,a){let n;if(i.hasOwnProperty("shapes")||i.hasOwnProperty("c"))if(a.hasOwnProperty("meRotation"))n={x:0,y:0};else{const i=(0,o.GD)(e,s),a=(0,o.GD)(e,t);n={x:a.x1-i.x1,y:a.y1-i.y1}}else n={x:t.x-s.x,y:t.y-s.y};const r={x:0,y:0};let l;a.hasOwnProperty("meRotation")?l=a.meRotation:t.hasOwnProperty("rotation")&&(l=(t.rotation-s.rotation)%360);if(null!=l){n.rotation=l;const{x1:t,y1:i,x2:a,y2:c}=(0,o.GD)(e,s);r.x=t+(a-t)/2,r.y=i+(c-i)/2}if(t.hasOwnProperty("elevation")){let e;e=Number.isNumeric(t.elevation)?t.elevation-s.elevation:(t.elevation.bottom??0)-(s.elevation.bottom??0),0!=e&&(n.z=e)}return{transform:n,origin:r}}(e.documentName,e.toObject(),l,t,s),g=s.links[e.id];m.add((async()=>{const t=new Map;u(d,h,g,c,t,new Set(g.map((e=>e.id))),e.id);for(const[e,s]of t.entries()){const t={ignoreLinks:!0,animate:!1};"Token"===e&&(t.RidingMovement=!0,t.forced=!0),await(0,n.C2)(e,s,t,c)}}))}class LinkerAPI{static async openMenu(){return(await Promise.all([s.e(518),s.e(894)]).then(s.bind(s,894))).openLinkerMenu()}static async smartLink({multiLayer:e=!1}={}){let t;if(t=e?await(0,n.rH)():this._getSelected().map((e=>e.document)),!t.length)return;if(!this._smartLink){let e;for(const s of t)if(e=(this.getLinks(s)??[]).find((e=>e.type===c.TWO_WAY)),e)break;e||(e={id:foundry.utils.randomID(),type:c.TWO_WAY,label:"S_LINK"}),this._smartLink=e;(await s.e(927).then(s.bind(s,927))).openSmartLinkMenu(t[0])}const{id:i,type:a,label:o}=this._smartLink;let r=0;for(const e of t)await this.addLink(e,i,a,o)&&r++;r&&ui.notifications.info(`Mass Edit: ${r} documents have been linked.`)}static getLinks(e){return e=e.document??e,e.flags[r.Do]?.links}static getLinkedDocuments(e){Array.isArray(e)||(e=[e]);const t=new Set;return e.forEach((e=>this._findLinked(e,t))),e.forEach((e=>t.delete(e))),t}static getHardLinkedDocuments(e){Array.isArray(e)||(e=[e]);const t=new Set;return e.forEach((e=>this._findHardLinked(e,t))),e.forEach((e=>t.delete(e))),t}static hasLink(e,t){const s=e.document??e;return Boolean(s.flags[r.Do]?.links?.find((e=>e.id===t)))}static async addLink(e,t,s=c.TWO_WAY,i=null){if(!Object.values(c).includes(s))throw Error(`Invalid link type: ${s}`);const a=e.document??e,n=a.flags[r.Do]?.links??[];let o=n.find((e=>e.id===t));if(o){if(!(o.type!==s||i&&o.label!==i))return!1;o.type=s,i&&(o.label=i)}else o={id:t,type:s},i&&(o.label=i),n.push(o);return a.setFlag(r.Do,"links",n),Hooks.call(`${r.Do}.addLink`,a.documentName,a.id,t,s,i),!0}static removeLink(e,t){const s=e.document??e;let i=s.flags[r.Do]?.links;i&&(i=i.filter((e=>e.id!==t)),i.length?s.setFlag(r.Do,"links",i):s.unsetFlag(r.Do,"links"),Hooks.call(`${r.Do}.removeLink`,s.id,t))}static removeLinks(e){const t=e.document??e;return!!t.flags[r.Do]?.links&&(t.unsetFlag(r.Do,"links"),Hooks.call(`${r.Do}.removeNode`,t.id),!0)}static async removeLinksFromSelected({multiLayer:e=!1,notification:t=!1}={}){let s;s=e?await(0,n.rH)():LinkerAPI._getSelected();let i=0;for(const e of s)LinkerAPI.removeLinks(e)&&i++;t&&i&&ui.notifications.info(`Mass Edit: Links removed from ${i} documents.`),Object.values(ui.windows).find((e=>e.unlink))?.unlink(s)}static history=[];static deleteSelectedLinkedPlaceables(){const e=LinkerAPI._getSelected().map((e=>e.document));if(!e.length)return;const t=LinkerAPI.getHardLinkedDocuments(e).filter((t=>!e.find((e=>e.id===t.id)))),s=new Map;t.forEach((e=>{s.get(e.documentName)?s.get(e.documentName).push(e.toObject()):s.set(e.documentName,[e.toObject()])}));const i=canvas.scene;s.forEach(((e,t)=>{i.deleteEmbeddedDocuments(t,e.map((e=>e._id)),{isUndo:!0})})),LinkerAPI.history.push({id:e[0].id,data:s}),LinkerAPI.history.length>10&&LinkerAPI.history.shift(),i.deleteEmbeddedDocuments(e[0].documentName,e.map((e=>e.id)))}static removeAllLinksOnCurrentScene(){const e=canvas.scene;e&&r.Me.forEach((t=>{const s=[];e.getEmbeddedCollection(t).forEach((e=>{e.flags[r.Do]?.links&&s.push({_id:e.id,[`flags.${r.Do}.-=links`]:null})})),s.length&&e.updateEmbeddedDocuments(t,s)}))}static updateLinkLabelOnCurrentScene(e,t){if(!e)return;const s=canvas.scene;if(!s)return;let i=!1;r.Me.forEach((a=>{const n=[];s.getEmbeddedCollection(a).forEach((s=>{const i=s.flags[r.Do]?.links?.find((t=>t.id===e));i&&i.label!=t&&(t?i.label=t:delete i.label,n.push({_id:s.id,[`flags.${r.Do}.links`]:s.flags[r.Do]?.links}))})),n.length&&(s.updateEmbeddedDocuments(a,n),i=!0)})),i&&Hooks.call(`${r.Do}.linkLabelChange`,e,t)}static removeLinkFromScene(e){const t=canvas.scene;t&&e&&(r.Me.forEach((s=>{const i=[];t.getEmbeddedCollection(s).forEach((t=>{let s=t.flags[r.Do]?.links;if(s){let a=s.filter((t=>t.id!==e));a.length!==s.length&&i.push({_id:t.id,[`flags.${r.Do}.links`]:a})}})),i.length&&t.updateEmbeddedDocuments(s,i)})),Hooks.call(`${r.Do}.removeNode`,e))}static _getSelected(){const e=canvas.activeLayer;return r.Me.includes(e.options.objectClass.embeddedName)?[...canvas.activeLayer.controlled]:[]}static _getLinkedDocumentsUsingLink(e,t=null){if(null!=t&&!Object.values(c).includes(t))throw Error(`Invalid link type: ${t}`);const s=new Set;return r.Me.forEach((i=>{canvas.scene.getEmbeddedCollection(i).forEach((i=>{i.flags[r.Do]?.links?.some((s=>s.id===e&&(null==t||s.type===t)))&&s.add(i)}))})),s}static _findLinked(e,t,s=new Set){t.add(e);const i=e.flags[r.Do]?.links?.filter((e=>!s.has(e.id))).map((e=>e.id));return i?.length?(i.forEach((e=>s.add(e))),r.Me.forEach((e=>{const a=canvas.scene.getEmbeddedCollection(e).filter((e=>e.flags[r.Do]?.links?.some((e=>i.find((t=>t===e.id))))));for(const e of a)this._findLinked(e,t,s)})),t):t}static _findHardLinked(e,t,s=new Set){t.add(e);const i=e.flags[r.Do]?.links?.filter((e=>e.type!==c.RECEIVE&&!s.has(e.id))).map((e=>e.id));return i?.length?(i.forEach((e=>s.add(e))),r.Me.forEach((e=>{const a=canvas.scene.getEmbeddedCollection(e).filter((e=>e.flags[r.Do]?.links?.some((e=>i.find((t=>t===e.id&&e.type!==c.SEND))))));for(const e of a)this._findHardLinked(e,t,s)})),t):t}static _highlightDocuments(e){const t=canvas.controls.debug;t.clear();e.forEach((e=>{let s=e.object.bounds;t.lineStyle(10,0,1,.5),t.drawRect(s.x,s.y,s.width,s.height),t.lineStyle(8,65280,1,.5),t.drawRect(s.x,s.y,s.width,s.height)}))}static _clearHighlight(){canvas.controls.debug.clear()}}},269:(e,t,s)=>{s.d(t,{$:()=>Mouse3D});var i=s(241),a=s(971);class Mouse3D{static{this._boundOn3DMouseDown=this._on3DMouseDown.bind(this),this._boundOn3dMouseMove=this._on3dMouseMove.bind(this),this._boundOn3dMouseWheel=this._on3dMouseWheel.bind(this)}static activate({mouseMoveCallback:e=null,mouseClickCallback:t=null,mouseWheelClickCallback:s=null}={}){this.mouseMoveCallback=e,this.mouseClickCallback=t,this.mouseWheelClickCallback=s,this._createTracker(),this._activate3DListeners()}static deactivate(){this.tracker&&game.Levels3DPreview?._active&&(game.Levels3DPreview.scene.remove(this.tracker),this.tracker=null,this.deactivate3DListeners())}static _createTracker(){if(!this.tracker){const e=game.Levels3DPreview.THREE;this.tracker=new e.Mesh(new e.SphereGeometry(.01,8,8),new e.MeshBasicMaterial({opacity:.5,transparent:!0,color:65280,wireframe:!0})),this.tracker.userData.interactive=!1,this.tracker.userData.ignoreHover=!0;const t=game.Levels3DPreview.interactionManager.canvas3dMousePosition;this.tracker.position.set(t.x,t.y,t.z),game.Levels3DPreview.scene.add(this.tracker)}}static _activate3DListeners(){this.deactivate3DListeners(),game.Levels3DPreview.renderer.domElement.addEventListener("mousedown",this._boundOn3DMouseDown,!1),game.Levels3DPreview.renderer.domElement.addEventListener("mousemove",this._boundOn3dMouseMove,!1),game.Levels3DPreview.renderer.domElement.addEventListener("wheel",this._boundOn3dMouseWheel,!0)}static deactivate3DListeners(){game.Levels3DPreview.renderer.domElement.removeEventListener("mousedown",this._boundOn3DMouseDown,!1),game.Levels3DPreview.renderer.domElement.removeEventListener("mousemove",this._boundOn3dMouseMove,!1),game.Levels3DPreview.renderer.domElement.removeEventListener("wheel",this._boundOn3dMouseWheel,!0)}static _on3DMouseDown(e){if(1===e.which){const e=game.Levels3DPreview.ruler.constructor.pos3DToCanvas(this.tracker.position),t=game.Levels3DPreview.interactionManager.currentHover?.placeable;this.mouseClickCallback?.({x:e.x,y:e.y,z:e.z,placeable:t})}else 2===e.which&&this.mouseWheelClickCallback?.()}static _on3dMouseMove(){this.delayMoveTimer||(this.delayMoveTimer=setTimeout((function(){const e=game.Levels3DPreview.interactionManager.canvas3dMousePosition,t=game.Levels3DPreview.interactionManager.camera.position,s=game.Levels3DPreview.interactionManager.computeSightCollisionFrom3DPositions(t,e,"collision",!1,!1,!1,!0);if(s[0]){const e=s[0];Mouse3D.tracker?.position.set(e.point.x,e.point.y,e.point.z);const t=game.Levels3DPreview.ruler.constructor.pos3DToCanvas(e.point);Mouse3D.mouseMoveCallback?.({x:t.x,y:t.y,z:t.z})}Mouse3D.delayMoveTimer=null}),100))}static _on3dMouseWheel(e){if(!a.Picker.isActive()&&!i._8.isActive()||!(e.ctrlKey||e.shiftKey||e.metaKey||e.altKey))return!1;{e.stopPropagation(),e.preventDefault();let t=e.delta=e.deltaY;if(e.shiftKey&&0===t&&(t=e.delta=e.deltaX),0===t)return;e.altKey?a.Picker.addScaling(e.delta<0?.05:-.05):(e.ctrlKey||e.metaKey)&&e.shiftKey?i._8.iterate(e.delta>=0,!0):e.ctrlKey||e.metaKey?a.Picker.addRotation(e.delta<0?2.5:-2.5):e.shiftKey&&a.Picker.addRotation(e.delta<0?15:-15)}}}},971:(e,t,s)=>{s.r(t),s.d(t,{DataTransform:()=>DataTransform,Picker:()=>Picker,editPreviewPlaceables:()=>l});var i=s(596),a=s(638),n=s(269),o=s(575),r=s(120);class Picker{static pickerOverlay;static boundStart;static boundEnd;static callback;static _transformAccumulator={rotation:0,scale:1};static isActive(){return Boolean(this.pickerOverlay)}static addRotation(e){this._rotation+=e,this.pickerOverlay?.setPositions?.(canvas.mousePosition),this._transformAccumulator.rotation+=e}static addScaling(e){this._scale+=e,this._transformAccumulator.scale*=this._scale,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static resetTransformAccumulator(){this._transformAccumulator.rotation=0,this._transformAccumulator.scale=1}static getTransformAccumulator(){return foundry.utils.deepClone(this._transformAccumulator)}static mirrorX(){this._mirrorX=!0,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static mirrorY(){this._mirrorY=!0,this.pickerOverlay?.setPositions?.(canvas.mousePosition)}static async activate(e,t){this.destroy();const s=new PIXI.Container;if(this.callback=e,t){let e;t.label&&(e=new PreciseText(t.label,{...CONFIG.canvasTextStyle,_fontSize:24}),e.anchor.set(.5,1),s.addChild(e));let{previews:i,layer:a,previewDocuments:n}=await this._genPreviews(t);this._rotation=t.rotation??0,this._scale=t.scale??1,this._mirrorX=!1,this._mirrorY=!1;const r=()=>t.center&&!("TokenLayer"===a.name&&1===t.previewData.size);let l;l=r()?(0,o.Ym)(t.previewData):{x:0,y:0,z:0},game.Levels3DPreview?._active||delete l.z;const c=function(d){if(!d)return;if(r()&&(l=(0,o.Ym)(t.previewData)),t.snap&&a&&!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)){const e=a.getSnappedPoint(d);e.z=d.z,d=e}const u=i[0].document,m=(0,o.GD)(u.documentName,u);let h={x:d.x-m.x1-l.x,y:d.y-m.y1-l.y};null!=d.z&&(h.z=d.z-m.z1-l.z),0!=Picker._rotation&&(h.rotation=Picker._rotation,Picker._rotation=0),1!=Picker._scale&&(h.scale=Picker._scale,Picker._scale=1),h.mirrorX=Picker._mirrorX,Picker._mirrorX=!1,h.mirrorY=Picker._mirrorY,Picker._mirrorY=!1;for(const e of i){const t=e.document,s=t.documentName;DataTransform.apply(s,e._pData??t,d,h,e),e.renderFlags.set({refresh:!0}),null!=t.sort&&(e._meSort||(e._meSort=t.sort),t.sort=e._meSort+1e4),game.Levels3DPreview?._active||null==t.elevation||(e._meElevation||(e._meElevation=t.elevation),t.elevation=e._meElevation+1e4),e._l3dPreview&&(e._l3dPreview.collision=!1),"Region"===s?e._onUpdate({shapes:null}):"AmbientLight"===s?e.initializeLightSource():"AmbientSound"===s&&e.initializeSoundSource()}e&&(e.x=d.x,e.y=d.y-38),s.previewDocuments=n,t.center&&null!=h.scale&&c(d)};let d=1/0,u=1/0;s.on("pointermove",(e=>{const t=e.data.client;t.x===d&&t.y===u||(d=t.x,u=t.y,c(e.data.getLocalPosition(s)))})),s.setPositions=c}t?.previewOnly||(game.Levels3DPreview?._active?n.$.activate({mouseMoveCallback:Picker.feedPos.bind(Picker),mouseClickCallback:Picker.resolve.bind(Picker),mouseWheelClickCallback:Picker.destroy.bind(Picker)}):(s.hitArea=canvas.dimensions.rect,s.cursor="crosshair",s.interactive=!0,s.zIndex=5,s.on("remove",(()=>s.off("pick"))),s.on("mousedown",(e=>{Picker.boundStart=e.data.getLocalPosition(s)})),s.on("mouseup",(e=>{Picker.boundEnd=e.data.getLocalPosition(s)})),s.on("click",(e=>{if(2==e.nativeEvent.which)this.callback?.(null);else{const e=Math.min(this.boundStart.x,this.boundEnd.x),t=Math.max(this.boundStart.x,this.boundEnd.x),s=Math.min(this.boundStart.y,this.boundEnd.y),i=Math.max(this.boundStart.y,this.boundEnd.y);this.callback?.({start:{x:e,y:s},end:{x:t,y:i}})}this.destroy()})),canvas.stage.addChild(s))),this.pickerOverlay=s,setTimeout((()=>this.feedPos(canvas.mousePosition)),100)}static feedPos(e){this.pickerOverlay?.setPositions?.(e)}static resolve(e){this.callback&&(null==e?this.callback(null):this.callback?.({start:{x:e.x,y:e.y,z:e.z},end:{x:e.x,y:e.y,z:e.z}})),this.destroy()}static destroy(){this.pickerOverlay&&(this.pickerOverlay.parent?.removeChild(this.pickerOverlay),this.pickerOverlay.previewDocuments&&this.pickerOverlay.previewDocuments.forEach((e=>{const t=canvas.getLayerByEmbeddedName(e);t&&(game.Levels3DPreview?._active&&t.preview.children.forEach((e=>{e._l3dPreview?.destroy()})),t.clearPreviewContainer())})),this.pickerOverlay.destroy(!0),this.pickerOverlay.children?.forEach((e=>e.destroy(!0))),this.callback?.(null),this.pickerOverlay=null,n.$.deactivate()),this.callback=null}static async _createPreview(e){const t=this.constructor.documentName,s=getDocumentClass(t);e._id=foundry.utils.randomID();const i=new s(e,{parent:canvas.scene}),a=new CONFIG[t].objectClass(i);if(i._object=a,a.eventMode="none",a.document.alpha=.4,a.document.occlusion&&(a.document.occlusion.alpha=.4),this.preview.addChild(a),await a.draw(),a.tooltip&&(a.tooltip.renderable=!1),a.controlIcon?.tooltip&&(a.controlIcon.tooltip.renderable=!1),Picker._overridePlaceableVisibility(a),game.Levels3DPreview?._active)if("Tile"===t){game.Levels3DPreview.createTile(a);const e=game.Levels3DPreview.tiles[a.id];e.castShadow=!1,e.collision=!1,a._l3dPreview=e}else if("Token"===t)game.Levels3DPreview.addToken(a),a._l3dPreview=null;else if("AmbientLight"===t){game.Levels3DPreview.addLight(a);const e=game.Levels3DPreview.lights[a.id];a._l3dPreview=e}return a}static _overridePlaceableVisibility(e){Object.defineProperty(e,"isVisible",{get:function(){return!0},set:function(){}}),Object.defineProperty(e,"visible",{get:function(){return!0},set:function(){}}),e.controlIcon&&(e.controlIcon.alpha=.4,Object.defineProperty(e.controlIcon,"visible",{get:function(){return!0},set:function(){}}))}static async _genPreviews(e){if(!e.previewData)return{previews:[]};const t={},s=[];for(const[i,a]of e.previewData.entries())for(const n of a){if(null==t.x)if("Wall"===i)t.x=-n.c?.[0]??0,t.y=-n.c?.[1]??0;else if("Region"===i){const e=n.shapes[0];t.x=-(e?.x??e.points?.[0]??0),t.y=-(e?.y??e.points?.[1]??0)}else t.x=-n.x??0,t.y=-n.y??0;s.push({documentName:i,data:n}),e.taPreview&&"Token"===i&&this._genTAPreviews(n,e.taPreview,n,s)}const i=new Set,a=[];for(const{documentName:e,data:n}of s){DataTransform.apply(e,n,{x:0,y:0},t);const s=await this._createPreview.call(canvas.getLayerByEmbeddedName(e),foundry.utils.deepClone(n));s._pData=n,a.push(s),i.add(e)}return{previews:a,layer:canvas.getLayerByEmbeddedName(e.documentName),previewDocuments:i}}static _genTAPreviews(e,t,s,i){if(!game.modules.get("token-attacher")?.active)return;const a=foundry.utils.getProperty(e,"flags.token-attacher.prototypeAttached"),n=foundry.utils.getProperty(e,"flags.token-attacher.pos"),o=foundry.utils.getProperty(e,"flags.token-attacher.grid");if(!(a&&n&&o))return;const r=canvas.grid.size/o.size,l=this._parseTAPreview(t,a);for(const[e,t]of Object.entries(l))for(let a of t)["Token","Tile","Drawing"].includes(e)&&(a.width*=r,a.height*=r),"Wall"===e?(a.c[0]=s.x+(a.c[0]-n.xy.x)*r,a.c[1]=s.y+(a.c[1]-n.xy.y)*r,a.c[2]=s.x+(a.c[2]-n.xy.x)*r,a.c[3]=s.y+(a.c[3]-n.xy.y)*r):"Region"===e?a.shapes?.forEach((e=>{if("polygon"===e.type)for(let t=0;t<e.points.length;t+=2)e.points[t]=s.x+(e.points[t]-n.xy.x)*r,e.points[t+1]=s.y+(e.points[t+1]-n.xy.y)*r;else e.x=s.x+(e.x-n.xy.x)*r,e.y=s.y+(e.y-n.xy.y)*r,"ellipse"===e.type?(e.radiusX*=r,e.radiusY*=r):"rectangle"===e.type&&(e.width*=r,e.height*=r)})):(a.x=s.x+(a.x-n.xy.x)*r,a.y=s.y+(a.y-n.xy.y)*r),i.push({documentName:e,data:a})}static _parseTAPreview(e,t){if("ALL"===e)return t;const s={};e=e.split(",");for(const i of e){let[e,a]=i.trim().split(".");t[e]&&(null==a?s[e]=t[e]:t[e][a]&&(s[e]||(s[e]=[]),s[e].push(t[e][a])))}return s}}class DataTransform{static apply(e,t,s,i,a){return null==i.x&&(i.x=0),null==i.y&&(i.y=0),"Wall"===e?this.transformWall(t,s,i,a):"Tile"===e?this.transformTile(t,s,i,a):"Note"==e?this.transformNote(t,s,i,a):"Token"===e?this.transformToken(t,s,i,a):"MeasuredTemplate"===e?this.transformMeasuredTemplate(t,s,i,a):"AmbientLight"===e?this.transformAmbientLight(t,s,i,a):"AmbientSound"===e?this.transformAmbientSound(t,s,i,a):"Drawing"===e?this.transformDrawing(t,s,i,a):"Region"===e&&this.transformRegion(t,s,i,a),t}static transformRegion(e,t,s,i){if(null!=s.scale&&e.shapes){const t=s.scale;for(const s of e.shapes)if("polygon"===s.type)for(let e=0;e<s.points.length;e++)s.points[e]*=t;else s.x*=t,s.y*=t,"ellipse"===s.type?(s.radiusX*=t,s.radiusY*=t):"rectangle"===s.type&&(s.height*=t,s.width*=t)}if(e.shapes&&e.shapes.forEach((e=>{if("polygon"===e.type)for(let t=0;t<e.points.length;t+=2)try{e.points[t]+=s.x,e.points[t+1]+=s.y}catch(t){console.log(e,s)}else e.x+=s.x,e.y+=s.y})),s.z&&(Number.isNumeric(e.elevation?.bottom)&&(e.elevation.bottom+=s.z),Number.isNumeric(e.elevation?.top)&&(e.elevation.top+=s.z)),null!=s.rotation&&e.shapes)for(const i of e.shapes)if("rectangle"===i.type&&(i.type="polygon",i.points=[i.x,i.y,i.x+i.width,i.y,i.x+i.width,i.y+i.height,i.x,i.y+i.height],delete i.width,delete i.height,delete i.x,delete i.y,delete i.rotation),"polygon"===i.type){const e=Math.toRadians(s.rotation%360);for(let s=0;s<i.points.length;s+=2)[i.points[s],i.points[s+1]]=this.rotatePoint(t.x,t.y,i.points[s],i.points[s+1],e)}else{const e=Math.toRadians(s.rotation%360);let a={x:i.x+(i.radiusX??i.width)/2,y:i.y+(i.radiusY??i.height)/2};[a.x,a.y]=this.rotatePoint(t.x,t.y,a.x,a.y,e),i.x=a.x-(i.radiusX??i.width)/2,i.y=a.y-(i.radiusY??i.height)/2}if(s.mirrorX||s.mirrorY)for(const i of e.shapes)if("rectangle"===i.type||"ellipse"===i.type){const e={x:i.x+(i.width??i.radiusX)/2,y:i.y+(i.height??i.radiusY)/2};s.mirrorX&&(e.x=t.x-(e.x-t.x),i.x=e.x-(i.width??i.radiusX)/2),s.mirrorY&&(e.y=t.y-(e.y-t.y),i.y=e.y-(i.height??i.radiusY)/2)}else if("polygon"===i.type){if(s.mirrorX)for(let e=0;e<i.points.length;e+=2)i.points[e]=t.x-(i.points[e]-t.x);if(s.mirrorY)for(let e=1;e<i.points.length;e+=2)i.points[e]=t.y-(i.points[e]-t.y)}if(i){const t=i.document;if(e.elevation&&(t.elevation=e.elevation),e.shapes)for(let s=0;s<e.shapes.length;s++){const i=t.shapes[s],a=e.shapes[s];i.type!==a.type?t.shapes[s]=new foundry.data.PolygonShapeData(a):"polygon"===i.type?i.points=a.points:(i.x=a.x,i.y=a.y,"rectangle"===i.type?(i.width=a.width,i.height=a.height):"ellipse"===i.type&&(i.radiusX=a.radiusX,i.radiusY=a.radiusY))}}}static transformNote(e,t,s,i){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const i=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,i)}s.mirrorX&&(e.x=t.x-(e.x-t.x)),s.mirrorY&&(e.y=t.y-(e.y-t.y)),i&&(i.document.x=e.x,i.document.y=e.y,e.elevation&&(i.document.elevation=e.elevation))}static transformAmbientSound(e,t,s,i){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.radius*=t),null!=e.elevation&&(e.elevation*=t,e.elevation*=t)}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.z&&(e.elevation=(e.elevation??0)+s.z),null!=s.rotation){const i=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,i)}if(s.mirrorX&&(e.x=t.x-(e.x-t.x)),s.mirrorY&&(e.y=t.y-(e.y-t.y)),i){const t=i.document;t.x=e.x,t.y=e.y,t.radius=e.radius,e.elevation&&(t.elevation=e.elevation)}}static transformWall(e,t,s,i){const a=foundry.utils.deepClone(e.c);if(null!=s.scale){const e=s.scale;a[0]*=e,a[1]*=e,a[2]*=e,a[3]*=e}if(a[0]+=s.x,a[1]+=s.y,a[2]+=s.x,a[3]+=s.y,null!=s.rotation){const e=Math.toRadians(s.rotation%360);[a[0],a[1]]=this.rotatePoint(t.x,t.y,a[0],a[1],e),[a[2],a[3]]=this.rotatePoint(t.x,t.y,a[2],a[3],e)}s.mirrorX&&(a[0]=t.x-(a[0]-t.x),a[2]=t.x-(a[2]-t.x)),s.mirrorY&&(a[1]=t.y-(a[1]-t.y),a[3]=t.y-(a[3]-t.y)),e.c=a,i&&(i.document.c=a)}static transformMeasuredTemplate(e,t,s,i){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.distance*=t,e.width&&(e.width*=t))}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const i=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,i),e.direction+=Math.toDegrees(i)}if((s.mirrorX||s.mirrorY)&&(s.mirrorX&&(e.x=t.x-(e.x-t.x),e.direction>180?e.direction=360-(e.direction-180):e.direction=180-e.direction),s.mirrorY&&(e.y=t.y-(e.y-t.y),e.direction=180-(e.direction-180))),i){const t=i.document;t.x=e.x,t.y=e.y,t.direction=e.direction,t.distance=e.distance,t.width=e.width,e.elevation&&(t.elevation=e.elevation)}}static transformAmbientLight(e,t,s,i){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.config.dim*=t,e.config.bright*=t),null!=e.elevation&&(e.elevation*=t)}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.z&&(e.elevation=(e.elevation??0)+s.z),null!=s.rotation){const i=Math.toRadians(s.rotation%360);[e.x,e.y]=this.rotatePoint(t.x,t.y,e.x,e.y,i),e.rotation+=Math.toDegrees(i)}if((s.mirrorX||s.mirrorY)&&(s.mirrorX&&(e.x=t.x-(e.x-t.x),e.rotation=180-(e.rotation-180)),s.mirrorY&&(e.y=t.y-(e.y-t.y),e.rotation>180?e.rotation=360-(e.rotation-180):e.rotation=180-e.rotation)),i){const t=i.document;if(t.x=e.x,t.y=e.y,t.rotation=e.rotation,t.config.dim=e.config.dim,t.config.bright=e.config.bright,e.elevation&&(t.elevation=e.elevation),i._l3dPreview){const e=game.Levels3DPreview.ruler.constructor.posCanvasTo3d({x:t.x,y:t.y,z:t.elevation}),s=i._l3dPreview.mesh;s.position.x=e.x,s.position.y=e.y,s.position.z=e.z}}}static transformTile(e,t,s,i){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,e.width*=t,e.height*=t;const i=e.flags?.["levels-3d-preview"]?.depth;null!=i&&""!=i&&(e.flags["levels-3d-preview"].depth=i*t),null!=e.elevation&&(e.elevation*=t)}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const i=Math.toRadians(s.rotation%360);let a={x:e.x+e.width/2,y:e.y+e.height/2};[a.x,a.y]=this.rotatePoint(t.x,t.y,a.x,a.y,i),e.x=a.x-e.width/2,e.y=a.y-e.height/2,e.rotation+=Math.toDegrees(i)}if(s.mirrorX||s.mirrorY){let i={x:e.x+e.width/2,y:e.y+e.height/2};s.mirrorX&&(i.x=t.x-(i.x-t.x),e.texture.scaleX*=-1,e.x=i.x-e.width/2),s.mirrorY&&(i.y=t.y-(i.y-t.y),e.texture.scaleY*=-1,e.y=i.y-e.height/2),e.rotation=180-(e.rotation-180)}if(i){const t=i.document;if(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.rotation=e.rotation,t.texture.scaleX=e.texture.scaleX,t.texture.scaleY=e.texture.scaleY,null!=e.elevation&&(t.elevation=e.elevation),i._l3dPreview&&i._l3dPreview.mesh){const e=game.Levels3DPreview.ruler.constructor.posCanvasTo3d({x:t.x+t.width/2,y:t.y+t.height/2,z:t.elevation}),a=i._l3dPreview.mesh;a.position.x=e.x,a.position.y=e.y,a.position.z=e.z,null!=s.scale&&a.scale.multiplyScalar(s.scale),null!=s.rotation&&(a.rotation.y+=game.Levels3DPreview.THREE.MathUtils.degToRad(-s.rotation))}}}static transformDrawing(e,t,s,i){if(null!=s.scale){const t=s.scale;if(e.x*=t,e.y*=t,e.shape.width*=t,e.shape.height*=t,e.shape.points){const s=e.shape.points;for(let e=0;e<s.length;e++)s[e]*=t}}if(e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0),null!=s.rotation){const i=Math.toRadians(s.rotation%360);let a={x:e.x+e.shape.width/2,y:e.y+e.shape.height/2};[a.x,a.y]=this.rotatePoint(t.x,t.y,a.x,a.y,i),e.x=a.x-e.shape.width/2,e.y=a.y-e.shape.height/2,e.rotation+=Math.toDegrees(i)}if(s.mirrorX||s.mirrorY){const i={x:e.x+e.shape.width/2,y:e.y+e.shape.height/2};if(s.mirrorX){if(e.x=t.x-(i.x-t.x),e.shape.points){const t=e.shape.points;for(let s=0;s<t.length;s+=2)t[s]=e.shape.width/2-(t[s]-e.shape.width/2)}e.x=i.x-e.shape.width/2}if(s.mirrorY){if(e.y=t.y-(i.y-t.y),e.shape.points){const t=e.shape.points;for(let s=1;s<t.length;s+=2)t[s]=e.shape.height/2-(t[s]-e.shape.height/2)}e.y=i.y-e.shape.height/2}e.rotation=180-(e.rotation-180)}if(i){const t=i.document;t.x=e.x,t.y=e.y,t.shape.width=e.shape.width,t.shape.height=e.shape.height,t.shape.points=e.shape.points,t.rotation=e.rotation,e.elevation&&(t.elevation=e.elevation)}}static transformToken(e,t,s,i){if(null!=s.scale){const t=s.scale;e.x*=t,e.y*=t,s.gridScale||(e.width*=t,e.height*=t,e.elevation*=t)}e.x+=s.x,e.y+=s.y,null!=e.elevation&&(e.elevation+=s.z??0);const a=canvas.grid;if(null!=s.rotation){const i=Math.toRadians(s.rotation%360);let n={x:e.x+e.width*a.sizeX/2,y:e.y+e.height*a.sizeY/2};[n.x,n.y]=this.rotatePoint(t.x,t.y,n.x,n.y,i),e.x=n.x-e.width*a.sizeX/2,e.y=n.y-e.height*a.sizeY/2,e.rotation=(e.rotation+Math.toDegrees(i))%360}if(s.mirrorX||s.mirrorY){let i={x:e.x+e.width*a.sizeX/2,y:e.y+e.height*a.sizeY/2};s.mirrorX&&(i.x=t.x-(i.x-t.x),e.texture.scaleX*=-1,e.x=i.x-e.width*a.sizeX/2),s.mirrorY&&(i.y=t.y-(i.y-t.y),e.texture.scaleY*=-1,e.y=i.y-e.height*a.sizeY/2),e.rotation=180-(e.rotation-180)}if(i){const t=i.document;if(t.x=e.x,t.y=e.y,t.elevation=e.elevation,t.rotation=e.rotation,t.width=e.width,t.height=e.height,t.texture.scaleX=e.texture.scaleX,t.texture.scaleY=e.texture.scaleY,e.elevation&&(t.elevation=e.elevation),i.hasOwnProperty("_l3dPreview")){if(i._l3dPreview=game.Levels3DPreview.tokens[i.id],!i._l3dPreview)return;const e=game.Levels3DPreview.ruler.constructor.posCanvasTo3d({x:t.x+t.width*canvas.grid.sizeX/2,y:t.y+t.height*canvas.grid.sizeY/2,z:t.elevation}),s=i._l3dPreview.mesh;s.position.x=e.x,s.position.y=e.y,s.position.z=e.z}}}static rotatePoint(e,t,s,i,a){const n=s-e,o=i-t;return[e+Math.cos(a)*n-Math.sin(a)*o,t+Math.sin(a)*n+Math.cos(a)*o]}}async function l(){const e=new Set;if(i.Me.forEach((t=>{canvas.getLayerByEmbeddedName(t).controlled.forEach((t=>{e.add(t.document),a.sy.getLinkedDocuments(t.document).forEach((t=>e.add(t)))}))})),!e.size){(await(0,r.rH)()).forEach((t=>e.add(t)))}if(!e.size)return;const t=new Map;let s;e.forEach((e=>{const a=e.documentName;if(!i.Me.includes(a))return;let n=e.toObject();if("Token"===a&&game.modules.get("token-attacher")?.active&&tokenAttacher?.generatePrototypeAttached){const e=n.flags?.["token-attacher"]?.attached||{};if(!foundry.utils.isEmpty(e)){const t=tokenAttacher.generatePrototypeAttached(n,e);foundry.utils.setProperty(n,"flags.token-attacher.attached",null),foundry.utils.setProperty(n,"flags.token-attacher.prototypeAttached",t),foundry.utils.setProperty(n,"flags.token-attacher.grid",{size:canvas.grid.size,w:canvas.grid.sizeX,h:canvas.grid.sizeY})}}t.get(a)?t.get(a).push(n):t.set(a,[n]),s||(s=a)}));const n=new Map;t.forEach(((e,t)=>{n.set(t,foundry.utils.deepClone(e))})),Picker.activate((async e=>{null!=e&&t.forEach(((e,t)=>{let s=[];const i=n.get(t);for(let t=0;t<i.length;t++){const a=foundry.utils.diffObject(i[t],e[t]);foundry.utils.isEmpty(a)||(a._id=i[t]._id,s.push(a))}s.length&&canvas.scene.updateEmbeddedDocuments(t,s,{ignoreLinks:!0,animate:!1})}))}),{documentName:s,previewData:t,snap:!0,taPreview:"ALL",center:!0})}},652:(e,t,s)=>{s.d(t,{A0:()=>PresetCollection,A6:()=>PresetTree,XF:()=>p,Xd:()=>g,_P:()=>PresetFolder,af:()=>PresetAPI,dH:()=>PresetPackFolder,y1:()=>VirtualFileFolder});var i=s(439),a=s(739),n=s(241),o=s(596),r=s(971),l=s(465),c=s(120),d=s(627),u=s(671),m=s(575);const h="world.mass-edit-presets-main",g="MassEditMetaData",p=["id","img","documentName","tags"];class PresetCollection{static presets;static workingPack;static async getTree(e,{externalCompendiums:t=!0,virtualDirectory:s=!0,setFormVisibility:i=!1}={}){let a,n;CONFIG.debug.MassEdit&&console.time("getTree");try{a=await this._initCompendium(this.workingPack),n=await PresetTree.init(a,e,{forceLoad:!0,setFormVisibility:i})}catch(t){console.log(t),console.log(`FAILED TO LOAD WORKING COMPENDIUM {${this.workingPack}}`),console.log("RETURNING TO DEFAULT"),await game.settings.set(o.Do,"workingPack",h),this.workingPack=h,a=await this._initCompendium(this.workingPack),n=await PresetTree.init(a,e,{forceLoad:!0,setFormVisibility:i})}const r=[];if(t)for(const t of game.packs)if(t.collection!==this.workingPack&&t.index.get(g)){const s=await PresetTree.init(t,e,{setFormVisibility:i});if(!s.hasVisible)continue;const a=new PresetPackFolder({pack:t,tree:s});r.push(a),n.allFolders.set(a.uuid,a);for(const[e,t]of s.allFolders)n.allFolders.set(e,t)}if(s){const t=await d.WX.getVirtualDirectoryTree(e,{setFormVisibility:i});if(t?.hasVisible){const e=new VirtualFileFolder({name:"VIRTUAL DIRECTORY",children:t.folders,uuid:"virtual_directory",color:"#1c5fa385"});r.push(e),n.allFolders.set(e.uuid,e);for(const[e,s]of t.allFolders)n.allFolders.set(e,s)}}return n.extFolders=this._groupExtFolders(r,n.allFolders),CONFIG.debug.MassEdit&&console.timeEnd("getTree"),n}static _groupExtFolders(e,t){e=e.sort(((e,t)=>e.name.localeCompare(t.name)));const s={},i=[];e.forEach((e=>{e.group?(e.group in s||(s[e.group]=[]),s[e.group].push(e)):i.push(e)}));const a=[];for(const[e,i]of Object.entries(s)){const s=c.AU.randomID(e),n="virtual@"+e,o=new PresetVirtualFolder({id:s,uuid:n,name:e,children:i,draggable:!1});t.set(n,o),a.push(o)}return a.concat(i).sort(((e,t)=>e.name.localeCompare(t.name)))}static async _cleanIndex(e,t,s){if(e.locked||!t||foundry.utils.isEmpty(s))return;const i=e.index,a={};for(const e of Object.keys(s))i.has(e)||(a["-="+e]=null);foundry.utils.isEmpty(a)||(CONFIG.debug.MassEdit&&console.log("Mass Edit - Index Cleanup",a),t.setFlag(o.Do,"index",a),delete PresetTree._packTrees[e.metadata.name])}static _sortFolders(e,t="a"){for(const t of e)t.children=this._sortFolders(t.children,t.sorting),t.presets=this._sortPresets(t.presets,t.sorting);return"a"===t?e.sort(((e,t)=>e.name.localeCompare(t.name,"en",{numeric:!0}))):e.sort(((e,t)=>e.sort-t.sort))}static _sortPresets(e,t="a"){return"a"===t?e.sort(((e,t)=>e.name.localeCompare(t.name,"en",{numeric:!0}))):e.sort(((e,t)=>e.sort-t.sort))}static async packToPresets(e){if(!e)return[];const t=[];let s=(await e.getDocument(g))?.getFlag(o.Do,"index");const i=e.index.contents;for(const a of i){if(a._id===g)continue;const i=s[a._id],n=new u.k({...a,...i,pack:e.collection});t.push(n)}return t}static async update(e){const t=await this._initCompendium(this.workingPack),s=await t.getDocument(e.id),i={name:e.name,flags:{[o.Do]:{preset:e.toJSON()}}},a=e.pages;a&&(i.pages=a),await s.update(i);const n=await this._initMetaDocument(this.workingPack),r={};p.forEach((t=>{r[t]=e[t]})),await n.setFlag(o.Do,"index",{[e.id]:r}),delete PresetTree._packTrees[t.metadata.name]}static async updatePresets(e){await JournalEntry.updateDocuments(e,{pack:this.workingPack})}static async set(e,t){if(t||(t=this.workingPack),e instanceof Array){for(const s of e)await PresetCollection.set(s,t);return}if((await this._initCompendium(t)).index.get(e.id))return void await this.update(e);const s=await JournalEntry.createDocuments([{_id:e.id,name:e.name,pages:e.pages??[],folder:e.folder,flags:{[o.Do]:{preset:e.toJSON()}}}],{pack:t,keepId:!0});e.uuid=s[0].uuid,e.document=s[0];const i=await this._initMetaDocument(t),a={};p.forEach((t=>{a[t]=e[t]})),await i.setFlag(o.Do,"index",{[e.id]:a}),delete PresetTree._packTrees[t]}static async get(e,{full:t=!0}={}){if(e.startsWith("virtual@"))return this._constructVirtualFilePreset(e,{full:t});let{collection:s,documentId:i,documentType:a,embedded:n,doc:r}=foundry.utils.parseUuid(e);const l=s.index.get(i);if(l){const e=(await s.getDocument(g))?.getFlag(o.Do,"index"),i=e[l._id],a=new u.k({...l,...i,pack:s.collection});return t&&await a.load(),a}return null}static async _constructVirtualFilePreset(e,{full:t=!0}={}){const s=e.substring(8),i=new u.JG({src:s});return t&&await i.load(),i}static async delete(e){if(!e)return;e instanceof Array||(e=[e]);const t={};for(const s of e){let{collection:e}=foundry.utils.parseUuid(s.uuid);e&&(e=e.collection,t[e]?t[e].push(s):t[e]=[s])}for(const e of Object.keys(t)){const s=await game.packs.get(e);if(!s)continue;const i=await this._initMetaDocument(e),a={},n=[];for(const s of t[e])n.push(s.id),a["-="+s.id]=null;const r={pack:e};r.ids=n,await JournalEntry.deleteDocuments(n,r),await i.setFlag(o.Do,"index",a),delete PresetTree._packTrees[s.metadata.name]}}static async _initCompendium(e){let t=game.packs.get(e);return t||e!==h||(t=await CompendiumCollection.createCompendium({label:"Mass Edit: Presets (MAIN)",type:"JournalEntry",ownership:{GAMEMASTER:"NONE",PLAYER:"NONE",ASSISTANT:"NONE"},packageType:"world"}),await this._initMetaDocument(e)),t}static async _initMetaDocument(e){const t=game.packs.get(e),s=await t.getDocument(g);if(s)return s;return(await JournalEntry.createDocuments([{_id:g,name:"!!! METADATA: DO NOT DELETE !!!",flags:{[o.Do]:{index:{}}}}],{pack:e,keepId:!0}))[0]}static async deleteFolder(e,t=!1){const s=await fromUuid(e);if(!s.compendium.locked){if(t){const e=s.compendium.get(g);if(!e)return;const t={},i=function(e){e.contents.forEach((e=>t["-="+e._id]=null)),e.children.forEach((e=>i(e.folder)))};i(s),e.setFlag(o.Do,"index",t)}return delete PresetTree._packTrees[s.compendium.metadata.name],await s.delete({deleteSubfolders:t,deleteContents:t})}}static _searchPresetTree(e,t){const s=[];return t.folder||this._searchPresetList(e.allPresets,s,t),e.allFolders.forEach((e=>this._searchPresetFolder(e,s,t))),s}static _searchPresetFolder(e,t,s){s.folder&&e.name!==s.folder||this._searchPresetList(e.presets,t,s,e.name)}static _searchPresetList(e,t,{name:s,type:i,tags:a}={},n){for(const n of e){let e=!0;s&&s!==n.name&&(e=!1),i&&i!==n.documentName&&(e=!1),e&&a&&(e=a.matchAny?a.tags.some((e=>n.tags.includes(e))):a.tags.every((e=>n.tags.includes(e)))),e&&t.push(n)}}static async buildSpotlightOmnisearchIndex(e){const t=await PresetCollection.getTree(null,{externalCompendiums:!0}),s=CONFIG.SpotlightOmnisearch.SearchTerm,i=async function(){o.Me.includes(this.data.documentName)&&(ui.spotlightOmnisearch?.setDraggingState(!0),await PresetAPI.spawnPreset({preset:this.data,coordPicker:!0,taPreview:"ALL",scaleToGrid:game.settings.get(o.Do,"presetScaling")}),ui.spotlightOmnisearch?.setDraggingState(!1))},a=function(e){if(o.Me.includes(this.data.documentName)){const{x:t,y:s}=canvas.canvasCoordinatesFromClient({x:e.clientX,y:e.clientY});PresetAPI.spawnPreset({preset:this.data,x:t,y:s,scaleToGrid:game.settings.get(o.Do,"presetScaling")})}else"Scene"===this.data.documentName&&(0,c.XK)(this.data)},r=function(){ui.spotlightOmnisearch?.setDraggingState(!1)},l=function(){const e=[{name:"MassEdit.presets.open-journal",icon:'<i class="fas fa-book-open fa-fw"></i>',callback:()=>{this.data.openJournal()}}];return o.Me.includes(this.data.documentName)&&e.push({name:"MassEdit.presets.controls.activate-brush",icon:'<i class="fas fa-paint-brush"></i>',callback:async()=>{canvas.getLayerByEmbeddedName(this.data.documentName)?.activate(),n.vM.activate({preset:await this.data.load(),deactivateCallback:r})&&ui.spotlightOmnisearch.setDraggingState(!0)}}),e},d=function(t){e.push(new s({name:t.name,description:"Mass Edit: Preset",type:t.documentName+" preset",img:t.img,icon:["fa-solid fa-books",t.icon],keywords:t.tags,onClick:i,onDragEnd:a,data:t,actions:l}))};t.presets.forEach(d),t.allFolders.forEach((e=>e.presets.forEach(d)))}}class PresetAPI{static name="PresetAPI";static async getPreset({uuid:e,name:t,type:s,folder:i,tags:a,random:n=!1,full:o=!0}={}){if(e)return await PresetCollection.get(e,{full:o});if(!(t||s||i||a))throw Error("UUID, Name, Type, and/or Folder required to retrieve a Preset.");a&&(Array.isArray(a)?a={tags:a,matchAny:!0}:"string"==typeof a&&(a={tags:a.split(","),matchAny:!0}));const r=PresetCollection._searchPresetTree(await PresetCollection.getTree(s,{externalCompendiums:!0,virtualDirectory:!0}),{name:t,type:s,folder:i,tags:a});let l=n?r[Math.floor(Math.random()*r.length)]:r[0];return l&&(l=l.clone(),o&&await l.load()),l}static async getPresets({uuid:e,name:t,type:s,folder:i,format:a="preset",tags:n,full:o=!0}={}){let r;if(e){r=[];const t=Array.isArray(e)?e:[e];for(const e of t){const t=await PresetCollection.get(e,{full:o});t&&r.push(t)}}else{if(!(t||s||i||n))throw Error("UUID, Name, Type, Folder and/or Tags required to retrieve a Preset.");n&&(Array.isArray(n)?n={tags:n,matchAny:!0}:"string"==typeof n&&(n={tags:n.split(","),matchAny:!0})),r=PresetCollection._searchPresetTree(await PresetCollection.getTree(s,{externalCompendiums:!0,virtualDirectory:!0}),{name:t,type:s,folder:i,tags:n})}return"name"===a?r.map((e=>e.name)):"nameAndFolder"===a?r.map((e=>({name:e.name,folder:e._folderName}))):r}static async createPresetFromActor(e,{keepId:t=!1,folder:s}={}){if(!e||"Actor"!==e.documentName)return;const i={id:t?e.id:null,name:e.name,documentName:"Token",img:e.img,data:[e.prototypeToken.toJSON()],folder:s};i.gridSize=canvas.scene.grid.size;const a=new u.k(i);return await PresetCollection.set(a),a}static async createPresetFromActorUuid(e,t={}){const s=await fromUuid(e);if("Actor"!==!s.documentName)return await this.createPresetFromActor(s,t)}static async createPreset(e,t={}){if(!e)return;e instanceof Array||(e=[e]);const s={};for(const t of e){const e=t.document.documentName;s.hasOwnProperty(e)||(s[e]=[]),s[e].push(t)}const i=[];for(const[e,a]of Object.entries(s)){const s=[];for(const e of a)s.push((0,m.h)(e));const n={name:(0,c.kg)("presets.default-name"),documentName:e,data:s};switch(n.documentName){case"Token":case"Tile":case"Note":n.img=s[0].texture.src;break;case"AmbientSound":n.img="icons/svg/sound.svg";break;case"AmbientLight":n.img="icons/svg/light.svg";break;case"Drawing":n.img="icons/svg/acid.svg";break;case"MeasuredTemplate":n.img="icons/svg/circle.svg"}if("Token"===n.documentName)n.name=s[0].name;else{const e=s[0].flags?.tagger?.tags?.[0];e&&(n.name=e)}n.gridSize=a[0].document.parent.grid.size,foundry.utils.mergeObject(n,t,{inplace:!0});const o=new u.k(n);await PresetCollection.set(o),i.push(o)}return i}static async spawnPreset({uuid:e,preset:t,name:s,type:n,folder:d,tags:u,random:h=!1,x:g,y:p,z:f,coordPicker:y=!1,pickerLabel:b,taPreview:v,sceneId:k=canvas.scene.id,snapToGrid:w=!0,hidden:x=!1,layerSwitch:_=!1,scaleToGrid:D=!1,modifyPrompt:P=!0,center:T=!1,transform:E={},previewOnly:S=!1,flags:O}={}){if(!canvas.ready)throw Error("Canvas need to be 'ready' for a preset to be spawned.");if(!(e||t||s||n||d||u))throw Error("ID, Name, Folder, Tags, or Preset is needed to spawn it.");if(!y&&(null==g&&null!=p||null!=g&&null==p))throw Error("Need both X and Y coordinates to spawn a preset.");if(t&&await t.load(),!(t=t??await PresetAPI.getPreset({uuid:e,name:s,type:n,folder:d,tags:u,random:h})))throw Error(`No preset could be found matching: { uuid: "${e}", name: "${s}", type: "${n}"}`);let C=foundry.utils.deepClone(t.data);if(t.spawnRandom&&C.length&&(C=[C[Math.floor(Math.random()*C.length)]]),P&&t.modifyOnSpawn?.length&&(C=await async function(e,t){const s={},i=foundry.utils.flattenObject(e);for(const e of t)e in i&&(null==i[e]?s[e]="":s[e]=i[e]);foundry.utils.isEmpty(s)||await new Promise((t=>{(0,a.Ls)(s,"PresetFieldModify",{callback:s=>{if(foundry.utils.isEmpty(s))return null==s&&(e=null),void t();for(const[e,t]of Object.entries(s))i[e]=t;const a=foundry.utils.expandObject(i),n=[];for(let t=0;t<e.length;t++)n.push(a[t]);e=n,t()},simplified:!0,noTabs:!0})}));return e}(C,t.modifyOnSpawn),null==C))return;C=C.map((e=>(0,m.Go)(t,e))),C=C.map((e=>foundry.utils.flattenObject(e))),foundry.utils.isEmpty(t.randomize)||await(0,l.of)(C,null,t.randomize),await(0,i.fP)(t.documentName,C,C),C=C.map((e=>foundry.utils.expandObject(e)));let M=foundry.utils.deepClone(t.attached);t.preSpawnScript&&await(0,c.HG)(t.preSpawnScript,{data:C,attached:M});const N=new Map;if(N.set(t.documentName,C),M)for(const e of M)N.get(e.documentName)||N.set(e.documentName,[]),N.get(e.documentName).push(e.data);if(!t.preserveLinks){const e=new Map,t=function(t){let s=e.get(t);return s||(s=t.startsWith("LinkTokenBehavior - ")?"LinkTokenBehavior - "+foundry.utils.randomID(8):foundry.utils.randomID(),e.set(t,s)),s};N.forEach((e=>{e.forEach((e=>{e.flags?.[o.Do]?.links?.forEach((e=>{e.id=t(e.id)})),e.behaviors?.forEach((e=>{e.system?.linkId&&(e.system.linkId=t(e.system.linkId))}))}))}))}if(D){const e=canvas.grid.size/(t.gridSize||100);N.forEach(((t,s)=>{t.forEach((t=>r.DataTransform.apply(s,t,{x:0,y:0},{scale:e,gridScale:!0})))}))}if(y){const e=await new Promise((async e=>{r.Picker.activate(e,{documentName:t.documentName,previewData:N,snap:w,label:b,taPreview:v,center:T,previewOnly:S,...E})}));if(null==e)return[];g=e.end.x,p=e.end.y,null!=e.end.z&&(f=e.end.z)}else if(null==g||null==p)if(game.Levels3DPreview?._active){const e=game.Levels3DPreview.interactionManager.canvas2dMousePosition;g=e.x,p=e.y,f=e.z}else g=canvas.mousePosition.x,p=canvas.mousePosition.y,"Token"!==t.documentName&&"Tile"!==t.documentName||(g-=canvas.dimensions.size/2,p-=canvas.dimensions.size/2);if(!y){if(T){const e=(0,m.Ym)(N);g-=e.x,p-=e.y}let e={x:g,y:p};w&&!game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)&&(e=canvas.getLayerByEmbeddedName(t.documentName).getSnappedPoint(e)),e.z=f;const s=(0,m.Q2)(N);s.x+=e.x,s.y+=e.y,game.Levels3DPreview?._active&&(null==e.z?s.z=0:s.z+=e.z),N.forEach(((e,t)=>{e.forEach((e=>{r.DataTransform.apply(t,e,{x:0,y:0},s)}))}))}if(N.forEach(((e,t)=>{e.forEach((e=>{["Drawing","MeasuredTemplate"].includes(t)&&("Drawing"===t?e.author=game.user.id:"MeasuredTemplate"===t&&(e.user=game.user.id)),(x||game.keyboard.downKeys.has("AltLeft"))&&(e.hidden=!0),O&&(e.flags=foundry.utils.mergeObject(e.flags??{},O)),"Region"===t&&e.behaviors&&e.behaviors.forEach((e=>{e.system?.destinationTags?.length&&(e.system.destinationTags=(0,m.Ch)(e.system.destinationTags))})),"Token"===t&&null===e.flags?.["token-attacher"]?.attached&&delete e.flags["token-attacher"].attached}))})),N.get("Tile")){const e=Math.max(0,...game.scenes.get(k).tiles.map((e=>e.sort)))+1;N.get("Tile").sort(((e,t)=>(e.sort??0)-(t.sort??0))).forEach(((t,s)=>t.sort=e+s))}_&&(game.user.isGM||["Token","MeasuredTemplate","Note"].includes(t.documentName))&&canvas.getLayerByEmbeddedName(t.documentName)?.activate();const F=[];for(const[e,t]of N.entries()){(await(0,c.VS)(e,t,k)).forEach((e=>F.push(e)))}return t.postSpawnScript&&await(0,c.HG)(t.postSpawnScript,{documents:F,objects:F.map((e=>e.object)).filter(Boolean)}),await t.callPostSpawnHooks({documents:F,objects:F.map((e=>e.object)).filter(Boolean)}),F}}class PresetFolder{static isEditable(e){const{collection:t}=foundry.utils.parseUuid(e);return t&&!t.locked}constructor({id:e,uuid:t,name:s,sorting:i="m",color:a="#000000",sort:n=0,children:o=[],presets:r=[],draggable:l=!0,folder:c=null,visible:d=!0,render:u=!0,types:h=[]}={}){this.id=e,this.uuid=t,this.name=s,this.sorting=i,this.color=a,this.sort=n,this.children=o,this.children.forEach((e=>{e.folder=this.id})),this.presets=r,this.draggable=l,this.folder=c,this.visible=d,this.render=u,this.expanded=m.cm.expanded(this.uuid),this.types=h}async update(e){const t=await fromUuid(this.uuid);t&&(foundry.utils.mergeObject(this,e),await t.update(e))}}class PresetVirtualFolder extends PresetFolder{constructor(e){super(e),this.virtual=!0,this.draggable=!1}async update(e){}}class VirtualFileFolder extends PresetVirtualFolder{constructor(e){super(e),this.id=foundry.utils.randomID(),e.types||(this.types=["ALL"]),this.bucket=e.bucket,this.source=e.source,this.name=(0,m.e6)(this.name),this.icon=e.icon,this.subtext=e.subtext,e.source&&["data","forgevtt"].includes(e.source)&&(this.indexable=!0)}}class PresetPackFolder extends PresetVirtualFolder{constructor(e){const t=e.tree,s=e.pack,i=t.metaDoc.getFlag(o.Do,"folder")??{},a=s.collection;super({uuid:a,id:c.AU.randomID(a),name:i.name??s.title,children:t.folders,presets:t.presets,draggable:!1,color:i.color??"#000000"}),this.group=i.group}get pack(){return this.uuid}async update(e={}){const t=game.packs.get(this.pack);if(t.locked)return;if(e.hasOwnProperty("name")&&e.name===t.title&&delete e.name,foundry.utils.isEmpty(e))return;const s=await PresetCollection._initMetaDocument(this.pack);await s.setFlag(o.Do,"folder",e),foundry.utils.mergeObject(this,e)}}class PresetTree{static _packTrees={};static async init(e,t,{forceLoad:s=!1,setFormVisibility:i=!1}={}){if(!e)return null;if(CONFIG.debug.MassEdit&&console.time(e.title),!s&&PresetTree._packTrees[e.metadata.name]){const s=PresetTree._packTrees[e.metadata.name];return i&&s.setVisibility(t),CONFIG.debug.MassEdit&&console.timeEnd(e.title),s}const a=new Map,n=new Map,r=e.folders.contents;for(const e of r){const t=new PresetFolder({id:e._id,uuid:e.uuid,name:e.name,sorting:e.sorting,color:e.color,sort:e.sort,draggable:e.pack===PresetCollection.workingPack,folder:e.folder?.uuid,types:e.flags[o.Do]?.types||["ALL"]});a.set(t.uuid,t),n.set(e.uuid,t)}for(const e of r)if(e.folder){a.get(e.folder.uuid).children.push(a.get(e.uuid)),n.delete(e.uuid)}const l=[],c=[];let d=!1;const m=await e.getDocument(g);let h=m?.getFlag(o.Do,"index");const p=e.index.contents;PresetCollection._cleanIndex(e,m,h);for(const t of p){if(t._id===g)continue;const s=h[t._id],i=new u.k({...t,...s,pack:e.collection});if(!i.documentName){if(console.log(`Missing MetaData. Attempting document load: ${i.id} | ${i.name}`),await i.load(!0),!i.documentName)continue;console.log(`MetaData. Found for: ${i.id} | ${i.name}`),e.locked||await i._updateIndex(i)}if(i.folder){let e=!1;for(const[t,s]of a)if(s.id===i.folder){s.presets.push(i),e=!0;break}e||c.push(i)}else c.push(i);l.push(i),d|=i._visible}const f="manual"===game.settings.get(o.Do,"presetSortMode")?"m":"a",y=PresetCollection._sortFolders(Array.from(n.values()),f),b=PresetCollection._sortPresets(c,f);CONFIG.debug.MassEdit&&console.timeEnd(e.title);const v=new PresetTree({folders:y,presets:b,allPresets:l,allFolders:a,hasVisible:d,metaDoc:m,pack:e});return i&&v.setVisibility(t),PresetTree._packTrees[e.metadata.name]=v,v}constructor({folders:e,presets:t,allPresets:s,allFolders:i,hasVisible:a,metaDoc:n,pack:o}={}){this.folders=e,this.presets=t,this.allPresets=s,this.allFolders=i,this.hasVisible=a,this.metaDoc=n,this.pack=o}setVisibility(e){this.allFolders.forEach((t=>{t.render=!0,t.visible=!e||t.types.includes(e)})),this.hasVisible=!1;for(const t of this.allPresets){if(t._visible=!0,t._render=!0,e&&("ALL"===e?o.TA.includes(t.documentName)||(t._visible=!1):"FAVORITES"===e?t.isFavorite||(t._visible=!1):t.documentName!==e&&(t._visible=!1)),"FAVORITES"===e&&t.folder&&t.isFavorite)for(const[e,s]of this.allFolders)if(s.id===t.folder){this._setChildAndParentFoldersVisible(s);break}this.hasVisible=this.hasVisible||t._visible}}_setChildAndParentFoldersVisible(e){if(e.visible=!0,e.folder)for(const[t,s]of this.allFolders.entries())if(s.id===e.folder)return this._setChildAndParentFoldersVisible(s)}}},627:(e,t,s)=>{s.d(t,{ME:()=>IndexerForm,WX:()=>FileIndexer});var i=s(596),a=s(120),n=s(652),o=s(671),r=s(575);const l="mass_edit_cache.json";class FileIndexer{static _loadedTree;static _buildingIndex=!1;static async getVirtualDirectoryTree(e,{setFormVisibility:t=!1}={}){if(CONFIG.debug.MassEdit&&console.time("Virtual File Directory"),this._loadedTree)return CONFIG.debug.MassEdit&&console.timeEnd("Virtual File Directory"),t&&this._loadedTree.setVisibility(e),this._loadedTree;const s=new Map,i=[],a=[],o=await this.loadMainIndexCache();if(!o)return CONFIG.debug.MassEdit&&console.timeEnd("Virtual File Directory"),null;for(const e of o){let t="";if("forge-bazaar"===e.source)t="https://assets.forge-vtt.com/bazaar/";else if("forgevtt"===e.source){if("undefined"==typeof ForgeVTT||!ForgeVTT.usingTheForge)continue;const e=await ForgeAPI.getUserId();if(!e)continue;t=`https://assets.forge-vtt.com/${e}/`}else if("s3"===e.source){const s=game.data.files.s3;if(!s||!s.buckets.includes(e.bucket))continue;t=`https://${e.bucket}.${s.endpoint.host}`}const o=e.index.map((a=>this._indexToVirtualFolder(a,"",s,i,{prePend:t,source:e.source,bucket:e.bucket})));if(o?.length){const t=new n.y1({uuid:"virtual@source@"+e.source,name:e.source,children:o,types:["ALL"],bucket:e.bucket});o.some((e=>e.types.includes("Tile")))&&t.types.push("Tile"),o.some((e=>e.types.includes("AmbientSound")))&&t.types.push("AmbientSound"),o.forEach((e=>{e.folder=t.id})),s.set(t.uuid,t),a.push(t)}}let r;return a.length&&(r=new n.A6({folders:a,presets:[],allPresets:i,allFolders:s,hasVisible:i.some((e=>e._visible)),metaDoc:null,pack:null}),t&&r.setVisibility(e)),this._loadedTree=r,CONFIG.debug.MassEdit&&console.timeEnd("Virtual File Directory"),r}static async buildIndex(){if(this._buildingIndex)return void ui.notifications.warn("Index Build In-Progress. Wait for it to finish before attempting it again.");this._buildingIndex=!0,ui.notifications.info("Building Mass Edit directory index.");const e=game.settings.get(i.Do,"indexer");try{const t=[],s=[];for(const i of e.indexDirs){"forge-bazaar"!==i.source&&"forgevtt"!==i.source||await this._buildFauxForgeBrowser(i.source,i.target);let a=await this.generateIndex(i.target,s,i.source,i.bucket,e);if(a){const e=i.target.split("/").filter(Boolean);for(let t=e.length-2;t>=0;t--)a={dir:e[t],dirs:[a]};let s=t.find((e=>e.source===i.source&&e.bucket==i.bucket));s?this.mergeIndex(s.index,[a]):(s={source:i.source,index:[a]},i.bucket&&(s.bucket=i.bucket),t.push(s))}}for(const e of s){const s=await this.loadIndexCache(e);s&&this.mergeCaches(t,s)}const i=await this.loadIndexCache("/"+l);i&&this.mergeCaches(t,i,{tagsOnly:!0,overrideNullTagsOnly:e.overrideTags}),t.length&&await this._writeIndexToCache(t),this._loadedTree=null,ui.notifications.info("MassEdit Index build finished.")}catch(e){console.log(e)}this._buildingIndex=!1}static mergeCaches(e,t,{tagsOnly:s=!1,overrideNullTagsOnly:i=!1}={}){for(const a of t){const t=e.find((e=>e.source===a.source&&e.bucket==a.bucket));t?this.mergeIndex(t.index,a.index,{tagsOnly:s,overrideNullTagsOnly:i}):s||e.push(a)}}static mergeIndex(e,t,{tagsOnly:s=!1,overrideNullTagsOnly:i=!1}={}){for(const a of t){const t=e.find((e=>e.dir===a.dir));if(t){if(s||(t.icon=a.icon,t.subtext=a.subtext),a.dirs&&(t.dirs?this.mergeIndex(t.dirs,a.dirs,{tagsOnly:s,overrideNullTagsOnly:i}):s||(t.dirs=a.dirs)),a.files)if(t.files)for(const e of a.files){const a=t.files?.find((t=>t.name===e.name));a?i&&null!=a.tags||(a.tags=e.tags):s||(t.files||(t.files=[]),t.files.push(e))}else s||(t.files=a.files)}else s||e.push(a)}}static async getPreset(e){return this._loadedTree||await FileIndexer.getVirtualDirectoryTree(),this._loadedTree?this._loadedTree.allPresets.find((t=>t.uuid===e)):null}static async saveIndexToCache(e=this._loadedTree?.folders,{path:t="",notify:s=!0,source:i="data"}={}){if(e){const a=[];for(const t of e){const e={source:t.name,index:t.children.map((e=>this._cacheFolder(e)))};t.bucket&&(e.bucket=t.bucket),a.push(e)}this._writeIndexToCache(a,{path:t,notify:s,source:i})}}static async _writeIndexToCache(e,{path:t="",notify:s=!0,source:i="data"}={}){const a=JSON.stringify(e),n=await StringCompress.compress(a);await FilePicker.upload(i,t,n,{},{notify:s})}static async saveFolderToCache(e){if(!(this._loadedTree||e.indexable||e.source))return;const t=this._loadedTree.allFolders;let s=e;for(;s.folder;){let e;for(const[i,a]of t)if(a.id===s.folder){e=a;break}if(!e)return;e=new n.y1({name:e.name,folder:e.folder}),s&&(e.children=[s]),s=e}this.saveIndexToCache([s],{path:e.uuid.replace("virtual@",""),source:e.source})}static _cacheFolder(e){const t={dir:(0,r.CY)(e.name)};return e.presets.length&&(t.files=e.presets.map((e=>this._cachePreset(e)))),e.children.length&&(t.dirs=e.children.map((e=>this._cacheFolder(e)))),t}static _cachePreset(e){const t={name:(0,r.CY)(e.name)};return e.tags?.length&&(t.tags=e.tags),t}static async loadIndexCache(e){let t;try{t=await StringCompress.decompressCache(e)}catch(t){ui.notifications.warn("Failed to load cache: "+e)}return t}static async loadMainIndexCache(){let e;if("undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge){e=`https://assets.forge-vtt.com/${await ForgeAPI.getUserId()}/${l}`}else e="/"+l;return await this.loadIndexCache(e)}static _indexToVirtualFolder(e,t,s,i,a){const r=t+"/"+e.dir,l="virtual@"+a.prePend+r,c=new n.y1({uuid:l,name:e.dir,subtext:e.subtext,icon:e.icon,color:e.color,source:a.source,bucket:a.bucket});if(e.dirs){for(const t of e.dirs){const e=this._indexToVirtualFolder(t,r,s,i,a);e&&(e.folder=c.id,c.children.push(e))}c.children.sort(((e,t)=>e.name.localeCompare(t.name)))}if(e.files)for(const t of e.files){const e=new o.JG({name:t.name,src:a.prePend+r+"/"+t.name,tags:t.tags,folder:c.id});i.push(e),c.presets.push(e)}return["Tile","AmbientSound"].forEach((e=>{(c.presets.some((t=>t.documentName===e))||c.children.some((t=>t.types.includes(e))))&&c.types.push(e)})),s.set(l,c),c}static async generateIndex(e,t=[],s="data",n=null,o,c={},d=[]){let u,m=c[e]??{};if(m.noscan)return null;try{u=await this._browse(s,e,{bucket:n})}catch(e){return null}const h=u.files.find((e=>e.endsWith("indexer.json")));if(h&&(c=await(0,r.$J)(h)??{},m=c[e]??{},m.noscan))return null;m.tags&&(d=m.tags.map((e=>a.Fo.simplifyString(e))).filter(Boolean).concat(d));const g={dir:e.split("/").filter(Boolean).pop(),dirs:[],files:[]};if(o.folderFilters.some((e=>g.dir.includes(e))))return null;foundry.utils.isEmpty(m)||["color","icon","subtext"].forEach((e=>{m[e]&&(g[e]=m[e])}));for(let r of u.files){const c=r.split("\\").pop().split("/").pop();if(o.fileFilters.some((e=>c.includes(e))))continue;if("noscan.txt"===c)return null;if(c!==l||o.ignoreExternal){if("module.json"===c){const e=await this._getAuthorFromModule(r);if(e){g.subtext=m.subtext??e;const t=a.Fo.simplifyString(e.split(/[ ,\-_@]+/)[0]??"");t&&t.length>=3&&(d=[...d,t],g.files.forEach((e=>{e.tags=d})))}}}else{const i=o.cacheDir;if(i.target!==e.target||i.source!==s||i.bucket!==n)return t.push(r),null}let u=c.split(".");if(u=u[u.length-1].toLowerCase(),i.Y0.includes(u)){const e={name:c};d.length&&(e.tags=d),g.files.push(e)}}for(let e of u.dirs)e=await this.generateIndex(e,t,s,n,o,c,d),e&&g.dirs.push(e);return g.dirs.length||delete g.dirs,g.files.length||delete g.files,g.dirs||g.files?g:null}static async _browse(e,t,s){return"forge-bazaar"===e||"forgevtt"===e?this._fauxForgeBrowser?.get(t)??{dirs:[],files:[]}:await FilePicker.browse(e,t,s)}static async _buildFauxForgeBrowser(e,t){if(this._fauxForgeBrowser=new Map,"undefined"==typeof ForgeVTT||!ForgeVTT.usingTheForge)return;let s;if("forgevtt"!==e&&["modules","systems","worlds","assets"].includes(t.replaceAll(/[\/\\]/g,""))){s=(await FilePicker.browse(e,t,{recursive:!1})).dirs}else s=[t];const i=(e,t)=>{for(let s=1;s<e.length+1;s++){const i=e.slice(0,s).join("/"),a=e.slice(0,s+1).join("/");let n=this._fauxForgeBrowser.get(i);n||(n={dirs:[],files:[]},this._fauxForgeBrowser.set(i,n)),i===a?n.files.push(t):n.dirs.includes(a)||n.dirs.push(a)}};for(const t of s){const s=await FilePicker.browse(e,t,{recursive:!0});for(const e of s.files){const t=new URL(e).pathname.split("/");i(t.slice(2,t.length-1),t.slice(2).join("/"))}}}static async _getAuthorFromModule(e){const t=await(0,r.$J)(e);if(t){const e=t.author??t.authors?.[0]?.name;if("string"==typeof e)return e}return null}}class StringCompress{static async compress(e){const t=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip")),s=[];for await(const e of this.streamAsyncIterator(t))s.push(e);const i=new Blob(s);return new File([i],l)}static async decompressCache(e){let t;try{const s=await fetch(e);if(s.ok){const e=await this.decompress(s.body);t=JSON.parse(e)}}catch(e){}return t}static async decompress(e){const t=e.pipeThrough(new DecompressionStream("gzip")),s=[];for await(const e of this.streamAsyncIterator(t))s.push(e);const i=await this.concatUint8Arrays(s);return(new TextDecoder).decode(i)}static async concatUint8Arrays(e){const t=new Blob(e),s=await t.arrayBuffer();return new Uint8Array(s)}static async*streamAsyncIterator(e){const t=e.getReader();try{for(;;){const{done:e,value:s}=await t.read();if(e)return;yield s}}finally{t.releaseLock()}}}class IndexerForm extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","mass-edit-dark-window"],template:`modules/${i.Do}/templates/preset/indexer.html`,width:500,height:"auto"})}get title(){return"Directory Indexer"}async getData(e={}){const t=foundry.utils.deepClone(game.settings.get(i.Do,"indexer"));return t.fileFilters=t.fileFilters.join(", "),t.folderFilters=t.folderFilters.join(", "),t}activateListeners(e){super.activateListeners(e),e.on("click",".addDirectory",this._onAddDirectory.bind(this)),e.on("click",".deleteDirectory",this._onDeleteDirectory.bind(this)),e.on("input",'[name="fileFilters"]',this._onFileFiltersChange.bind(this)),e.on("input",'[name="folderFilters"]',this._onFolderFiltersChange.bind(this)),e.find('input[type="checkbox"]').on("change",this._onToggleCheckbox.bind(this))}_onToggleCheckbox(e){const t=$(e.currentTarget),s=t.attr("name");this._updateIndexerSettings({[s]:t.is(":checked")},!1)}_onFileFiltersChange(e){clearTimeout(this._onInputTimeOut),this._onInputTimeOut=setTimeout((()=>{const t=$(e.currentTarget).val().split(",").map((e=>e.trim())).filter(Boolean);this._updateIndexerSettings({fileFilters:t},!1)}),500)}_onFolderFiltersChange(e){clearTimeout(this._onInputTimeOut),this._onInputTimeOut=setTimeout((()=>{const t=$(e.currentTarget).val().split(",").map((e=>e.trim())).filter(Boolean);this._updateIndexerSettings({folderFilters:t},!1)}),500)}async _onAddDirectory(){this.selectFolder((async e=>{if(!e)return;if(e.bucket||delete e.bucket,!["data","public","forge-bazaar","forgevtt","s3"].includes(e.source))return void ui.notifications.warn(`${e.source} is not a supported source.`);const t=game.settings.get(i.Do,"indexer").indexDirs;t.find((t=>t.source===e.source&&t.target===e.target&&t.bucket==e.bucket))||(t.push(e),this._updateIndexerSettings({indexDirs:t}))}))}async _onDeleteDirectory(e){const t=$(e.target).closest(".directory"),s=t.find(".source").val(),a=t.find(".target").val(),n=t.find(".bucket").val()||null,o=game.settings.get(i.Do,"indexer").indexDirs.filter((e=>!(e.source===s&&e.target===a&&e.bucket==n)));this._updateIndexerSettings({indexDirs:o})}async _updateIndexerSettings(e={},t=!0){const s=game.settings.get(i.Do,"indexer");foundry.utils.mergeObject(s,e),await game.settings.set(i.Do,"indexer",s),t&&await this.render()}async selectFolder(e){new FilePicker({type:"folder",activeSource:"data",current:"",callback:(t,s)=>{const i={target:s.result.target,source:s.activeSource,bucket:s.result.bucket};i.bucket||delete i.bucket,e(i)}}).render(!0)}async _updateObject(e,t){FileIndexer.buildIndex()}}},624:(e,t,s)=>{s.d(t,{P6:()=>MassEditPresets,pB:()=>_});var i=s(998),a=s(439),n=s(739);class TrackerDialog extends Dialog{constructor(e,{total:t,cancelCallback:s,left:i,top:a}){super(e,{left:i,top:a}),this.count=0,this.total=t,this.cancelCallback=s}incrementCount(){this.count++,this.element?.find(".count").html(this.count)}stop(){this.close(!0)}get active(){return this._state===Application.RENDER_STATES.RENDERED||this._state===Application.RENDER_STATES.RENDERING}}async function o({title:e="Progress",cancelCallback:t,total:s}={}){if(!s)return;const i=new TrackerDialog({title:e,content:`\n<div>\n<div  style="display: block; text-align: center; padding: 5px;"><i class="fas fa-circle-notch fa-spin fa-3x"></i></div>\n    <p style="text-align: center;"><span class="count">count</span>/${s}</p>\n</div>`,buttons:{cancel:{icon:'<i class="fas fa-stop"></i>',label:"Stop/Cancel",callback:()=>{t?.()}}},default:"cancel"},{total:s,cancelCallback:t,left:50,top:50});return await i._render(!0),i}function r(e){return e.presets?e.presets.length+e.children.reduce((function(e,t){return e+r(t)}),0):e.contents.length+e.children.reduce((function(e,t){return e+r(t.folder)}),0)}var l=s(241),c=s(860);class SortingHelpersFixed{static performIntegerSort(e,{target:t=null,siblings:s=[],sortKey:i="sort",sortBefore:a}={}){void 0===a&&(a=(e[i]||0)>(t?.[i]||0)),(s=Array.from(s)).sort(((e,t)=>e[i]-t[i]));let n,o,r=a?s.length:0,l=t?s.findIndex((e=>e===t)):r;return[n,o]=a?this._sortBefore(s,l,i):this._sortAfter(s,l,i),0===s.length?[{target:e,update:{[i]:CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(o)&&null===n?[{target:e,update:{[i]:o-CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(n)&&null===o?[{target:e,update:{[i]:n+CONST.SORT_INTEGER_DENSITY}}]:Number.isFinite(n)&&Number.isFinite(o)&&Math.abs(o-n)>1?[{target:e,update:{[i]:Math.round(.5*(n+o))}}]:(s.splice(l+(a?0:1),0,e),s.map(((e,t)=>({target:e,update:{[i]:(t+1)*CONST.SORT_INTEGER_DENSITY}}))))}static performIntegerSortMulti(e,{target:t=null,siblings:s=[],sortKey:i="sort",sortBefore:a}={}){let n=e[0];void 0===a&&(a=(n[i]||0)>(t?.[i]||0)),(s=Array.from(s)).sort(((e,t)=>e[i]-t[i]));let o,r,l=a?s.length:0,c=t?s.findIndex((e=>e===t)):l;if([o,r]=a?this._sortBefore(s,c,i):this._sortAfter(s,c,i),0===s.length)return e.map(((e,t)=>({target:e,update:{[i]:CONST.SORT_INTEGER_DENSITY*(t+1)}})));if(Number.isFinite(r)&&null===o)return e.map(((t,s)=>({target:t,update:{[i]:r-CONST.SORT_INTEGER_DENSITY*(e.length-s+1)}})));if(Number.isFinite(o)&&null===r)return e.map(((e,t)=>({target:e,update:{[i]:o+CONST.SORT_INTEGER_DENSITY*(t+1)}})));if(Number.isFinite(o)&&Number.isFinite(r)&&Math.abs(r-o)>e.length){let t=Math.floor(1/(e.length+1)*Math.abs(r-o));return 0===t&&(t=1),o=Math.min(r,o),e.map(((e,s)=>({target:e,update:{[i]:o+t*(s+1)}})))}return s.splice(c+(a?0:1),0,...e),s.map(((e,t)=>({target:e,update:{[i]:(t+1)*CONST.SORT_INTEGER_DENSITY}})))}static _sortBefore(e,t,s){let i=e[t]?e[t][s]:null;return[e[t-1]?e[t-1][s]:null,i]}static _sortAfter(e,t,s){return[e[t]?e[t][s]:null,e[t+1]?e[t+1][s]:null]}}var d=s(120),u=s(652),m=s(627),h=s(638),g=s(671),p=s(596);class TagSelector extends FormApplication{constructor(e){const t=TagSelector.defaultOptions;super({},{left:e.position.left-t.width-5,top:e.position.top}),this.presetsApp=e}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"tag-selector",classes:["mass-edit-dark-window","mass-edit-window-fill"],template:`modules/${p.Do}/templates/preset/tagSelector.html`,resizable:!0,minimizable:!0,width:200,height:500})}get title(){return"Tag Selector"}async close(e={}){return this.presetsApp._tagSelector=null,super.close(e)}async getData(e={}){const t=this.getTagsOfRendered(),s=this.getSearchedTags();let i=[],a=[];return t.forEach(((e,t)=>{const n={name:t,count:e};s.includes(t)?a.push(n):i.push(n)})),i=i.sort(((e,t)=>t.count-e.count)),a=a.sort(((e,t)=>t.count-e.count)),{tags:i,activeTags:a}}activateListeners(e){super.activateListeners(e),e.on("click",".tag",this._onClickTag.bind(this))}getTagsOfRendered(){const e=new Map;return this.presetsApp.tree.folders.forEach((t=>this._getFolderTags(t,e))),this.presetsApp.tree.extFolders.forEach((t=>this._getFolderTags(t,e))),this.presetsApp.tree.presets.forEach((t=>this._getPresetTags(t,e))),e}getSearchedTags(){return(MassEditPresets.lastSearch??"").split(" ").filter((e=>e.startsWith("#"))).map((e=>e.substring(1)))}_getFolderTags(e,t){if(e.render){for(const s of e.children)this._getFolderTags(s,t);for(const s of e.presets)this._getPresetTags(s,t)}}_getPresetTags(e,t){if(e.visible)for(const s of e.tags)t.set(s,(t.get(s)??0)+1)}_onClickTag(e){const t="#"+$(e.currentTarget).find("span").first().text(),s=this.presetsApp.element.find(".header-search input");let i=s.val();$(e.currentTarget).hasClass("active")?i=i.split(" ").filter((e=>e!==t)).filter(Boolean).join(" "):(!i.endsWith(" ")&&i.length&&(i+=" "),i+=t),s.val(i).trigger("input")}}var f=s(575);const y={manual:{get tooltip(){return(0,d.kg)("SIDEBAR.SortModeManual",!1)},icon:'<i class="fa-solid fa-arrow-down-short-wide"></i>'},alphabetical:{get tooltip(){return(0,d.kg)("SIDEBAR.SortModeAlpha",!1)},icon:'<i class="fa-solid fa-arrow-down-a-z"></i>'}},b={p:{get tooltip(){return(0,d.kg)("presets.search-presets")},icon:'<i class="fas fa-search"></i>'},pf:{get tooltip(){return(0,d.kg)("presets.search-presets-folders")},icon:'<i class="fa-solid fa-folder-magnifying-glass"></i>'}};class MassEditPresets extends FormApplication{static objectHover=!1;static lastSearch;constructor(e,t,s,i={}){if(!i.preventPositionOverride&&MassEditPresets.previousPosition&&(i={...i,...MassEditPresets.previousPosition}),super({},i),this.callback=t,this.dragType=null,this.dragData=null,this.draggedElements=null,!e&&p.TA.includes(s)){const e=game.settings.get(p.Do,"presetDocLock");this.documentName=e||s}else this.configApp=e,this.documentName=s||this.configApp.documentName}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"mass-edit-presets",classes:["sheet","mass-edit-dark-window","mass-edit-window-fill"],template:`modules/${p.Do}/templates/preset/presets.html`,resizable:!0,minimizable:!0,width:377,height:900,scrollY:[".item-list"]})}get title(){let e=(0,d.kg)("common.presets");return p.TA.includes(this.documentName)?e+=` [${(0,d.kg)("common.placeable")}]`:e+=` [${this.documentName}]`,e}async getData(e){const t=super.getData(e);await getTemplate(`modules/${p.Do}/templates/preset/preset.html`,"me-preset"),await getTemplate(`modules/${p.Do}/templates/preset/presetFolder.html`,"me-preset-folder"),await getTemplate(`modules/${p.Do}/templates/preset/presetsContent.html`,"me-presets-content");const s=game.settings.get(p.Do,"presetExtComp"),i=game.settings.get(p.Do,"presetVirtualDir");return this.tree=await u.A0.getTree(this.documentName,{externalCompendiums:s,virtualDirectory:i,setFormVisibility:!0}),this._tagSelector?.render(!0),t.presets=this.tree.presets,t.folders=this.tree.folders,t.extFolders=this.tree.extFolders.length?this.tree.extFolders:null,t.createEnabled=Boolean(this.configApp),t.isPlaceable=p.Me.includes(this.documentName)||"ALL"===this.documentName||"FAVORITES"===this.documentName,t.allowDocumentSwap=p.TA.includes(this.documentName)&&!this.configApp,t.docLockActive=game.settings.get(p.Do,"presetDocLock")===this.documentName,t.layerSwitchActive=game.settings.get(p.Do,"presetLayerSwitch"),t.scaling=game.settings.get(p.Do,"presetScaling"),t.extCompActive=s,t.virtDirActive=i,t.sortMode=y[game.settings.get(p.Do,"presetSortMode")],t.searchMode=b[game.settings.get(p.Do,"presetSearchMode")],t.displayDragDropMessage=t.allowDocumentSwap&&!(this.tree.presets.length||this.tree.folders.length||t.extFolders),t.lastSearch=MassEditPresets.lastSearch,t.docs=p.TA.reduce(((e,t)=>({...e,[t]:g.aK[t]})),{}),t.documents=p.TA,t.currentDocument=this.documentName,t.callback=Boolean(this.callback),t}activateListeners(e){super.activateListeners(e);const t=e.closest(".window-content").find(".drag-drop-overlay");e.closest(".window-content").on("mouseover",(e=>{canvas.activeLayer?.preview?.children.some((e=>e._original?.mouseInteractionManager?.isDragging))?(t.show(),MassEditPresets.objectHover=!0):(t.hide(),MassEditPresets.objectHover=!1)})).on("mouseout",(()=>{t.hide(),MassEditPresets.objectHover=!1})),e.find(".create-preset").on("click",(()=>{const e=canvas.activeLayer.controlled;e.length&&p.Me.includes(e[0].document.documentName)&&this.dropPlaceable(e)}));const s=e.find(".item-list");e.on("click",".item",(e=>{x(e,s),this._activeBrush&&this._toggleBrush(e)})),e.on("mouseenter",".item",(e=>{$(e.currentTarget).find(".tags, .display-hover").addClass("show"),this._playPreview(e)})),e.on("mouseleave",".item",(e=>{$(e.currentTarget).find(".tags, .display-hover").removeClass("show"),this._endPreview(e)})),e.on("dragstart",".item",(e=>{this.dragType="item";const t=$(e.target).closest(".item");t.hasClass("selected")||(s.find(".item.selected").removeClass("selected").removeClass("last-selected"),t.addClass("selected").addClass("last-selected"));const i=[];s.find(".item.selected").each((function(){i.push($(this).data("uuid"))})),this.dragData=i,this.draggedElements=s.find(".item.selected"),e.originalEvent.dataTransfer&&(e.originalEvent.dataTransfer.clearData(),e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({uuids:i})))})),e.on("dragleave",".item.sortable",(e=>{$(e.target).closest(".item").removeClass("drag-bot").removeClass("drag-top")})),e.on("dragover",".item.sortable",(e=>{if("item"!==this.dragType)return;if(!this.draggedElements.hasClass("sortable"))return;const t=$(e.target).closest(".item");if(t.hasClass("selected"))return;var s=e.currentTarget.getBoundingClientRect();let i=e.offsetY/s.height;i<.2?t.removeClass("drag-bot").addClass("drag-top"):i>.8&&t.removeClass("drag-top").addClass("drag-bot")})),e.on("drop",".item.sortable",(e=>{if(MassEditPresets.lastSearch?.length)return;if("item"!==this.dragType)return;if(!this.draggedElements.hasClass("sortable"))return;const t=$(e.target).closest(".item"),i=t.hasClass("drag-top");t.removeClass("drag-bot").removeClass("drag-top");const a=this.dragData;a&&(t.hasClass("selected")||((i?a:a.reverse()).forEach((e=>{const a=s.find(`.item[data-uuid="${e}"]`);a&&(i?a.insertBefore(t):a.insertAfter(t))})),this._onItemSort(a,t.data("uuid"),{before:i,folderUuid:t.closest(".folder").data("uuid")}))),this.dragType=null,this.dragData=null,this.draggedElements=null})),e.on("dragend",".item",(e=>{(function(e){let t=!1;ui.sidebar?.element?.length&&(t=k(e.pageX,e.pageY,ui.sidebar.element));t||(t=k(e.pageX,e.pageY,$(e.target).closest(".window-app")));return t})(e)||this._onPresetDragOut(e)})),e.on("click",".folder > header",(e=>this._folderToggle($(e.target).closest(".folder")))),e.on("dragstart",".folder.sortable",(e=>{if("item"==this.dragType)return;this.dragType="folder";const t=[$(e.target).closest(".folder").data("uuid")];$(e.target).find(".folder").each((function(){t.push($(this).data("uuid"))})),this.dragData=t})),e.on("dragleave",".folder.sortable header",(e=>{$(e.target).closest(".folder").removeClass("drag-mid").removeClass("drag-top")})),e.on("dragover",".folder.sortable header",(e=>{const t=$(e.target).closest(".folder");if("folder"===this.dragType){if(this.dragData.includes(t.data("uuid")))return;var s=e.currentTarget.getBoundingClientRect();e.offsetY/s.height<.2?t.removeClass("drag-mid").addClass("drag-top"):t.removeClass("drag-top").addClass("drag-mid")}else"item"===this.dragType&&this.draggedElements.hasClass("sortable")&&t.addClass("drag-mid")})),e.on("drop",".folder.sortable header",(t=>{if(this._foundryDrop(t))return;if(MassEditPresets.lastSearch?.length)return;const i=$(t.target).closest(".folder");if("folder"===this.dragType){const t=i.hasClass("drag-top");i.removeClass("drag-mid").removeClass("drag-top");const s=this.dragData;if(s){if(s.includes(i.data("uuid")))return;const a=s[0],n=e.find(`.folder[data-uuid="${a}"]`);n&&(t?n.insertBefore(i):i.find(".folder-items").first().append(n),t?this._onFolderSort(a,i.data("uuid"),{inside:!1,folderUuid:i.parent().closest(".folder").data("uuid")??null}):this._onFolderSort(a,null,{inside:!0,folderUuid:i.data("uuid")}))}}else if("item"===this.dragType&&this.draggedElements.hasClass("sortable")){i.removeClass("drag-mid");const e=this.dragData,t=i.children(".preset-items");e?.forEach((e=>{const i=s.find(`.item[data-uuid="${e}"]`);i.length&&t.append(i)})),this._onItemSort(e,null,{folderUuid:i.data("uuid")})}this.dragType=null,this.dragData=null,this.draggedElements=null})),e.on("drop",".top-level-preset-items",(t=>{if(!this._foundryDrop(t)&&!MassEditPresets.lastSearch?.length){if("folder"===this.dragType){const t=e.find(".top-level-folder-items"),s=e.find(`.folder[data-uuid="${this.dragData[0]}"]`);t.append(s),this._onFolderSort(this.dragData[0],null)}else if("item"===this.dragType&&this.draggedElements.hasClass("sortable")){const t=this.dragData,i=e.find(".top-level-preset-items");t?.forEach((e=>{const t=s.find(`.item[data-uuid="${e}"]`);t.length&&i.append(t)})),this._onItemSort(t,null)}this.dragType=null,this.dragData=null,this.draggedElements=null}})),e.on("click",".toggle-sort",this._onToggleSort.bind(this)),e.on("click",".toggle-doc-lock",this._onToggleLock.bind(this)),e.on("click",".toggle-ext-comp",this._onToggleExtComp.bind(this)),e.on("click",".toggle-virtual-dir",this._onToggleVirtDir.bind(this)),e.on("click",".toggle-scaling",this._onToggleScaling.bind(this)),e.on("click",".toggle-layer-switch",this._onToggleLayerSwitch.bind(this)),e.on("click",".document-select",this._onDocumentChange.bind(this)),e.on("dblclick",".item",this._onDoubleClickPreset.bind(this)),e.on("click",".create-folder",this._onCreateFolder.bind(this)),e.on("click",".preset-create",this._onPresetCreate.bind(this)),e.on("click",".preset-update a",this._onPresetUpdate.bind(this)),e.on("click",".preset-favorite",this._onToggleFavorite.bind(this)),e.on("click",".preset-callback",this._onApplyPreset.bind(this)),e.on("click",".tagSelector",this._onToggleTagSelector.bind(this));const i=e.find(".header-search input");i.on("input",(e=>this._onSearchInput(e))),(MassEditPresets.lastSearch?.length??0)>=2&&i.trigger("input"),e.on("click",".toggle-search-mode",(e=>{this._onToggleSearch(e,i)})),this._contextMenu(e.find(".item-list"))}async _playPreview(e){clearTimeout(this._previewTimeout),this._previewTimeout=setTimeout((()=>this._renderPlayPreview(e)),200)}async _renderPlayPreview(e){await this._endPreview();const t=$(e.currentTarget).data("uuid");if(!t)return;const s=await u.A0.get(t,{full:!1});if("AmbientSound"===s.documentName){const e=(0,d.JK)(s.img)?s.img:(await s.load()).data[0]?.path;if(!e)return;(await game.audio.play(e))._mePreview=!0}else if("Tile"===s.documentName&&"icons/svg/video.svg"===s.thumbnail){await s.load();const e=s.data[0].texture?.src;if(e&&(0,f.cZ)(e)){this._videoPreviewElement?this._videoPreviewElement.empty():(this._videoPreviewElement=$('<div class="meVideoPreview"></div>'),$(document.body).append(this._videoPreviewElement));const t=visualViewport.width/1024;this._videoPreviewElement.append(`<video width="${320*t}" height="${240*t}" autoplay loop><source src="${e}" type="video/${e.split(".").pop().toLowerCase()}"></video>`)}}}async _endPreview(){clearTimeout(this._previewTimeout),game.audio.playing.forEach((e=>{e._mePreview&&e.stop()})),this._videoPreviewElement&&(this._videoPreviewElement.remove(),this._videoPreviewElement=null)}_folderToggle(e){const t=e.data("uuid"),s=this.tree.allFolders.get(t);s.expanded?this._folderCollapse(e,s):this._folderExpand(e,s)}async _folderExpand(e,t){if(f.cm.setExpanded(t.uuid,!0),t.expanded=!0,e.find(".folder-items").length)e.removeClass("collapsed"),e.find("header .folder-icon").first().removeClass("fa-folder-closed").addClass("fa-folder-open");else{let s=await renderTemplate(`modules/${p.Do}/templates/preset/presetFolder.html`,{folder:t,createEnabled:Boolean(this.configApp),callback:Boolean(this.callback),sortable:fromUuidSync(t.uuid)?.pack===u.A0.workingPack});e.replaceWith(s)}}_folderCollapse(e,t){e.addClass("collapsed"),e.find("header .folder-icon").first().removeClass("fa-folder-open").addClass("fa-folder-closed"),f.cm.setExpanded(t.uuid,!1),t.expanded=!1}_foundryDrop(e){const t=TextEditor.getDragEventData(e.originalEvent);if(!isEmpty(t)){if("Folder"===t.type){const e=fromUuidSync(t.uuid);return"Actor"===e.type&&(!this._importTracker?.active&&(o({title:"Converting Actors",total:r(e)}).then((async t=>{this._importTracker=t,await this._importActorFolder(e,null,{keepId:!0}),this._importTracker?.stop()})),!0))}return"Actor"===t.type&&(u.af.createPresetFromActorUuid(t.uuid,{keepId:!0}).then((e=>{e&&this.render(!0)})),!0)}return!1}async _importActorFolder(e,t=null,s={}){let i=new Folder.implementation({_id:s.keepId?e.id:null,name:e.name,type:"JournalEntry",sorting:e.sorting,folder:t,color:e.color??"#000000",flags:{[p.Do]:{types:["ALL","Token"]}}},{pack:u.A0.workingPack});i=await Folder.create(i,{pack:i.pack,keepId:s.keepId});for(const t of e.children){if(!this._importTracker?.active)break;await this._importActorFolder(t.folder,i.id,s)}for(const t of e.contents){if(!this._importTracker?.active)break;await u.af.createPresetFromActorUuid(t.uuid,{folder:i.id,keepId:s.keepId}),this._importTracker.incrementCount()}this.render(!0)}async _onDoubleClickPreset(e){l._8.close();const t=$(e.target).closest(".item").data("uuid");if(!t)return;let s=await u.af.getPreset({uuid:t});s&&("Scene"===s.documentName&&(ui.notifications.info(`Mass Edit: ${(0,d.kg)("common.apply")} [${s.name}]`),(0,d.XK)(s)),p.Me.includes(s.documentName)&&(ui.notifications.info(`Mass Edit: ${(0,d.kg)("presets.spawning")} [${s.name}]`),this._setInteractivityState(!1),await u.af.spawnPreset({preset:s,coordPicker:!0,taPreview:"ALL",layerSwitch:game.settings.get(p.Do,"presetLayerSwitch"),scaleToGrid:game.settings.get(p.Do,"presetScaling"),center:!0}),this._setInteractivityState(!0)))}_setInteractivityState(e){e?this.element.removeClass("inactive"):this.element.addClass("inactive")}_contextMenu(e){ContextMenu.create(this,e,".item",this._getItemContextOptions(),{hookName:"MassEditPresetContext",onOpen:this._onRightClickPreset.bind(this)}),ContextMenu.create(this,e,".folder header",this._getFolderContextOptions(),{hookName:"MassEditFolderContext"})}_getItemContextOptions(){return[{name:(0,d.kg)("CONTROLS.CommonEdit",!1),icon:'<i class="fas fa-edit"></i>',condition:e=>g.k.isEditable(e.data("uuid")),callback:e=>this._onEditSelectedPresets(e)},{name:"Brush",icon:'<i class="fa-solid fa-paintbrush"></i>',condition:e=>p.Me.includes(e.data("doc-name")),callback:e=>this._onActivateBrush(e)},{name:(0,d.kg)("presets.open-journal"),icon:'<i class="fas fa-book-open"></i>',condition:e=>!e.hasClass("virtual"),callback:e=>this._onOpenJournal(e)},{name:(0,d.kg)("presets.apply-to-selected"),icon:'<i class="fas fa-arrow-circle-right"></i>',condition:e=>p.Me.includes(e.data("doc-name"))&&canvas.getLayerByEmbeddedName(e.data("doc-name")).controlled.length,callback:e=>this._onApplyToSelected(e)},{name:(0,d.kg)("Duplicate",!1),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>g.k.isEditable(e.data("uuid"))&&!e.hasClass("virtual"),callback:e=>this._onCopySelectedPresets(null,{keepFolder:!0,keepId:!1})},{name:(0,d.kg)("presets.copy-source-to-clipboard"),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>e.data("uuid").startsWith("virtual@"),callback:e=>game.clipboard.copyPlainText(e.data("uuid").substring(8))},{name:(0,d.kg)("presets.copy-to-clipboard"),icon:'<i class="fa-solid fa-copy"></i>',condition:e=>1===$(this.form).find(".item-list").find(".item.selected").length,callback:e=>this._onCopyPresetToClipboard()},{name:"Copy UUID",icon:'<i class="fa-solid fa-passport"></i>',callback:e=>this._onCopyUUID(e)},{name:(0,d.kg)("presets.export-as-json"),icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportSelectedPresets()},{name:(0,d.kg)("presets.export-to-compendium"),icon:'<i class="fas fa-file-export fa-fw"></i>',callback:e=>this._onExportSelectedPresetsToComp()},{name:(0,d.kg)("CONTROLS.CommonDelete",!1),icon:'<i class="fas fa-trash fa-fw"></i>',condition:e=>g.k.isEditable(e.data("uuid"))&&!e.hasClass("virtual"),callback:e=>this._onDeleteSelectedPresets(e)}]}_getFolderContextOptions(){return[{name:"Edit",icon:'<i class="fas fa-edit"></i>',condition:e=>{const t=this.tree.allFolders.get(e.closest(".folder").data("uuid"));return!t.virtual||t instanceof u.dH},callback:e=>this._onFolderEdit(e)},{name:"Save Index",icon:'<i class="fas fa-file-search"></i>',condition:e=>this.tree.allFolders.get(e.closest(".folder").data("uuid")).indexable,callback:e=>{m.WX.saveFolderToCache(this.tree.allFolders.get(e.closest(".folder").data("uuid")))}},{name:"Export to Compendium",icon:'<i class="fas fa-file-export fa-fw"></i>',condition:e=>!(this.tree.allFolders.get(e.closest(".folder").data("uuid"))instanceof u.y1),callback:e=>{this._onExportFolder(e.closest(".folder").data("uuid"))}},{name:(0,d.kg)("FOLDER.Remove",!1),icon:'<i class="fas fa-trash fa-fw"></i>',condition:e=>u._P.isEditable(e.closest(".folder").data("uuid")),callback:e=>this._onFolderDelete(e.closest(".folder").data("uuid"))},{name:(0,d.kg)("FOLDER.Delete",!1),icon:'<i class="fas fa-dumpster"></i>',condition:e=>u._P.isEditable(e.closest(".folder").data("uuid")),callback:e=>this._onFolderDelete(e.closest(".folder").data("uuid"),{deleteAll:!0})},{name:"Randomize Child Folder Colors",icon:'<i class="fas fa-dice"></i>',condition:()=>CONFIG.debug.MassEdit,callback:e=>(0,f.Li)(e.closest(".folder").data("uuid"),this.tree,(()=>this.render(!0)))}]}async _onExportFolder(e){let{pack:t,keepId:s}=await new Promise((e=>w(e,{exportTo:!0,keepIdSelect:!0})));if(t&&!this._importTracker?.active){this.tree.allFolders.get(e)&&(this._importTracker=await o({title:"Exporting Folder",total:r(this.tree.allFolders.get(e))}),await this._onCopyFolder(e,null,t,!0,s),this._importTracker?.stop())}}async _onCopyFolder(e,t=null,s,i=!0,a=!0){s||(s=u.A0.workingPack);const n=this.tree.allFolders.get(e),o=await fromUuid(e);if(n){let e;e=o?o.flags[p.Do]?.types??["ALL"]:["ALL"];const r={_id:a?n.id:null,name:n.name,color:n.color,sorting:n.sorting,folder:t,flags:{[p.Do]:{types:e}},type:"JournalEntry"},l=await Folder.create(r,{pack:s,keepId:a});for(const e of n.presets){if(!this._importTracker?.active)break;const t=(await e.load()).clone();t.folder=l.id,a||(t.id=foundry.utils.randomID()),await u.A0.set(t,s),this._importTracker?.incrementCount()}for(const e of n.children){if(!this._importTracker?.active)break;await this._onCopyFolder(e.uuid,l.id,s,!1,a)}i&&this.render(!0)}}async _onExportSelectedPresetsToComp(){let{pack:e,keepId:t}=await new Promise((e=>w(e,{exportTo:!0,keepIdSelect:!0})));e&&this._onCopySelectedPresets(e,{keepId:t})}async _onCopySelectedPresets(e,{keepFolder:t=!1,keepId:s=!0}={}){const[i,a]=await this._getSelectedPresets();for(const a of i){const i=a.clone();t||(i.folder=null),s||(i.id=foundry.utils.randomID()),await u.A0.set(i,e)}i.length&&this.render(!0)}async _onCopyPresetToClipboard(){const[e,t]=await this._getSelectedPresets();e.length&&(0,a.lW)(e[0])}async _getSelectedPresets({editableOnly:e=!1,virtualOnly:t=!1,full:s=!0}={}){const i=[];let a=".item.selected";t&&(a+=".virtual");let n=this.element.find(".item-list").find(a);e&&(n=n.filter((function(){return g.k.isEditable($(this).data("uuid"))}))),n.each((function(){const e=$(this).data("uuid");i.push(e)}));const o=[];for(const e of i){const t=await u.A0.get(e,{full:s});t&&o.push(t)}return[o,n]}async _onExportSelectedPresets(){const[e,t]=await this._getSelectedPresets();v(e)}async _onEditSelectedPresets(e){const[t,s]=await this._getSelectedPresets({virtualOnly:e.hasClass("virtual"),editableOnly:!0});if(t.length){const s=e.offset();s.top+=e.height(),this._editPresets(t,s)}}async _onDeleteSelectedPresets(e){const[t,s]=await this._getSelectedPresets({editableOnly:!0,full:!1});if(t.length){(0===t.length||await Dialog.confirm({title:`${(0,d.kg)("common.delete")} [ ${t.length} ]`,content:`<p>${(0,d.kg)("AreYouSure",!1)}</p><p>${(0,d.zS)("presets.delete-presets-warn",{count:t.length})}</p>`}))&&(await u.A0.delete(t),s.remove())}}async _onOpenJournal(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});t.forEach((e=>e.openJournal()))}_onCopyUUID(e){e.data("uuid"),game.clipboard.copyPlainText(e.data("uuid")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:e.attr("name"),type:"uuid",id:e.data("uuid")}))}async _onApplyToSelected(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});if(!t.length)return;const i=new Set;for(const e of t)if(i.add(e.documentName),i.size>1)return void ui.notifications.warn((0,d.kg)("presets.apply-to-selected-warn"));const n=canvas.getLayerByEmbeddedName(t[0].documentName).controlled;if(n.length)for(const e of t)(0,a.B0)(n,e,!1,!0)}async _onCreateFolder(e){const t=[];"ALL"===this.documentName?t.push("ALL"):p.TA.includes(this.documentName)?t.push("ALL",this.documentName):t.push(this.documentName);const s=new Folder.implementation({name:Folder.defaultName(),type:"JournalEntry",sorting:"m",flags:{[p.Do]:{types:t}}},{pack:u.A0.workingPack});await new Promise((e=>{new PresetFolderConfig(s,{resolve:e}).render(!0)})),this.render(!0)}async _onFolderEdit(e){const t=$(e).closest(".folder").data("uuid"),s=this.tree.allFolders.get(t);let i;i=s instanceof u.dH?new Folder.implementation({_id:s.id,name:s.name,type:"JournalEntry",color:s.color,sorting:s.sorting},{pack:s.uuid}):await fromUuid($(e).closest(".folder").data("uuid")),new Promise((t=>{const a={resolve:t,...e.offset(),folder:s};a.top+=e.height(),new PresetFolderConfig(i,a).render(!0)})).then((()=>this.render(!0)))}async _onFolderDelete(e,{render:t=!0,deleteAll:s=!1}={}){const i=this.tree.allFolders.get(e);if(i){let a;a=s?await Dialog.confirm({title:`${(0,d.kg)("FOLDER.Delete",!1)}: ${i.name}`,content:`<div style="color:red;"><h4>${(0,d.kg)("AreYouSure",!1)}</h4><p>${(0,d.kg)("FOLDER.DeleteWarning",!1)}</p></div>`}):await Dialog.confirm({title:`${(0,d.kg)("FOLDER.Remove",!1)}: ${i.name}`,content:`<h4>${(0,d.kg)("AreYouSure",!1)}</h4><p>${(0,d.kg)("FOLDER.RemoveWarning",!1)}</p>`}),a&&(await u.A0.deleteFolder(e,s),t&&this.render(!0))}}_onSearchInput(e){clearTimeout(this._searchTimer),this._searchTimer=setTimeout((()=>this._onSearch(e)),250)}async _onSearch(e){let t=e.target.value,s=MassEditPresets.lastSearch||"";if(MassEditPresets.lastSearch=t,s.length>=2&&t.length<2)return $(e.target).removeClass("active"),this._resetSearchState(),void this._renderContent();if(t.length<2)return;let i=e.target.value.trim().toLowerCase().split(" ").filter((e=>e.length>=2));if(!i.length)return;$(e.target).addClass("active");const a=i.filter((e=>e.startsWith("#"))).map((e=>e.substring(1)));i=i.filter((e=>!e.startsWith("#"))),this._searchFoundPresets=[],this.tree.folders.forEach((e=>this._searchFolder(i,a,e))),this.tree.extFolders.forEach((e=>this._searchFolder(i,a,e))),this.tree.presets.forEach((e=>this._searchPreset(i,a,e))),this._renderContent()}_searchFolder(e,t,s,i=!1){const a=s.name.toLowerCase();let n=!t.length&&e.every((e=>a.includes(e))),o=!1;for(const a of s.children)this._searchFolder(e,t,a,n||i)&&(o=!0);let r=!1;for(const a of s.presets)this._searchPreset(e,t,a,n||i)&&(r=!0);const l=n||o||r;return s.expanded=o||r,s.render=l||i,l}_searchPreset(e,t,s,i=!1){if(!s._visible)return!1;const a=s.name.toLowerCase();return this._searchFoundPresets.length<1001&&e.every((e=>a.includes(e)||s.tags.includes(e)))&&t.every((e=>s.tags.includes(e)))?(s._render=!0,this._searchFoundPresets.push(s),s._render):(s._render=i,!1)}_resetSearchState(){this._searchFoundPresets=[],this.tree.folders.forEach((e=>this._resetSearchStateFolder(e))),this.tree.extFolders.forEach((e=>this._resetSearchStateFolder(e))),this.tree.presets.forEach((e=>this._resetSearchStatePreset(e)))}_resetSearchStateFolder(e){e.expanded=f.cm.expanded(e.uuid),e.render=!0,e.children.forEach((e=>this._resetSearchStateFolder(e))),e.presets.forEach((e=>this._resetSearchStatePreset(e)))}_resetSearchStatePreset(e){e._render=!0}async _renderContent(){let e;e="p"===game.settings.get(p.Do,"presetSearchMode")?{callback:Boolean(this.callback),presets:this._searchFoundPresets,folders:[],createEnabled:Boolean(this.configApp),extFolders:null}:{callback:Boolean(this.callback),presets:this.tree.presets,folders:this.tree.folders,createEnabled:Boolean(this.configApp),extFolders:this.tree.extFolders.length?this.tree.extFolders:null};const t=await renderTemplate(`modules/${p.Do}/templates/preset/presetsContent.html`,e);this.element.find(".item-list").html(t),this._tagSelector?.render(!0)}async _onFolderSort(e,t,{inside:s=!0,folderUuid:i=null}={}){let a,n=this.tree.allFolders.get(e),o=this.tree.allFolders.get(t);a=i?this.tree.allFolders.get(i).children:this.tree.folders;const r=[];for(const t of a)t.uuid!==e&&r.push(t);const l=SortingHelpersFixed.performIntegerSort(n,{target:o,siblings:r,sortBefore:!0});if(l.length){const e=[];l.forEach((t=>{const s=t.update;s._id=t.target.id,s.folder=this.tree.allFolders.get(i)?.id??null,e.push(s),t.target.sort=s.sort})),await Folder.updateDocuments(e,{pack:u.A0.workingPack})}this.render(!0)}async _onItemSort(e,t,{before:s=!0,folderUuid:i=null}={}){const a=new Set(e),n=this.tree.allPresets.filter((e=>a.has(e.uuid)));let o,r=this.tree.allPresets.find((e=>e.uuid===t));o=i?this.tree.allFolders.get(i).presets:this.tree.presets;const l=[];for(const e of o)a.has(e.uuid)||l.push(e);const c=SortingHelpersFixed.performIntegerSortMulti(n,{target:r,siblings:l,sortBefore:s});if(c.length){const e=[];c.forEach((t=>{const s=t.update;s._id=t.target.id,s.folder=this.tree.allFolders.get(i)?.id??null,e.push(s);const a=o.find((e=>e.id===s._id));a&&(a.folder=s.folder,a.sort=s.sort),t.target.sort=s.sort})),await u.A0.updatePresets(e)}this.render(!0)}async _onToggleSort(e){const t="manual"===game.settings.get(p.Do,"presetSortMode")?"alphabetical":"manual";await game.settings.set(p.Do,"presetSortMode",t),this.render(!0)}async _onToggleSearch(e,t){const s=$(e.target).closest(".toggle-search-mode"),i="p"===game.settings.get(p.Do,"presetSearchMode")?"pf":"p";await game.settings.set(p.Do,"presetSearchMode",i);const a=b[i];s.attr("data-tooltip",a.tooltip).html(a.icon),MassEditPresets.lastSearch&&t.trigger("input")}_onToggleLock(e){const t=$(e.target).closest(".toggle-doc-lock");let s=game.settings.get(p.Do,"presetDocLock"),i=this.documentName;i!==s?t.addClass("active"):(t.removeClass("active"),i=""),game.settings.set(p.Do,"presetDocLock",i)}_onToggleLayerSwitch(e){const t=$(e.currentTarget),s=!game.settings.get(p.Do,"presetLayerSwitch");s?t.addClass("active"):t.removeClass("active"),game.settings.set(p.Do,"presetLayerSwitch",s)}async _onToggleVirtDir(e){const t=$(e.currentTarget),s=!game.settings.get(p.Do,"presetVirtualDir");s?t.addClass("active"):t.removeClass("active"),await game.settings.set(p.Do,"presetVirtualDir",s),this.render(!0)}async _onToggleExtComp(e){const t=$(e.currentTarget),s=!game.settings.get(p.Do,"presetExtComp");s?t.addClass("active"):t.removeClass("active"),await game.settings.set(p.Do,"presetExtComp",s),this.render(!0)}async _onToggleScaling(e){const t=$(e.target).closest(".toggle-scaling"),s=!game.settings.get(p.Do,"presetScaling");s?t.addClass("active"):t.removeClass("active"),game.settings.set(p.Do,"presetScaling",s)}_onDocumentChange(e){const t=$(e.target).closest(".document-select").data("name");t!=this.documentName&&(this.documentName=t,game.settings.get(p.Do,"presetLayerSwitch")&&canvas.getLayerByEmbeddedName("Actor"===this.documentName?"Token":this.documentName)?.activate(),MassEditPresets.lastSearch&&(MassEditPresets.lastSearch="",this._resetSearchState()),this.render(!0))}async _onRightClickPreset(e){const t=$(e).closest(".item");t.hasClass("selected")||(t.closest(".item-list").find(".item.selected").removeClass("selected").removeClass("last-selected"),t.addClass("selected").addClass("last-selected"))}_editPresets(e,t={},s){t.callback=()=>this.render(!0),!("left"in t)&&s&&(t.left=s.originalEvent.x-PresetConfig.defaultOptions.width/2,t.top=s.originalEvent.y),new PresetConfig(e,t).render(!0)}async _onApplyPreset(e){if(this.callback){const t=$(e.target).closest(".item").data("uuid");this.callback(await u.A0.get(t))}}async _onToggleTagSelector(e){this._tagSelector?(this._tagSelector.close(!0),this._tagSelector=null):(this._tagSelector=new TagSelector(this),this._tagSelector.render(!0))}async _onPresetDragOut(e){const t=$(e.originalEvent.target).closest(".item").data("uuid"),s=await u.A0.get(t);if(!s)return;const i=function(e,t,s){const i=function(s){const i=s.position,a=i.left,n=i.top,o=Number.isNumeric(i.height)?i.height:$(s.element).height(),r=Number.isNumeric(i.width)?i.width:$(s.element).width();return e>a&&e<a+r&&t>n&&t<n+o},a=(0,n.bj)();return a&&a.documentName===s&&i(a)?a:null}(e.pageX,e.pageY,s.documentName);if(i)return void i._applyPreset(s);if("Scene"===s.documentName)return void(0,d.XK)(s);if(!p.Me.includes(s.documentName))return;let a,o,r;if(game.Levels3DPreview?._active){game.Levels3DPreview.interactionManager._onMouseMove(e,!0);const{x:t,y:s,z:i}=game.Levels3DPreview.interactionManager.canvas2dMousePosition;a=t,o=s,r=i}else{const[t,i]=[e.clientX,e.clientY],n=canvas.stage.worldTransform;a=(t-n.tx)/canvas.stage.scale.x,o=(i-n.ty)/canvas.stage.scale.y,"Token"!==s.documentName&&"Tile"!==s.documentName||(a-=canvas.dimensions.size/2,o-=canvas.dimensions.size/2)}u.af.spawnPreset({preset:s,x:a,y:o,z:r,mousePosition:!1,layerSwitch:game.settings.get(p.Do,"presetLayerSwitch"),scaleToGrid:game.settings.get(p.Do,"presetScaling")})}async _onToggleFavorite(e){const t=$(e.target).closest(".item"),s=t.data("uuid"),i=t.find(".preset-favorite i");if(s){const e=game.settings.get(p.Do,"presetFavorites");i.hasClass("fa-regular")?(i.removeClass("fa-regular").addClass("fa-solid"),e[s]=!0):(i.removeClass("fa-solid").addClass("fa-regular"),delete e[s]),game.settings.set(p.Do,"presetFavorites",e),g.k.favorites=e}}async _onActivateBrush(e){const[t,s]=await this._getSelectedPresets({editableOnly:!1});l._8.addPresets(t)}setPosition({left:e,top:t,width:s,height:i,scale:a}={}){if(!this.popOut&&!this.options.resizable)return;const n=this.element[0],o=this.position,r=this.popOut,l=window.getComputedStyle(n);if(null===a&&(a=1),a=a??o.scale??1,"auto"!==i&&"auto"!==this.options.height||(n.style.height="",i=null),!n.style.width||s){const t=s||n.offsetWidth,i=parseInt(l.minWidth)||(r?MIN_WINDOW_WIDTH:0),c=n.style.maxWidth||window.innerWidth/a;o.width=s=Math.clamp?Math.clamp(t,i,c):Math.clamped(t,i,c),n.style.width=`${s}px`,s*a+o.left>window.innerWidth&&(e=o.left)}if(s=n.offsetWidth,!n.style.height||i){const e=i||n.offsetHeight+1,s=parseInt(l.minHeight)||(r?MIN_WINDOW_HEIGHT:0),c=n.style.maxHeight||window.innerHeight/a;o.height=i=Math.clamp?Math.clamp(e,s,c):Math.clamped(e,s,c),n.style.height=`${i}px`,i*a+o.top>window.innerHeight+1&&(t=o.top-1)}let c,d;if(i=n.offsetHeight,r&&!this.posSet||Number.isFinite(e)){const t=s*a,i=Number.isFinite(e)?e:(window.innerWidth-t)/2,n=Math.max(window.innerWidth-t,0);o.left=e=Math.clamp?Math.clamp(i,0,n):Math.clamped(i,0,n),c=e}if(r&&!this.posSet||Number.isFinite(t)){const e=i*a,s=Number.isFinite(t)?t:(window.innerHeight-e)/2,n=Math.max(window.innerHeight-e,0);o.top=Math.clamp?Math.clamp(s,0,n):Math.clamped(s,0,n),d=o.top}let u="";if(a&&(o.scale=Math.max(a,0),u+=1===a?"":`scale(${a})`),(c||d)&&(this.posSet=!0,u+="translate("+c+"px,"+d+"px)"),u&&(n.style.transform=u),!this.options.preventPositionOverride){const{left:e,top:t,width:s,height:i}=this.position;MassEditPresets.previousPosition={left:e,top:t,width:s,height:i}}return o}async close(e={}){return MassEditPresets.objectHover=!1,this._tagSelector?.close(),this._endPreview(),super.close(e)}async _onPresetUpdate(e){const t=await u.A0.get($(e.target).closest(".item").data("uuid"));if(!t)return;const s=this.configApp instanceof ActiveEffectConfig?this._getActiveEffectFields():this.configApp.getSelectedFields();if(!s||foundry.utils.isEmpty(s))return void ui.notifications.warn((0,d.kg)("presets.warn-no-fields"));const a=foundry.utils.deepClone(this.configApp.randomizeFields||{}),n=foundry.utils.deepClone(this.configApp.addSubtractFields||{});"Token"===this.documentName&&i.f.correctDetectionModeOrder(s,a),t.update({data:s,randomize:a,addSubtract:n}),ui.notifications.info(`Preset "${t.name}" updated`)}async _onPresetCreate(e){const t=this.configApp instanceof ActiveEffectConfig?this._getActiveEffectFields():this.configApp.getSelectedFields();if(!t||foundry.utils.isEmpty(t))return void ui.notifications.warn((0,d.kg)("presets.warn-no-fields"));const s=new g.k({name:(0,d.kg)("presets.default-name"),documentName:this.documentName,data:t,addSubtract:this.configApp.addSubtractFields,randomize:this.configApp.randomizeFields});await u.A0.set(s),this.render(!0),this._editPresets([s],{isCreate:!0},e)}async dropPlaceable(e,t){const s=await u.af.createPreset(e),i=e[0].document.documentName;"ALL"!==this.documentName&&this.documentName!==i&&(this.documentName=i);const a={isCreate:!0};a.left=this.position.left+this.position.width+20,a.top=this.position.top;const n=h.sy.getLinkedDocuments(e.map((e=>e.document)));if(n.size){await new Promise((e=>{Dialog.confirm({title:"Attach Linked",content:`<p>Linked placeables have been detected [<b>${n.size}</b>].</p><p>Should they be included as <b>Attached</b>?</p>`,yes:()=>e(!0),no:()=>e(!1),defaultYes:!1})}))&&(a.attached=Array.from(n).map((e=>({documentName:e.documentName,data:(0,f.h)(e)}))))}this._editPresets(s,a,t),this.render(!0)}async actorToPreset(e){await u.af.createPreset(placeables)}_getActiveEffectFields(){return{changes:foundry.utils.deepClone(this.configApp.object.changes??[])}}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-change-compendium",icon:"fa-solid fa-gear",onclick:e=>this._onWorkingPackChange()}),e.unshift({label:"",class:"mass-edit-indexer",icon:"fas fa-archive",onclick:e=>this._onOpenIndexer()}),e.unshift({label:"",class:"mass-edit-export",icon:"fas fa-file-export",onclick:e=>this._onExport(e)}),e.unshift({label:"",class:"mass-edit-import",icon:"fas fa-file-import",onclick:e=>this._onImport(e)}),CONFIG.debug.MassEdit&&e.unshift({label:"Debug",class:"mass-edit-debug",icon:"fas fa-bug",onclick:e=>{console.log({index:game.packs.get(u.A0.workingPack).get(u.Xd)?.flags[p.Do]?.index,tree:this.tree})}}),e}async _onWorkingPackChange(){let e=await new Promise((e=>w(e,{})));e&&e!==u.A0.workingPack&&(await game.settings.set(p.Do,"workingPack",e),this.render(!0))}async _onOpenIndexer(){m.WX._buildingIndex?ui.notifications.warn("Index Build In-Progress. Wait for it to finish before attempting it again."):(new m.ME).render(!0)}async _onExport(){const e=game.packs.get(u.A0.workingPack);await e.getDocuments();v((await u.A0.getTree(null,{externalCompendiums:!1,virtualDirectory:!1})).allPresets)}async _onImport(){const e=await(0,c.h)();if(!e)return;let t=0;if("Array"===foundry.utils.getType(e))for(const s of e){if(!("documentName"in s))continue;if(!("data"in s)||foundry.utils.isEmpty(s.data))continue;const e=new g.k(s);e._pages=s.pages,await u.A0.set(e),t++}ui.notifications.info(`Mass Edit: ${(0,d.zS)("presets.imported",{count:t})}`),t&&this.render(!0)}async _updateObject(e,t){this.callback&&this.callback(await u.A0.get(e.submitter.data.id))}}async function v(e,t){if(e.length){for(const t of e)await t.load();e=e.map((e=>{const t=e.clone();return t.folder=null,t.uuid=null,t})),saveDataToFile(JSON.stringify(e,null,2),"text/json",(t??"mass-edit-presets")+".json")}}class PresetConfig extends FormApplication{static name="PresetConfig";constructor(e,t={}){super({},t),this.presets=e,this.callback=t.callback,this.isCreate=t.isCreate,this.attached=t.attached}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","mass-edit-dark-window"],template:`modules/${p.Do}/templates/preset/presetEdit.html`,width:360,height:"auto",tabs:[{navSelector:".sheet-tabs",contentSelector:".content",initial:"main"}]})}get id(){return"mass-edit-preset-edit"}get title(){const e=this.presets[0]instanceof g.JG?"File":"Preset";return this.presets.length>1?`${e}s [${this.presets.length}]`:`${e}: ${this.presets[0].name.substring(0,20)}${this.presets[0].name.length>20?"...":""}`}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"",class:"mass-edit-export",icon:"fas fa-file-export",onclick:e=>this._onExport(e)}),e}_onExport(){let e;1===this.presets.length&&(e="mass-edit-preset-"+this.presets[0].name.replace(" ","_").replace(/\W/g,"")),v(this.presets,e)}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t={};t.virtual=this.presets[0]instanceof g.JG,t.preset={},1===this.presets.length?(t.preset=foundry.utils.deepClone(this.presets[0].toJSON()),t.displayFieldDelete=!0,t.displayFieldModify=!0,t.attached=this.attached||t.preset.attached,t.attached&&(t.attached=t.attached.map((e=>{let t=e.documentName;return"Token"===e.documentName&&e.data.name&&(t+=": "+e.data.name),{icon:g.aK[e.documentName]??g.aK.DEFAULT,tooltip:t}})))):(t.multiEdit=!0,t.preset={}),this._submitData&&foundry.utils.mergeObject(t.preset,this._submitData),t.minlength=this.presets.length>1?0:1,t.tva=game.modules.get("token-variants")?.active,(this.data&&!(this.data instanceof Array)||!this.data&&this.presets[0].isEmpty)&&(t.modifyDisabled=!0,t.deleteDisabled=!0);const s=this.presets[0].documentName;return"Actor"!==s&&this.presets.every((e=>e.documentName===s))&&(t.documentEdit=s,t.isPlaceable=p.Me.includes(s)),t}activateListeners(e){super.activateListeners(e),e.find('[name="name"]').select(),e.find(".edit-document").on("click",this._onEditDocument.bind(this)),e.find(".assign-document").on("click",this._onAssignDocument.bind(this)),e.find(".delete-fields").on("click",this._onDeleteFields.bind(this)),e.find(".spawn-fields").on("click",this._onSpawnFields.bind(this)),e.find("summary").on("click",(()=>setTimeout((()=>this.setPosition({height:"auto"})),30))),e.find(".attached").on("click",this.onAttachedRemove.bind(this)),e.find(".attach-selected").on("click",(()=>{const e=canvas.activeLayer.controlled;e.length&&p.Me.includes(e[0].document.documentName)&&this.dropPlaceable(e)}));const t=e.find(".token-variants-image-select-button");t.on("click",(e=>{game.modules.get("token-variants").api.showArtSelect("Preset",{callback:(e,s)=>{t.siblings(`[name="${t.data("target")}"]`).val(e)},searchType:"Item"})}));const s=e.closest(".window-content").find(".drag-drop-overlay");e.closest(".window-content").on("mouseover",(e=>{1===this.presets.length&&(canvas.activeLayer?.preview?.children.some((e=>e._original?.mouseInteractionManager?.isDragging))?(s.show(),PresetConfig.objectHover=!0):(s.hide(),PresetConfig.objectHover=!1))})).on("mouseout",(()=>{1===this.presets.length&&(s.hide(),PresetConfig.objectHover=!1)})),d.Fo.activateListeners(e,{change:()=>this.setPosition({height:"auto"})})}_getSubmitData(e={}){const t=super._getSubmitData(e);return t.name=t.name?.trim(),t.img=t.img?.trim()||null,t.preSpawnScript=t.preSpawnScript?.trim(),t.postSpawnScript=t.postSpawnScript?.trim(),t.tags=t.tags?t.tags.split(","):[],t.addTags=t.addTags?t.addTags.split(","):[],t.removeTags=t.removeTags?t.removeTags.split(","):[],t}async render(e=!1){return this.form&&(this._submitData=this._getSubmitData()),await super.render(e)}async dropPlaceable(e,t){this.attached||(this.attached=foundry.utils.deepClone(this.presets[0].attached??[])),e.forEach((e=>this.attached.push({documentName:e.document.documentName,data:(0,f.h)(e)}))),await this.render(!0),setTimeout((()=>this.setPosition({height:"auto"})),30)}async onAttachedRemove(e){const t=$(e.target).closest(".attached").data("index");this.attached=this.attached||foundry.utils.deepClone(this.presets[0].attached),this.attached.splice(t,1),await this.render(!0),setTimeout((()=>this.setPosition({height:"auto"})),30)}async _onSpawnFields(){new PresetFieldModify(this.data??this.presets[0].data,(e=>{this.modifyOnSpawn=e}),this.modifyOnSpawn??this.presets[0].modifyOnSpawn).render(!0)}async _onDeleteFields(){new PresetFieldDelete(this.data??this.presets[0].data,(e=>{this.data=e})).render(!0)}async _onAssignDocument(){const e=canvas.getLayerByEmbeddedName(this.presets[0].documentName)?.controlled.map((e=>e.document));if(!e?.length)return;const t=h.sy.getLinkedDocuments(e);if(t.size){await new Promise((e=>{Dialog.confirm({title:"Override Attached",content:`<p>Linked placeables have been detected [<b>${t.size}</b>].</p><p>Should they be included and override <b>Attached</b>?</p>`,yes:()=>e(!0),no:()=>e(!1),defaultYes:!1})}))&&(this.attached=Array.from(t).map((e=>({documentName:e.documentName,data:(0,f.h)(e)}))))}const s=e.map((e=>(0,f.h)(e)));this.data=s,ui.notifications.info((0,d.zS)("presets.assign",{count:s.length,document:this.presets[0].documentName})),this.gridSize=canvas.grid.size,this.modifyOnSpawn=[],this.render(!0)}async _onEditDocument(){const e=[],t=CONFIG[this.presets[0].documentName].documentClass;for(const s of this.presets)s.data.forEach((i=>{const a=new t((0,f.Go)(s,i),{parent:canvas.scene});e.push(a)}));const s=await(0,n.gx)(e,null,{presetEdit:!0,callback:e=>{this.addSubtract={},this.randomize={};for(const t of Object.keys(e.data))t in e.randomize&&(this.randomize[t]=e.randomize[t]),t in e.addSubtract&&(this.addSubtract[t]=e.addSubtract[t]);this.data=e.data,this.render(!0)},forceForm:!0}),i=new g.k({data:{},randomize:this.presets[0].randomize,addSubtract:this.presets[0].addSubtract});setTimeout((()=>{s._applyPreset(i)}),400)}async _updatePresets(e){for(const t of this.presets){let s;if(s=this.isCreate?{name:e.name||t.name||(0,d.kg)("presets.default-name"),img:e.img??t.img}:{name:e.name||t.name,img:e.img||t.img},this.data&&(s.data=this.data),this.addSubtract&&(s.addSubtract=this.addSubtract),this.randomize&&(s.randomize=this.randomize),this.modifyOnSpawn&&(s.modifyOnSpawn=this.modifyOnSpawn),this.gridSize&&(s.gridSize=this.gridSize),this.attached&&(s.attached=this.attached),null!=e.preSpawnScript&&(s.preSpawnScript=e.preSpawnScript),null!=e.postSpawnScript&&(s.postSpawnScript=e.postSpawnScript),null!=e.spawnRandom&&(s.spawnRandom=e.spawnRandom),null!=e.preserveLinks&&(s.preserveLinks=e.preserveLinks),1===this.presets.length)s.tags=e.tags;else if(e.addTags.length||e.removeTags.length){let i=t.tags??[];e.addTags.length&&(i=Array.from(new Set(i.concat(e.addTags)))),e.removeTags.length&&(i=i.filter((t=>!e.removeTags.includes(t)))),s.tags=i}await t.update(s)}}async _updateObject(e,t){return await this._updatePresets(t),this.callback&&this.callback(this.presets),this.presets}async _renderOuter(){const e=await super._renderOuter();return this._createDocumentIdLink(e),e}_createDocumentIdLink(e){const t=e.find(".window-title"),s=(0,d.kg)("DOCUMENT.JournalEntry",!1),i=document.createElement("a");i.classList.add("document-id-link"),i.setAttribute("alt","Copy document id"),i.dataset.tooltip=`${s}: ${this.presets.map((e=>e.id)).join(", ")}`,i.dataset.tooltipDirection="UP",i.innerHTML='<i class="fa-solid fa-passport"></i>',i.addEventListener("click",(e=>{e.preventDefault(),game.clipboard.copyPlainText(this.presets.map((e=>e.id)).join(", ")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"id",id:this.presets.map((e=>e.id)).join(", ")}))})),i.addEventListener("contextmenu",(e=>{e.preventDefault(),game.clipboard.copyPlainText(this.presets.map((e=>e.uuid)).join(", ")),ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"uuid",id:this.presets.map((e=>e.uuid)).join(", ")}))})),t.append(i)}}class PresetFieldSelect extends FormApplication{static name="PresetFieldSelect";constructor(e,t){super(),this.presetData=e,this.isObject=!(e instanceof Array),this.callback=t}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","preset-field-select","mass-edit-dark-window","mass-edit-window-fill"],template:`modules/${p.Do}/templates/preset/presetFieldSelect.html`,width:600,resizable:!1})}activateListeners(e){super.activateListeners(e),e.find(".item").on("click",this._onFieldClick)}_onFieldClick(e){x(e,$(e.target).closest(".preset-field-list"))}async getData(e={}){let t=foundry.utils.flattenObject(this.presetData);const s=!this.isObject&&1===this.presetData.length;let i,a=[];for(const[e,n]of Object.entries(t)){if(!s){const t=e.split(".")[0];i?t!==i&&a.push({header:!0,index:t}):a.push({header:!0,index:0}),i=t}let t,o=e;s&&(o=o.substring(o.indexOf(".")+1));const r=foundry.utils.getType(n);t="Object"===r||"Array"===r||"null"===r?JSON.stringify(n):n,a.push({name:e,label:o,value:t,selected:!1})}return{fields:a}}}class PresetFieldDelete extends PresetFieldSelect{static name="PresetFieldDelete";get title(){return(0,d.kg)("presets.select-delete")}async getData(e={}){const t=await super.getData(e);return t.button={icon:'<i class="fas fa-trash"></i>',text:(0,d.kg)("common.delete")},t}async _updateObject(e,t){let s=foundry.utils.flattenObject(this.presetData);if($(e.target).closest("form").find(".item.selected").each((function(){const e=$(this).attr("name");delete s[e]})),s=expandObject(s),!this.isObject){let e=[];for(let t=0;t<this.presetData.length;t++)s[t]&&e.push(s[t]);s=e}this.callback(s)}}class PresetFieldModify extends PresetFieldSelect{static name="PresetFieldModify";constructor(e,t,s){super(e,t),this.modifyOnSpawn=s??[]}get title(){return(0,d.kg)("presets.select-modify")}async getData(e={}){const t=await super.getData(e);t.button={icon:'<i class="fas fa-check"></i>',text:(0,d.kg)("CONTROLS.CommonSelect",!1)};for(const e of t.fields)this.modifyOnSpawn.includes(e.name)&&(e.selected=!0);return t}async _updateObject(e,t){const s=$(e.target).closest("form"),i=[];s.find(".item.selected").each((function(){let e=$(this).attr("name");i.push(e)})),this.callback(i)}}class PresetFolderConfig extends FolderConfig{static name="PresetFolderConfig";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sheet","folder-edit"],template:`modules/${p.Do}/templates/preset/presetFolderEdit.html`,width:360})}get id(){return this.object.id?super.id:"folder-create"}get title(){return this.object.id?`${(0,d.kg)("FOLDER.Update",!1)}: ${this.object.name}`:(0,d.kg)("FOLDER.Create",!1)}activateListeners(e){super.activateListeners(e),e.find(".document-select").on("click",this._onDocumentChange.bind(this))}_onDocumentChange(e){$(e.target).closest(".document-select").toggleClass("active")}async close(e={}){return this.options.submitOnClose||this.options.resolve?.(null),super.close(e)}async getData(e={}){const t=this.document.toObject(),s=(0,d.kg)(Folder.implementation.metadata.label,!1);let i,a=t.flags[p.Do]?.types??["ALL"];return this.options?.folder instanceof u.dH||1===a.length&&!p.TA.includes(a[0])?this.displayTypes=!1:(this.displayTypes=!0,i=[],p.TA.forEach((e=>{"FAVORITES"!=e&&i.push({name:e,icon:g.aK[e],active:a.includes(e)})}))),{folder:t,name:t._id?t.name:"",newName:(0,d.zS)("DOCUMENT.New",{type:s},!1),safeColor:t.color??"#000000",sortingModes:{a:"FOLDER.SortAlphabetical",m:"FOLDER.SortManual"},submitText:(0,d.kg)(t._id?"FOLDER.Update":"FOLDER.Create",!1),docs:i,virtualPackFolder:this.options.folder instanceof u.dH,group:this.options.folder?.group}}async _updateObject(e,t){if(this.displayTypes){let e=[];$(this.form).find(".document-select.active").each((function(){e.push($(this).data("name"))})),e.length||e.push("ALL"),t[`flags.${p.Do}.types`]=e}let s=this.object;if(this.options.folder instanceof u.dH){let e={};["name","color","group"].forEach((s=>{t[s]?.trim()?e[s]=t[s].trim():e["-="+s]=null})),await this.options.folder.update(e)}else t.name?.trim()||(t.name=Folder.implementation.defaultName()),this.object.id?await this.object.update(t):(this.object.updateSource(t),s=await Folder.create(this.object,{pack:this.object.pack}));return this.options.resolve?.(s),s}}function k(e,t,s){var i=s.offset();let a=i.left,n=i.top,o=s.width(),r=s.height();return e>a&&e<a+o&&t>n&&t<n+r}function w(e,{excludePack:t,exportTo:s=!1,keepIdSelect:i=!1}={}){let a;a=s?{title:(0,d.kg)("presets.select-compendium"),message:(0,d.kg)("presets.export-directory-message"),buttonLabel:(0,d.kg)("FOLDER.Export",!1)}:{title:(0,d.kg)("presets.select-compendium"),message:(0,d.kg)("presets.working-directory-message"),buttonLabel:(0,d.kg)("common.swap")};let n="";for(const e of game.packs)if(!e.locked&&"JournalEntry"===e.documentName){if(e.collection===t)continue;const s=e.collection===u.A0.workingPack;n+=`<option value="${e.collection}" ${s?'selected="selected"':""}>${e.title}</option>`}let o=`\n  <p style="color: orangered;">${a.message}</p>\n  <div class="form-group">\n    <label>${(0,d.kg)("PACKAGE.TagCompendium",!1)}</label>\n    <div class="form-fields">\n      <select style="width: 100%; margin-bottom: 10px;">${n}</select>\n    </div>\n  </div>`;i&&(o+=`\n<div class="form-group">\n    <label>${(0,d.kg)("presets.keep-ids")}</label>\n    <input type="checkbox" name="keepId" checked>\n    <p style="font-size: smaller;">${(0,d.kg)("presets.keep-ids-hint")}</p>\n</div>`),new Dialog({title:a.title,content:o,buttons:{export:{label:a.buttonLabel,callback:t=>{const s=$(t).find("select").val();e(i?{pack:s,keepId:$(t).find('[name="keepId"]').is(":checked")}:s)}},cancel:{label:(0,d.kg)("Cancel",!1),callback:()=>e(i?{}:null)}},close:()=>e(i?{}:null),default:"cancel"}).render(!0)}function x(e,t){const s=$(e.target).closest(".item"),i=t.find(".item"),a=i.filter(".last-selected");if(e.ctrlKey||e.metaKey||e.shiftKey){if(e.ctrlKey||e.metaKey)s.toggleClass("selected"),s.hasClass("selected")?(a.removeClass("last-selected"),s.addClass("last-selected")):s.removeClass("last-index");else if(e.shiftKey)if(a.length){let e=i.index(s),t=i.index(a);if(e===t)s.toggleClass("selected"),s.hasClass("selected")?s.addClass("last-selected"):a.removeClass("last-selected");else{let s=i.toArray();if(e>t)for(let i=t;i<=e;i++)$(s[i]).addClass("selected");else for(let i=t;i>=e;i--)$(s[i]).addClass("selected")}}else a.removeClass("last-selected"),s.toggleClass("selected"),s.hasClass("selected")&&s.addClass("last-selected")}else a.removeClass("last-selected"),i.removeClass("selected"),s.addClass("selected").addClass("last-selected")}function _(){const e=function(e,...t){if(!MassEditPresets.objectHover&&!PresetConfig.objectHover)return e(...t);{this.mouseInteractionManager.cancel(...t);const e=Object.values(ui.windows).find((e=>MassEditPresets.objectHover&&e instanceof MassEditPresets||PresetConfig.objectHover&&e instanceof PresetConfig));if(e){const s=canvas.activeLayer.controlled.length?[...canvas.activeLayer.controlled]:[this];e.dropPlaceable(s,...t)}this._onDragLeftCancel(...t)}};p.Me.forEach((t=>{libWrapper.register(p.Do,`${t}.prototype._onDragLeftDrop`,e,"MIXED")})),Hooks.on("renderSceneControls",((e,t,s)=>{if(!game.user.isGM)return;if(!game.settings.get(p.Do,"presetSceneControl"))return;const i=$('\n<li class="scene-control mass-edit-scene-control" data-control="me-presets" aria-label="Mass Edit: Presets" role="tab" data-tooltip="Mass Edit: Presets">\n  <i class="fa-solid fa-books"></i>\n</li>\n  ');i.on("click",(()=>{let e=canvas.activeLayer.constructor.documentName;p.Me.includes(e)||(e="ALL");const t=Object.values(ui.windows).find((e=>e instanceof MassEditPresets));t?t.close():new MassEditPresets(null,null,e,{left:i.position().left+i.width()+40}).render(!0)})),t.find(".control-tools").find(".scene-control").last().after(i)})),libWrapper.register(p.Do,"CompendiumDirectory.prototype._getEntryContextOptions",(function(e,...t){const s=e(...t);return s.push({name:"Open Journal Compendium",icon:'<i class="fas fa-book-open"></i>',condition:e=>{const t=game.packs.get(e.data("pack"));return"JournalEntry"===t.metadata.type&&t.index.get(u.Xd)},callback:e=>{game.packs.get(e.data("pack")).render(!0)}}),console.log(s),s}),"WRAPPER"),libWrapper.register(p.Do,"CompendiumDirectory.prototype._onClickEntryName",(async function(e,t){const s=t.currentTarget.closest("[data-pack]").dataset.pack,i=game.packs.get(s);if("JournalEntry"!==i.metadata.type||!i.index.get(u.Xd))return e(t);new MassEditPresets(null,null,"ALL").render(!0)}),"MIXED")}},671:(e,t,s)=>{s.d(t,{JG:()=>VirtualFilePreset,aK:()=>d,k:()=>Preset});var i=s(596),a=s(120),n=s(652),o=s(627),r=s(575);const l=["id","name","sort","folder"],c=["id","name","data","sort","folder","uuid","documentName","addSubtract","randomize","img","gridSize","modifyOnSpawn","preSpawnScript","postSpawnScript","spawnRandom","attached","tags","preserveLinks"],d={ALL:"fas fa-globe",FAVORITES:"fas fa-star",Token:"fas fa-user-circle",MeasuredTemplate:"fas fa-ruler-combined",Tile:"fa-solid fa-cubes",Drawing:"fa-solid fa-pencil-alt",Wall:"fa-solid fa-block-brick",AmbientLight:"fa-regular fa-lightbulb",AmbientSound:"fa-solid fa-music",Note:"fa-solid fa-bookmark",Region:"fa-regular fa-game-board",Actor:"fas fa-user-alt",Scene:"fas fa-map",DEFAULT:"fa-solid fa-question"};class Preset{static isEditable(e){if(e.startsWith("virtual@"))return!0;let{collection:t}=foundry.utils.parseUuid(e);return!!t&&!t.locked}constructor(e){this.id=e.id??e._id??foundry.utils.randomID(),this.name=e.name??"Mass Edit Preset",this.documentName=e.documentName,this.sort=e.sort??0,this.tags=e.tags??[],this.addSubtract=e.addSubtract instanceof Array?Object.fromEntries(e.addSubtract):foundry.utils.deepClone(e.addSubtract??{}),this.randomize=e.randomize instanceof Array?Object.fromEntries(e.randomize):foundry.utils.deepClone(e.randomize??{}),this.data=foundry.utils.deepClone(e.data),this.img=e.img,this.folder=e.folder,this.uuid=e.uuid,this.gridSize=e.gridSize,this.modifyOnSpawn=e.modifyOnSpawn,this.preSpawnScript=e.preSpawnScript,this.postSpawnScript=e.postSpawnScript,this.attached=e.attached,this.spawnRandom=e.spawnRandom,this.preserveLinks=e.preserveLinks,this._visible=!0,this._render=!0}get visible(){return this._visible&&this._render}get icon(){return d[this.documentName]??d.DEFAULT}get thumbnail(){return this.img?(0,a.JK)(this.img)?"icons/svg/sound.svg":(0,r.cZ)(this.img)?"icons/svg/video.svg":this.img:CONST.DEFAULT_TOKEN}get pages(){return this.document?.pages.size?this.document.toJSON().pages:this._pages?this._pages:null}set data(e){this._data=e instanceof Array?e.length?e:[{}]:null==e?[{}]:[e]}get data(){return this._data}get isPlaceable(){return i.Me.includes(this.documentName)}get isFavorite(){return Preset.favorites||(Preset.favorites=game.settings.get(i.Do,"presetFavorites")),Boolean(Preset.favorites[this.uuid])}get isEmpty(){return foundry.utils.isEmpty(this.data[0])}addPostSpawnHook(e){this._postSpawnHooks||(this._postSpawnHooks=[]),this._postSpawnHooks.push(e)}async callPostSpawnHooks(e){if(this._postSpawnHooks)for(const t of this._postSpawnHooks)await t(e)}async load(e=!1){if(this.document&&!e)return this;if(!this.document&&this.uuid&&(this.document=await fromUuid(this.uuid)),this.document){const e=this.document.getFlag(i.Do,"preset")??{};this.documentName=e.documentName,this.img=e.img,this.data=e.data,this.randomize="Object"===foundry.utils.getType(e.randomize)?e.randomize:Object.fromEntries(e.randomize??[]),this.addSubtract="Object"===foundry.utils.getType(e.addSubtract)?e.addSubtract:Object.fromEntries(e.addSubtract??[]),this.gridSize=e.gridSize,this.modifyOnSpawn=e.modifyOnSpawn,this.preSpawnScript=e.preSpawnScript,this.postSpawnScript=e.postSpawnScript,this.attached=e.attached,this.spawnRandom=e.spawnRandom,this.preserveLinks=e.preserveLinks,this.tags=e.tags??[]}return this}async openJournal(){this.document||await this.load(),this.document&&this.document.sheet.render(!0)}async attach(e){if(e){e instanceof Array||(e=[e]),this.attached||(this.attached=[]);for(const t of e)this.attached.push({documentName:t.document.documentName,data:(0,r.h)(t)});await this.update({attached:this.attached})}}async update(e){if(this.document){const t={};if(Object.keys(e).forEach((s=>{"randomize"===s||"addSubtract"===s?(t[s]=Object.entries(e[s]),this[s]=e[s]):"data"!==s||e.data instanceof Array?c.includes(s)&&e[s]!==this[s]&&(t[s]=e[s],this[s]=e[s]):(t.data=this.data.map((t=>foundry.utils.mergeObject(t,e.data))),this.data=t.data)})),!foundry.utils.isEmpty(t)){const e={flags:{[i.Do]:{preset:t}}};l.forEach((s=>{s in t&&this.document[s]!==t[s]&&(e[s]=t[s])})),await this.document.update(e)}await this._updateIndex(t)}else console.warn("Updating preset without document",this.id,this.uuid,this.name)}async _updateIndex(e){const t={};if(n.XF.forEach((s=>{s in e&&(t[s]=e[s])})),!foundry.utils.isEmpty(t)){const e=game.packs.get(this.document.pack),s=await e.getDocument(n.Xd);if(!s)return void console.warn(`META INDEX missing in ${this.document.pack}`);{let a={};a[this.id]=t,await s.setFlag(i.Do,"index",a),delete n.A6._packTrees[e.metadata.name]}}}toJSON(){let e={};c.forEach((t=>{e[t]=this[t]})),e.randomize=Object.entries(e.randomize??{}),e.addSubtract=Object.entries(e.addSubtract??{});const t=this.pages;return t&&(e.pages=t),e}clone(){const e=new Preset(this.toJSON());return e.document=this.document,e}}class VirtualFilePreset extends Preset{constructor(e){e.name||(e.name=e.src.split("/").pop()),e.name=(0,r.e6)(e.name),e.uuid="virtual@"+e.src,e.documentName=(0,a.JK)(e.src)?"AmbientSound":"Tile","Tile"===e.documentName?(e.data=[{texture:{src:e.src},x:0,y:0,rotation:0}],e.img=e.src):(e.data=[{path:e.src,radius:20,x:0,y:0}],e.img=e.src),e.gridSize=150,super(e)}get virtual(){return!0}async load(e=!1){if(this._storedReference)return this;const t=await o.WX.getPreset(this.uuid);if(t&&(this.tags=t.tags),this._storedReference=t,this.data[0].path)return this;const s=this.data[0].texture?.src;let i,n,r;if((0,a.wu)(s)){const e=new Image;if(r=new Promise((t=>{e.onload=t,e.src=s})),await Promise.race([r,(async()=>{await new Promise((e=>setTimeout(e,1e3)))})()]),!e.complete||0===e.naturalWidth)return console.log("Image Load failed",s),null;i=e.naturalWidth,n=e.naturalHeight}else{const e=document.createElement("video");r=new Promise((t=>{e.onloadedmetadata=t,e.src=s,e.load()})),await Promise.race([r,(async()=>{await new Promise((e=>setTimeout(e,1e3)))})()]),i=e.videoWidth,n=e.videoHeight}return this.data[0].width=i,this.data[0].height=n,this}async update(e){e.hasOwnProperty("tags")&&this._storedReference&&(this._storedReference.tags=e.tags,clearTimeout(VirtualFilePreset._updateTimeout),VirtualFilePreset._updateTimeout=setTimeout((()=>o.WX.saveIndexToCache()),3e3))}clone(){const e=this.toJSON();return e.src=e.img,new VirtualFilePreset(e)}}},575:(e,t,s)=>{s.d(t,{$J:()=>f,CY:()=>p,Ch:()=>r,GD:()=>m,Go:()=>l,Li:()=>c,Q2:()=>u,S9:()=>y,Ym:()=>d,cZ:()=>h,cm:()=>FolderState,e6:()=>g,h:()=>o});var i=s(596),a=s(465),n=s(652);class FolderState{static expanded(e){return game.folders._expanded[e]}static setExpanded(e,t){game.folders._expanded[e]=t}}function o(e){const t=e.document??e,s=t.toObject();if("Token"===t.documentName&&game.modules.get("token-attacher")?.active&&tokenAttacher?.generatePrototypeAttached){const e=s.flags?.["token-attacher"]?.attached||{};if(!foundry.utils.isEmpty(e)){const t=tokenAttacher.generatePrototypeAttached(s,e);foundry.utils.setProperty(s,"flags.token-attacher.attached",null),foundry.utils.setProperty(s,"flags.token-attacher.prototypeAttached",t),foundry.utils.setProperty(s,"flags.token-attacher.grid",{size:canvas.grid.size,w:canvas.grid.sizeX??canvas.grid.w,h:canvas.grid.sizeY??canvas.grid.h})}}return s}function r(e){if(game.modules.get("tagger")?.active){const t={"{#}":(e,t)=>{const s=new RegExp("^"+e.replace(t,"([1-9]+[0-9]*)")+"$"),i=Tagger.getByTag(s);if(!i.length)return e.replace(t,1);const a=i.map((e=>Number(Tagger.getTags(e).find((e=>e.match(s))).match(s)[1]))),n=Math.max(...a)+1;for(let s=1;s<=n;s++)if(!a.includes(s))return e.replace(t,s)},"{id}":(e,t,s)=>{let i=temporaryIds?.[e]?.[s];return i||(temporaryIds?.[e]||(temporaryIds[e]=[]),i=foundry.utils.randomID(),temporaryIds[e].push(i)),e.replace(t,i)}},s=Object.entries(t).filter((e=>(e[0]=new RegExp(`${e[0]}`,"g"),e)));e=(e=Tagger._validateTags(e,"TaggerHandler")).map(((e,t)=>{const i=s.filter((([t])=>e.match(t)));return i.length?(i.forEach((([s,i])=>{e=i(e,s,t)})),e):e}))}return e}function l(e,t){let s;switch(e.documentName){case"Token":s={name:e.name,elevation:0,x:0,y:0,rotation:0,width:1,height:1};break;case"Tile":s={width:canvas.grid.sizeX??canvas.grid.w,height:canvas.grid.sizeY??canvas.grid.h,x:0,y:0,rotation:0,elevation:0};break;case"AmbientSound":s={radius:20,x:0,y:0};break;case"Drawing":s={shape:{width:2*(canvas.grid.sizeX??canvas.grid.w),height:2*(canvas.grid.sizeY??canvas.grid.h),strokeWidth:8,strokeAlpha:1},x:0,y:0,rotation:0};break;case"MeasuredTemplate":s={distance:10,x:0,y:0};break;case"AmbientLight":s={config:{dim:20,bright:20},x:0,y:0};break;case"Scene":s={name:e.name};break;case"Wall":s={c:[0,0,canvas.grid.size,0]};break;case"Region":s={name:e.name,shapes:[{type:"rectangle",hole:!1,x:0,y:0,width:2*(canvas.grid.sizeX??canvas.grid.w),height:2*(canvas.grid.sizeX??canvas.grid.w),rotation:0}]};break;default:s={x:0,y:0}}return foundry.utils.mergeObject(s,t)}async function c(e,t,n){const o=t.allFolders.get(e).children;if(!o.length)return;const r=await renderTemplate(`modules/${i.Do}/templates/randomizer/color.html`,{method:"interpolateReverse",space:"srgb",hue:"longer"});let l;let c=new Dialog({title:"Pick Range",content:`<form>${r}</form>`,buttons:{save:{label:"Apply",callback:async e=>{!async function(e,t,s){const i=o.map((e=>({color:"#000000"}))),r={color:{type:"color",method:e,space:t,hue:s,colors:l.getColors()}};await(0,a.of)(i,o,r);for(let e=0;e<o.length;e++)await o[e].update(i[e]);n?.()}(e.find('[name="method"]').val(),e.find('[name="space"]').val(),e.find('[name="hue"]').val())}}},render:e=>{Promise.all([s.e(646),s.e(470),s.e(236)]).then(s.bind(s,236)).then((t=>{l=new t.ColorSlider(e,[{hex:"#663600",offset:0},{hex:"#944f00",offset:100}]),setTimeout((()=>c.setPosition({height:"auto"})),100)}))}});c.render(!0)}function d(e){const t=function(e){let t=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER;return e.forEach(((e,n)=>{for(const o of e){const e=m(n,o);e.x1<t&&(t=e.x1),e.y1<s&&(s=e.y1),e.x2>i&&(i=e.x2),e.y2>a&&(a=e.y2)}})),{x:t,y:s,width:i-t,height:a-s}}(e),s=t.x+t.width/2,i=t.y+t.height/2,a=u(e);return{x:s+a.x,y:i+a.y,z:0}}function u(e){const[t,s]=e.entries().next().value,i={};if("Wall"===t){const e=s[0].c;i.x=-e[0],i.y=-e[1],i.z=0}else if("Region"===t){const e=m(t,s[0]);i.x=-e.x1,i.y=-e.y1,i.z=-e.z1}else i.x=-s[0].x,i.y=-s[0].y,i.z=-(s[0].elevation??0);return i}function m(e,t){let s,i,a,n,o,r;if("Wall"===e)s=Math.min(t.c[0],t.c[2]),i=Math.min(t.c[1],t.c[3]),a=Math.max(t.c[0],t.c[2]),n=Math.max(t.c[1],t.c[3]),o=0,r=0;else{if("Region"===e)return a=-1/0,n=-1/0,s=1/0,i=1/0,o=t.elevation?.bottom??0,r=t.elevation?.top??0,t.shapes?.forEach((e=>{if(e.points)for(let t=0;t<e.points.length;t+=2){let o=e.points[t],r=e.points[t+1];s=Math.min(s,o),i=Math.min(i,r),a=Math.max(a,o),n=Math.max(n,r)}else s=Math.min(s,e.x),i=Math.min(i,e.y),a=Math.max(a,e.x+(e.radiusX??e.width)),n=Math.max(n,e.y+(e.radiusY??e.height))})),{x1:s,y1:i,x2:a,y2:n,z1:o,z2:r};{let l,c;s=t.x||0,i=t.y||0,o=t.elevation??0,"Tile"===e?(l=t.width,c=t.height):"Drawing"===e?(l=t.shape.width,c=t.shape.height):"Token"===e?(l=t.width*canvas.dimensions.size,c=t.height*canvas.dimensions.size):(l=0,c=0),a=s+(l||0),n=i+(c||0),r=o}}return{x1:s,y1:i,x2:a,y2:n,z1:o,z2:r}}function h(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),["mp4","ogg","webm","m4v"].includes(t)}function g(e){try{return decodeURIComponent(e)}catch(t){return console.warn("URI Component not decodable: "+e),e}}function p(e){try{return encodeURIComponent(e)}catch(t){return console.warn("URI Component not encodable: "+e),e}}async function f(e){try{return await jQuery.getJSON(e)}catch(e){}return null}function y(){Hooks.on("renderSidebar",((e,t)=>{game.user.isGM&&t.on("drop",(async e=>{const t=$(e.target).closest(".directory-item.playlist").data("document-id");if(!t)return;const s=game.playlists.get(t);if(!s)return;let i=e.originalEvent.dataTransfer.getData("text/plain");if(!i)return;i=JSON.parse(i);let a=(await n.af.getPresets({uuid:i.uuids,full:!1})).filter((e=>"AmbientSound"===e.documentName));for(const e of a)await e.load();const o=[];a.forEach((e=>{e.data.forEach((t=>{t.path&&o.push({name:e.name,path:t.path,channel:"music",repeat:!1,fade:null,description:"Mass Edit Preset",volume:.52,playing:!1,pausedTime:null,flags:{}})}))})),PlaylistSound.create(o,{parent:s})}))}))}},465:(e,t,s)=>{s.d(t,{Bd:()=>a,RZ:()=>o,Rn:()=>l,_j:()=>n,of:()=>r});var i=s(120);function a(e){const t=e.closest(".form-group");t.find(".mass-edit-checkbox input").prop("checked",!0).trigger("change"),t.find(".mass-edit-randomize").addClass("active")}function n(e,t){const s=e.closest(".form-group");let i=!0;t&&s.find("[name]").each((function(){i&&(i=!Boolean(t.randomizeFields[this.name]))})),i&&(s.find(".mass-edit-checkbox input").prop("checked",!1).trigger("change"),s.find(".mass-edit-randomize").removeClass("active"))}function o(e,t){if(t)for(const s of Object.keys(t))a(e.find(`[name="${s}"]`))}async function r(e,t,a){if(!a||foundry.utils.isEmpty(a))return;let n=!1;for(let o=0;o<e.length;o++){const r=e[o];for(const l of Object.keys(r))if(l in a){const c=a[l];if("select"===c.type)r[l]=c.selection[Math.floor(Math.random()*c.selection.length)];else if("number"===c.type)if(c.step="any"===c.step?1:Number(c.step),Number.isNaN(c.step)&&(c.step=1),"interpolate"===c.method){const e=(c.max-c.min)/c.step+1;r[l]=o%e*c.step+c.min}else if("interpolateReverse"===c.method){const e=(c.max-c.min)/c.step;r[l]=(e-o%(e+1))*c.step+c.min}else{const e=(c.max-c.min+(Number.isInteger(c.step)?1:0))/c.step;r[l]=Math.floor(Math.random()*e)*c.step+c.min}else if("boolean"===c.type)r[l]=Math.random()<.5;else if("color"===c.type){if(c.color1&&(c.colors=[{hex:c.color1,offset:0},{hex:c.color2,offset:100}]),"discrete"===c.space){"interpolate"===c.method?r[l]=c.colors[o%c.colors.length].hex:"interpolateReverse"===c.method?r[l]=c.colors[c.colors.length-1-o%c.colors.length].hex:r[l]=c.colors[Math.floor(Math.random()*c.colors.length)].hex;continue}let t,i=c.colors.map((e=>e));i[0].offset>0&&i.unshift({hex:i[0].hex,offset:0}),i[i.length-1].offset<100&&i.push({hex:i[i.length-1].hex,offset:100}),t="interpolate"===c.method?1-(o+1)/e.length:"interpolateReverse"===c.method?(o+1)/e.length:Math.random(),t*=100;let a,n,d=0;for(;d<i.length-1&&i[d+1].offset<t;)d++;d===i.length-1?(a=i[d-1],n=i[d]):(a=i[d],n=i[d+1]);let u=t-a.offset;u/=n.offset-a.offset;const m=(await s.e(646).then(s.bind(s,646))).default;a=new m(a.hex),n=new m(n.hex);const h=c.space||"srgb",g=c.hue||"shorter";let p=a.range(n,{space:h,hue:g,outputSpace:"srgb"})(u).toString({format:"hex"});p.length<7&&(p="#"+p[1]+p[1]+p[2]+p[2]+p[3]+p[3]),r[l]=p}else if("image"===c.type){if("sequential"===c.method?r[l]=c.images[o%c.images.length]:r[l]=c.images[Math.floor(Math.random()*c.images.length)],c.maintainAspect){const e=t?.[o]?.width??r.width,s=t?.[o]?.height??r.height;if(null!=s&&null!=e)try{const t=await loadTexture(r[l]);if(t){const i=e/s,a=t.width/t.height;a!==i&&(a>i?(r["texture.scaleX"]=1,r["texture.scaleY"]=i):(r["texture.scaleX"]=s/e,r["texture.scaleY"]=1))}}catch(e){}}}else if("text"===c.type)if("findAndReplace"===c.method||"findAndReplaceRegex"===c.method){if(t){const e=foundry.utils.flattenObject((0,i.bQ)(t[o]).toObject());e[l]||c.find?e[l]&&("flags.tagger.tags"===l&&(e[l]=e[l].join(",")),"findAndReplaceRegex"===c.method?r[l]=(0,i.H6)(c.find,c.replace,e[l]):r[l]=(0,i.OV)(c.find,c.replace,e[l])):r[l]=c.replace}}else"unique"===c.method?(c.shuffled||(d(c.strings),c.shuffled=!0,c.i=-1),c.i++,r[l]=c.strings[c.i%c.strings.length]):r[l]=c.strings[Math.floor(Math.random()*c.strings.length)];else"coordinate"===c.type&&(n=!0)}}if(n){let s,i=[];for(let s=0;s<t.length;s++)i.push({p:t[s],update:e[s]});i.sort(((e,t)=>(t.p.w??t.p.width??0)+(t.p.h??t.p.height??0)-(e.p.w??e.p.width??0)-(e.p.h??e.p.height??0)));for(const e of i){const t=a.x??a.y;if("noOverlap"===t.method){s||(s={freeId:0,boundingBox:t.boundingBox,freeRectangles:{0:t.boundingBox},stepX:t.stepX,stepY:t.stepY});const[i,a]=u(e.p,s);e.update.x=i,e.update.y=a}}}}function l(e,t){return e%t<=t/2?e-e%t:e-e%t+t}function c(e,t,s){const i=(t-e)/(s="any"===s?1:Number(s));return Math.floor(Math.random()*(i+(Number.isInteger(s)?1:0)))*s+e}function d(e){for(var t,s=e.length,i=0;s--;)i=Math.floor(Math.random()*(s+1)),t=e[s],e[s]=e[i],e[i]=t;return e}function u(e,t){const s={x:0,y:0,width:l(e.w??e.width,t.stepX),height:l(e.h??e.height,t.stepY)},i=t.freeRectangles;let a=Object.keys(i).filter((e=>{return t=i[e],(a=s).width<=t.width&&a.height<=t.height;var t,a}));if(a.length){const e=a[Math.floor(Math.random()*a.length)];s.x=c(i[e].x,Math.max(i[e].x+i[e].width-s.width,0),t.stepX),s.y=c(i[e].y,Math.max(i[e].y+i[e].height-s.height,0),t.stepY)}else s.x=c(t.boundingBox.x,Math.max(t.boundingBox.x+t.boundingBox.width-s.width,t.boundingBox.x),t.stepX),s.y=c(t.boundingBox.y,Math.max(t.boundingBox.y+t.boundingBox.height-s.height,t.boundingBox.y),t.stepY);let n=Object.keys(i).filter((e=>{return t=i[e],a=s,t.x<a.x+a.width&&a.x<t.x+t.width&&t.y<a.y+a.height&&a.y<t.y+t.height;var t,a}));for(const e of n){const a=i[e];delete i[e],a.x<s.x&&m(i,{x:a.x,y:a.y,width:s.x-a.x,height:a.height},t),a.x+a.width>s.x+s.width&&m(i,{x:s.x+s.width,y:a.y,width:a.x+a.width-(s.x+s.width),height:a.height},t),a.y<s.y&&m(i,{x:a.x,y:a.y,width:a.width,height:s.y-a.y},t),a.y+a.height>s.y+s.height&&m(i,{x:a.x,y:s.y+s.height,width:a.width,height:a.y+a.height-(s.y+s.height)},t)}return[s.x,s.y]}function m(e,t,s){const i=Object.keys(e);for(const s of i)if(a=e[s],n=t,a.x<=n.x&&a.x+a.width>=n.x+n.width&&a.y<=n.y&&a.y+a.height>=n.y+n.height)return;var a,n;s.freeId++,e[s.freeId]=t}},118:(e,t,s)=>{let i;s.d(t,{xH:()=>i});const a=new RegExp("([^.[]+|\\[('([^'\\\\]|\\\\.)+?'|\"([^\"\\\\]|\\\\.)+?\")\\])","g"),n=new RegExp("(^\\['|'\\]$|^\\[\"|\"\\]$)","g");Hooks.once("init",(()=>{i=!globalThis.libWrapper||(globalThis.libWrapper.is_fallback??1)?class{static get is_fallback(){return!0}static get WRAPPER(){return"WRAPPER"}static get MIXED(){return"MIXED"}static get OVERRIDE(){return"OVERRIDE"}static register(e,t,s,i="MIXED",{chain:o,bind:r=[]}={}){const l=t.endsWith("#set"),c=(t=l?t.slice(0,-4):t).match(a).map((e=>e.replace(/\\(.)/g,"$1").replace(n,""))),d=c.splice(0,1)[0];let u,m;if(0==c.length)u=globalThis,m=d;else{const e=eval;m=c.pop(),u=c.reduce(((e,t)=>e[t]),globalThis[d]??e(d))}let h=u,g=null;for(;h&&(g=Object.getOwnPropertyDescriptor(h,m),!g);)h=Object.getPrototypeOf(h);if(!g||!1===g?.configurable)throw new Error(`libWrapper Shim: '${t}' does not exist, could not be found, or has a non-configurable descriptor.`);let p=null;const f=o??("OVERRIDE"!=i.toUpperCase?.()&&3!=i)?function(...e){return s.call(this,p.bind(this),...r,...e)}:function(...e){return s.call(this,...r,...e)};if(l){if(!g.set)throw new Error(`libWrapper Shim: '${t}' does not have a setter`);p=g.set,g.set=f}else g.value?(p=g.value,g.value=f):(p=g.get,g.get=f);g.configurable=!0,Object.defineProperty(u,m,g)}}:globalThis.libWrapper}))},892:(e,t,s)=>{async function i(e,t){if(e=e.object??e,t=function(e){return PIXI.Color?new PIXI.Color(e).toNumber():PIXI.utils.string2hex(e)}(t),e instanceof PlaceableObject)isNaN(t)?await TokenMagic.deleteFilters(e,"DDTint"):await TokenMagic.addUpdateFilters(e,[{filterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t)}]);else{let s=e["flags.tokenmagic.filters"];isNaN(t)?s&&(e["flags.tokenmagic.filters"]=s.filter((e=>"DDTint"!==e.tmFilters.filterId))):(s=(s??[]).filter((e=>"DDTint"!==e.tmFilters.filterId)),s.push({tmFilters:{tmFilterId:"DDTint",tmFilterInternalId:randomID(),tmFilterType:"ddTint",filterOwner:game.data.userId,tmParams:{tmFilterType:"ddTint",filterId:"DDTint",tint:PIXI.utils.hex2rgb(t),updateId:randomID(),rank:1e4,enabled:!0,filterOwner:game.data.userId}}}),e["flags.tokenmagic.filters"]=s)}}function a(e){let t=16711680,s=e.object??e;if(s._TMFXgetSprite){const e=s._TMFXgetSprite()?.filters?.find((e=>"DDTint"===e.filterId));e&&(t=PIXI.utils.rgb2hex(e.uniforms.tint))}return function(e){return PIXI.Color?new PIXI.Color(e).toHex():PIXI.utils.hex2string(e)}(t)}async function n(e,t,s=!1){if((e=e.object??e)instanceof PlaceableObject)if("DELETE ALL"===t)await TokenMagic.deleteFilters(e);else if(s)await TokenMagic.deleteFilters(e,t);else{const s=TokenMagic.getPreset(t);s&&await TokenMagic.addUpdateFilters(e,foundry.utils.deepClone(s))}}s.d(t,{VC:()=>n,gs:()=>i,qT:()=>a})},120:(e,t,s)=>{s.d(t,{AU:()=>SeededRandom,C2:()=>E,Fo:()=>TagInput,H6:()=>w,HG:()=>N,JK:()=>c,LM:()=>S,Ng:()=>_,OV:()=>k,Tx:()=>g,VS:()=>P,XK:()=>M,bQ:()=>u,cZ:()=>l,dS:()=>x,dT:()=>v,f6:()=>T,ht:()=>f,jz:()=>d,kg:()=>O,m1:()=>p,p:()=>h,rH:()=>F,uv:()=>m,w$:()=>y,wu:()=>r,zS:()=>C});var i=s(596),a=s(971),n=s(624),o=s(465);function r(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),i.f9.includes(t)}function l(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),i.Vf.includes(t)}function c(e){var t=e.split(".");return t=t[t.length-1].toLowerCase(),i.In.includes(t)}async function d(e,t,s,i=[]){const a=await FilePicker.browse(t,e,{bucket:s});if(a){for(const e of a.files)i.push(e);for(const e of a.dirs)await d(e,t,s,i)}return i}function u(e){return e.document?e.document:e}function m(e,t,s){if(e[t]==s)return!0;const i=null==s||!1===s||""===s||"Object"===foundry.utils.getType(s)&&foundry.utils.isEmpty(s),a=null==e[t]||!1===e[t]||""===e[t]||"Object"===foundry.utils.getType(e[t])&&foundry.utils.isEmpty(e[t]);if(i&&a)return!0;if("flags.tagger.tags"===t){const i=e[t]||[];let a=s;Array.isArray(a)||(a=s?s.split(",").map((e=>e.trim())):[]);for(const e of a)if(!i.includes(e))return!1;return!0}return!(!s||"string"!=typeof s||!s.includes("*"))&&v(s,e[t])}function h(e,t){const s=e.split(".");for(let e=s.length-1;e>=1;e--){const i=s.slice(0,e).join(".")+".-="+s[e];if(i in t)return i}return null}function g(e,t){if(t)for(const s of Object.keys(t))e.find(`[name="${s}"]`).removeClass("me-add").removeClass("me-subtract").addClass("add"===t[s].method?"me-add":"me-subtract").attr("title","add"===t[s].method?`+ ${O("form.adding")}`:`- ${O("form.subtracting")}`)}function p(e){if(!e||!e.length)return{};const t=foundry.utils.flattenObject(e[0]);for(let s=1;s<e.length;s++){const i=foundry.utils.flattenObject(foundry.utils.diffObject(t,foundry.utils.flattenObject(e[s])));for(const e of Object.keys(i))(""!==i[e]&&null!=i[e]||""!==t[e]&&null!=t[e])&&delete t[e]}return t}function f(e,t={},s=""){if(t)for(const[i,a]of Object.entries(e)){const n=s?s+"."+i:i;if("Object"===foundry.utils.getType(a))f(a,t,n);else{const s=foundry.utils.getProperty(t,n);void 0!==s&&(e[i]=s)}}}function y(e){if((e=e.map((e=>e.object??e)).filter((e=>e.center))).length)if(1===e.length)e[0].center?.x&&canvas.animatePan({x:e[0].center.x,y:e[0].center.y,duration:250});else{const t={x:999999999,y:999999999},s={x:-999999999,y:-999999999};for(let i of e){let e=i;i instanceof Wall&&(e={x:i.center.x-i.width/2,y:i.center.y-i.height/2}),e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.x+i.width>s.x&&(s.x=e.x+i.width),e.y+i.height>s.y&&(s.y=e.y+i.height)}let i=canvas.scene._viewPosition.scale;const a=100;s.x-t.x+a>canvas.screenDimensions[0]/i&&(i=canvas.screenDimensions[0]/(s.x-t.x+a)),s.y-t.y+a>canvas.screenDimensions[1]/i&&(i=canvas.screenDimensions[1]/(s.y-t.y+a)),canvas.animatePan({duration:250,scale:i,x:(s.x-t.x)/2+t.x,y:(s.y-t.y)/2+t.y})}}function b(e){return e.replace(/[/\-\\^$+?.()|[\]{}]/g,"\\$&")}function v(e,t){return new RegExp("^"+b(e).replaceAll("*",".*")+"$").test(t)}function k(e,t,s){let i=new RegExp(b(e).replaceAll("*",".*"),"g");return s.replaceAll(i,t)}function w(e,t,s){try{let i=new RegExp(e,"g");return s.replaceAll(i,t)}catch(e){}return s}function x(e){const t=function(t){new n.P6(e,(async s=>{foundry.utils.isEmpty(s.randomize)||await(0,o.of)(s.data,null,s.randomize);const i=e.object.changes??[];let a=[];Object.keys(s.data[0]).forEach((e=>{let i;i="string"===foundry.utils.getType(s.data[0][e])?s.data[0][e]:JSON.stringify(s.data[0][e]),a.push({key:"Token"===t?"ATL."+e:e,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE,priority:20,value:i})}));for(let e=i.length-1;e>=0;e--)a.find((t=>t.key===i[e].key))||a.unshift(i[e]);e.object.update({changes:a})}),t).render(!0)};new Dialog({title:O("common.presets"),content:"",buttons:{activeEffect:{label:"ActiveEffect",callback:()=>{new n.P6(e,(t=>{const s=e.object.changes??[];let i=[];t.data[0].changes?.forEach((e=>{e.key&&i.push(foundry.utils.mergeObject({mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE,priority:20},e))}));for(let e=s.length-1;e>=0;e--)i.find((t=>t.key===s[e].key))||i.unshift(s[e]);e.object.update({changes:i})}),"ActiveEffect").render(!0)}},token:{label:"Token",callback:()=>t("Token")},actor:{label:"Actor",callback:()=>t("Actor")}}}).render(!0)}function _(e){return(e.document?e.document.documentName:e.documentName)??"NONE"}const D={};async function P(e,t,s){if(game.user.isGM)return game.scenes.get(s).createEmbeddedDocuments(e,t);const a=foundry.utils.randomID(),n={handlerName:"document",args:{sceneID:s,documentName:e,data:t,requestID:a},type:"CREATE"};return game.socket.emit(`module.${i.Do}`,n),setTimeout((()=>{D[a]?.([])}),4e3),new Promise((e=>{D[a]=e}))}function T({requestID:e,sceneID:t,documentName:s,documentIDs:i}={}){if(!D.hasOwnProperty(e))return;const a=game.scenes.get(t),n=[];for(const e of i)n.push(a.getEmbeddedDocument(s,e));D[e](n),delete D[e]}async function E(e,t,s,a){if(game.user.isGM)return a.updateEmbeddedDocuments(e,t,s);{const n={handlerName:"document",args:{sceneID:a.id,documentName:e,updates:t,context:s},type:"UPDATE"};game.socket.emit(`module.${i.Do}`,n)}}function S(){return game.users.filter((e=>e.active&&e.isGM)).sort(((e,t)=>t.role-e.role||e.id.compare(t.id)))[0]?.isSelf}function O(e,t=!0){return t?game.i18n.localize(`MassEdit.${e}`):game.i18n.localize(e)}function C(e,t,s=!0){return s?game.i18n.format(`MassEdit.${e}`,t):game.i18n.format(e,t)}async function M(e){if(e&&canvas.scene){await e.load();const t=foundry.utils.flattenObject(e.data[0]),s=e.randomize;foundry.utils.isEmpty(s)||await(0,o.of)([t],null,s),await canvas.scene.update(t),("grid.color"in t||"grid.alpha"in t)&&canvas.grid.grid.draw({color:(t["grid.color"]??canvas.scene.grid.color).replace("#","0x"),alpha:Number(t["grid.alpha"]??canvas.scene.grid.alpha)})}}async function N(e,{actor:t,token:s,...i}={}){const a=ChatMessage.implementation.getSpeaker({actor:t,token:s}),n=game.user.character;s=s||(canvas.ready?canvas.tokens.get(a.token):null),t=t||s?.actor||game.actors.get(a.actor);const o=Object.keys(i);if(o.some((e=>Number.isNumeric(e))))throw new Error("Illegal numeric Macro parameter passed to execution scope.");const r=Object.values(i),l=new(0,async function(){}.constructor)("speaker","actor","token","character","scope",...o,`{${e}\n}`);try{return await l.call(this,a,t,s,n,i,...r)}catch(e){ui.notifications.error("MACRO.Error",{localize:!0})}}class SeededRandom{static randomID(e,t=16){e=this.cyrb128(e);const s=this.sfc32(e[0],e[1],e[2],e[3]),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array.from({length:t},(()=>62*s()|0)).map((e=>i[e])).join("")}static cyrb128(e){let t=1779033703,s=3144134277,i=1013904242,a=2773480762;for(let n,o=0;o<e.length;o++)n=e.charCodeAt(o),t=s^Math.imul(t^n,597399067),s=i^Math.imul(s^n,2869860233),i=a^Math.imul(i^n,951274213),a=t^Math.imul(a^n,2716044179);return t=Math.imul(i^t>>>18,597399067),s=Math.imul(a^s>>>22,2869860233),i=Math.imul(t^i>>>17,951274213),a=Math.imul(s^a>>>19,2716044179),t^=s^i^a,s^=t,i^=t,a^=t,[t>>>0,s>>>0,i>>>0,a>>>0]}static sfc32(e,t,s,i){return function(){var a=((e|=0)+(t|=0)|0)+(i|=0)|0;return i=i+1|0,e=t^t>>>9,t=(s|=0)+(s<<3)|0,s=(s=s<<21|s>>>11)+a|0,(a>>>0)/4294967296}}}class TagInput{static simplifyString(e){return e.replace(/[^0-9a-zA-Z_\- ]/gi,"").toLowerCase()}static registerHandlebarsHelper(){Handlebars.registerHelper("tagInput",(e=>{const t=e.hash.name,s=e.hash.label??"Tags",i=e.hash.listId,a=e.hash.listEntries;let n=e.hash.tags;Handlebars.Utils.isArray(n)||(n=[]);let o="";n.forEach((e=>{o+=this._tagField(e)}));let r="",l="";return i&&a&&(r=`list="${i}"`,l=`<datalist id="${i}"><option value="DELETE"><option value="DELETE ALL">`,a.forEach((e=>{l+=`<option value="${e}">`})),l+="</datalist>"),new Handlebars.SafeString(`\n      ${l}\n      <fieldset>\n        <legend>${s}</legend>\n        <div class="form-group me-tags">\n            <input type="text" ${r} class="tag-input">  \n            <input type="text" class="tag-hidden-input" name="${t}" value="${n.join(",")}" hidden>\n            <button type="button" class="add-tag"><i class="fas fa-save" style="margin: auto;"></i></button>\n            <div class="tag-container">${o}</div>\n        </div>\n      </fieldset>\n    `)}))}static _tagField(e){return`<div class="tag"><span>${e}</span> <a class="delete-tag"><i class="fa-solid fa-x fa-xs"></i></a></div>`}static activateListeners(e,{change:t,simplifyTags:s=!0}={}){e.find(".me-tags .add-tag").on("click",(e=>{const i=$(e.target).closest(".me-tags"),a=i.find(".tag-input"),n=a.val().split(",").map((e=>(e=e.trim(),s&&(e=this.simplifyString(e)),e))).filter(Boolean);if(n.length){a.val("");const e=i.find(".tag-hidden-input"),s=e.val().split(",").filter(Boolean);for(const e of n)s.includes(e)||(s.push(e),i.find(".tag-container").append(this._tagField(e)));e.attr("value",s.join(",")),t?.(s)}})),e.find(".me-tags").on("click",".delete-tag",(e=>{const s=$(e.target).closest(".tag"),i=s.find("span").text(),a=s.closest(".me-tags").find(".tag-hidden-input"),n=a.val().split(",").filter((e=>e!==i));a.attr("value",n.join(",")),s.remove(),t?.(n)}))}}async function F(){const e=await new Promise((async e=>{a.Picker.activate(e)}));if(!e)return[];const t=new PIXI.Rectangle(e.start.x,e.start.y,e.end.x-e.start.x,e.end.y-e.start.y);let s=[];return i.Me.forEach((e=>{canvas.getLayerByEmbeddedName(e).placeables.forEach((e=>{const i=e.center;t.contains(i.x,i.y)&&s.push(e.document)}))})),s}},669:e=>{e.exports=jQuery}},a={};function n(e){var t=a[e];if(void 0!==t)return t.exports;var s=a[e]={exports:{}};return i[e].call(s.exports,s,s.exports,n),s.exports}n.m=i,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(s,i){if(1&i&&(s=this(s)),8&i)return s;if("object"==typeof s&&s){if(4&i&&s.__esModule)return s;if(16&i&&"function"==typeof s.then)return s}var a=Object.create(null);n.r(a);var o={};e=e||[null,t({}),t([]),t(t)];for(var r=2&i&&s;"object"==typeof r&&!~e.indexOf(r);r=t(r))Object.getOwnPropertyNames(r).forEach((e=>o[e]=()=>s[e]));return o.default=()=>s,n.d(a,o),a},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,s)=>(n.f[s](e,t),t)),[])),n.u=e=>e+".bundle.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},n.l=(e,t,i,a)=>{if(s[e])s[e].push(t);else{var o,r;if(void 0!==i)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var d=l[c];if(d.getAttribute("src")==e){o=d;break}}o||(r=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,n.nc&&o.setAttribute("nonce",n.nc),o.src=e),s[e]=[t];var u=(t,i)=>{o.onerror=o.onload=null,clearTimeout(m);var a=s[e];if(delete s[e],o.parentNode&&o.parentNode.removeChild(o),a&&a.forEach((e=>e(i))),t)return t(i)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),r&&document.head.appendChild(o)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="modules/multi-token-edit/",(()=>{var e={792:0};n.f.j=(t,s)=>{var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var a=new Promise(((s,a)=>i=e[t]=[s,a]));s.push(i[2]=a);var o=n.p+n.u(t),r=new Error;n.l(o,(s=>{if(n.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var a=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+a+": "+o+")",r.name="ChunkLoadError",r.type=a,r.request=o,i[1](r)}}),"chunk-"+t,t)}};var t=(t,s)=>{var i,a,[o,r,l]=s,c=0;if(o.some((t=>0!==e[t]))){for(i in r)n.o(r,i)&&(n.m[i]=r[i]);if(l)l(n)}for(t&&t(s);c<o.length;c++)a=o[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0},s=self.webpackChunk=self.webpackChunk||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),(()=>{var e=n(739),t=n(120),s=n(118),i=n(596),a=n(971),o=n(575);function r(){if(game.modules.get("select-tool-everywhere")?.active)return;const e=["AmbientLight","AmbientSound","MeasuredTemplate","Note"];e.forEach((e=>{Hooks.on(`refresh${e}`,l)})),Hooks.on("canvasReady",(()=>{e.forEach((e=>canvas.getLayerByEmbeddedName(e).options.controllableObjects=!0)),i.Me.includes("Region")&&(canvas.regions.options.rotatableObjects=!0)})),Hooks.on("getSceneControlButtons",(e=>function(e){for(const t of e)["lighting","sounds","measure"].includes(t.name)&&(t.tools.find((e=>"select"===e.name))||(t.tools.unshift({name:"select",title:"CONTROLS.CommonSelect",icon:"fas fa-expand"}),t.activeTool="select"))}(e))),Hooks.on("drawNote",(e=>{setTimeout((()=>l(e)),10)})),libWrapper.register(i.Do,"AmbientLight.prototype._onDragLeftCancel",(function(...e){Object.getPrototypeOf(AmbientLight).prototype._onDragLeftCancel.apply(this,e),this.initializeLightSource?this.initializeLightSource({defer:!0}):this.updateSource({defer:!0})}),"OVERRIDE"),foundry.utils.isNewerVersion(game.version,12)&&(libWrapper.register(i.Do,"Region.prototype._canDrag",(function(){return game.user.isGM}),"OVERRIDE"),libWrapper.register(i.Do,"Region.prototype._onDragLeftMove",(function(e){canvas._onDragCanvasPan(e);const{clones:t,destination:s,origin:i}=e.interactionData,{x1:n,y1:r}=(0,o.GD)("Region",this.document);let l={x:n+(s.x-i.x),y:r+(s.y-i.y)};e.shiftKey||(l=this.layer.getSnappedPoint(l));const c=l.x-n,d=l.y-r;for(const e of t||[])a.DataTransform.apply("Region",e.document.toObject(),{x:0,y:0},{x:c,y:d},e),e.visible=!0,e._onUpdate({shapes:null})}),"OVERRIDE"),libWrapper.register(i.Do,"Region.prototype._prepareDragLeftDropUpdates",(function(e){const t=[];for(const s of e.interactionData.clones)t.push({_id:s._original.id,shapes:s.document.toObject(!1).shapes});return t}),"OVERRIDE"),libWrapper.register(i.Do,"Region.prototype.rotate",(async function(e,t){if(game.paused&&!game.user.isGM)return ui.notifications.warn("GAME.PausedWarning",{localize:!0}),this;const s=this.document.toObject(),{x1:i,y1:n,x2:r,y2:l}=(0,o.GD)("Region",s),c={x:i+(r-i)/2,y:n+(l-n)/2};return a.DataTransform.apply("Region",s,c,{rotation:e}),await this.document.update({shapes:s.shapes},{meRotation:e}),this}),"OVERRIDE"),libWrapper.register(i.Do,"RegionLayer.prototype._onMouseWheel",(function(e){const t=this.hover;if(!t||t.isPreview||t.document.shapes.some((e=>"ellipse"===e.type)))return;const s=e.shiftKey?15:3,i=s*Math.sign(e.delta);t.rotate(i,s)}),"OVERRIDE"))}function l(e){e.controlled&&(e.controlIcon.border.visible=!0)}var c=n(652),d=n(624),u=n(867),m=n(439),h=n(338),g=n(638),p=n(671);var f=n(241);class V12Migrator{static async migrateAllPacks({migrateFunc:e=null,coreMigration:t=!1}={}){if(e||t){for(const s of game.packs)if("JournalEntry"===s.documentName&&s.index.get(c.Xd))if(s.locked)console.warn(`Mass Edit - Unable to migrate a locked compendium. ${s.metadata.label}`);else try{this.migratePack({pack:s,migrateFunc:e,coreMigration:t})}catch(e){console.warn(`Mass Edit - Ran into an issue while migrating ${s.metadata.label}`),console.error(e)}}else ui.notifications.warn("Specify either a `migrateFunc` or enable `coreMigration` flag.")}static async migratePack({pack:e=c.A0.workingPack,migrateFunc:t=null,coreMigration:s=!1}={}){if("string"===foundry.utils.getType(e)){let t=game.packs.get(e)||game.packs.find((t=>t.metadata.label===e));if(!t)return void console.warn("Invalid pack: "+e);e=t}if(!e.index.get(c.Xd))return void console.warn(`Mass Edit - This is not a preset compendium. ${e.metadata.label}`);if(e.locked)return void console.warn(`Mass Edit - Unable to migrate a locked compendium. ${e.metadata.label}`);if(!t&&!s)return void ui.notifications.warn("Specify either a `migrateFunc` or enable `coreMigration` flag.");const a=[],n=await e.getDocuments();for(const e of n){const n=e.getFlag(i.Do,"preset");if(!n)continue;let o={};if(n.data?.length&&(this._migrateData(n.data,n.documentName,s,t),foundry.utils.setProperty(o,`flags.${i.Do}.preset.data`,n.data)),n.attached?.length){for(const e of n.attached)this._migrateData([e.data],e.documentName,s,t);foundry.utils.setProperty(o,`flags.${i.Do}.preset.attached`,n.attached)}foundry.utils.isEmpty(o)||(o._id=e.id,a.push(o))}a.length<=0?ui.notifications.info("Mass Edit - No data to migrate: "+e.metadata.label):(await JournalEntry.updateDocuments(a,{pack:e.collection}),ui.notifications.notify("Mass Edit - Migrated "+a.length+' presets within "'+e.metadata.label))}static _migrateData(e,t,s=!0,i=null){const a=getDocumentClass(t);for(const n of e){s&&a?.migrateData(n),i&&i(n,t);const e=n.flags?.["token-attacher"]?.prototypeAttached;e&&this._migratePrototypeAttached(e,s,i)}}static _migratePrototypeAttached(e,t=!0,s=null){for(const[i,a]of Object.entries(e))this._migrateData(a,i,t,s)}}Hooks.once("init",(()=>{foundry.utils.isNewerVersion(game.version,12)&&(i.Me.unshift("Region"),i.TA.push("Region"),i.Dn.push("Region"),n.e(180).then(n.bind(n,180)).then((e=>e.registerBehaviors()))),(0,o.S9)(),(0,g.TT)(),t.Fo.registerHandlebarsHelper(),r(),game.settings.register(i.Do,"cssStyle",{scope:"world",config:!1,type:String,default:"Solid Background"}),game.settings.register(i.Do,"cssCustom",{scope:"world",config:!1,type:String,default:u.rY.Default}),game.settings.registerMenu(i.Do,"cssEdit",{name:(0,t.kg)("settings.cssEdit.name"),hint:(0,t.kg)("settings.cssEdit.hint"),label:"",scope:"world",icon:"fas fa-cog",type:u.Ay,restricted:!0}),game.settings.register(i.Do,"singleDocDefaultConfig",{name:(0,t.kg)("settings.singleDocDefaultConfig.name"),hint:(0,t.kg)("settings.singleDocDefaultConfig.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(i.Do,"rangeToTextbox",{name:(0,t.kg)("settings.rangeToTextbox.name"),hint:(0,t.kg)("settings.rangeToTextbox.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register(i.Do,"indexer",{scope:"world",config:!1,type:Object,default:{indexDirs:[{target:"modules",source:"data"},{target:"sounds",source:"public"}],cacheDir:{target:"",source:"data"},overrideTags:!1,ignoreExternal:!1,fileFilters:["Thumb","-thumb","Thumbnail","thumbnail"],folderFilters:["Thumb","thumb"]}}),game.settings.register(i.Do,"workingPack",{scope:"world",config:!1,type:String,default:"world.mass-edit-presets-main",onChange:e=>{c.A0.workingPack=e}}),c.A0.workingPack=game.settings.get(i.Do,"workingPack"),game.settings.register(i.Do,"docPresets",{scope:"world",config:!1,type:Array,default:[]}),game.settings.register(i.Do,"presetsMigrated",{scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(i.Do,"presetsCompMigrated",{scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(i.Do,"presetDocLock",{scope:"world",config:!1,type:String,default:""}),game.settings.register(i.Do,"presetLayerSwitch",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(i.Do,"presetExtComp",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(i.Do,"presetVirtualDir",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(i.Do,"presetScaling",{scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(i.Do,"presetSortMode",{scope:"world",config:!1,type:String,default:"manual"}),game.settings.register(i.Do,"presetSearchMode",{scope:"world",config:!1,type:String,default:"pf"}),game.settings.register(i.Do,"presetSceneControl",{name:"Scene Controls: Preset Button",scope:"world",config:!0,type:Boolean,default:!0,onChange:()=>{ui.controls.render()}}),game.settings.register(i.Do,"presetFavorites",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(i.Do,"pinnedFields",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(i.Do,"customControls",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register(i.Do,"autoSnap",{name:(0,t.kg)("settings.autoSnap.name"),hint:(0,t.kg)("settings.autoSnap.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(i.Do,"panToSearch",{name:(0,t.kg)("settings.panToSearch.name"),hint:(0,t.kg)("settings.panToSearch.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(i.Do,"preSelectAutoApply",{name:"Pre-Select Auto-apply",hint:"Should the auto-apply button be ticked by default on Mass Edit forms.",scope:"world",config:!0,type:Boolean,default:!1}),game.modules.get("tokenmagic")?.active&&game.settings.register(i.Do,"tmfxFieldsEnable",{name:(0,t.kg)("settings.tmfxFieldsEnable.name"),hint:(0,t.kg)("settings.tmfxFieldsEnable.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(i.Do,"brush",{scope:"world",config:!1,type:Object,default:{scale:[1,1],rotation:[0,0],random:!0,group:!1,spawner:!0,eraser:!1,lock:!1,snap:!1,scaleToGrid:!0}}),game.keybindings.register(i.Do,"linker",{name:(0,t.kg)("keybindings.linkerMenu.name"),hint:(0,t.kg)("keybindings.linkerMenu.hint"),editable:[{key:"KeyQ",modifiers:["Shift"]}],onDown:()=>{g.sy.openMenu()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"smartLink",{name:"Smart Link",hint:"Initiate smart document linking.",editable:[{key:"KeyL",modifiers:[]}],onDown:()=>{g.sy.smartLink({multiLayer:!Boolean(g.sy._getSelected().length)})},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"smartUnlink",{name:"Smart Un-Link",hint:"Initiate smart document un-linking.",editable:[{key:"KeyU",modifiers:[]}],onDown:()=>{g.sy.removeLinksFromSelected({notification:!0,multiLayer:!Boolean(g.sy._getSelected().length)})},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"deleteAllLinked",{name:"Delete Selected & Linked",hint:"Deletes currently selected placeable and all placeables linked to it via the `Linker Menu`",editable:[{key:"Delete",modifiers:["Shift"]}],onDown:()=>{g.sy.deleteSelectedLinkedPlaceables()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"placeablePreviewEdit",{name:(0,t.kg)("keybindings.placeableEdit.name"),hint:(0,t.kg)("keybindings.placeableEdit.hint"),editable:[{key:"KeyD",modifiers:["Shift"]}],onDown:a.editPreviewPlaceables,restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"mirrorX",{name:"Mirror Preview Horizontally",hint:"",editable:[{key:"KeyH",modifiers:[]}],onDown:()=>a.Picker.mirrorX(),restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"mirrorY",{name:"Mirror Preview Vertically",hint:"",editable:[{key:"KeyV",modifiers:[]}],onDown:()=>a.Picker.mirrorY(),restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"editKey",{name:(0,t.kg)("keybindings.editKey.name"),hint:(0,t.kg)("keybindings.editKey.hint"),editable:[{key:"KeyE",modifiers:["Shift"]}],onDown:()=>{const t=(0,e.bj)();t?t.close():(0,e.gx)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"copyKey",{name:(0,t.kg)("common.copy"),hint:"Copy data from within an opened Mass Edit form OR the selected and all linked placeables.",editable:[{key:"KeyC",modifiers:["Shift"]}],onDown:()=>{if(""===window.getSelection().toString()){const e=Object.values(ui.windows).find((e=>null!=e.meObjects));if(e)return e.performMassCopy()}const e=g.sy._getSelected().map((e=>e.document));if(e.length){const t=Array.from(g.sy.getHardLinkedDocuments(e).filter((t=>!e.find((e=>e.id===t.id))))),s=new p.k({documentName:e[0].documentName,data:e.map((e=>e.toObject())),attached:t.map((e=>({documentName:e.documentName,data:e.toObject()})))});(0,m.lW)(s)}},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"pasteKey",{name:(0,t.kg)("common.paste"),hint:"Paste data onto selected placeables or spawn it as a new placeable.",editable:[{key:"KeyV",modifiers:["Shift"]}],onDown:()=>{(0,e.CM)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"selectKey",{name:(0,t.kg)("keybindings.selectKey.name"),hint:(0,t.kg)("keybindings.selectKey.hint"),editable:[{key:"KeyF",modifiers:["Shift"]}],onDown:()=>{(0,e.G_)()},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"presetApply",{name:(0,t.kg)("keybindings.presetApply.name"),hint:(0,t.kg)("keybindings.presetApply.hint"),editable:[{key:"KeyX",modifiers:["Shift"]}],onDown:()=>{const e=Object.values(ui.windows).find((e=>e instanceof d.P6));if(e)return void e.close(!0);const s=Object.values(ui.windows).find((e=>e instanceof ActiveEffectConfig));if(s)return void(0,t.dS)(s);const a=canvas.activeLayer.constructor.documentName;i.Me.includes(a)&&new d.P6(null,null,a).render(!0)},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"presetApplyScene",{name:(0,t.kg)("keybindings.presetApplyScene.name"),hint:(0,t.kg)("keybindings.presetApplyScene.hint"),editable:[],onDown:()=>{const e=Object.values(ui.windows).find((e=>e instanceof d.P6));e?e.close(!0):new d.P6(null,null,"Scene").render(!0)},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register(i.Do,"genericFormKey",{name:(0,t.kg)("keybindings.genericForm.name"),hint:(0,t.kg)("keybindings.genericForm.hint"),editable:[{key:"KeyR",modifiers:["Shift"]}],onDown:()=>{let[s,a]=(0,e.ef)(null,!1);if(!s)return;const n=(0,t.Ng)(s);[...i.lv,"Token"].includes(n)&&("Token"===n?(0,e.Pw)(a,{massEdit:!0}):new h.s(a,{massEdit:!0,documentName:n}).render(!0))},restricted:!0,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),s.xH.register(i.Do,"ClientKeybindings._onCopy",(function(t,...s){if(""===window.getSelection().toString()){const t=(0,e.bj)();if(t?.performMassCopy())return!0}const i=t(...s);return i&&(0,m.ms)(canvas.activeLayer.constructor.documentName),i}),"MIXED"),s.xH.register(i.Do,"ClientKeybindings._onPaste",(function(t,...s){return!!(0,e.CM)()||t(...s)}),"MIXED"),s.xH.register(i.Do,"MouseManager.prototype._onWheel",(function(e,...t){const s=t[0];if((a.Picker.isActive()||f._8.isActive())&&(s.ctrlKey||s.shiftKey||s.metaKey||s.altKey)){s.ctrlKey&&s.preventDefault();let e=s.delta=s.deltaY;if(s.shiftKey&&0===e&&(e=s.delta=s.deltaX),0===e)return;return void(s.altKey?a.Picker.addScaling(s.delta<0?.05:-.05):(s.ctrlKey||s.metaKey)&&s.shiftKey?f._8.iterate(s.delta>=0,!0):s.ctrlKey||s.metaKey?a.Picker.addRotation(s.delta<0?2.5:-2.5):s.shiftKey&&a.Picker.addRotation(s.delta<0?15:-15))}return e(...t)}),"MIXED"),game.settings.get(i.Do,"presetSceneControl")&&s.xH.register(i.Do,"SceneNavigation.prototype._getContextMenuOptions",(function(t,...s){const i=t(...s);return i.push({name:"Mass Edit",icon:'<i class="fa-solid fa-pen-to-square"></i>',condition:game.user.isGM,callback:t=>{const s=t.attr("data-scene-id");(0,e.gx)(game.scenes.get(s))}}),i}),"WRAPPER"),(0,d.pB)(),game.socket?.on(`module.${i.Do}`,(async e=>{const s=e.args;if("document"===e.handlerName&&"UPDATE"===e.type){if(!(0,t.LM)())return;game.scenes.get(s.sceneID).updateEmbeddedDocuments(s.documentName,s.updates,s.context)}else if("document"===e.handlerName&&"CREATE"===e.type){if(!(0,t.LM)())return;const e=(await(0,t.VS)(s.documentName,s.data,s.sceneID)).map((e=>e.id)),a={handlerName:"document",args:{requestID:s.requestID,sceneID:s.sceneID,documentName:s.documentName,documentIDs:e},type:"RESOLVE"};game.socket.emit(`module.${i.Do}`,a)}else if("document"===e.handlerName&&"DELETE"===e.type){if(!(0,t.LM)())return;game.scenes.get(s.sceneId).deleteEmbeddedDocuments(s.embedName,s.ids)}else"document"===e.handlerName&&"RESOLVE"===e.type&&(0,t.f6)(s)})),Hooks.on("spotlightOmnisearch.indexBuilt",((e,t)=>{if(!game.user.isGM)return;const s=game.settings.get("spotlight-omnisearch","compendiumConfig");game.packs.filter((e=>"JournalEntry"===e.documentName&&e.index.get(c.Xd))).forEach((e=>s[e.collection]=!1)),game.settings.set("spotlight-omnisearch","compendiumConfig",s);const i=c.A0.buildSpotlightOmnisearchIndex(e);t.push(i)})),globalThis.MassEdit={showGenericForm:e.Ls,performMassUpdate:m.pt,performMassSearch:m.qn,showMassEdit:e.gx,getPreset:c.af.getPreset,getPresets:c.af.getPresets,createPreset:c.af.createPreset,spawnPreset:c.af.spawnPreset,activateBrush:f.Yv,deactivateBrush:f.Xt,openBrushMenu:f.Oy,migratePack:(e,t={})=>V12Migrator.migratePack(e,t),migrateAllPacks:(e={})=>V12Migrator.migrateAllPacks(e),linker:g.sy},game.modules.get(i.Do).api={...globalThis.MassEdit}})),Hooks.on("canvasReady",(()=>{f._8.isActive()?f._8.close():a.Picker.isActive()&&a.Picker.destroy()})),Hooks.on("renderTokenHUD",((t,s,i)=>{canvas.tokens.controlled.length>=2&&($(s).find('.control-icon[data-action="config"]').after('<div class="control-icon" data-action="massConfig">\n          <i class="fas fa-cogs"></i>\n        </div>'),$(s).on("click",'[data-action="massConfig"]',(()=>{(0,e.gx)()})))})),Hooks.on("renderTileHUD",((t,s,i)=>{(canvas.background?canvas.background.controlled.concat(canvas.foreground.controlled):canvas.tiles.controlled).length>=2&&($(s).find('.control-icon[data-action="underfoot"]').after('<div class="control-icon" data-action="massConfig">\n          <i class="fas fa-cogs"></i>\n        </div>'),$(s).on("click",'[data-action="massConfig"]',(()=>{(0,e.gx)()})))})),Hooks.on("renderActiveEffectConfig",(e=>{const s=$(e.form).find(".effects-header .key");if(s.length){const i=$('<i title="Apply \'Mass Edit\' preset" style="font-size:smaller;color:brown;"> <a>[ME]</a></i>');i.on("click",(()=>(0,t.dS)(e))),s.append(i)}}))})()})();
//# sourceMappingURL=bundle.js.map