(()=>{"use strict";var e,t={404:(e,t,a)=>{function n(e,t){const a={standard:r,gurps:s};return e in a?new a[e](t):new o}a.d(t,{c:()=>c});const i="/icons/svg/light.svg";class r{quantityField="quantity";constructor(e){this.quantityField=e??"quantity"}_getQuantity(e){let t=e.system;for(const e of this.quantityField.split("."))t=t[e];return t}_findMatchingItem(e,t){return Array.from(e.items).find((e=>e.name.toLowerCase()===t.toLowerCase()))}actorHasLightSource(e,t){return!!this._findMatchingItem(e,t.name)}getImage(e,t){let a=this._findMatchingItem(e,t.name);return a?a.img:i}getInventory(e,t){if(!t.consumable)return;let a=this._findMatchingItem(e,t.name);return a?this._getQuantity(a):void 0}async decrementInventory(e,t){if(!t.consumable)return Promise.resolve();let a=this._findMatchingItem(e,t.name);if(a&&this._getQuantity(a)>0){let e={};return e["system."+this.quantityField]=this._getQuantity(a)-1,a.update(e)}return Promise.resolve()}async setInventory(e,t,a){if(!t.consumable)return Promise.resolve();let n=this._findMatchingItem(e,t.name),i={};return i["system."+this.quantityField]=a,n.update(i)}}class s{quantityField="quantity";constructor(e){this.quantityField=e??"quantity"}actorHasLightSource(e,t){let[a]=e.findEquipmentByName(t.name);return!!a}getImage(){return i}getInventory(e,t){let[a]=e.findEquipmentByName(t.name);return a?a.count:void 0}async decrementInventory(e,t){if(!t.consumable)return Promise.resolve();let[a,n]=e.findEquipmentByName(t.name);return a&&a.count>0&&e.updateEqtCount(n,a.count-1),Promise.resolve()}async setInventory(e,t,a){if(!t.consumable)return Promise.resolve();let[n,i]=e.findEquipmentByName(t.name);return n&&e.updateEqtCount(i,a),Promise.resolve()}}class o{quantityField="quantity";constructor(){}actorHasLightSource(e,t){return!(!t||"Self"!==t.name)}getImage(){return i}getInventory(){return 1}async decrementInventory(){return Promise.resolve()}}const l={dnd5e:{system:"dnd5e",topology:"standard",quantity:"quantity",aliases:{"Lantern, Hooded":"Hooded Lantern","Lantern, Bullseye":"Bullseye Lantern"},sources:{Candle:{name:"Candle",type:"equipment",consumable:!0,states:2,light:[{bright:5,dim:10,angle:360}]},Torch:{name:"Torch",type:"equipment",consumable:!0,states:2,light:[{bright:20,dim:40,angle:360}]},Lamp:{name:"Lamp",type:"equipment",consumable:!1,states:2,light:[{bright:15,dim:45,angle:360}]},"Bullseye Lantern":{name:"Bullseye Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:60,dim:120,angle:57}]},"Hooded Lantern":{name:"Hooded Lantern",type:"equipment",consumable:!1,states:3,light:[{bright:30,dim:60,angle:360},{bright:0,dim:5,angle:360}]},Light:{name:"Light",type:"cantrip",consumable:!1,states:2,light:[{bright:20,dim:40,angle:360}]},"Dancing Lights":{name:"Dancing Lights",type:"cantrip",consumable:!1,states:2,light:[{bright:0,dim:10,angle:360}]}}},swade:{system:"swade",topology:"standard",quantity:"quantity",sources:{Candle:{name:"Candle",type:"equipment",consumable:!0,states:2,light:[{bright:0,dim:2,angle:360}]},Flashlight:{name:"Flashlight",type:"equipment",consumable:!1,states:2,light:[{bright:10,dim:10,angle:6}]},Lantern:{name:"Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:4,dim:4,angle:360}]},Torch:{name:"Torch",type:"equipment",consumable:!0,states:2,light:[{bright:4,dim:4,angle:360}]}}},pf1:{system:"pf1",topology:"standard",quantity:"quantity",sources:{Candle:{name:"Candle",type:"equipment",consumable:!0,states:2,light:[{bright:0,dim:5,angle:360}]},Lamp:{name:"Lamp",type:"equipment",consumable:!1,states:2,light:[{bright:15,dim:30,angle:360}]},Lantern:{name:"Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:30,dim:60,angle:360}]},"Bullseye Lantern":{name:"Bullseye Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:60,dim:120,angle:90}]},"Hooded Lantern":{name:"Hooded Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:30,dim:60,angle:360}]},"Miner's Lantern":{name:"Miner's Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:30,dim:60,angle:90}]},Torch:{name:"Torch",type:"equipment",consumable:!0,states:2,light:[{bright:20,dim:40,angle:360}]}}},pf2e:{system:"pf2e",topology:"standard",quantity:"quantity",sources:{Candle:{name:"Candle",type:"equipment",consumable:!0,states:2,light:[{bright:0,dim:10,angle:360}]},"Lantern (Hooded)":{name:"Lantern (Hooded)",type:"equipment",consumable:!1,states:3,light:[{bright:30,dim:60,angle:360},{bright:0,dim:5,angle:360}]},"Lantern (Bull's Eye)":{name:"Lantern (Bull's Eye)",type:"equipment",consumable:!1,states:2,light:[{bright:60,dim:120,angle:90}]},Torch:{name:"Torch",type:"equipment",consumable:!0,states:2,light:[{bright:20,dim:40,angle:360}]},"Everburning Torch":{name:"Everburning Torch",type:"equipment",consumable:!1,states:2,light:[{bright:20,dim:40,color:"#57cdff",saturation:.3,contrast:.3,shadows:.2,angle:360,animation:{type:"torch",speed:1,intensity:7,reverse:!1}}]}}},sfrpg:{system:"sfrpg",topology:"standard",quantity:"quantity",sources:{"Portable Light, Lantern":{name:"Portable Light, Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:10,dim:10,angle:360,color:"#555555",alpha:.5}]},"Portable Light, Flashlight":{name:"Portable Light, Flashlight",type:"equipment",consumable:!1,states:2,light:[{bright:20,dim:20,angle:90,color:"#555555",alpha:.5}]},"Portable Light, Beacon":{name:"Portable Light, Beacon",type:"equipment",consumable:!1,states:2,light:[{bright:20,dim:50,angle:360,color:"#555555",alpha:.5}]},"Portable Light, Spotlight":{name:"Portable Light, Spotlight",type:"equipment",consumable:!1,states:2,light:[{bright:100,dim:100,angle:90,color:"#555555",alpha:.5}]},"Comm Unit, Personal":{name:"Comm Unit, Personal",type:"equipment",consumable:!1,states:2,light:[{bright:15,dim:15,angle:90,color:"#555555",alpha:.5}]},"Dancing Lights":{name:"Dancing Lights",type:"cantrip",consumable:!1,states:2,light:[{bright:0,dim:10,angle:360,color:"#555555",alpha:.5}]}}},earthdawn4e:{system:"earthdawn4e",topology:"standard",quantity:"amount",sources:{Candle:{name:"Candle",type:"equipment",consumable:!0,states:2,light:[{bright:0,dim:3,angle:360}]},"Lantern (Hooded)":{name:"Lantern (Hooded)",type:"equipment",consumable:!1,states:3,light:[{bright:10,dim:10,angle:360},{bright:0,dim:10,angle:360}]},"Lantern (Bullseye)":{name:"Lantern (Bullseye)",type:"equipment",consumable:!1,states:2,light:[{bright:20,dim:20,angle:3}]},Torch:{name:"Torch",type:"equipment",consumable:!0,states:2,light:[{bright:10,dim:10,angle:360}]}}},gurps:{system:"gurps",topology:"gurps",quantity:"amount",sources:{"Candle, Tallow":{name:"Candle, Tallow",type:"equipment",consumable:!0,states:2,light:[{bright:0,dim:2,angle:360,color:"#ff9329",alpha:.6}]},"Flashlight, Heavy":{name:"Flashlight, Heavy",type:"equipment",consumable:!1,states:2,light:[{bright:30,dim:30,angle:6,color:"#ffd6aa",alpha:1}]},"Mini Flashlight":{name:"Mini Flashlight",type:"equipment",consumable:!1,states:2,light:[{bright:4,dim:5,angle:6,color:"#ffd6aa",alpha:1}]},"Micro Flashlight":{name:"Micro Flashlight",type:"equipment",consumable:!1,states:2,light:[{bright:1,dim:1,angle:6,color:"#ffd6aa",alpha:1}]},"Survival Flashlight":{name:"Survival Flashlight",type:"equipment",consumable:!1,states:2,light:[{bright:1,dim:1,angle:6,color:"#ffd6aa",alpha:1}]},Lantern:{name:"Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:4,dim:5,angle:360,color:"#ff9329",alpha:1}]},Torch:{name:"Torch",type:"equipment",consumable:!0,states:2,light:[{bright:9,dim:10,angle:360,color:"#ff9329",alpha:1}]},"Bull's-Eye Lantern":{name:"Bull's-Eye Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:9,dim:10,angle:57,color:"#ff9329",alpha:1}]},"Electric Lantern, Small":{name:"Electric Lantern, Small",type:"equipment",consumable:!1,states:2,light:[{bright:3,dim:3,angle:360,color:"#ff9329",alpha:1}]},"Electric Lantern, Large":{name:"Electric Lantern, Large",type:"equipment",consumable:!1,states:2,light:[{bright:4,dim:5,angle:360,color:"#ff9329",alpha:1}]},"Small Tactical Light":{name:"Small Tactical Light",type:"equipment",consumable:!1,states:2,light:[{bright:22,dim:25,angle:6,color:"#ffd6aa",alpha:1}]},"Large Tactical Light":{name:"Large Tactical Light",type:"equipment",consumable:!1,states:2,light:[{bright:95,dim:100,angle:6,color:"#ffd6aa",alpha:1}]},Floodlight:{name:"Floodlight",type:"equipment",consumable:!1,states:2,light:[{bright:190,dim:200,angle:6,color:"#ffd6aa",alpha:1}]}}},dcc:{system:"dcc",topology:"standard",quantity:"quantity",aliases:{Lantern:"Oil"},sources:{"Torch, each":{name:"Torch, each",type:"equipment",consumable:!0,states:2,light:[{bright:15,dim:30,angle:360,color:"#ff9329",alpha:.2,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},Lantern:{name:"Lantern",type:"equipment",consumable:!1,states:2,light:[{bright:15,dim:30,angle:360,color:"#ff9329",alpha:.2,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]}}},ose:{topology:"standard",quantity:"quantity.value",sources:{Torches:{type:"item",consumable:!0,light:[{bright:20,dim:30,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},Lantern:{type:"item",consumable:!1,light:[{bright:20,dim:30,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]}}},"reclaim-the-wild":{system:"reclaim-the-wild",topology:"standard",quantity:"quantity",aliases:{},sources:{Candle:{name:"Candle",type:"equipment",consumable:!0,states:2,light:[{bright:0,dim:1,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},Firewood:{name:"Firewood",type:"equipment",consumable:!0,states:2,light:[{bright:2,dim:8,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Lantern (1h, R0)":{name:"Lantern (1h, R0)",type:"equipment",consumable:!1,states:3,light:[{bright:2,dim:0,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}},{bright:5,dim:0,angle:85,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Lantern (1h, R1)":{name:"Lantern (1h, R1)",type:"equipment",consumable:!1,states:3,light:[{bright:2,dim:3,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}},{bright:6,dim:0,angle:85,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Lantern (1h, R2)":{name:"Lantern (1h, R2)",type:"equipment",consumable:!1,states:3,light:[{bright:3,dim:0,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}},{bright:7,dim:0,angle:85,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Lantern (1h, R3)":{name:"Lantern (1h, R3)",type:"equipment",consumable:!1,states:3,light:[{bright:3,dim:4,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}},{bright:8,dim:0,angle:85,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Lantern (1h, R4)":{name:"Lantern (1h, R4)",type:"equipment",consumable:!1,states:3,light:[{bright:4,dim:0,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}},{bright:9,dim:0,angle:85,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Lantern (1h, R5)":{name:"Lantern (1h, R5)",type:"equipment",consumable:!1,states:3,light:[{bright:4,dim:5,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}},{bright:10,dim:0,angle:85,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Torch (1h, R0)":{name:"Torch (1h, R0)",type:"equipment",consumable:!1,states:2,light:[{bright:4,dim:0,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Torch (1h, R1)":{name:"Torch (1h, R1)",type:"equipment",consumable:!1,states:2,light:[{bright:4,dim:5,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Torch (1h, R2)":{name:"Torch (1h, R2)",type:"equipment",consumable:!1,states:2,light:[{bright:5,dim:0,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Torch (1h, R3)":{name:"Torch (1h, R3)",type:"equipment",consumable:!1,states:2,light:[{bright:5,dim:6,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Torch (1h, R4)":{name:"Torch (1h, R4)",type:"equipment",consumable:!1,states:2,light:[{bright:6,dim:0,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Torch (1h, R5)":{name:"Torch (1h, R5)",type:"equipment",consumable:!1,states:2,light:[{bright:6,dim:7,angle:360,color:"#ff9329",alpha:.5,animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]}}},dragonbane:{system:"dragonbane",topology:"standard",quantity:"quantity",sources:{Lantern:{name:"Lantern",type:"equipment",consumable:!1,light:[{bright:10,dim:10,angle:360,alpha:.1,color:"#f9f06b",animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Oil Lamp":{name:"Oil Lamp",type:"equipment",consumable:!1,light:[{bright:10,dim:10,angle:360,alpha:.1,color:"#f9f06b",animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},Torch:{name:"Torch",type:"equipment",consumable:!1,light:[{bright:10,dim:10,angle:360,alpha:.1,color:"#f9f06b",animation:{type:"torch",speed:5,intensity:5,reverse:!1}}]},"Tallow Candle":{name:"Tallow Candle",type:"equipment",consumable:!1,light:[{bright:4,dim:4,angle:360,alpha:.1,color:"#f9f06b",animation:{type:"torch",speed:5,intensity:3,reverse:!1}}]}}},demonlord:{system:"demonlord",topology:"standard",quantity:"quantity",aliases:{"Lantern, Spotlight":"Spotlight Lantern"},sources:{Candle:{name:"Candle",type:"item",consumable:!0,states:2,light:[{bright:1,dim:2,angle:360,color:"#ff9329",alpha:.1,animation:{type:"torch",speed:"3",intensity:"1",reverse:!1}}]},Torch:{name:"Torch",type:"item",consumable:!0,states:2,light:[{bright:5,dim:10,angle:360,color:"#ff9329",alpha:.1,animation:{type:"torch",speed:"1",intensity:"5",reverse:!1}}]},"Spotlight Lantern":{name:"Spotlight Lantern",type:"item",consumable:!1,states:2,light:[{bright:20,dim:40,angle:53,animation:{type:"torch",speed:"1",intensity:"10",reverse:!1}}]},Lantern:{name:"Lantern",type:"item",consumable:!1,states:3,light:[{bright:10,dim:20,angle:360,animation:{type:"torch",speed:"1",intensity:"10",reverse:!1}}]}}},default:{system:"default",topology:"none",quantity:"quantity",sources:{Self:{name:"Self",type:"none",consumable:!1,states:2,light:[{bright:40,dim:20,angle:360}]}}}};class c{static commonLibrary;library;constructor(e){this.library=e}static applyFieldDefaults(e,t){for(const a in e){const n=t&&Object.prototype.hasOwnProperty.call(t,a)?t[a]:null;e[a].system||(e[a].system=a),e[a].topology||(e[a].topology=n?n.topology:"standard"),e[a].quantity||(e[a].quantity=n?n.quantity:"quantity"),e[a].sources||(e[a].sources={});const i=e[a].sources;for(const e in i){const t=n?n.sources[e]:null;i[e].name||(i[e].name=e),i[e].type||(i[e].type=t?t.type:"equipment"),void 0===i[e].consumable&&(i[e].consumable=!!t&&t.consumable),"true"===i[e].consumable&&(i[e].consumable=!0),"false"===i[e].consumable&&(i[e].consumable=!1),i[e].light&&i[e].light.constructor!==Array&&(i[e].light=[i[e].light]),i[e].light&&i[e].light.constructor===Array&&!i[e].states&&(i[e].states=i[e].light.length+1)}if(e[a].aliases){e[a].sources||(e[a].sources={});let t=e[a].sources,i=e[a].aliases;for(const e in i){let a=i[e],r=t[a]?t[a]:n&&n.sources[a]?n.sources[a]:null;r&&(t[e]=Object.assign({},r,{name:e}))}}}}static async load(e,t,a,i,r,s){c.commonLibrary||(c.commonLibrary=l,this.applyFieldDefaults(c.commonLibrary));let o=Object.assign({},s);o.bright=t,o.dim=a;let g,u={system:e,name:i,states:2,light:[o]};r?(g="string"==typeof r?await fetch(r).then((e=>e.json())).catch((e=>{console.warn("Failed loading user library: ",e)})):r,g&&this.applyFieldDefaults(g,c.commonLibrary)):g={};let m=h(g,c.commonLibrary,u);if(m[e])return m[e].topology=n(m[e].topology,m[e].quantity),new c(m[e]);{m.default.topology=n(m.default.topology,m.default.quantity);let e=m.default;return e.sources.Self.light[0].bright=t,e.sources.Self.light[0].dim=a,new c(e)}}get lightSources(){return this.library.sources}getLightSource(e){if(e)for(let t in this.library.sources)if(t.toLowerCase()===e.toLowerCase())return this.library.sources[t]}getInventory(e,t){let a=this.getLightSource(t);return this.library.topology.getInventory(e,a)}async _presetInventory(e,t,a){let n=this.getLightSource(t);return this.library.topology.setInventory(e,n,a)}async decrementInventory(e,t){let a=this.getLightSource(t);return this.library.topology.decrementInventory(e,a)}getImage(e,t){let a=this.getLightSource(t);return this.library.topology.getImage(e,a)}actorHasLightSource(e,t){let a=this.getLightSource(t);return this.library.topology.actorHasLightSource(e,a)}actorLightSources(e){let t=[];for(let a in this.library.sources)if(this.library.topology.actorHasLightSource(e,this.library.sources[a])){let n=Object.assign({image:this.library.topology.getImage(e,this.library.sources[a])},this.library.sources[a]);t.push(n)}return t}}let h=function(e,t,a){let n={};for(let e in t)n[e]={system:t[e].system,topology:t[e].topology,quantity:t[e].quantity,sources:{}};if(e)for(let a in e)a in t||(n[a]={system:e[a].system,topology:e[a].topology,quantity:e[a].quantity,sources:{}});for(let i in n){if(e&&i in e)for(let t in e[i].sources){let a=e[i].sources[t];n[i].sources[t]={name:a.name,type:a.type,consumable:a.consumable,states:a.states,light:Object.assign({},a.light)}}let r="";if(a.name){let e=!1,s=null;if(i===a.system){for(let t in n[i].sources)if(t.toLowerCase()===a.name.toLowerCase()){e=!0;break}if(!e&&t[i]){for(let e in t[i].sources)if(e.toLowerCase()===a.name.toLowerCase()){r=e,s=t[i].sources[e];break}r||(r=a.name),n[i].sources[r]={name:r,type:s?s.type:"equipment",consumable:!s||s.consumable,states:a.states,light:a.light}}}}if(i in t)for(let a in t[i].sources)if(!(e&&i in e&&a in e[i].sources||r&&a===r)){let e=t[i].sources[a];n[i].sources[a]={name:e.name,type:e.type,consumable:e.consumable,states:e.states,light:Object.assign({},e.light)}}}return n}},360:(e,t,a)=>{a.d(t,{c:()=>n});class n{static get playerTorches(){return game.settings.get("torch","playerTorches")}static get gmUsesInventory(){return game.settings.get("torch","gmUsesInventory")}static get userUsesInventory(){return game.settings.get("torch","playerUsesInventory")}static get inventoryItemName(){return game.settings.get("torch","gmInventoryItemName")}static get lightRadii(){return{bright:game.settings.get("torch","brightRadius"),dim:game.settings.get("torch","dimRadius")}}static get gameLightSources(){return game.settings.get("torch","gameLightSources")}static get dancingLightsVision(){return"dnd5e"===game.system.id&&game.settings.get("torch","dancingLightVision")}static get helpText(){return`\n<h3>Torch</h3>\n<ol class="hotkey-list">\n\t<li>\n\t\t<h4>${game.i18n.localize("torch.turnOffAllLights")}</h4>\n\t\t<div class="keys">${game.i18n.localize("torch.holdCtrlOnClick")}</div>\n\t</li>\n</ol>\n`}static register(){game.settings.register("torch","playerTorches",{name:game.i18n.localize("torch.playerTorches.name"),hint:game.i18n.localize("torch.playerTorches.hint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("torch","gmUsesInventory",{name:game.i18n.localize("torch.gmUsesInventory.name"),hint:game.i18n.localize("torch.gmUsesInventory.hint"),scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("torch","playerUsesInventory",{name:game.i18n.localize("torch.playerUsesInventory.name"),hint:game.i18n.localize("torch.playerUsesInventory.hint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("torch","gmInventoryItemName",{name:game.i18n.localize("torch.gmInventoryItemName.name"),hint:game.i18n.localize("torch.gmInventoryItemName.hint"),scope:"world",config:!0,default:"torch",type:String}),game.settings.register("torch","gameLightSources",{name:game.i18n.localize("torch.gameLightSources.name"),hint:game.i18n.localize("torch.gameLightSources.hint"),filePicker:"any",scope:"world",config:!0,default:"",type:String}),game.settings.register("torch","brightRadius",{name:game.i18n.localize("torch.brightRadius.name"),hint:game.i18n.localize("torch.brightRadius.hint"),scope:"world",config:!0,default:20,type:Number}),game.settings.register("torch","dimRadius",{name:game.i18n.localize("torch.dimRadius.name"),hint:game.i18n.localize("torch.dimRadius.hint"),scope:"world",config:!0,default:40,type:Number}),"dnd5e"===game.system.id&&game.settings.register("torch","dancingLightVision",{name:game.i18n.localize("torch.dancingLightVision.name"),hint:game.i18n.localize("torch.dancingLightVision.hint"),scope:"world",config:!0,default:!1,type:Boolean})}}},388:(e,t,a)=>{a.d(t,{c:()=>r});const n={"create:dnd5e:Dancing Lights":["TOKEN_CREATE","TOKEN_DELETE"],"delete:dnd5e:Dancing Lights":["TOKEN_DELETE"]};class i{static ACTIONS={"create:dnd5e:Dancing Lights":i.createDancingLights,"delete:dnd5e:Dancing Lights":i.removeDancingLights};static isPermitted(e,t){return!(t in n)||n[t].every((t=>e.can(t)))}static supports(e){return e in i.ACTIONS}static perform(e,t,a,n){i.ACTIONS[e](t,a,n)}static async createDancingLights(e,t,a){let n=game.settings.get("torch","dancingLightVision"),i={actorData:{},actorId:t.actor.id,actorLink:!1,bar1:{attribute:""},bar2:{attribute:""},displayBars:CONST.TOKEN_DISPLAY_MODES.NONE,displayName:CONST.TOKEN_DISPLAY_MODES.HOVER,disposition:CONST.TOKEN_DISPOSITIONS.FRIENDLY,flags:{},height:1,hidden:!1,light:a,lockRotation:!1,name:"Dancing Light",randomimg:!1,rotation:0,sight:{bright:0,dim:0,angle:360},texture:{src:"icons/magic/light/explosion-star-glow-orange.webp",scaleX:.25,scaleY:.25,rotation:0},mirrorX:!1,vision:n,width:1},r=e.grid.size*t.height,s=e.grid.size*t.width,o={x:t.x+s/2,y:t.y+r/2},l=[Object.assign({x:o.x-s,y:o.y-r},i),Object.assign({x:o.x,y:o.y-r},i),Object.assign({x:o.x-s,y:o.y},i),Object.assign({x:o.x,y:o.y},i)];await e.createEmbeddedDocuments("Token",l,{renderSheet:!1})}static async removeDancingLights(e,t){let a=[];e.tokens.forEach((n=>{t.actor.id===n.actor.id&&"Dancing Light"===n.name&&a.push(e.getEmbeddedDocument("Token",n.id).id)})),await e.deleteEmbeddedDocuments("Token",a)}}class r{static async handleSocketRequest(e){if(void 0===e.addressTo||e.addressTo===game.user.id){let t=game.scenes.get(e.sceneId),a=t.tokens.get(e.tokenId);i.supports(e.requestType)?await i.perform(e.requestType,t,a,e.lightSettings):console.warning(`Torch | --- Attempted unregistered socket action ${e.requestType}`)}}static requestSupported(e,t){return i.supports(`${e}:${game.system.id}:${t}`)}static async sendRequest(e,t,a,n){let s={requestType:`${t}:${game.system.id}:${a}`,sceneId:canvas.scene.id,tokenId:e,lightSettings:n};if(i.supports(s.requestType)){if(i.isPermitted(game.user,s.requestType))return r.handleSocketRequest(s),!0;{let e=game.users.contents.find((e=>e.active&&i.isPermitted(e,s.requestType)));return e?(s.addressTo=e.id,game.socket.emit("module.torch",s),!0):(ui.notifications.error("No GM available for Dancing Lights!"),!1)}}console.warning(`Torch | --- Requested unregistered socket action ${s.requestType}`)}}},288:(e,t,a)=>{a.d(t,{c:()=>s});var n=a(388),i=a(360);const r=function(e){let t={};for(let a in e)t["light."+a]=e[a];return t};class s{STATE_ON="on";STATE_DIM="dim";STATE_OFF="off";_token;_library;_ownedSources;constructor(e,t){this._token=e,this._library=t,this._ownedSources=t.actorLightSources(this._token.actor)}get ownedLightSources(){return this._ownedSources}get lightSourceState(){let e=this._token.getFlag("torch","lightSourceState");return void 0===e?this.STATE_OFF:e}get currentLightSource(){let e=this._token.getFlag("torch","lightSource");if(e&&this._ownedSources.find((t=>t.name===e)))return e;let t=i.c.inventoryItemName,a=t?this._ownedSources.find((e=>e.name.toLowerCase()===t.toLowerCase())):void 0;return t&&a?a.name:this._ownedSources.length>0?this._ownedSources[0].name:void 0}async setCurrentLightSource(e){await this._token.setFlag("torch","lightSource",e)}lightSourceIsExhausted(e){return!!this._library.getLightSource(e).consumable&&0===this._library.getInventory(this._token.actor,e)}getInventory(e){let t=this._library.getLightSource(e);return t&&t.consumable?this._library.getInventory(this._token.actor,e):t?-1:void 0}async forceStateOff(){let e=this._token.getFlag("torch","lightSourceState");await this._token.setFlag("torch","lightSourceState",this.STATE_OFF),await this._turnOffSource(e===this.STATE_OFF||void 0===e)}async advanceState(){let e=this.currentLightSource,t=this.lightSourceState;switch(t=3===this._library.getLightSource(e).states?t===this.STATE_OFF?this.STATE_ON:t===this.STATE_ON?this.STATE_DIM:this.STATE_OFF:t===this.STATE_OFF?this.STATE_ON:this.STATE_OFF,await this._token.setFlag("torch","lightSourceState",t),t){case this.STATE_OFF:await this._turnOffSource();break;case this.STATE_ON:await this._turnOnSource();break;case this.STATE_DIM:await this._dimSource();break;default:await this._turnOffSource()}return t}async _turnOffSource(e){let t=this._library.getLightSource(this.currentLightSource);if(n.c.requestSupported("delete",this.currentLightSource))n.c.sendRequest(this._token.id,"delete",this.currentLightSource,t.light);else{let a=game.actors.get(this._token.actorId).prototypeToken;await this._token.update(r(a.light)),!e&t.consumable&&await this._consumeSource(t)}}async _turnOnSource(){let e=this._library.getLightSource(this.currentLightSource);n.c.requestSupported("create",this.currentLightSource)?n.c.sendRequest(this._token.id,"create",this.currentLightSource,e.light[0]):await this._token.update(r(e.light[0]))}async _dimSource(){let e=this._library.getLightSource(this.currentLightSource);3===e.states&&await this._token.update(r(e.light[1]))}async _consumeSource(e){(game.user.isGM&&i.c.gmUsesInventory||!game.user.isGM&&i.c.userUsesInventory)&&this._library.getInventory(this._token.actor,e.name)&&await this._library.decrementInventory(this._token.actor,e.name)}}}},a={};function n(e){var i=a[e];if(void 0!==i)return i.exports;var r=a[e]={exports:{}};return t[e](r,r.exports,n),r.exports}n.m=t,n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,a)=>(n.f[a](e,t),t)),[])),n.u=e=>e+".js",n.miniCssF=e=>{},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},n.l=(t,a,i,r)=>{if(e[t])e[t].push(a);else{var s,o;if(void 0!==i)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var h=l[c];if(h.getAttribute("src")==t){s=h;break}}s||(o=!0,(s=document.createElement("script")).charset="utf-8",s.timeout=120,n.nc&&s.setAttribute("nonce",n.nc),s.src=t),e[t]=[a];var g=(a,n)=>{s.onerror=s.onload=null,clearTimeout(u);var i=e[t];if(delete e[t],s.parentNode&&s.parentNode.removeChild(s),i&&i.forEach((e=>e(n))),a)return a(n)},u=setTimeout(g.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=g.bind(null,s.onerror),s.onload=g.bind(null,s.onload),o&&document.head.appendChild(s)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var a=t.getElementsByTagName("script");if(a.length)for(var i=a.length-1;i>-1&&!e;)e=a[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={728:0};n.f.j=(t,a)=>{var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)a.push(i[2]);else{var r=new Promise(((a,n)=>i=e[t]=[a,n]));a.push(i[2]=r);var s=n.p+n.u(t),o=new Error;n.l(s,(a=>{if(n.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var r=a&&("load"===a.type?"missing":a.type),s=a&&a.target&&a.target.src;o.message="Loading chunk "+t+" failed.\n("+r+": "+s+")",o.name="ChunkLoadError",o.type=r,o.request=s,i[1](o)}}),"chunk-"+t,t)}};var t=(t,a)=>{var i,r,[s,o,l]=a,c=0;if(s.some((t=>0!==e[t]))){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);l&&l(n)}for(t&&t(a);c<s.length;c++)r=s[c],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},a=self.webpackChunk=self.webpackChunk||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})(),(()=>{var e=n(360),t=n(388);const a='<i class="fas fa-slash"></i>';class i{static async addQueryButton(e,t){let a=$('<div class="control-icon torch"><i class="fas fa-question"></i></div>');t.find(".col.left").prepend(a),a.find("i").click((async e=>{e.preventDefault(),e.stopPropagation(),new Dialog({title:game.i18n.localize("torch.help.setupSources.title"),content:game.i18n.localize("torch.help.setupSources.body"),buttons:{close:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Close")}},default:"close"}).render(!0)}))}static async addFlameButton(e,t,n,r,s,o){let l=e.lightSourceState,c=e.lightSourceIsExhausted(e.currentLightSource),h=$('<div class="control-icon torch"><i class="fas fa-fire"></i></div>');if(l===e.STATE_ON)h.addClass("active");else if(l===e.STATE_DIM)h.addClass("active");else if(c){let e=$(a);h.addClass("fa-stack"),h.find("i").addClass("fa-stack-1x"),e.addClass("fa-stack-1x"),h.prepend(e)}t.find(".col.left").prepend(h),h.find("i.fa-fire").contextmenu((async t=>{t.preventDefault(),t.stopPropagation(),e.lightSourceState===e.STATE_OFF&&i.toggleSourceMenu(h,e,o)})),h.find("i").click((async t=>{t.preventDefault(),t.stopPropagation(),h.next().hasClass("light-source-menu")||(e.lightSourceIsExhausted(e.currentLightSource)?new Dialog({title:game.i18n.localize("torch.help.supplyExhausted.title"),content:game.i18n.localize("torch.help.supplyExhausted.body"),buttons:{close:{icon:'<i class="fas fa-check"></i>',label:"Close"}},default:"close"}).render(!0):t.shiftKey?s(e):t.altKey?(await n(e),i.syncFlameButtonState(h,e)):(await r(e),i.syncFlameButtonState(h,e)))}))}static toggleSourceMenu(e,t,a){let n=e.next();if(n.hasClass("light-source-menu"))return void n.remove();let r=$('<div class="control-icon light-source-menu"></div>'),s=t.ownedLightSources,o=t.currentLightSource;for(let n of s){let s=$(`<button type="button" class="light-source-menu-item" >\n\t  <img src="${n.image}" title="${n.name}" />\n\t</button>`);n.name===o&&s.addClass("active"),t.lightSourceIsExhausted(n.name)&&s.addClass("exhausted"),s.click((async r=>{let s=$(r.currentTarget.parentElement);await a(t,n.name),i.syncDisabledState(e,t),s.remove()})),r.append(s)}e.after(r)}static syncDisabledState(e,t){let n=e.find(".fa-slash"),i=n.length>0,r=t.lightSourceIsExhausted(t.currentLightSource);if(!i&&r){let t=$(a);e.addClass("fa-stack"),e.find("i").addClass("fa-stack-1x"),t.addClass("fa-stack-1x"),e.prepend(t)}else i&&!r&&(n.remove(),e.find("i").removeClass("fa-stack-1x"),e.removeClass("fa-stack"))}static syncFlameButtonState(e,t){let a=t.lightSourceState;a===t.STATE_ON||a===t.STATE_DIM?e.addClass("active"):e.removeClass("active")}}var r=n(288),s=n(404);class o{async#e(t,a){let n=game.scenes.get(t).tokens.get(a),i=game.actors.get(n.actorId),o=await s.c.load(game.system.id,e.c.lightRadii.bright,e.c.lightRadii.dim,e.c.inventoryItemName,e.c.gameLightSources,i.prototypeToken.light);return new r.c(n,o)}#t(e,t,a){const n=/[A-Za-z0-9]+/;let i;if("string"==typeof t&&n.test(t)||(i="first parm - scene id - isn't an id string"),"string"==typeof a&&n.test(a)||(i="second parm - token id - isn't an id string"),i)throw`${e} : ${i}`}#a(e,t,a,n){const i=/[A-Za-z0-9]+/;let r;if("string"==typeof t&&i.test(t)||(r="first parm - scene id - isn't an id string"),"string"==typeof a&&i.test(a)||(r="second parm - token id - isn't an id string"),("string"!=typeof n||n.length<1)&&(r="third parm - source name - isn't the name of a light source"),r)throw`${e} : ${r}`}async toggle(e,t){this.#t("toggle",e,t);let a=await this.#e(e,t);return await a.advanceState()}async extinguish(e,t){this.#t("extinguish",e,t);let a=await this.#e(e,t);return await a.forceStateOff()}async currentSource(e,t){this.#t("currentSource",e,t);let a=await this.#e(e,t);return await a.currentLightSource}async currentState(e,t){this.#t("currentState",e,t);let a=await this.#e(e,t);return await a.lightSourceState}async equippedSources(e,t){this.#t("equippedSources",e,t);let a=await this.#e(e,t);return await a.ownedLightSources.map((e=>e.name))}async selectSource(e,t,a){this.#a("selectSource",e,t,a);let n=await this.#e(e,t);return await n.setCurrentLightSource(a)}async inventory(e,t,a){this.#a("inventory",e,t,a);let n=await this.#e(e,t);return await n.getInventory(a)}async sourceExhausted(e,t,a){this.#a("sourceExhausted",e,t,a);let n=await this.#e(e,t);return await n.lightSourceIsExhausted(a)}}let l=(...e)=>{console.log(...e)};class c{static async addTorchButton(t,a){let n=game.actors.get(t.object.document.actorId),o=await s.c.load(game.system.id,e.c.lightRadii.bright,e.c.lightRadii.dim,e.c.inventoryItemName,e.c.gameLightSources,n.prototypeToken.light),l=new r.c(t.object.document,o),h=l.ownedLightSources;t.object.document.name in h||(game.user.isGM||e.c.playerTorches)&&(l.currentLightSource?i.addFlameButton(l,a,c.forceSourceOff,c.toggleLightSource,c.toggleLightHeld,c.changeLightSource):i.addQueryButton(l,a))}static async toggleLightSource(e){let t=await e.advanceState();l(`${e.currentLightSource} is now ${t}`)}static async forceSourceOff(e){await e.forceSourceOff(),l(`Forced ${e.currentLightSource} off`)}static async toggleLightHeld(){}static async changeLightSource(e,t){await e.setCurrentLightSource(t)}static setupQuenchTesting(){console.log("Torch | --- In test environment - load test code..."),n.e(920).then(n.bind(n,920)).then((e=>{try{e.hookTests(),console.log("Torch | --- Tests ready")}catch(e){console.log("Torch | --- Error registering test code",e)}})).catch((e=>{console.log("Torch | --- No test code found",e)}))}}Hooks.on("ready",(()=>{Hooks.on("renderTokenHUD",((e,t,a)=>{c.addTorchButton(e,t,a)})),Hooks.on("renderControlsReference",((t,a)=>{a.find("div").first().append(e.c.helpText)})),game.socket.on("module.torch",(e=>{t.c.handleSocketRequest(e)}))})),Hooks.once("init",(()=>{game.world.id.startsWith("torch-test-")&&c.setupQuenchTesting(),e.c.register(),game.Torch=new o})),console.log("Torch | --- Module loaded")})()})();
//# sourceMappingURL=torch.js.map